cscope 15 $HOME/Documents/HermitCore/usr/lighttpd-1.4.45/src -q 0000005650 0001468881
	@array.c

1 
	~"fœ¡.h
"

3 
	~"¬¿y.h
"

4 
	~"bufãr.h
"

6 
	~<¡ršg.h
>

7 
	~<¡dio.h
>

8 
	~<¡dlib.h
>

9 
	~<lim™s.h
>

11 
	~<”ºo.h
>

12 
	~<as£¹.h
>

14 
	#ARRAY_NOT_FOUND
 ((
size_t
)(-1))

	)

16 
¬¿y
 *
	$¬¿y_š™
() {

17 
¬¿y
 *
a
;

19 
a
 = 
	`ÿÎoc
(1, (*a));

20 
	`fÜû_as£¹
(
a
);

22  
a
;

23 
	}
}

25 
¬¿y
 *
	$¬¿y_š™_¬¿y
(
¬¿y
 *
¤c
) {

26 
size_t
 
i
;

27 
¬¿y
 *
a
 = 
	`¬¿y_š™
();

29 ià(0 =ğ
¤c
->
size
è 
a
;

31 
a
->
u£d
 = 
¤c
->used;

32 
a
->
size
 = 
¤c
->size;

33 
a
->
unique_ndx
 = 
¤c
->unique_ndx;

35 
a
->
d©a
 = 
	`m®loc
((*
¤c
->d©aè* src->
size
);

36 
	`fÜû_as£¹
(
NULL
 !ğ
a
->
d©a
);

37 
i
 = 0; i < 
¤c
->
size
; i++) {

38 ià(
¤c
->
d©a
[
i
]è
a
->d©a[i] = src->d©a[i]->
	`cİy
(src->data[i]);

39 
a
->
d©a
[
i
] = 
NULL
;

42 
a
->
sÜ‹d
 = 
	`m®loc
((*
¤c
->sÜ‹dè* src->
size
);

43 
	`fÜû_as£¹
(
NULL
 !ğ
a
->
sÜ‹d
);

44 
	`memıy
(
a
->
sÜ‹d
, 
¤c
->sÜ‹d, (*¤c->sÜ‹dè* src->
size
);

45  
a
;

46 
	}
}

48 
	$¬¿y_ä“
(
¬¿y
 *
a
) {

49 
size_t
 
i
;

50 ià(!
a
) ;

52 
i
 = 0; i < 
a
->
size
; i++) {

53 ià(
a
->
d©a
[
i
]èa->d©a[i]->
	`ä“
(a->data[i]);

56 ià(
a
->
d©a
è
	`ä“
(a->data);

57 ià(
a
->
sÜ‹d
è
	`ä“
(a->sorted);

59 
	`ä“
(
a
);

60 
	}
}

62 
	$¬¿y_»£t
(
¬¿y
 *
a
) {

63 
size_t
 
i
;

64 ià(!
a
) ;

66 
i
 = 0; i < 
a
->
u£d
; i++) {

67 
a
->
d©a
[
i
]->
	`»£t
(a->data[i]);

70 
a
->
u£d
 = 0;

71 
a
->
unique_ndx
 = 0;

72 
	}
}

74 
d©a_un£t
 *
	$¬¿y_pİ
(
¬¿y
 *
a
) {

75 
d©a_un£t
 *
du
;

77 
	`fÜû_as£¹
(
a
->
u£d
 != 0);

79 
a
->
u£d
 --;

80 
du
 = 
a
->
d©a
[a->
u£d
];

81 
	`fÜû_as£¹
(
a
->
sÜ‹d
[a->
u£d
] ==‡->used);

82 
a
->
d©a
[a->
u£d
] = 
NULL
;

84  
du
;

85 
	}
}

91 
size_t
 
	$¬¿y_g‘_šdex
(
¬¿y
 *
a
, cÚ¡ *
key
, 
size_t
 
keyËn
, size_ˆ*
ºdx
) {

96 
size_t
 
low”
 = 0, 
uµ”
 = 
a
->
u£d
;

97 
	`fÜû_as£¹
(
uµ”
 <ğ
SSIZE_MAX
);

99 
low”
 !ğ
uµ”
) {

100 
size_t
 
´obe
 = (
low”
 + 
uµ”
) / 2;

101 
cmp
 = 
	`bufãr_ÿ£Ëss_com·»
(
key
, 
keyËn
, 
	`CONST_BUF_LEN
(
a
->
d©a
[a->
sÜ‹d
[
´obe
]]->key));

102 
	`as£¹
(
low”
 < 
uµ”
);

103 
	`as£¹
((
low”
 <ğ
´obe
è&& (´ob< 
uµ”
));

105 ià(
cmp
 == 0) {

107 ià(
ºdx
è*ºdx = 
´obe
;

108  
a
->
sÜ‹d
[
´obe
];

109 } ià(
cmp
 < 0) {

111 
uµ”
 = 
´obe
;

114 
low”
 = 
´obe
 + 1;

119 ià(
ºdx
è*ºdx = 
low”
;

120  
ARRAY_NOT_FOUND
;

121 
	}
}

123 
d©a_un£t
 *
	$¬¿y_g‘_–em’t
(
¬¿y
 *
a
, cÚ¡ *
key
) {

124 
size_t
 
ndx
;

125 
	`fÜû_as£¹
(
NULL
 !ğ
key
);

127 ià(
ARRAY_NOT_FOUND
 !ğ(
ndx
 = 
	`¬¿y_g‘_šdex
(
a
, 
key
, 
	`¡¾’
(key), 
NULL
))) {

129  
a
->
d©a
[
ndx
];

132  
NULL
;

133 
	}
}

135 
d©a_un£t
 *
	$¬¿y_exŒaù_–em’t
(
¬¿y
 *
a
, cÚ¡ *
key
) {

136 
size_t
 
ndx
, 
pos
;

137 
	`fÜû_as£¹
(
NULL
 !ğ
key
);

139 ià(
ARRAY_NOT_FOUND
 !ğ(
ndx
 = 
	`¬¿y_g‘_šdex
(
a
, 
key
, 
	`¡¾’
(key), &
pos
))) {

141 cÚ¡ 
size_t
 
Ï¡_ndx
 = 
a
->
u£d
 - 1;

142 
d©a_un£t
 *
’Œy
 = 
a
->
d©a
[
ndx
];

145 ià(
ndx
 !ğ
Ï¡_ndx
) {

147 
size_t
 
Ï¡_–em_pos
;

149 
	`fÜû_as£¹
(
Ï¡_ndx
 =ğ
	`¬¿y_g‘_šdex
(
a
, 
	`CONST_BUF_LEN
×->
d©a
[Ï¡_ndx]->
key
), &
Ï¡_–em_pos
));

152 
a
->
d©a
[
ndx
] =‡->d©a[
Ï¡_ndx
];

153 
a
->
d©a
[
Ï¡_ndx
] = 
NULL
;

156 
a
->
sÜ‹d
[
Ï¡_–em_pos
] = 
ndx
;

158 
a
->
d©a
[
ndx
] = 
NULL
;

162 ià(
pos
 !ğ
Ï¡_ndx
) {

163 
	`memmove
(
a
->
sÜ‹d
 + 
pos
,‡->sÜ‹d +…o + 1, (
Ï¡_ndx
 -…os) * (*a->sorted));

165 
a
->
sÜ‹d
[
Ï¡_ndx
] = 
ARRAY_NOT_FOUND
;

166 --
a
->
u£d
;

168  
’Œy
;

171  
NULL
;

172 
	}
}

174 
d©a_un£t
 *
	$¬¿y_g‘_unu£d_–em’t
(
¬¿y
 *
a
, 
d©a_ty³_t
 
t
) {

175 
d©a_un£t
 *
ds
 = 
NULL
;

176 
i
;

178 
i
 = 
a
->
u£d
; i <‡->
size
; i++) {

179 ià(
a
->
d©a
[
i
] &&‡->d©a[i]->
ty³
 =ğ
t
) {

180 
ds
 = 
a
->
d©a
[
i
];

183 
a
->
d©a
[
i
] =‡->d©a[a->
u£d
];

184 
a
->
d©a
[a->
u£d
] = 
NULL
;

186  
ds
;

190  
NULL
;

191 
	}
}

193 
	$¬¿y_£t_key_v®ue
(
¬¿y
 *
hdrs
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®ue
, size_ˆ
v®_Ën
) {

194 
d©a_¡ršg
 *
ds_d¡
;

196 ià(
NULL
 !ğ(
ds_d¡
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
hdrs
, 
key
))) {

197 
	`bufãr_cİy_¡ršg_Ën
(
ds_d¡
->
v®ue
, v®ue, 
v®_Ën
);

201 ià(
NULL
 =ğ(
ds_d¡
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
hdrs
, 
TYPE_STRING
))) {

202 
ds_d¡
 = 
	`d©a_¡ršg_š™
();

205 
	`bufãr_cİy_¡ršg_Ën
(
ds_d¡
->
key
, key, 
key_Ën
);

206 
	`bufãr_cİy_¡ršg_Ën
(
ds_d¡
->
v®ue
, v®ue, 
v®_Ën
);

207 
	`¬¿y_š£¹_unique
(
hdrs
, (
d©a_un£t
 *)
ds_d¡
);

208 
	}
}

211 
d©a_un£t
 **
	$¬¿y_fšd_Ü_š£¹
(
¬¿y
 *
a
, 
d©a_un£t
 *
’Œy
) {

212 
size_t
 
ndx
, 
pos
, 
j
;

215 ià(
	`bufãr_is_em±y
(
’Œy
->
key
è||ƒÁry->
is_šdex_key
) {

216 
	`bufãr_cİy_št
(
’Œy
->
key
, 
a
->
unique_ndx
++);

217 
’Œy
->
is_šdex_key
 = 1;

218 
	`fÜû_as£¹
(0 !ğ
a
->
unique_ndx
);

222 ià(
ARRAY_NOT_FOUND
 !ğ(
ndx
 = 
	`¬¿y_g‘_šdex
(
a
, 
	`CONST_BUF_LEN
(
’Œy
->
key
), &
pos
))) {

224  &
a
->
d©a
[
ndx
];

230 
	`fÜû_as£¹
(
a
->
u£d
 + 1 <ğ
SSIZE_MAX
);

232 ià(
a
->
size
 == 0) {

233 
a
->
size
 = 16;

234 
a
->
d©a
 = 
	`m®loc
((*a->d©aè*‡->
size
);

235 
a
->
sÜ‹d
 = 
	`m®loc
((*a->sÜ‹dè*‡->
size
);

236 
	`fÜû_as£¹
(
a
->
d©a
);

237 
	`fÜû_as£¹
(
a
->
sÜ‹d
);

238 
j
 = 
a
->
u£d
; j <‡->
size
; j++èa->
d©a
[j] = 
NULL
;

239 } ià(
a
->
size
 =ğa->
u£d
) {

240 
a
->
size
 += 16;

241 
a
->
d©a
 = 
	`»®loc
×->d©a, (*a->d©aè*‡->
size
);

242 
a
->
sÜ‹d
 = 
	`»®loc
×->sÜ‹d, (*a->sÜ‹dè*‡->
size
);

243 
	`fÜû_as£¹
(
a
->
d©a
);

244 
	`fÜû_as£¹
(
a
->
sÜ‹d
);

245 
j
 = 
a
->
u£d
; j <‡->
size
; j++èa->
d©a
[j] = 
NULL
;

248 
ndx
 = 
a
->
u£d
;

251 ià(
a
->
d©a
[
ndx
]èa->d©a[ndx]->
	`ä“
(a->data[ndx]);

253 
a
->
d©a
[a->
u£d
++] = 
’Œy
;

256 ià(
pos
 !ğ
ndx
) {

257 
	`memmove
(
a
->
sÜ‹d
 + (
pos
 + 1),‡->sÜ‹d + (pos), (
ndx
 -…os) * (*a->sorted));

261 
a
->
sÜ‹d
[
pos
] = 
ndx
;

263  
NULL
;

264 
	}
}

267 
	$¬¿y_»¶aû
(
¬¿y
 *
a
, 
d©a_un£t
 *
’Œy
) {

268 
d©a_un£t
 **
Şd
;

270 
	`fÜû_as£¹
(
NULL
 !ğ
’Œy
);

271 ià(
NULL
 !ğ(
Şd
 = 
	`¬¿y_fšd_Ü_š£¹
(
a
, 
’Œy
))) {

272 
	`fÜû_as£¹
(*
Şd
 !ğ
’Œy
);

273 (*
Şd
)->
	`ä“
(*old);

274 *
Şd
 = 
’Œy
;

276 
	}
}

278 
	$¬¿y_š£¹_unique
(
¬¿y
 *
a
, 
d©a_un£t
 *
’Œy
) {

279 
d©a_un£t
 **
Şd
;

281 
	`fÜû_as£¹
(
NULL
 !ğ
’Œy
);

282 ià(
NULL
 !ğ(
Şd
 = 
	`¬¿y_fšd_Ü_š£¹
(
a
, 
’Œy
))) {

283 
	`fÜû_as£¹
((*
Şd
)->
ty³
 =ğ
’Œy
->type);

284 
’Œy
->
	`š£¹_dup
(*
Şd
,ƒntry);

286 
	}
}

288 
	$¬¿y_´št_šd’t
(
d•th
) {

289 
i
;

290 
i
 = 0; i < 
d•th
; i ++) {

291 
	`årštf
(
¡dout
, " ");

293 
	}
}

295 
size_t
 
	$¬¿y_g‘_max_key_Ëngth
(
¬¿y
 *
a
) {

296 
size_t
 
maxËn
, 
i
;

298 
maxËn
 = 0;

299 
i
 = 0; i < 
a
->
u£d
; i ++) {

300 
d©a_un£t
 *
du
 = 
a
->
d©a
[
i
];

301 
size_t
 
Ën
 = 
	`¡¾’
(
du
->
key
->
±r
);

303 ià(
Ën
 > 
maxËn
) {

304 
maxËn
 = 
Ën
;

307  
maxËn
;

308 
	}
}

310 
	$¬¿y_´št
(
¬¿y
 *
a
, 
d•th
) {

311 
size_t
 
i
;

312 
size_t
 
maxËn
;

313 
Ú–še
 = 1;

315 ià(
a
->
u£d
 > 5) {

316 
Ú–še
 = 0;

318 
i
 = 0; i < 
a
->
u£d
 && 
Ú–še
; i++) {

319 
d©a_un£t
 *
du
 = 
a
->
d©a
[
i
];

320 ià(!
du
->
is_šdex_key
) {

321 
Ú–še
 = 0;

324 
du
->
ty³
) {

325 
TYPE_INTEGER
:

326 
TYPE_STRING
:

329 
Ú–še
 = 0;

333 ià(
Ú–še
) {

334 
	`årštf
(
¡dout
, "(");

335 
i
 = 0; i < 
a
->
u£d
; i++) {

336 
d©a_un£t
 *
du
 = 
a
->
d©a
[
i
];

337 ià(
i
 != 0) {

338 
	`årštf
(
¡dout
, ", ");

340 
du
->
	`´št
(du, 
d•th
 + 1);

342 
	`årštf
(
¡dout
, ")");

346 
maxËn
 = 
	`¬¿y_g‘_max_key_Ëngth
(
a
);

347 
	`årštf
(
¡dout
, "(\n");

348 
i
 = 0; i < 
a
->
u£d
; i++) {

349 
d©a_un£t
 *
du
 = 
a
->
d©a
[
i
];

350 
	`¬¿y_´št_šd’t
(
d•th
 + 1);

351 ià(!
du
->
is_šdex_key
) {

352 
j
;

354 ià(
i
 && (i % 5) == 0) {

355 
	`årštf
(
¡dout
, "# %zu\n", 
i
);

356 
	`¬¿y_´št_šd’t
(
d•th
 + 1);

358 
	`årštf
(
¡dout
, "\"%s\"", 
du
->
key
->
±r
);

359 
j
 = 
maxËn
 - 
	`¡¾’
(
du
->
key
->
±r
); j > 0; j --) {

360 
	`årštf
(
¡dout
, " ");

362 
	`årštf
(
¡dout
, " => ");

364 
du
->
	`´št
(du, 
d•th
 + 1);

365 
	`årštf
(
¡dout
, ",\n");

367 ià(!(
i
 && (i - 1 % 5) == 0)) {

368 
	`¬¿y_´št_šd’t
(
d•th
 + 1);

369 
	`årštf
(
¡dout
, "# %zu\n", 
i
);

371 
	`¬¿y_´št_šd’t
(
d•th
);

372 
	`årštf
(
¡dout
, ")");

375 
	}
}

377 #ifdeà
DEBUG_ARRAY


378 
	$maš
 (
¬gc
, **
¬gv
) {

379 
¬¿y
 *
a
;

380 
d©a_¡ršg
 *
ds
;

382 
	`UNUSED
(
¬gc
);

383 
	`UNUSED
(
¬gv
);

385 
a
 = 
	`¬¿y_š™
();

387 
ds
 = 
	`d©a_¡ršg_š™
();

388 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("abc"));

389 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("alfrag"));

391 
	`¬¿y_š£¹_unique
(
a
, (
d©a_un£t
 *)
ds
);

393 
ds
 = 
	`d©a_¡ršg_š™
();

394 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("abc"));

395 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("hameplman"));

397 
	`¬¿y_š£¹_unique
(
a
, (
d©a_un£t
 *)
ds
);

399 
ds
 = 
	`d©a_¡ršg_š™
();

400 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("123"));

401 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("alfrag"));

403 
	`¬¿y_š£¹_unique
(
a
, (
d©a_un£t
 *)
ds
);

405 
	`¬¿y_´št
(
a
, 0);

407 
	`¬¿y_ä“
(
a
);

409 
	`årštf
(
¡d”r
, "%d\n",

410 
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("Content-type")));

413 
	}
}

	@array.h

1 #iâdeà
ARRAY_H


2 
	#ARRAY_H


	)

3 
	~"fœ¡.h
"

5 #ifdeà
HAVE_PCRE_H


6 
	~<püe.h
>

9 
	~"bufãr.h
"

10 
	~"veùÜ.h
"

12 
	~<¡dlib.h
>

14 
	#DATA_IS_STRING
(
x
è(x->
ty³
 =ğ
TYPE_STRING
)

	)

16 ’um { 
	mTYPE_UNSET
, 
	mTYPE_STRING
, 
	mTYPE_OTHER
, 
	mTYPE_ARRAY
, 
	mTYPE_INTEGER
, 
	mTYPE_FASTCGI
, 
	mTYPE_CONFIG
 } 
	td©a_ty³_t
;

17 
	#DATA_UNSET
 \

18 
d©a_ty³_t
 
ty³
; \

19 
bufãr
 *
key
; \

20 
is_šdex_key
; \

21 
d©a_un£t
 *(*
cİy
)(cÚ¡ d©a_un£ˆ*
¤c
); \

22 (* 
ä“
)(
d©a_un£t
 *
p
); \

23 (* 
»£t
)(
d©a_un£t
 *
p
); \

24 (*
š£¹_dup
)(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
); \

25 (*
´št
)(cÚ¡ 
d©a_un£t
 *
p
, 
d•th
)

	)

27 
	sd©a_un£t
 {

28 
	mDATA_UNSET
;

29 } 
	td©a_un£t
;

32 
d©a_un£t
 **
	md©a
;

34 
size_t
 *
	msÜ‹d
;

36 
size_t
 
	mu£d
;

37 
size_t
 
	msize
;

39 
size_t
 
	munique_ndx
;

40 } 
	t¬¿y
;

43 
	mDATA_UNSET
;

45 
bufãr
 *
	mv®ue
;

46 } 
	td©a_¡ršg
;

48 
d©a_¡ršg
 *
d©a_¡ršg_š™
();

49 
d©a_¡ršg
 *
d©a_»¥Ú£_š™
();

52 
	mDATA_UNSET
;

54 
¬¿y
 *
	mv®ue
;

55 } 
	td©a_¬¿y
;

57 
d©a_¬¿y
 *
d©a_¬¿y_š™
();

63 
	mCONFIG_COND_UNSET
,

64 
	mCONFIG_COND_EQ
,

65 
	mCONFIG_COND_MATCH
,

66 
	mCONFIG_COND_NE
,

67 
	mCONFIG_COND_NOMATCH
,

68 
	mCONFIG_COND_ELSE


69 } 
	tcÚfig_cÚd_t
;

75 
	mCOMP_UNSET
,

76 
	mCOMP_SERVER_SOCKET
,

77 
	mCOMP_HTTP_URL
,

78 
	mCOMP_HTTP_HOST
,

79 
	mCOMP_HTTP_REFERER
,

80 
	mCOMP_HTTP_USER_AGENT
,

81 
	mCOMP_HTTP_LANGUAGE
,

82 
	mCOMP_HTTP_COOKIE
,

83 
	mCOMP_HTTP_REMOTE_IP
,

84 
	mCOMP_HTTP_QUERY_STRING
,

85 
	mCOMP_HTTP_SCHEME
,

86 
	mCOMP_HTTP_REQUEST_METHOD
,

88 
	mCOMP_LAST_ELEMENT


89 } 
	tcomp_key_t
;

96 
d©a_cÚfig
 
	td©a_cÚfig
;

97 
DEFINE_TYPED_VECTOR_NO_RELEASE
(
cÚfig_w—k
, 
d©a_cÚfig
*);

99 
	sd©a_cÚfig
 {

100 
	mDATA_UNSET
;

102 
¬¿y
 *
	mv®ue
;

104 
bufãr
 *
	mcomp_key
;

105 
comp_key_t
 
	mcomp
;

107 
cÚfig_cÚd_t
 
	mcÚd
;

108 
bufãr
 *
	mİ
;

110 
	mcÚ‹xt_ndx
;

111 
veùÜ_cÚfig_w—k
 
	mchd»n
;

113 
d©a_cÚfig
 *
	m·»Á
;

115 
d©a_cÚfig
 *
	m´ev
;

116 
d©a_cÚfig
 *
	mÃxt
;

118 
bufãr
 *
	m¡ršg
;

119 #ifdeà
HAVE_PCRE_H


120 
püe
 *
	m»gex
;

121 
püe_exŒa
 *
	m»gex_¡udy
;

125 
d©a_cÚfig
 *
d©a_cÚfig_š™
();

128 
	mDATA_UNSET
;

130 
	mv®ue
;

131 } 
	td©a_š‹g”
;

133 
d©a_š‹g”
 *
d©a_š‹g”_š™
();

136 
	mDATA_UNSET
;

138 
bufãr
 *
	mho¡
;

140 
	mpÜt
;

142 
time_t
 
	mdi§bË_ts
;

143 
	mis_di§bËd
;

144 
size_t
 
	mb®ªû
;

146 
	mu§ge
;

147 
	mÏ¡_u£d_ndx
;

148 } 
	td©a_ç¡cgi
;

150 
d©a_ç¡cgi
 *
d©a_ç¡cgi_š™
();

152 
¬¿y
 *
¬¿y_š™
();

153 
¬¿y
 *
¬¿y_š™_¬¿y
×¼ay *
a
);

154 
¬¿y_ä“
(
¬¿y
 *
a
);

155 
¬¿y_»£t
(
¬¿y
 *
a
);

156 
¬¿y_š£¹_unique
(
¬¿y
 *
a
, 
d©a_un£t
 *
’Œy
);

157 
d©a_un£t
 *
¬¿y_pİ
(
¬¿y
 *
a
);

158 
¬¿y_´št
(
¬¿y
 *
a
, 
d•th
);

159 
d©a_un£t
 *
¬¿y_g‘_unu£d_–em’t
(
¬¿y
 *
a
, 
d©a_ty³_t
 
t
);

160 
d©a_un£t
 *
¬¿y_g‘_–em’t
(
¬¿y
 *
a
, cÚ¡ *
key
);

161 
d©a_un£t
 *
¬¿y_exŒaù_–em’t
(
¬¿y
 *
a
, cÚ¡ *
key
);

162 
¬¿y_£t_key_v®ue
(
¬¿y
 *
hdrs
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®ue
, size_ˆ
v®_Ën
);

163 
¬¿y_»¶aû
(
¬¿y
 *
a
, 
d©a_un£t
 *
’Œy
);

164 
¬¿y_¡rÿ£cmp
(cÚ¡ *
a
, 
size_t
 
a_Ën
, cÚ¡ *
b
, size_ˆ
b_Ën
);

165 
¬¿y_´št_šd’t
(
d•th
);

166 
size_t
 
¬¿y_g‘_max_key_Ëngth
(
¬¿y
 *
a
);

	@base.h

1 #iâdeà
_BASE_H_


2 
	#_BASE_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£‰šgs.h
"

7 
	~<sys/ty³s.h
>

8 
	~<sys/time.h
>

9 
	~<sys/¡©.h
>

11 
	~<lim™s.h
>

13 #ifdeà
HAVE_STDINT_H


14 
	~<¡dšt.h
>

17 #ifdeà
HAVE_INTTYPES_H


18 
	~<š‰y³s.h
>

21 
	~"bufãr.h
"

22 
	~"¬¿y.h
"

23 
	~"chunk.h
"

24 
	~"keyv®ue.h
"

25 
	~"fdev’t.h
"

26 
	~"sys-sock‘.h
"

27 
	~"¥ÏyŒ“.h
"

28 
	~"‘ag.h
"

31 #ià
defšed
 
HAVE_LIBSSL
 && defšed 
HAVE_OPENSSL_SSL_H


32 
	#USE_OPENSSL


	)

33 
	~<İ’s¦/İ’s¦cÚf.h
>

34 #iâdeà
USE_OPENSSL_KERBEROS


35 #iâdeà
OPENSSL_NO_KRB5


36 
	#OPENSSL_NO_KRB5


	)

39 
	~<İ’s¦/s¦.h
>

40 #ià! 
defšed
 
OPENSSL_NO_TLSEXT
 && ! defšed 
SSL_CTRL_SET_TLSEXT_HOSTNAME


41 
	#OPENSSL_NO_TLSEXT


	)

45 #ifdeà
HAVE_FAM_H


46 
	~<çm.h
>

49 #iâdeà
O_BINARY


50 
	#O_BINARY
 0

	)

53 #iâdeà
O_LARGEFILE


54 
	#O_LARGEFILE
 0

	)

57 #iâdeà
SIZE_MAX


58 #ifdeà
SIZE_T_MAX


59 
	#SIZE_MAX
 
SIZE_T_MAX


	)

61 
	#SIZE_MAX
 ((
size_t
)~0)

	)

65 #iâdeà
SSIZE_MAX


66 
	#SSIZE_MAX
 ((
size_t
)~0 >> 1)

	)

69 #ifdeà
__APPLE__


70 
	~<üt_ex‹ºs.h
>

71 
	#’vœÚ
 (* 
	`_NSG‘EnvœÚ
())

	)

73 **
’vœÚ
;

77 #iâdeà
HAVE_SOCKLEN_T


78 
	tsockËn_t
;

82 #ià(!
defšed
(
HAVE_STDINT_H
)è&& (!defšed(
HAVE_INTTYPES_H
)è&& (!defšed(
ušt32_t
))

83 
	#ušt32_t
 
u_št32_t


	)

87 #iâdeà
SHUT_WR


88 
	#SHUT_WR
 1

	)

91 ’um { 
	mT_CONFIG_UNSET
,

92 
	mT_CONFIG_STRING
,

93 
	mT_CONFIG_SHORT
,

94 
	mT_CONFIG_INT
,

95 
	mT_CONFIG_BOOLEAN
,

96 
	mT_CONFIG_ARRAY
,

97 
	mT_CONFIG_LOCAL
,

98 
	mT_CONFIG_DEPRECATED
,

99 
	mT_CONFIG_UNSUPPORTED


100 } 
	tcÚfig_v®ues_ty³_t
;

102 ’um { 
	mT_CONFIG_SCOPE_UNSET
,

103 
	mT_CONFIG_SCOPE_SERVER
,

104 
	mT_CONFIG_SCOPE_CONNECTION


105 } 
	tcÚfig_scİe_ty³_t
;

108 cÚ¡ *
	mkey
;

109 *
	mde¡š©iÚ
;

111 
cÚfig_v®ues_ty³_t
 
	mty³
;

112 
cÚfig_scİe_ty³_t
 
	mscİe
;

113 } 
	tcÚfig_v®ues_t
;

115 ’um { 
	mDIRECT
, 
	mEXTERNAL
 } 
	tcÚÃùiÚ_ty³
;

118 *
	mkey
;

119 
cÚÃùiÚ_ty³
 
	mty³
;

120 *
	mv®ue
;

121 } 
	t»que¡_hªdËr
;

124 *
	mkey
;

125 *
	mho¡
;

126 
	mpÜt
;

127 
	mu£d
;

128 
	mçùÜ
;

129 } 
	tfcgi_cÚÃùiÚs
;

133 #ifdeà
HAVE_IPV6


134 
sockaddr_š6
 
	mv6
;

136 
sockaddr_š
 
	mv4
;

137 #ifdeà
HAVE_SYS_UN_H


138 
sockaddr_un
 
	mun
;

140 
sockaddr
 
	m¶aš
;

141 } 
	tsock_addr
;

144 
	#HTTP_STATUS
 
	`BV
(0)

	)

145 
	#HTTP_CONNECTION
 
	`BV
(1)

	)

146 
	#HTTP_CONTENT_LENGTH
 
	`BV
(2)

	)

147 
	#HTTP_DATE
 
	`BV
(3)

	)

148 
	#HTTP_LOCATION
 
	`BV
(4)

	)

153 
bufãr
 *
	m»que¡
;

154 
bufãr
 *
	muri
;

156 
bufãr
 *
	mÜig_uri
;

158 
h‰p_m‘hod_t
 
	mh‰p_m‘hod
;

159 
h‰p_v”siÚ_t
 
	mh‰p_v”siÚ
;

161 
bufãr
 *
	m»que¡_lše
;

164 
bufãr
 *
	mh‰p_ho¡
;

165 cÚ¡ *
	mh‰p_¿nge
;

166 cÚ¡ *
	mh‰p_cÚ‹Á_ty³
;

167 cÚ¡ *
	mh‰p_if_modif›d_sšû
;

168 cÚ¡ *
	mh‰p_if_nÚe_m©ch
;

170 
¬¿y
 *
	mh—d”s
;

173 
off_t
 
	mcÚ‹Á_Ëngth
;

174 
off_t
 
	m‹_chunked
;

177 
	macû±_’codšg
;

180 
bufãr
 *
	m·thšfo
;

181 } 
	t»que¡
;

184 
off_t
 
	mcÚ‹Á_Ëngth
;

185 
	mk“p_®ive
;

187 
¬¿y
 *
	mh—d”s
;

190 
	mHTTP_TRANSFER_ENCODING_IDENTITY
, 
	mHTTP_TRANSFER_ENCODING_CHUNKED


191 } 
	mŒªsãr_’codšg
;

192 } 
	t»¥Ú£
;

195 
bufãr
 *
	mscheme
;

198 
bufãr
 *
	mauthÜ™y
;

201 
bufãr
 *
	m·th
;

202 
bufãr
 *
	m·th_¿w
;

203 
bufãr
 *
	mqu”y
;

204 } 
	t»que¡_uri
;

207 
bufãr
 *
	m·th
;

208 
bufãr
 *
	mba£dœ
;

210 
bufãr
 *
	mdoc_roÙ
;

211 
bufãr
 *
	m»l_·th
;

213 
bufãr
 *
	m‘ag
;

214 } 
	tphysiÿl
;

217 
bufãr
 *
	mÇme
;

218 
bufãr
 *
	m‘ag
;

220 
¡©
 
	m¡
;

222 
time_t
 
	m¡©_ts
;

224 #ifdeà
HAVE_LSTAT


225 
	mis_symlšk
;

228 #ifdeà
HAVE_FAM_H


229 
	mdœ_v”siÚ
;

232 
bufãr
 *
	mcÚ‹Á_ty³
;

233 } 
	t¡©_ÿche_’Œy
;

236 
¥Ïy_Œ“
 *
	mfes
;

238 
bufãr
 *
	mdœ_Çme
;

239 #ifdeà
HAVE_FAM_H


240 
¥Ïy_Œ“
 *
	mdœs
;

242 
FAMCÚÃùiÚ
 
	mçm
;

243 
	mçm_fcû_ndx
;

245 
bufãr
 *
	mhash_key
;

246 } 
	t¡©_ÿche
;

249 
¬¿y
 *
	mmim‘y³s
;

252 
bufãr
 *
	mdocum’t_roÙ
;

253 
bufãr
 *
	m£rv”_Çme
;

254 
bufãr
 *
	m”rÜ_hªdËr
;

255 
bufãr
 *
	m”rÜ_hªdËr_404
;

256 
bufãr
 *
	m£rv”_g
;

257 
bufãr
 *
	mdœli¡_’codšg
;

258 
bufãr
 *
	m”rÜfe_´efix
;

260 
	mhigh_´ecisiÚ_time¡amps
;

261 
	mmax_k“p_®ive_»que¡s
;

262 
	mmax_k“p_®ive_idË
;

263 
	mmax_»ad_idË
;

264 
	mmax_wr™e_idË
;

265 
	mu£_x©Œ
;

266 
	mfŞlow_symlšk
;

267 
	m¿nge_»que¡s
;

268 
	m¡»am_»que¡_body
;

269 
	m¡»am_»¥Ú£_body
;

273 
	mlog_fe_nÙ_found
;

274 
	mlog_»que¡_h—d”
;

275 
	mlog_»que¡_hªdlšg
;

276 
	mlog_»¥Ú£_h—d”
;

277 
	mlog_cÚd™iÚ_hªdlšg
;

278 
	mlog_s¦_noi£
;

279 
	mlog_timeouts
;

283 
bufãr
 *
	ms¦_³mfe
;

284 
bufãr
 *
	ms¦_ÿ_fe
;

285 
bufãr
 *
	ms¦_ch”_li¡
;

286 
bufãr
 *
	ms¦_dh_fe
;

287 
bufãr
 *
	ms¦_ec_curve
;

288 
	ms¦_hÚÜ_ch”_Üd”
;

289 
	ms¦_em±y_äagm’ts
;

290 
	ms¦_u£_s¦v2
;

291 
	ms¦_u£_s¦v3
;

292 
	ms¦_v”ifyş›Á
;

293 
	ms¦_v”ifyş›Á_’fÜû
;

294 
	ms¦_v”ifyş›Á_d•th
;

295 
bufãr
 *
	ms¦_v”ifyş›Á_u£ºame
;

296 
	ms¦_v”ifyş›Á_expÜt_û¹
;

297 
	ms¦_di§bË_ş›Á_»ÃgÙŸtiÚ
;

298 
	ms¦_»ad_ah—d
;

300 
	mu£_v6
, 
	m£t_v6Úly
;

301 
	mdeãr_acû±
;

302 
	ms¦_’abËd
;

303 
	m®low_h‰p11
;

304 
	m‘ag_u£_šode
;

305 
	m‘ag_u£_mtime
;

306 
	m‘ag_u£_size
;

307 
	mfÜû_low”ÿ£_f’ames
;

308 
	mh‰p_·r£İts
;

309 
	mmax_»que¡_size
;

310 
	mli¡’_backlog
;

312 
	mkby‹s_³r_£cÚd
;

315 
	mglob®_kby‹s_³r_£cÚd
;

317 
off_t
 
	mglob®_by‹s_³r_£cÚd_út
;

331 
off_t
 *
	mglob®_by‹s_³r_£cÚd_út_±r
;

333 #ià
defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
) \

334 || 
defšed
(
__O³nBSD__
è|| defšed(
__D¿gÚFly__
)

335 
bufãr
 *
	mbsd_acû±_f‹r
;

338 #ifdeà
USE_OPENSSL


339 
SSL_CTX
 *
	ms¦_ùx
;

341 
EVP_PKEY
 *
	ms¦_³mfe_pkey
;

342 
X509
 *
	ms¦_³mfe_x509
;

343 
STACK_OF
(
X509_NAME
è*
	ms¦_ÿ_fe_û¹_Çmes
;

345 } 
	t¥ecific_cÚfig
;

350 
	mCON_STATE_CONNECT
,

351 
	mCON_STATE_REQUEST_START
,

352 
	mCON_STATE_READ
,

353 
	mCON_STATE_REQUEST_END
,

354 
	mCON_STATE_READ_POST
,

355 
	mCON_STATE_HANDLE_REQUEST
,

356 
	mCON_STATE_RESPONSE_START
,

357 
	mCON_STATE_WRITE
,

358 
	mCON_STATE_RESPONSE_END
,

359 
	mCON_STATE_ERROR
,

360 
	mCON_STATE_CLOSE


361 } 
	tcÚÃùiÚ_¡©e_t
;

367 
	mCOND_RESULT_UNSET
,

372 
	mCOND_RESULT_SKIP
,

375 
	mCOND_RESULT_FALSE
,

376 
	mCOND_RESULT_TRUE
,

377 } 
	tcÚd_»suÉ_t
;

381 
cÚd_»suÉ_t
 
	m»suÉ
;

383 
cÚd_»suÉ_t
 
	mloÿl_»suÉ
;

384 
	m·‰”ncouÁ
;

385 
	mm©ches
[3 * 10];

386 
bufãr
 *
	mcomp_v®ue
;

387 } 
	tcÚd_ÿche_t
;

390 
cÚÃùiÚ_¡©e_t
 
	m¡©e
;

393 
time_t
 
	m»ad_idË_ts
;

394 
time_t
 
	mşo£_timeout_ts
;

395 
time_t
 
	mwr™e_»que¡_ts
;

397 
time_t
 
	mcÚÃùiÚ_¡¬t
;

398 
time_t
 
	m»que¡_¡¬t
;

399 
time¥ec
 
	m»que¡_¡¬t_hp
;

401 
size_t
 
	m»que¡_couÁ
;

402 
size_t
 
	mloİs_³r_»que¡
;

408 
	mfd
;

409 
	mfde_ndx
;

410 
	mndx
;

413 
	mis_»adabË
;

414 
	mis_wr™abË
;

416 
	mk“p_®ive
;

417 
	mk“p_®ive_idË
;

419 
	mfe_¡¬‹d
;

420 
	mfe_fšished
;

422 
chunkqueue
 *
	mwr™e_queue
;

423 
chunkqueue
 *
	m»ad_queue
;

424 
chunkqueue
 *
	m»que¡_cÚ‹Á_queue
;

426 
	mŒaffic_lim™_»ached
;

428 
off_t
 
	mby‹s_wr™‹n
;

429 
off_t
 
	mby‹s_wr™‹n_cur_£cÚd
;

430 
off_t
 
	mby‹s_»ad
;

431 
off_t
 
	mby‹s_h—d”
;

433 
	mh‰p_¡©us
;

435 
sock_addr
 
	md¡_addr
;

436 
bufãr
 *
	md¡_addr_buf
;

439 
bufãr
 *
	m·r£_»que¡
;

440 
	m·r£d_»¥Ú£
;

442 
»que¡
 
	m»que¡
;

443 
»que¡_uri
 
	muri
;

444 
physiÿl
 
	mphysiÿl
;

445 
»¥Ú£
 
	m»¥Ú£
;

447 
size_t
 
	mh—d”_Ën
;

449 
¬¿y
 *
	m’vœÚm’t
;

452 
	mgÙ_»¥Ú£
;

454 
	mš_jobli¡
;

456 
cÚÃùiÚ_ty³
 
	mmode
;

458 **
	m¶ugš_ùx
;

460 
¥ecific_cÚfig
 
	mcÚf
;

461 
cÚd_ÿche_t
 *
	mcÚd_ÿche
;

463 
bufãr
 *
	m£rv”_Çme
;

466 
	m”rÜ_hªdËr_§ved_¡©us
;

467 
h‰p_m‘hod_t
 
	m”rÜ_hªdËr_§ved_m‘hod
;

469 
£rv”_sock‘
 *
	m¤v_sock‘
;

471 #ifdeà
USE_OPENSSL


472 
SSL
 *
	ms¦
;

473 #iâdeà
OPENSSL_NO_TLSEXT


474 
bufãr
 *
	m£xt_£rv”_Çme
;

476 
	m»ÃgÙŸtiÚs
;

479 
‘ag_æags_t
 
	m‘ag_æags
;

481 
	mcÚd™iÚ®_is_v®id
[
COMP_LAST_ELEMENT
];

482 } 
	tcÚÃùiÚ
;

485 
cÚÃùiÚ
 **
	m±r
;

486 
size_t
 
	msize
;

487 
size_t
 
	mu£d
;

488 } 
	tcÚÃùiÚs
;

491 #ifdeà
HAVE_IPV6


493 
	mçmy
;

495 
š6_addr
 
	mv6
;

496 
š_addr
 
	mv4
;

497 } 
	maddr
;

498 
	mb2
[
INET6_ADDRSTRLEN
 + 1];

499 
time_t
 
	mts
;

500 } 
	tš‘_Áİ_ÿche_ty³
;

505 
bufãr
 *
	muri
;

506 
time_t
 
	mmtime
;

507 
	mh‰p_¡©us
;

508 } 
	t»®·th_ÿche_ty³
;

511 
time_t
 
	mmtime
;

512 
bufãr
 *
	m¡r
;

513 } 
	tmtime_ÿche_ty³
;

516 *
	m±r
;

517 
size_t
 
	mu£d
;

518 
size_t
 
	msize
;

519 } 
	tbufãr_¶ugš
;

522 
	mpÜt
;

523 
bufãr
 *
	mbšdho¡
;

525 
bufãr
 *
	m”rÜlog_fe
;

526 
	m”rÜlog_u£_sy¦og
;

527 
bufãr
 *
	mb»akag–og_fe
;

529 
	mdÚt_d«mÚize
;

530 
	m´eæight_check
;

531 
bufãr
 *
	mchªg”oÙ
;

532 
bufãr
 *
	mu£ºame
;

533 
bufãr
 *
	mgrou²ame
;

535 
bufãr
 *
	mpid_fe
;

537 
bufãr
 *
	mev’t_hªdËr
;

539 
bufãr
 *
	mmoduËs_dœ
;

540 
bufãr
 *
	mÃtwÜk_back’d
;

541 
¬¿y
 *
	mmoduËs
;

542 
¬¿y
 *
	mu¶ßd_‹mpdœs
;

543 
	mu¶ßd_‹mp_fe_size
;

544 
	mmax_»que¡_f›ld_size
;

546 
	mmax_wÜk”
;

547 
	mmax_fds
;

548 
	mmax_cÚns
;

550 
	mlog_»que¡_h—d”_Ú_”rÜ
;

551 
	mlog_¡©e_hªdlšg
;

553 ’um { 
	mSTAT_CACHE_ENGINE_UNSET
,

554 
	mSTAT_CACHE_ENGINE_NONE
,

555 
	mSTAT_CACHE_ENGINE_SIMPLE


556 #ifdeà
HAVE_FAM_H


557 , 
	mSTAT_CACHE_ENGINE_FAM


559 } 
	m¡©_ÿche_’gše
;

560 
	m’abË_cÜes
;

561 
	m»jeù_ex³ù_100_w™h_417
;

562 
bufãr
 *
	mx©Œ_Çme
;

564 
	mh‰p_h—d”_¡riù
;

565 
	mh‰p_ho¡_¡riù
;

566 
	mh‰p_ho¡_nÜm®ize
;

567 
	mhigh_´ecisiÚ_time¡amps
;

568 
time_t
 
	mlßdts
;

569 
	mlßdavg
[3];

570 } 
	t£rv”_cÚfig
;

572 
	s£rv”_sock‘
 {

573 
sock_addr
 
	maddr
;

574 
	mfd
;

575 
	mfde_ndx
;

577 
	mis_s¦
;

579 
bufãr
 *
	m¤v_tok’
;

581 #ifdeà
USE_OPENSSL


582 
SSL_CTX
 *
	ms¦_ùx
;

584 } 
	t£rv”_sock‘
;

587 
£rv”_sock‘
 **
	m±r
;

589 
size_t
 
	msize
;

590 
size_t
 
	mu£d
;

591 } 
	t£rv”_sock‘_¬¿y
;

593 
	s£rv”
 {

594 
£rv”_sock‘_¬¿y
 
	m¤v_sock‘s
;

597 
	m”rÜlog_fd
;

598 ’um { 
	mERRORLOG_FILE
, 
	mERRORLOG_FD
, 
	mERRORLOG_SYSLOG
, 
	mERRORLOG_PIPE
 } 
	m”rÜlog_mode
;

599 
bufãr
 *
	m”rÜlog_buf
;

601 
fdev’ts
 *
	mev
, *
	mev_šs
;

603 
bufãr_¶ugš
 
	m¶ugšs
;

604 *
	m¶ugš_¦Ùs
;

607 
	mcÚ_İ’ed
;

608 
	mcÚ_»ad
;

609 
	mcÚ_wr™‹n
;

610 
	mcÚ_şo£d
;

612 
	ms¦_is_š™
;

614 
	mmax_fds
;

615 
	mcur_fds
;

616 
	mwªt_fds
;

617 
	msock‘s_di§bËd
;

619 
size_t
 
	mmax_cÚns
;

622 
bufãr
 *
	m·r£_fuÎ_·th
;

623 
bufãr
 *
	m»¥Ú£_h—d”
;

624 
bufãr
 *
	m»¥Ú£_¿nge
;

625 
bufãr
 *
	mtmp_buf
;

627 
bufãr
 *
	mtmp_chunk_Ën
;

629 
bufãr
 *
	mem±y_¡ršg
;

631 
bufãr
 *
	mcÚd_check_buf
;

634 #ifdeà
HAVE_IPV6


635 
š‘_Áİ_ÿche_ty³
 
	mš‘_Áİ_ÿche
[
INET_NTOP_CACHE_MAX
];

637 
mtime_ÿche_ty³
 
	mmtime_ÿche
[
FILE_CACHE_MAX
];

639 
¬¿y
 *
	m¥l™_v®s
;

642 
time_t
 
	mcur_ts
;

643 
time_t
 
	mÏ¡_g’”©ed_d©e_ts
;

644 
time_t
 
	mÏ¡_g’”©ed_debug_ts
;

645 
time_t
 
	m¡¬tup_ts
;

647 
bufãr
 *
	mts_debug_¡r
;

648 
bufãr
 *
	mts_d©e_¡r
;

651 
¬¿y
 *
	mcÚfig_touched
;

653 
¬¿y
 *
	mcÚfig_cÚ‹xt
;

654 
¥ecific_cÚfig
 **
	mcÚfig_¡Üage
;

656 
£rv”_cÚfig
 
	m¤vcÚf
;

658 
	mcÚfig_d•»ÿ‹d
;

659 
	mcÚfig_unsuµÜ‹d
;

661 
cÚÃùiÚs
 *
	mcÚns
;

662 
cÚÃùiÚs
 *
	mjobli¡
;

663 
cÚÃùiÚs
 *
	mfdwa™queue
;

665 
¡©_ÿche
 *
	m¡©_ÿche
;

680 
¬¿y
 *
	m¡©us
;

682 
fdev’t_hªdËr_t
 
	mev’t_hªdËr
;

684 (* 
	mÃtwÜk_back’d_wr™e
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, 
	mfd
, 
chunkqueue
 *
	mcq
, 
off_t
 
	mmax_by‹s
);

685 #ifdeà
USE_OPENSSL


686 (* 
	mÃtwÜk_s¦_back’d_wr™e
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, 
SSL
 *
	ms¦
, 
chunkqueue
 *
	mcq
, 
off_t
 
	mmax_by‹s
);

689 
uid_t
 
	muid
;

690 
gid_t
 
	mgid
;

691 } 
	t£rv”
;

	@base64.c

1 
	~"fœ¡.h
"

3 
	~"ba£64.h
"

13 cÚ¡ 
	gba£64_¡ªd¬d_bË
[66] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";

14 cÚ¡ 
	gba£64_¡ªd¬d_»v”£_bË
[128] = {

27 cÚ¡ 
	gba£64_u¾_bË
[66] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_.";

28 cÚ¡ 
	gba£64_u¾_»v”£_bË
[128] = {

40 * 
	$bufãr_­³nd_ba£64_decode
(
bufãr
 *
out
, cÚ¡ * 
š
, 
size_t
 
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
) {

41 *
»suÉ
;

42 
size_t
 
out_pos
 = 0;

43 
group
 = 0;

44 
size_t
 
i
;

45 cÚ¡ * 
ba£64_»v”£_bË
;

47 
ch¬£t
) {

48 
BASE64_STANDARD
:

49 
ba£64_»v”£_bË
 = 
ba£64_¡ªd¬d_»v”£_bË
;

51 
BASE64_URL
:

52 
ba£64_»v”£_bË
 = 
ba£64_u¾_»v”£_bË
;

55  
NULL
;

58 
»suÉ
 = (*è
	`bufãr_¡ršg_´•¬e_­³nd
(
out
, 3*(
š_Ëngth
 / 4) + 3);

61 
i
 = 0; i < 
š_Ëngth
; i++) {

62 
c
 = (è
š
[
i
];

63 
ch
;

65 ià(
c
 == '\0') ;

66 ià(
c
 >ğ128è 
NULL
;

68 
ch
 = 
ba£64_»v”£_bË
[
c
];

69 ià(-3 =ğ
ch
) {

71 ià(
group
 < 2è 
NULL
;

73 } ià(-2 =ğ
ch
) {

75 } ià(
ch
 < 0) {

76  
NULL
;

79 
group
) {

81 
»suÉ
[
out_pos
] = 
ch
 << 2;

82 
group
 = 1;

85 
»suÉ
[
out_pos
++] |ğ
ch
 >> 4;

86 
»suÉ
[
out_pos
] = (
ch
 & 0x0f) << 4;

87 
group
 = 2;

90 
»suÉ
[
out_pos
++] |ğ
ch
 >>2;

91 
»suÉ
[
out_pos
] = (
ch
 & 0x03) << 6;

92 
group
 = 3;

95 
»suÉ
[
out_pos
++] |ğ
ch
;

96 
group
 = 0;

101 
group
) {

107  
NULL
;

115 ià(0 !ğ
»suÉ
[
out_pos
]è 
NULL
;

119 
	`bufãr_comm™
(
out
, 
out_pos
);

121  
»suÉ
;

122 
	}
}

124 
size_t
 
	$li_to_ba£64_no_·ddšg
(* 
out
, 
size_t
 
out_Ëngth
, cÚ¡ * 
š
, size_ˆ
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
) {

125 cÚ¡ 
size_t
 
fuÎ_tu¶es
 = 
š_Ëngth
 / 3;

126 cÚ¡ 
size_t
 
š_tu¶e_»mašd”
 = 
š_Ëngth
 % 3;

127 cÚ¡ 
size_t
 
out_tu¶e_»mašd”
 = 
š_tu¶e_»mašd”
 ? 1 + in_tuple_remainder : 0;

128 cÚ¡ 
size_t
 
»quœe_¥aû
 = 4 * 
fuÎ_tu¶es
 + 
out_tu¶e_»mašd”
;

129 cÚ¡ * 
ba£64_bË
;

130 
size_t
 
i
;

131 
size_t
 
out_pos
 = 0;

133 
ch¬£t
) {

134 
BASE64_STANDARD
:

135 
ba£64_bË
 = 
ba£64_¡ªd¬d_bË
;

137 
BASE64_URL
:

138 
ba£64_bË
 = 
ba£64_u¾_bË
;

141 
	`fÜû_as£¹
(0 && "invalid charset");

145 
	`fÜû_as£¹
(
fuÎ_tu¶es
 <= 2*full_tuples);

146 
	`fÜû_as£¹
(
fuÎ_tu¶es
 <= 4*full_tuples);

147 
	`fÜû_as£¹
(4*
fuÎ_tu¶es
 <ğ4*fuÎ_tu¶e + 
out_tu¶e_»mašd”
);

148 
	`fÜû_as£¹
(
»quœe_¥aû
 <ğ
out_Ëngth
);

150 
i
 = 2; i < 
š_Ëngth
; i += 3) {

151 
v
 = (
š
[
i
-2] << 16) | (in[i-1] << 8) | in[i];

152 
out
[
out_pos
+3] = 
ba£64_bË
[
v
 & 0x3f]; v >>= 6;

153 
out
[
out_pos
+2] = 
ba£64_bË
[
v
 & 0x3f]; v >>= 6;

154 
out
[
out_pos
+1] = 
ba£64_bË
[
v
 & 0x3f]; v >>= 6;

155 
out
[
out_pos
+0] = 
ba£64_bË
[
v
 & 0x3f];

156 
out_pos
 += 4;

158 
š_tu¶e_»mašd”
) {

164 
v
 = (
š
[
i
-2] << 4);

165 
out
[
out_pos
+1] = 
ba£64_bË
[
v
 & 0x3f]; v >>= 6;

166 
out
[
out_pos
+0] = 
ba£64_bË
[
v
 & 0x3f];

167 
out_pos
 += 2;

173 
v
 = (
š
[
i
-2] << 10) | (in[i-1] << 2);

174 
out
[
out_pos
+2] = 
ba£64_bË
[
v
 & 0x3f]; v >>= 6;

175 
out
[
out_pos
+1] = 
ba£64_bË
[
v
 & 0x3f]; v >>= 6;

176 
out
[
out_pos
+0] = 
ba£64_bË
[
v
 & 0x3f];

177 
out_pos
 += 3;

181 
	`fÜû_as£¹
(
out_pos
 <ğ
out_Ëngth
);

182  
out_pos
;

183 
	}
}

185 
size_t
 
	$li_to_ba£64
(* 
out
, 
size_t
 
out_Ëngth
, cÚ¡ * 
š
, size_ˆ
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
) {

186 cÚ¡ 
size_t
 
š_tu¶e_»mašd”
 = 
š_Ëngth
 % 3;

187 
size_t
 
·ddšg_Ëngth
 = 
š_tu¶e_»mašd”
 ? 3 - in_tuple_remainder : 0;

189 
·ddšg
;

190 
size_t
 
out_pos
;

192 
ch¬£t
) {

193 
BASE64_STANDARD
:

194 
·ddšg
 = 
ba£64_¡ªd¬d_bË
[64];

196 
BASE64_URL
:

197 
·ddšg
 = 
ba£64_u¾_bË
[64];

200 
	`fÜû_as£¹
(0 && "invalid charset");

203 
	`fÜû_as£¹
(
out_Ëngth
 >ğ
·ddšg_Ëngth
);

204 
out_pos
 = 
	`li_to_ba£64_no_·ddšg
(
out
, 
out_Ëngth
 - 
·ddšg_Ëngth
, 
š
, 
š_Ëngth
, 
ch¬£t
);

206 
·ddšg_Ëngth
 > 0) {

207 
out
[
out_pos
++] = 
·ddšg
;

208 
·ddšg_Ëngth
--;

211 
	`fÜû_as£¹
(
out_pos
 <ğ
out_Ëngth
);

213  
out_pos
;

214 
	}
}

217 * 
	$bufãr_­³nd_ba£64_’code_no_·ddšg
(
bufãr
 *
out
, cÚ¡ * 
š
, 
size_t
 
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
) {

218 
size_t
 
»£rve
 = 4*(
š_Ëngth
/3) + 4;

219 * 
»suÉ
 = 
	`bufãr_¡ršg_´•¬e_­³nd
(
out
, 
»£rve
);

220 
size_t
 
out_pos
 = 
	`li_to_ba£64_no_·ddšg
(
»suÉ
, 
»£rve
, 
š
, 
š_Ëngth
, 
ch¬£t
);

222 
	`bufãr_comm™
(
out
, 
out_pos
);

224  
»suÉ
;

225 
	}
}

227 * 
	$bufãr_­³nd_ba£64_’code
(
bufãr
 *
out
, cÚ¡ * 
š
, 
size_t
 
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
) {

228 
size_t
 
»£rve
 = 4*(
š_Ëngth
/3) + 4;

229 * 
»suÉ
 = 
	`bufãr_¡ršg_´•¬e_­³nd
(
out
, 
»£rve
);

230 
size_t
 
out_pos
 = 
	`li_to_ba£64
(
»suÉ
, 
»£rve
, 
š
, 
š_Ëngth
, 
ch¬£t
);

232 
	`bufãr_comm™
(
out
, 
out_pos
);

234  
»suÉ
;

235 
	}
}

	@base64.h

1 #iâdeà
_BASE64_H_


2 
	#_BASE64_H_


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

8 
	mBASE64_STANDARD
,

9 
	mBASE64_URL
,

10 } 
	tba£64_ch¬£t
;

12 * 
bufãr_­³nd_ba£64_decode
(
bufãr
 *
out
, cÚ¡ * 
š
, 
size_t
 
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
);

14 
size_t
 
li_to_ba£64_no_·ddšg
(* 
out
, size_ˆ
out_Ëngth
, cÚ¡ * 
š
, size_ˆ
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
);

15 
size_t
 
li_to_ba£64
(* 
out
, size_ˆ
out_Ëngth
, cÚ¡ * 
š
, size_ˆ
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
);

17 * 
bufãr_­³nd_ba£64_’code_no_·ddšg
(
bufãr
 *
out
, cÚ¡ * 
š
, 
size_t
 
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
);

18 * 
bufãr_­³nd_ba£64_’code
(
bufãr
 *
out
, cÚ¡ * 
š
, 
size_t
 
š_Ëngth
, 
ba£64_ch¬£t
 
ch¬£t
);

	@buffer.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

8 
	~<¡dio.h
>

9 
	~<as£¹.h
>

10 
	~<ùy³.h
>

12 cÚ¡ 
	ghex_ch¬s
[] = "0123456789abcdef";

19 
bufãr
* 
	$bufãr_š™
() {

20 
bufãr
 *
b
;

22 
b
 = 
	`m®loc
((*b));

23 
	`fÜû_as£¹
(
b
);

25 
b
->
±r
 = 
NULL
;

26 
b
->
size
 = 0;

27 
b
->
u£d
 = 0;

29  
b
;

30 
	}
}

32 
bufãr
 *
	$bufãr_š™_bufãr
(cÚ¡ 
bufãr
 *
¤c
) {

33 
bufãr
 *
b
 = 
	`bufãr_š™
();

34 
	`bufãr_cİy_bufãr
(
b
, 
¤c
);

35  
b
;

36 
	}
}

38 
bufãr
 *
	$bufãr_š™_¡ršg
(cÚ¡ *
¡r
) {

39 
bufãr
 *
b
 = 
	`bufãr_š™
();

40 
	`bufãr_cİy_¡ršg
(
b
, 
¡r
);

41  
b
;

42 
	}
}

44 
	$bufãr_ä“
(
bufãr
 *
b
) {

45 ià(
NULL
 =ğ
b
) ;

47 
	`ä“
(
b
->
±r
);

48 
	`ä“
(
b
);

49 
	}
}

51 
	$bufãr_»£t
(
bufãr
 *
b
) {

52 ià(
NULL
 =ğ
b
) ;

55 ià(
b
->
size
 > 
BUFFER_MAX_REUSE_SIZE
) {

56 
	`ä“
(
b
->
±r
);

57 
b
->
±r
 = 
NULL
;

58 
b
->
size
 = 0;

59 } ià(
b
->
size
 > 0) {

60 
b
->
±r
[0] = '\0';

63 
b
->
u£d
 = 0;

64 
	}
}

66 
	$bufãr_move
(
bufãr
 *
b
, bufã¸*
¤c
) {

67 
bufãr
 
tmp
;

69 ià(
NULL
 =ğ
b
) {

70 
	`bufãr_»£t
(
¤c
);

73 
	`bufãr_»£t
(
b
);

74 ià(
NULL
 =ğ
¤c
) ;

76 
tmp
 = *
¤c
; *¤øğ*
b
; *b =mp;

77 
	}
}

79 
	#BUFFER_PIECE_SIZE
 64

	)

80 
size_t
 
	$bufãr_®ign_size
(
size_t
 
size
) {

81 
size_t
 
®ign
 = 
BUFFER_PIECE_SIZE
 - (
size
 % BUFFER_PIECE_SIZE);

83 ià(
size
 + 
®ign
 < size)  size;

84  
size
 + 
®ign
;

85 
	}
}

88 
	$bufãr_®loc
(
bufãr
 *
b
, 
size_t
 
size
) {

89 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

90 ià(0 =ğ
size
) size = 1;

92 ià(
size
 <ğ
b
->size) ;

94 ià(
NULL
 !ğ
b
->
±r
è
	`ä“
(b->ptr);

96 
b
->
u£d
 = 0;

97 
b
->
size
 = 
	`bufãr_®ign_size
(size);

98 
b
->
±r
 = 
	`m®loc
(b->
size
);

100 
	`fÜû_as£¹
(
NULL
 !ğ
b
->
±r
);

101 
	}
}

104 
	$bufãr_»®loc
(
bufãr
 *
b
, 
size_t
 
size
) {

105 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

106 ià(0 =ğ
size
) size = 1;

108 ià(
size
 <ğ
b
->size) ;

110 
b
->
size
 = 
	`bufãr_®ign_size
(size);

111 
b
->
±r
 = 
	`»®loc
(b->±r, b->
size
);

113 
	`fÜû_as£¹
(
NULL
 !ğ
b
->
±r
);

114 
	}
}

117 * 
	$bufãr_¡ršg_´•¬e_cİy
(
bufãr
 *
b
, 
size_t
 
size
) {

118 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

119 
	`fÜû_as£¹
(
size
 + 1 > size);

121 
	`bufãr_®loc
(
b
, 
size
 + 1);

123 
b
->
u£d
 = 1;

124 
b
->
±r
[0] = '\0';

126  
b
->
±r
;

127 
	}
}

129 * 
	$bufãr_¡ršg_´•¬e_­³nd
(
bufãr
 *
b
, 
size_t
 
size
) {

130 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

132 ià(
	`bufãr_¡ršg_is_em±y
(
b
)) {

133  
	`bufãr_¡ršg_´•¬e_cİy
(
b
, 
size
);

135 
size_t
 
»q_size
 = 
b
->
u£d
 + 
size
;

138 
	`fÜû_as£¹
(
»q_size
 >ğ
b
->
u£d
);

141 
	`fÜû_as£¹
(
»q_size
 >ğ
b
->
u£d
);

143 
	`bufãr_»®loc
(
b
, 
»q_size
);

145  
b
->
±r
 + b->
u£d
 - 1;

147 
	}
}

149 
	$bufãr_¡ršg_£t_Ëngth
(
bufãr
 *
b
, 
size_t
 
Ën
) {

150 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

151 
	`fÜû_as£¹
(
Ën
 + 1 >†en);

153 
	`bufãr_»®loc
(
b
, 
Ën
 + 1);

155 
b
->
u£d
 = 
Ën
 + 1;

156 
b
->
±r
[
Ën
] = '\0';

157 
	}
}

159 
	$bufãr_comm™
(
bufãr
 *
b
, 
size_t
 
size
)

161 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

162 
	`fÜû_as£¹
(
b
->
size
 > 0);

164 ià(0 =ğ
b
->
u£d
) b->used = 1;

166 ià(
size
 > 0) {

168 
	`fÜû_as£¹
(
b
->
u£d
 + 
size
 > b->used);

170 
	`fÜû_as£¹
(
b
->
u£d
 + 
size
 <= b->size);

171 
b
->
u£d
 +ğ
size
;

174 
b
->
±r
[b->
u£d
 - 1] = '\0';

175 
	}
}

177 
	$bufãr_cİy_¡ršg
(
bufãr
 *
b
, cÚ¡ *
s
) {

178 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
s
, 
NULL
 !ğ ? 
	`¡¾’
(s) : 0);

179 
	}
}

181 
	$bufãr_cİy_¡ršg_Ën
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
) {

182 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

183 
	`fÜû_as£¹
(
NULL
 !ğ
s
 || 
s_Ën
 == 0);

185 
	`bufãr_¡ršg_´•¬e_cİy
(
b
, 
s_Ën
);

187 ià(0 !ğ
s_Ën
è
	`memıy
(
b
->
±r
, 
s
, s_len);

189 
	`bufãr_comm™
(
b
, 
s_Ën
);

190 
	}
}

192 
	$bufãr_cİy_bufãr
(
bufãr
 *
b
, cÚ¡ bufã¸*
¤c
) {

193 ià(
NULL
 =ğ
¤c
 || 0 =ğ¤c->
u£d
) {

194 
	`bufãr_¡ršg_´•¬e_cİy
(
b
, 0);

195 
b
->
u£d
 = 0;

197 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
¤c
->
±r
, 
	`bufãr_¡ršg_Ëngth
(src));

199 
	}
}

201 
	$bufãr_­³nd_¡ršg
(
bufãr
 *
b
, cÚ¡ *
s
) {

202 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
s
, 
NULL
 !ğ ? 
	`¡¾’
(s) : 0);

203 
	}
}

216 
	$bufãr_­³nd_¡ršg_Ën
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
) {

217 *
rg‘_buf
;

219 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

220 
	`fÜû_as£¹
(
NULL
 !ğ
s
 || 
s_Ën
 == 0);

222 
rg‘_buf
 = 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
s_Ën
);

224 ià(0 =ğ
s_Ën
) ;

226 
	`memıy
(
rg‘_buf
, 
s
, 
s_Ën
);

228 
	`bufãr_comm™
(
b
, 
s_Ën
);

229 
	}
}

231 
	$bufãr_­³nd_¡ršg_bufãr
(
bufãr
 *
b
, cÚ¡ bufã¸*
¤c
) {

232 ià(
NULL
 =ğ
¤c
) {

233 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
NULL
, 0);

235 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
¤c
->
±r
, 
	`bufãr_¡ršg_Ëngth
(src));

237 
	}
}

239 
	$bufãr_­³nd_ušt_hex
(
bufãr
 *
b
, 
uštmax_t
 
v®ue
) {

240 *
buf
;

241 
shiá
 = 0;

244 
uštmax_t
 
cİy
 = 
v®ue
;

246 
cİy
 >>= 8;

247 
shiá
 += 2;

248 } 0 !ğ
cİy
);

251 
buf
 = 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
shiá
);

252 
	`bufãr_comm™
(
b
, 
shiá
);

254 
shiá
 <<= 2;

255 
shiá
 > 0) {

256 
shiá
 -= 4;

257 *(
buf
++èğ
hex_ch¬s
[(
v®ue
 >> 
shiá
) & 0x0F];

259 
	}
}

261 * 
	$uto¡r
(* cÚ¡ 
buf_’d
, 
uštmax_t
 
v®
) {

262 *
cur
 = 
buf_’d
;

264 
mod
 = 
v®
 % 10;

265 
v®
 /= 10;

267 *(--
cur
èğ(è('0' + 
mod
);

268 } 0 !ğ
v®
);

269  
cur
;

270 
	}
}

272 * 
	$™o¡r
(* cÚ¡ 
buf_’d
, 
štmax_t
 
v®
) {

277 
uštmax_t
 
uv®
 = 
v®
 >= 0 ? (uintmax_t)val : ((uintmax_t)~val) + 1;

278 *
cur
 = 
	`uto¡r
(
buf_’d
, 
uv®
);

279 ià(
v®
 < 0è*(--
cur
) = '-';

281  
cur
;

282 
	}
}

284 
	$bufãr_­³nd_št
(
bufãr
 *
b
, 
štmax_t
 
v®
) {

285 
buf
[
LI_ITOSTRING_LENGTH
];

286 * cÚ¡ 
buf_’d
 = 
buf
 + (buf);

287 *
¡r
;

289 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

291 
¡r
 = 
	`™o¡r
(
buf_’d
, 
v®
);

292 
	`fÜû_as£¹
(
buf_’d
 > 
¡r
 && sŒ >ğ
buf
);

294 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
¡r
, 
buf_’d
 - str);

295 
	}
}

297 
	$bufãr_cİy_št
(
bufãr
 *
b
, 
štmax_t
 
v®
) {

298 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

300 
b
->
u£d
 = 0;

301 
	`bufãr_­³nd_št
(
b
, 
v®
);

302 
	}
}

304 
	$bufãr_­³nd_¡ráime
(
bufãr
 *
b
, cÚ¡ *
fÜm©
, cÚ¡ 
tm
 *tm) {

305 
size_t
 
r
;

306 * 
buf
;

307 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

308 
	`fÜû_as£¹
(
NULL
 !ğ
tm
);

310 ià(
NULL
 =ğ
fÜm©
 || '\0' == format[0]) {

312 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 0);

316 
buf
 = 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 255);

317 
r
 = 
	`¡ráime
(
buf
, 
	`bufãr_¡ršg_¥aû
(
b
), 
fÜm©
, 
tm
);

323 ià(0 =ğ
r
 ||„ >ğ
	`bufãr_¡ršg_¥aû
(
b
)) {

325 
buf
 = 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 4095);

326 
r
 = 
	`¡ráime
(
buf
, 
	`bufãr_¡ršg_¥aû
(
b
), 
fÜm©
, 
tm
);

329 ià(
r
 >ğ
	`bufãr_¡ršg_¥aû
(
b
))„ = 0;

331 
	`bufãr_comm™
(
b
, 
r
);

332 
	}
}

335 
	$li_™o¡º
(*
buf
, 
size_t
 
buf_Ën
, 
štmax_t
 
v®
) {

336 
p_buf
[
LI_ITOSTRING_LENGTH
];

337 * cÚ¡ 
p_buf_’d
 = 
p_buf
 + (p_buf);

338 * 
¡r
 = 
p_buf_’d
 - 1;

339 *
¡r
 = '\0';

341 
¡r
 = 
	`™o¡r
(¡r, 
v®
);

342 
	`fÜû_as£¹
(
p_buf_’d
 > 
¡r
 && sŒ >ğ
p_buf
);

344 
	`fÜû_as£¹
(
buf_Ën
 >ğ(
size_t
è(
p_buf_’d
 - 
¡r
));

345 
	`memıy
(
buf
, 
¡r
, 
p_buf_’d
 - str);

346 
	}
}

348 
	$li_uto¡º
(*
buf
, 
size_t
 
buf_Ën
, 
uštmax_t
 
v®
) {

349 
p_buf
[
LI_ITOSTRING_LENGTH
];

350 * cÚ¡ 
p_buf_’d
 = 
p_buf
 + (p_buf);

351 * 
¡r
 = 
p_buf_’d
 - 1;

352 *
¡r
 = '\0';

354 
¡r
 = 
	`uto¡r
(¡r, 
v®
);

355 
	`fÜû_as£¹
(
p_buf_’d
 > 
¡r
 && sŒ >ğ
p_buf
);

357 
	`fÜû_as£¹
(
buf_Ën
 >ğ(
size_t
è(
p_buf_’d
 - 
¡r
));

358 
	`memıy
(
buf
, 
¡r
, 
p_buf_’d
 - str);

359 
	}
}

361 
	$št2hex
(
c
) {

362  
hex_ch¬s
[(
c
 & 0x0F)];

363 
	}
}

368 
	$hex2št
(
hex
) {

369 
v®ue
 = 
hex
 - '0';

370 ià(
v®ue
 > 9) {

371 
hex
 |= 0x20;

372 
v®ue
 = 
hex
 - 'a' + 10;

373 ià(
v®ue
 < 10) value = 0xff;

375 ià(
v®ue
 > 15) value = 0xff;

377  
v®ue
;

378 
	}
}

380 * 
	$bufãr_£¬ch_¡ršg_Ën
(
bufãr
 *
b
, cÚ¡ *
ÃedË
, 
size_t
 
Ën
) {

381 
size_t
 
i
;

382 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

383 
	`fÜû_as£¹
(0 !ğ
Ën
 && 
NULL
 !ğ
ÃedË
);

385 ià(
b
->
u£d
 < 
Ën
è 
NULL
;

387 
i
 = 0; i < 
b
->
u£d
 - 
Ën
; i++) {

388 ià(0 =ğ
	`memcmp
(
b
->
±r
 + 
i
, 
ÃedË
, 
Ën
)) {

389  
b
->
±r
 + 
i
;

393  
NULL
;

394 
	}
}

396 
	$bufãr_is_em±y
(cÚ¡ 
bufãr
 *
b
) {

397  
NULL
 =ğ
b
 || 0 =ğb->
u£d
;

398 
	}
}

400 
	$bufãr_¡ršg_is_em±y
(cÚ¡ 
bufãr
 *
b
) {

401  0 =ğ
	`bufãr_¡ršg_Ëngth
(
b
);

402 
	}
}

411 
	$bufãr_is_equ®
(cÚ¡ 
bufãr
 *
a
, cÚ¡ bufã¸*
b
) {

412 
	`fÜû_as£¹
(
NULL
 !ğ
a
 && NULL !ğ
b
);

414 ià(
a
->
u£d
 !ğ
b
->used)  0;

415 ià(
a
->
u£d
 == 0)  1;

417  (0 =ğ
	`memcmp
(
a
->
±r
, 
b
->±r,‡->
u£d
));

418 
	}
}

420 
	$bufãr_is_equ®_¡ršg
(cÚ¡ 
bufãr
 *
a
, cÚ¡ *
s
, 
size_t
 
b_Ën
) {

421 
	`fÜû_as£¹
(
NULL
 !ğ
a
 && NULL !ğ
s
);

422 
	`fÜû_as£¹
(
b_Ën
 + 1 > b_len);

424 ià(
a
->
u£d
 !ğ
b_Ën
 + 1)  0;

425 ià(0 !ğ
	`memcmp
(
a
->
±r
, 
s
, 
b_Ën
))  0;

426 ià('\0' !ğ
a
->
±r
[a->
u£d
-1])  0;

429 
	}
}

432 
	$bufãr_is_equ®_ÿ£Ëss_¡ršg
(cÚ¡ 
bufãr
 *
a
, cÚ¡ *
s
, 
size_t
 
b_Ën
) {

433 
	`fÜû_as£¹
(
NULL
 !ğ
a
);

434 ià(
a
->
u£d
 !ğ
b_Ën
 + 1)  0;

435 
	`fÜû_as£¹
('\0' =ğ
a
->
±r
[a->
u£d
 - 1]);

437  (0 =ğ
	`¡rÿ£cmp
(
a
->
±r
, 
s
));

438 
	}
}

440 
	$bufãr_ÿ£Ëss_com·»
(cÚ¡ *
a
, 
size_t
 
a_Ën
, cÚ¡ *
b
, size_ˆ
b_Ën
) {

441 
size_t
 cÚ¡ 
Ën
 = (
a_Ën
 < 
b_Ën
) ?‡_len : b_len;

442 
size_t
 
i
;

444 
i
 = 0; i < 
Ën
; ++i) {

445 
ÿ
 = 
a
[
i
], 
cb
 = 
b
[i];

446 ià(
ÿ
 =ğ
cb
) ;

449 ià(
ÿ
 >= 'A' && ca <= 'Z') ca |= 32;

450 ià(
cb
 >= 'A' && cb <= 'Z') cb |= 32;

452 ià(
ÿ
 =ğ
cb
) ;

453  (()
ÿ
è- (()
cb
);

455 ià(
a_Ën
 =ğ
b_Ën
)  0;

456  
a_Ën
 < 
b_Ën
 ? -1 : 1;

457 
	}
}

459 
	$bufãr_is_equ®_right_Ën
(cÚ¡ 
bufãr
 *
b1
, cÚ¡ bufã¸*
b2
, 
size_t
 
Ën
) {

461 ià(
Ën
 == 0)  1;

464 ià(
b1
->
u£d
 =ğ0 || 
b2
->used == 0)  0;

467 ià(
b1
->
u£d
 - 1 < 
Ën
 || 
b2
->used - 1 <†en)  0;

469  0 =ğ
	`memcmp
(
b1
->
±r
 + b1->
u£d
 - 1 - 
Ën
, 
b2
->ptr + b2->used - 1 -†en,†en);

470 
	}
}

472 
	$li_tohex
(*
buf
, 
size_t
 
buf_Ën
, cÚ¡ *
s
, size_ˆ
s_Ën
) {

473 
size_t
 
i
;

474 
	`fÜû_as£¹
(2 * 
s_Ën
 > s_len);

475 
	`fÜû_as£¹
(2 * 
s_Ën
 < 
buf_Ën
);

477 
i
 = 0; i < 
s_Ën
; i++) {

478 
buf
[2*
i
] = 
hex_ch¬s
[(
s
[i] >> 4) & 0x0F];

479 
buf
[2*
i
+1] = 
hex_ch¬s
[
s
[i] & 0x0F];

481 
buf
[2*
s_Ën
] = '\0';

482 
	}
}

484 
	$bufãr_cİy_¡ršg_hex
(
bufãr
 *
b
, cÚ¡ *
š
, 
size_t
 
š_Ën
) {

486 
	`fÜû_as£¹
(
š_Ën
 * 2 > in_len);

488 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 2 * 
š_Ën
);

489 
	`li_tohex
(
b
->
±r
, 
	`bufãr_¡ršg_Ëngth
(b)+1, 
š
, 
š_Ën
);

490 
	}
}

493 cÚ¡ 
	g’coded_ch¬s_»l_uri_·¹
[] = {

516 cÚ¡ 
	g’coded_ch¬s_»l_uri
[] = {

538 cÚ¡ 
	g’coded_ch¬s_html
[] = {

560 cÚ¡ 
	g’coded_ch¬s_mšim®_xml
[] = {

582 cÚ¡ 
	g’coded_ch¬s_hex
[] = {

604 cÚ¡ 
	g’coded_ch¬s_h‰p_h—d”
[] = {

628 
	$bufãr_­³nd_¡ršg_’coded
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
, 
bufãr_’codšg_t
 
’codšg
) {

629 *
ds
, *
d
;

630 
size_t
 
d_Ën
, 
ndx
;

631 cÚ¡ *
m­
 = 
NULL
;

633 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

634 
	`fÜû_as£¹
(
NULL
 !ğ
s
 || 0 =ğ
s_Ën
);

636 ià(0 =ğ
s_Ën
) ;

638 
’codšg
) {

639 
ENCODING_REL_URI
:

640 
m­
 = 
’coded_ch¬s_»l_uri
;

642 
ENCODING_REL_URI_PART
:

643 
m­
 = 
’coded_ch¬s_»l_uri_·¹
;

645 
ENCODING_HTML
:

646 
m­
 = 
’coded_ch¬s_html
;

648 
ENCODING_MINIMAL_XML
:

649 
m­
 = 
’coded_ch¬s_mšim®_xml
;

651 
ENCODING_HEX
:

652 
m­
 = 
’coded_ch¬s_hex
;

654 
ENCODING_HTTP_HEADER
:

655 
m­
 = 
’coded_ch¬s_h‰p_h—d”
;

659 
	`fÜû_as£¹
(
NULL
 !ğ
m­
);

662 
ds
 = (*)
s
, 
d_Ën
 = 0, 
ndx
 = 0;‚dx < 
s_Ën
; ds++,‚dx++) {

663 ià(
m­
[*
ds
]) {

664 
’codšg
) {

665 
ENCODING_REL_URI
:

666 
ENCODING_REL_URI_PART
:

667 
d_Ën
 += 3;

669 
ENCODING_HTML
:

670 
ENCODING_MINIMAL_XML
:

671 
d_Ën
 += 6;

673 
ENCODING_HTTP_HEADER
:

674 
ENCODING_HEX
:

675 
d_Ën
 += 2;

679 
d_Ën
++;

683 
d
 = (*è
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
d_Ën
);

684 
	`bufãr_comm™
(
b
, 
d_Ën
);

685 
	`fÜû_as£¹
('\0' =ğ*
d
);

687 
ds
 = (*)
s
, 
d_Ën
 = 0, 
ndx
 = 0;‚dx < 
s_Ën
; ds++,‚dx++) {

688 ià(
m­
[*
ds
]) {

689 
’codšg
) {

690 
ENCODING_REL_URI
:

691 
ENCODING_REL_URI_PART
:

692 
d
[
d_Ën
++] = '%';

693 
d
[
d_Ën
++] = 
hex_ch¬s
[((*
ds
) >> 4) & 0x0F];

694 
d
[
d_Ën
++] = 
hex_ch¬s
[(*
ds
) & 0x0F];

696 
ENCODING_HTML
:

697 
ENCODING_MINIMAL_XML
:

698 
d
[
d_Ën
++] = '&';

699 
d
[
d_Ën
++] = '#';

700 
d
[
d_Ën
++] = 'x';

701 
d
[
d_Ën
++] = 
hex_ch¬s
[((*
ds
) >> 4) & 0x0F];

702 
d
[
d_Ën
++] = 
hex_ch¬s
[(*
ds
) & 0x0F];

703 
d
[
d_Ën
++] = ';';

705 
ENCODING_HEX
:

706 
d
[
d_Ën
++] = 
hex_ch¬s
[((*
ds
) >> 4) & 0x0F];

707 
d
[
d_Ën
++] = 
hex_ch¬s
[(*
ds
) & 0x0F];

709 
ENCODING_HTTP_HEADER
:

710 
d
[
d_Ën
++] = *
ds
;

711 
d
[
d_Ën
++] = '\t';

715 
d
[
d_Ën
++] = *
ds
;

718 
	}
}

720 
	$bufãr_­³nd_¡ršg_c_esÿ³d
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
) {

721 *
ds
, *
d
;

722 
size_t
 
d_Ën
, 
ndx
;

724 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

725 
	`fÜû_as£¹
(
NULL
 !ğ
s
 || 0 =ğ
s_Ën
);

727 ià(0 =ğ
s_Ën
) ;

730 
ds
 = (*)
s
, 
d_Ën
 = 0, 
ndx
 = 0;‚dx < 
s_Ën
; ds++,‚dx++) {

731 ià((*
ds
 < 0x20)

732 || (*
ds
 >= 0x7f)) {

733 *
ds
) {

737 
d_Ën
 += 2;

740 
d_Ën
 += 4;

744 
d_Ën
++;

748 
d
 = (*è
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
d_Ën
);

749 
	`bufãr_comm™
(
b
, 
d_Ën
);

750 
	`fÜû_as£¹
('\0' =ğ*
d
);

752 
ds
 = (*)
s
, 
d_Ën
 = 0, 
ndx
 = 0;‚dx < 
s_Ën
; ds++,‚dx++) {

753 ià((*
ds
 < 0x20)

754 || (*
ds
 >= 0x7f)) {

755 
d
[
d_Ën
++] = '\\';

756 *
ds
) {

758 
d
[
d_Ën
++] = 't';

761 
d
[
d_Ën
++] = 'r';

764 
d
[
d_Ën
++] = 'n';

767 
d
[
d_Ën
++] = 'x';

768 
d
[
d_Ën
++] = 
hex_ch¬s
[((*
ds
) >> 4) & 0x0F];

769 
d
[
d_Ën
++] = 
hex_ch¬s
[(*
ds
) & 0x0F];

773 
d
[
d_Ën
++] = *
ds
;

776 
	}
}

779 
	$bufãr_cİy_¡ršg_’coded_cgi_v¬Çmes
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
, 
is_h‰p_h—d”
) {

780 
size_t
 
i
, 
j
;

782 
	`fÜû_as£¹
(
NULL
 !ğ
b
);

783 
	`fÜû_as£¹
(
NULL
 !ğ
s
 || 0 =ğ
s_Ën
);

785 
	`bufãr_»£t
(
b
);

787 ià(
is_h‰p_h—d”
 && 
NULL
 !ğ
s
 && 0 !ğ
	`¡rÿ£cmp
(s, "CONTENT-TYPE")) {

788 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
s_Ën
 + 5);

789 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("HTTP_"));

791 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
s_Ën
);

794 
j
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

795 
i
 = 0; i < 
s_Ën
; ++i) {

796 
ü
 = 
s
[
i
];

797 ià(
	`light_i§Íha
(
ü
)) {

799 
ü
 &= ~32;

800 } ià(!
	`light_isdig™
(
ü
)) {

801 
ü
 = '_';

803 
b
->
±r
[
j
++] = 
ü
;

805 
b
->
u£d
 = 
j
;

806 
b
->
±r
[b->
u£d
++] = '\0';

807 
	}
}

813 
	$bufãr_u¾decode_š‹º®
(
bufãr
 *
u¾
, 
is_qu”y
) {

814 
high
, 
low
;

815 *
¤c
;

816 *
d¡
;

818 
	`fÜû_as£¹
(
NULL
 !ğ
u¾
);

819 ià(
	`bufãr_¡ršg_is_em±y
(
u¾
)) ;

821 
	`fÜû_as£¹
('\0' =ğ
u¾
->
±r
[u¾->
u£d
-1]);

823 
¤c
 = (*è
u¾
->
±r
;

825 '\0' !ğ*
¤c
) {

826 ià('%' =ğ*
¤c
) ;

827 ià(
is_qu”y
 && '+' =ğ*
¤c
) *src = ' ';

828 
¤c
++;

830 
d¡
 = 
¤c
;

832 '\0' !ğ*
¤c
) {

833 ià(
is_qu”y
 && *
¤c
 == '+') {

834 *
d¡
 = ' ';

835 } ià(*
¤c
 == '%') {

836 *
d¡
 = '%';

838 
high
 = 
	`hex2št
(*(
¤c
 + 1));

839 ià(0xFF !ğ
high
) {

840 
low
 = 
	`hex2št
(*(
¤c
 + 2));

841 ià(0xFF !ğ
low
) {

842 
high
 = (high << 4è| 
low
;

845 ià(
high
 < 32 || high == 127) high = '_';

847 *
d¡
 = 
high
;

848 
¤c
 += 2;

852 *
d¡
 = *
¤c
;

855 
d¡
++;

856 
¤c
++;

859 *
d¡
 = '\0';

860 
u¾
->
u£d
 = (
d¡
 - u¾->
±r
) + 1;

861 
	}
}

863 
	$bufãr_u¾decode_·th
(
bufãr
 *
u¾
) {

864 
	`bufãr_u¾decode_š‹º®
(
u¾
, 0);

865 
	}
}

867 
	$bufãr_u¾decode_qu”y
(
bufãr
 *
u¾
) {

868 
	`bufãr_u¾decode_š‹º®
(
u¾
, 1);

869 
	}
}

890 
	$bufãr_·th_sim¶ify
(
bufãr
 *
de¡
, bufã¸*
¤c
)

893 
c
, 
´e1
, 
´e2
;

894 *
¡¬t
, *
¦ash
, *
w®k
, *
out
;

896 
	`fÜû_as£¹
(
NULL
 !ğ
de¡
 && NULL !ğ
¤c
);

898 ià(
	`bufãr_¡ršg_is_em±y
(
¤c
)) {

899 
	`bufãr_¡ršg_´•¬e_cİy
(
de¡
, 0);

903 
	`fÜû_as£¹
('\0' =ğ
¤c
->
±r
[¤c->
u£d
-1]);

906 ià(
¤c
 =ğ
de¡
) {

907 
	`bufãr_¡ršg_´•¬e_­³nd
(
de¡
, 1);

909 
	`bufãr_¡ršg_´•¬e_cİy
(
de¡
, 
	`bufãr_¡ršg_Ëngth
(
¤c
) + 1);

912 #ià
	`defšed
(
__WIN32
è|| defšed(
__CYGWIN__
)

915 *
p
;

916 
p
 = 
¤c
->
±r
; *p;…++) {

917 ià(*
p
 == '\\') *p = '/';

922 
w®k
 = 
¤c
->
±r
;

923 
¡¬t
 = 
de¡
->
±r
;

924 
out
 = 
de¡
->
±r
;

925 
¦ash
 = 
de¡
->
±r
;

928 *
w®k
 == ' ') {

929 
w®k
++;

932 
´e1
 = 0;

933 
c
 = *(
w®k
++);

935 ià(
c
 != '/') {

936 
´e1
 = '/';

937 *(
out
++) = '/';

940 
c
 != '\0') {

945 
´e2
 = 
´e1
;

946 
´e1
 = 
c
;

949 
c
 = *
w®k
;

950 *
out
 = 
´e1
;

952 
out
++;

953 
w®k
++;

956 ià(
c
 == '/' || c == '\0') {

957 cÚ¡ 
size_t
 
tokËn
 = 
out
 - 
¦ash
;

958 ià(
tokËn
 =ğ3 && 
´e2
 =ğ'.' && 
´e1
 == '.') {

960 
out
 = 
¦ash
;

963 ià(
out
 > 
¡¬t
) {

964 
out
--;

965 
out
 > 
¡¬t
 && *out != '/') out--;

969 ià(
c
 =ğ'\0'è
out
++;

971 } ià(
tokËn
 =ğ1 || (
´e2
 =ğ'/' && 
´e1
 == '.')) {

973 
out
 = 
¦ash
;

975 ià(
c
 =ğ'\0'è
out
++;

979 
¦ash
 = 
out
;

983 
	`bufãr_¡ršg_£t_Ëngth
(
de¡
, 
out
 - 
¡¬t
);

984 
	}
}

986 
	$light_isdig™
(
c
) {

987  (
c
 >= '0' && c <= '9');

988 
	}
}

990 
	$light_isxdig™
(
c
) {

991 ià(
	`light_isdig™
(
c
))  1;

993 
c
 |= 32;

994  (
c
 >= 'a' && c <= 'f');

995 
	}
}

997 
	$light_i§Íha
(
c
) {

998 
c
 |= 32;

999  (
c
 >= 'a' && c <= 'z');

1000 
	}
}

1002 
	$light_i§Êum
(
c
) {

1003  
	`light_isdig™
(
c
è|| 
	`light_i§Íha
(c);

1004 
	}
}

1006 
	$bufãr_to_low”
(
bufãr
 *
b
) {

1007 
size_t
 
i
;

1009 
i
 = 0; i < 
b
->
u£d
; ++i) {

1010 
c
 = 
b
->
±r
[
i
];

1011 ià(
c
 >ğ'A' && c <ğ'Z'è
b
->
±r
[
i
] |= 0x20;

1013 
	}
}

1016 
	$bufãr_to_uµ”
(
bufãr
 *
b
) {

1017 
size_t
 
i
;

1019 
i
 = 0; i < 
b
->
u£d
; ++i) {

1020 
c
 = 
b
->
±r
[
i
];

1021 ià(
c
 >ğ'A' && c <ğ'Z'è
b
->
±r
[
i
] &= ~0x20;

1023 
	}
}

1025 #ifdeà
HAVE_LIBUNWIND


1026 
	#UNW_LOCAL_ONLY


	)

1027 
	~<libunwšd.h
>

1029 
	$´št_backŒaû
(
FILE
 *
fe
) {

1030 
unw_cursÜ_t
 
cursÜ
;

1031 
unw_cÚ‹xt_t
 
cÚ‹xt
;

1032 
»t
;

1033 
äame
 = 0;

1035 ià(0 !ğ(
»t
 = 
	`unw_g‘cÚ‹xt
(&
cÚ‹xt
))è
”rÜ
;

1036 ià(0 !ğ(
»t
 = 
	`unw_š™_loÿl
(&
cursÜ
, &
cÚ‹xt
))è
”rÜ
;

1038 
	`årštf
(
fe
, "Backtrace:\n");

1040 0 < (
»t
 = 
	`unw_¡•
(&
cursÜ
))) {

1041 
unw_wÜd_t
 
´oc_
 = 0;

1042 
unw_´oc_šfo_t
 
´ocšfo
;

1043 
´oúame
[256];

1044 
unw_wÜd_t
 
´oc_off£t
 = 0;

1046 ià(0 !ğ(
»t
 = 
	`unw_g‘_»g
(&
cursÜ
, 
UNW_REG_IP
, &
´oc_
))è
”rÜ
;

1048 ià(0 =ğ
´oc_
) {

1050 ++
äame
;

1051 
	`årštf
(
fe
, "%u: (n)\n", 
äame
);

1055 ià(0 !ğ(
»t
 = 
	`unw_g‘_´oc_šfo
(&
cursÜ
, &
´ocšfo
))è
”rÜ
;

1057 ià(0 !ğ(
»t
 = 
	`unw_g‘_´oc_Çme
(&
cursÜ
, 
´oúame
, Õroúame), &
´oc_off£t
))) {

1058 -
»t
) {

1059 
UNW_ENOMEM
:

1060 
	`mem£t
(
´oúame
 + (procname) - 4, '.', 3);

1061 
´oúame
[(procname) - 1] = '\0';

1063 
UNW_ENOINFO
:

1064 
´oúame
[0] = '?';

1065 
´oúame
[1] = '\0';

1066 
´oc_off£t
 = 0;

1069 
	`¢´štf
(
´oúame
, Õroúame), "?? (unw_g‘_´oc_Çm”rÜ %d)", -
»t
);

1074 ++
äame
;

1075 
	`årštf
(
fe
, "%u: %s (+0x%x) [%p]\n",

1076 
äame
,

1077 
´oúame
,

1078 (è
´oc_off£t
,

1079 (*)(
ušŒ_t
)
´oc_
);

1082 ià(0 !ğ
»t
è
”rÜ
;

1086 
”rÜ
:

1087 
	`årštf
(
fe
, "E¼Ü whg’”©šg backŒaû: unwšdƒ¼Ü %i\n", (è-
»t
);

1088 
	}
}

1090 
	$´št_backŒaû
(
FILE
 *
fe
) {

1091 
	`UNUSED
(
fe
);

1092 
	}
}

1095 
	$log_çed_as£¹
(cÚ¡ *
f’ame
, 
lše
, cÚ¡ *
msg
) {

1097 
	`årštf
(
¡d”r
, "%s.%u: %s\n", 
f’ame
, 
lše
, 
msg
);

1098 
	`´št_backŒaû
(
¡d”r
);

1099 
	`fæush
(
¡d”r
);

1100 
	`abÜt
();

1101 
	}
}

	@buffer.h

1 #iâdeà
_BUFFER_H_


2 
	#_BUFFER_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£‰šgs.h
"

7 
	~<¡dlib.h
>

8 
	~<sys/ty³s.h
>

9 
	~<¡dio.h
>

10 
	~<time.h
>

12 
	~<¡dšt.h
>

14 #ià
defšed
 
HAVE_STDINT_H


15 
	~<¡dšt.h
>

16 #–ià
defšed
 
HAVE_INTTYPES_H


17 
	~<š‰y³s.h
>

32 *
	m±r
;

35 
size_t
 
	mu£d
;

37 
size_t
 
	msize
;

38 } 
	tbufãr
;

41 
bufãr
* 
bufãr_š™
();

42 
bufãr
* 
bufãr_š™_bufãr
(cÚ¡ bufã¸*
¤c
);

43 
bufãr
* 
bufãr_š™_¡ršg
(cÚ¡ *
¡r
);

45 
bufãr_ä“
(
bufãr
 *
b
);

47 
bufãr_»£t
(
bufãr
 *
b
);

50 
bufãr_move
(
bufãr
 *
b
, bufã¸*
¤c
);

57 * 
bufãr_¡ršg_´•¬e_cİy
(
bufãr
 *
b
, 
size_t
 
size
);

65 * 
bufãr_¡ršg_´•¬e_­³nd
(
bufãr
 *
b
, 
size_t
 
size
);

72 
bufãr_comm™
(
bufãr
 *
b
, 
size_t
 
size
);

79 
bufãr_¡ršg_£t_Ëngth
(
bufãr
 *
b
, 
size_t
 
Ën
);

81 
bufãr_cİy_¡ršg
(
bufãr
 *
b
, cÚ¡ *
s
);

82 
bufãr_cİy_¡ršg_Ën
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
);

83 
bufãr_cİy_bufãr
(
bufãr
 *
b
, cÚ¡ bufã¸*
¤c
);

85 
bufãr_cİy_¡ršg_hex
(
bufãr
 *
b
, cÚ¡ *
š
, 
size_t
 
š_Ën
);

87 
bufãr_­³nd_¡ršg
(
bufãr
 *
b
, cÚ¡ *
s
);

88 
bufãr_­³nd_¡ršg_Ën
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
);

89 
bufãr_­³nd_¡ršg_bufãr
(
bufãr
 *
b
, cÚ¡ bufã¸*
¤c
);

91 
bufãr_­³nd_ušt_hex
(
bufãr
 *
b
, 
uštmax_t
 
Ën
);

92 
bufãr_­³nd_št
(
bufãr
 *
b
, 
štmax_t
 
v®
);

93 
bufãr_cİy_št
(
bufãr
 *
b
, 
štmax_t
 
v®
);

95 
bufãr_­³nd_¡ráime
(
bufãr
 *
b
, cÚ¡ *
fÜm©
, cÚ¡ 
tm
 *tm);

98 
	#LI_ITOSTRING_LENGTH
 (2 + (8 * (
štmax_t
è* 31 + 99è/ 100)

	)

100 
li_™o¡º
(*
buf
, 
size_t
 
buf_Ën
, 
štmax_t
 
v®
);

101 
li_uto¡º
(*
buf
, 
size_t
 
buf_Ën
, 
uštmax_t
 
v®
);

104 
li_tohex
(*
buf
, 
size_t
 
buf_Ën
, cÚ¡ *
s
, size_ˆ
s_Ën
);

106 * 
bufãr_£¬ch_¡ršg_Ën
(
bufãr
 *
b
, cÚ¡ *
ÃedË
, 
size_t
 
Ën
);

112 
bufãr_is_em±y
(cÚ¡ 
bufãr
 *
b
);

114 
bufãr_¡ršg_is_em±y
(cÚ¡ 
bufãr
 *
b
);

116 
bufãr_is_equ®
(cÚ¡ 
bufãr
 *
a
, cÚ¡ bufã¸*
b
);

117 
bufãr_is_equ®_right_Ën
(cÚ¡ 
bufãr
 *
a
, cÚ¡ bufã¸*
b
, 
size_t
 
Ën
);

118 
bufãr_is_equ®_¡ršg
(cÚ¡ 
bufãr
 *
a
, cÚ¡ *
s
, 
size_t
 
b_Ën
);

119 
bufãr_is_equ®_ÿ£Ëss_¡ršg
(cÚ¡ 
bufãr
 *
a
, cÚ¡ *
s
, 
size_t
 
b_Ën
);

120 
bufãr_ÿ£Ëss_com·»
(cÚ¡ *
a
, 
size_t
 
a_Ën
, cÚ¡ *
b
, size_ˆ
b_Ën
);

123 
	mENCODING_REL_URI
,

124 
	mENCODING_REL_URI_PART
,

125 
	mENCODING_HTML
,

126 
	mENCODING_MINIMAL_XML
,

127 
	mENCODING_HEX
,

128 
	mENCODING_HTTP_HEADER


129 } 
	tbufãr_’codšg_t
;

131 
bufãr_­³nd_¡ršg_’coded
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
, 
bufãr_’codšg_t
 
’codšg
);

134 
bufãr_­³nd_¡ršg_c_esÿ³d
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
);

137 
bufãr_cİy_¡ršg_’coded_cgi_v¬Çmes
(
bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
s_Ën
, 
is_h‰p_h—d”
);

139 
bufãr_u¾decode_·th
(
bufãr
 *
u¾
);

140 
bufãr_u¾decode_qu”y
(
bufãr
 *
u¾
);

141 
bufãr_·th_sim¶ify
(
bufãr
 *
de¡
, bufã¸*
¤c
);

143 
bufãr_to_low”
(
bufãr
 *
b
);

144 
bufãr_to_uµ”
(
bufãr
 *
b
);

148 
hex2št
(
c
);

149 
št2hex
(
i
);

151 
light_isdig™
(
c
);

152 
light_isxdig™
(
c
);

153 
light_i§Íha
(
c
);

154 
light_i§Êum
(
c
);

156 
šlše
 
size_t
 
bufãr_¡ršg_Ëngth
(cÚ¡ 
bufãr
 *
b
);

157 
šlše
 
size_t
 
bufãr_¡ršg_¥aû
(cÚ¡ 
bufãr
 *
b
);

158 
šlše
 
bufãr_­³nd_¦ash
(
bufãr
 *
b
);

160 
	#BUFFER_APPEND_STRING_CONST
(
x
, 
y
) \

161 
	`bufãr_­³nd_¡ršg_Ën
(
x
, 
y
, (yè- 1)

	)

163 
	#BUFFER_COPY_STRING_CONST
(
x
, 
y
) \

164 
	`bufãr_cİy_¡ršg_Ën
(
x
, 
y
, (yè- 1)

	)

166 
	#CONST_STR_LEN
(
x
èx, (xè? (xè- 1 : 0

	)

167 
	#CONST_BUF_LEN
(
x
è((xè? (x)->
±r
 : 
NULL
), 
	`bufãr_¡ršg_Ëngth
(x)

	)

170 
´št_backŒaû
(
FILE
 *
fe
);

171 
	$log_çed_as£¹
(cÚ¡ *
f’ame
, 
lše
, cÚ¡ *
msg
è
LI_NORETURN
;

172 
	#fÜû_as£¹
(
x
èdØ{ ià(!(x)è
	`log_çed_as£¹
(
__FILE__
, 
__LINE__
, "as£¹iÚ faed: " #x); 
	}
} 0)

	)

173 
	#SEGFAULT
(è
	`log_çed_as£¹
(
__FILE__
, 
__LINE__
, "abÜ‹d");

	)

177 
šlše
 
size_t
 
	$bufãr_¡ršg_Ëngth
(cÚ¡ 
bufãr
 *
b
) {

178  
NULL
 !ğ
b
 && 0 !ğb->
u£d
 ? b->used - 1 : 0;

179 
	}
}

181 
šlše
 
size_t
 
	$bufãr_¡ršg_¥aû
(cÚ¡ 
bufãr
 *
b
) {

182 ià(
NULL
 =ğ
b
 || b->
size
 == 0)  0;

183 ià(0 =ğ
b
->
u£d
è b->
size
 - 1;

184  
b
->
size
 - b->
u£d
;

185 
	}
}

187 
šlše
 
	$bufãr_­³nd_¦ash
(
bufãr
 *
b
) {

188 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

189 ià(
Ën
 > 0 && '/' !ğ
b
->
±r
[Ën-1]è
	`BUFFER_APPEND_STRING_CONST
(b, "/");

190 
	}
}

	@build/CMakeFiles/3.9.2/CompilerIdC/CMakeCCompilerId.c

1 #ifdeà
__ılu¥lus


5 #ià
defšed
(
__18CXX
)

6 
	#ID_VOID_MAIN


	)

8 #ià
defšed
(
__CLASSIC_C__
)

10 cÚ¡

	)

11 vŞ©e

	)

18 #ià
defšed
(
__INTEL_COMPILER
è|| defšed(
__ICC
)

19 
	#COMPILER_ID
 "IÁ–"

	)

20 #ià
defšed
(
_MSC_VER
)

21 
	#SIMULATE_ID
 "MSVC"

	)

24 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__INTEL_COMPILER
/100)

	)

25 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__INTEL_COMPILER
/10 % 10)

	)

26 #ià
defšed
(
__INTEL_COMPILER_UPDATE
)

27 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__INTEL_COMPILER_UPDATE
)

	)

29 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__INTEL_COMPILER
 % 10)

	)

31 #ià
defšed
(
__INTEL_COMPILER_BUILD_DATE
)

33 
	#COMPILER_VERSION_TWEAK
 
	`DEC
(
__INTEL_COMPILER_BUILD_DATE
)

	)

35 #ià
defšed
(
_MSC_VER
)

37 
	#SIMULATE_VERSION_MAJOR
 
	`DEC
(
_MSC_VER
 / 100)

	)

38 
	#SIMULATE_VERSION_MINOR
 
	`DEC
(
_MSC_VER
 % 100)

	)

41 #–ià
defšed
(
__PATHCC__
)

42 
	#COMPILER_ID
 "P©hSÿË"

	)

43 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__PATHCC__
)

	)

44 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__PATHCC_MINOR__
)

	)

45 #ià
defšed
(
__PATHCC_PATCHLEVEL__
)

46 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__PATHCC_PATCHLEVEL__
)

	)

49 #–ià
defšed
(
__BORLANDC__
è&& defšed(
__CODEGEARC_VERSION__
)

50 
	#COMPILER_ID
 "Emb¬ÿd”o"

	)

51 
	#COMPILER_VERSION_MAJOR
 
	`HEX
(
__CODEGEARC_VERSION__
>>24 & 0x00FF)

	)

52 
	#COMPILER_VERSION_MINOR
 
	`HEX
(
__CODEGEARC_VERSION__
>>16 & 0x00FF)

	)

53 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__CODEGEARC_VERSION__
 & 0xFFFF)

	)

55 #–ià
defšed
(
__BORLANDC__
)

56 
	#COMPILER_ID
 "BÜÏnd"

	)

58 
	#COMPILER_VERSION_MAJOR
 
	`HEX
(
__BORLANDC__
>>8)

	)

59 
	#COMPILER_VERSION_MINOR
 
	`HEX
(
__BORLANDC__
 & 0xFF)

	)

61 #–ià
defšed
(
__WATCOMC__
) && __WATCOMC__ < 1200

62 
	#COMPILER_ID
 "W©com"

	)

64 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__WATCOMC__
 / 100)

	)

65 
	#COMPILER_VERSION_MINOR
 
	`DEC
((
__WATCOMC__
 / 10è% 10)

	)

66 #ià(
__WATCOMC__
 % 10) > 0

67 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__WATCOMC__
 % 10)

	)

70 #–ià
defšed
(
__WATCOMC__
)

71 
	#COMPILER_ID
 "O³nW©com"

	)

73 
	#COMPILER_VERSION_MAJOR
 
	`DEC
((
__WATCOMC__
 - 1100è/ 100)

	)

74 
	#COMPILER_VERSION_MINOR
 
	`DEC
((
__WATCOMC__
 / 10è% 10)

	)

75 #ià(
__WATCOMC__
 % 10) > 0

76 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__WATCOMC__
 % 10)

	)

79 #–ià
defšed
(
__SUNPRO_C
)

80 
	#COMPILER_ID
 "SunPro"

	)

81 #ià
__SUNPRO_C
 >= 0x5100

83 
	#COMPILER_VERSION_MAJOR
 
	`HEX
(
__SUNPRO_C
>>12)

	)

84 
	#COMPILER_VERSION_MINOR
 
	`HEX
(
__SUNPRO_C
>>4 & 0xFF)

	)

85 
	#COMPILER_VERSION_PATCH
 
	`HEX
(
__SUNPRO_C
 & 0xF)

	)

88 
	#COMPILER_VERSION_MAJOR
 
	`HEX
(
__SUNPRO_C
>>8)

	)

89 
	#COMPILER_VERSION_MINOR
 
	`HEX
(
__SUNPRO_C
>>4 & 0xF)

	)

90 
	#COMPILER_VERSION_PATCH
 
	`HEX
(
__SUNPRO_C
 & 0xF)

	)

93 #–ià
defšed
(
__HP_cc
)

94 
	#COMPILER_ID
 "HP"

	)

96 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__HP_cc
/10000)

	)

97 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__HP_cc
/100 % 100)

	)

98 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__HP_cc
 % 100)

	)

100 #–ià
defšed
(
__DECC
)

101 
	#COMPILER_ID
 "Com·q"

	)

103 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__DECC_VER
/10000000)

	)

104 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__DECC_VER
/100000 % 100)

	)

105 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__DECC_VER
 % 10000)

	)

107 #–ià
defšed
(
__IBMC__
è&& defšed(
__COMPILER_VER__
)

108 
	#COMPILER_ID
 "zOS"

	)

110 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__IBMC__
/100)

	)

111 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__IBMC__
/10 % 10)

	)

112 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__IBMC__
 % 10)

	)

114 #–ià
defšed
(
__IBMC__
è&& !defšed(
__COMPILER_VER__
) && __IBMC__ >= 800

115 
	#COMPILER_ID
 "XL"

	)

117 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__IBMC__
/100)

	)

118 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__IBMC__
/10 % 10)

	)

119 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__IBMC__
 % 10)

	)

121 #–ià
defšed
(
__IBMC__
è&& !defšed(
__COMPILER_VER__
) && __IBMC__ < 800

122 
	#COMPILER_ID
 "Visu®Age"

	)

124 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__IBMC__
/100)

	)

125 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__IBMC__
/10 % 10)

	)

126 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__IBMC__
 % 10)

	)

128 #–ià
defšed
(
__PGI
)

129 
	#COMPILER_ID
 "PGI"

	)

130 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__PGIC__
)

	)

131 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__PGIC_MINOR__
)

	)

132 #ià
defšed
(
__PGIC_PATCHLEVEL__
)

133 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__PGIC_PATCHLEVEL__
)

	)

136 #–ià
defšed
(
_CRAYC
)

137 
	#COMPILER_ID
 "C¿y"

	)

138 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
_RELEASE_MAJOR
)

	)

139 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
_RELEASE_MINOR
)

	)

141 #–ià
defšed
(
__TI_COMPILER_VERSION__
)

142 
	#COMPILER_ID
 "TI"

	)

144 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__TI_COMPILER_VERSION__
/1000000)

	)

145 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__TI_COMPILER_VERSION__
/1000 % 1000)

	)

146 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__TI_COMPILER_VERSION__
 % 1000)

	)

148 #–ià
defšed
(
__FUJITSU
è|| defšed(
__FCC_VERSION
è|| defšed(
__fcc_v”siÚ
)

149 
	#COMPILER_ID
 "Fuj™su"

	)

151 #–ià
defšed
(
__TINYC__
)

152 
	#COMPILER_ID
 "TšyCC"

	)

154 #–ià
defšed
(
__BCC__
)

155 
	#COMPILER_ID
 "Bruû"

	)

157 #–ià
defšed
(
__SCO_VERSION__
)

158 
	#COMPILER_ID
 "SCO"

	)

160 #–ià
defšed
(
__şªg__
è&& defšed(
__­¶e_bud_v”siÚ__
)

161 
	#COMPILER_ID
 "AµËCÏng"

	)

162 #ià
defšed
(
_MSC_VER
)

163 
	#SIMULATE_ID
 "MSVC"

	)

165 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__şªg_majÜ__
)

	)

166 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__şªg_mšÜ__
)

	)

167 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__şªg_·tchËv–__
)

	)

168 #ià
defšed
(
_MSC_VER
)

170 
	#SIMULATE_VERSION_MAJOR
 
	`DEC
(
_MSC_VER
 / 100)

	)

171 
	#SIMULATE_VERSION_MINOR
 
	`DEC
(
_MSC_VER
 % 100)

	)

173 
	#COMPILER_VERSION_TWEAK
 
	`DEC
(
__­¶e_bud_v”siÚ__
)

	)

175 #–ià
defšed
(
__şªg__
)

176 
	#COMPILER_ID
 "CÏng"

	)

177 #ià
defšed
(
_MSC_VER
)

178 
	#SIMULATE_ID
 "MSVC"

	)

180 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__şªg_majÜ__
)

	)

181 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__şªg_mšÜ__
)

	)

182 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__şªg_·tchËv–__
)

	)

183 #ià
defšed
(
_MSC_VER
)

185 
	#SIMULATE_VERSION_MAJOR
 
	`DEC
(
_MSC_VER
 / 100)

	)

186 
	#SIMULATE_VERSION_MINOR
 
	`DEC
(
_MSC_VER
 % 100)

	)

189 #–ià
defšed
(
__GNUC__
)

190 
	#COMPILER_ID
 "GNU"

	)

191 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__GNUC__
)

	)

192 #ià
defšed
(
__GNUC_MINOR__
)

193 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__GNUC_MINOR__
)

	)

195 #ià
defšed
(
__GNUC_PATCHLEVEL__
)

196 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__GNUC_PATCHLEVEL__
)

	)

199 #–ià
defšed
(
_MSC_VER
)

200 
	#COMPILER_ID
 "MSVC"

	)

202 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
_MSC_VER
 / 100)

	)

203 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
_MSC_VER
 % 100)

	)

204 #ià
defšed
(
_MSC_FULL_VER
)

205 #ià
_MSC_VER
 >= 1400

207 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
_MSC_FULL_VER
 % 100000)

	)

210 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
_MSC_FULL_VER
 % 10000)

	)

213 #ià
defšed
(
_MSC_BUILD
)

214 
	#COMPILER_VERSION_TWEAK
 
	`DEC
(
_MSC_BUILD
)

	)

217 #–ià
defšed
(
__VISUALDSPVERSION__
è|| defšed(
__ADSPBLACKFIN__
è|| defšed(
__ADSPTS__
è|| defšed(
__ADSP21000__
)

218 
	#COMPILER_ID
 "ADSP"

	)

219 #ià
defšed
(
__VISUALDSPVERSION__
)

221 
	#COMPILER_VERSION_MAJOR
 
	`HEX
(
__VISUALDSPVERSION__
>>24)

	)

222 
	#COMPILER_VERSION_MINOR
 
	`HEX
(
__VISUALDSPVERSION__
>>16 & 0xFF)

	)

223 
	#COMPILER_VERSION_PATCH
 
	`HEX
(
__VISUALDSPVERSION__
>>8 & 0xFF)

	)

226 #–ià
defšed
(
__IAR_SYSTEMS_ICC__
 ) || defšed(
__IAR_SYSTEMS_ICC
)

227 
	#COMPILER_ID
 "IAR"

	)

229 #–ià
defšed
(
__ARMCC_VERSION
)

230 
	#COMPILER_ID
 "ARMCC"

	)

231 #ià
__ARMCC_VERSION
 >= 1000000

233 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__ARMCC_VERSION
/1000000)

	)

234 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__ARMCC_VERSION
/10000 % 100)

	)

235 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__ARMCC_VERSION
 % 10000)

	)

238 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__ARMCC_VERSION
/100000)

	)

239 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__ARMCC_VERSION
/10000 % 10)

	)

240 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__ARMCC_VERSION
 % 10000)

	)

244 #–ià
defšed
(
__SDCC_VERSION_MAJOR
è|| defšed(
SDCC
)

245 
	#COMPILER_ID
 "SDCC"

	)

246 #ià
defšed
(
__SDCC_VERSION_MAJOR
)

247 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
__SDCC_VERSION_MAJOR
)

	)

248 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
__SDCC_VERSION_MINOR
)

	)

249 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
__SDCC_VERSION_PATCH
)

	)

252 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
SDCC
/100)

	)

253 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
SDCC
/10 % 10)

	)

254 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
SDCC
 % 10)

	)

257 #–ià
defšed
(
_SGI_COMPILER_VERSION
è|| defšed(
_COMPILER_VERSION
)

258 
	#COMPILER_ID
 "MIPS´o"

	)

259 #ià
defšed
(
_SGI_COMPILER_VERSION
)

261 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
_SGI_COMPILER_VERSION
/100)

	)

262 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
_SGI_COMPILER_VERSION
/10 % 10)

	)

263 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
_SGI_COMPILER_VERSION
 % 10)

	)

266 
	#COMPILER_VERSION_MAJOR
 
	`DEC
(
_COMPILER_VERSION
/100)

	)

267 
	#COMPILER_VERSION_MINOR
 
	`DEC
(
_COMPILER_VERSION
/10 % 10)

	)

268 
	#COMPILER_VERSION_PATCH
 
	`DEC
(
_COMPILER_VERSION
 % 10)

	)

275 #–ià
defšed
(
__sgi
)

276 
	#COMPILER_ID
 "MIPS´o"

	)

278 #–ià
defšed
(
__hpux
è|| defšed(
__hpua
)

279 
	#COMPILER_ID
 "HP"

	)

282 
	#COMPILER_ID
 ""

	)

289 cÚ¡* 
	gšfo_comp”
 = "INFO" ":" "comp”[" 
COMPILER_ID
 "]";

290 #ifdeà
SIMULATE_ID


291 cÚ¡* 
	gšfo_simuÏ‹
 = "INFO" ":" "simuÏ‹[" 
SIMULATE_ID
 "]";

294 #ifdeà
__QNXNTO__


295 cÚ¡* 
	gqnxÁo
 = "INFO" ":" "qnxnto[]";

298 #ià
defšed
(
__CRAYXE
è|| defšed(
__CRAYXC
)

299 cÚ¡ *
	gšfo_üay
 = "INFO" ":" "compiler_wrapper[CrayPrgEnv]";

302 
	#STRINGIFY_HELPER
(
X
è#X

	)

303 
	#STRINGIFY
(
X
è
	`STRINGIFY_HELPER
(X)

	)

306 #ià
defšed
(
__lšux
è|| defšed(
__lšux__
è|| defšed(
lšux
)

307 
	#PLATFORM_ID
 "Lšux"

	)

309 #–ià
defšed
(
__CYGWIN__
)

310 
	#PLATFORM_ID
 "Cygwš"

	)

312 #–ià
defšed
(
__MINGW32__
)

313 
	#PLATFORM_ID
 "MšGW"

	)

315 #–ià
defšed
(
__APPLE__
)

316 
	#PLATFORM_ID
 "D¬wš"

	)

318 #–ià
defšed
(
_WIN32
è|| defšed(
__WIN32__
è|| defšed(
WIN32
)

319 
	#PLATFORM_ID
 "Wšdows"

	)

321 #–ià
defšed
(
__F»eBSD__
è|| defšed(
__F»eBSD
)

322 
	#PLATFORM_ID
 "F»eBSD"

	)

324 #–ià
defšed
(
__N‘BSD__
è|| defšed(
__N‘BSD
)

325 
	#PLATFORM_ID
 "N‘BSD"

	)

327 #–ià
defšed
(
__O³nBSD__
è|| defšed(
__OPENBSD
)

328 
	#PLATFORM_ID
 "O³nBSD"

	)

330 #–ià
defšed
(
__sun
è|| defšed(
sun
)

331 
	#PLATFORM_ID
 "SunOS"

	)

333 #–ià
defšed
(
_AIX
è|| defšed(
__AIX
è|| defšed(
__AIX__
è|| defšed(
__aix
è|| defšed(
__aix__
)

334 
	#PLATFORM_ID
 "AIX"

	)

336 #–ià
defšed
(
__sgi
è|| defšed(
__sgi__
è|| defšed(
_SGI
)

337 
	#PLATFORM_ID
 "IRIX"

	)

339 #–ià
defšed
(
__hpux
è|| defšed(
__hpux__
)

340 
	#PLATFORM_ID
 "HP-UX"

	)

342 #–ià
defšed
(
__HAIKU__
)

343 
	#PLATFORM_ID
 "Haiku"

	)

345 #–ià
defšed
(
__BeOS
è|| defšed(
__BEOS__
è|| defšed(
_BEOS
)

346 
	#PLATFORM_ID
 "BeOS"

	)

348 #–ià
defšed
(
__QNX__
è|| defšed(
__QNXNTO__
)

349 
	#PLATFORM_ID
 "QNX"

	)

351 #–ià
defšed
(
__Œu64
è|| defšed(
_Œu64
è|| defšed(
__TRU64__
)

352 
	#PLATFORM_ID
 "Tru64"

	)

354 #–ià
defšed
(
__riscos
è|| defšed(
__riscos__
)

355 
	#PLATFORM_ID
 "RISCos"

	)

357 #–ià
defšed
(
__sšix
è|| defšed(
__sšix__
è|| defšed(
__SINIX__
)

358 
	#PLATFORM_ID
 "SINIX"

	)

360 #–ià
defšed
(
__UNIX_SV__
)

361 
	#PLATFORM_ID
 "UNIX_SV"

	)

363 #–ià
defšed
(
__bsdos__
)

364 
	#PLATFORM_ID
 "BSDOS"

	)

366 #–ià
defšed
(
_MPRAS
è|| defšed(
MPRAS
)

367 
	#PLATFORM_ID
 "MP-RAS"

	)

369 #–ià
defšed
(
__osf
è|| defšed(
__osf__
)

370 
	#PLATFORM_ID
 "OSF1"

	)

372 #–ià
defšed
(
_SCO_SV
è|| defšed(
SCO_SV
è|| defšed(
sco_sv
)

373 
	#PLATFORM_ID
 "SCO_SV"

	)

375 #–ià
defšed
(
__uÉrix
è|| defšed(
__uÉrix__
è|| defšed(
_ULTRIX
)

376 
	#PLATFORM_ID
 "ULTRIX"

	)

378 #–ià
defšed
(
__XENIX__
è|| defšed(
_XENIX
è|| defšed(
XENIX
)

379 
	#PLATFORM_ID
 "X’ix"

	)

381 #–ià
defšed
(
__WATCOMC__
)

382 #ià
defšed
(
__LINUX__
)

383 
	#PLATFORM_ID
 "Lšux"

	)

385 #–ià
defšed
(
__DOS__
)

386 
	#PLATFORM_ID
 "DOS"

	)

388 #–ià
defšed
(
__OS2__
)

389 
	#PLATFORM_ID
 "OS2"

	)

391 #–ià
defšed
(
__WINDOWS__
)

392 
	#PLATFORM_ID
 "Wšdows3x"

	)

395 
	#PLATFORM_ID


	)

399 
	#PLATFORM_ID


	)

408 #ià
defšed
(
_WIN32
è&& defšed(
_MSC_VER
)

409 #ià
defšed
(
_M_IA64
)

410 
	#ARCHITECTURE_ID
 "IA64"

	)

412 #–ià
defšed
(
_M_X64
è|| defšed(
_M_AMD64
)

413 
	#ARCHITECTURE_ID
 "x64"

	)

415 #–ià
defšed
(
_M_IX86
)

416 
	#ARCHITECTURE_ID
 "X86"

	)

418 #–ià
defšed
(
_M_ARM
)

419 #ià
_M_ARM
 == 4

420 
	#ARCHITECTURE_ID
 "ARMV4I"

	)

421 #–ià
_M_ARM
 == 5

422 
	#ARCHITECTURE_ID
 "ARMV5I"

	)

424 
	#ARCHITECTURE_ID
 "ARMV" 
	`STRINGIFY
(
_M_ARM
)

	)

427 #–ià
defšed
(
_M_MIPS
)

428 
	#ARCHITECTURE_ID
 "MIPS"

	)

430 #–ià
defšed
(
_M_SH
)

431 
	#ARCHITECTURE_ID
 "SHx"

	)

434 
	#ARCHITECTURE_ID
 ""

	)

437 #–ià
defšed
(
__WATCOMC__
)

438 #ià
defšed
(
_M_I86
)

439 
	#ARCHITECTURE_ID
 "I86"

	)

441 #–ià
defšed
(
_M_IX86
)

442 
	#ARCHITECTURE_ID
 "X86"

	)

445 
	#ARCHITECTURE_ID
 ""

	)

449 
	#ARCHITECTURE_ID


	)

453 
	#DEC
(
n
) \

454 ('0' + (((
n
) / 10000000)%10)), \

455 ('0' + (((
n
) / 1000000)%10)), \

456 ('0' + (((
n
) / 100000)%10)), \

457 ('0' + (((
n
) / 10000)%10)), \

458 ('0' + (((
n
) / 1000)%10)), \

459 ('0' + (((
n
) / 100)%10)), \

460 ('0' + (((
n
) / 10)%10)), \

461 ('0' + ((
n
è% 10))

	)

464 
	#HEX
(
n
) \

465 ('0' + ((
n
)>>28 & 0xF)), \

466 ('0' + ((
n
)>>24 & 0xF)), \

467 ('0' + ((
n
)>>20 & 0xF)), \

468 ('0' + ((
n
)>>16 & 0xF)), \

469 ('0' + ((
n
)>>12 & 0xF)), \

470 ('0' + ((
n
)>>8 & 0xF)), \

471 ('0' + ((
n
)>>4 & 0xF)), \

472 ('0' + ((
n
è& 0xF))

	)

475 #ifdeà
COMPILER_VERSION_MAJOR


476 cÚ¡ 
	gšfo_v”siÚ
[] = {

479 
COMPILER_VERSION_MAJOR
,

480 #ifdeà
COMPILER_VERSION_MINOR


481 '.', 
COMPILER_VERSION_MINOR
,

482 #ifdeà
COMPILER_VERSION_PATCH


483 '.', 
COMPILER_VERSION_PATCH
,

484 #ifdeà
COMPILER_VERSION_TWEAK


485 '.', 
COMPILER_VERSION_TWEAK
,

493 #ifdeà
SIMULATE_VERSION_MAJOR


494 cÚ¡ 
	gšfo_simuÏ‹_v”siÚ
[] = {

497 
SIMULATE_VERSION_MAJOR
,

498 #ifdeà
SIMULATE_VERSION_MINOR


499 '.', 
SIMULATE_VERSION_MINOR
,

500 #ifdeà
SIMULATE_VERSION_PATCH


501 '.', 
SIMULATE_VERSION_PATCH
,

502 #ifdeà
SIMULATE_VERSION_TWEAK


503 '.', 
SIMULATE_VERSION_TWEAK
,

514 cÚ¡* 
	gšfo_¶©fÜm
 = "INFO" ":" "¶©fÜm[" 
PLATFORM_ID
 "]";

515 cÚ¡* 
	gšfo_¬ch
 = "INFO" ":" "¬ch[" 
ARCHITECTURE_ID
 "]";

520 #ià!
defšed
(
__STDC__
)

521 #ià
defšed
(
_MSC_VER
è&& !defšed(
__şªg__
)

522 
	#C_DIALECT
 "90"

	)

524 
	#C_DIALECT


	)

526 #–ià
__STDC_VERSION__
 >= 201000L

527 
	#C_DIALECT
 "11"

	)

528 #–ià
__STDC_VERSION__
 >= 199901L

529 
	#C_DIALECT
 "99"

	)

531 
	#C_DIALECT
 "90"

	)

533 cÚ¡ * 
	gšfo_Ïnguage_dŸËù_deçuÉ
 =

534 "INFO" ":" "dŸËù_deçuÉ[" 
C_DIALECT
 "]";

538 #ifdeà
ID_VOID_MAIN


539 
	$maš
(è{
	}
}

541 #ià
defšed
(
__CLASSIC_C__
)

542 
	$maš
(
¬gc
, 
¬gv
) argc; *argv[];

544 
	$maš
(
¬gc
, * 
¬gv
[])

547 
»quœe
 = 0;

548 
»quœe
 +ğ
šfo_comp”
[
¬gc
];

549 
»quœe
 +ğ
šfo_¶©fÜm
[
¬gc
];

550 
»quœe
 +ğ
šfo_¬ch
[
¬gc
];

551 #ifdeà
COMPILER_VERSION_MAJOR


552 
»quœe
 +ğ
šfo_v”siÚ
[
¬gc
];

554 #ifdeà
SIMULATE_ID


555 
»quœe
 +ğ
šfo_simuÏ‹
[
¬gc
];

557 #ifdeà
SIMULATE_VERSION_MAJOR


558 
»quœe
 +ğ
šfo_simuÏ‹_v”siÚ
[
¬gc
];

560 #ià
	`defšed
(
__CRAYXE
è|| defšed(
__CRAYXC
)

561 
»quœe
 +ğ
šfo_üay
[
¬gc
];

563 
»quœe
 +ğ
šfo_Ïnguage_dŸËù_deçuÉ
[
¬gc
];

564 ()
¬gv
;

565  
»quœe
;

566 
	}
}

	@build/CMakeFiles/CheckTypeSize/HAVE_SOCKLEN_T.c

1 
	~<sys/ty³s.h
>

2 
	~<¡dšt.h
>

3 
	~<¡ddef.h
>

4 
	~"sys/sock‘.h
"

7 #undeà
KEY


8 #ià
defšed
(
__i386
)

9 
	#KEY
 '_','_','i','3','8','6'

	)

10 #–ià
defšed
(
__x86_64
)

11 
	#KEY
 '_','_','x','8','6','_','6','4'

	)

12 #–ià
defšed
(
__µc__
)

13 
	#KEY
 '_','_','p','p','c','_','_'

	)

14 #–ià
defšed
(
__µc64__
)

15 
	#KEY
 '_','_','p','p','c','6','4','_','_'

	)

18 
	#SIZE
 ((
sockËn_t
))

	)

19 
	gšfo_size
[] = {'I', 'N', 'F', 'O', ':', 's','i','z','e','[',

20 ('0' + ((
SIZE
 / 10000)%10)),

21 ('0' + ((
SIZE
 / 1000)%10)),

22 ('0' + ((
SIZE
 / 100)%10)),

23 ('0' + ((
SIZE
 / 10)%10)),

24 ('0' + (
SIZE
 % 10)),

26 #ifdeà
KEY


27 ' ','k','e','y','[', 
KEY
, ']',

31 #ifdeà
__CLASSIC_C__


32 
	$maš
(
¬gc
, 
¬gv
) argc; *argv[];

34 
	$maš
(
¬gc
, *
¬gv
[])

37 
»quœe
 = 0;

38 
»quœe
 +ğ
šfo_size
[
¬gc
];

39 ()
¬gv
;

40  
»quœe
;

41 
	}
}

	@build/CMakeFiles/CheckTypeSize/SIZEOF_LONG.c

1 
	~<sys/ty³s.h
>

2 
	~<¡dšt.h
>

3 
	~<¡ddef.h
>

6 #undeà
KEY


7 #ià
defšed
(
__i386
)

8 
	#KEY
 '_','_','i','3','8','6'

	)

9 #–ià
defšed
(
__x86_64
)

10 
	#KEY
 '_','_','x','8','6','_','6','4'

	)

11 #–ià
defšed
(
__µc__
)

12 
	#KEY
 '_','_','p','p','c','_','_'

	)

13 #–ià
defšed
(
__µc64__
)

14 
	#KEY
 '_','_','p','p','c','6','4','_','_'

	)

17 
	#SIZE
 (())

	)

18 
	gšfo_size
[] = {'I', 'N', 'F', 'O', ':', 's','i','z','e','[',

19 ('0' + ((
SIZE
 / 10000)%10)),

20 ('0' + ((
SIZE
 / 1000)%10)),

21 ('0' + ((
SIZE
 / 100)%10)),

22 ('0' + ((
SIZE
 / 10)%10)),

23 ('0' + (
SIZE
 % 10)),

25 #ifdeà
KEY


26 ' ','k','e','y','[', 
KEY
, ']',

30 #ifdeà
__CLASSIC_C__


31 
	$maš
(
¬gc
, 
¬gv
) argc; *argv[];

33 
	$maš
(
¬gc
, *
¬gv
[])

36 
»quœe
 = 0;

37 
»quœe
 +ğ
šfo_size
[
¬gc
];

38 ()
¬gv
;

39  
»quœe
;

40 
	}
}

	@build/CMakeFiles/CheckTypeSize/SIZEOF_OFF_T.c

1 
	~<sys/ty³s.h
>

2 
	~<¡dšt.h
>

3 
	~<¡ddef.h
>

6 #undeà
KEY


7 #ià
defšed
(
__i386
)

8 
	#KEY
 '_','_','i','3','8','6'

	)

9 #–ià
defšed
(
__x86_64
)

10 
	#KEY
 '_','_','x','8','6','_','6','4'

	)

11 #–ià
defšed
(
__µc__
)

12 
	#KEY
 '_','_','p','p','c','_','_'

	)

13 #–ià
defšed
(
__µc64__
)

14 
	#KEY
 '_','_','p','p','c','6','4','_','_'

	)

17 
	#SIZE
 ((
off_t
))

	)

18 
	gšfo_size
[] = {'I', 'N', 'F', 'O', ':', 's','i','z','e','[',

19 ('0' + ((
SIZE
 / 10000)%10)),

20 ('0' + ((
SIZE
 / 1000)%10)),

21 ('0' + ((
SIZE
 / 100)%10)),

22 ('0' + ((
SIZE
 / 10)%10)),

23 ('0' + (
SIZE
 % 10)),

25 #ifdeà
KEY


26 ' ','k','e','y','[', 
KEY
, ']',

30 #ifdeà
__CLASSIC_C__


31 
	$maš
(
¬gc
, 
¬gv
) argc; *argv[];

33 
	$maš
(
¬gc
, *
¬gv
[])

36 
»quœe
 = 0;

37 
»quœe
 +ğ
šfo_size
[
¬gc
];

38 ()
¬gv
;

39  
»quœe
;

40 
	}
}

	@build/CMakeFiles/feature_tests.c

2 cÚ¡ 
	gã©u»s
[] = {"\n"

4 #ià(
__GNUC__
 * 100 + 
__GNUC_MINOR__
) >= 304

11 #ià(
__GNUC__
 * 100 + 
__GNUC_MINOR__
è>ğ304 && 
defšed
(
__STDC_VERSION__
) && __STDC_VERSION__ >= 199901L

18 #ià(
__GNUC__
 * 100 + 
__GNUC_MINOR__
è>ğ406 && 
defšed
(
__STDC_VERSION__
) && __STDC_VERSION__ >= 201000L

25 #ià(
__GNUC__
 * 100 + 
__GNUC_MINOR__
è>ğ304 && 
defšed
(
__STDC_VERSION__
) && __STDC_VERSION__ >= 199901L

34 
	$maš
(
¬gc
, ** 
¬gv
è{ (ïrgv;  
ã©u»s
[¬gc]; 
	}
}

	@build/config.h

6 
	#LIGHTTPD_VERSION_ID
 10400

	)

7 
	#PACKAGE_NAME
 "Ligh‰pd"

	)

8 
	#PACKAGE_VERSION
 ""

	)

9 
	#LIBRARY_DIR
 "/İt/h”m™/lib/ligh‰pd"

	)

11 #iâdeà
_GNU_SOURCE


12 
	#_GNU_SOURCE


	)

20 
	#HAVE_SYS_POLL_H


	)

23 
	#HAVE_SYS_RESOURCE_H


	)

25 
	#HAVE_SYS_SELECT_H


	)

26 
	#HAVE_SYS_TYPES_H


	)

27 
	#HAVE_SYS_UIO_H


	)

29 
	#HAVE_SYS_WAIT_H


	)

30 
	#HAVE_SYS_TIME_H


	)

31 
	#HAVE_UNISTD_H


	)

32 
	#HAVE_PTHREAD_H


	)

33 
	#HAVE_IPV6


	)

34 
	#HAVE_WEAK_SYMBOLS


	)

58 
	#HAVE_GETOPT_H


	)

60 
	#HAVE_INTTYPES_H


	)

74 
	#HAVE_PCRE_H


	)

75 
	#HAVE_LIBPCRE


	)

78 
	#HAVE_PWD_H


	)

82 
	#HAVE_LIBPCRE


	)

84 
	#HAVE_STDDEF_H


	)

85 
	#HAVE_STDINT_H


	)

112 
	#HAVE_SOCKLEN_T


	)

113 
	#SIZEOF_LONG
 8

	)

114 
	#SIZEOF_OFF_T
 8

	)

122 
	#HAVE_GMTIME_R


	)

125 
	#HAVE_LOCALTIME_R


	)

128 
	#HAVE_MEMCPY


	)

129 
	#HAVE_MEMSET


	)

137 
	#HAVE_SELECT


	)

142 
	#HAVE_SIGACTION


	)

143 
	#HAVE_SIGNAL


	)

145 
	#HAVE_STRPTIME


	)

147 
	#HAVE_WRITEV


	)

152 
	#HAVE_EXPLICIT_BZERO


	)

	@chunk.c

1 
	~"fœ¡.h
"

9 
	~"chunk.h
"

10 
	~"ba£.h
"

11 
	~"log.h
"

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

15 
	~"sys-mm­.h
"

17 
	~<¡dlib.h
>

18 
	~<fú.h
>

19 
	~<uni¡d.h
>

21 
	~<¡dio.h
>

22 
	~<”ºo.h
>

23 
	~<¡ršg.h
>

26 
	#DEFAULT_TEMPFILE_SIZE
 (1 * 1024 * 1024)

	)

27 
	#MAX_TEMPFILE_SIZE
 (128 * 1024 * 1024)

	)

29 
¬¿y
 *
	gchunkqueue_deçuÉ_‹mpdœs
 = 
NULL
;

30 
	gchunkqueue_deçuÉ_‹mpfe_size
 = 
DEFAULT_TEMPFILE_SIZE
;

32 
chunkqueue
 *
	$chunkqueue_š™
() {

33 
chunkqueue
 *
cq
;

35 
cq
 = 
	`ÿÎoc
(1, (*cq));

36 
	`fÜû_as£¹
(
NULL
 !ğ
cq
);

38 
cq
->
fœ¡
 = 
NULL
;

39 
cq
->
Ï¡
 = 
NULL
;

41 
cq
->
unu£d
 = 
NULL
;

43 
cq
->
‹mpdœs
 = 
chunkqueue_deçuÉ_‹mpdœs
;

44 
cq
->
u¶ßd_‹mp_fe_size
 = 
chunkqueue_deçuÉ_‹mpfe_size
;

46  
cq
;

47 
	}
}

49 
chunk
 *
	$chunk_š™
() {

50 
chunk
 *
c
;

52 
c
 = 
	`ÿÎoc
(1, (*c));

53 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

55 
c
->
ty³
 = 
MEM_CHUNK
;

56 
c
->
mem
 = 
	`bufãr_š™
();

57 
c
->
fe
.
Çme
 = 
	`bufãr_š™
();

58 
c
->
fe
.
¡¬t
 = c->fe.
Ëngth
 = c->fe.
mm­
.
off£t
 = 0;

59 
c
->
fe
.
fd
 = -1;

60 
c
->
fe
.
mm­
.
¡¬t
 = 
MAP_FAILED
;

61 
c
->
fe
.
mm­
.
Ëngth
 = 0;

62 
c
->
fe
.
is_‹mp
 = 0;

63 
c
->
off£t
 = 0;

64 
c
->
Ãxt
 = 
NULL
;

66  
c
;

67 
	}
}

69 
	$chunk_»£t
(
chunk
 *
c
) {

70 ià(
NULL
 =ğ
c
) ;

72 
c
->
ty³
 = 
MEM_CHUNK
;

74 
	`bufãr_»£t
(
c
->
mem
);

76 ià(
c
->
fe
.
is_‹mp
 && !
	`bufãr_¡ršg_is_em±y
(c->fe.
Çme
)) {

77 
	`uÆšk
(
c
->
fe
.
Çme
->
±r
);

80 
	`bufãr_»£t
(
c
->
fe
.
Çme
);

82 ià(
c
->
fe
.
fd
 != -1) {

83 
	`şo£
(
c
->
fe
.
fd
);

84 
c
->
fe
.
fd
 = -1;

86 ià(
MAP_FAILED
 !ğ
c
->
fe
.
mm­
.
¡¬t
) {

87 
	`munm­
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
);

88 
c
->
fe
.
mm­
.
¡¬t
 = 
MAP_FAILED
;

90 
c
->
fe
.
¡¬t
 = c->fe.
Ëngth
 = c->fe.
mm­
.
off£t
 = 0;

91 
c
->
fe
.
mm­
.
Ëngth
 = 0;

92 
c
->
fe
.
is_‹mp
 = 0;

93 
c
->
off£t
 = 0;

94 
c
->
Ãxt
 = 
NULL
;

95 
	}
}

97 
	$chunk_ä“
(
chunk
 *
c
) {

98 ià(
NULL
 =ğ
c
) ;

100 
	`chunk_»£t
(
c
);

102 
	`bufãr_ä“
(
c
->
mem
);

103 
	`bufãr_ä“
(
c
->
fe
.
Çme
);

105 
	`ä“
(
c
);

106 
	}
}

108 
off_t
 
	$chunk_»maššg_Ëngth
(cÚ¡ 
chunk
 *
c
) {

109 
off_t
 
Ën
 = 0;

110 
c
->
ty³
) {

111 
MEM_CHUNK
:

112 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
);

114 
FILE_CHUNK
:

115 
Ën
 = 
c
->
fe
.
Ëngth
;

118 
	`fÜû_as£¹
(
c
->
ty³
 =ğ
MEM_CHUNK
 || c->ty³ =ğ
FILE_CHUNK
);

121 
	`fÜû_as£¹
(
c
->
off£t
 <ğ
Ën
);

122  
Ën
 - 
c
->
off£t
;

123 
	}
}

125 
	$chunkqueue_ä“
(
chunkqueue
 *
cq
) {

126 
chunk
 *
c
, *
pc
;

128 ià(
NULL
 =ğ
cq
) ;

130 
c
 = 
cq
->
fœ¡
; c; ) {

131 
pc
 = 
c
;

132 
c
 = c->
Ãxt
;

133 
	`chunk_ä“
(
pc
);

136 
c
 = 
cq
->
unu£d
; c; ) {

137 
pc
 = 
c
;

138 
c
 = c->
Ãxt
;

139 
	`chunk_ä“
(
pc
);

142 
	`ä“
(
cq
);

143 
	}
}

145 
	$chunkqueue_push_unu£d_chunk
(
chunkqueue
 *
cq
, 
chunk
 *
c
) {

146 
	`fÜû_as£¹
(
NULL
 !ğ
cq
 && NULL !ğ
c
);

149 ià(
cq
->
unu£d_chunks
 > 4) {

150 
	`chunk_ä“
(
c
);

152 
	`chunk_»£t
(
c
);

153 
c
->
Ãxt
 = 
cq
->
unu£d
;

154 
cq
->
unu£d
 = 
c
;

155 
cq
->
unu£d_chunks
++;

157 
	}
}

159 
chunk
 *
	$chunkqueue_g‘_unu£d_chunk
(
chunkqueue
 *
cq
) {

160 
chunk
 *
c
;

162 
	`fÜû_as£¹
(
NULL
 !ğ
cq
);

165 ià(0 =ğ
cq
->
unu£d
) {

166 
c
 = 
	`chunk_š™
();

169 
c
 = 
cq
->
unu£d
;

170 
cq
->
unu£d
 = 
c
->
Ãxt
;

171 
c
->
Ãxt
 = 
NULL
;

172 
cq
->
unu£d_chunks
--;

175  
c
;

176 
	}
}

178 
	$chunkqueue_´•’d_chunk
(
chunkqueue
 *
cq
, 
chunk
 *
c
) {

179 
c
->
Ãxt
 = 
cq
->
fœ¡
;

180 
cq
->
fœ¡
 = 
c
;

182 ià(
NULL
 =ğ
cq
->
Ï¡
) {

183 
cq
->
Ï¡
 = 
c
;

185 
cq
->
by‹s_š
 +ğ
	`chunk_»maššg_Ëngth
(
c
);

186 
	}
}

188 
	$chunkqueue_­³nd_chunk
(
chunkqueue
 *
cq
, 
chunk
 *
c
) {

189 
c
->
Ãxt
 = 
NULL
;

190 ià(
cq
->
Ï¡
) {

191 
cq
->
Ï¡
->
Ãxt
 = 
c
;

193 
cq
->
Ï¡
 = 
c
;

195 ià(
NULL
 =ğ
cq
->
fœ¡
) {

196 
cq
->
fœ¡
 = 
c
;

198 
cq
->
by‹s_š
 +ğ
	`chunk_»maššg_Ëngth
(
c
);

199 
	}
}

201 
	$chunkqueue_»£t
(
chunkqueue
 *
cq
) {

202 
chunk
 *
cur
 = 
cq
->
fœ¡
;

204 
cq
->
fœ¡
 = cq->
Ï¡
 = 
NULL
;

206 
NULL
 !ğ
cur
) {

207 
chunk
 *
Ãxt
 = 
cur
->next;

208 
	`chunkqueue_push_unu£d_chunk
(
cq
, 
cur
);

209 
cur
 = 
Ãxt
;

212 
cq
->
by‹s_š
 = 0;

213 
cq
->
by‹s_out
 = 0;

214 
cq
->
‹mpdœ_idx
 = 0;

215 
	}
}

217 
	$chunkqueue_­³nd_fe_fd
(
chunkqueue
 *
cq
, 
bufãr
 *
â
, 
fd
, 
off_t
 
off£t
, off_ˆ
Ën
) {

218 
chunk
 *
c
;

220 ià(0 =ğ
Ën
) {

221 
	`şo£
(
fd
);

225 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

227 
c
->
ty³
 = 
FILE_CHUNK
;

229 
	`bufãr_cİy_bufãr
(
c
->
fe
.
Çme
, 
â
);

230 
c
->
fe
.
¡¬t
 = 
off£t
;

231 
c
->
fe
.
Ëngth
 = 
Ën
;

232 
c
->
fe
.
fd
 = fd;

233 
c
->
off£t
 = 0;

235 
	`chunkqueue_­³nd_chunk
(
cq
, 
c
);

236 
	}
}

238 
	$chunkqueue_­³nd_fe
(
chunkqueue
 *
cq
, 
bufãr
 *
â
, 
off_t
 
off£t
, off_ˆ
Ën
) {

239 
chunk
 *
c
;

241 ià(0 =ğ
Ën
) ;

243 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

245 
c
->
ty³
 = 
FILE_CHUNK
;

247 
	`bufãr_cİy_bufãr
(
c
->
fe
.
Çme
, 
â
);

248 
c
->
fe
.
¡¬t
 = 
off£t
;

249 
c
->
fe
.
Ëngth
 = 
Ën
;

250 
c
->
off£t
 = 0;

252 
	`chunkqueue_­³nd_chunk
(
cq
, 
c
);

253 
	}
}

255 
	$chunkqueue_­³nd_bufãr
(
chunkqueue
 *
cq
, 
bufãr
 *
mem
) {

256 
chunk
 *
c
;

258 ià(
	`bufãr_¡ršg_is_em±y
(
mem
)) ;

260 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

261 
c
->
ty³
 = 
MEM_CHUNK
;

262 
	`fÜû_as£¹
(
NULL
 !ğ
c
->
mem
);

263 
	`bufãr_move
(
c
->
mem
, mem);

265 
	`chunkqueue_­³nd_chunk
(
cq
, 
c
);

266 
	}
}

268 
	$chunkqueue_´•’d_bufãr
(
chunkqueue
 *
cq
, 
bufãr
 *
mem
) {

269 
chunk
 *
c
;

271 ià(
	`bufãr_¡ršg_is_em±y
(
mem
)) ;

273 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

274 
c
->
ty³
 = 
MEM_CHUNK
;

275 
	`fÜû_as£¹
(
NULL
 !ğ
c
->
mem
);

276 
	`bufãr_move
(
c
->
mem
, mem);

278 
	`chunkqueue_´•’d_chunk
(
cq
, 
c
);

279 
	}
}

282 
	$chunkqueue_­³nd_mem
(
chunkqueue
 *
cq
, cÚ¡ * 
mem
, 
size_t
 
Ën
) {

283 
chunk
 *
c
;

285 ià(0 =ğ
Ën
) ;

287 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

288 
c
->
ty³
 = 
MEM_CHUNK
;

289 
	`bufãr_cİy_¡ršg_Ën
(
c
->
mem
, mem, 
Ën
);

291 
	`chunkqueue_­³nd_chunk
(
cq
, 
c
);

292 
	}
}

295 
	$chunkqueue_­³nd_chunkqueue
(
chunkqueue
 *
cq
, chunkqueu*
¤c
) {

296 ià(
¤c
 =ğ
NULL
 || NULL =ğ¤c->
fœ¡
) ;

298 ià(
NULL
 =ğ
cq
->
fœ¡
) {

299 
cq
->
fœ¡
 = 
¤c
->first;

301 
cq
->
Ï¡
->
Ãxt
 = 
¤c
->
fœ¡
;

303 
cq
->
Ï¡
 = 
¤c
->last;

304 
cq
->
by‹s_š
 +ğ(
¤c
->by‹s_š - src->
by‹s_out
);

306 
¤c
->
fœ¡
 = 
NULL
;

307 
¤c
->
Ï¡
 = 
NULL
;

308 
¤c
->
by‹s_out
 = src->
by‹s_š
;

309 
	}
}

312 
	$chunkqueue_g‘_memÜy
(
chunkqueue
 *
cq
, **
mem
, 
size_t
 *
Ën
, size_ˆ
mš_size
, size_ˆ
®loc_size
) {

313 cÚ¡ 
size_t
 
REALLOC_MAX_SIZE
 = 256;

314 
chunk
 *
c
;

315 
bufãr
 *
b
;

316 *
dummy_mem
;

317 
size_t
 
dummy_Ën
;

319 
	`fÜû_as£¹
(
NULL
 !ğ
cq
);

320 ià(
NULL
 =ğ
mem
èmem = &
dummy_mem
;

321 ià(
NULL
 =ğ
Ën
èËÀğ&
dummy_Ën
;

324 ià(0 =ğ
mš_size
) min_size = 1024;

325 ià(0 =ğ
®loc_size
)‡lloc_size = 4096;

326 ià(
®loc_size
 < 
mš_size
)‡lloc_size = min_size;

328 ià(
NULL
 !ğ
cq
->
Ï¡
 && 
MEM_CHUNK
 =ğcq->Ï¡->
ty³
) {

329 
size_t
 
have
;

331 
b
 = 
cq
->
Ï¡
->
mem
;

332 
have
 = 
	`bufãr_¡ršg_¥aû
(
b
);

335 ià(
	`bufãr_¡ršg_is_em±y
(
b
)) {

336 
	`bufãr_¡ršg_´•¬e_cİy
(
b
, 
®loc_size
);

337 
have
 = 
	`bufãr_¡ršg_¥aû
(
b
);

340 ià(
have
 < 
mš_size
 && 
b
->
size
 <ğ
REALLOC_MAX_SIZE
) {

341 
size_t
 
cur_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

342 
size_t
 
Ãw_size
 = 
cur_Ën
 + 
mš_size
, 
­³nd
;

343 ià(
Ãw_size
 < 
®loc_size
)‚ew_size =‡lloc_size;

345 
­³nd
 = 
Ãw_size
 - 
cur_Ën
;

346 ià(
­³nd
 >ğ
mš_size
) {

347 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
­³nd
);

348 
have
 = 
	`bufãr_¡ršg_¥aû
(
b
);

353 ià(
have
 >ğ
mš_size
) {

354 *
mem
 = 
b
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(b);

355 *
Ën
 = 
have
;

361 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

362 
c
->
ty³
 = 
MEM_CHUNK
;

363 
	`chunkqueue_­³nd_chunk
(
cq
, 
c
);

365 
b
 = 
c
->
mem
;

366 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 
®loc_size
);

368 *
mem
 = 
b
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(b);

369 *
Ën
 = 
	`bufãr_¡ršg_¥aû
(
b
);

370 
	}
}

372 
	$chunkqueue_u£_memÜy
(
chunkqueue
 *
cq
, 
size_t
 
Ën
) {

373 
bufãr
 *
b
;

375 
	`fÜû_as£¹
(
NULL
 !ğ
cq
);

376 
	`fÜû_as£¹
(
NULL
 !ğ
cq
->
Ï¡
 && 
MEM_CHUNK
 =ğcq->Ï¡->
ty³
);

377 
b
 = 
cq
->
Ï¡
->
mem
;

379 ià(
Ën
 > 0) {

380 
	`bufãr_comm™
(
b
, 
Ën
);

381 
cq
->
by‹s_š
 +ğ
Ën
;

382 } ià(
	`bufãr_¡ršg_is_em±y
(
b
)) {

386 
	`bufãr_»£t
(
b
);

388 
	}
}

390 
	$chunkqueue_£t_‹mpdœs_deçuÉ
 (
¬¿y
 *
‹mpdœs
, 
u¶ßd_‹mp_fe_size
) {

391 
chunkqueue_deçuÉ_‹mpdœs
 = 
‹mpdœs
;

392 
chunkqueue_deçuÉ_‹mpfe_size


393 ğ(0 =ğ
u¶ßd_‹mp_fe_size
è? 
DEFAULT_TEMPFILE_SIZE


394 : (
u¶ßd_‹mp_fe_size
 > 
MAX_TEMPFILE_SIZE
) ? MAX_TEMPFILE_SIZE

395 : 
u¶ßd_‹mp_fe_size
;

396 
	}
}

399 
	$chunkqueue_£t_‹mpdœs
(
chunkqueue
 *
cq
, 
¬¿y
 *
‹mpdœs
, 
u¶ßd_‹mp_fe_size
) {

400 
	`fÜû_as£¹
(
NULL
 !ğ
cq
);

401 
cq
->
‹mpdœs
 =empdirs;

402 
cq
->
u¶ßd_‹mp_fe_size


403 ğ(0 =ğ
u¶ßd_‹mp_fe_size
è? 
DEFAULT_TEMPFILE_SIZE


404 : (
u¶ßd_‹mp_fe_size
 > 
MAX_TEMPFILE_SIZE
) ? MAX_TEMPFILE_SIZE

405 : 
u¶ßd_‹mp_fe_size
;

406 
cq
->
‹mpdœ_idx
 = 0;

407 
	}
}

410 
	$chunkqueue_¡—l
(
chunkqueue
 *
de¡
, chunkqueu*
¤c
, 
off_t
 
Ën
) {

411 
Ën
 > 0) {

412 
chunk
 *
c
 = 
¤c
->
fœ¡
;

413 
off_t
 
ş’
 = 0, 
u£
;

415 ià(
NULL
 =ğ
c
) ;

417 
ş’
 = 
	`chunk_»maššg_Ëngth
(
c
);

418 ià(0 =ğ
ş’
) {

420 
¤c
->
fœ¡
 = 
c
->
Ãxt
;

421 ià(
c
 =ğ
¤c
->
Ï¡
è¤c->Ï¡ = 
NULL
;

422 
	`chunkqueue_push_unu£d_chunk
(
¤c
, 
c
);

426 
u£
 = 
Ën
 >ğ
ş’
 ? clen :†en;

427 
Ën
 -ğ
u£
;

429 ià(
u£
 =ğ
ş’
) {

431 
¤c
->
fœ¡
 = 
c
->
Ãxt
;

432 ià(
c
 =ğ
¤c
->
Ï¡
è¤c->Ï¡ = 
NULL
;

434 
	`chunkqueue_­³nd_chunk
(
de¡
, 
c
);

438 
c
->
ty³
) {

439 
MEM_CHUNK
:

440 
	`chunkqueue_­³nd_mem
(
de¡
, 
c
->
mem
->
±r
 + c->
off£t
, 
u£
);

442 
FILE_CHUNK
:

444 
	`chunkqueue_­³nd_fe
(
de¡
, 
c
->
fe
.
Çme
, c->fe.
¡¬t
 + c->
off£t
, 
u£
);

448 
c
->
off£t
 +ğ
u£
;

449 
	`fÜû_as£¹
(0 =ğ
Ën
);

452 
¤c
->
by‹s_out
 +ğ
u£
;

454 
	}
}

456 
chunk
 *
	$chunkqueue_g‘_­³nd_‹mpfe
(
chunkqueue
 *
cq
) {

457 
chunk
 *
c
;

458 
bufãr
 *
‹m¶©e
 = 
	`bufãr_š™_¡ršg
("/var/tmp/lighttpd-upload-XXXXXX");

459 
fd
 = -1;

461 ià(
cq
->
‹mpdœs
 && cq->‹mpdœs->
u£d
) {

464 
”ºo
 = 
EIO
; 
cq
->
‹mpdœ_idx
 < cq->
‹mpdœs
->
u£d
; ++cq->tempdir_idx) {

465 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
cq
->
‹mpdœs
->
d©a
[cq->
‹mpdœ_idx
];

467 
	`bufãr_cİy_bufãr
(
‹m¶©e
, 
ds
->
v®ue
);

468 
	`bufãr_­³nd_¦ash
(
‹m¶©e
);

469 
	`bufãr_­³nd_¡ršg_Ën
(
‹m¶©e
, 
	`CONST_STR_LEN
("lighttpd-upload-XXXXXX"));

472 ià(-1 !ğ(
fd
 = 
	`mk¡emp
(
‹m¶©e
->
±r
))) ;

476 
fd
 = 
	`mk¡emp
(
‹m¶©e
->
±r
);

479 ià(
fd
 < 0) {

480 
	`bufãr_ä“
(
‹m¶©e
);

481  
NULL
;

484 ià(0 !ğ
	`fú
(
fd
, 
F_SETFL
, fú(fd, 
F_GETFL
, 0è| 
O_APPEND
)) {

485 
	`şo£
(
fd
);

486 
	`bufãr_ä“
(
‹m¶©e
);

487  
NULL
;

489 
	`fd_şo£_Ú_exec
(
fd
);

491 
c
 = 
	`chunkqueue_g‘_unu£d_chunk
(
cq
);

492 
c
->
ty³
 = 
FILE_CHUNK
;

493 
c
->
fe
.
fd
 = fd;

494 
c
->
fe
.
is_‹mp
 = 1;

495 
	`bufãr_cİy_bufãr
(
c
->
fe
.
Çme
, 
‹m¶©e
);

496 
c
->
fe
.
Ëngth
 = 0;

498 
	`chunkqueue_­³nd_chunk
(
cq
, 
c
);

500 
	`bufãr_ä“
(
‹m¶©e
);

502  
c
;

503 
	}
}

505 
chunkqueue_»move_em±y_chunks
(
chunkqueue
 *
cq
);

507 
	$chunkqueue_­³nd_mem_to_‹mpfe
(
£rv”
 *
¤v
, 
chunkqueue
 *
de¡
, cÚ¡ *
mem
, 
size_t
 
Ën
) {

508 
chunk
 *
d¡_c
;

509 
ssize_t
 
wr™‹n
;

522 
d¡_c
 = 
de¡
->
Ï¡
;

523 ià(
NULL
 !ğ
d¡_c


524 && 
FILE_CHUNK
 =ğ
d¡_c
->
ty³


525 && 
d¡_c
->
fe
.
is_‹mp


526 && 
d¡_c
->
fe
.
fd
 >= 0

527 && 0 =ğ
d¡_c
->
off£t
) {

530 ià(
d¡_c
->
fe
.
Ëngth
 >ğ(
off_t
)
de¡
->
u¶ßd_‹mp_fe_size
) {

532 
rc
 = 
	`şo£
(
d¡_c
->
fe
.
fd
);

533 
d¡_c
->
fe
.
fd
 = -1;

534 ià(0 !ğ
rc
) {

535 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

536 "şo£(è‹mp-fe", 
d¡_c
->
fe
.
Çme
, "failed:",

537 
	`¡»¼Ü
(
”ºo
));

540 
d¡_c
 = 
NULL
;

543 
d¡_c
 = 
NULL
;

546 ià(
NULL
 =ğ
d¡_c
 && NULL =ğ(d¡_øğ
	`chunkqueue_g‘_­³nd_‹mpfe
(
de¡
))) {

553 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

554 "İ’šgemp-fçed:", 
	`¡»¼Ü
(
”ºo
));

561 
wr™‹n
 = 
	`wr™e
(
d¡_c
->
fe
.
fd
, 
mem
, 
Ën
);

563 ià((
size_t
è
wr™‹n
 =ğ
Ën
) {

564 
d¡_c
->
fe
.
Ëngth
 +ğ
Ën
;

565 
de¡
->
by‹s_š
 +ğ
Ën
;

568 } ià(
wr™‹n
 >= 0) {

571 
de¡
->
by‹s_š
 +ğ
wr™‹n
;

572 
mem
 +ğ
wr™‹n
;

573 
Ën
 -ğ(
size_t
)
wr™‹n
;

574 
d¡_c
->
fe
.
Ëngth
 +ğ(
size_t
)
wr™‹n
;

576 } ià(
”ºo
 =ğ
EINTR
) {

579 
»Œy
 = (
”ºo
 =ğ
ENOSPC
 && 
de¡
->
‹mpdœs
 && ++de¡->
‹mpdœ_idx
 < de¡->‹mpdœs->
u£d
);

580 ià(!
»Œy
) {

581 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

582 "wr™e(è‹mp-fe", 
d¡_c
->
fe
.
Çme
, "failed:",

583 
	`¡»¼Ü
(
”ºo
));

586 ià(0 =ğ
	`chunk_»maššg_Ëngth
(
d¡_c
)) {

588 
	`chunkqueue_»move_em±y_chunks
(
de¡
);

590 
rc
 = 
	`şo£
(
d¡_c
->
fe
.
fd
);

591 
d¡_c
->
fe
.
fd
 = -1;

592 ià(0 !ğ
rc
) {

593 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

594 "şo£(è‹mp-fe", 
d¡_c
->
fe
.
Çme
, "failed:",

595 
	`¡»¼Ü
(
”ºo
));

599 ià(!
»Œy
) ;

604 } 
d¡_c
);

607 
	}
}

609 
	$chunkqueue_¡—l_w™h_‹mpfes
(
£rv”
 *
¤v
, 
chunkqueue
 *
de¡
, chunkqueu*
¤c
, 
off_t
 
Ën
) {

610 
Ën
 > 0) {

611 
chunk
 *
c
 = 
¤c
->
fœ¡
;

612 
off_t
 
ş’
 = 0, 
u£
;

614 ià(
NULL
 =ğ
c
) ;

616 
ş’
 = 
	`chunk_»maššg_Ëngth
(
c
);

617 ià(0 =ğ
ş’
) {

619 
¤c
->
fœ¡
 = 
c
->
Ãxt
;

620 ià(
c
 =ğ
¤c
->
Ï¡
è¤c->Ï¡ = 
NULL
;

621 
	`chunkqueue_push_unu£d_chunk
(
¤c
, 
c
);

625 
u£
 = (
Ën
 >ğ
ş’
) ? clen :†en;

626 
Ën
 -ğ
u£
;

628 
c
->
ty³
) {

629 
FILE_CHUNK
:

630 ià(
u£
 =ğ
ş’
) {

632 
¤c
->
fœ¡
 = 
c
->
Ãxt
;

633 ià(
c
 =ğ
¤c
->
Ï¡
è¤c->Ï¡ = 
NULL
;

634 
	`chunkqueue_­³nd_chunk
(
de¡
, 
c
);

638 
	`chunkqueue_­³nd_fe
(
de¡
, 
c
->
fe
.
Çme
, c->fe.
¡¬t
 + c->
off£t
, 
u£
);

640 
c
->
off£t
 +ğ
u£
;

641 
	`fÜû_as£¹
(0 =ğ
Ën
);

645 
MEM_CHUNK
:

647 ià(0 !ğ
	`chunkqueue_­³nd_mem_to_‹mpfe
(
¤v
, 
de¡
, 
c
->
mem
->
±r
 + c->
off£t
, 
u£
)) {

651 ià(
u£
 =ğ
ş’
) {

653 
¤c
->
fœ¡
 = 
c
->
Ãxt
;

654 ià(
c
 =ğ
¤c
->
Ï¡
è¤c->Ï¡ = 
NULL
;

655 
	`chunkqueue_push_unu£d_chunk
(
¤c
, 
c
);

658 
c
->
off£t
 +ğ
u£
;

659 
	`fÜû_as£¹
(0 =ğ
Ën
);

664 
¤c
->
by‹s_out
 +ğ
u£
;

668 
	}
}

670 
off_t
 
	$chunkqueue_Ëngth
(
chunkqueue
 *
cq
) {

671 
off_t
 
Ën
 = 0;

672 
chunk
 *
c
;

674 
c
 = 
cq
->
fœ¡
; c; c = c->
Ãxt
) {

675 
Ën
 +ğ
	`chunk_»maššg_Ëngth
(
c
);

678  
Ën
;

679 
	}
}

681 
	$chunkqueue_is_em±y
(
chunkqueue
 *
cq
) {

682  
NULL
 =ğ
cq
->
fœ¡
;

683 
	}
}

685 
	$chunkqueue_m¬k_wr™‹n
(
chunkqueue
 *
cq
, 
off_t
 
Ën
) {

686 
off_t
 
wr™‹n
 = 
Ën
;

687 
chunk
 *
c
;

688 
	`fÜû_as£¹
(
Ën
 >= 0);

690 
c
 = 
cq
->
fœ¡
; 
NULL
 != c; c = cq->first) {

691 
off_t
 
c_Ën
 = 
	`chunk_»maššg_Ëngth
(
c
);

693 ià(0 =ğ
wr™‹n
 && 0 !ğ
c_Ën
) ;

695 ià(
wr™‹n
 >ğ
c_Ën
) {

696 
c
->
off£t
 +ğ
c_Ën
;

697 
wr™‹n
 -ğ
c_Ën
;

699 
cq
->
fœ¡
 = 
c
->
Ãxt
;

700 ià(
c
 =ğ
cq
->
Ï¡
ècq->Ï¡ = 
NULL
;

702 
	`chunkqueue_push_unu£d_chunk
(
cq
, 
c
);

704 
c
->
off£t
 +ğ
wr™‹n
;

705 
wr™‹n
 = 0;

710 
	`fÜû_as£¹
(0 =ğ
wr™‹n
);

711 
cq
->
by‹s_out
 +ğ
Ën
;

712 
	}
}

714 
	$chunkqueue_»move_fšished_chunks
(
chunkqueue
 *
cq
) {

715 
chunk
 *
c
;

717 
c
 = 
cq
->
fœ¡
; c; c = cq->first) {

718 ià(0 !ğ
	`chunk_»maššg_Ëngth
(
c
)) ;

720 
cq
->
fœ¡
 = 
c
->
Ãxt
;

721 ià(
c
 =ğ
cq
->
Ï¡
ècq->Ï¡ = 
NULL
;

723 
	`chunkqueue_push_unu£d_chunk
(
cq
, 
c
);

725 
	}
}

727 
	$chunkqueue_»move_em±y_chunks
(
chunkqueue
 *
cq
) {

728 
chunk
 *
c
;

729 
	`chunkqueue_»move_fšished_chunks
(
cq
);

730 ià(
	`chunkqueue_is_em±y
(
cq
)) ;

732 
c
 = 
cq
->
fœ¡
; c->
Ãxt
; c = c->next) {

733 ià(0 =ğ
	`chunk_»maššg_Ëngth
(
c
->
Ãxt
)) {

734 
chunk
 *
em±y
 = 
c
->
Ãxt
;

735 
c
->
Ãxt
 = 
em±y
->next;

736 ià(
em±y
 =ğ
cq
->
Ï¡
ècq->Ï¡ = 
c
;

738 
	`chunkqueue_push_unu£d_chunk
(
cq
, 
em±y
);

741 
	}
}

	@chunk.h

1 #iâdeà
_CHUNK_H_


2 
	#_CHUNK_H_


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

6 
	~"¬¿y.h
"

8 
	schunk
 {

9 ’um { 
	mMEM_CHUNK
, 
	mFILE_CHUNK
 } 
	mty³
;

11 
bufãr
 *
	mmem
;

15 
bufãr
 *
	mÇme
;

16 
off_t
 
	m¡¬t
;

17 
off_t
 
	mËngth
;

19 
	mfd
;

21 *
	m¡¬t
;

22 
size_t
 
	mËngth
;

23 
off_t
 
	moff£t
;

24 } 
	mmm­
;

26 
	mis_‹mp
;

27 } 
	mfe
;

33 
off_t
 
	moff£t
;

35 
chunk
 *
	mÃxt
;

36 } 
	tchunk
;

39 
chunk
 *
	mfœ¡
;

40 
chunk
 *
	mÏ¡
;

42 
chunk
 *
	munu£d
;

43 
size_t
 
	munu£d_chunks
;

45 
off_t
 
	mby‹s_š
, 
	mby‹s_out
;

47 
¬¿y
 *
	m‹mpdœs
;

48 
	mu¶ßd_‹mp_fe_size
;

49 
	m‹mpdœ_idx
;

50 } 
	tchunkqueue
;

52 
chunkqueue
 *
chunkqueue_š™
();

53 
chunkqueue_£t_‹mpdœs_deçuÉ
 (
¬¿y
 *
‹mpdœs
, 
u¶ßd_‹mp_fe_size
);

54 
chunkqueue_­³nd_fe
(
chunkqueue
 *
cq
, 
bufãr
 *
â
, 
off_t
 
off£t
, off_ˆ
Ën
);

55 
chunkqueue_­³nd_fe_fd
(
chunkqueue
 *
cq
, 
bufãr
 *
â
, 
fd
, 
off_t
 
off£t
, off_ˆ
Ën
);

56 
chunkqueue_­³nd_mem
(
chunkqueue
 *
cq
, cÚ¡ *
mem
, 
size_t
 
Ën
);

57 
chunkqueue_­³nd_bufãr
(
chunkqueue
 *
cq
, 
bufãr
 *
mem
);

58 
chunkqueue_´•’d_bufãr
(
chunkqueue
 *
cq
, 
bufãr
 *
mem
);

59 
chunkqueue_­³nd_chunkqueue
(
chunkqueue
 *
cq
, chunkqueu*
¤c
);

61 
	g£rv”
;

62 
chunkqueue_­³nd_mem_to_‹mpfe
(
£rv”
 *
¤v
, 
chunkqueue
 *
cq
, cÚ¡ *
mem
, 
size_t
 
Ën
);

73 
chunkqueue_g‘_memÜy
(
chunkqueue
 *
cq
, **
mem
, 
size_t
 *
Ën
, size_ˆ
mš_size
, size_ˆ
®loc_size
);

77 
chunkqueue_u£_memÜy
(
chunkqueue
 *
cq
, 
size_t
 
Ën
);

82 
chunkqueue_m¬k_wr™‹n
(
chunkqueue
 *
cq
, 
off_t
 
Ën
);

84 
chunkqueue_»move_fšished_chunks
(
chunkqueue
 *
cq
);

86 
chunkqueue_¡—l
(
chunkqueue
 *
de¡
, chunkqueu*
¤c
, 
off_t
 
Ën
);

87 
	g£rv”
;

88 
chunkqueue_¡—l_w™h_‹mpfes
(
£rv”
 *
¤v
, 
chunkqueue
 *
de¡
, chunkqueu*
¤c
, 
off_t
 
Ën
);

90 
off_t
 
chunkqueue_Ëngth
(
chunkqueue
 *
cq
);

91 
chunkqueue_ä“
(
chunkqueue
 *
cq
);

92 
chunkqueue_»£t
(
chunkqueue
 *
cq
);

94 
chunkqueue_is_em±y
(
chunkqueue
 *
cq
);

	@configfile-glue.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"bufãr.h
"

5 
	~"¬¿y.h
"

6 
	~"log.h
"

7 
	~"¶ugš.h
"

9 
	~"cÚfigfe.h
"

11 
	~<¡ršg.h
>

12 
	~<¡dlib.h
>

13 #iâdeà
_WIN32


14 
	~<¬·/š‘.h
>

32 
	$cÚfig_š£¹_v®ues_š‹º®
(
£rv”
 *
¤v
, 
¬¿y
 *
ÿ
, cÚ¡ 
cÚfig_v®ues_t
 
cv
[], 
cÚfig_scİe_ty³_t
 
scİe
) {

33 
size_t
 
i
;

34 
d©a_un£t
 *
du
;

36 
i
 = 0; 
cv
[i].
key
; i++) {

38 ià(
NULL
 =ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
ÿ
, 
cv
[
i
].
key
))) {

44 ià((
T_CONFIG_SCOPE_SERVER
 =ğ
cv
[
i
].
scİe
)

45 && (
T_CONFIG_SCOPE_SERVER
 !ğ
scİe
)) {

47 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

49 
cv
[
i
].
key
);

52 
cv
[
i
].
ty³
) {

53 
T_CONFIG_ARRAY
:

54 ià(
du
->
ty³
 =ğ
TYPE_ARRAY
) {

55 
size_t
 
j
;

56 
d©a_¬¿y
 *
da
 = (d©a_¬¿y *)
du
;

58 
j
 = 0; j < 
da
->
v®ue
->
u£d
; j++) {

59 
d©a_un£t
 *
ds
 = 
da
->
v®ue
->
d©a
[
j
];

60 ià(
ds
->
ty³
 =ğ
TYPE_STRING
) {

61 
	`¬¿y_š£¹_unique
(
cv
[
i
].
de¡š©iÚ
, 
ds
->
	`cİy
(ds));

63 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbsd",

65 
cv
[
i
].
key
, "[", 
ds
->key, "],y³:", ds->
ty³
);

71 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", 
cv
[
i
].
key
, "should have been‡‡rray of strings†ike ... = ( \"...\" )");

76 
T_CONFIG_STRING
:

77 ià(
du
->
ty³
 =ğ
TYPE_STRING
) {

78 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
du
;

80 
	`bufãr_cİy_bufãr
(
cv
[
i
].
de¡š©iÚ
, 
ds
->
v®ue
);

82 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", 
cv
[
i
].
key
, "should have been‡ string†ike ... = \"...\"");

87 
T_CONFIG_SHORT
:

88 
du
->
ty³
) {

89 
TYPE_INTEGER
: {

90 
d©a_š‹g”
 *
di
 = (d©a_š‹g” *)
du
;

92 *((*)(
cv
[
i
].
de¡š©iÚ
)èğ
di
->
v®ue
;

95 
TYPE_STRING
: {

96 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
du
;

104 ià(
ds
->
v®ue
->
±r
 && *ds->value->ptr) {

105 *
e
;

106 
l
 = 
	`¡¹Ş
(
ds
->
v®ue
->
±r
, &
e
, 10);

107 ià(
e
 !ğ
ds
->
v®ue
->
±r
 && !*&& 
l
 >=0 &&† <= 65535) {

108 *((*)(
cv
[
i
].
de¡š©iÚ
)èğ
l
;

113 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "gÙ‡ sŒšg buˆex³ùed‡ shÜt:", 
cv
[
i
].
key
, 
ds
->
v®ue
);

118 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssds", "uÃx³ùedy³ fÜ key:", 
cv
[
i
].
key
, 
du
->
ty³
, "expected‡ short integer,„ange 0 ... 65535");

122 
T_CONFIG_INT
:

123 
du
->
ty³
) {

124 
TYPE_INTEGER
: {

125 
d©a_š‹g”
 *
di
 = (d©a_š‹g” *)
du
;

127 *((*)(
cv
[
i
].
de¡š©iÚ
)èğ
di
->
v®ue
;

130 
TYPE_STRING
: {

131 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
du
;

133 ià(
ds
->
v®ue
->
±r
 && *ds->value->ptr) {

134 *
e
;

135 
l
 = 
	`¡¹Ş
(
ds
->
v®ue
->
±r
, &
e
, 10);

136 ià(
e
 !ğ
ds
->
v®ue
->
±r
 && !*&& 
l
 >= 0) {

137 *((*)(
cv
[
i
].
de¡š©iÚ
)èğ
l
;

142 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "gÙ‡ sŒšg buˆex³ùed‡Àš‹g”:", 
cv
[
i
].
key
, 
ds
->
v®ue
);

147 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssds", "uÃx³ùedy³ fÜ key:", 
cv
[
i
].
key
, 
du
->
ty³
, "expected‡n integer,„ange 0 ... 4294967295");

151 
T_CONFIG_BOOLEAN
:

152 ià(
du
->
ty³
 =ğ
TYPE_STRING
) {

153 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
du
;

155 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("enable"))) {

156 *((*)(
cv
[
i
].
de¡š©iÚ
)) = 1;

157 } ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("disable"))) {

158 *((*)(
cv
[
i
].
de¡š©iÚ
)) = 0;

160 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbs", "ERROR: uÃx³ùed v®ufÜ key:", 
cv
[
i
].
key
, 
ds
->
v®ue
, "(enable|disable)");

165 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssss", "ERROR: uÃx³ùedy³ fÜ key:", 
cv
[
i
].
key
, "(string)", "\"(enable|disable)\"");

170 
T_CONFIG_LOCAL
:

171 
T_CONFIG_UNSET
:

173 
T_CONFIG_UNSUPPORTED
:

174 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssss", "ERROR: found unsuµÜ‹d key:", 
cv
[
i
].
key
, "-", (*)(cv[i].
de¡š©iÚ
));

176 
¤v
->
cÚfig_unsuµÜ‹d
 = 1;

179 
T_CONFIG_DEPRECATED
:

180 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssss", "ERROR: found d•»ÿ‹d key:", 
cv
[
i
].
key
, "-", (*)(cv[i].
de¡š©iÚ
));

182 
¤v
->
cÚfig_d•»ÿ‹d
 = 1;

189 
	}
}

191 
	$cÚfig_š£¹_v®ues_glob®
(
£rv”
 *
¤v
, 
¬¿y
 *
ÿ
, cÚ¡ 
cÚfig_v®ues_t
 
cv
[], 
cÚfig_scİe_ty³_t
 
scİe
) {

192 
size_t
 
i
;

193 
d©a_un£t
 *
du
;

195 
i
 = 0; 
cv
[i].
key
; i++) {

196 
d©a_¡ršg
 *
touched
;

198 ià(
NULL
 =ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
ÿ
, 
cv
[
i
].
key
))) {

205 
touched
 = 
	`d©a_¡ršg_š™
();

207 
	`bufãr_cİy_¡ršg_Ën
(
touched
->
v®ue
, 
	`CONST_STR_LEN
(""));

208 
	`bufãr_cİy_bufãr
(
touched
->
key
, 
du
->key);

210 
	`¬¿y_š£¹_unique
(
¤v
->
cÚfig_touched
, (
d©a_un£t
 *)
touched
);

213  
	`cÚfig_š£¹_v®ues_š‹º®
(
¤v
, 
ÿ
, 
cv
, 
scİe
);

214 
	}
}

216 
	$sock_addr_g‘_pÜt
(
sock_addr
 *
addr
) {

217 #ifdeà
HAVE_IPV6


218  
	`Áohs
(
addr
->
¶aš
.
§_çmy
 ?‡ddr->
v6
.
sš6_pÜt
 :‡ddr->
v4
.
sš_pÜt
);

220  
	`Áohs
(
addr
->
v4
.
sš_pÜt
);

222 
	}
}

224 cÚ¡ * 
	$cÚd_»suÉ_to_¡ršg
(
cÚd_»suÉ_t
 
cÚd_»suÉ
) {

225 
cÚd_»suÉ
) {

226 
COND_RESULT_UNSET
:  "unset";

227 
COND_RESULT_SKIP
:  "skipped";

228 
COND_RESULT_FALSE
:  "false";

229 
COND_RESULT_TRUE
:  "true";

232 
	}
}

234 
	$cÚfig_addr¡r_eq_»mÙe__mask
(
£rv”
 *
¤v
, cÚ¡ *
addr¡r
, 
nm_b™s
, 
sock_addr
 *
rmt
) {

236 
sock_addr
 
v®
;

237 #ifdeà
HAVE_INET_PTON


238 ià(1 =ğ
	`š‘_±Ú
(
AF_INET
, 
addr¡r
, &
v®
.
v4
.
sš_addr
))

240 ià(
INADDR_NONE
 !ğ(
v®
.
v4
.
sš_addr
 = 
	`š‘_addr
(
addr¡r
)))

244 
ušt32_t
 
nm
;

245 ià(
nm_b™s
 > 32) {

246 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "ERROR: ipv4‚‘maskoØÏrge:", 
nm_b™s
);

249 
nm
 = 
	`htÚl
(~((1u << (32 - (0 !ğ
nm_b™s
 ?‚m_bits : 32))) - 1));

251 ià(
rmt
->
¶aš
.
§_çmy
 =ğ
AF_INET
) {

252  ((
v®
.
v4
.
sš_addr
.
s_addr
 & 
nm
è=ğ(
rmt
->ipv4.sin_addr.s_addr &‚m));

253 #ifdeà
HAVE_IPV6


254 } ià(
rmt
->
¶aš
.
§_çmy
 =ğ
AF_INET6


255 && 
	`IN6_IS_ADDR_V4MAPPED
(&
rmt
->
v6
.
sš6_addr
)) {

256 #ifdeà
s6_addr32


257 
š_addr_t
 
x
 = 
rmt
->
v6
.
sš6_addr
.
s6_addr32
[3];

259 
š_addr_t
 
x
;

260 
	`memıy
(&
x
, 
rmt
->
v6
.
sš6_addr
.
s6_addr
+12, (
š_addr_t
));

262  ((
v®
.
v4
.
sš_addr
.
s_addr
 & 
nm
è=ğ(
x
 &‚m));

267 #ià
	`defšed
(
HAVE_INET_PTON
è&& defšed(
HAVE_IPV6
)

268 } ià(1 =ğ
	`š‘_±Ú
(
AF_INET6
, 
addr¡r
, &
v®
.
v6
.
sš6_addr
)) {

269 ià(
nm_b™s
 > 128) {

270 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "ERROR: ipv6‚‘maskoØÏrge:", 
nm_b™s
);

273 ià(
rmt
->
¶aš
.
§_çmy
 =ğ
AF_INET6
) {

274 
ušt8_t
 *
a
 = (ušt8_ˆ*)&
v®
.
v6
.
sš6_addr
.
s6_addr
[0];

275 
ušt8_t
 *
b
 = (ušt8_ˆ*)&
rmt
->
v6
.
sš6_addr
.
s6_addr
[0];

276 
m©ch
;

278 
m©ch
 = (
nm_b™s
 >= 8)

279 ? *
a
++ =ğ*
b
++

280 : (*
a
 >> (8 - 
nm_b™s
)è=ğ(*
b
 >> (8 -‚m_bits));

281 } 
m©ch
 && (
nm_b™s
 -= 8) > 0);

282  
m©ch
;

283 } ià(
rmt
->
¶aš
.
§_çmy
 =ğ
AF_INET


284 && 
	`IN6_IS_ADDR_V4MAPPED
(&
v®
.
v6
.
sš6_addr
)) {

285 
ušt32_t
 
nm
 =

286 
nm_b™s
 < 128 ? 
	`htÚl
(~(~0u >> (nm_bits > 96 ?‚m_bits - 96 : 0))) : ~0u;

287 #ifdeà
s6_addr32


288 
š_addr_t
 
x
 = 
v®
.
v6
.
sš6_addr
.
s6_addr32
[3];

290 
š_addr_t
 
x
;

291 
	`memıy
(&
x
, 
v®
.
v6
.
sš6_addr
.
s6_addr
+12, (
š_addr_t
));

293  ((
x
 & 
nm
è=ğ(
rmt
->
v4
.
sš_addr
.
s_addr
 &‚m));

299 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ERROR: i°add¸i šv®id:", 
addr¡r
);

302 
	}
}

304 
	$cÚfig_addrbuf_eq_»mÙe__mask
(
£rv”
 *
¤v
, 
bufãr
 *
¡ršg
, *
nm_¦ash
, 
sock_addr
 *
rmt
) {

305 *
”r
;

306 
nm_b™s
 = 
	`¡¹Ş
(
nm_¦ash
 + 1, &
”r
, 10);

307 
size_t
 
addr¡¾’
 = (size_t)(
nm_¦ash
 - 
¡ršg
->
±r
);

308 
addr¡r
[64];

310 ià(*
”r
) {

311 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "ERROR:‚Ú-dig™ found iÀÃtmask:", 
¡ršg
, 
”r
);

315 ià(
nm_b™s
 <= 0) {

316 ià(*(
nm_¦ash
+1) == '\0') {

317 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "ERROR:‚Ønumb”‡á” / ", 
¡ršg
);

319 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "ERROR: inv®id‚‘mask <ğ0:", 
¡ršg
, 
”r
);

324 ià(
addr¡¾’
 >ğ(
addr¡r
)) {

325 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "ERROR:‡dd»s ¡ršgoØlÚg:", 
¡ršg
);

329 
	`memıy
(
addr¡r
, 
¡ršg
->
±r
, 
addr¡¾’
);

330 
addr¡r
[
addr¡¾’
] = '\0';

332  
	`cÚfig_addr¡r_eq_»mÙe__mask
(
¤v
, 
addr¡r
, 
nm_b™s
, 
rmt
);

333 
	}
}

335 
cÚd_»suÉ_t
 
cÚfig_check_cÚd_ÿched
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
);

337 
cÚd_»suÉ_t
 
	$cÚfig_check_cÚd_noÿche
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
) {

338 
bufãr
 *
l
;

339 
£rv”_sock‘
 *
¤v_sock
 = 
cÚ
->
¤v_sock‘
;

340 
cÚd_ÿche_t
 *
ÿche
 = &
cÚ
->
cÚd_ÿche
[
dc
->
cÚ‹xt_ndx
];

343 ià(
dc
->
·»Á
 && dc->·»Á->
cÚ‹xt_ndx
) {

349 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

350 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "gØ·»Á", 
dc
->
·»Á
->
key
);

353 
	`cÚfig_check_cÚd_ÿched
(
¤v
, 
cÚ
, 
dc
->
·»Á
)) {

354 
COND_RESULT_UNSET
:

356  
COND_RESULT_UNSET
;

357 
COND_RESULT_SKIP
:

358 
COND_RESULT_FALSE
:

360  
COND_RESULT_SKIP
;

361 
COND_RESULT_TRUE
:

367 ià(
dc
->
´ev
) {

372 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

373 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "gØ´ev", 
dc
->
´ev
->
key
);

377 
	`cÚfig_check_cÚd_ÿched
(
¤v
, 
cÚ
, 
dc
->
´ev
)) {

378 
COND_RESULT_UNSET
:

380  
COND_RESULT_UNSET
;

381 
COND_RESULT_SKIP
:

382 
COND_RESULT_TRUE
:

384  
COND_RESULT_SKIP
;

385 
COND_RESULT_FALSE
:

391 ià(!
cÚ
->
cÚd™iÚ®_is_v®id
[
dc
->
comp
]) {

392 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

393 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "dss",

394 
dc
->
comp
,

395 
dc
->
key
->
±r
,

399  
COND_RESULT_UNSET
;

403 
ÿche
->
loÿl_»suÉ
) {

404 
COND_RESULT_TRUE
:

405 
COND_RESULT_FALSE
:

406  
ÿche
->
loÿl_»suÉ
;

411 ià(
CONFIG_COND_ELSE
 =ğ
dc
->
cÚd
è 
COND_RESULT_TRUE
;

415 
dc
->
comp
) {

416 
COMP_HTTP_HOST
: {

417 *
ck_cŞÚ
 = 
NULL
, *
v®_cŞÚ
 = NULL;

419 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
authÜ™y
)) {

425 
l
 = 
cÚ
->
uri
.
authÜ™y
;

427 
dc
->
cÚd
) {

428 
CONFIG_COND_NE
:

429 
CONFIG_COND_EQ
:

430 
ck_cŞÚ
 = 
	`¡rchr
(
dc
->
¡ršg
->
±r
, ':');

431 
v®_cŞÚ
 = 
	`¡rchr
(
l
->
±r
, ':');

433 ià(
NULL
 !ğ
ck_cŞÚ
 && NULL =ğ
v®_cŞÚ
) {

435 
	`bufãr_cİy_bufãr
(
¤v
->
cÚd_check_buf
, 
l
);

436 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
cÚd_check_buf
, 
	`CONST_STR_LEN
(":"));

437 
	`bufãr_­³nd_št
(
¤v
->
cÚd_check_buf
, 
	`sock_addr_g‘_pÜt
(&(
¤v_sock
->
addr
)));

438 
l
 = 
¤v
->
cÚd_check_buf
;

439 } ià(
NULL
 !ğ
v®_cŞÚ
 && NULL =ğ
ck_cŞÚ
) {

441 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
cÚd_check_buf
, 
l
->
±r
, 
v®_cŞÚ
 -†->ptr);

442 
l
 = 
¤v
->
cÚd_check_buf
;

448 #ià
defšed
 
USE_OPENSSL
 && ! defšed 
OPENSSL_NO_TLSEXT


449 } ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
£xt_£rv”_Çme
)) {

450 
l
 = 
cÚ
->
£xt_£rv”_Çme
;

453 
l
 = 
¤v
->
em±y_¡ršg
;

457 
COMP_HTTP_REMOTE_IP
: {

458 *
nm_¦ash
;

468 ià((
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
 ||

469 
dc
->
cÚd
 =ğ
CONFIG_COND_NE
) &&

470 (
NULL
 !ğ(
nm_¦ash
 = 
	`¡rchr
(
dc
->
¡ršg
->
±r
, '/')))) {

471 
	`cÚfig_addrbuf_eq_»mÙe__mask
(
¤v
, 
dc
->
¡ršg
, 
nm_¦ash
, &
cÚ
->
d¡_addr
)) {

472 1:  (
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
è? 
COND_RESULT_TRUE
 : 
COND_RESULT_FALSE
;

473 0:  (
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
è? 
COND_RESULT_FALSE
 : 
COND_RESULT_TRUE
;

474 -1:  
COND_RESULT_FALSE
;

477 
l
 = 
cÚ
->
d¡_addr_buf
;

480 
COMP_HTTP_SCHEME
:

481 
l
 = 
cÚ
->
uri
.
scheme
;

484 
COMP_HTTP_URL
:

485 
l
 = 
cÚ
->
uri
.
·th
;

488 
COMP_HTTP_QUERY_STRING
:

489 
l
 = 
cÚ
->
uri
.
qu”y
;

492 
COMP_SERVER_SOCKET
:

493 
l
 = 
¤v_sock
->
¤v_tok’
;

496 
COMP_HTTP_REFERER
: {

497 
d©a_¡ršg
 *
ds
;

499 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Referer"))) {

500 
l
 = 
ds
->
v®ue
;

502 
l
 = 
¤v
->
em±y_¡ršg
;

506 
COMP_HTTP_COOKIE
: {

507 
d©a_¡ršg
 *
ds
;

508 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Cookie"))) {

509 
l
 = 
ds
->
v®ue
;

511 
l
 = 
¤v
->
em±y_¡ršg
;

515 
COMP_HTTP_USER_AGENT
: {

516 
d©a_¡ršg
 *
ds
;

517 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "User-Agent"))) {

518 
l
 = 
ds
->
v®ue
;

520 
l
 = 
¤v
->
em±y_¡ršg
;

524 
COMP_HTTP_REQUEST_METHOD
: {

525 cÚ¡ *
m‘hod
 = 
	`g‘_h‰p_m‘hod_Çme
(
cÚ
->
»que¡
.
h‰p_m‘hod
);

529 
	`bufãr_cİy_¡ršg
(
¤v
->
tmp_buf
, 
m‘hod
);

531 
l
 = 
¤v
->
tmp_buf
;

535 
COMP_HTTP_LANGUAGE
: {

536 
d©a_¡ršg
 *
ds
;

537 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Accept-Language"))) {

538 
l
 = 
ds
->
v®ue
;

540 
l
 = 
¤v
->
em±y_¡ršg
;

545  
COND_RESULT_FALSE
;

548 ià(
NULL
 =ğ
l
) {

549 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

550 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "bsbs", 
dc
->
comp_key
,

551 "(", 
l
, ") compareo NULL");

553  
COND_RESULT_FALSE
;

556 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

557 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "bsbsb", 
dc
->
comp_key
,

558 "(", 
l
, "ècom·»Ø", 
dc
->
¡ršg
);

560 
dc
->
cÚd
) {

561 
CONFIG_COND_NE
:

562 
CONFIG_COND_EQ
:

563 ià(
	`bufãr_is_equ®
(
l
, 
dc
->
¡ršg
)) {

564  (
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
è? 
COND_RESULT_TRUE
 : 
COND_RESULT_FALSE
;

566  (
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
è? 
COND_RESULT_FALSE
 : 
COND_RESULT_TRUE
;

569 #ifdeà
HAVE_PCRE_H


570 
CONFIG_COND_NOMATCH
:

571 
CONFIG_COND_MATCH
: {

572 
n
;

574 #iâdeà
–em’tsof


575 
	#–em’tsof
(
x
è((xè/ (x[0]))

	)

577 
n
 = 
	`püe_exec
(
dc
->
»gex
, dc->
»gex_¡udy
, 
	`CONST_BUF_LEN
(
l
), 0, 0,

578 
ÿche
->
m©ches
, 
	`–em’tsof
(cache->matches));

580 
ÿche
->
·‰”ncouÁ
 = 
n
;

581 ià(
n
 > 0) {

582 
ÿche
->
comp_v®ue
 = 
l
;

583  (
dc
->
cÚd
 =ğ
CONFIG_COND_MATCH
è? 
COND_RESULT_TRUE
 : 
COND_RESULT_FALSE
;

586  (
dc
->
cÚd
 =ğ
CONFIG_COND_MATCH
è? 
COND_RESULT_FALSE
 : 
COND_RESULT_TRUE
;

596  
COND_RESULT_FALSE
;

597 
	}
}

599 
cÚd_»suÉ_t
 
	$cÚfig_check_cÚd_ÿched
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
) {

600 
cÚd_ÿche_t
 *
ÿches
 = 
cÚ
->
cÚd_ÿche
;

602 ià(
COND_RESULT_UNSET
 =ğ
ÿches
[
dc
->
cÚ‹xt_ndx
].
»suÉ
) {

603 
ÿches
[
dc
->
cÚ‹xt_ndx
].
»suÉ
 = 
	`cÚfig_check_cÚd_noÿche
(
¤v
, 
cÚ
, dc);

604 
ÿches
[
dc
->
cÚ‹xt_ndx
].
»suÉ
) {

605 
COND_RESULT_FALSE
:

606 
COND_RESULT_TRUE
:

608 
ÿches
[
dc
->
cÚ‹xt_ndx
].
loÿl_»suÉ
 = caches[dc->cÚ‹xt_ndx].
»suÉ
;

614 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

615 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "dss",

616 
dc
->
cÚ‹xt_ndx
,

618 
	`cÚd_»suÉ_to_¡ršg
(
ÿches
[
dc
->
cÚ‹xt_ndx
].
»suÉ
));

621 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

622 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "dss",

623 
dc
->
cÚ‹xt_ndx
,

625 
	`cÚd_»suÉ_to_¡ršg
(
ÿches
[
dc
->
cÚ‹xt_ndx
].
»suÉ
));

628  
ÿches
[
dc
->
cÚ‹xt_ndx
].
»suÉ
;

629 
	}
}

633 
	$cÚfig_cÚd_ş—r_node
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
) {

635 ià(
cÚ
->
cÚd_ÿche
[
dc
->
cÚ‹xt_ndx
].
»suÉ
 !ğ
COND_RESULT_UNSET
) {

636 
size_t
 
i
;

638 
cÚ
->
cÚd_ÿche
[
dc
->
cÚ‹xt_ndx
].
·‰”ncouÁ
 = 0;

639 
cÚ
->
cÚd_ÿche
[
dc
->
cÚ‹xt_ndx
].
comp_v®ue
 = 
NULL
;

640 
cÚ
->
cÚd_ÿche
[
dc
->
cÚ‹xt_ndx
].
»suÉ
 = 
COND_RESULT_UNSET
;

642 
i
 = 0; i < 
dc
->
chd»n
.
u£d
; ++i) {

643 
d©a_cÚfig
 *
dc_chd
 = 
dc
->
chd»n
.
d©a
[
i
];

644 ià(
NULL
 =ğ
dc_chd
->
´ev
) {

646 
	`cÚfig_cÚd_ş—r_node
(
¤v
, 
cÚ
, 
dc_chd
);

649 ià(
NULL
 !ğ
dc
->
Ãxt
è
	`cÚfig_cÚd_ş—r_node
(
¤v
, 
cÚ
, dc->next);

651 
	}
}

658 
	$cÚfig_cÚd_ÿche_»£t_™em
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
comp_key_t
 
™em
) {

659 
size_t
 
i
;

661 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

662 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

664 ià(
™em
 =ğ
dc
->
comp
) {

666 
cÚ
->
cÚd_ÿche
[
i
].
loÿl_»suÉ
 = 
COND_RESULT_UNSET
;

668 
	`cÚfig_cÚd_ş—r_node
(
¤v
, 
cÚ
, 
dc
);

671 
	}
}

676 
	$cÚfig_cÚd_ÿche_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

677 
size_t
 
i
;

680 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

681 
cÚ
->
cÚd_ÿche
[
i
].
»suÉ
 = 
COND_RESULT_UNSET
;

682 
cÚ
->
cÚd_ÿche
[
i
].
loÿl_»suÉ
 = 
COND_RESULT_UNSET
;

683 
cÚ
->
cÚd_ÿche
[
i
].
·‰”ncouÁ
 = 0;

684 
cÚ
->
cÚd_ÿche
[
i
].
comp_v®ue
 = 
NULL
;

687 
i
 = 0; i < 
COMP_LAST_ELEMENT
; i++) {

688 
cÚ
->
cÚd™iÚ®_is_v®id
[
i
] = 0;

690 
	}
}

692 
	$cÚfig_check_cÚd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
) {

693 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

694 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "=== start of condition block ===");

696  (
	`cÚfig_check_cÚd_ÿched
(
¤v
, 
cÚ
, 
dc
è=ğ
COND_RESULT_TRUE
);

697 
	}
}

699 
	$cÚfig_­³nd_cÚd_m©ch_bufãr
(
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
, 
bufãr
 *
buf
, 
n
)

701 
cÚd_ÿche_t
 *
ÿche
 = &
cÚ
->
cÚd_ÿche
[
dc
->
cÚ‹xt_ndx
];

702 ià(
n
 >ğ
ÿche
->
·‰”ncouÁ
) {

706 
n
 <<= 1;

707 
	`bufãr_­³nd_¡ršg_Ën
(
buf
,

708 
ÿche
->
comp_v®ue
->
±r
 + cache->
m©ches
[
n
],

709 
ÿche
->
m©ches
[
n
 + 1] - cache->matches[n]);

711 
	}
}

	@configfile.c

1 
	~"fœ¡.h
"

3 
	~"£rv”.h
"

4 
	~"log.h
"

5 
	~"¡»am.h
"

6 
	~"¶ugš.h
"

8 
	~"cÚfig·r£r.h
"

9 
	~"cÚfigfe.h
"

10 
	~"´oc_İ’.h
"

11 
	~"»que¡.h
"

12 
	~"v”siÚ.h
"

14 
	~<sys/¡©.h
>

16 
	~<¡dlib.h
>

17 
	~<fú.h
>

18 
	~<uni¡d.h
>

19 
	~<”ºo.h
>

20 
	~<¡ršg.h
>

21 
	~<¡dio.h
>

22 
	~<ùy³.h
>

23 
	~<lim™s.h
>

24 
	~<as£¹.h
>

25 
	~<glob.h
>

28 #ià
defšed
(
HAVE_MYSQL
è|| (defšed(
HAVE_LDAP_H
è&& defšed(
HAVE_LBER_H
è&& defšed(
HAVE_LIBLDAP
è&& defšed(
HAVE_LIBLBER
))

29 
	$cÚfig_w¬n_authn_moduË
 (
£rv”
 *
¤v
, cÚ¡ *
moduË
) {

30 
size_t
 
Ën
 = 
	`¡¾’
(
moduË
);

31 
size_t
 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; ++i) {

32 cÚ¡ 
d©a_cÚfig
 *
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

33 cÚ¡ 
d©a_un£t
 *
du
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "auth.backend");

34 ià(
NULL
 !ğ
du
 && du->
ty³
 =ğ
TYPE_STRING
) {

35 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
du
;

36 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
moduË
, 
Ën
)) {

37 
ds
 = 
	`d©a_¡ršg_š™
();

38 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_authn_"));

39 
	`bufãr_­³nd_¡ršg
(
ds
->
v®ue
, 
moduË
);

40 
	`¬¿y_š£¹_unique
(
¤v
->
¤vcÚf
.
moduËs
, (
d©a_un£t
 *)
ds
);

41 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSSsSSS", "W¬nšg:…Ëa£‡dd \"mod_authn_", 
moduË
, "\"o server.modules†ist in†ighttpd.conf. A future„elease of†ighttpd 1.4.x will‚ot‡utomatically†oad mod_authn_", module, "and†ighttpd will failo start up since your†ighttpd.conf uses‡uth.backend = \"", module, "\".");

46 
	}
}

49 
	$cÚfig_š£¹
(
£rv”
 *
¤v
) {

50 
size_t
 
i
;

51 
»t
 = 0;

52 
bufãr
 *
¡©_ÿche_¡ršg
;

54 
cÚfig_v®ues_t
 
cv
[] = {

55 { "£rv”.bšd", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

56 { "£rv”.”rÜlog", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

57 { "£rv”.”rÜfe-´efix", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

58 { "£rv”.chroÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

59 { "£rv”.u£ºame", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

60 { "£rv”.grou²ame", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

61 { "£rv”.pÜt", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_SERVER
 },

62 { "£rv”.g", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

63 { "£rv”.u£-v6", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

64 { "£rv”.moduËs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_SERVER
 },

66 { "£rv”.ev’t-hªdËr", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

67 { "£rv”.pid-fe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

68 { "£rv”.max-»que¡-size", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

69 { "£rv”.max-wÜk”", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_SERVER
 },

70 { "£rv”.docum’t-roÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

71 { "£rv”.fÜû-low”ÿ£-f’ames", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

72 { "debug.log-cÚd™iÚ-hªdlšg", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

73 { "£rv”.max-k“p-®ive-»que¡s", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

74 { "£rv”.Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

75 { "£rv”.max-k“p-®ive-idË", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

77 { "£rv”.max-»ad-idË", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

78 { "£rv”.max-wr™e-idË", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

79 { "£rv”.”rÜ-hªdËr", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

80 { "£rv”.max-fds", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_SERVER
 },

81 #ifdeà
HAVE_LSTAT


82 { "£rv”.fŞlow-symlšk", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

87 
T_CONFIG_UNSUPPORTED
, 
T_CONFIG_SCOPE_UNSET
 },

89 { "£rv”.kby‹s-³r-£cÚd", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

90 { "cÚÃùiÚ.kby‹s-³r-£cÚd", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

91 { "mim‘y³.u£-x©Œ", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

92 { "mim‘y³.assign", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

93 { "s¦.³mfe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

95 { "s¦.’gše", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

96 { "debug.log-fe-nÙ-found", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

97 { "debug.log-»que¡-hªdlšg", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

98 { "debug.log-»¥Ú£-h—d”", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

99 { "debug.log-»que¡-h—d”", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

100 { "debug.log-s¦-noi£", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

101 { "£rv”.´ÙocŞ-h‰p11", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

102 { "debug.log-»que¡-h—d”-Ú-”rÜ", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

103 { "debug.log-¡©e-hªdlšg", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

104 { "s¦.ÿ-fe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

106 { "£rv”.”rÜlog-u£-sy¦og", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

107 { "£rv”.¿nge-»que¡s", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

108 { "£rv”.¡©-ÿche-’gše", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

109 { "£rv”.max-cÚÃùiÚs", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_SERVER
 },

110 { "£rv”.ÃtwÜk-back’d", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

111 { "£rv”.u¶ßd-dœs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_SERVER
 },

112 { "£rv”.cÜe-fes", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

113 { "s¦.ch”-li¡", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

114 { "s¦.u£-s¦v2", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

115 { "‘ag.u£-šode", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

117 { "‘ag.u£-mtime", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

118 { "‘ag.u£-size", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

119 { "£rv”.»jeù-ex³ù-100-w™h-417", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

120 { "debug.log-timeouts", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

121 { "£rv”.deãr-acû±", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

122 { "£rv”.b»akag–og", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

123 { "s¦.v”ifyş›Á.aùiv©e", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

124 { "s¦.v”ifyş›Á.’fÜû", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

125 { "s¦.v”ifyş›Á.d•th", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

126 { "s¦.v”ifyş›Á.u£ºame", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

128 { "s¦.v”ifyş›Á.expÜtû¹", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

129 { "£rv”.£t-v6Úly", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

130 { "s¦.u£-s¦v3", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

131 { "s¦.dh-fe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

132 { "s¦.ec-curve", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

133 { "s¦.di§bË-ş›Á-»ÃgÙŸtiÚ", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

134 { "s¦.hÚÜ-ch”-Üd”", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

135 { "s¦.em±y-äagm’ts", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

136 { "£rv”.u¶ßd-‹mp-fe-size", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_SERVER
 },

137 { "mim‘y³.x©Œ-Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_SERVER
 },

138 { "£rv”.li¡’-backlog", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

139 { "£rv”.”rÜ-hªdËr-404", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

140 { "£rv”.h‰p-·r£İt-h—d”-¡riù",
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

141 { "£rv”.h‰p-·r£İt-ho¡-¡riù", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

142 { "£rv”.h‰p-·r£İt-ho¡-nÜm®ize",
NULL
,
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_SERVER
 },

143 { "£rv”.bsd-acû±-f‹r", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

144 { "£rv”.¡»am-»que¡-body", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

145 { "£rv”.¡»am-»¥Ú£-body", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

146 { "£rv”.max-»que¡-f›ld-size", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_SERVER
 },

147 { "s¦.»ad-ah—d", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

149 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

153 
cv
[0].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
bšdho¡
;

154 
cv
[1].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
”rÜlog_fe
;

155 
cv
[3].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
chªg”oÙ
;

156 
cv
[4].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
u£ºame
;

157 
cv
[5].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
grou²ame
;

158 
cv
[6].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
pÜt
);

159 
cv
[9].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
moduËs
;

161 
cv
[10].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
ev’t_hªdËr
;

162 
cv
[11].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
pid_fe
;

163 
cv
[13].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
max_wÜk”
);

165 
cv
[23].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
max_fds
);

167 
cv
[37].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
);

168 
cv
[38].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
log_¡©e_hªdlšg
);

170 
cv
[40].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
”rÜlog_u£_sy¦og
);

171 
¡©_ÿche_¡ršg
 = 
	`bufãr_š™
();

172 
cv
[42].
de¡š©iÚ
 = 
¡©_ÿche_¡ršg
;

173 
cv
[43].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
max_cÚns
);

174 
cv
[44].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
ÃtwÜk_back’d
;

175 
cv
[45].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
;

176 
cv
[46].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
’abË_cÜes
);

178 
cv
[52].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
»jeù_ex³ù_100_w™h_417
);

179 
cv
[55].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
b»akag–og_fe
;

181 
cv
[68].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
u¶ßd_‹mp_fe_size
);

182 
cv
[69].
de¡š©iÚ
 = 
¤v
->
¤vcÚf
.
x©Œ_Çme
;

183 
cv
[72].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
h‰p_h—d”_¡riù
);

184 
cv
[73].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
h‰p_ho¡_¡riù
);

185 
cv
[74].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
h‰p_ho¡_nÜm®ize
);

186 
cv
[78].
de¡š©iÚ
 = &(
¤v
->
¤vcÚf
.
max_»que¡_f›ld_size
);

188 
¤v
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, srv->
cÚfig_cÚ‹xt
->
u£d
 * (
¥ecific_cÚfig
 *));

190 
	`fÜû_as£¹
(
¤v
->
cÚfig_¡Üage
);

191 
	`fÜû_as£¹
(
¤v
->
cÚfig_cÚ‹xt
->
u£d
);

194 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

195 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

196 
¥ecific_cÚfig
 *
s
;

198 
s
 = 
	`ÿÎoc
(1, (
¥ecific_cÚfig
));

199 
	`fÜû_as£¹
(
s
);

200 
s
->
docum’t_roÙ
 = 
	`bufãr_š™
();

201 
s
->
mim‘y³s
 = 
	`¬¿y_š™
();

202 
s
->
£rv”_Çme
 = 
	`bufãr_š™
();

203 
s
->
s¦_³mfe
 = 
	`bufãr_š™
();

204 
s
->
s¦_ÿ_fe
 = 
	`bufãr_š™
();

205 
s
->
”rÜ_hªdËr
 = 
	`bufãr_š™
();

206 
s
->
”rÜ_hªdËr_404
 = 
	`bufãr_š™
();

207 
s
->
£rv”_g
 = 
	`bufãr_š™_¡ršg
(
PACKAGE_DESC
);

208 
s
->
s¦_ch”_li¡
 = 
	`bufãr_š™
();

209 
s
->
s¦_dh_fe
 = 
	`bufãr_š™
();

210 
s
->
s¦_ec_curve
 = 
	`bufãr_š™
();

211 
s
->
”rÜfe_´efix
 = 
	`bufãr_š™
();

212 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
) \

213 || 
	`defšed
(
__O³nBSD__
è|| defšed(
__D¿gÚFly__
)

214 
s
->
bsd_acû±_f‹r
 = (
i
 == 0)

215 ? 
	`bufãr_š™
()

216 : 
	`bufãr_š™_bufãr
(
¤v
->
cÚfig_¡Üage
[0]->
bsd_acû±_f‹r
);

218 
s
->
max_k“p_®ive_»que¡s
 = 16;

219 
s
->
max_k“p_®ive_idË
 = 5;

220 
s
->
max_»ad_idË
 = 60;

221 
s
->
max_wr™e_idË
 = 360;

222 
s
->
max_»que¡_size
 = 0;

223 
s
->
u£_x©Œ
 = 0;

224 
s
->
s¦_’abËd
 = 0;

225 
s
->
s¦_hÚÜ_ch”_Üd”
 = 1;

226 
s
->
s¦_em±y_äagm’ts
 = 0;

227 
s
->
s¦_u£_s¦v2
 = 0;

228 
s
->
s¦_u£_s¦v3
 = 0;

229 
s
->
u£_v6
 = (
i
 =ğ0è? 0 : 
¤v
->
cÚfig_¡Üage
[0]->use_ipv6;

230 
s
->
£t_v6Úly
 = (
i
 =ğ0è? 1 : 
¤v
->
cÚfig_¡Üage
[0]->set_v6only;

231 
s
->
deãr_acû±
 = (
i
 =ğ0è? 0 : 
¤v
->
cÚfig_¡Üage
[0]->defer_accept;

232 #ifdeà
HAVE_LSTAT


233 
s
->
fŞlow_symlšk
 = 1;

235 
s
->
kby‹s_³r_£cÚd
 = 0;

236 
s
->
®low_h‰p11
 = 1;

237 
s
->
‘ag_u£_šode
 = 1;

238 
s
->
‘ag_u£_mtime
 = 1;

239 
s
->
‘ag_u£_size
 = 1;

240 
s
->
¿nge_»que¡s
 = 1;

241 
s
->
fÜû_low”ÿ£_f’ames
 = (
i
 == 0) ? 2 : 0;

242 
s
->
glob®_kby‹s_³r_£cÚd
 = 0;

243 
s
->
glob®_by‹s_³r_£cÚd_út
 = 0;

244 
s
->
glob®_by‹s_³r_£cÚd_út_±r
 = &s->
glob®_by‹s_³r_£cÚd_út
;

245 
s
->
s¦_v”ifyş›Á
 = 0;

246 
s
->
s¦_v”ifyş›Á_’fÜû
 = 1;

247 
s
->
s¦_v”ifyş›Á_u£ºame
 = 
	`bufãr_š™
();

248 
s
->
s¦_v”ifyş›Á_d•th
 = 9;

249 
s
->
s¦_v”ifyş›Á_expÜt_û¹
 = 0;

250 
s
->
s¦_di§bË_ş›Á_»ÃgÙŸtiÚ
 = 1;

251 
s
->
s¦_»ad_ah—d
 = (0 =ğ
i
 ? 1 : 
¤v
->
cÚfig_¡Üage
[0]->ssl_read_ahead);

252 
s
->
li¡’_backlog
 = (0 =ğ
i
 ? 1024 : 
¤v
->
cÚfig_¡Üage
[0]->listen_backlog);

253 
s
->
¡»am_»que¡_body
 = 0;

254 
s
->
¡»am_»¥Ú£_body
 = 0;

257 
cv
[2].
de¡š©iÚ
 = 
s
->
”rÜfe_´efix
;

258 
cv
[7].
de¡š©iÚ
 = 
s
->
£rv”_g
;

259 
cv
[8].
de¡š©iÚ
 = &(
s
->
u£_v6
);

261 
cv
[12].
de¡š©iÚ
 = &(
s
->
max_»que¡_size
);

262 
cv
[14].
de¡š©iÚ
 = 
s
->
docum’t_roÙ
;

263 
cv
[15].
de¡š©iÚ
 = &(
s
->
fÜû_low”ÿ£_f’ames
);

264 
cv
[16].
de¡š©iÚ
 = &(
s
->
log_cÚd™iÚ_hªdlšg
);

265 
cv
[17].
de¡š©iÚ
 = &(
s
->
max_k“p_®ive_»que¡s
);

266 
cv
[18].
de¡š©iÚ
 = 
s
->
£rv”_Çme
;

267 
cv
[19].
de¡š©iÚ
 = &(
s
->
max_k“p_®ive_idË
);

269 
cv
[20].
de¡š©iÚ
 = &(
s
->
max_»ad_idË
);

270 
cv
[21].
de¡š©iÚ
 = &(
s
->
max_wr™e_idË
);

271 
cv
[22].
de¡š©iÚ
 = 
s
->
”rÜ_hªdËr
;

272 #ifdeà
HAVE_LSTAT


273 
cv
[24].
de¡š©iÚ
 = &(
s
->
fŞlow_symlšk
);

275 
cv
[25].
de¡š©iÚ
 = &(
s
->
glob®_kby‹s_³r_£cÚd
);

276 
cv
[26].
de¡š©iÚ
 = &(
s
->
kby‹s_³r_£cÚd
);

277 
cv
[27].
de¡š©iÚ
 = &(
s
->
u£_x©Œ
);

278 
cv
[28].
de¡š©iÚ
 = 
s
->
mim‘y³s
;

279 
cv
[29].
de¡š©iÚ
 = 
s
->
s¦_³mfe
;

281 
cv
[30].
de¡š©iÚ
 = &(
s
->
s¦_’abËd
);

282 
cv
[31].
de¡š©iÚ
 = &(
s
->
log_fe_nÙ_found
);

283 
cv
[32].
de¡š©iÚ
 = &(
s
->
log_»que¡_hªdlšg
);

284 
cv
[33].
de¡š©iÚ
 = &(
s
->
log_»¥Ú£_h—d”
);

285 
cv
[34].
de¡š©iÚ
 = &(
s
->
log_»que¡_h—d”
);

286 
cv
[35].
de¡š©iÚ
 = &(
s
->
log_s¦_noi£
);

287 
cv
[36].
de¡š©iÚ
 = &(
s
->
®low_h‰p11
);

288 
cv
[39].
de¡š©iÚ
 = 
s
->
s¦_ÿ_fe
;

290 
cv
[41].
de¡š©iÚ
 = &(
s
->
¿nge_»que¡s
);

291 
cv
[47].
de¡š©iÚ
 = 
s
->
s¦_ch”_li¡
;

292 
cv
[48].
de¡š©iÚ
 = &(
s
->
s¦_u£_s¦v2
);

293 
cv
[49].
de¡š©iÚ
 = &(
s
->
‘ag_u£_šode
);

295 
cv
[50].
de¡š©iÚ
 = &(
s
->
‘ag_u£_mtime
);

296 
cv
[51].
de¡š©iÚ
 = &(
s
->
‘ag_u£_size
);

297 
cv
[53].
de¡š©iÚ
 = &(
s
->
log_timeouts
);

298 
cv
[54].
de¡š©iÚ
 = &(
s
->
deãr_acû±
);

299 
cv
[56].
de¡š©iÚ
 = &(
s
->
s¦_v”ifyş›Á
);

300 
cv
[57].
de¡š©iÚ
 = &(
s
->
s¦_v”ifyş›Á_’fÜû
);

301 
cv
[58].
de¡š©iÚ
 = &(
s
->
s¦_v”ifyş›Á_d•th
);

302 
cv
[59].
de¡š©iÚ
 = 
s
->
s¦_v”ifyş›Á_u£ºame
;

304 
cv
[60].
de¡š©iÚ
 = &(
s
->
s¦_v”ifyş›Á_expÜt_û¹
);

305 
cv
[61].
de¡š©iÚ
 = &(
s
->
£t_v6Úly
);

306 
cv
[62].
de¡š©iÚ
 = &(
s
->
s¦_u£_s¦v3
);

307 
cv
[63].
de¡š©iÚ
 = 
s
->
s¦_dh_fe
;

308 
cv
[64].
de¡š©iÚ
 = 
s
->
s¦_ec_curve
;

309 
cv
[65].
de¡š©iÚ
 = &(
s
->
s¦_di§bË_ş›Á_»ÃgÙŸtiÚ
);

310 
cv
[66].
de¡š©iÚ
 = &(
s
->
s¦_hÚÜ_ch”_Üd”
);

311 
cv
[67].
de¡š©iÚ
 = &(
s
->
s¦_em±y_äagm’ts
);

312 
cv
[70].
de¡š©iÚ
 = &(
s
->
li¡’_backlog
);

313 
cv
[71].
de¡š©iÚ
 = 
s
->
”rÜ_hªdËr_404
;

314 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
) \

315 || 
	`defšed
(
__O³nBSD__
è|| defšed(
__D¿gÚFly__
)

316 
cv
[75].
de¡š©iÚ
 = 
s
->
bsd_acû±_f‹r
;

318 
cv
[76].
de¡š©iÚ
 = &(
s
->
¡»am_»que¡_body
);

319 
cv
[77].
de¡š©iÚ
 = &(
s
->
¡»am_»¥Ú£_body
);

320 
cv
[79].
de¡š©iÚ
 = &(
s
->
s¦_»ad_ah—d
);

322 
¤v
->
cÚfig_¡Üage
[
i
] = 
s
;

324 ià(0 !ğ(
»t
 = 
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
))) {

328 ià(
s
->
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_BUFMIN
) {

329 
s
->
¡»am_»que¡_body
 |ğ
FDEVENT_STREAM_REQUEST
;

331 ià(
s
->
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
) {

332 
s
->
¡»am_»¥Ú£_body
 |ğ
FDEVENT_STREAM_RESPONSE
;

337 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[0];

338 
s
->
h‰p_·r£İts
=

339 (
¤v
->
¤vcÚf
.
h‰p_h—d”_¡riù
 ?(
HTTP_PARSEOPT_HEADER_STRICT
) :0)

340 |(
¤v
->
¤vcÚf
.
h‰p_ho¡_¡riù
 ?(
HTTP_PARSEOPT_HOST_STRICT


341 |
HTTP_PARSEOPT_HOST_NORMALIZE
):0)

342 |(
¤v
->
¤vcÚf
.
h‰p_ho¡_nÜm®ize
 ?(
HTTP_PARSEOPT_HOST_NORMALIZE
):0);

345 ià(
	`bufãr_¡ršg_is_em±y
(
¡©_ÿche_¡ršg
)) {

346 
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 = 
STAT_CACHE_ENGINE_SIMPLE
;

347 } ià(
	`bufãr_is_equ®_¡ršg
(
¡©_ÿche_¡ršg
, 
	`CONST_STR_LEN
("simple"))) {

348 
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 = 
STAT_CACHE_ENGINE_SIMPLE
;

349 #ifdeà
HAVE_FAM_H


350 } ià(
	`bufãr_is_equ®_¡ršg
(
¡©_ÿche_¡ršg
, 
	`CONST_STR_LEN
("fam"))) {

351 
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 = 
STAT_CACHE_ENGINE_FAM
;

353 } ià(
	`bufãr_is_equ®_¡ršg
(
¡©_ÿche_¡ršg
, 
	`CONST_STR_LEN
("disable"))) {

354 
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 = 
STAT_CACHE_ENGINE_NONE
;

356 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

358 #ifdeà
HAVE_FAM_H


361 " buˆnÙ:", 
¡©_ÿche_¡ršg
);

362 
»t
 = 
HANDLER_ERROR
;

365 
	`bufãr_ä“
(
¡©_ÿche_¡ršg
);

368 
d©a_¡ršg
 *
ds
;

369 
´•’d_mod_šdexfe
 = 1;

370 
­³nd_mod_dœli¡šg
 = 1;

371 
­³nd_mod_¡©icfe
 = 1;

372 
­³nd_mod_authn_fe
 = 1;

373 
­³nd_mod_authn_ld­
 = 1;

374 
­³nd_mod_authn_mysql
 = 1;

375 
cÚšs_mod_auth
 = 0;

378 
i
 = 0; i < 
¤v
->
¤vcÚf
.
moduËs
->
u£d
; i++) {

379 
ds
 = (
d©a_¡ršg
 *)
¤v
->
¤vcÚf
.
moduËs
->
d©a
[
i
];

381 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_indexfile"))) {

382 
´•’d_mod_šdexfe
 = 0;

385 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_staticfile"))) {

386 
­³nd_mod_¡©icfe
 = 0;

389 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_dirlisting"))) {

390 
­³nd_mod_dœli¡šg
 = 0;

393 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_authn_file"))) {

394 
­³nd_mod_authn_fe
 = 0;

397 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_authn_ldap"))) {

398 
­³nd_mod_authn_ld­
 = 0;

401 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_authn_mysql"))) {

402 
­³nd_mod_authn_mysql
 = 0;

405 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_auth"))) {

406 
cÚšs_mod_auth
 = 1;

409 ià(0 =ğ
´•’d_mod_šdexfe
 &&

410 0 =ğ
­³nd_mod_dœli¡šg
 &&

411 0 =ğ
­³nd_mod_¡©icfe
 &&

412 0 =ğ
­³nd_mod_authn_fe
 &&

413 0 =ğ
­³nd_mod_authn_ld­
 &&

414 0 =ğ
­³nd_mod_authn_mysql
 &&

415 1 =ğ
cÚšs_mod_auth
) {

420 ià(
´•’d_mod_šdexfe
) {

422 
¬¿y
 *
moduËs
 = 
	`¬¿y_š™
();

424 
ds
 = 
	`d©a_¡ršg_š™
();

425 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_indexfile"));

426 
	`¬¿y_š£¹_unique
(
moduËs
, (
d©a_un£t
 *)
ds
);

428 
i
 = 0; i < 
¤v
->
¤vcÚf
.
moduËs
->
u£d
; i++) {

429 
d©a_un£t
 *
du
 = 
¤v
->
¤vcÚf
.
moduËs
->
d©a
[
i
];

430 
	`¬¿y_š£¹_unique
(
moduËs
, 
du
->
	`cİy
(du));

433 
	`¬¿y_ä“
(
¤v
->
¤vcÚf
.
moduËs
);

434 
¤v
->
¤vcÚf
.
moduËs
 = modules;

438 ià(
­³nd_mod_dœli¡šg
) {

439 
ds
 = 
	`d©a_¡ršg_š™
();

440 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_dirlisting"));

441 
	`¬¿y_š£¹_unique
(
¤v
->
¤vcÚf
.
moduËs
, (
d©a_un£t
 *)
ds
);

444 ià(
­³nd_mod_¡©icfe
) {

445 
ds
 = 
	`d©a_¡ršg_š™
();

446 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_staticfile"));

447 
	`¬¿y_š£¹_unique
(
¤v
->
¤vcÚf
.
moduËs
, (
d©a_un£t
 *)
ds
);

453 ià(
cÚšs_mod_auth
) {

454 ià(
­³nd_mod_authn_fe
) {

455 
ds
 = 
	`d©a_¡ršg_š™
();

456 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("mod_authn_file"));

457 
	`¬¿y_š£¹_unique
(
¤v
->
¤vcÚf
.
moduËs
, (
d©a_un£t
 *)
ds
);

459 ià(
­³nd_mod_authn_ld­
) {

460 #ià
	`defšed
(
HAVE_LDAP_H
è&& defšed(
HAVE_LBER_H
è&& defšed(
HAVE_LIBLDAP
è&& defšed(
HAVE_LIBLBER
)

461 
	`cÚfig_w¬n_authn_moduË
(
¤v
, "ldap");

464 ià(
­³nd_mod_authn_mysql
) {

465 #ià
	`defšed
(
HAVE_MYSQL
)

466 
	`cÚfig_w¬n_authn_moduË
(
¤v
, "mysql");

472  
»t
;

474 
	}
}

477 
	#PATCH
(
x
è
cÚ
->
cÚf
.x = 
s
->
	)
x

478 
	$cÚfig_£tup_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

479 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[0];

481 
	`PATCH
(
h‰p_·r£İts
);

483 
	`PATCH
(
®low_h‰p11
);

484 
	`PATCH
(
mim‘y³s
);

485 
	`PATCH
(
docum’t_roÙ
);

486 
	`PATCH
(
high_´ecisiÚ_time¡amps
);

487 
	`PATCH
(
max_k“p_®ive_»que¡s
);

488 
	`PATCH
(
max_k“p_®ive_idË
);

489 
	`PATCH
(
max_»ad_idË
);

490 
	`PATCH
(
max_wr™e_idË
);

491 
	`PATCH
(
max_»que¡_size
);

492 
	`PATCH
(
u£_x©Œ
);

493 
	`PATCH
(
”rÜ_hªdËr
);

494 
	`PATCH
(
”rÜ_hªdËr_404
);

495 
	`PATCH
(
”rÜfe_´efix
);

496 #ifdeà
HAVE_LSTAT


497 
	`PATCH
(
fŞlow_symlšk
);

499 
	`PATCH
(
£rv”_g
);

500 
	`PATCH
(
kby‹s_³r_£cÚd
);

501 
	`PATCH
(
glob®_kby‹s_³r_£cÚd
);

502 
	`PATCH
(
glob®_by‹s_³r_£cÚd_út
);

504 
cÚ
->
cÚf
.
glob®_by‹s_³r_£cÚd_út_±r
 = &
s
->
glob®_by‹s_³r_£cÚd_út
;

505 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, 
s
->server_name);

507 
	`PATCH
(
log_»que¡_h—d”
);

508 
	`PATCH
(
log_»¥Ú£_h—d”
);

509 
	`PATCH
(
log_»que¡_hªdlšg
);

510 
	`PATCH
(
log_cÚd™iÚ_hªdlšg
);

511 
	`PATCH
(
log_fe_nÙ_found
);

512 
	`PATCH
(
log_s¦_noi£
);

513 
	`PATCH
(
log_timeouts
);

515 
	`PATCH
(
¿nge_»que¡s
);

516 
	`PATCH
(
fÜû_low”ÿ£_f’ames
);

518 
	`PATCH
(
¡»am_»que¡_body
);

519 
	`PATCH
(
¡»am_»¥Ú£_body
);

521 
	`PATCH
(
s¦_’abËd
);

523 
	`PATCH
(
s¦_³mfe
);

524 #ifdeà
USE_OPENSSL


525 
	`PATCH
(
s¦_³mfe_x509
);

526 
	`PATCH
(
s¦_³mfe_pkey
);

528 
	`PATCH
(
s¦_ÿ_fe
);

529 #ifdeà
USE_OPENSSL


530 
	`PATCH
(
s¦_ÿ_fe_û¹_Çmes
);

532 
	`PATCH
(
s¦_ch”_li¡
);

533 
	`PATCH
(
s¦_dh_fe
);

534 
	`PATCH
(
s¦_ec_curve
);

535 
	`PATCH
(
s¦_hÚÜ_ch”_Üd”
);

536 
	`PATCH
(
s¦_em±y_äagm’ts
);

537 
	`PATCH
(
s¦_u£_s¦v2
);

538 
	`PATCH
(
s¦_u£_s¦v3
);

539 
	`PATCH
(
‘ag_u£_šode
);

540 
	`PATCH
(
‘ag_u£_mtime
);

541 
	`PATCH
(
‘ag_u£_size
);

543 
	`PATCH
(
s¦_v”ifyş›Á
);

544 
	`PATCH
(
s¦_v”ifyş›Á_’fÜû
);

545 
	`PATCH
(
s¦_v”ifyş›Á_d•th
);

546 
	`PATCH
(
s¦_v”ifyş›Á_u£ºame
);

547 
	`PATCH
(
s¦_v”ifyş›Á_expÜt_û¹
);

548 
	`PATCH
(
s¦_di§bË_ş›Á_»ÃgÙŸtiÚ
);

549 
	`PATCH
(
s¦_»ad_ah—d
);

552 
	}
}

554 
	$cÚfig_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

555 
size_t
 
i
, 
j
;

558 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

559 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

560 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[
i
];

563 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

566 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

567 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

569 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.document-root"))) {

570 
	`PATCH
(
docum’t_roÙ
);

571 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.range-requests"))) {

572 
	`PATCH
(
¿nge_»que¡s
);

573 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.error-handler"))) {

574 
	`PATCH
(
”rÜ_hªdËr
);

575 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.error-handler-404"))) {

576 
	`PATCH
(
”rÜ_hªdËr_404
);

577 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.errorfile-prefix"))) {

578 
	`PATCH
(
”rÜfe_´efix
);

579 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("mimetype.assign"))) {

580 
	`PATCH
(
mim‘y³s
);

581 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.max-keep-alive-requests"))) {

582 
	`PATCH
(
max_k“p_®ive_»que¡s
);

583 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.max-keep-alive-idle"))) {

584 
	`PATCH
(
max_k“p_®ive_idË
);

585 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.max-write-idle"))) {

586 
	`PATCH
(
max_wr™e_idË
);

587 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.max-read-idle"))) {

588 
	`PATCH
(
max_»ad_idË
);

589 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.max-request-size"))) {

590 
	`PATCH
(
max_»que¡_size
);

591 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("mimetype.use-xattr"))) {

592 
	`PATCH
(
u£_x©Œ
);

593 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("etag.use-inode"))) {

594 
	`PATCH
(
‘ag_u£_šode
);

595 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("etag.use-mtime"))) {

596 
	`PATCH
(
‘ag_u£_mtime
);

597 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("etag.use-size"))) {

598 
	`PATCH
(
‘ag_u£_size
);

599 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.pemfile"))) {

600 
	`PATCH
(
s¦_³mfe
);

601 #ifdeà
USE_OPENSSL


602 
	`PATCH
(
s¦_³mfe_x509
);

603 
	`PATCH
(
s¦_³mfe_pkey
);

605 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.ca-file"))) {

606 
	`PATCH
(
s¦_ÿ_fe
);

607 #ifdeà
USE_OPENSSL


608 
	`PATCH
(
s¦_ÿ_fe_û¹_Çmes
);

610 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.honor-cipher-order"))) {

611 
	`PATCH
(
s¦_hÚÜ_ch”_Üd”
);

612 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.empty-fragments"))) {

613 
	`PATCH
(
s¦_em±y_äagm’ts
);

614 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.use-sslv2"))) {

615 
	`PATCH
(
s¦_u£_s¦v2
);

616 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.use-sslv3"))) {

617 
	`PATCH
(
s¦_u£_s¦v3
);

618 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.cipher-list"))) {

619 
	`PATCH
(
s¦_ch”_li¡
);

620 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.engine"))) {

621 
	`PATCH
(
s¦_’abËd
);

622 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.dh-file"))) {

623 
	`PATCH
(
s¦_dh_fe
);

624 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.ec-curve"))) {

625 
	`PATCH
(
s¦_ec_curve
);

626 #ifdeà
HAVE_LSTAT


627 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.follow-symlink"))) {

628 
	`PATCH
(
fŞlow_symlšk
);

630 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.name"))) {

631 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, 
s
->server_name);

632 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.tag"))) {

633 
	`PATCH
(
£rv”_g
);

634 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.stream-request-body"))) {

635 
	`PATCH
(
¡»am_»que¡_body
);

636 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.stream-response-body"))) {

637 
	`PATCH
(
¡»am_»¥Ú£_body
);

638 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("connection.kbytes-per-second"))) {

639 
	`PATCH
(
kby‹s_³r_£cÚd
);

640 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-request-handling"))) {

641 
	`PATCH
(
log_»que¡_hªdlšg
);

642 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-request-header"))) {

643 
	`PATCH
(
log_»que¡_h—d”
);

644 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-response-header"))) {

645 
	`PATCH
(
log_»¥Ú£_h—d”
);

646 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-condition-handling"))) {

647 
	`PATCH
(
log_cÚd™iÚ_hªdlšg
);

648 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-file-not-found"))) {

649 
	`PATCH
(
log_fe_nÙ_found
);

650 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-ssl-noise"))) {

651 
	`PATCH
(
log_s¦_noi£
);

652 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("debug.log-timeouts"))) {

653 
	`PATCH
(
log_timeouts
);

654 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.protocol-http11"))) {

655 
	`PATCH
(
®low_h‰p11
);

656 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.force-lowercase-filenames"))) {

657 
	`PATCH
(
fÜû_low”ÿ£_f’ames
);

659 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.listen-backlog"))) {

660 
	`PATCH
(
li¡’_backlog
);

662 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.kbytes-per-second"))) {

663 
	`PATCH
(
glob®_kby‹s_³r_£cÚd
);

664 
	`PATCH
(
glob®_by‹s_³r_£cÚd_út
);

665 
cÚ
->
cÚf
.
glob®_by‹s_³r_£cÚd_út_±r
 = &
s
->
glob®_by‹s_³r_£cÚd_út
;

666 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.verifyclient.activate"))) {

667 
	`PATCH
(
s¦_v”ifyş›Á
);

668 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.verifyclient.enforce"))) {

669 
	`PATCH
(
s¦_v”ifyş›Á_’fÜû
);

670 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.verifyclient.depth"))) {

671 
	`PATCH
(
s¦_v”ifyş›Á_d•th
);

672 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.verifyclient.username"))) {

673 
	`PATCH
(
s¦_v”ifyş›Á_u£ºame
);

674 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.verifyclient.exportcert"))) {

675 
	`PATCH
(
s¦_v”ifyş›Á_expÜt_û¹
);

676 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.disable-client-renegotiation"))) {

677 
	`PATCH
(
s¦_di§bË_ş›Á_»ÃgÙŸtiÚ
);

678 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssl.read-ahead"))) {

679 
	`PATCH
(
s¦_»ad_ah—d
);

684 
cÚ
->
‘ag_æags
 = (cÚ->
cÚf
.
‘ag_u£_mtime
 ? 
ETAG_USE_MTIME
 : 0) |

685 (
cÚ
->
cÚf
.
‘ag_u£_šode
 ? 
ETAG_USE_INODE
 : 0) |

686 (
cÚ
->
cÚf
.
‘ag_u£_size
 ? 
ETAG_USE_SIZE
 : 0);

689 
	}
}

690 #undeà
PATCH


693 
	mfoo
;

694 
	mb¬
;

696 cÚ¡ 
bufãr
 *
	msourû
;

697 cÚ¡ *
	mšput
;

698 
size_t
 
	moff£t
;

699 
size_t
 
	msize
;

701 
	mlše_pos
;

702 
	mlše
;

704 
	mš_key
;

705 
	mš_b¿û
;

706 
	mš_cÚd
;

707 } 
	ttok’iz”_t
;

710 
	$tok’iz”_İ’
(
£rv”
 *
¤v
, 
tok’iz”_t
 *
t
, 
bufãr
 *
ba£dœ
, cÚ¡ *
â
) {

711 ià(
	`bufãr_¡ršg_is_em±y
(
ba£dœ
) ||

712 (
â
[0] == '/' || fn[0] == '\\') ||

713 (
â
[0] == '.' && (fn[1] == '/' || fn[1] == '\\'))) {

714 
t
->
fe
 = 
	`bufãr_š™_¡ršg
(
â
);

716 
t
->
fe
 = 
	`bufãr_š™_bufãr
(
ba£dœ
);

717 
	`bufãr_­³nd_¡ršg
(
t
->
fe
, 
â
);

720 ià(0 !ğ
	`¡»am_İ’
(&(
t
->
s
),->
fe
)) {

721 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

722 "İ’šg cÚfigf", 
t
->
fe
, "çed:", 
	`¡»¼Ü
(
”ºo
));

723 
	`bufãr_ä“
(
t
->
fe
);

727 
t
->
šput
 =->
s
.
¡¬t
;

728 
t
->
off£t
 = 0;

729 
t
->
size
 =->
s
.size;

730 
t
->
lše
 = 1;

731 
t
->
lše_pos
 = 1;

733 
t
->
š_key
 = 1;

734 
t
->
š_b¿û
 = 0;

735 
t
->
š_cÚd
 = 0;

737 
	}
}

739 
	$tok’iz”_şo£
(
£rv”
 *
¤v
, 
tok’iz”_t
 *
t
) {

740 
	`UNUSED
(
¤v
);

742 
	`bufãr_ä“
(
t
->
fe
);

743  
	`¡»am_şo£
(&(
t
->
s
));

744 
	}
}

746 
	$cÚfig_sk_Ãwlše
(
tok’iz”_t
 *
t
) {

747 
sk³d
 = 1;

748 
	`fÜû_as£¹
(
t
->
šput
[t->
off£t
] == '\r' ||->input[t->offset] == '\n');

749 ià(
t
->
šput
[t->
off£t
] == '\r' &&->input[t->offset + 1] == '\n') {

750 
sk³d
 ++;

751 
t
->
off£t
 ++;

753 
t
->
off£t
 ++;

754  
sk³d
;

755 
	}
}

757 
	$cÚfig_sk_comm’t
(
tok’iz”_t
 *
t
) {

758 
i
;

759 
	`fÜû_as£¹
(
t
->
šput
[t->
off£t
] == '#');

760 
i
 = 1; 
t
->
šput
[t->
off£t
 + i] &&

761 (
t
->
šput
[t->
off£t
 + 
i
] != '\n' &&->input[t->offset + i] != '\r');

762 
i
++);

763 
t
->
off£t
 +ğ
i
;

764  
i
;

765 
	}
}

767 
	$cÚfig_tok’iz”
(
£rv”
 *
¤v
, 
tok’iz”_t
 *
t
, *
tok’_id
, 
bufãr
 *
tok’
) {

768 
tid
 = 0;

769 
size_t
 
i
;

771 
tid
 = 0;id =ğ0 && 
t
->
off£t
 <->
size
 &&->
šput
[t->offset] ; ) {

772 
c
 = 
t
->
šput
[t->
off£t
];

773 cÚ¡ *
¡¬t
 = 
NULL
;

775 
c
) {

777 ià(
t
->
š_b¿û
) {

778 ià(
t
->
šput
[t->
off£t
 + 1] == '>') {

779 
t
->
off£t
 += 2;

781 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("=>"));

783 
tid
 = 
TK_ARRAY_ASSIGN
;

785 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

786 "sourû:", 
t
->
sourû
,

787 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

791 } ià(
t
->
š_cÚd
) {

792 ià(
t
->
šput
[t->
off£t
 + 1] == '=') {

793 
t
->
off£t
 += 2;

795 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("=="));

797 
tid
 = 
TK_EQ
;

798 } ià(
t
->
šput
[t->
off£t
 + 1] == '~') {

799 
t
->
off£t
 += 2;

801 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("=~"));

803 
tid
 = 
TK_MATCH
;

805 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

806 "sourû:", 
t
->
sourû
,

807 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

811 
t
->
š_key
 = 1;

812 
t
->
š_cÚd
 = 0;

813 } ià(
t
->
š_key
) {

814 
tid
 = 
TK_ASSIGN
;

816 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
, 1);

818 
t
->
off£t
++;

819 
t
->
lše_pos
++;

821 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

822 "sourû:", 
t
->
sourû
,

823 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

830 ià(
t
->
š_cÚd
) {

831 ià(
t
->
šput
[t->
off£t
 + 1] == '=') {

832 
t
->
off£t
 += 2;

834 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("!="));

836 
tid
 = 
TK_NE
;

837 } ià(
t
->
šput
[t->
off£t
 + 1] == '~') {

838 
t
->
off£t
 += 2;

840 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("!~"));

842 
tid
 = 
TK_NOMATCH
;

844 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

845 "sourû:", 
t
->
sourû
,

846 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

850 
t
->
š_key
 = 1;

851 
t
->
š_cÚd
 = 0;

853 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

854 "sourû:", 
t
->
sourû
,

855 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

863 
t
->
off£t
++;

864 
t
->
lše_pos
++;

868 ià(
t
->
š_b¿û
 == 0) {

869 
dÚe
 = 0;

870 !
dÚe
 && 
t
->
off£t
 <->
size
) {

871 
t
->
šput
[t->
off£t
]) {

874 
	`cÚfig_sk_Ãwlše
(
t
);

875 
t
->
lše_pos
 = 1;

876 
t
->
lše
++;

880 
t
->
lše_pos
 +ğ
	`cÚfig_sk_comm’t
(t);

885 
t
->
off£t
++;

886 
t
->
lše_pos
++;

890 
dÚe
 = 1;

893 
t
->
š_key
 = 1;

894 
tid
 = 
TK_EOL
;

895 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(EOL)"));

897 
	`cÚfig_sk_Ãwlše
(
t
);

898 
t
->
lše_pos
 = 1;

899 
t
->
lše
++;

903 ià(
t
->
š_b¿û
 > 0) {

904 
tid
 = 
TK_COMMA
;

906 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(COMMA)"));

909 
t
->
off£t
++;

910 
t
->
lše_pos
++;

914 
¡¬t
 = 
t
->
šput
 +->
off£t
 + 1;

915 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
(""));

917 
i
 = 1; 
t
->
šput
[t->
off£t
 + i]; i++) {

918 ià(
t
->
šput
[t->
off£t
 + 
i
] == '\\' &&

919 
t
->
šput
[t->
off£t
 + 
i
 + 1] == '"') {

921 
	`bufãr_­³nd_¡ršg_Ën
(
tok’
, 
¡¬t
, 
t
->
šput
 +->
off£t
 + 
i
 - start);

923 
¡¬t
 = 
t
->
šput
 +->
off£t
 + 
i
 + 1;

926 
i
++;

931 ià(
t
->
šput
[t->
off£t
 + 
i
] == '"') {

932 
tid
 = 
TK_STRING
;

934 
	`bufãr_­³nd_¡ršg_Ën
(
tok’
, 
¡¬t
, 
t
->
šput
 +->
off£t
 + 
i
 - start);

940 ià(
t
->
šput
[t->
off£t
 + 
i
] == '\0') {

943 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

944 "sourû:", 
t
->
sourû
,

945 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

951 
t
->
off£t
 +ğ
i
 + 1;

952 
t
->
lše_pos
 +ğ
i
 + 1;

956 
t
->
off£t
++;

957 
t
->
š_b¿û
++;

959 
tid
 = 
TK_LPARAN
;

961 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("("));

964 
t
->
off£t
++;

965 
t
->
š_b¿û
--;

967 
tid
 = 
TK_RPARAN
;

969 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
(")"));

972 
t
->
off£t
++;

974 
tid
 = 
TK_DOLLAR
;

975 
t
->
š_cÚd
 = 1;

976 
t
->
š_key
 = 0;

978 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("$"));

983 ià(
t
->
šput
[t->
off£t
 + 1] == '=') {

984 
t
->
off£t
 += 2;

985 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("+="));

986 
tid
 = 
TK_APPEND
;

988 
t
->
off£t
++;

989 
tid
 = 
TK_PLUS
;

990 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("+"));

995 
t
->
off£t
++;

997 
tid
 = 
TK_LCURLY
;

999 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("{"));

1004 
t
->
off£t
++;

1006 
tid
 = 
TK_RCURLY
;

1008 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("}"));

1013 
t
->
off£t
++;

1015 
tid
 = 
TK_LBRACKET
;

1017 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("["));

1022 
t
->
off£t
++;

1024 
tid
 = 
TK_RBRACKET
;

1026 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("]"));

1030 
t
->
lše_pos
 +ğ
	`cÚfig_sk_comm’t
(t);

1034 ià(
t
->
š_cÚd
) {

1035 
i
 = 0; 
t
->
šput
[t->
off£t
 + i] &&

1036 (
	`i§Íha
(()
t
->
šput
[t->
off£t
 + 
i
])

1037 ); 
i
++);

1039 ià(
i
 && 
t
->
šput
[t->
off£t
 + i]) {

1040 
tid
 = 
TK_SRVVARNAME
;

1041 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
, 
i
);

1043 
t
->
off£t
 +ğ
i
;

1044 
t
->
lše_pos
 +ğ
i
;

1047 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

1048 "sourû:", 
t
->
sourû
,

1049 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

1053 } ià(
	`isdig™
(()
c
)) {

1055 
i
 = 0; 
t
->
šput
[t->
off£t
 + i] && 
	`isdig™
(()t->input[t->offset + i]); i++);

1058 ià(
i
) {

1059 
tid
 = 
TK_INTEGER
;

1061 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
, 
i
);

1063 
t
->
off£t
 +ğ
i
;

1064 
t
->
lše_pos
 +ğ
i
;

1068 
i
 = 0; 
t
->
šput
[t->
off£t
 + i] &&

1069 (
	`i§Êum
(()
t
->
šput
[t->
off£t
 + 
i
]) ||

1070 
t
->
šput
[t->
off£t
 + 
i
] == '.' ||

1071 
t
->
šput
[t->
off£t
 + 
i
] == '_' ||

1072 
t
->
šput
[t->
off£t
 + 
i
] == '-'

1073 ); 
i
++);

1075 ià(
i
 && 
t
->
šput
[t->
off£t
 + i]) {

1076 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
, 
i
);

1078 ià(
	`¡rcmp
(
tok’
->
±r
, "include") == 0) {

1079 
tid
 = 
TK_INCLUDE
;

1080 } ià(
	`¡rcmp
(
tok’
->
±r
, "include_shell") == 0) {

1081 
tid
 = 
TK_INCLUDE_SHELL
;

1082 } ià(
	`¡rcmp
(
tok’
->
±r
, "global") == 0) {

1083 
tid
 = 
TK_GLOBAL
;

1084 } ià(
	`¡rcmp
(
tok’
->
±r
, "else") == 0) {

1085 
tid
 = 
TK_ELSE
;

1087 
tid
 = 
TK_LKEY
;

1090 
t
->
off£t
 +ğ
i
;

1091 
t
->
lše_pos
 +ğ
i
;

1094 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsds",

1095 "sourû:", 
t
->
sourû
,

1096 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

1105 ià(
tid
) {

1106 *
tok’_id
 = 
tid
;

1108 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsdbdd",

1109 "sourû:", 
t
->
sourû
,

1110 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

1111 
tok’
,ok’->
u£d
 - 1, 
tid
);

1115 } ià(
t
->
off£t
 <->
size
) {

1116 
	`årštf
(
¡d”r
, "%s.%d: %d, %s\n",

1117 
__FILE__
, 
__LINE__
,

1118 
tid
, 
tok’
->
±r
);

1121 
	}
}

1123 
	$cÚfig_·r£
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
, 
tok’iz”_t
 *
t
) {

1124 *
pP¬£r
;

1125 
tok’_id
;

1126 
bufãr
 *
tok’
, *
Ï¡tok’
;

1127 
»t
;

1129 
pP¬£r
 = 
	`cÚfig·r£rAÎoc
Ğ
m®loc
 );

1130 
	`fÜû_as£¹
(
pP¬£r
);

1131 
Ï¡tok’
 = 
	`bufãr_š™
();

1132 
tok’
 = 
	`bufãr_š™
();

1133 (1 =ğ(
»t
 = 
	`cÚfig_tok’iz”
(
¤v
, 
t
, &
tok’_id
, 
tok’
))è&& 
cÚ‹xt
->
ok
) {

1134 
	`bufãr_cİy_bufãr
(
Ï¡tok’
, 
tok’
);

1135 
	`cÚfig·r£r
(
pP¬£r
, 
tok’_id
, 
tok’
, 
cÚ‹xt
);

1137 
tok’
 = 
	`bufãr_š™
();

1139 
	`bufãr_ä“
(
tok’
);

1141 ià(
»t
 !ğ-1 && 
cÚ‹xt
->
ok
) {

1143 
	`cÚfig·r£r
(
pP¬£r
, 
TK_EOL
, 
	`bufãr_š™_¡ršg
("(EOL)"), 
cÚ‹xt
);

1144 ià(
cÚ‹xt
->
ok
) {

1145 
	`cÚfig·r£r
(
pP¬£r
, 0, 
NULL
, 
cÚ‹xt
);

1148 
	`cÚfig·r£rF»e
(
pP¬£r
, 
ä“
);

1150 ià(
»t
 == -1) {

1151 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1152 "cÚfigf·r£¸çed‡t:", 
Ï¡tok’
);

1153 } ià(
cÚ‹xt
->
ok
 == 0) {

1154 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsdsb",

1155 "sourû:", 
t
->
sourû
,

1156 "lše:", 
t
->
lše
, "pos:",->
lše_pos
,

1157 "·r£¸çed somehow‚—¸h”e:", 
Ï¡tok’
);

1158 
»t
 = -1;

1160 
	`bufãr_ä“
(
Ï¡tok’
);

1162  
»t
 == -1 ? -1 : 0;

1163 
	}
}

1165 
	$tok’iz”_š™
(
tok’iz”_t
 *
t
, cÚ¡ 
bufãr
 *
sourû
, cÚ¡ *
šput
, 
size_t
 
size
) {

1167 
t
->
sourû
 = source;

1168 
t
->
šput
 = input;

1169 
t
->
size
 = size;

1170 
t
->
off£t
 = 0;

1171 
t
->
lše
 = 1;

1172 
t
->
lše_pos
 = 1;

1174 
t
->
š_key
 = 1;

1175 
t
->
š_b¿û
 = 0;

1176 
t
->
š_cÚd
 = 0;

1178 
	}
}

1180 
	$cÚfig_·r£_fe_¡»am
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
, cÚ¡ 
bufãr
 *
f’ame
) {

1181 
tok’iz”_t
 
t
;

1182 
¡»am
 
s
;

1183 
»t
;

1185 ià(0 !ğ
	`¡»am_İ’
(&
s
, 
f’ame
)) {

1186 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

1187 "İ’šg cÚfigf", 
f’ame
, "çed:", 
	`¡»¼Ü
(
”ºo
));

1190 
	`tok’iz”_š™
(&
t
, 
f’ame
, 
s
.
¡¬t
, s.
size
);

1191 
»t
 = 
	`cÚfig_·r£
(
¤v
, 
cÚ‹xt
, &
t
);

1194 
	`¡»am_şo£
(&
s
);

1195  
»t
;

1196 
	}
}

1198 
	$cÚfig_·r£_fe
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
, cÚ¡ *
â
) {

1199 
bufãr
 *
f’ame
;

1200 
size_t
 
i
;

1201 
»t
 = -1;

1202 #ifdeà
GLOB_BRACE


1203 
æags
 = 
GLOB_BRACE
;

1205 
æags
 = 0;

1207 
glob_t
 
gl
;

1209 ià((
â
[0] == '/' || fn[0] == '\\') ||

1210 (
â
[0] == '.' && (fn[1] == '/' || fn[1] == '\\')) ||

1211 (
â
[0] == '.' && fn[1] == '.' && (fn[2] == '/' || fn[2] == '\\'))) {

1212 
f’ame
 = 
	`bufãr_š™_¡ršg
(
â
);

1214 
f’ame
 = 
	`bufãr_š™_bufãr
(
cÚ‹xt
->
ba£dœ
);

1215 
	`bufãr_­³nd_¡ršg
(
f’ame
, 
â
);

1218 
	`glob
(
f’ame
->
±r
, 
æags
, 
NULL
, &
gl
)) {

1220 
i
 = 0; i < 
gl
.
gl_·thc
; ++i) {

1221 
	`bufãr_cİy_¡ršg
(
f’ame
, 
gl
.
gl_·thv
[
i
]);

1222 
»t
 = 
	`cÚfig_·r£_fe_¡»am
(
¤v
, 
cÚ‹xt
, 
f’ame
);

1223 ià(0 !ğ
»t
) ;

1225 
	`globä“
(&
gl
);

1227 
GLOB_NOMATCH
:

1228 ià(
f’ame
->
±r
[
	`¡rc¥n
(filename->ptr, "*?[]{}")] != '\0') {

1229 
»t
 = 0;

1232 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "šşudfnÙ found: ", 
f’ame
);

1235 
GLOB_ABORTED
:

1236 
GLOB_NOSPACE
:

1237 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "glob()", 
f’ame
, "çed:", 
	`¡»¼Ü
(
”ºo
));

1241 
	`bufãr_ä“
(
f’ame
);

1242  
»t
;

1243 
	}
}

1245 * 
	$g‘CWD
() {

1246 *
s
, *
s1
;

1247 
size_t
 
Ën
;

1248 #ifdeà
PATH_MAX


1249 
Ën
 = 
PATH_MAX
;

1251 
Ën
 = 4096;

1254 
s
 = 
	`m®loc
(
Ën
);

1255 ià(!
s
è 
NULL
;

1256 
NULL
 =ğ
	`g‘cwd
(
s
, 
Ën
)) {

1257 ià(
”ºo
 !ğ
ERANGE
 || 
SSIZE_MAX
 - 
Ën
 <†en) {

1258 
	`ä“
(
s
);

1259  
NULL
;

1261 
Ën
 *= 2;

1262 
s1
 = 
	`»®loc
(
s
, 
Ën
);

1263 ià(!
s1
) {

1264 
	`ä“
(
s
);

1265  
NULL
;

1267 
s
 = 
s1
;

1269  
s
;

1270 
	}
}

1272 
	$cÚfig_·r£_cmd
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
, cÚ¡ *
cmd
) {

1273 
tok’iz”_t
 
t
;

1274 
»t
;

1275 
bufãr
 *
sourû
;

1276 
bufãr
 *
out
;

1277 *
Şdpwd
;

1279 ià(
NULL
 =ğ(
Şdpwd
 = 
	`g‘CWD
())) {

1280 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1281 "ÿÂÙ g‘ cwd", 
	`¡»¼Ü
(
”ºo
));

1285 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ‹xt
->
ba£dœ
)) {

1286 ià(0 !ğ
	`chdœ
(
cÚ‹xt
->
ba£dœ
->
±r
)) {

1287 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1288 "ÿÂÙ chªgdœeùÜyo", 
cÚ‹xt
->
ba£dœ
, 
	`¡»¼Ü
(
”ºo
));

1289 
	`ä“
(
Şdpwd
);

1294 
sourû
 = 
	`bufãr_š™_¡ršg
(
cmd
);

1295 
out
 = 
	`bufãr_š™
();

1297 ià(0 !ğ
	`´oc_İ’_bufãr
(
cmd
, 
NULL
, 
out
, NULL)) {

1298 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

1299 "İ’šg", 
sourû
, "çed:", 
	`¡»¼Ü
(
”ºo
));

1300 
»t
 = -1;

1302 
	`tok’iz”_š™
(&
t
, 
sourû
, 
	`CONST_BUF_LEN
(
out
));

1303 
»t
 = 
	`cÚfig_·r£
(
¤v
, 
cÚ‹xt
, &
t
);

1306 
	`bufãr_ä“
(
sourû
);

1307 
	`bufãr_ä“
(
out
);

1308 ià(0 !ğ
	`chdœ
(
Şdpwd
)) {

1309 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

1310 "ÿÂÙ chªgdœeùÜyo", 
Şdpwd
, 
	`¡»¼Ü
(
”ºo
));

1311 
	`ä“
(
Şdpwd
);

1314 
	`ä“
(
Şdpwd
);

1315  
»t
;

1316 
	}
}

1318 
	$cÚ‹xt_š™
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
) {

1319 
cÚ‹xt
->
¤v
 = srv;

1320 
cÚ‹xt
->
ok
 = 1;

1321 
	`veùÜ_cÚfig_w—k_š™
(&
cÚ‹xt
->
cÚfigs_¡ack
);

1322 
cÚ‹xt
->
ba£dœ
 = 
	`bufãr_š™
();

1323 
	}
}

1325 
	$cÚ‹xt_ä“
(
cÚfig_t
 *
cÚ‹xt
) {

1326 
	`veùÜ_cÚfig_w—k_ş—r
(&
cÚ‹xt
->
cÚfigs_¡ack
);

1327 
	`bufãr_ä“
(
cÚ‹xt
->
ba£dœ
);

1328 
	}
}

1330 
	$cÚfig_»ad
(
£rv”
 *
¤v
, cÚ¡ *
â
) {

1331 
cÚfig_t
 
cÚ‹xt
;

1332 
d©a_cÚfig
 *
dc
;

1333 
d©a_š‹g”
 *
dpid
;

1334 
d©a_¡ršg
 *
dcwd
;

1335 
»t
;

1336 *
pos
;

1337 
bufãr
 *
f’ame
;

1339 
	`cÚ‹xt_š™
(
¤v
, &
cÚ‹xt
);

1340 
cÚ‹xt
.
®l_cÚfigs
 = 
¤v
->
cÚfig_cÚ‹xt
;

1342 #ifdeà
__WIN32


1343 
pos
 = 
	`¡¼chr
(
â
, '\\');

1345 
pos
 = 
	`¡¼chr
(
â
, '/');

1347 ià(
pos
) {

1348 
	`bufãr_cİy_¡ršg_Ën
(
cÚ‹xt
.
ba£dœ
, 
â
, 
pos
 - fn + 1);

1351 
dc
 = 
	`d©a_cÚfig_š™
();

1352 
	`bufãr_cİy_¡ršg_Ën
(
dc
->
key
, 
	`CONST_STR_LEN
("global"));

1354 
	`fÜû_as£¹
(
cÚ‹xt
.
®l_cÚfigs
->
u£d
 == 0);

1355 
dc
->
cÚ‹xt_ndx
 = 
cÚ‹xt
.
®l_cÚfigs
->
u£d
;

1356 
	`¬¿y_š£¹_unique
(
cÚ‹xt
.
®l_cÚfigs
, (
d©a_un£t
 *)
dc
);

1357 
cÚ‹xt
.
cu¼’t
 = 
dc
;

1360 
dpid
 = 
	`d©a_š‹g”_š™
();

1361 
dpid
->
v®ue
 = 
	`g‘pid
();

1362 
	`bufãr_cİy_¡ršg_Ën
(
dpid
->
key
, 
	`CONST_STR_LEN
("var.PID"));

1363 
	`¬¿y_š£¹_unique
(
dc
->
v®ue
, (
d©a_un£t
 *)
dpid
);

1365 
dcwd
 = 
	`d©a_¡ršg_š™
();

1366 
	`bufãr_¡ršg_´•¬e_cİy
(
dcwd
->
v®ue
, 1023);

1367 ià(
NULL
 !ğ
	`g‘cwd
(
dcwd
->
v®ue
->
±r
, dcwd->v®ue->
size
 - 1)) {

1368 
	`bufãr_comm™
(
dcwd
->
v®ue
, 
	`¡¾’
(dcwd->v®ue->
±r
));

1369 
	`bufãr_cİy_¡ršg_Ën
(
dcwd
->
key
, 
	`CONST_STR_LEN
("var.CWD"));

1370 
	`¬¿y_š£¹_unique
(
dc
->
v®ue
, (
d©a_un£t
 *)
dcwd
);

1372 
dcwd
->
	`ä“
((
d©a_un£t
*) dcwd);

1375 
f’ame
 = 
	`bufãr_š™_¡ršg
(
â
);

1376 
»t
 = 
	`cÚfig_·r£_fe_¡»am
(
¤v
, &
cÚ‹xt
, 
f’ame
);

1377 
	`bufãr_ä“
(
f’ame
);

1380 
	`fÜû_as£¹
(!(0 =ğ
»t
 && 
cÚ‹xt
.
ok
 && 0 !ğcÚ‹xt.
cÚfigs_¡ack
.
u£d
));

1381 
	`cÚ‹xt_ä“
(&
cÚ‹xt
);

1383 ià(0 !ğ
»t
) {

1384  
»t
;

1387 ià(0 !ğ
	`cÚfig_š£¹
(
¤v
)) {

1392 
	}
}

1394 
	$cÚfig_£t_deçuÉs
(
£rv”
 *
¤v
) {

1395 
size_t
 
i
;

1396 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[0];

1397 
¡©
 
¡1
, 
¡2
;

1399 
	sev_m­
 { 
fdev’t_hªdËr_t
 
‘
; cÚ¡ *
Çme
; } 
ev’t_hªdËrs
[] =

1404 #ifdeà
USE_LINUX_EPOLL


1405 { 
FDEVENT_HANDLER_LINUX_SYSEPOLL
, "linux-sysepoll" },

1407 #ifdeà
USE_POLL


1408 { 
FDEVENT_HANDLER_POLL
, "poll" },

1410 #ifdeà
USE_SELECT


1411 { 
FDEVENT_HANDLER_SELECT
, "select" },

1413 #ifdeà
USE_LIBEV


1414 { 
FDEVENT_HANDLER_LIBEV
, "libev" },

1416 #ifdeà
USE_SOLARIS_DEVPOLL


1417 { 
FDEVENT_HANDLER_SOLARIS_DEVPOLL
,"solaris-devpoll" },

1419 #ifdeà
USE_SOLARIS_PORT


1420 { 
FDEVENT_HANDLER_SOLARIS_PORT
, "solaris-eventports" },

1422 #ifdeà
USE_FREEBSD_KQUEUE


1423 { 
FDEVENT_HANDLER_FREEBSD_KQUEUE
, "freebsd-kqueue" },

1424 { 
FDEVENT_HANDLER_FREEBSD_KQUEUE
, "kqueue" },

1426 { 
FDEVENT_HANDLER_UNSET
, 
NULL
 }

1429 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
chªg”oÙ
)) {

1430 ià(-1 =ğ
	`¡©
(
¤v
->
¤vcÚf
.
chªg”oÙ
->
±r
, &
¡1
)) {

1431 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1432 "£rv”.chroÙ dÛ¢'ˆexi¡:", 
¤v
->
¤vcÚf
.
chªg”oÙ
);

1435 ià(!
	`S_ISDIR
(
¡1
.
¡_mode
)) {

1436 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1437 "£rv”.chroÙ i¢'ˆ¨dœeùÜy:", 
¤v
->
¤vcÚf
.
chªg”oÙ
);

1442 ià(!
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
->
u£d
) {

1443 
d©a_¡ršg
 *
ds
 = 
	`d©a_¡ršg_š™
();

1444 cÚ¡ *
tmpdœ
 = 
	`g‘’v
("TMPDIR");

1445 ià(
NULL
 =ğ
tmpdœ
)mpdir = "/var/tmp";

1446 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
tmpdœ
);

1447 
	`¬¿y_š£¹_unique
(
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
, (
d©a_un£t
 *)
ds
);

1450 ià(
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
->
u£d
) {

1451 
bufãr
 * cÚ¡ 
b
 = 
¤v
->
tmp_buf
;

1452 
size_t
 
Ën
;

1453 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
chªg”oÙ
)) {

1454 
	`bufãr_cİy_bufãr
(
b
, 
¤v
->
¤vcÚf
.
chªg”oÙ
);

1455 
	`bufãr_­³nd_¦ash
(
b
);

1457 
	`bufãr_»£t
(
b
);

1459 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

1461 
i
 = 0; i < 
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
->
u£d
; ++i) {

1462 cÚ¡ 
d©a_¡ršg
 * cÚ¡ 
ds
 = (d©a_¡ršg *)
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
->
d©a
[
i
];

1463 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 
Ën
);

1464 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
v®ue
);

1465 ià(-1 =ğ
	`¡©
(
b
->
±r
, &
¡1
)) {

1466 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1467 "£rv”.u¶ßd-dœ dÛ¢'ˆexi¡:", 
b
);

1468 } ià(!
	`S_ISDIR
(
¡1
.
¡_mode
)) {

1469 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1470 "£rv”.u¶ßd-dœ i¢'ˆ¨dœeùÜy:", 
b
);

1475 
	`chunkqueue_£t_‹mpdœs_deçuÉ
(

1476 
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
,

1477 
¤v
->
¤vcÚf
.
u¶ßd_‹mp_fe_size
);

1479 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
docum’t_roÙ
)) {

1480 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1486 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
s
->
docum’t_roÙ
);

1488 
	`bufãr_to_low”
(
¤v
->
tmp_buf
);

1490 ià(2 =ğ
s
->
fÜû_low”ÿ£_f’ames
) {

1491 
s
->
fÜû_low”ÿ£_f’ames
 = 0;

1493 ià(0 =ğ
	`¡©
(
¤v
->
tmp_buf
->
±r
, &
¡1
)) {

1494 
is_low”
 = 0;

1496 
is_low”
 = 
	`bufãr_is_equ®
(
¤v
->
tmp_buf
, 
s
->
docum’t_roÙ
);

1499 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
s
->
docum’t_roÙ
);

1501 
	`bufãr_to_uµ”
(
¤v
->
tmp_buf
);

1506 ià(
is_low”
 && 
	`bufãr_is_equ®
(
¤v
->
tmp_buf
, 
s
->
docum’t_roÙ
)) {

1511 
s
->
fÜû_low”ÿ£_f’ames
 = 0;

1512 } ià(0 =ğ
	`¡©
(
¤v
->
tmp_buf
->
±r
, &
¡2
)) {

1518 ià(
¡1
.
¡_šo
 =ğ
¡2
.st_ino) {

1521 
s
->
fÜû_low”ÿ£_f’ames
 = 1;

1527 ià(
¤v
->
¤vcÚf
.
pÜt
 == 0) {

1528 
¤v
->
¤vcÚf
.
pÜt
 = 
s
->
s¦_’abËd
 ? 443 : 80;

1531 ià(
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
ev’t_hªdËr
)) {

1537 
¤v
->
ev’t_hªdËr
 = 
ev’t_hªdËrs
[0].
‘
;

1539 ià(
FDEVENT_HANDLER_UNSET
 =ğ
¤v
->
ev’t_hªdËr
) {

1540 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1550 
i
 = 0; 
ev’t_hªdËrs
[i].
Çme
; i++) {

1551 ià(0 =ğ
	`¡rcmp
(
ev’t_hªdËrs
[
i
].
Çme
, 
¤v
->
¤vcÚf
.
ev’t_hªdËr
->
±r
)) {

1552 
¤v
->
ev’t_hªdËr
 = 
ev’t_hªdËrs
[
i
].
‘
;

1557 ià(
FDEVENT_HANDLER_UNSET
 =ğ
¤v
->
ev’t_hªdËr
) {

1558 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1560 
¤v
->
¤vcÚf
.
ev’t_hªdËr
 );

1566 ià(
s
->
s¦_’abËd
) {

1567 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_³mfe
)) {

1570 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1575 #iâdeà
USE_OPENSSL


1576 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1584 
	}
}

	@configfile.h

1 #iâdeà
_CONFIG_PARSER_H_


2 
	#_CONFIG_PARSER_H_


	)

3 
	~"fœ¡.h
"

5 
	~"¬¿y.h
"

6 
	~"bufãr.h
"

7 
	~"£rv”.h
"

10 
£rv”
 *
	m¤v
;

11 
	mok
;

12 
¬¿y
 *
	m®l_cÚfigs
;

13 
veùÜ_cÚfig_w—k
 
	mcÚfigs_¡ack
;

14 
d©a_cÚfig
 *
	mcu¼’t
;

15 
bufãr
 *
	mba£dœ
;

16 } 
	tcÚfig_t
;

18 *
cÚfig·r£rAÎoc
(*(*
m®locProc
)(
size_t
));

19 
cÚfig·r£rF»e
(*
p
, (*
ä“Proc
)(*));

20 
	`cÚfig·r£r
(*
yyp
, 
yymajÜ
, 
bufãr
 *
yymšÜ
, 
cÚfig_t
 *
ùx
);

21 
	`cÚfig_·r£_fe
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
, cÚ¡ *
â
);

22 
	`cÚfig_·r£_cmd
(
£rv”
 *
¤v
, 
cÚfig_t
 *
cÚ‹xt
, cÚ¡ *
cmd
);

23 
d©a_un£t
 *
	`cÚfig·r£r_m”ge_d©a
(d©a_un£ˆ*
İ1
, cÚ¡ d©a_un£ˆ*
İ2
);

25 
	`cÚfig_£tup_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

26 
	`cÚfig_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

28 
	`cÚfig_cÚd_ÿche_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

29 
	`cÚfig_cÚd_ÿche_»£t_™em
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
comp_key_t
 
™em
);

	@configparser.c

6 
	~"fœ¡.h
"

7 
	~<¡dio.h
>

10 
	~"fœ¡.h
"

11 
	~"cÚfigfe.h
"

12 
	~"bufãr.h
"

13 
	~"¬¿y.h
"

14 
	~"»que¡.h
"

16 
	~<as£¹.h
>

17 
	~<ùy³.h
>

18 
	~<”ºo.h
>

19 
	~<¡dio.h
>

20 
	~<¡ršg.h
>

22 
	$cÚfig·r£r_push
(
cÚfig_t
 *
ùx
, 
d©a_cÚfig
 *
dc
, 
i¢ew
) {

23 ià(
i¢ew
) {

24 
dc
->
cÚ‹xt_ndx
 = 
ùx
->
®l_cÚfigs
->
u£d
;

25 
	`fÜû_as£¹
(
dc
->
cÚ‹xt_ndx
 > 
ùx
->
cu¼’t
->context_ndx);

26 
	`¬¿y_š£¹_unique
(
ùx
->
®l_cÚfigs
, (
d©a_un£t
 *)
dc
);

27 
dc
->
·»Á
 = 
ùx
->
cu¼’t
;

28 
	`veùÜ_cÚfig_w—k_push
(&
dc
->
·»Á
->
chd»n
, dc);

30 ià(
ùx
->
cÚfigs_¡ack
.
u£d
 > 0 && ctx->
cu¼’t
->
cÚ‹xt_ndx
 == 0) {

31 
	`årštf
(
¡d”r
, "Cannot use conditionals inside‡ global { ... } block\n");

32 
	`ex™
(-1);

34 
	`veùÜ_cÚfig_w—k_push
(&
ùx
->
cÚfigs_¡ack
, ctx->
cu¼’t
);

35 
ùx
->
cu¼’t
 = 
dc
;

36 
	}
}

38 
d©a_cÚfig
 *
	$cÚfig·r£r_pİ
(
cÚfig_t
 *
ùx
) {

39 
d©a_cÚfig
 *
Şd
 = 
ùx
->
cu¼’t
;

40 
ùx
->
cu¼’t
 = 
	`veùÜ_cÚfig_w—k_pİ
(&ùx->
cÚfigs_¡ack
);

41  
Şd
;

42 
	}
}

45 
d©a_un£t
 *
	$cÚfig·r£r_g‘_v¬ŸbË
(
cÚfig_t
 *
ùx
, cÚ¡ 
bufãr
 *
key
) {

46 
d©a_un£t
 *
du
;

47 
d©a_cÚfig
 *
dc
;

50 
	`årštf
(
¡d”r
, "g‘ v¬ %s\n", 
key
->
±r
);

52 
dc
 = 
ùx
->
cu¼’t
; dc; døğdc->
·»Á
) {

54 
	`årštf
(
¡d”r
, "g‘ v¬ oÀblock: %s\n", 
dc
->
key
->
±r
);

55 
	`¬¿y_´št
(
dc
->
v®ue
, 0);

57 ià(
NULL
 !ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
dc
->
v®ue
, 
key
->
±r
))) {

58  
du
->
	`cİy
(du);

61  
NULL
;

62 
	}
}

67 
d©a_un£t
 *
	$cÚfig·r£r_m”ge_d©a
(
d©a_un£t
 *
İ1
, cÚ¡ d©a_un£ˆ*
İ2
) {

69 ià(
İ1
->
ty³
 !ğ
İ2
->type) {

70 ià(
İ1
->
ty³
 =ğ
TYPE_STRING
 && 
İ2
->ty³ =ğ
TYPE_INTEGER
) {

71 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
İ1
;

72 
	`bufãr_­³nd_št
(
ds
->
v®ue
, ((
d©a_š‹g”
*)
İ2
)->value);

73  
İ1
;

74 } ià(
İ1
->
ty³
 =ğ
TYPE_INTEGER
 && 
İ2
->ty³ =ğ
TYPE_STRING
) {

75 
d©a_¡ršg
 *
ds
 = 
	`d©a_¡ršg_š™
();

76 
	`bufãr_­³nd_št
(
ds
->
v®ue
, ((
d©a_š‹g”
*)
İ1
)->value);

77 
	`bufãr_­³nd_¡ršg_bufãr
(
ds
->
v®ue
, ((
d©a_¡ršg
*)
İ2
)->value);

78 
İ1
->
	`ä“
(op1);

79  (
d©a_un£t
 *)
ds
;

81 
	`årštf
(
¡d”r
, "dataype mismatch, cannot merge\n");

82 
İ1
->
	`ä“
(op1);

83  
NULL
;

87 
İ1
->
ty³
) {

88 
TYPE_STRING
:

89 
	`bufãr_­³nd_¡ršg_bufãr
(((
d©a_¡ršg
 *)
İ1
)->
v®ue
, ((d©a_¡ršg *)
İ2
)->value);

91 
TYPE_INTEGER
:

92 ((
d©a_š‹g”
 *)
İ1
)->
v®ue
 +ğ((d©a_š‹g” *)
İ2
)->value;

94 
TYPE_ARRAY
: {

95 
¬¿y
 *
d¡
 = ((
d©a_¬¿y
 *)
İ1
)->
v®ue
;

96 
¬¿y
 *
¤c
 = ((
d©a_¬¿y
 *)
İ2
)->
v®ue
;

97 
d©a_un£t
 *
du
;

98 
size_t
 
i
;

100 
i
 = 0; i < 
¤c
->
u£d
; i ++) {

101 
du
 = (
d©a_un£t
 *)
¤c
->
d©a
[
i
];

102 ià(
du
) {

103 ià(
du
->
is_šdex_key
 || 
	`bufãr_is_em±y
(du->
key
è|| !
	`¬¿y_g‘_–em’t
(
d¡
, du->key->
±r
)) {

104 
	`¬¿y_š£¹_unique
(
d¡
, 
du
->
	`cİy
(du));

106 
	`årštf
(
¡d”r
, "Du¶iÿ‹‡¼ay-key '%s'\n", 
du
->
key
->
±r
);

107 
İ1
->
	`ä“
(op1);

108  
NULL
;

114 
	`fÜû_as£¹
(0);

118  
İ1
;

119 
	}
}

121 
	$cÚfig·r£r_»mÙe_nÜm®ize_com·t
(
bufãr
 *
rv®ue
) {

126 
bufãr
 *
b
 = 
	`bufãr_š™
();

127 
rc
;

129 ià(
rv®ue
->
±r
[0] != '[') {

130 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("["));

131 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
rv®ue
);

132 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("]"));

134 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
rv®ue
);

137 
rc
 = 
	`h‰p_»que¡_ho¡_nÜm®ize
(
b
);

139 ià(0 =ğ
rc
) {

141 
size_t
 
bËn
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

142 ià(
bËn
 > 1è
	`bufãr_cİy_¡ršg_Ën
(
rv®ue
, 
b
->
±r
+1, blen-2);

145 
	`bufãr_ä“
(
b
);

146  
rc
;

147 
	}
}

163 #iâdeà
INTERFACE


164 
	#INTERFACE
 1

	)

200 
	#YYCODETYPE
 

	)

201 
	#YYNOCODE
 50

	)

202 
	#YYACTIONTYPE
 

	)

203 
	#cÚfig·r£rTOKENTYPE
 
bufãr
 *

	)

205 
cÚfig·r£rTOKENTYPE
 
	myy0
;

206 
d©a_cÚfig
 * 
	myy2
;

207 
¬¿y
 * 
	myy22
;

208 
d©a_un£t
 * 
	myy59
;

209 
cÚfig_cÚd_t
 
	myy75
;

210 
bufãr
 * 
	myy87
;

211 
	myy99
;

212 } 
	tYYMINORTYPE
;

213 
	#YYSTACKDEPTH
 100

	)

214 
	#cÚfig·r£rARG_SDECL
 
cÚfig_t
 *
ùx
;

	)

215 
	#cÚfig·r£rARG_PDECL
 ,
cÚfig_t
 *
ùx


	)

216 
	#cÚfig·r£rARG_FETCH
 
cÚfig_t
 *
ùx
 = 
yypP¬£r
->
	)
ctx

217 
	#cÚfig·r£rARG_STORE
 
yypP¬£r
->
ùx
 = 
	)
ctx

218 
	#YYNSTATE
 68

	)

219 
	#YYNRULE
 43

	)

220 
	#YYERRORSYMBOL
 26

	)

221 
	#YYERRSYMDT
 
yy99


	)

222 
	#YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

	)

223 
	#YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

	)

224 
	#YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

	)

273 
YYACTIONTYPE
 
	gyy_aùiÚ
[] = {

290 
YYCODETYPE
 
	gyy_lookah—d
[] = {

307 
	#YY_SHIFT_USE_DFLT
 (-2)

	)

308 sigÃd 
	gyy_shiá_of¡
[] = {

317 
	#YY_REDUCE_USE_DFLT
 (-38)

	)

318 sigÃd 
	gyy_»duû_of¡
[] = {

327 
YYACTIONTYPE
 
	gyy_deçuÉ
[] = {

336 
	#YY_SZ_ACTTAB
 ((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

348 #ifdeà
YYFALLBACK


349 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

365 
	syySckEÁry
 {

366 
	m¡©’o
;

367 
	mmajÜ
;

369 
YYMINORTYPE
 
	mmšÜ
;

372 
yySckEÁry
 
	tyySckEÁry
;

376 
	syyP¬£r
 {

377 
	myyidx
;

378 
	myy”rút
;

379 
cÚfig·r£rARG_SDECL


380 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

382 
yyP¬£r
 
	tyyP¬£r
;

384 #iâdeà
NDEBUG


385 
	~<¡dio.h
>

386 
FILE
 *
	gyyT¿ûFILE
 = 
NULL
;

387 *
	gyyT¿ûProm±
 = 
NULL
;

390 #iâdeà
NDEBUG


409 
	$cÚfig·r£rT¿û
(
FILE
 *
T¿ûFILE
, *
zT¿ûProm±
){

410 
yyT¿ûFILE
 = 
T¿ûFILE
;

411 
yyT¿ûProm±
 = 
zT¿ûProm±
;

412 ifĞ
yyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

413 ifĞ
yyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

414 
	}
}

418 #iâdeà
NDEBUG


421 cÚ¡ *
	gyyTok’Name
[] = {

438 #iâdeà
NDEBUG


441 cÚ¡ *
	gyyRuËName
[] = {

493 cÚ¡ *
	$cÚfig·r£rTok’Name
(
tok’Ty³
){

494 #iâdeà
NDEBUG


495 ifĞ
tok’Ty³
>0 && (
size_t
éok’Ty³<((
yyTok’Name
)/(yyTokenName[0])) ){

496  
yyTok’Name
[
tok’Ty³
];

503 
	}
}

518 *
	$cÚfig·r£rAÎoc
(*(*
m®locProc
)(
size_t
)){

519 
yyP¬£r
 *
pP¬£r
;

520 
pP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

521 ifĞ
pP¬£r
 ){

522 
pP¬£r
->
yyidx
 = -1;

524  
pP¬£r
;

525 
	}
}

532 
	$yy_de¡ruùÜ
(
YYCODETYPE
 
yymajÜ
, 
YYMINORTYPE
 *
yypmšÜ
){

533  
yymajÜ
 ){

570 { 
	`bufãr_ä“
((
yypmšÜ
->
yy0
)); }

575 { ià((
yypmšÜ
->
yy59
)è(yypmšÜ->yy59)->
	`ä“
((yypminor->yy59)); }

580 { ià((
yypmšÜ
->
yy59
)è(yypmšÜ->yy59)->
	`ä“
((yypminor->yy59)); }

585 { ià((
yypmšÜ
->
yy59
)è(yypmšÜ->yy59)->
	`ä“
((yypminor->yy59)); }

590 { 
	`¬¿y_ä“
((
yypmšÜ
->
yy22
)); }

595 { 
	`¬¿y_ä“
((
yypmšÜ
->
yy22
)); }

600 { 
	`bufãr_ä“
((
yypmšÜ
->
yy87
)); }

605 { 
	`bufãr_ä“
((
yypmšÜ
->
yy87
)); }

610 
	}
}

620 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

621 
YYCODETYPE
 
yymajÜ
;

622 
yySckEÁry
 *
yytos
;

624 ifĞ
pP¬£r
->
yyidx
<0 )  0;

625 
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

626 #iâdeà
NDEBUG


627 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

628 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

629 
yyT¿ûProm±
,

630 
yyTok’Name
[
yytos
->
majÜ
]);

633 
yymajÜ
 = 
yytos
->
majÜ
;

634 
	`yy_de¡ruùÜ
Ğ
yymajÜ
, &
yytos
->
mšÜ
);

635 
pP¬£r
->
yyidx
--;

636  
yymajÜ
;

637 
	}
}

651 
	$cÚfig·r£rF»e
(

652 *
p
,

653 (*
ä“Proc
)(*)

655 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

656 ifĞ
pP¬£r
==
NULL
 ) ;

657  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

658 (*
ä“Proc
)((*)
pP¬£r
);

659 
	}
}

669 
	$yy_fšd_shiá_aùiÚ
(

670 
yyP¬£r
 *
pP¬£r
,

671 
iLookAh—d


673 
i
;

674 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

677 
i
 = 
yy_shiá_of¡
[
¡©’o
];

678 ifĞ
i
==
YY_SHIFT_USE_DFLT
 ){

679  
yy_deçuÉ
[
¡©’o
];

681 ifĞ
iLookAh—d
==
YYNOCODE
 ){

682  
YY_NO_ACTION
;

684 
i
 +ğ
iLookAh—d
;

685 ifĞ
i
<0 || (
size_t
)i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

686 #ifdeà
YYFALLBACK


687 
iF®lback
;

688 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

689 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

690 #iâdeà
NDEBUG


691 ifĞ
yyT¿ûFILE
 ){

692 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

693 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

696  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

699  
yy_deçuÉ
[
¡©’o
];

701  
yy_aùiÚ
[
i
];

703 
	}
}

713 
	$yy_fšd_»duû_aùiÚ
(

714 
yyP¬£r
 *
pP¬£r
,

715 
iLookAh—d


717 
i
;

718 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

720 
i
 = 
yy_»duû_of¡
[
¡©’o
];

721 ifĞ
i
==
YY_REDUCE_USE_DFLT
 ){

722  
yy_deçuÉ
[
¡©’o
];

724 ifĞ
iLookAh—d
==
YYNOCODE
 ){

725  
YY_NO_ACTION
;

727 
i
 +ğ
iLookAh—d
;

728 ifĞ
i
<0 || (
size_t
)i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

729  
yy_deçuÉ
[
¡©’o
];

731  
yy_aùiÚ
[
i
];

733 
	}
}

738 
	$yy_shiá
(

739 
yyP¬£r
 *
yypP¬£r
,

740 
yyNewS‹
,

741 
yyMajÜ
,

742 
YYMINORTYPE
 *
yypMšÜ


744 
yySckEÁry
 *
yytos
;

745 
yypP¬£r
->
yyidx
++;

746 ifĞ
yypP¬£r
->
yyidx
>=
YYSTACKDEPTH
 ){

747 
cÚfig·r£rARG_FETCH
;

748 
yypP¬£r
->
yyidx
--;

749 #iâdeà
NDEBUG


750 ifĞ
yyT¿ûFILE
 ){

751 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

754  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

757 
cÚfig·r£rARG_STORE
;

760 
yytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

761 
yytos
->
¡©’o
 = 
yyNewS‹
;

762 
yytos
->
majÜ
 = 
yyMajÜ
;

763 
yytos
->
mšÜ
 = *
yypMšÜ
;

764 #iâdeà
NDEBUG


765 ifĞ
yyT¿ûFILE
 && 
yypP¬£r
->
yyidx
>0 ){

766 
i
;

767 
	`årštf
(
yyT¿ûFILE
,"%sShiá %d\n",
yyT¿ûProm±
,
yyNewS‹
);

768 
	`årštf
(
yyT¿ûFILE
,"%sSck:",
yyT¿ûProm±
);

769 
i
=1; i<=
yypP¬£r
->
yyidx
; i++)

770 
	`årštf
(
yyT¿ûFILE
," %s",
yyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
majÜ
]);

771 
	`årštf
(
yyT¿ûFILE
,"\n");

774 
	}
}

780 
YYCODETYPE
 
	mlhs
;

781 
	mÄhs
;

782 } 
	gyyRuËInfo
[] = {

828 
yy_acû±
(
yyP¬£r
*);

834 
	$yy_»duû
(

835 
yyP¬£r
 *
yypP¬£r
,

836 
yyruËno


838 
yygÙo
;

839 
yyaù
;

840 
YYMINORTYPE
 
yygÙomšÜ
;

841 
yySckEÁry
 *
yym¥
;

842 
yysize
;

843 
cÚfig·r£rARG_FETCH
;

844 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

845 #iâdeà
NDEBUG


846 ifĞ
yyT¿ûFILE
 ) {

847 ià(
yyruËno
>=0

848 && (
size_t
)
yyruËno
<(
yyRuËName
)/(yyRuleName[0]) ){

849 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

850 
yyRuËName
[
yyruËno
]);

857  
yyruËno
 ){

883 { 
yym¥
[-1].
mšÜ
.
yy2
 = 
NULL
; }

885 
	`yy_de¡ruùÜ
(1,&
yym¥
[0].
mšÜ
);

894 
	`yy_de¡ruùÜ
(1,&
yym¥
[0].
mšÜ
);

899 ià(
ùx
->
ok
) {

900 
	`bufãr_cİy_bufãr
(
yym¥
[0].
mšÜ
.
yy59
->
key
, yym¥[-2].mšÜ.
yy87
);

901 ià(
	`¡ºcmp
(
yym¥
[-2].
mšÜ
.
yy87
->
±r
, "env.", ("env.") - 1) == 0) {

902 
	`årštf
(
¡d”r
, "Settingƒnv variable is‚ot supported in conditional %d %s: %s\n",

903 
ùx
->
cu¼’t
->
cÚ‹xt_ndx
,

904 
ùx
->
cu¼’t
->
key
->
±r
, 
yym¥
[-2].
mšÜ
.
yy87
->ptr);

905 
ùx
->
ok
 = 0;

906 } ià(
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
ùx
->
cu¼’t
->
v®ue
, 
yym¥
[0].
mšÜ
.
yy59
->
key
->
±r
)) {

907 
	`¬¿y_š£¹_unique
(
ùx
->
cu¼’t
->
v®ue
, 
yym¥
[0].
mšÜ
.
yy59
);

908 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

910 
	`årštf
(
¡d”r
, "Duplicate config variable in conditional %d %s: %s\n",

911 
ùx
->
cu¼’t
->
cÚ‹xt_ndx
,

912 
ùx
->
cu¼’t
->
key
->
±r
, 
yym¥
[0].
mšÜ
.
yy59
->key->ptr);

913 
ùx
->
ok
 = 0;

914 
yym¥
[0].
mšÜ
.
yy59
->
	`ä“
(yymsp[0].minor.yy59);

915 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

918 
	`bufãr_ä“
(
yym¥
[-2].
mšÜ
.
yy87
);

919 
yym¥
[-2].
mšÜ
.
yy87
 = 
NULL
;

922 
	`yy_de¡ruùÜ
(2,&
yym¥
[-1].
mšÜ
);

927 ià(
ùx
->
ok
) {

928 
¬¿y
 *
v¬s
 = 
ùx
->
cu¼’t
->
v®ue
;

929 
d©a_un£t
 *
du
;

931 ià(
	`¡ºcmp
(
yym¥
[-2].
mšÜ
.
yy87
->
±r
, "env.", ("env.") - 1) == 0) {

932 
	`årštf
(
¡d”r
, "Appendingƒnv variable is‚ot supported in conditional %d %s: %s\n",

933 
ùx
->
cu¼’t
->
cÚ‹xt_ndx
,

934 
ùx
->
cu¼’t
->
key
->
±r
, 
yym¥
[-2].
mšÜ
.
yy87
->ptr);

935 
ùx
->
ok
 = 0;

936 } ià(
NULL
 !ğ(
du
 = 
	`¬¿y_exŒaù_–em’t
(
v¬s
, 
yym¥
[-2].
mšÜ
.
yy87
->
±r
)è|| NULL !ğ(du = 
	`cÚfig·r£r_g‘_v¬ŸbË
(
ùx
, yymsp[-2].minor.yy87))) {

937 
du
 = 
	`cÚfig·r£r_m”ge_d©a
(du, 
yym¥
[0].
mšÜ
.
yy59
);

938 ià(
NULL
 =ğ
du
) {

939 
ùx
->
ok
 = 0;

942 
	`bufãr_cİy_bufãr
(
du
->
key
, 
yym¥
[-2].
mšÜ
.
yy87
);

943 
	`¬¿y_š£¹_unique
(
ùx
->
cu¼’t
->
v®ue
, 
du
);

945 
yym¥
[0].
mšÜ
.
yy59
->
	`ä“
(yymsp[0].minor.yy59);

947 
	`bufãr_cİy_bufãr
(
yym¥
[0].
mšÜ
.
yy59
->
key
, yym¥[-2].mšÜ.
yy87
);

948 
	`¬¿y_š£¹_unique
(
ùx
->
cu¼’t
->
v®ue
, 
yym¥
[0].
mšÜ
.
yy59
);

950 
	`bufãr_ä“
(
yym¥
[-2].
mšÜ
.
yy87
);

951 
yym¥
[-2].
mšÜ
.
yy87
 = 
NULL
;

952 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

956 
	`yy_de¡ruùÜ
(3,&
yym¥
[-1].
mšÜ
);

961 ià(
	`¡rchr
(
yym¥
[0].
mšÜ
.
yy0
->
±r
, '.'è=ğ
NULL
) {

962 
yygÙomšÜ
.
yy87
 = 
	`bufãr_š™_¡ršg
("var.");

963 
	`bufãr_­³nd_¡ršg_bufãr
(
yygÙomšÜ
.
yy87
, 
yym¥
[0].
mšÜ
.
yy0
);

964 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy0
);

965 
yym¥
[0].
mšÜ
.
yy0
 = 
NULL
;

967 
yygÙomšÜ
.
yy87
 = 
yym¥
[0].
mšÜ
.
yy0
;

968 
yym¥
[0].
mšÜ
.
yy0
 = 
NULL
;

976 
yygÙomšÜ
.
yy59
 = 
NULL
;

977 ià(
ùx
->
ok
) {

978 
yygÙomšÜ
.
yy59
 = 
	`cÚfig·r£r_m”ge_d©a
(
yym¥
[-2].
mšÜ
.yy59, yymsp[0].minor.yy59);

979 ià(
NULL
 =ğ
yygÙomšÜ
.
yy59
) {

980 
ùx
->
ok
 = 0;

982 
yym¥
[-2].
mšÜ
.
yy59
 = 
NULL
;

983 
yym¥
[0].
mšÜ
.
yy59
->
	`ä“
(yymsp[0].minor.yy59);

984 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

988 
	`yy_de¡ruùÜ
(5,&
yym¥
[-1].
mšÜ
);

993 
yygÙomšÜ
.
yy59
 = 
yym¥
[0].
mšÜ
.yy59;

994 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1001 
yygÙomšÜ
.
yy59
 = 
NULL
;

1002 ià(
ùx
->
ok
) {

1003 ià(
	`¡ºcmp
(
yym¥
[0].
mšÜ
.
yy87
->
±r
, "env.", ("env.") - 1) == 0) {

1004 *
’v
;

1006 ià(
NULL
 !ğ(
’v
 = 
	`g‘’v
(
yym¥
[0].
mšÜ
.
yy87
->
±r
 + 4))) {

1007 
d©a_¡ršg
 *
ds
;

1008 
ds
 = 
	`d©a_¡ršg_š™
();

1009 
	`bufãr_­³nd_¡ršg
(
ds
->
v®ue
, 
’v
);

1010 
yygÙomšÜ
.
yy59
 = (
d©a_un£t
 *)
ds
;

1013 
	`årštf
(
¡d”r
, "Undefšedƒnv v¬ŸbË: %s\n", 
yym¥
[0].
mšÜ
.
yy87
->
±r
 + 4);

1014 
ùx
->
ok
 = 0;

1016 } ià(
NULL
 =ğ(
yygÙomšÜ
.
yy59
 = 
	`cÚfig·r£r_g‘_v¬ŸbË
(
ùx
, 
yym¥
[0].
mšÜ
.
yy87
))) {

1017 
	`årštf
(
¡d”r
, "Undefšed cÚfig v¬ŸbË: %s\n", 
yym¥
[0].
mšÜ
.
yy87
->
±r
);

1018 
ùx
->
ok
 = 0;

1020 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy87
);

1021 
yym¥
[0].
mšÜ
.
yy87
 = 
NULL
;

1029 
yygÙomšÜ
.
yy59
 = (
d©a_un£t
 *)
	`d©a_¡ršg_š™
();

1030 
	`bufãr_cİy_bufãr
(((
d©a_¡ršg
 *)(
yygÙomšÜ
.
yy59
))->
v®ue
, 
yym¥
[0].
mšÜ
.
yy0
);

1031 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy0
);

1032 
yym¥
[0].
mšÜ
.
yy0
 = 
NULL
;

1039 *
’d±r
;

1040 
yygÙomšÜ
.
yy59
 = (
d©a_un£t
 *)
	`d©a_š‹g”_š™
();

1041 
”ºo
 = 0;

1042 ((
d©a_š‹g”
 *)(
yygÙomšÜ
.
yy59
))->
v®ue
 = 
	`¡¹Ş
(
yym¥
[0].
mšÜ
.
yy0
->
±r
, &
’d±r
, 10);

1044 ià(
’d±r
 !ğ
yym¥
[0].
mšÜ
.
yy0
->
±r
è
	`is¥aû
(*endptr))ƒndptr++;

1045 ià(0 !ğ
”ºo
 || *
’d±r
 != '\0') {

1046 
	`årštf
(
¡d”r
, "”rÜ…¬sšg‚umb”: '%s'\n", 
yym¥
[0].
mšÜ
.
yy0
->
±r
);

1047 
ùx
->
ok
 = 0;

1049 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy0
);

1050 
yym¥
[0].
mšÜ
.
yy0
 = 
NULL
;

1057 
yygÙomšÜ
.
yy59
 = (
d©a_un£t
 *)
	`d©a_¬¿y_š™
();

1058 
	`¬¿y_ä“
(((
d©a_¬¿y
 *)(
yygÙomšÜ
.
yy59
))->
v®ue
);

1059 ((
d©a_¬¿y
 *)(
yygÙomšÜ
.
yy59
))->
v®ue
 = 
yym¥
[0].
mšÜ
.
yy22
;

1060 
yym¥
[0].
mšÜ
.
yy22
 = 
NULL
;

1067 
yygÙomšÜ
.
yy22
 = 
	`¬¿y_š™
();

1070 
	`yy_de¡ruùÜ
(8,&
yym¥
[-1].
mšÜ
);

1071 
	`yy_de¡ruùÜ
(9,&
yym¥
[0].
mšÜ
);

1076 
yygÙomšÜ
.
yy22
 = 
yym¥
[-1].
mšÜ
.yy22;

1077 
yym¥
[-1].
mšÜ
.
yy22
 = 
NULL
;

1080 
	`yy_de¡ruùÜ
(8,&
yym¥
[-2].
mšÜ
);

1081 
	`yy_de¡ruùÜ
(9,&
yym¥
[0].
mšÜ
);

1086 
yygÙomšÜ
.
yy22
 = 
NULL
;

1087 ià(
ùx
->
ok
) {

1088 ià(
	`bufãr_is_em±y
(
yym¥
[0].
mšÜ
.
yy59
->
key
) ||

1089 
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
yym¥
[-2].
mšÜ
.
yy22
, yym¥[0].mšÜ.
yy59
->
key
->
±r
)) {

1090 
	`¬¿y_š£¹_unique
(
yym¥
[-2].
mšÜ
.
yy22
, yym¥[0].mšÜ.
yy59
);

1091 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1093 
	`årštf
(
¡d”r
, "Error: duplicate‡rray-key: %s. Please get„id ofhe duplicateƒntry.\n",

1094 
yym¥
[0].
mšÜ
.
yy59
->
key
->
±r
);

1095 
ùx
->
ok
 = 0;

1096 
yym¥
[0].
mšÜ
.
yy59
->
	`ä“
(yymsp[0].minor.yy59);

1097 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1100 
yygÙomšÜ
.
yy22
 = 
yym¥
[-2].
mšÜ
.yy22;

1101 
yym¥
[-2].
mšÜ
.
yy22
 = 
NULL
;

1105 
	`yy_de¡ruùÜ
(10,&
yym¥
[-1].
mšÜ
);

1110 
yygÙomšÜ
.
yy22
 = 
yym¥
[-1].
mšÜ
.yy22;

1111 
yym¥
[-1].
mšÜ
.
yy22
 = 
NULL
;

1114 
	`yy_de¡ruùÜ
(10,&
yym¥
[0].
mšÜ
);

1119 
yygÙomšÜ
.
yy22
 = 
NULL
;

1120 ià(
ùx
->
ok
) {

1121 
yygÙomšÜ
.
yy22
 = 
	`¬¿y_š™
();

1122 
	`¬¿y_š£¹_unique
(
yygÙomšÜ
.
yy22
, 
yym¥
[0].
mšÜ
.
yy59
);

1123 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1131 
yygÙomšÜ
.
yy59
 = 
yym¥
[0].
mšÜ
.yy59;

1132 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1139 
yygÙomšÜ
.
yy59
 = 
NULL
;

1140 ià(
ùx
->
ok
) {

1141 
	`bufãr_cİy_bufãr
(
yym¥
[0].
mšÜ
.
yy59
->
key
, yym¥[-2].mšÜ.
yy87
);

1142 
	`bufãr_ä“
(
yym¥
[-2].
mšÜ
.
yy87
);

1143 
yym¥
[-2].
mšÜ
.
yy87
 = 
NULL
;

1145 
yygÙomšÜ
.
yy59
 = 
yym¥
[0].
mšÜ
.yy59;

1146 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1150 
	`yy_de¡ruùÜ
(11,&
yym¥
[-1].
mšÜ
);

1153 
	`yy_de¡ruùÜ
(1,&
yym¥
[0].
mšÜ
);

1160 
d©a_cÚfig
 *
dc
;

1161 
dc
 = (
d©a_cÚfig
 *)
	`¬¿y_g‘_–em’t
(
ùx
->
¤v
->
cÚfig_cÚ‹xt
, "global");

1162 
	`fÜû_as£¹
(
dc
);

1163 
	`cÚfig·r£r_push
(
ùx
, 
dc
, 0);

1166 
	`yy_de¡ruùÜ
(12,&
yym¥
[0].
mšÜ
);

1171 
	`fÜû_as£¹
(
ùx
->
cu¼’t
);

1172 
	`cÚfig·r£r_pİ
(
ùx
);

1173 
	`fÜû_as£¹
(
ùx
->
cu¼’t
);

1177 
	`yy_de¡ruùÜ
(13,&
yym¥
[-2].
mšÜ
);

1179 
	`yy_de¡ruùÜ
(14,&
yym¥
[0].
mšÜ
);

1184 
yygÙomšÜ
.
yy2
 = 
NULL
;

1185 ià(
ùx
->
ok
) {

1186 ià(
yym¥
[-3].
mšÜ
.
yy2
->
cÚ‹xt_ndx
 >= yymsp[0].minor.yy2->context_ndx) {

1187 
	`årštf
(
¡d”r
, "unreachableƒlse condition\n");

1188 
ùx
->
ok
 = 0;

1190 ià(
yym¥
[-3].
mšÜ
.
yy2
->
cÚd
 =ğ
CONFIG_COND_ELSE
) {

1191 
	`årštf
(
¡d”r
, "unreachable condition followingƒlse catch-all\n");

1192 
ùx
->
ok
 = 0;

1194 
yym¥
[0].
mšÜ
.
yy2
->
´ev
 = yymsp[-3].minor.yy2;

1195 
yym¥
[-3].
mšÜ
.
yy2
->
Ãxt
 = yymsp[0].minor.yy2;

1196 
yygÙomšÜ
.
yy2
 = 
yym¥
[0].
mšÜ
.yy2;

1197 
yym¥
[-3].
mšÜ
.
yy2
 = 
NULL
;

1198 
yym¥
[0].
mšÜ
.
yy2
 = 
NULL
;

1203 
	`yy_de¡ruùÜ
(15,&
yym¥
[-1].
mšÜ
);

1208 
yygÙomšÜ
.
yy2
 = 
NULL
;

1209 ià(
ùx
->
ok
) {

1210 ià(
yym¥
[-3].
mšÜ
.
yy2
->
cÚ‹xt_ndx
 >= yymsp[0].minor.yy2->context_ndx) {

1211 
	`årštf
(
¡d”r
, "unreachableƒlse condition\n");

1212 
ùx
->
ok
 = 0;

1214 ià(
yym¥
[-3].
mšÜ
.
yy2
->
cÚd
 =ğ
CONFIG_COND_ELSE
) {

1215 
	`årštf
(
¡d”r
, "unreachable condition followingƒlse catch-all\n");

1216 
ùx
->
ok
 = 0;

1219 ià(
ùx
->
ok
) {

1220 
size_t
 
pos
;

1221 
d©a_cÚfig
 *
dc
;

1222 
dc
 = (
d©a_cÚfig
 *)
	`¬¿y_exŒaù_–em’t
(
ùx
->
®l_cÚfigs
, 
yym¥
[0].
mšÜ
.
yy2
->
key
->
±r
);

1223 
	`fÜû_as£¹
(
yym¥
[0].
mšÜ
.
yy2
 =ğ
dc
);

1224 
	`bufãr_cİy_bufãr
(
yym¥
[0].
mšÜ
.
yy2
->
key
, yymsp[-3].minor.yy2->key);

1227 
pos
 = 
	`bufãr_¡ršg_Ëngth
(
yym¥
[0].
mšÜ
.
yy2
->
key
)-bufãr_¡ršg_Ëngth(yym¥[-3].mšÜ.yy2->
¡ršg
)-2;

1228 
yym¥
[-3].
mšÜ
.
yy2
->
cÚd
) {

1229 
CONFIG_COND_NE
:

1230 
yym¥
[0].
mšÜ
.
yy2
->
key
->
±r
[
pos
] = '=';

1233 
CONFIG_COND_EQ
:

1234 
yym¥
[0].
mšÜ
.
yy2
->
key
->
±r
[
pos
] = '!';

1237 
CONFIG_COND_NOMATCH
:

1238 
yym¥
[0].
mšÜ
.
yy2
->
key
->
±r
[
pos
] = '=';

1241 
CONFIG_COND_MATCH
:

1242 
yym¥
[0].
mšÜ
.
yy2
->
key
->
±r
[
pos
] = '!';

1246 
	`fÜû_as£¹
(0);

1249 ià(
NULL
 =ğ(
dc
 = (
d©a_cÚfig
 *)
	`¬¿y_g‘_–em’t
(
ùx
->
®l_cÚfigs
, 
yym¥
[0].
mšÜ
.
yy2
->
key
->
±r
))) {

1251 
	`¬¿y_š£¹_unique
(
ùx
->
®l_cÚfigs
, (
d©a_un£t
 *)
yym¥
[0].
mšÜ
.
yy2
);

1252 
yym¥
[0].
mšÜ
.
yy2
->
´ev
 = yymsp[-3].minor.yy2;

1253 
yym¥
[-3].
mšÜ
.
yy2
->
Ãxt
 = yymsp[0].minor.yy2;

1255 
	`årštf
(
¡d”r
, "unreachableƒlse condition\n");

1256 
ùx
->
ok
 = 0;

1257 
yym¥
[0].
mšÜ
.
yy2
->
	`ä“
((
d©a_un£t
 *)yymsp[0].minor.yy2);

1258 
yym¥
[0].
mšÜ
.
yy2
 = 
dc
;

1261 
yygÙomšÜ
.
yy2
 = 
yym¥
[0].
mšÜ
.yy2;

1262 
yym¥
[-3].
mšÜ
.
yy2
 = 
NULL
;

1263 
yym¥
[0].
mšÜ
.
yy2
 = 
NULL
;

1268 
	`yy_de¡ruùÜ
(15,&
yym¥
[-1].
mšÜ
);

1273 
yygÙomšÜ
.
yy2
 = 
yym¥
[0].
mšÜ
.yy2;

1274 
yym¥
[0].
mšÜ
.
yy2
 = 
NULL
;

1281 
yygÙomšÜ
.
yy2
 = 
NULL
;

1282 ià(
ùx
->
ok
) {

1283 
d©a_cÚfig
 *
cur
;

1285 
cur
 = 
ùx
->
cu¼’t
;

1286 
	`cÚfig·r£r_pİ
(
ùx
);

1288 
	`fÜû_as£¹
(
cur
 && 
ùx
->
cu¼’t
);

1290 
yygÙomšÜ
.
yy2
 = 
cur
;

1295 
	`yy_de¡ruùÜ
(13,&
yym¥
[-2].
mšÜ
);

1297 
	`yy_de¡ruùÜ
(14,&
yym¥
[0].
mšÜ
);

1302 
yygÙomšÜ
.
yy2
 = 
NULL
;

1303 ià(
ùx
->
ok
) {

1304 
d©a_cÚfig
 *
cur
;

1306 
cur
 = 
ùx
->
cu¼’t
;

1307 
	`cÚfig·r£r_pİ
(
ùx
);

1309 
	`fÜû_as£¹
(
cur
 && 
ùx
->
cu¼’t
);

1311 
yygÙomšÜ
.
yy2
 = 
cur
;

1316 
	`yy_de¡ruùÜ
(13,&
yym¥
[-2].
mšÜ
);

1318 
	`yy_de¡ruùÜ
(14,&
yym¥
[0].
mšÜ
);

1323 
d©a_cÚfig
 *
dc
;

1324 
bufãr
 *
b
, *
rv®ue
, *
İ
;

1326 ià(
ùx
->
ok
 && 
yym¥
[0].
mšÜ
.
yy59
->
ty³
 !ğ
TYPE_STRING
) {

1327 
	`årštf
(
¡d”r
, "rvalue must be string");

1328 
ùx
->
ok
 = 0;

1331 ià(
ùx
->
ok
) {

1332 
yym¥
[-1].
mšÜ
.
yy75
) {

1333 
CONFIG_COND_NE
:

1334 
İ
 = 
	`bufãr_š™_¡ršg
("!=");

1336 
CONFIG_COND_EQ
:

1337 
İ
 = 
	`bufãr_š™_¡ršg
("==");

1339 
CONFIG_COND_NOMATCH
:

1340 
İ
 = 
	`bufãr_š™_¡ršg
("!~");

1342 
CONFIG_COND_MATCH
:

1343 
İ
 = 
	`bufãr_š™_¡ršg
("=~");

1346 
	`fÜû_as£¹
(0);

1350 
b
 = 
	`bufãr_š™
();

1351 
	`bufãr_cİy_bufãr
(
b
, 
ùx
->
cu¼’t
->
key
);

1352 
	`bufãr_­³nd_¡ršg
(
b
, "/");

1353 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
yym¥
[-5].
mšÜ
.
yy0
);

1354 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
yym¥
[-3].
mšÜ
.
yy87
);

1355 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
İ
);

1356 
rv®ue
 = ((
d©a_¡ršg
*)
yym¥
[0].
mšÜ
.
yy59
)->
v®ue
;

1357 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
rv®ue
);

1359 ià(
NULL
 !ğ(
dc
 = (
d©a_cÚfig
 *)
	`¬¿y_g‘_–em’t
(
ùx
->
®l_cÚfigs
, 
b
->
±r
))) {

1360 
	`cÚfig·r£r_push
(
ùx
, 
dc
, 0);

1363 
comp_key_t
 
comp
;

1364 *
comp_key
;

1365 
size_t
 
Ën
;

1366 } 
comps
[] = {

1367 { 
COMP_SERVER_SOCKET
, 
	`CONST_STR_LEN
("SERVER[\"socket\"]" ) },

1368 { 
COMP_HTTP_URL
, 
	`CONST_STR_LEN
("HTTP[\"url\"]" ) },

1369 { 
COMP_HTTP_HOST
, 
	`CONST_STR_LEN
("HTTP[\"host\"]" ) },

1370 { 
COMP_HTTP_REFERER
, 
	`CONST_STR_LEN
("HTTP[\"referer\"]" ) },

1371 { 
COMP_HTTP_USER_AGENT
, 
	`CONST_STR_LEN
("HTTP[\"useragent\"]" ) },

1372 { 
COMP_HTTP_USER_AGENT
, 
	`CONST_STR_LEN
("HTTP[\"user-agent\"]" ) },

1373 { 
COMP_HTTP_LANGUAGE
, 
	`CONST_STR_LEN
("HTTP[\"language\"]" ) },

1374 { 
COMP_HTTP_COOKIE
, 
	`CONST_STR_LEN
("HTTP[\"cookie\"]" ) },

1375 { 
COMP_HTTP_REMOTE_IP
, 
	`CONST_STR_LEN
("HTTP[\"remoteip\"]" ) },

1376 { 
COMP_HTTP_REMOTE_IP
, 
	`CONST_STR_LEN
("HTTP[\"remote-ip\"]" ) },

1377 { 
COMP_HTTP_QUERY_STRING
, 
	`CONST_STR_LEN
("HTTP[\"querystring\"]") },

1378 { 
COMP_HTTP_QUERY_STRING
, 
	`CONST_STR_LEN
("HTTP[\"query-string\"]") },

1379 { 
COMP_HTTP_REQUEST_METHOD
, 
	`CONST_STR_LEN
("HTTP[\"request-method\"]") },

1380 { 
COMP_HTTP_SCHEME
, 
	`CONST_STR_LEN
("HTTP[\"scheme\"]" ) },

1381 { 
COMP_UNSET
, 
NULL
, 0 },

1383 
size_t
 
i
;

1385 
dc
 = 
	`d©a_cÚfig_š™
();

1387 
	`bufãr_cİy_bufãr
(
dc
->
key
, 
b
);

1388 
	`bufãr_cİy_bufãr
(
dc
->
İ
, op);

1389 
	`bufãr_cİy_bufãr
(
dc
->
comp_key
, 
yym¥
[-5].
mšÜ
.
yy0
);

1390 
	`bufãr_­³nd_¡ršg_Ën
(
dc
->
comp_key
, 
	`CONST_STR_LEN
("[\""));

1391 
	`bufãr_­³nd_¡ršg_bufãr
(
dc
->
comp_key
, 
yym¥
[-3].
mšÜ
.
yy87
);

1392 
	`bufãr_­³nd_¡ršg_Ën
(
dc
->
comp_key
, 
	`CONST_STR_LEN
("\"]"));

1393 
dc
->
cÚd
 = 
yym¥
[-1].
mšÜ
.
yy75
;

1395 
i
 = 0; 
comps
[i].
comp_key
; i ++) {

1396 ià(
	`bufãr_is_equ®_¡ršg
(

1397 
dc
->
comp_key
, 
comps
[
i
].comp_key, comps[i].
Ën
)) {

1398 
dc
->
comp
 = 
comps
[
i
].comp;

1402 ià(
COMP_UNSET
 =ğ
dc
->
comp
) {

1403 
	`årštf
(
¡d”r
, "”rÜ comp_key %s", 
dc
->
comp_key
->
±r
);

1404 
ùx
->
ok
 = 0;

1406 ià(
COMP_HTTP_REMOTE_IP
 =ğ
dc
->
comp


1407 && (
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
 || dc->cÚd =ğ
CONFIG_COND_NE
)) {

1408 * cÚ¡ 
¦ash
 = 
	`¡rchr
(
rv®ue
->
±r
, '/');

1409 * cÚ¡ 
cŞÚ
 = 
	`¡rchr
(
rv®ue
->
±r
, ':');

1410 ià(
NULL
 !ğ
¦ash
 && sÏsh =ğ
rv®ue
->
±r
){

1412 ià(
NULL
 !ğ
¦ash
) {

1413 *
ÅŒ
;

1414 cÚ¡ 
nm_b™s
 = 
	`¡¹oul
(
¦ash
 + 1, &
ÅŒ
, 10);

1415 ià(*
ÅŒ
 || 0 =ğ
nm_b™s
 ||‚m_b™ > (
NULL
 !ğ
cŞÚ
 ? 128 : 32)) {

1417 
	`årštf
(
¡d”r
, "šv®id o¸missšg‚‘mask: %s\n", 
rv®ue
->
±r
);

1418 
ùx
->
ok
 = 0;

1421 
rc
;

1422 
	`bufãr_¡ršg_£t_Ëngth
(
rv®ue
, (
size_t
)(
¦ash
 -„v®ue->
±r
));

1423 
rc
 = (
NULL
 =ğ
cŞÚ
)

1424 ? 
	`h‰p_»que¡_ho¡_nÜm®ize
(
rv®ue
)

1425 : 
	`cÚfig·r£r_»mÙe_nÜm®ize_com·t
(
rv®ue
);

1426 
	`bufãr_­³nd_¡ršg_Ën
(
rv®ue
, 
	`CONST_STR_LEN
("/"));

1427 
	`bufãr_­³nd_št
(
rv®ue
, ()
nm_b™s
);

1428 ià(0 !ğ
rc
) {

1429 
	`årštf
(
¡d”r
, "šv®id IP‡ddr: %s\n", 
rv®ue
->
±r
);

1430 
ùx
->
ok
 = 0;

1435 
rc
 = (
NULL
 =ğ
cŞÚ
)

1436 ? 
	`h‰p_»que¡_ho¡_nÜm®ize
(
rv®ue
)

1437 : 
	`cÚfig·r£r_»mÙe_nÜm®ize_com·t
(
rv®ue
);

1438 ià(0 !ğ
rc
) {

1439 
	`årštf
(
¡d”r
, "šv®id IP‡ddr: %s\n", 
rv®ue
->
±r
);

1440 
ùx
->
ok
 = 0;

1444 ià(
COMP_SERVER_SOCKET
 =ğ
dc
->
comp
) {

1446 ià(
rv®ue
->
±r
[0] != ':'

1447 && !(
rv®ue
->
±r
[0] == '[' &&„value->ptr[1] == ']')) {

1448 ià(
	`h‰p_»que¡_ho¡_nÜm®ize
(
rv®ue
)) {

1449 
	`årštf
(
¡d”r
, "šv®id IP‡ddr: %s\n", 
rv®ue
->
±r
);

1450 
ùx
->
ok
 = 0;

1454 ià(
COMP_HTTP_HOST
 =ğ
dc
->
comp
) {

1455 ià(
dc
->
cÚd
 =ğ
CONFIG_COND_EQ
 || dc->cÚd =ğ
CONFIG_COND_NE
) {

1456 ià(
	`h‰p_»que¡_ho¡_nÜm®ize
(
rv®ue
)) {

1457 
	`årštf
(
¡d”r
, "šv®id IP‡ddr: %s\n", 
rv®ue
->
±r
);

1458 
ùx
->
ok
 = 0;

1463 ià(
ùx
->
ok
è
yym¥
[-1].
mšÜ
.
yy75
) {

1464 
CONFIG_COND_NE
:

1465 
CONFIG_COND_EQ
:

1466 
dc
->
¡ršg
 = 
	`bufãr_š™_bufãr
(
rv®ue
);

1468 
CONFIG_COND_NOMATCH
:

1469 
CONFIG_COND_MATCH
: {

1470 #ifdeà
HAVE_PCRE_H


1471 cÚ¡ *
”½Œ
;

1472 
”roff
, 
ÿ±u»s
;

1474 ià(
NULL
 =ğ(
dc
->
»gex
 =

1475 
	`püe_compe
(
rv®ue
->
±r
, 0, &
”½Œ
, &
”roff
, 
NULL
))) {

1476 
dc
->
¡ršg
 = 
	`bufãr_š™_¡ršg
(
”½Œ
);

1477 
dc
->
cÚd
 = 
CONFIG_COND_UNSET
;

1479 
	`årštf
(
¡d”r
, "parsing„egex failed: %s -> %s‡t offset %d\n",

1480 
rv®ue
->
±r
, 
”½Œ
, 
”roff
);

1482 
ùx
->
ok
 = 0;

1483 } ià(
NULL
 =ğ(
dc
->
»gex_¡udy
 =

1484 
	`püe_¡udy
(
dc
->
»gex
, 0, &
”½Œ
)) &&

1485 
”½Œ
 !ğ
NULL
) {

1486 
	`årštf
(
¡d”r
, "studying„egex failed: %s -> %s\n",

1487 
rv®ue
->
±r
, 
”½Œ
);

1488 
ùx
->
ok
 = 0;

1489 } ià(0 !ğ(
	`püe_fuÎšfo
(
dc
->
»gex
, dc->
»gex_¡udy
, 
PCRE_INFO_CAPTURECOUNT
, &
ÿ±u»s
))) {

1490 
	`årštf
(
¡d”r
, "getting capture count for„egex failed: %s\n",

1491 
rv®ue
->
±r
);

1492 
ùx
->
ok
 = 0;

1493 } ià(
ÿ±u»s
 > 9) {

1494 
	`årštf
(
¡d”r
, "Too many captures in„egex, use (?:...) instead of (...): %s\n",

1495 
rv®ue
->
±r
);

1496 
ùx
->
ok
 = 0;

1498 
dc
->
¡ršg
 = 
	`bufãr_š™_bufãr
(
rv®ue
);

1501 
	`årštf
(
¡d”r
, "can't handle '$%s[%s] =~ ...'‡s you compiled without…cre support. \n"

1503 
yym¥
[-5].
mšÜ
.
yy0
->
±r
, yym¥[-3].mšÜ.
yy87
->ptr);

1504 
ùx
->
ok
 = 0;

1510 
	`årštf
(
¡d”r
, "unknown condition for $%s[%s]\n",

1511 
yym¥
[-5].
mšÜ
.
yy0
->
±r
, yym¥[-3].mšÜ.
yy87
->ptr);

1512 
ùx
->
ok
 = 0;

1516 ià(
ùx
->
ok
) {

1517 
	`cÚfig·r£r_push
(
ùx
, 
dc
, 1);

1519 
dc
->
	`ä“
((
d©a_un£t
*) dc);

1523 
	`bufãr_ä“
(
b
);

1524 
	`bufãr_ä“
(
İ
);

1525 
	`bufãr_ä“
(
yym¥
[-5].
mšÜ
.
yy0
);

1526 
yym¥
[-5].
mšÜ
.
yy0
 = 
NULL
;

1527 
	`bufãr_ä“
(
yym¥
[-3].
mšÜ
.
yy87
);

1528 
yym¥
[-3].
mšÜ
.
yy87
 = 
NULL
;

1529 
yym¥
[0].
mšÜ
.
yy59
->
	`ä“
(yymsp[0].minor.yy59);

1530 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1534 
	`yy_de¡ruùÜ
(16,&
yym¥
[-6].
mšÜ
);

1535 
	`yy_de¡ruùÜ
(18,&
yym¥
[-4].
mšÜ
);

1536 
	`yy_de¡ruùÜ
(19,&
yym¥
[-2].
mšÜ
);

1541 ià(
ùx
->
ok
) {

1542 
d©a_cÚfig
 *
dc
 = 
	`d©a_cÚfig_š™
();

1543 
	`bufãr_cİy_bufãr
(
dc
->
key
, 
ùx
->
cu¼’t
->key);

1544 
	`bufãr_­³nd_¡ršg_Ën
(
dc
->
key
, 
	`CONST_STR_LEN
("/"));

1545 
	`bufãr_­³nd_¡ršg_Ën
(
dc
->
key
, 
	`CONST_STR_LEN
("else_tmp_token"));

1546 
dc
->
cÚd
 = 
CONFIG_COND_ELSE
;

1547 
	`cÚfig·r£r_push
(
ùx
, 
dc
, 1);

1555 
yygÙomšÜ
.
yy75
 = 
CONFIG_COND_EQ
;

1558 
	`yy_de¡ruùÜ
(20,&
yym¥
[0].
mšÜ
);

1563 
yygÙomšÜ
.
yy75
 = 
CONFIG_COND_MATCH
;

1566 
	`yy_de¡ruùÜ
(21,&
yym¥
[0].
mšÜ
);

1571 
yygÙomšÜ
.
yy75
 = 
CONFIG_COND_NE
;

1574 
	`yy_de¡ruùÜ
(22,&
yym¥
[0].
mšÜ
);

1579 
yygÙomšÜ
.
yy75
 = 
CONFIG_COND_NOMATCH
;

1582 
	`yy_de¡ruùÜ
(23,&
yym¥
[0].
mšÜ
);

1587 
yygÙomšÜ
.
yy87
 = 
NULL
;

1588 ià(
ùx
->
ok
) {

1589 ià(
yym¥
[0].
mšÜ
.
yy59
->
ty³
 =ğ
TYPE_STRING
) {

1590 
yygÙomšÜ
.
yy87
 = 
	`bufãr_š™_bufãr
(((
d©a_¡ršg
*)
yym¥
[0].
mšÜ
.
yy59
)->
v®ue
);

1591 } ià(
yym¥
[0].
mšÜ
.
yy59
->
ty³
 =ğ
TYPE_INTEGER
) {

1592 
yygÙomšÜ
.
yy87
 = 
	`bufãr_š™
();

1593 
	`bufãr_cİy_št
(
yygÙomšÜ
.
yy87
, ((
d©a_š‹g”
 *)
yym¥
[0].
mšÜ
.
yy59
)->
v®ue
);

1595 
	`årštf
(
¡d”r
, "operand must be string");

1596 
ùx
->
ok
 = 0;

1599 
yym¥
[0].
mšÜ
.
yy59
->
	`ä“
(yymsp[0].minor.yy59);

1600 
yym¥
[0].
mšÜ
.
yy59
 = 
NULL
;

1607 ià(
ùx
->
ok
) {

1608 ià(0 !ğ
	`cÚfig_·r£_fe
(
ùx
->
¤v
, ctx, 
yym¥
[0].
mšÜ
.
yy87
->
±r
)) {

1609 
ùx
->
ok
 = 0;

1611 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy87
);

1612 
yym¥
[0].
mšÜ
.
yy87
 = 
NULL
;

1616 
	`yy_de¡ruùÜ
(24,&
yym¥
[-1].
mšÜ
);

1621 ià(
ùx
->
ok
) {

1622 ià(0 !ğ
	`cÚfig_·r£_cmd
(
ùx
->
¤v
, ctx, 
yym¥
[0].
mšÜ
.
yy87
->
±r
)) {

1623 
ùx
->
ok
 = 0;

1625 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy87
);

1626 
yym¥
[0].
mšÜ
.
yy87
 = 
NULL
;

1630 
	`yy_de¡ruùÜ
(25,&
yym¥
[-1].
mšÜ
);

1633 
yygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

1634 
yysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

1635 
yypP¬£r
->
yyidx
 -ğ
yysize
;

1636 
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yypP¬£r
,
yygÙo
);

1637 ifĞ
yyaù
 < 
YYNSTATE
 ){

1638 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yygÙo
,&
yygÙomšÜ
);

1639 }ifĞ
yyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 ){

1640 
	`yy_acû±
(
yypP¬£r
);

1642 
	}
}

1647 
	$yy_·r£_çed
(

1648 
yyP¬£r
 *
yypP¬£r


1650 
cÚfig·r£rARG_FETCH
;

1651 #iâdeà
NDEBUG


1652 ifĞ
yyT¿ûFILE
 ){

1653 
	`årštf
(
yyT¿ûFILE
,"%sFa!\n",
yyT¿ûProm±
);

1656  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

1661 
ùx
->
ok
 = 0;

1664 
cÚfig·r£rARG_STORE
;

1665 
	}
}

1670 
	$yy_syÁax_”rÜ
(

1671 
yyP¬£r
 *
yypP¬£r
,

1672 
yymajÜ
,

1673 
YYMINORTYPE
 
yymšÜ


1675 
cÚfig·r£rARG_FETCH
;

1676 
	`UNUSED
(
yymajÜ
);

1677 
	`UNUSED
(
yymšÜ
);

1678 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

1679 
cÚfig·r£rARG_STORE
;

1680 
	}
}

1685 
	$yy_acû±
(

1686 
yyP¬£r
 *
yypP¬£r


1688 
cÚfig·r£rARG_FETCH
;

1689 #iâdeà
NDEBUG


1690 ifĞ
yyT¿ûFILE
 ){

1691 
	`årštf
(
yyT¿ûFILE
,"%sAcû±!\n",
yyT¿ûProm±
);

1694  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

1697 
cÚfig·r£rARG_STORE
;

1698 
	}
}

1719 
	$cÚfig·r£r
(

1720 *
yyp
,

1721 
yymajÜ
,

1722 
cÚfig·r£rTOKENTYPE
 
yymšÜ


1723 
cÚfig·r£rARG_PDECL


1725 
YYMINORTYPE
 
yymšÜuniÚ
;

1726 
yyaù
;

1727 
yy’dofšput
;

1728 
yy”rÜh™
 = 0;

1729 
yyP¬£r
 *
yypP¬£r
;

1732 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

1733 ifĞ
yypP¬£r
->
yyidx
<0 ){

1734 ifĞ
yymajÜ
==0 ) ;

1735 
yypP¬£r
->
yyidx
 = 0;

1736 
yypP¬£r
->
yy”rút
 = -1;

1737 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

1738 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

1740 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

1741 
yy’dofšput
 = (
yymajÜ
==0);

1742 
cÚfig·r£rARG_STORE
;

1744 #iâdeà
NDEBUG


1745 ifĞ
yyT¿ûFILE
 ){

1746 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

1751 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,
yymajÜ
);

1752 ifĞ
yyaù
<
YYNSTATE
 ){

1753 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

1754 
yypP¬£r
->
yy”rút
--;

1755 ifĞ
yy’dofšput
 && 
yypP¬£r
->
yyidx
>=0 ){

1756 
yymajÜ
 = 0;

1758 
yymajÜ
 = 
YYNOCODE
;

1760 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

1761 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

1762 }ifĞ
yyaù
 =ğ
YY_ERROR_ACTION
 ){

1763 
yymx
;

1764 #iâdeà
NDEBUG


1765 ifĞ
yyT¿ûFILE
 ){

1766 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

1769 #ifdeà
YYERRORSYMBOL


1789 ifĞ
yypP¬£r
->
yy”rút
<0 ){

1790 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1792 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

1793 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

1794 #iâdeà
NDEBUG


1795 ifĞ
yyT¿ûFILE
 ){

1796 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

1797 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

1800 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

1801 
yymajÜ
 = 
YYNOCODE
;

1804 
yypP¬£r
->
yyidx
 >= 0 &&

1805 
yymx
 !ğ
YYERRORSYMBOL
 &&

1806 (
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,
YYERRORSYMBOL
)è>ğ
YYNSTATE


1808 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

1810 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

1811 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

1812 
	`yy_·r£_çed
(
yypP¬£r
);

1813 
yymajÜ
 = 
YYNOCODE
;

1814 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

1815 
YYMINORTYPE
 
u2
;

1816 
u2
.
YYERRSYMDT
 = 0;

1817 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

1820 
yypP¬£r
->
yy”rút
 = 3;

1821 
yy”rÜh™
 = 1;

1832 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

1833 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

1835 
yypP¬£r
->
yy”rút
 = 3;

1836 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

1837 ifĞ
yy’dofšput
 ){

1838 
	`yy_·r£_çed
(
yypP¬£r
);

1840 
yymajÜ
 = 
YYNOCODE
;

1843 
	`yy_acû±
(
yypP¬£r
);

1844 
yymajÜ
 = 
YYNOCODE
;

1846 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

1848 
	}
}

	@configparser.h

1 
	#TK_EOL
 1

	)

2 
	#TK_ASSIGN
 2

	)

3 
	#TK_APPEND
 3

	)

4 
	#TK_LKEY
 4

	)

5 
	#TK_PLUS
 5

	)

6 
	#TK_STRING
 6

	)

7 
	#TK_INTEGER
 7

	)

8 
	#TK_LPARAN
 8

	)

9 
	#TK_RPARAN
 9

	)

10 
	#TK_COMMA
 10

	)

11 
	#TK_ARRAY_ASSIGN
 11

	)

12 
	#TK_GLOBAL
 12

	)

13 
	#TK_LCURLY
 13

	)

14 
	#TK_RCURLY
 14

	)

15 
	#TK_ELSE
 15

	)

16 
	#TK_DOLLAR
 16

	)

17 
	#TK_SRVVARNAME
 17

	)

18 
	#TK_LBRACKET
 18

	)

19 
	#TK_RBRACKET
 19

	)

20 
	#TK_EQ
 20

	)

21 
	#TK_MATCH
 21

	)

22 
	#TK_NE
 22

	)

23 
	#TK_NOMATCH
 23

	)

24 
	#TK_INCLUDE
 24

	)

25 
	#TK_INCLUDE_SHELL
 25

	)

	@connections-glue.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"cÚÃùiÚs.h
"

5 
	~"jobli¡.h
"

6 
	~"log.h
"

8 
	~<”ºo.h
>

10 #ifdeà
USE_OPENSSL


11 
	~<İ’s¦/s¦.h
>

12 
	~<İ’s¦/”r.h
>

15 cÚ¡ *
	$cÚÃùiÚ_g‘_¡©e
(
cÚÃùiÚ_¡©e_t
 
¡©e
) {

16 
¡©e
) {

17 
CON_STATE_CONNECT
:  "connect";

18 
CON_STATE_READ
:  "read";

19 
CON_STATE_READ_POST
:  "readpost";

20 
CON_STATE_WRITE
:  "write";

21 
CON_STATE_CLOSE
:  "close";

22 
CON_STATE_ERROR
:  "error";

23 
CON_STATE_HANDLE_REQUEST
:  "handle-req";

24 
CON_STATE_REQUEST_START
:  "req-start";

25 
CON_STATE_REQUEST_END
:  "req-end";

26 
CON_STATE_RESPONSE_START
:  "resp-start";

27 
CON_STATE_RESPONSE_END
:  "resp-end";

30 
	}
}

32 cÚ¡ *
	$cÚÃùiÚ_g‘_shÜt_¡©e
(
cÚÃùiÚ_¡©e_t
 
¡©e
) {

33 
¡©e
) {

34 
CON_STATE_CONNECT
:  ".";

35 
CON_STATE_READ
:  "r";

36 
CON_STATE_READ_POST
:  "R";

37 
CON_STATE_WRITE
:  "W";

38 
CON_STATE_CLOSE
:  "C";

39 
CON_STATE_ERROR
:  "E";

40 
CON_STATE_HANDLE_REQUEST
:  "h";

41 
CON_STATE_REQUEST_START
:  "q";

42 
CON_STATE_REQUEST_END
:  "Q";

43 
CON_STATE_RESPONSE_START
:  "s";

44 
CON_STATE_RESPONSE_END
:  "S";

47 
	}
}

49 
	$cÚÃùiÚ_£t_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
cÚÃùiÚ_¡©e_t
 
¡©e
) {

50 
	`UNUSED
(
¤v
);

52 
cÚ
->
¡©e
 = state;

55 
	}
}

58 
	$dump_·ck‘
(cÚ¡ *
d©a
, 
size_t
 
Ën
) {

59 
size_t
 
i
, 
j
;

61 ià(
Ën
 == 0) ;

63 
i
 = 0; i < 
Ën
; i++) {

64 ià(
i
 % 16 =ğ0è
	`årštf
(
¡d”r
, " ");

66 
	`årštf
(
¡d”r
, "%02x ", 
d©a
[
i
]);

68 ià((
i
 + 1) % 16 == 0) {

69 
	`årštf
(
¡d”r
, " ");

70 
j
 = 0; j <ğ
i
 % 16; j++) {

71 
c
;

73 ià(
i
-15+
j
 >ğ
Ën
) ;

75 
c
 = 
d©a
[
i
-15+
j
];

77 
	`årštf
(
¡d”r
, "%c", 
c
 > 32 && c < 128 ? c : '.');

80 
	`årštf
(
¡d”r
, "\n");

84 ià(
Ën
 % 16 != 0) {

85 
j
 = 
i
 % 16; j < 16; j++) {

86 
	`årštf
(
¡d”r
, " ");

89 
	`årštf
(
¡d”r
, " ");

90 
j
 = 
i
 & ~0xf; j < 
Ën
; j++) {

91 
c
;

93 
c
 = 
d©a
[
j
];

94 
	`årštf
(
¡d”r
, "%c", 
c
 > 32 && c < 128 ? c : '.');

96 
	`årštf
(
¡d”r
, "\n");

98 
	}
}

101 
	$cÚÃùiÚ_hªdË_»ad_s¦
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

102 #ifdeà
USE_OPENSSL


103 
r
, 
s¦_”r
, 
Ën
;

104 *
mem
 = 
NULL
;

105 
size_t
 
mem_Ën
 = 0;

107 ià(!
cÚ
->
¤v_sock‘
->
is_s¦
)  -1;

109 
	`ERR_ş—r_”rÜ
();

111 
	`chunkqueue_g‘_memÜy
(
cÚ
->
»ad_queue
, &
mem
, &
mem_Ën
, 0, 
	`SSL_³ndšg
(cÚ->
s¦
));

114 
	`mem£t
(
mem
, 0, 
mem_Ën
);

117 
Ën
 = 
	`SSL_»ad
(
cÚ
->
s¦
, 
mem
, 
mem_Ën
);

118 ià(
Ën
 > 0) {

119 
	`chunkqueue_u£_memÜy
(
cÚ
->
»ad_queue
, 
Ën
);

120 
cÚ
->
by‹s_»ad
 +ğ
Ën
;

122 
	`chunkqueue_u£_memÜy
(
cÚ
->
»ad_queue
, 0);

125 ià(
cÚ
->
»ÃgÙŸtiÚs
 > 1 && cÚ->
cÚf
.
s¦_di§bË_ş›Á_»ÃgÙŸtiÚ
) {

126 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "SSL:„enegotiation initiated by client, killing connection");

127 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

130 } 
Ën
 > 0 && (
cÚ
->
cÚf
.
s¦_»ad_ah—d
 || 
	`SSL_³ndšg
(cÚ->
s¦
) > 0));

132 ià(
Ën
 < 0) {

133 
Û¼no
 = 
”ºo
;

134 (
r
 = 
	`SSL_g‘_”rÜ
(
cÚ
->
s¦
, 
Ën
))) {

135 
SSL_ERROR_WANT_WRITE
:

136 
cÚ
->
is_wr™abË
 = -1;

137 
SSL_ERROR_WANT_READ
:

138 
cÚ
->
is_»adabË
 = 0;

145 
SSL_ERROR_SYSCALL
:

158 (
s¦_”r
 = 
	`ERR_g‘_”rÜ
())) {

160 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds", "SSL:",

161 
r
, 
	`ERR_”rÜ_¡ršg
(
s¦_”r
, 
NULL
));

164 
Û¼no
) {

166 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddds", "SSL:",

167 
Ën
, 
r
, 
Û¼no
,

168 
	`¡»¼Ü
(
Û¼no
));

173 
SSL_ERROR_ZERO_RETURN
:

176 ià(
r
 == 0) {

182 (
s¦_”r
 = 
	`ERR_g‘_”rÜ
())) {

183 
	`ERR_GET_REASON
(
s¦_”r
)) {

184 
SSL_R_SSL_HANDSHAKE_FAILURE
:

185 #ifdeà
SSL_R_TLSV1_ALERT_UNKNOWN_CA


186 
SSL_R_TLSV1_ALERT_UNKNOWN_CA
:

188 #ifdeà
SSL_R_SSLV3_ALERT_CERTIFICATE_UNKNOWN


189 
SSL_R_SSLV3_ALERT_CERTIFICATE_UNKNOWN
:

191 #ifdeà
SSL_R_SSLV3_ALERT_BAD_CERTIFICATE


192 
SSL_R_SSLV3_ALERT_BAD_CERTIFICATE
:

194 ià(!
cÚ
->
cÚf
.
log_s¦_noi£
) ;

200 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds", "SSL:",

201 
r
, 
	`ERR_”rÜ_¡ršg
(
s¦_”r
, 
NULL
));

206 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

209 } ià(
Ën
 == 0) {

210 
cÚ
->
is_»adabË
 = 0;

218 
	`UNUSED
(
¤v
);

219 
	`UNUSED
(
cÚ
);

222 
	}
}

225 
	$cÚÃùiÚ_hªdË_»ad
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

226 
Ën
;

227 *
mem
 = 
NULL
;

228 
size_t
 
mem_Ën
 = 0;

229 
tÜ—d
;

231 ià(
cÚ
->
¤v_sock‘
->
is_s¦
) {

232  
	`cÚÃùiÚ_hªdË_»ad_s¦
(
¤v
, 
cÚ
);

240 #ià
	`defšed
(
__WIN32
)

241 
	`chunkqueue_g‘_memÜy
(
cÚ
->
»ad_queue
, &
mem
, &
mem_Ën
, 0, 4096);

243 
Ën
 = 
	`»cv
(
cÚ
->
fd
, 
mem
, 
mem_Ën
, 0);

245 ià(
	`ioùl
(
cÚ
->
fd
, 
FIONREAD
, &
tÜ—d
) ||oread <= 4*1024) {

246 
tÜ—d
 = 4096;

248 ià(
tÜ—d
 > 
MAX_READ_LIMIT
) {

249 
tÜ—d
 = 
MAX_READ_LIMIT
;

251 
	`chunkqueue_g‘_memÜy
(
cÚ
->
»ad_queue
, &
mem
, &
mem_Ën
, 0, 
tÜ—d
);

253 
Ën
 = 
	`»ad
(
cÚ
->
fd
, 
mem
, 
mem_Ën
);

256 
	`chunkqueue_u£_memÜy
(
cÚ
->
»ad_queue
, 
Ën
 > 0 ?†en : 0);

258 ià(
Ën
 < 0) {

259 
cÚ
->
is_»adabË
 = 0;

261 #ià
	`defšed
(
__WIN32
)

263 
Ï¡E¼Ü
 = 
	`WSAG‘La¡E¼Ü
();

264 
Ï¡E¼Ü
) {

265 
EAGAIN
:

267 
EINTR
:

269 
cÚ
->
is_»adabË
 = 1;

271 
ECONNRESET
:

275 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "cÚÃùiÚ clo£d -„ecv faed: ", 
Ï¡E¼Ü
);

280 
”ºo
) {

281 
EAGAIN
:

283 
EINTR
:

285 
cÚ
->
is_»adabË
 = 1;

287 
ECONNRESET
:

291 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "cÚÃùiÚ clo£d -„—d faed: ", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

296 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

299 } ià(
Ën
 == 0) {

300 
cÚ
->
is_»adabË
 = 0;

306 } ià(
Ën
 !ğ(
ssize_t
è
mem_Ën
) {

309 
cÚ
->
is_»adabË
 = 0;

312 
cÚ
->
by‹s_»ad
 +ğ
Ën
;

314 
	`dump_·ck‘
(
b
->
±r
, 
Ën
);

318 
	}
}

320 
	$cÚÃùiÚ_hªdË_»ad_po¡_cq_com·ù
(
chunkqueue
 *
cq
) {

323 
chunk
 *
c
;

324 
NULL
 !ğ(
c
 = 
cq
->
fœ¡
è&& NULL !ğc->
Ãxt
) {

325 
bufãr
 *
mem
 = 
c
->
Ãxt
->mem;

326 
off_t
 
off£t
 = 
c
->
Ãxt
->offset;

327 
size_t
 
bËn
 = 
	`bufãr_¡ršg_Ëngth
(
mem
è- (size_t)
off£t
;

328 
	`fÜû_as£¹
(
c
->
ty³
 =ğ
MEM_CHUNK
);

329 
	`fÜû_as£¹
(
c
->
Ãxt
->
ty³
 =ğ
MEM_CHUNK
);

330 
	`bufãr_­³nd_¡ršg_Ën
(
c
->
mem
, mem->
±r
+
off£t
, 
bËn
);

331 
c
->
Ãxt
->
off£t
 = c->offset;

332 
c
->
Ãxt
->
mem
 = c->mem;

333 
c
->
mem
 = mem;

334 
c
->
off£t
 = off£ˆ+ (
off_t
)
bËn
;

335 
	`chunkqueue_»move_fšished_chunks
(
cq
);

336 ià(0 !ğ
bËn
)  1;

339 
	}
}

341 
	$cÚÃùiÚ_hªdË_»ad_po¡_chunked_ülf
(
chunkqueue
 *
cq
) {

344 
chunk
 *
c
;

345 
bufãr
 *
b
;

346 *
p
;

347 
size_t
 
Ën
;

351 ià(
	`chunkqueue_is_em±y
(
cq
))  0;

353 
c
 = 
cq
->
fœ¡
;

354 
b
 = 
c
->
mem
;

355 
p
 = 
b
->
±r
+
c
->
off£t
;

356 ià(
p
[0] != '\r')  -1;

357 ià(
p
[1] == '\n')  1;

358 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
è- (
size_t
)
c
->
off£t
;

359 ià(1 !ğ
Ën
)  -1;

361 
NULL
 !ğ(
c
 = c->
Ãxt
)) {

362 
b
 = 
c
->
mem
;

363 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
è- (
size_t
)
c
->
off£t
;

364 ià(0 =ğ
Ën
) ;

365 
p
 = 
b
->
±r
+
c
->
off£t
;

366  (
p
[0] == '\n') ? 1 : -1;

369 
	}
}

371 
hªdËr_t
 
	$cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
h‰p_¡©us
) {

372 
	`UNUSED
(
¤v
);

374 
cÚ
->
k“p_®ive
 = 0;

377 ià(0 !ğ
cÚ
->
by‹s_h—d”
è 
HANDLER_ERROR
;

379 
cÚ
->
h‰p_¡©us
 = http_status;

380 
cÚ
->
mode
 = 
DIRECT
;

381 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

382  
HANDLER_FINISHED
;

383 
	}
}

385 
hªdËr_t
 
	$cÚÃùiÚ_hªdË_»ad_po¡_chunked
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
chunkqueue
 *
cq
, chunkqueu*
d¡_cq
) {

388 cÚ¡ 
off_t
 
max_»que¡_size
 = (off_t)
cÚ
->
cÚf
.max_request_size << 10;

389 
off_t
 
‹_chunked
 = 
cÚ
->
»que¡
.te_chunked;

391 
off_t
 
Ën
 = 
cq
->
by‹s_š
 - cq->
by‹s_out
;

393 0 =ğ
‹_chunked
) {

394 *
p
;

395 
chunk
 *
c
 = 
cq
->
fœ¡
;

396 
	`fÜû_as£¹
(
c
->
ty³
 =ğ
MEM_CHUNK
);

397 
p
 = 
	`¡rchr
(
c
->
mem
->
±r
+c->
off£t
, '\n');

398 ià(
NULL
 !ğ
p
) {

399 
off_t
 
hsz
 = 
p
 + 1 - (
c
->
mem
->
±r
+c->
off£t
);

400 *
s
 = (*)
c
->
mem
->
±r
+c->
off£t
;

401 
u
;(u=()
	`hex2št
(*
s
))!=0xFF;++s) {

402 ià(
‹_chunked
 > (~((
off_t
)-1) >> 4)) {

403 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

406  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 400);

408 
‹_chunked
 <<= 4;

409 
‹_chunked
 |ğ
u
;

411 *
s
 == ' ' || *s == '\t') ++s;

412 ià(*
s
 != '\r' && *s != ';') {

413 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

416  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 400);

419 ià(
hsz
 >= 1024) {

422 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

425  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 400);

428 ià(0 =ğ
‹_chunked
) {

432 ià(
p
[0] == '\r' &&…[1] == '\n') {

434 
hsz
 += 2;

438 
hsz
 -= 2;

440 
c
 = 
cq
->
fœ¡
;

441 
p
 = 
	`¡r¡r
(
c
->
mem
->
±r
+c->
off£t
+
hsz
, "\r\n\r\n");

442 } 
NULL
 =ğ
p


443 && 
	`cÚÃùiÚ_hªdË_»ad_po¡_cq_com·ù
(
cq
));

444 ià(
NULL
 =ğ
p
) {

448 ià((
off_t
)
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t


449 < 
¤v
->
¤vcÚf
.
max_»que¡_f›ld_size
) {

455 
cÚ
->
k“p_®ive
 = 0;

458 
hsz
 = 
p
 + 4 - (
c
->
mem
->
±r
+c->
off£t
);

464 
	`chunkqueue_m¬k_wr™‹n
(
cq
, (
size_t
)
hsz
);

465 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 = 
d¡_cq
->
by‹s_š
;

470 
	`chunkqueue_m¬k_wr™‹n
(
cq
, (
size_t
)
hsz
);

471 
Ën
 = 
cq
->
by‹s_š
 - cq->
by‹s_out
;

473 ià(0 !=
max_»que¡_size


474 && (
max_»que¡_size
 < 
‹_chunked


475 || 
max_»que¡_size
 - 
‹_chunked
 < 
d¡_cq
->
by‹s_š
)) {

476 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sos",

478 
d¡_cq
->
by‹s_š
 + 
‹_chunked
, "-> 413");

480  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 413);

483 
‹_chunked
 += 2;

490 ià((
off_t
)
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
 >= 1024) {

491 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

494  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 400);

496 ià(!
	`cÚÃùiÚ_hªdË_»ad_po¡_cq_com·ù
(
cq
)) {

500 ià(0 =ğ
‹_chunked
) ;

502 ià(
‹_chunked
 > 2) {

503 ià(
Ën
 > 
‹_chunked
-2)†en =e_chunked-2;

504 ià(
d¡_cq
->
by‹s_š
 + 
‹_chunked
 <= 64*1024) {

506 
	`chunkqueue_¡—l
(
d¡_cq
, 
cq
, 
Ën
);

508 ià(0 !ğ
	`chunkqueue_¡—l_w™h_‹mpfes
(
¤v
,
d¡_cq
,
cq
,
Ën
)) {

510  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 500);

512 
‹_chunked
 -ğ
Ën
;

513 
Ën
 = 
cq
->
by‹s_š
 - cq->
by‹s_out
;

516 ià(
Ën
 < 
‹_chunked
) ;

518 ià(2 =ğ
‹_chunked
) {

519 ià(-1 =ğ
	`cÚÃùiÚ_hªdË_»ad_po¡_chunked_ülf
(
cq
)) {

520 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

523  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 400);

525 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 2);

526 
‹_chunked
 -= 2;

529 } !
	`chunkqueue_is_em±y
(
cq
));

531 
cÚ
->
»que¡
.
‹_chunked
 =e_chunked;

532  
HANDLER_GO_ON
;

533 
	}
}

535 
hªdËr_t
 
	$cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

536 
chunkqueue
 *
cq
 = 
cÚ
->
»ad_queue
;

537 
chunkqueue
 *
d¡_cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

539 
is_şo£d
 = 0;

541 ià(
cÚ
->
is_»adabË
) {

542 
cÚ
->
»ad_idË_ts
 = 
¤v
->
cur_ts
;

544 
	`cÚÃùiÚ_hªdË_»ad
(
¤v
, 
cÚ
)) {

546  
HANDLER_ERROR
;

548 
is_şo£d
 = 1;

555 
	`chunkqueue_»move_fšished_chunks
(
cq
);

557 ià(-1 =ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

558 
hªdËr_t
 
rc
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_chunked
(
¤v
, 
cÚ
, 
cq
, 
d¡_cq
);

559 ià(
HANDLER_GO_ON
 !ğ
rc
) „c;

561 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 <= 64*1024) {

563 
	`chunkqueue_¡—l
(
d¡_cq
, 
cq
, (
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 - d¡_cq->
by‹s_š
);

565 ià(0 !ğ
	`chunkqueue_¡—l_w™h_‹mpfes
(
¤v
, 
d¡_cq
, 
cq
, (
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 - d¡_cq->
by‹s_š
)) {

567  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 500);

570 
	`chunkqueue_»move_fšished_chunks
(
cq
);

572 ià(
d¡_cq
->
by‹s_š
 =ğ(
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

574 
cÚ
->
cÚf
.
¡»am_»que¡_body
 &ğ~
FDEVENT_STREAM_REQUEST_POLLIN
;

575 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST
) {

576 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_HANDLE_REQUEST
);

578  
HANDLER_GO_ON
;

579 } ià(
is_şo£d
) {

581  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 400);

583  
HANDLER_ERROR
;

585 
cÚ
->
cÚf
.
¡»am_»que¡_body
 |ğ
FDEVENT_STREAM_REQUEST_POLLIN
;

586  (
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST
)

587 ? 
HANDLER_GO_ON


588 : 
HANDLER_WAIT_FOR_EVENT
;

590 
	}
}

592 
	$cÚÃùiÚ_»¥Ú£_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

593 
	`UNUSED
(
¤v
);

595 
cÚ
->
mode
 = 
DIRECT
;

596 
cÚ
->
h‰p_¡©us
 = 0;

597 
cÚ
->
is_wr™abË
 = 1;

598 
cÚ
->
fe_fšished
 = 0;

599 
cÚ
->
fe_¡¬‹d
 = 0;

600 
cÚ
->
gÙ_»¥Ú£
 = 0;

601 
cÚ
->
·r£d_»¥Ú£
 = 0;

602 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

603 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = -1;

604 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 = 0;

605 ià(
cÚ
->
physiÿl
.
·th
) {

606 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
doc_roÙ
);

607 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

608 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
ba£dœ
);

609 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
»l_·th
);

610 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
‘ag
);

612 
	`¬¿y_»£t
(
cÚ
->
»¥Ú£
.
h—d”s
);

613 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

614 
	}
}

	@connections.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"£rv”.h
"

5 
	~"log.h
"

6 
	~"cÚÃùiÚs.h
"

7 
	~"fdev’t.h
"

9 
	~"cÚfigfe.h
"

10 
	~"»que¡.h
"

11 
	~"»¥Ú£.h
"

12 
	~"ÃtwÜk.h
"

13 
	~"h‰p_chunk.h
"

14 
	~"¡©_ÿche.h
"

15 
	~"jobli¡.h
"

17 
	~"¶ugš.h
"

19 
	~"š‘_Áİ_ÿche.h
"

21 
	~<sys/¡©.h
>

23 
	~<¡dlib.h
>

24 
	~<¡dio.h
>

25 
	~<uni¡d.h
>

26 
	~<”ºo.h
>

27 
	~<¡ršg.h
>

28 
	~<fú.h
>

29 
	~<as£¹.h
>

31 #ifdeà
USE_OPENSSL


32 
	~<İ’s¦/s¦.h
>

33 
	~<İ’s¦/”r.h
>

36 #ifdeà
HAVE_SYS_FILIO_H


37 
	~<sys/fio.h
>

40 
	~"sys-sock‘.h
"

43 
	mPLUGIN_DATA
;

44 } 
	t¶ugš_d©a
;

46 
cÚÃùiÚ
 *
	$cÚÃùiÚs_g‘_Ãw_cÚÃùiÚ
(
£rv”
 *
¤v
) {

47 
cÚÃùiÚs
 *
cÚns
 = 
¤v
->conns;

48 
size_t
 
i
;

50 ià(
cÚns
->
size
 == 0) {

51 
cÚns
->
size
 = 128;

52 
cÚns
->
±r
 = 
NULL
;

53 
cÚns
->
±r
 = 
	`m®loc
((*cÚns->±rè* cÚns->
size
);

54 
	`fÜû_as£¹
(
NULL
 !ğ
cÚns
->
±r
);

55 
i
 = 0; i < 
cÚns
->
size
; i++) {

56 
cÚns
->
±r
[
i
] = 
	`cÚÃùiÚ_š™
(
¤v
);

58 } ià(
cÚns
->
size
 =ğcÚns->
u£d
) {

59 
cÚns
->
size
 += 128;

60 
cÚns
->
±r
 = 
	`»®loc
(cÚns->±r, (*cÚns->±rè* cÚns->
size
);

61 
	`fÜû_as£¹
(
NULL
 !ğ
cÚns
->
±r
);

63 
i
 = 
cÚns
->
u£d
; i < cÚns->
size
; i++) {

64 
cÚns
->
±r
[
i
] = 
	`cÚÃùiÚ_š™
(
¤v
);

68 
	`cÚÃùiÚ_»£t
(
¤v
, 
cÚns
->
±r
[cÚns->
u£d
]);

70 
	`årštf
(
¡d”r
, "%s.%d:‡dd: ", 
__FILE__
, 
__LINE__
);

71 
i
 = 0; i < 
cÚns
->
u£d
 + 1; i++) {

72 
	`årštf
(
¡d”r
, "%d ", 
cÚns
->
±r
[
i
]->
fd
);

74 
	`årštf
(
¡d”r
, "\n");

77 
cÚns
->
±r
[cÚns->
u£d
]->
ndx
 = conns->used;

78  
cÚns
->
±r
[cÚns->
u£d
++];

79 
	}
}

81 
	$cÚÃùiÚ_d–
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

82 
size_t
 
i
;

83 
cÚÃùiÚs
 *
cÚns
 = 
¤v
->conns;

84 
cÚÃùiÚ
 *
‹mp
;

86 ià(
cÚ
 =ğ
NULL
)  -1;

88 ià(-1 =ğ
cÚ
->
ndx
)  -1;

90 
	`bufãr_»£t
(
cÚ
->
uri
.
authÜ™y
);

91 
	`bufãr_»£t
(
cÚ
->
uri
.
·th
);

92 
	`bufãr_»£t
(
cÚ
->
uri
.
qu”y
);

93 
	`bufãr_»£t
(
cÚ
->
»que¡
.
Üig_uri
);

95 
i
 = 
cÚ
->
ndx
;

99 ià(
i
 !ğ
cÚns
->
u£d
 - 1) {

100 
‹mp
 = 
cÚns
->
±r
[
i
];

101 
cÚns
->
±r
[
i
] = cÚns->±r[cÚns->
u£d
 - 1];

102 
cÚns
->
±r
[cÚns->
u£d
 - 1] = 
‹mp
;

104 
cÚns
->
±r
[
i
]->
ndx
 = i;

105 
cÚns
->
±r
[cÚns->
u£d
 - 1]->
ndx
 = -1;

108 
cÚns
->
u£d
--;

110 
cÚ
->
ndx
 = -1;

112 
	`årštf
(
¡d”r
, "%s.%d: d–: (%d)", 
__FILE__
, 
__LINE__
, 
cÚns
->
u£d
);

113 
i
 = 0; i < 
cÚns
->
u£d
; i++) {

114 
	`årštf
(
¡d”r
, "%d ", 
cÚns
->
±r
[
i
]->
fd
);

116 
	`årštf
(
¡d”r
, "\n");

119 
	}
}

121 
	$cÚÃùiÚ_şo£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

122 #ifdeà
USE_OPENSSL


123 
£rv”_sock‘
 *
¤v_sock
 = 
cÚ
->
¤v_sock‘
;

124 ià(
¤v_sock
->
is_s¦
) {

125 ià(
cÚ
->
s¦
è
	`SSL_ä“
(con->ssl);

126 
cÚ
->
s¦
 = 
NULL
;

130 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
cÚ
->
fde_ndx
), cÚ->
fd
);

131 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
cÚ
->
fd
);

132 #ifdeà
__WIN32


133 ià(
	`şo£sock‘
(
cÚ
->
fd
)) {

134 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

135 "(w¬nšgèşo£:", 
cÚ
->
fd
, 
	`¡»¼Ü
(
”ºo
));

138 ià(
	`şo£
(
cÚ
->
fd
)) {

139 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

140 "(w¬nšgèşo£:", 
cÚ
->
fd
, 
	`¡»¼Ü
(
”ºo
));

144 
¤v
->
cur_fds
--;

147 ià(
¤v
->
¤vcÚf
.
log_¡©e_hªdlšg
) {

148 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

149 "cÚÃùiÚ clo£d fÜ fd", 
cÚ
->
fd
);

151 
cÚ
->
fd
 = -1;

152 
	`cÚÃùiÚ_d–
(
¤v
, 
cÚ
);

153 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_CONNECT
);

156 
	}
}

158 
	$cÚÃùiÚ_»ad_fÜ_eos
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

164 
ssize_t
 
Ën
;

165 
buf
[4096];

168 
Ën
 = 
	`»ad
(
cÚ
->
fd
, 
buf
, (buf));

169 } 
Ën
 > 0 || (ËÀ< 0 && 
”ºo
 =ğ
EINTR
));

171 ià(
Ën
 < 0 && 
”ºo
 =ğ
EAGAIN
) ;

172 #ià
	`defšed
(
EWOULDBLOCK
è&& EWOULDBLOCK !ğ
EAGAIN


173 ià(
Ën
 < 0 && 
”ºo
 =ğ
EWOULDBLOCK
) ;

177 
cÚ
->
şo£_timeout_ts
 = 
¤v
->
cur_ts
 - (
HTTP_LINGER_TIMEOUT
+1);

178 
	}
}

180 
	$cÚÃùiÚ_hªdË_şo£_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

181 
	`cÚÃùiÚ_»ad_fÜ_eos
(
¤v
, 
cÚ
);

183 ià(
¤v
->
cur_ts
 - 
cÚ
->
şo£_timeout_ts
 > 
HTTP_LINGER_TIMEOUT
) {

184 
	`cÚÃùiÚ_şo£
(
¤v
, 
cÚ
);

186 
	}
}

188 
	$cÚÃùiÚ_hªdË_shutdown
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

189 
r
;

191 #ifdeà
USE_OPENSSL


192 
£rv”_sock‘
 *
¤v_sock
 = 
cÚ
->
¤v_sock‘
;

193 ià(
¤v_sock
->
is_s¦
 && 
	`SSL_is_š™_fšished
(
cÚ
->
s¦
)) {

194 
»t
, 
s¦_r
;

195 
”r
;

196 
	`ERR_ş—r_”rÜ
();

197 (
»t
 = 
	`SSL_shutdown
(
cÚ
->
s¦
))) {

207 
	`ERR_ş—r_”rÜ
();

208 ià(-1 !ğ(
»t
 = 
	`SSL_shutdown
(
cÚ
->
s¦
))) ;

213 (
s¦_r
 = 
	`SSL_g‘_”rÜ
(
cÚ
->
s¦
, 
»t
))) {

214 
SSL_ERROR_ZERO_RETURN
:

216 
SSL_ERROR_WANT_WRITE
:

218 
SSL_ERROR_WANT_READ
:

220 
SSL_ERROR_SYSCALL
:

222 ià(0 !ğ(
”r
 = 
	`ERR_g‘_”rÜ
())) {

224 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdds", "SSL:",

225 
s¦_r
, 
»t
,

226 
	`ERR_”rÜ_¡ršg
(
”r
, 
NULL
));

227 } (
”r
 = 
	`ERR_g‘_”rÜ
()));

228 } ià(
”ºo
 != 0) {

229 
”ºo
) {

230 
EPIPE
:

231 
ECONNRESET
:

234 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddds", "SSL (error):",

235 
s¦_r
, 
»t
, 
”ºo
,

236 
	`¡»¼Ü
(
”ºo
));

243 (
”r
 = 
	`ERR_g‘_”rÜ
())) {

244 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdds", "SSL:",

245 
s¦_r
, 
»t
,

246 
	`ERR_”rÜ_¡ršg
(
”r
, 
NULL
));

252 
	`ERR_ş—r_”rÜ
();

256 
r
 = 
	`¶ugšs_ÿÎ_hªdË_cÚÃùiÚ_şo£
(
¤v
, 
cÚ
)) {

257 
HANDLER_GO_ON
:

258 
HANDLER_FINISHED
:

261 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "unhªdlšg„‘uº v®ue", 
r
);

265 
¤v
->
cÚ_şo£d
++;

266 
	`cÚÃùiÚ_»£t
(
¤v
, 
cÚ
);

269 
size_t
 
i
 = 0; i < 
¤v
->
¶ugšs
.
u£d
; ++i) {

270 
¶ugš
 *
p
 = (Õlugš **)(
¤v
->
¶ugšs
.
±r
))[
i
];

271 
¶ugš_d©a
 *
pd
 = 
p
->
d©a
;

272 ià(!
pd
 || 
NULL
 =ğ
cÚ
->
¶ugš_ùx
[pd->
id
]) ;

273 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

274 "missšg cËªu°š", 
p
->
Çme
);

275 
cÚ
->
¶ugš_ùx
[
pd
->
id
] = 
NULL
;

279 ià((0 =ğ
	`shutdown
(
cÚ
->
fd
, 
SHUT_WR
))) {

280 
cÚ
->
şo£_timeout_ts
 = 
¤v
->
cur_ts
;

281 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_CLOSE
);

283 ià(
¤v
->
¤vcÚf
.
log_¡©e_hªdlšg
) {

284 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

285 "shutdowÀfÜ fd", 
cÚ
->
fd
);

288 
	`cÚÃùiÚ_şo£
(
¤v
, 
cÚ
);

290 
	}
}

292 
	$cÚÃùiÚ_hªdË_»¥Ú£_’d_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

295 ià(
cÚ
->
h‰p_¡©us
) {

296 
	`¶ugšs_ÿÎ_hªdË_»que¡_dÚe
(
¤v
, 
cÚ
);

299 ià(
cÚ
->
¡©e
 !ğ
CON_STATE_ERROR
è
¤v
->
cÚ_wr™‹n
++;

301 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 !ğcÚ->
»que¡_cÚ‹Á_queue
->
by‹s_š


302 || 
cÚ
->
¡©e
 =ğ
CON_STATE_ERROR
) {

304 
cÚ
->
k“p_®ive
 = 0;

307 ià(
cÚ
->
k“p_®ive
) {

308 
	`cÚÃùiÚ_»£t
(
¤v
, 
cÚ
);

310 
cÚ
->
»que¡_¡¬t
 = 
¤v
->
cur_ts
;

311 
cÚ
->
»ad_idË_ts
 = 
¤v
->
cur_ts
;

313 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_REQUEST_START
);

315 
	`cÚÃùiÚ_hªdË_shutdown
(
¤v
, 
cÚ
);

317 
	}
}

319 
	$cÚÃùiÚ_hªdË_”rdoc_š™
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

323 
bufãr
 *
www_auth
 = 
NULL
;

324 ià(401 =ğ
cÚ
->
h‰p_¡©us
) {

325 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "WWW-Authenticate");

326 ià(
NULL
 !ğ
ds
) {

327 
www_auth
 = 
	`bufãr_š™_bufãr
(
ds
->
v®ue
);

331 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 = 0;

332 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

333 
	`¬¿y_»£t
(
cÚ
->
»¥Ú£
.
h—d”s
);

334 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

336 ià(
NULL
 !ğ
www_auth
) {

337 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("WWW-Auth’tiÿ‹"), 
	`CONST_BUF_LEN
(
www_auth
));

338 
	`bufãr_ä“
(
www_auth
);

340 
	}
}

342 
	$cÚÃùiÚ_hªdË_wr™e_´•¬e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

343 ià(
cÚ
->
mode
 =ğ
DIRECT
) {

345 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

346 
HTTP_METHOD_GET
:

347 
HTTP_METHOD_POST
:

348 
HTTP_METHOD_HEAD
:

350 
HTTP_METHOD_OPTIONS
:

356 ià((!
cÚ
->
h‰p_¡©us
 || cÚ->h‰p_¡©u =ğ200è&& !
	`bufãr_¡ršg_is_em±y
(cÚ->
uri
.
·th
) &&

357 
cÚ
->
uri
.
·th
->
±r
[0] != '*') {

358 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Allow"), CONST_STR_LEN("OPTIONS, GET, HEAD, POST"));

360 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 &ğ~
HTTP_TRANSFER_ENCODING_CHUNKED
;

361 
cÚ
->
·r£d_»¥Ú£
 &ğ~
HTTP_CONTENT_LENGTH
;

363 
cÚ
->
h‰p_¡©us
 = 200;

364 
cÚ
->
fe_fšished
 = 1;

366 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

370 ià(0 =ğ
cÚ
->
h‰p_¡©us
) {

371 
cÚ
->
h‰p_¡©us
 = 501;

377 ià(
cÚ
->
h‰p_¡©us
 == 0) {

378 
cÚ
->
h‰p_¡©us
 = 403;

381 
cÚ
->
h‰p_¡©us
) {

386 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 &ğ~
HTTP_TRANSFER_ENCODING_CHUNKED
;

387 
cÚ
->
·r£d_»¥Ú£
 &ğ~
HTTP_CONTENT_LENGTH
;

388 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

390 
cÚ
->
fe_fšished
 = 1;

393 ià(
cÚ
->
mode
 !ğ
DIRECT
) ;

396 ià(
cÚ
->
h‰p_¡©us
 < 400 || con->http_status >= 600) ;

398 
cÚ
->
fe_fšished
 = 0;

400 
	`cÚÃùiÚ_hªdË_”rdoc_š™
(
¤v
, 
cÚ
);

403 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
cÚf
.
”rÜfe_´efix
)) {

404 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

406 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, cÚ->
cÚf
.
”rÜfe_´efix
);

407 
	`bufãr_­³nd_št
(
cÚ
->
physiÿl
.
·th
, cÚ->
h‰p_¡©us
);

408 
	`bufãr_­³nd_¡ršg_Ën
(
cÚ
->
physiÿl
.
·th
, 
	`CONST_STR_LEN
(".html"));

410 ià(0 =ğ
	`h‰p_chunk_­³nd_fe
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
)) {

411 
cÚ
->
fe_fšished
 = 1;

412 ià(
HANDLER_ERROR
 !ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

413 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
sû
->
cÚ‹Á_ty³
));

418 ià(!
cÚ
->
fe_fšished
) {

419 
bufãr
 *
b
;

421 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

423 
cÚ
->
fe_fšished
 = 1;

424 
b
 = 
	`bufãr_š™
();

427 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

434 
	`bufãr_­³nd_št
(
b
, 
cÚ
->
h‰p_¡©us
);

435 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" - "));

436 
	`bufãr_­³nd_¡ršg
(
b
, 
	`g‘_h‰p_¡©us_Çme
(
cÚ
->
h‰p_¡©us
));

438 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

443 
	`bufãr_­³nd_št
(
b
, 
cÚ
->
h‰p_¡©us
);

444 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" - "));

445 
	`bufãr_­³nd_¡ršg
(
b
, 
	`g‘_h‰p_¡©us_Çme
(
cÚ
->
h‰p_¡©us
));

447 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</h1>\n"

452 ()
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
b
);

453 
	`bufãr_ä“
(
b
);

455 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/html"));

461 
	`¶ugšs_ÿÎ_hªdË_»¥Ú£_¡¬t
(
¤v
, 
cÚ
)) {

462 
HANDLER_GO_ON
:

463 
HANDLER_FINISHED
:

466 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "response_start…lugin failed");

470 ià(
cÚ
->
fe_fšished
) {

473 ià((!(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_CONTENT_LENGTH
)) &&

474 (
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) == 0) {

475 
off_t
 
qËn
 = 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
);

485 ià((
cÚ
->
h‰p_¡©us
 >= 100 && con->http_status < 200) ||

486 
cÚ
->
h‰p_¡©us
 == 204 ||

487 
cÚ
->
h‰p_¡©us
 == 304) {

488 
d©a_¡ršg
 *
ds
;

490 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
*è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Length"))) {

491 
	`bufãr_»£t
(
ds
->
v®ue
);

493 } ià(
qËn
 > 0 || 
cÚ
->
»que¡
.
h‰p_m‘hod
 !ğ
HTTP_METHOD_HEAD
) {

497 
	`bufãr_cİy_št
(
¤v
->
tmp_buf
, 
qËn
);

499 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-L’gth"), 
	`CONST_BUF_LEN
(¤v->
tmp_buf
));

511 ià(((
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_CONTENT_LENGTH
) == 0) &&

512 ((
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) == 0)) {

513 ià(
cÚ
->
»que¡
.
h‰p_v”siÚ
 =ğ
HTTP_VERSION_1_1
) {

514 
off_t
 
qËn
 = 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
);

515 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 = 
HTTP_TRANSFER_ENCODING_CHUNKED
;

516 ià(
qËn
) {

518 
bufãr
 *
b
 = 
¤v
->
tmp_chunk_Ën
;

519 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 0);

520 
	`bufãr_­³nd_ušt_hex
(
b
, (
uštmax_t
)
qËn
);

521 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n"));

522 
	`chunkqueue_´•’d_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

523 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("\r\n"));

526 
cÚ
->
k“p_®ive
 = 0;

539 ià(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_CONNECTION
) {

541 ià(
cÚ
->
k“p_®ive
 && !cÚ->
»¥Ú£
.keep_alive) {

542 
cÚ
->
k“p_®ive
 = 0;

547 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_HEAD
) {

552 
cÚ
->
fe_fšished
 = 1;

554 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

555 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 &ğ~
HTTP_TRANSFER_ENCODING_CHUNKED
;

558 
	`h‰p_»¥Ú£_wr™e_h—d”
(
¤v
, 
cÚ
);

561 
	}
}

563 
	$cÚÃùiÚ_hªdË_wr™e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

564 
	`ÃtwÜk_wr™e_chunkqueue
(
¤v
, 
cÚ
, cÚ->
wr™e_queue
, 
MAX_WRITE_LIMIT
)) {

566 
cÚ
->
wr™e_»que¡_ts
 = 
¤v
->
cur_ts
;

567 ià(
cÚ
->
fe_fšished
) {

568 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_RESPONSE_END
);

572 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

573 "cÚÃùiÚ clo£d: wr™çed oÀfd", 
cÚ
->
fd
);

574 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

577 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

580 
cÚ
->
wr™e_»que¡_ts
 = 
¤v
->
cur_ts
;

581 
cÚ
->
is_wr™abË
 = 0;

588 
	}
}

592 
cÚÃùiÚ
 *
	$cÚÃùiÚ_š™
(
£rv”
 *
¤v
) {

593 
cÚÃùiÚ
 *
cÚ
;

595 
	`UNUSED
(
¤v
);

597 
cÚ
 = 
	`ÿÎoc
(1, (*con));

598 
	`fÜû_as£¹
(
NULL
 !ğ
cÚ
);

600 
cÚ
->
fd
 = 0;

601 
cÚ
->
ndx
 = -1;

602 
cÚ
->
fde_ndx
 = -1;

603 
cÚ
->
by‹s_wr™‹n
 = 0;

604 
cÚ
->
by‹s_»ad
 = 0;

605 
cÚ
->
by‹s_h—d”
 = 0;

606 
cÚ
->
loİs_³r_»que¡
 = 0;

608 
	#CLEAN
(
x
) \

609 
cÚ
->
x
 = 
	`bufãr_š™
();

	)

611 
	`CLEAN
(
»que¡
.
uri
);

612 
	`CLEAN
(
»que¡
.
»que¡_lše
);

613 
	`CLEAN
(
»que¡
.request);

614 
	`CLEAN
(
»que¡
.
·thšfo
);

616 
	`CLEAN
(
»que¡
.
Üig_uri
);

618 
	`CLEAN
(
uri
.
scheme
);

619 
	`CLEAN
(
uri
.
authÜ™y
);

620 
	`CLEAN
(
uri
.
·th
);

621 
	`CLEAN
(
uri
.
·th_¿w
);

622 
	`CLEAN
(
uri
.
qu”y
);

624 
	`CLEAN
(
physiÿl
.
doc_roÙ
);

625 
	`CLEAN
(
physiÿl
.
·th
);

626 
	`CLEAN
(
physiÿl
.
ba£dœ
);

627 
	`CLEAN
(
physiÿl
.
»l_·th
);

628 
	`CLEAN
(
physiÿl
.
‘ag
);

629 
	`CLEAN
(
·r£_»que¡
);

631 
	`CLEAN
(
£rv”_Çme
);

632 
	`CLEAN
(
d¡_addr_buf
);

633 #ià
defšed
 
USE_OPENSSL
 && ! defšed 
OPENSSL_NO_TLSEXT


634 
	`CLEAN
(
£xt_£rv”_Çme
);

637 #undeà
CLEAN


638 
cÚ
->
wr™e_queue
 = 
	`chunkqueue_š™
();

639 
cÚ
->
»ad_queue
 = 
	`chunkqueue_š™
();

640 
cÚ
->
»que¡_cÚ‹Á_queue
 = 
	`chunkqueue_š™
();

642 
cÚ
->
»que¡
.
h—d”s
 = 
	`¬¿y_š™
();

643 
cÚ
->
»¥Ú£
.
h—d”s
 = 
	`¬¿y_š™
();

644 
cÚ
->
’vœÚm’t
 = 
	`¬¿y_š™
();

648 
cÚ
->
¶ugš_ùx
 = 
	`ÿÎoc
(1, (
¤v
->
¶ugšs
.
u£d
 + 1) * (*));

649 
	`fÜû_as£¹
(
NULL
 !ğ
cÚ
->
¶ugš_ùx
);

651 
cÚ
->
cÚd_ÿche
 = 
	`ÿÎoc
(
¤v
->
cÚfig_cÚ‹xt
->
u£d
, (
cÚd_ÿche_t
));

652 
	`fÜû_as£¹
(
NULL
 !ğ
cÚ
->
cÚd_ÿche
);

653 
	`cÚfig_£tup_cÚÃùiÚ
(
¤v
, 
cÚ
);

655  
cÚ
;

656 
	}
}

658 
	$cÚÃùiÚs_ä“
(
£rv”
 *
¤v
) {

659 
cÚÃùiÚs
 *
cÚns
 = 
¤v
->conns;

660 
size_t
 
i
;

662 
i
 = 0; i < 
cÚns
->
size
; i++) {

663 
cÚÃùiÚ
 *
cÚ
 = 
cÚns
->
±r
[
i
];

665 
	`cÚÃùiÚ_»£t
(
¤v
, 
cÚ
);

667 
	`chunkqueue_ä“
(
cÚ
->
wr™e_queue
);

668 
	`chunkqueue_ä“
(
cÚ
->
»ad_queue
);

669 
	`chunkqueue_ä“
(
cÚ
->
»que¡_cÚ‹Á_queue
);

670 
	`¬¿y_ä“
(
cÚ
->
»que¡
.
h—d”s
);

671 
	`¬¿y_ä“
(
cÚ
->
»¥Ú£
.
h—d”s
);

672 
	`¬¿y_ä“
(
cÚ
->
’vœÚm’t
);

674 
	#CLEAN
(
x
) \

675 
	`bufãr_ä“
(
cÚ
->
x
);

	)

677 
	`CLEAN
(
»que¡
.
uri
);

678 
	`CLEAN
(
»que¡
.
»que¡_lše
);

679 
	`CLEAN
(
»que¡
.request);

680 
	`CLEAN
(
»que¡
.
·thšfo
);

682 
	`CLEAN
(
»que¡
.
Üig_uri
);

684 
	`CLEAN
(
uri
.
scheme
);

685 
	`CLEAN
(
uri
.
authÜ™y
);

686 
	`CLEAN
(
uri
.
·th
);

687 
	`CLEAN
(
uri
.
·th_¿w
);

688 
	`CLEAN
(
uri
.
qu”y
);

690 
	`CLEAN
(
physiÿl
.
doc_roÙ
);

691 
	`CLEAN
(
physiÿl
.
·th
);

692 
	`CLEAN
(
physiÿl
.
ba£dœ
);

693 
	`CLEAN
(
physiÿl
.
‘ag
);

694 
	`CLEAN
(
physiÿl
.
»l_·th
);

695 
	`CLEAN
(
·r£_»que¡
);

697 
	`CLEAN
(
£rv”_Çme
);

698 
	`CLEAN
(
d¡_addr_buf
);

699 #ià
defšed
 
USE_OPENSSL
 && ! defšed 
OPENSSL_NO_TLSEXT


700 
	`CLEAN
(
£xt_£rv”_Çme
);

702 #undeà
CLEAN


703 
	`ä“
(
cÚ
->
¶ugš_ùx
);

704 
	`ä“
(
cÚ
->
cÚd_ÿche
);

706 
	`ä“
(
cÚ
);

709 
	`ä“
(
cÚns
->
±r
);

710 
	}
}

713 
	$cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

714 
	`¶ugšs_ÿÎ_cÚÃùiÚ_»£t
(
¤v
, 
cÚ
);

716 
	`cÚÃùiÚ_»¥Ú£_»£t
(
¤v
, 
cÚ
);

717 
cÚ
->
is_»adabË
 = 1;

719 
cÚ
->
by‹s_wr™‹n
 = 0;

720 
cÚ
->
by‹s_wr™‹n_cur_£cÚd
 = 0;

721 
cÚ
->
by‹s_»ad
 = 0;

722 
cÚ
->
by‹s_h—d”
 = 0;

723 
cÚ
->
loİs_³r_»que¡
 = 0;

725 
cÚ
->
»que¡
.
h‰p_m‘hod
 = 
HTTP_METHOD_UNSET
;

726 
cÚ
->
»que¡
.
h‰p_v”siÚ
 = 
HTTP_VERSION_UNSET
;

728 
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
 = 
NULL
;

729 
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
 = 
NULL
;

731 
	#CLEAN
(
x
) \

732 ià(
cÚ
->
x
è
	`bufãr_»£t
(cÚ->x);

	)

734 
	`CLEAN
(
»que¡
.
uri
);

735 
	`CLEAN
(
»que¡
.
»que¡_lše
);

736 
	`CLEAN
(
»que¡
.
·thšfo
);

737 
	`CLEAN
(
»que¡
.request);

741 
	`CLEAN
(
uri
.
scheme
);

744 
	`CLEAN
(
uri
.
·th_¿w
);

747 
	`CLEAN
(
·r£_»que¡
);

749 
	`CLEAN
(
£rv”_Çme
);

750 #ià
defšed
 
USE_OPENSSL
 && ! defšed 
OPENSSL_NO_TLSEXT


751 
	`CLEAN
(
£xt_£rv”_Çme
);

753 #undeà
CLEAN


755 
	#CLEAN
(
x
) \

756 ià(
cÚ
->
x
ècÚ->x->
u£d
 = 0;

	)

758 #undeà
CLEAN


760 
	#CLEAN
(
x
) \

761 
cÚ
->
»que¡
.
x
 = 
NULL
;

	)

763 
	`CLEAN
(
h‰p_ho¡
);

764 
	`CLEAN
(
h‰p_¿nge
);

765 
	`CLEAN
(
h‰p_cÚ‹Á_ty³
);

766 #undeà
CLEAN


767 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 = 0;

768 
cÚ
->
»que¡
.
‹_chunked
 = 0;

770 
	`¬¿y_»£t
(
cÚ
->
»que¡
.
h—d”s
);

771 
	`¬¿y_»£t
(
cÚ
->
’vœÚm’t
);

773 
	`chunkqueue_»£t
(
cÚ
->
»que¡_cÚ‹Á_queue
);

778 
cÚ
->
h—d”_Ën
 = 0;

779 
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 = 0;

783 
	`cÚfig_£tup_cÚÃùiÚ
(
¤v
, 
cÚ
);

786 
	}
}

793 
	$cÚÃùiÚ_hªdË_»ad_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

794 
chunk
 *
c
, *
Ï¡_chunk
;

795 
off_t
 
Ï¡_off£t
;

796 
chunkqueue
 *
cq
 = 
cÚ
->
»ad_queue
;

797 
is_şo£d
 = 0;

799 
is_»que¡_¡¬t
 = 
	`chunkqueue_is_em±y
(
cq
);

801 ià(
cÚ
->
is_»adabË
) {

802 
cÚ
->
»ad_idË_ts
 = 
¤v
->
cur_ts
;

804 
	`cÚÃùiÚ_hªdË_»ad
(
¤v
, 
cÚ
)) {

808 
is_şo£d
 = 1;

815 
	`chunkqueue_»move_fšished_chunks
(
cq
);

822 ià(
cÚ
->
»que¡_couÁ
 > 1 && 
is_»que¡_¡¬t
) {

823 
cÚ
->
»que¡_¡¬t
 = 
¤v
->
cur_ts
;

824 ià(
cÚ
->
cÚf
.
high_´ecisiÚ_time¡amps
)

825 
	`log_şock_g‘time_»®time
(&
cÚ
->
»que¡_¡¬t_hp
);

836 
Ï¡_chunk
 = 
NULL
;

837 
Ï¡_off£t
 = 0;

839 
c
 = 
cq
->
fœ¡
; c; c = c->
Ãxt
) {

840 
size_t
 
i
;

841 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

842 cÚ¡ *
b
 = 
c
->
mem
->
±r
 + c->
off£t
;

844 
i
 = 0; i < 
Ën
; ++i) {

845 
ch
 = 
b
[
i
];

847 ià('\r' =ğ
ch
) {

849 
size_t
 
j
 = 
i
+1;

850 
chunk
 *
cc
 = 
c
;

851 cÚ¡ 
h—d”_’d
[] = "\r\n\r\n";

852 
h—d”_’d_m©ch_pos
 = 1;

854  ; 
cc
; cøğcc->
Ãxt
, 
j
 = 0 ) {

855 
size_t
 
bbËn
 = 
	`bufãr_¡ršg_Ëngth
(
cc
->
mem
è- cc->
off£t
;

856 cÚ¡ *
bb
 = 
cc
->
mem
->
±r
 + cc->
off£t
;

858  ; 
j
 < 
bbËn
; j++) {

859 
ch
 = 
bb
[
j
];

861 ià(
ch
 =ğ
h—d”_’d
[
h—d”_’d_m©ch_pos
]) {

862 
h—d”_’d_m©ch_pos
++;

863 ià(4 =ğ
h—d”_’d_m©ch_pos
) {

864 
Ï¡_chunk
 = 
cc
;

865 
Ï¡_off£t
 = 
j
+1;

866 
found_h—d”_’d
;

869 
»£t_£¬ch
;

874 
»£t_£¬ch
: ;

877 
found_h—d”_’d
:

880 ià(
Ï¡_chunk
) {

881 
	`bufãr_»£t
(
cÚ
->
»que¡
.request);

883 
c
 = 
cq
->
fœ¡
; c; c = c->
Ãxt
) {

884 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

886 ià(
c
 =ğ
Ï¡_chunk
) {

887 
Ën
 = 
Ï¡_off£t
;

890 
	`bufãr_­³nd_¡ršg_Ën
(
cÚ
->
»que¡
.»que¡, 
c
->
mem
->
±r
 + c->
off£t
, 
Ën
);

891 
c
->
off£t
 +ğ
Ën
;

892 
cq
->
by‹s_out
 +ğ
Ën
;

894 ià(
c
 =ğ
Ï¡_chunk
) ;

897 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_REQUEST_END
);

898 } ià(
is_şo£d
) {

901 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

904 ià((
Ï¡_chunk
 ? 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.»que¡è: (
size_t
)
	`chunkqueue_Ëngth
(
cq
))

905 > 
¤v
->
¤vcÚf
.
max_»que¡_f›ld_size
) {

906 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "oversized„equest-header -> sending Status 431");

907 
cÚ
->
h‰p_¡©us
 = 431;

908 
cÚ
->
k“p_®ive
 = 0;

909 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_HANDLE_REQUEST
);

912 
	`chunkqueue_»move_fšished_chunks
(
cq
);

915 
	}
}

917 
hªdËr_t
 
	$cÚÃùiÚ_hªdË_fdev’t
(
£rv”
 *
¤v
, *
cÚ‹xt
, 
»v’ts
) {

918 
cÚÃùiÚ
 *
cÚ
 = 
cÚ‹xt
;

920 
	`jobli¡_­³nd
(
¤v
, 
cÚ
);

922 ià(
cÚ
->
¤v_sock‘
->
is_s¦
) {

924 ià(
»v’ts
 & (
FDEVENT_IN
 | 
FDEVENT_OUT
)) {

925 
cÚ
->
is_»adabË
 = 1;

926 
cÚ
->
is_wr™abË
 = 1;

929 ià(
»v’ts
 & 
FDEVENT_IN
) {

930 
cÚ
->
is_»adabË
 = 1;

932 ià(
»v’ts
 & 
FDEVENT_OUT
) {

933 
cÚ
->
is_wr™abË
 = 1;

939 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_READ
) {

940 
	`cÚÃùiÚ_hªdË_»ad_¡©e
(
¤v
, 
cÚ
);

943 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_WRITE
 &&

944 !
	`chunkqueue_is_em±y
(
cÚ
->
wr™e_queue
) &&

945 
cÚ
->
is_wr™abË
) {

947 ià(-1 =ğ
	`cÚÃùiÚ_hªdË_wr™e
(
¤v
, 
cÚ
)) {

948 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

950 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ds",

951 
cÚ
->
fd
,

956 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_CLOSE
) {

958 
	`cÚÃùiÚ_»ad_fÜ_eos
(
¤v
, 
cÚ
);

965 ià((
»v’ts
 & ~(
FDEVENT_IN
 | 
FDEVENT_OUT
)è&& 
cÚ
->
¡©e
 !ğ
CON_STATE_ERROR
) {

966 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_CLOSE
) {

967 
cÚ
->
şo£_timeout_ts
 = 
¤v
->
cur_ts
 - (
HTTP_LINGER_TIMEOUT
+1);

968 } ià(
»v’ts
 & 
FDEVENT_HUP
) {

969 ià(
	`fdev’t_is_tı_h®f_şo£d
(
cÚ
->
fd
)) {

970 
cÚ
->
k“p_®ive
 = 0;

972 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

974 } ià(
»v’ts
 & 
FDEVENT_ERR
) {

975 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

977 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

978 "cÚÃùiÚ clo£d:…Şl(è-> ???", 
»v’ts
);

982  
HANDLER_FINISHED
;

983 
	}
}

986 
cÚÃùiÚ
 *
	$cÚÃùiÚ_acû±
(
£rv”
 *
¤v
, 
£rv”_sock‘
 *
¤v_sock‘
) {

990 
út
;

991 
sock_addr
 
út_addr
;

992 
sockËn_t
 
út_Ën
;

1001 ià(
¤v
->
cÚns
->
u£d
 >ğ¤v->
max_cÚns
) {

1002  
NULL
;

1005 
út_Ën
 = (
út_addr
);

1007 #ià
	`defšed
(
SOCK_CLOEXEC
è&& defšed(
SOCK_NONBLOCK
)

1008 #ià
	`defšed
(
__N‘BSD__
)

1009 
út
 = 
	`·cû±
(
¤v_sock‘
->
fd
, (
sockaddr
 *è&
út_addr
, &
út_Ën
, 
NULL
, 
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
);

1011 
út
 = 
	`acû±4
(
¤v_sock‘
->
fd
, (
sockaddr
 *è&
út_addr
, &
út_Ën
, 
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
);

1014 
út
 = 
	`acû±
(
¤v_sock‘
->
fd
, (
sockaddr
 *è&
út_addr
, &
út_Ën
);

1016 ià(-1 =ğ
út
) {

1017 
”ºo
) {

1018 
EAGAIN
:

1019 #ià
EWOULDBLOCK
 !ğ
EAGAIN


1020 
EWOULDBLOCK
:

1022 
EINTR
:

1024 
ECONNABORTED
:

1027 
EMFILE
:

1031 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "acû± faed:", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

1033  
NULL
;

1035 ià(
út_addr
.
¶aš
.
§_çmy
 !ğ
AF_UNIX
) {

1036 
	`ÃtwÜk_acû±_tı_ÇgË_di§bË
(
út
);

1038  
	`cÚÃùiÚ_acû±ed
(
¤v
, 
¤v_sock‘
, &
út_addr
, 
út
);

1040 
	}
}

1042 
cÚÃùiÚ
 *
	$cÚÃùiÚ_acû±ed
(
£rv”
 *
¤v
, 
£rv”_sock‘
 *
¤v_sock‘
, 
sock_addr
 *
út_addr
, 
út
) {

1043 
cÚÃùiÚ
 *
cÚ
;

1045 
¤v
->
cur_fds
++;

1049 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1050 "­³ùed()", 
út
);

1052 
¤v
->
cÚ_İ’ed
++;

1054 
cÚ
 = 
	`cÚÃùiÚs_g‘_Ãw_cÚÃùiÚ
(
¤v
);

1056 
cÚ
->
fd
 = 
út
;

1057 
cÚ
->
fde_ndx
 = -1;

1058 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
cÚ
->
fd
, 
cÚÃùiÚ_hªdË_fdev’t
, con);

1060 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_REQUEST_START
);

1062 
cÚ
->
cÚÃùiÚ_¡¬t
 = 
¤v
->
cur_ts
;

1063 
cÚ
->
d¡_addr
 = *
út_addr
;

1064 
	`bufãr_cİy_¡ršg
(
cÚ
->
d¡_addr_buf
, 
	`š‘_Áİ_ÿche_g‘_
(
¤v
, &(cÚ->
d¡_addr
)));

1065 
cÚ
->
¤v_sock‘
 = srv_socket;

1067 ià(-1 =ğ
	`fdev’t_fú_£t_nb_şÛxec_sock
(
¤v
->
ev
, 
cÚ
->
fd
)) {

1068 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fú faed: ", 
	`¡»¼Ü
(
”ºo
));

1069 
	`cÚÃùiÚ_şo£
(
¤v
, 
cÚ
);

1070  
NULL
;

1072 #ifdeà
USE_OPENSSL


1074 ià(
¤v_sock‘
->
is_s¦
) {

1075 ià(
NULL
 =ğ(
cÚ
->
s¦
 = 
	`SSL_Ãw
(
¤v_sock‘
->
s¦_ùx
))) {

1076 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

1077 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

1079 
	`cÚÃùiÚ_şo£
(
¤v
, 
cÚ
);

1080  
NULL
;

1083 
cÚ
->
»ÃgÙŸtiÚs
 = 0;

1084 
	`SSL_£t_­p_d©a
(
cÚ
->
s¦
, con);

1085 
	`SSL_£t_acû±_¡©e
(
cÚ
->
s¦
);

1087 ià(1 !ğ(
	`SSL_£t_fd
(
cÚ
->
s¦
, 
út
))) {

1088 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

1089 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

1090 
	`cÚÃùiÚ_şo£
(
¤v
, 
cÚ
);

1091  
NULL
;

1095  
cÚ
;

1096 
	}
}

1099 
	$cÚÃùiÚ_¡©e_machše
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

1100 
dÚe
 = 0, 
r
;

1102 ià(
¤v
->
¤vcÚf
.
log_¡©e_hªdlšg
) {

1103 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

1105 
cÚ
->
fd
,

1106 
	`cÚÃùiÚ_g‘_¡©e
(
cÚ
->
¡©e
));

1109 
dÚe
 == 0) {

1110 
size_t
 
o¡©e
 = 
cÚ
->
¡©e
;

1112 ià(
¤v
->
¤vcÚf
.
log_¡©e_hªdlšg
) {

1113 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

1114 "¡©fÜ fd", 
cÚ
->
fd
, 
	`cÚÃùiÚ_g‘_¡©e
(cÚ->
¡©e
));

1117 
cÚ
->
¡©e
) {

1118 
CON_STATE_REQUEST_START
:

1119 
cÚ
->
»que¡_¡¬t
 = 
¤v
->
cur_ts
;

1120 
cÚ
->
»ad_idË_ts
 = 
¤v
->
cur_ts
;

1121 ià(
cÚ
->
cÚf
.
high_´ecisiÚ_time¡amps
)

1122 
	`log_şock_g‘time_»®time
(&
cÚ
->
»que¡_¡¬t_hp
);

1124 
cÚ
->
»que¡_couÁ
++;

1125 
cÚ
->
loİs_³r_»que¡
 = 0;

1127 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_READ
);

1130 
CON_STATE_REQUEST_END
:

1131 
	`bufãr_»£t
(
cÚ
->
uri
.
authÜ™y
);

1132 
	`bufãr_»£t
(
cÚ
->
uri
.
·th
);

1133 
	`bufãr_»£t
(
cÚ
->
uri
.
qu”y
);

1134 
	`bufãr_»£t
(
cÚ
->
»que¡
.
Üig_uri
);

1136 ià(
	`h‰p_»que¡_·r£
(
¤v
, 
cÚ
)) {

1139 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_READ_POST
);

1144 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_HANDLE_REQUEST
);

1147 
CON_STATE_READ_POST
:

1148 
CON_STATE_HANDLE_REQUEST
:

1158 
r
 = 
	`h‰p_»¥Ú£_´•¬e
(
¤v
, 
cÚ
)) {

1159 
HANDLER_WAIT_FOR_EVENT
:

1160 ià(!
cÚ
->
fe_fšished
 && (!cÚ->
fe_¡¬‹d
 || 0 =ğcÚ->
cÚf
.
¡»am_»¥Ú£_body
)) {

1164 
HANDLER_FINISHED
:

1165 ià(
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 > 0) {

1166 
cÚ
->
»que¡
.
h‰p_m‘hod
 = cÚ->
”rÜ_hªdËr_§ved_m‘hod
;

1168 ià(
cÚ
->
mode
 =ğ
DIRECT
) {

1169 ià(
cÚ
->
”rÜ_hªdËr_§ved_¡©us
) {

1170 ià(
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 > 0) {

1171 
cÚ
->
h‰p_¡©us
 = cÚ->
”rÜ_hªdËr_§ved_¡©us
;

1172 } ià(
cÚ
->
h‰p_¡©us
 == 404 || con->http_status == 403) {

1174 
cÚ
->
h‰p_¡©us
 = -cÚ->
”rÜ_hªdËr_§ved_¡©us
;

1179 } ià(
cÚ
->
h‰p_¡©us
 >= 400) {

1180 
bufãr
 *
”rÜ_hªdËr
 = 
NULL
;

1181 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
cÚf
.
”rÜ_hªdËr
)) {

1182 
”rÜ_hªdËr
 = 
cÚ
->
cÚf
.error_handler;

1183 } ià((
cÚ
->
h‰p_¡©us
 == 404 || con->http_status == 403)

1184 && !
	`bufãr_¡ršg_is_em±y
(
cÚ
->
cÚf
.
”rÜ_hªdËr_404
)) {

1185 
”rÜ_hªdËr
 = 
cÚ
->
cÚf
.
”rÜ_hªdËr_404
;

1188 ià(
”rÜ_hªdËr
) {

1194 
d©a_¡ršg
 *
ds
;

1195 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

1196 
ds
 = 
	`d©a_¡ršg_š™
();

1198 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("REDIRECT_STATUS"));

1199 
	`bufãr_­³nd_št
(
ds
->
v®ue
, 
cÚ
->
h‰p_¡©us
);

1200 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

1202 ià(
”rÜ_hªdËr
 =ğ
cÚ
->
cÚf
.error_handler) {

1203 
	`¶ugšs_ÿÎ_cÚÃùiÚ_»£t
(
¤v
, 
cÚ
);

1205 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1206 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 !ğcÚ->
»que¡_cÚ‹Á_queue
->
by‹s_š
) {

1207 
cÚ
->
k“p_®ive
 = 0;

1209 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 = 0;

1210 
	`chunkqueue_»£t
(
cÚ
->
»que¡_cÚ‹Á_queue
);

1213 
cÚ
->
is_wr™abË
 = 1;

1214 
cÚ
->
fe_fšished
 = 0;

1215 
cÚ
->
fe_¡¬‹d
 = 0;

1216 
cÚ
->
gÙ_»¥Ú£
 = 0;

1217 
cÚ
->
·r£d_»¥Ú£
 = 0;

1218 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

1219 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = -1;

1220 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 = 0;

1222 
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 = cÚ->
h‰p_¡©us
;

1223 
cÚ
->
”rÜ_hªdËr_§ved_m‘hod
 = cÚ->
»que¡
.
h‰p_m‘hod
;

1225 
cÚ
->
»que¡
.
h‰p_m‘hod
 = 
HTTP_METHOD_GET
;

1227 
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 = -cÚ->
h‰p_¡©us
;

1230 
	`bufãr_cİy_bufãr
(
cÚ
->
»que¡
.
uri
, 
”rÜ_hªdËr
);

1231 
	`cÚÃùiÚ_hªdË_”rdoc_š™
(
¤v
, 
cÚ
);

1232 
cÚ
->
h‰p_¡©us
 = 0;

1234 
dÚe
 = -1;

1239 ià(
cÚ
->
h‰p_¡©us
 == 0) con->http_status = 200;

1242 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_RESPONSE_START
);

1244 
HANDLER_WAIT_FOR_FD
:

1245 
¤v
->
wªt_fds
++;

1247 
	`fdwa™queue_­³nd
(
¤v
, 
cÚ
);

1250 
HANDLER_COMEBACK
:

1251 
dÚe
 = -1;

1253 
HANDLER_ERROR
:

1255 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1258 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd", "unknowÀ»t-v®ue: ", 
cÚ
->
fd
, 
r
);

1262 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_HANDLE_REQUEST
 && 
o¡©e
 =ğ
CON_STATE_READ_POST
) {

1263 
o¡©e
 = 
CON_STATE_HANDLE_REQUEST
;

1266 
CON_STATE_RESPONSE_START
:

1273 ià(-1 =ğ
	`cÚÃùiÚ_hªdË_wr™e_´•¬e
(
¤v
, 
cÚ
)) {

1274 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1279 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_WRITE
);

1281 
CON_STATE_RESPONSE_END
:

1282 
CON_STATE_ERROR
:

1283 
	`cÚÃùiÚ_hªdË_»¥Ú£_’d_¡©e
(
¤v
, 
cÚ
);

1285 
CON_STATE_CONNECT
:

1286 
	`chunkqueue_»£t
(
cÚ
->
»ad_queue
);

1288 
cÚ
->
»que¡_couÁ
 = 0;

1291 
CON_STATE_CLOSE
:

1292 
	`cÚÃùiÚ_hªdË_şo£_¡©e
(
¤v
, 
cÚ
);

1294 
CON_STATE_READ
:

1295 
	`cÚÃùiÚ_hªdË_»ad_¡©e
(
¤v
, 
cÚ
);

1297 
CON_STATE_WRITE
:

1300 ià(!
	`chunkqueue_is_em±y
(
cÚ
->
wr™e_queue
)) {

1301 ià(
cÚ
->
is_wr™abË
) {

1302 ià(-1 =ğ
	`cÚÃùiÚ_hªdË_wr™e
(
¤v
, 
cÚ
)) {

1303 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ds",

1304 
cÚ
->
fd
,

1306 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1309 ià(
cÚ
->
¡©e
 !ğ
CON_STATE_WRITE
) ;

1311 } ià(
cÚ
->
fe_fšished
) {

1312 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_RESPONSE_END
);

1316 ià(
cÚ
->
mode
 !ğ
DIRECT
 && !cÚ->
fe_fšished
) {

1317 
r
 = 
	`¶ugšs_ÿÎ_hªdË_sub»que¡
(
¤v
, 
cÚ
)) {

1318 
HANDLER_WAIT_FOR_EVENT
:

1319 
HANDLER_FINISHED
:

1320 
HANDLER_GO_ON
:

1322 
HANDLER_WAIT_FOR_FD
:

1323 
¤v
->
wªt_fds
++;

1324 
	`fdwa™queue_­³nd
(
¤v
, 
cÚ
);

1326 
HANDLER_COMEBACK
:

1328 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd", "uÃx³ùed sub»que¡ hªdË¸»t-v®ue: ", 
cÚ
->
fd
, 
r
);

1330 
HANDLER_ERROR
:

1331 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1335 } 
cÚ
->
¡©e
 =ğ
CON_STATE_WRITE
 && (!
	`chunkqueue_is_em±y
(cÚ->
wr™e_queue
è? cÚ->
is_wr™abË
 : cÚ->
fe_fšished
));

1339 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd",

1340 "unknowÀ¡©e:", 
cÚ
->
fd
, cÚ->
¡©e
);

1345 ià(
dÚe
 == -1) {

1346 
dÚe
 = 0;

1347 } ià(
o¡©e
 =ğ
cÚ
->
¡©e
) {

1348 
dÚe
 = 1;

1352 ià(
¤v
->
¤vcÚf
.
log_¡©e_hªdlšg
) {

1353 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

1355 
cÚ
->
fd
,

1356 
	`cÚÃùiÚ_g‘_¡©e
(
cÚ
->
¡©e
));

1359 
r
 = 0;

1360 
cÚ
->
¡©e
) {

1361 
CON_STATE_READ
:

1362 
CON_STATE_CLOSE
:

1363 
r
 = 
FDEVENT_IN
;

1365 
CON_STATE_WRITE
:

1370 ià(!
	`chunkqueue_is_em±y
(
cÚ
->
wr™e_queue
) &&

1371 (
cÚ
->
is_wr™abË
 == 0) &&

1372 (
cÚ
->
Œaffic_lim™_»ached
 == 0)) {

1373 
r
 |ğ
FDEVENT_OUT
;

1376 
CON_STATE_READ_POST
:

1377 ià(
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_POLLIN
) {

1378 
r
 |ğ
FDEVENT_IN
;

1384 ià(-1 !ğ
cÚ
->
fd
) {

1385 cÚ¡ 
ev’ts
 = 
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
cÚ
->
fd
);

1386 ià(
cÚ
->
is_»adabË
 < 0) {

1387 
cÚ
->
is_»adabË
 = 0;

1388 
r
 |ğ
FDEVENT_IN
;

1390 ià(
cÚ
->
is_wr™abË
 < 0) {

1391 
cÚ
->
is_wr™abË
 = 0;

1392 
r
 |ğ
FDEVENT_OUT
;

1394 ià(
r
 !ğ
ev’ts
) {

1396 ià((
r
 & 
FDEVENT_IN
è&& !(
ev’ts
 & FDEVENT_IN)) {

1397 
cÚ
->
»ad_idË_ts
 = 
¤v
->
cur_ts
;

1399 ià((
r
 & 
FDEVENT_OUT
è&& !(
ev’ts
 & FDEVENT_OUT)) {

1400 
cÚ
->
wr™e_»que¡_ts
 = 
¤v
->
cur_ts
;

1402 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &
cÚ
->
fde_ndx
, cÚ->
fd
, 
r
);

1407 
	}
}

	@connections.h

1 #iâdeà
_CONNECTIONS_H_


2 
	#_CONNECTIONS_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£rv”.h
"

6 
	~"fdev’t.h
"

8 
cÚÃùiÚ
 *
cÚÃùiÚ_š™
(
£rv”
 *
¤v
);

9 
cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

10 
cÚÃùiÚs_ä“
(
£rv”
 *
¤v
);

12 
cÚÃùiÚ
 * 
cÚÃùiÚ_acû±
(
£rv”
 *
¤v
, 
£rv”_sock‘
 *
¤v_sock
);

13 
cÚÃùiÚ
 * 
cÚÃùiÚ_acû±ed
(
£rv”
 *
¤v
, 
£rv”_sock‘
 *
¤v_sock‘
, 
sock_addr
 *
út_addr
, 
út
);

15 
cÚÃùiÚ_£t_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
cÚÃùiÚ_¡©e_t
 
¡©e
);

16 cÚ¡ * 
cÚÃùiÚ_g‘_¡©e
(
cÚÃùiÚ_¡©e_t
 
¡©e
);

17 cÚ¡ * 
cÚÃùiÚ_g‘_shÜt_¡©e
(
cÚÃùiÚ_¡©e_t
 
¡©e
);

18 
cÚÃùiÚ_¡©e_machše
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

19 
cÚÃùiÚ_hªdË_»ad
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

20 
hªdËr_t
 
cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

21 
hªdËr_t
 
cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
h‰p_¡©us
);

22 
cÚÃùiÚ_»¥Ú£_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

	@crc32.c

1 
	~"fœ¡.h
"

3 
	~"üc32.h
"

5 
	#CRC32C
(
c
,
d
è(c=(c>>8)^
üc_c
[(c^(d))&0xFF])

	)

7 cÚ¡ 
	güc_c
[256] = {

75 
ušt32_t
 
	$g’”©e_üc32c
(cÚ¡ *
bufãr
, 
size_t
 
Ëngth
) {

76 
size_t
 
i
;

77 
ušt32_t
 
üc32
 = ~0L;

79 
i
 = 0; i < 
Ëngth
; i++){

80 
	`CRC32C
(
üc32
, ()
bufãr
[
i
]);

82  ~
üc32
;

83 
	}
}

	@crc32.h

1 #iâdeà
__üc32ü_bË_h__


2 
	#__üc32ü_bË_h__


	)

3 
	~"fœ¡.h
"

5 
	~<sys/ty³s.h
>

7 #ià
defšed
 
HAVE_STDINT_H


8 
	~<¡dšt.h
>

9 #–ià
defšed
 
HAVE_INTTYPES_H


10 
	~<š‰y³s.h
>

13 
ušt32_t
 
g’”©e_üc32c
(cÚ¡ *
¡ršg
, 
size_t
 
Ëngth
);

	@data_array.c

1 
	~"fœ¡.h
"

3 
	~"¬¿y.h
"

5 
	~<¡ršg.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

9 
d©a_un£t
 *
	$d©a_¬¿y_cİy
(cÚ¡ 
d©a_un£t
 *
s
) {

10 
d©a_¬¿y
 *
¤c
 = (d©a_¬¿y *)
s
;

11 
d©a_¬¿y
 *
ds
 = 
	`d©a_¬¿y_š™
();

13 
	`bufãr_cİy_bufãr
(
ds
->
key
, 
¤c
->key);

14 
	`¬¿y_ä“
(
ds
->
v®ue
);

15 
ds
->
v®ue
 = 
	`¬¿y_š™_¬¿y
(
¤c
->value);

16 
ds
->
is_šdex_key
 = 
¤c
->is_index_key;

17  (
d©a_un£t
 *)
ds
;

18 
	}
}

20 
	$d©a_¬¿y_ä“
(
d©a_un£t
 *
d
) {

21 
d©a_¬¿y
 *
ds
 = (d©a_¬¿y *)
d
;

23 
	`bufãr_ä“
(
ds
->
key
);

24 
	`¬¿y_ä“
(
ds
->
v®ue
);

26 
	`ä“
(
d
);

27 
	}
}

29 
	$d©a_¬¿y_»£t
(
d©a_un£t
 *
d
) {

30 
d©a_¬¿y
 *
ds
 = (d©a_¬¿y *)
d
;

33 
	`bufãr_»£t
(
ds
->
key
);

34 
	`¬¿y_»£t
(
ds
->
v®ue
);

35 
	}
}

37 
	$d©a_¬¿y_š£¹_dup
(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
) {

38 
	`UNUSED
(
d¡
);

40 
¤c
->
	`ä“
(src);

43 
	}
}

45 
	$d©a_¬¿y_´št
(cÚ¡ 
d©a_un£t
 *
d
, 
d•th
) {

46 
d©a_¬¿y
 *
ds
 = (d©a_¬¿y *)
d
;

48 
	`¬¿y_´št
(
ds
->
v®ue
, 
d•th
);

49 
	}
}

51 
d©a_¬¿y
 *
	$d©a_¬¿y_š™
() {

52 
d©a_¬¿y
 *
ds
;

54 
ds
 = 
	`ÿÎoc
(1, (*ds));

55 
	`fÜû_as£¹
(
NULL
 !ğ
ds
);

57 
ds
->
key
 = 
	`bufãr_š™
();

58 
ds
->
v®ue
 = 
	`¬¿y_š™
();

60 
ds
->
cİy
 = 
d©a_¬¿y_cİy
;

61 
ds
->
ä“
 = 
d©a_¬¿y_ä“
;

62 
ds
->
»£t
 = 
d©a_¬¿y_»£t
;

63 
ds
->
š£¹_dup
 = 
d©a_¬¿y_š£¹_dup
;

64 
ds
->
´št
 = 
d©a_¬¿y_´št
;

65 
ds
->
ty³
 = 
TYPE_ARRAY
;

67  
ds
;

68 
	}
}

	@data_config.c

1 
	~"fœ¡.h
"

3 
	~"¬¿y.h
"

5 
	~<¡ršg.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

9 
d©a_un£t
 *
	$d©a_cÚfig_cİy
(cÚ¡ 
d©a_un£t
 *
s
) {

10 
d©a_cÚfig
 *
¤c
 = (d©a_cÚfig *)
s
;

11 
d©a_cÚfig
 *
ds
 = 
	`d©a_cÚfig_š™
();

13 
	`bufãr_cİy_bufãr
(
ds
->
key
, 
¤c
->key);

14 
	`bufãr_cİy_bufãr
(
ds
->
comp_key
, 
¤c
->comp_key);

15 
	`¬¿y_ä“
(
ds
->
v®ue
);

16 
ds
->
v®ue
 = 
	`¬¿y_š™_¬¿y
(
¤c
->value);

17  (
d©a_un£t
 *)
ds
;

18 
	}
}

20 
	$d©a_cÚfig_ä“
(
d©a_un£t
 *
d
) {

21 
d©a_cÚfig
 *
ds
 = (d©a_cÚfig *)
d
;

23 
	`bufãr_ä“
(
ds
->
key
);

24 
	`bufãr_ä“
(
ds
->
İ
);

25 
	`bufãr_ä“
(
ds
->
comp_key
);

27 
	`¬¿y_ä“
(
ds
->
v®ue
);

28 
	`veùÜ_cÚfig_w—k_ş—r
(&
ds
->
chd»n
);

30 ià(
ds
->
¡ršg
è
	`bufãr_ä“
(ds->string);

31 #ifdeà
HAVE_PCRE_H


32 ià(
ds
->
»gex
è
	`püe_ä“
(ds->regex);

33 ià(
ds
->
»gex_¡udy
è
	`püe_ä“
(ds->regex_study);

36 
	`ä“
(
d
);

37 
	}
}

39 
	$d©a_cÚfig_»£t
(
d©a_un£t
 *
d
) {

40 
d©a_cÚfig
 *
ds
 = (d©a_cÚfig *)
d
;

43 
	`bufãr_»£t
(
ds
->
key
);

44 
	`bufãr_»£t
(
ds
->
comp_key
);

45 
	`¬¿y_»£t
(
ds
->
v®ue
);

46 
	}
}

48 
	$d©a_cÚfig_š£¹_dup
(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
) {

49 
	`UNUSED
(
d¡
);

51 
¤c
->
	`ä“
(src);

54 
	}
}

56 
	$d©a_cÚfig_´št
(cÚ¡ 
d©a_un£t
 *
d
, 
d•th
) {

57 
d©a_cÚfig
 *
ds
 = (d©a_cÚfig *)
d
;

58 
¬¿y
 *
a
 = (¬¿y *)
ds
->
v®ue
;

59 
size_t
 
i
;

60 
size_t
 
maxËn
;

62 ià(0 =ğ
ds
->
cÚ‹xt_ndx
) {

63 
	`årštf
(
¡dout
, "config {\n");

66 ià(
ds
->
cÚd
 !ğ
CONFIG_COND_ELSE
) {

67 
	`årštf
(
¡dout
, "$%s %s \"%s\" {\n",

68 
ds
->
comp_key
->
±r
, ds->
İ
->±r, ds->
¡ršg
->ptr);

70 
	`årštf
(
¡dout
, "{\n");

72 
	`¬¿y_´št_šd’t
(
d•th
 + 1);

73 
	`årštf
(
¡dout
, "# block %d\n", 
ds
->
cÚ‹xt_ndx
);

75 
d•th
 ++;

77 
maxËn
 = 
	`¬¿y_g‘_max_key_Ëngth
(
a
);

78 
i
 = 0; i < 
a
->
u£d
; i ++) {

79 
d©a_un£t
 *
du
 = 
a
->
d©a
[
i
];

80 
size_t
 
Ën
 = 
	`¡¾’
(
du
->
key
->
±r
);

81 
size_t
 
j
;

83 
	`¬¿y_´št_šd’t
(
d•th
);

84 
	`årštf
(
¡dout
, "%s", 
du
->
key
->
±r
);

85 
j
 = 
maxËn
 - 
Ën
; j > 0; j --) {

86 
	`årštf
(
¡dout
, " ");

88 
	`årštf
(
¡dout
, " = ");

89 
du
->
	`´št
(du, 
d•th
);

90 
	`årštf
(
¡dout
, "\n");

93 
	`årštf
(
¡dout
, "\n");

94 
i
 = 0; i < 
ds
->
chd»n
.
u£d
; i ++) {

95 
d©a_cÚfig
 *
dc
 = 
ds
->
chd»n
.
d©a
[
i
];

98 ià(
NULL
 =ğ
dc
->
´ev
) {

99 
	`årštf
(
¡dout
, "\n");

100 
	`¬¿y_´št_šd’t
(
d•th
);

101 
dc
->
	`´št
((
d©a_un£t
 *èdc, 
d•th
);

102 
	`årštf
(
¡dout
, "\n");

106 
d•th
 --;

107 
	`¬¿y_´št_šd’t
(
d•th
);

108 
	`årštf
(
¡dout
, "}");

109 ià(0 !ğ
ds
->
cÚ‹xt_ndx
) {

110 ià(
ds
->
cÚd
 !ğ
CONFIG_COND_ELSE
) {

111 
	`årštf
(
¡dout
, " #ƒnd of $%s %s \"%s\"",

112 
ds
->
comp_key
->
±r
, ds->
İ
->±r, ds->
¡ršg
->ptr);

114 
	`årštf
(
¡dout
, " #ƒnd ofƒlse");

118 ià(
ds
->
Ãxt
) {

119 
	`årštf
(
¡dout
, "\n");

120 
	`¬¿y_´št_šd’t
(
d•th
);

121 
	`årštf
(
¡dout
, "else ");

122 
ds
->
Ãxt
->
	`´št
((
d©a_un£t
 *)ds->Ãxt, 
d•th
);

124 
	}
}

126 
d©a_cÚfig
 *
	$d©a_cÚfig_š™
() {

127 
d©a_cÚfig
 *
ds
;

129 
ds
 = 
	`ÿÎoc
(1, (*ds));

131 
ds
->
key
 = 
	`bufãr_š™
();

132 
ds
->
İ
 = 
	`bufãr_š™
();

133 
ds
->
comp_key
 = 
	`bufãr_š™
();

134 
ds
->
v®ue
 = 
	`¬¿y_š™
();

135 
	`veùÜ_cÚfig_w—k_š™
(&
ds
->
chd»n
);

137 
ds
->
cİy
 = 
d©a_cÚfig_cİy
;

138 
ds
->
ä“
 = 
d©a_cÚfig_ä“
;

139 
ds
->
»£t
 = 
d©a_cÚfig_»£t
;

140 
ds
->
š£¹_dup
 = 
d©a_cÚfig_š£¹_dup
;

141 
ds
->
´št
 = 
d©a_cÚfig_´št
;

142 
ds
->
ty³
 = 
TYPE_CONFIG
;

144  
ds
;

145 
	}
}

	@data_fastcgi.c

1 
	~"fœ¡.h
"

3 
	~"¬¿y.h
"

4 
	~"ç¡cgi.h
"

6 
	~<¡ršg.h
>

7 
	~<¡dio.h
>

8 
	~<¡dlib.h
>

10 
d©a_un£t
 *
	$d©a_ç¡cgi_cİy
(cÚ¡ 
d©a_un£t
 *
s
) {

11 
d©a_ç¡cgi
 *
¤c
 = (d©a_ç¡cg˜*)
s
;

12 
d©a_ç¡cgi
 *
ds
 = 
	`d©a_ç¡cgi_š™
();

14 
	`bufãr_cİy_bufãr
(
ds
->
key
, 
¤c
->key);

15 
	`bufãr_cİy_bufãr
(
ds
->
ho¡
, 
¤c
->host);

16 
ds
->
is_šdex_key
 = 
¤c
->is_index_key;

17  (
d©a_un£t
 *)
ds
;

18 
	}
}

20 
	$d©a_ç¡cgi_ä“
(
d©a_un£t
 *
d
) {

21 
d©a_ç¡cgi
 *
ds
 = (d©a_ç¡cg˜*)
d
;

23 
	`bufãr_ä“
(
ds
->
key
);

24 
	`bufãr_ä“
(
ds
->
ho¡
);

26 
	`ä“
(
d
);

27 
	}
}

29 
	$d©a_ç¡cgi_»£t
(
d©a_un£t
 *
d
) {

30 
d©a_ç¡cgi
 *
ds
 = (d©a_ç¡cg˜*)
d
;

32 
	`bufãr_»£t
(
ds
->
key
);

33 
	`bufãr_»£t
(
ds
->
ho¡
);

35 
	}
}

37 
	$d©a_ç¡cgi_š£¹_dup
(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
) {

38 
	`UNUSED
(
d¡
);

40 
¤c
->
	`ä“
(src);

43 
	}
}

45 
	$d©a_ç¡cgi_´št
(cÚ¡ 
d©a_un£t
 *
d
, 
d•th
) {

46 
d©a_ç¡cgi
 *
ds
 = (d©a_ç¡cg˜*)
d
;

47 
	`UNUSED
(
d•th
);

49 
	`årštf
(
¡dout
, "ç¡cgi(%s)", 
ds
->
ho¡
->
±r
);

50 
	}
}

53 
d©a_ç¡cgi
 *
	$d©a_ç¡cgi_š™
() {

54 
d©a_ç¡cgi
 *
ds
;

56 
ds
 = 
	`ÿÎoc
(1, (*ds));

57 
	`fÜû_as£¹
(
NULL
 !ğ
ds
);

59 
ds
->
key
 = 
	`bufãr_š™
();

60 
ds
->
ho¡
 = 
	`bufãr_š™
();

61 
ds
->
pÜt
 = 0;

62 
ds
->
is_di§bËd
 = 0;

64 
ds
->
cİy
 = 
d©a_ç¡cgi_cİy
;

65 
ds
->
ä“
 = 
d©a_ç¡cgi_ä“
;

66 
ds
->
»£t
 = 
d©a_ç¡cgi_»£t
;

67 
ds
->
š£¹_dup
 = 
d©a_ç¡cgi_š£¹_dup
;

68 
ds
->
´št
 = 
d©a_ç¡cgi_´št
;

69 
ds
->
ty³
 = 
TYPE_FASTCGI
;

71  
ds
;

72 
	}
}

	@data_integer.c

1 
	~"fœ¡.h
"

3 
	~"¬¿y.h
"

5 
	~<¡dio.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

9 
d©a_un£t
 *
	$d©a_š‹g”_cİy
(cÚ¡ 
d©a_un£t
 *
s
) {

10 
d©a_š‹g”
 *
¤c
 = (d©a_š‹g” *)
s
;

11 
d©a_š‹g”
 *
ds
 = 
	`d©a_š‹g”_š™
();

13 
	`bufãr_cİy_bufãr
(
ds
->
key
, 
¤c
->key);

14 
ds
->
is_šdex_key
 = 
¤c
->is_index_key;

15 
ds
->
v®ue
 = 
¤c
->value;

16  (
d©a_un£t
 *)
ds
;

17 
	}
}

19 
	$d©a_š‹g”_ä“
(
d©a_un£t
 *
d
) {

20 
d©a_š‹g”
 *
ds
 = (d©a_š‹g” *)
d
;

22 
	`bufãr_ä“
(
ds
->
key
);

24 
	`ä“
(
d
);

25 
	}
}

27 
	$d©a_š‹g”_»£t
(
d©a_un£t
 *
d
) {

28 
d©a_š‹g”
 *
ds
 = (d©a_š‹g” *)
d
;

31 
	`bufãr_»£t
(
ds
->
key
);

32 
ds
->
v®ue
 = 0;

33 
	}
}

35 
	$d©a_š‹g”_š£¹_dup
(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
) {

36 
	`UNUSED
(
d¡
);

38 
¤c
->
	`ä“
(src);

41 
	}
}

43 
	$d©a_š‹g”_´št
(cÚ¡ 
d©a_un£t
 *
d
, 
d•th
) {

44 
d©a_š‹g”
 *
ds
 = (d©a_š‹g” *)
d
;

45 
	`UNUSED
(
d•th
);

47 
	`årštf
(
¡dout
, "%d", 
ds
->
v®ue
);

48 
	}
}

51 
d©a_š‹g”
 *
	$d©a_š‹g”_š™
() {

52 
d©a_š‹g”
 *
ds
;

54 
ds
 = 
	`ÿÎoc
(1, (*ds));

55 
	`fÜû_as£¹
(
NULL
 !ğ
ds
);

57 
ds
->
key
 = 
	`bufãr_š™
();

58 
ds
->
v®ue
 = 0;

60 
ds
->
cİy
 = 
d©a_š‹g”_cİy
;

61 
ds
->
ä“
 = 
d©a_š‹g”_ä“
;

62 
ds
->
»£t
 = 
d©a_š‹g”_»£t
;

63 
ds
->
š£¹_dup
 = 
d©a_š‹g”_š£¹_dup
;

64 
ds
->
´št
 = 
d©a_š‹g”_´št
;

65 
ds
->
ty³
 = 
TYPE_INTEGER
;

67  
ds
;

68 
	}
}

	@data_string.c

1 
	~"fœ¡.h
"

3 
	~"¬¿y.h
"

5 
	~<¡ršg.h
>

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<as£¹.h
>

10 
d©a_un£t
 *
	$d©a_¡ršg_cİy
(cÚ¡ 
d©a_un£t
 *
s
) {

11 
d©a_¡ršg
 *
¤c
 = (d©a_¡ršg *)
s
;

12 
d©a_¡ršg
 *
ds
 = 
	`d©a_¡ršg_š™
();

14 
	`bufãr_cİy_bufãr
(
ds
->
key
, 
¤c
->key);

15 
	`bufãr_cİy_bufãr
(
ds
->
v®ue
, 
¤c
->value);

16 
ds
->
is_šdex_key
 = 
¤c
->is_index_key;

17  (
d©a_un£t
 *)
ds
;

18 
	}
}

20 
	$d©a_¡ršg_ä“
(
d©a_un£t
 *
d
) {

21 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
d
;

23 
	`bufãr_ä“
(
ds
->
key
);

24 
	`bufãr_ä“
(
ds
->
v®ue
);

26 
	`ä“
(
d
);

27 
	}
}

29 
	$d©a_¡ršg_»£t
(
d©a_un£t
 *
d
) {

30 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
d
;

33 
	`bufãr_»£t
(
ds
->
key
);

34 
	`bufãr_»£t
(
ds
->
v®ue
);

35 
	}
}

37 
	$d©a_¡ršg_š£¹_dup
(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
) {

38 
d©a_¡ršg
 *
ds_d¡
 = (d©a_¡ršg *)
d¡
;

39 
d©a_¡ršg
 *
ds_¤c
 = (d©a_¡ršg *)
¤c
;

41 ià(!
	`bufãr_is_em±y
(
ds_d¡
->
v®ue
)) {

42 
	`bufãr_­³nd_¡ršg_Ën
(
ds_d¡
->
v®ue
, 
	`CONST_STR_LEN
(", "));

43 
	`bufãr_­³nd_¡ršg_bufãr
(
ds_d¡
->
v®ue
, 
ds_¤c
->value);

45 
	`bufãr_cİy_bufãr
(
ds_d¡
->
v®ue
, 
ds_¤c
->value);

48 
¤c
->
	`ä“
(src);

51 
	}
}

53 
	$d©a_»¥Ú£_š£¹_dup
(
d©a_un£t
 *
d¡
, d©a_un£ˆ*
¤c
) {

54 
d©a_¡ršg
 *
ds_d¡
 = (d©a_¡ršg *)
d¡
;

55 
d©a_¡ršg
 *
ds_¤c
 = (d©a_¡ršg *)
¤c
;

57 ià(!
	`bufãr_is_em±y
(
ds_d¡
->
v®ue
)) {

58 
	`bufãr_­³nd_¡ršg_Ën
(
ds_d¡
->
v®ue
, 
	`CONST_STR_LEN
("\r\n"));

59 
	`bufãr_­³nd_¡ršg_bufãr
(
ds_d¡
->
v®ue
, ds_d¡->
key
);

60 
	`bufãr_­³nd_¡ršg_Ën
(
ds_d¡
->
v®ue
, 
	`CONST_STR_LEN
(": "));

61 
	`bufãr_­³nd_¡ršg_bufãr
(
ds_d¡
->
v®ue
, 
ds_¤c
->value);

63 
	`bufãr_cİy_bufãr
(
ds_d¡
->
v®ue
, 
ds_¤c
->value);

66 
¤c
->
	`ä“
(src);

69 
	}
}

72 
	$d©a_¡ršg_´št
(cÚ¡ 
d©a_un£t
 *
d
, 
d•th
) {

73 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
d
;

74 
size_t
 
i
, 
Ën
;

75 
	`UNUSED
(
d•th
);

78 ià(
	`bufãr_¡ršg_is_em±y
(
ds
->
v®ue
)) {

79 
	`åuts
("\"\"", 
¡dout
);

84 
	`putc
('"', 
¡dout
);

85 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

86 
i
 = 0; i < 
Ën
; i++) {

87 
c
 = 
ds
->
v®ue
->
±r
[
i
];

88 ià(
c
 == '"') {

89 
	`åuts
("\\\"", 
¡dout
);

91 
	`putc
(
c
, 
¡dout
);

94 
	`putc
('"', 
¡dout
);

95 
	}
}

98 
d©a_¡ršg
 *
	$d©a_¡ršg_š™
() {

99 
d©a_¡ršg
 *
ds
;

101 
ds
 = 
	`ÿÎoc
(1, (*ds));

102 
	`fÜû_as£¹
(
NULL
 !ğ
ds
);

104 
ds
->
key
 = 
	`bufãr_š™
();

105 
ds
->
v®ue
 = 
	`bufãr_š™
();

107 
ds
->
cİy
 = 
d©a_¡ršg_cİy
;

108 
ds
->
ä“
 = 
d©a_¡ršg_ä“
;

109 
ds
->
»£t
 = 
d©a_¡ršg_»£t
;

110 
ds
->
š£¹_dup
 = 
d©a_¡ršg_š£¹_dup
;

111 
ds
->
´št
 = 
d©a_¡ršg_´št
;

112 
ds
->
ty³
 = 
TYPE_STRING
;

114  
ds
;

115 
	}
}

117 
d©a_¡ršg
 *
	$d©a_»¥Ú£_š™
() {

118 
d©a_¡ršg
 *
ds
;

120 
ds
 = 
	`d©a_¡ršg_š™
();

121 
ds
->
š£¹_dup
 = 
d©a_»¥Ú£_š£¹_dup
;

123  
ds
;

124 
	}
}

	@etag.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"‘ag.h
"

6 #ià
defšed
 
HAVE_STDINT_H


7 
	~<¡dšt.h
>

8 #–ià
defšed
 
HAVE_INTTYPES_H


9 
	~<š‰y³s.h
>

12 
	~<¡ršg.h
>

14 
	$‘ag_is_equ®
(
bufãr
 *
‘ag
, cÚ¡ *
lše
, 
w—k_ok
) {

16 
START
 = 0,

17 
CHECK
,

18 
CHECK_QUOTED
,

19 
SKIP
,

20 
SKIP_QUOTED
,

21 
TAIL


22 } 
¡©e
 = 
START
;

24 cÚ¡ *
cu¼’t
;

25 cÚ¡ *
tok_¡¬t
;

26 cÚ¡ *
tok
 = 
NULL
;

27 
m©ched
;

29 ià('*' =ğ
lše
[0] && '\0' ==†ine[1]) {

33 ià(!
‘ag
 || 
	`bufãr_¡ršg_is_em±y
(etag))  0;

34 
tok_¡¬t
 = 
‘ag
->
±r
;

36 ià('W' =ğ
tok_¡¬t
[0]) {

37 ià(!
w—k_ok
 || '/' !ğ
tok_¡¬t
[1])  0;

38 
tok_¡¬t
 =ok_start + 2;

41 ià('"' !ğ
tok_¡¬t
[0])  0;

43 ++
tok_¡¬t
;

45 
cu¼’t
 = 
lše
; *current; ++current) {

46 
¡©e
) {

47 
START
:

49 *
cu¼’t
) {

52 ià('/' !ğ*++
cu¼’t
)  0;

53 ià('"' !ğ*++
cu¼’t
)  0;

54 ià(!
w—k_ok
) {

55 
¡©e
 = 
SKIP
;

57 
¡©e
 = 
CHECK
;

58 
tok
 = 
tok_¡¬t
;

63 
¡©e
 = 
CHECK
;

64 
tok
 = 
tok_¡¬t
;

76 
CHECK
:

81 
m©ched
 = *
tok
 && *tok =ğ*
cu¼’t
;

82 ++
tok
;

83 *
cu¼’t
) {

85 
¡©e
 = 
m©ched
 ? 
CHECK_QUOTED
 : 
SKIP_QUOTED
;

88 ià(*
tok
) {

92 ià(
m©ched
) {

97 
¡©e
 = 
TAIL
;

100 ià(!
m©ched
) {

102 
¡©e
 = 
SKIP
;

107 
CHECK_QUOTED
:

108 ià(!*
tok
 || *tok !ğ*
cu¼’t
) {

110 
¡©e
 = 
SKIP
;

113 ++
tok
;

114 
¡©e
 = 
CHECK
;

116 
SKIP
:

118 *
cu¼’t
) {

120 
¡©e
 = 
SKIP_QUOTED
;

123 
¡©e
 = 
TAIL
;

127 
SKIP_QUOTED
:

128 
¡©e
 = 
SKIP
;

130 
TAIL
:

132 *
cu¼’t
) {

134 
¡©e
 = 
START
;

149 
	}
}

151 
	$‘ag_ü—‹
(
bufãr
 *
‘ag
, 
¡©
 *
¡
,
‘ag_æags_t
 
æags
) {

152 ià(0 =ğ
æags
)  0;

154 
	`bufãr_»£t
(
‘ag
);

156 ià(
æags
 & 
ETAG_USE_INODE
) {

157 
	`bufãr_­³nd_št
(
‘ag
, 
¡
->
¡_šo
);

158 
	`bufãr_­³nd_¡ršg_Ën
(
‘ag
, 
	`CONST_STR_LEN
("-"));

161 ià(
æags
 & 
ETAG_USE_SIZE
) {

162 
	`bufãr_­³nd_št
(
‘ag
, 
¡
->
¡_size
);

163 
	`bufãr_­³nd_¡ršg_Ën
(
‘ag
, 
	`CONST_STR_LEN
("-"));

166 ià(
æags
 & 
ETAG_USE_MTIME
) {

167 
	`bufãr_­³nd_št
(
‘ag
, 
¡
->
¡_mtime
);

171 
	}
}

173 
	$‘ag_mu‹
(
bufãr
 *
mut
, bufã¸*
‘ag
) {

174 
size_t
 
i
, 
Ën
;

175 
ušt32_t
 
h
;

177 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
‘ag
);

178 
h
=0, 
i
=0; i < 
Ën
; ++ièh = (h<<5)^(h>>27)^(
‘ag
->
±r
[i]);

180 
	`bufãr_»£t
(
mut
);

181 
	`bufãr_cİy_¡ršg_Ën
(
mut
, 
	`CONST_STR_LEN
("\""));

182 
	`bufãr_­³nd_št
(
mut
, 
h
);

183 
	`bufãr_­³nd_¡ršg_Ën
(
mut
, 
	`CONST_STR_LEN
("\""));

186 
	}
}

	@etag.h

1 #iâdeà
ETAG_H


2 
	#ETAG_H


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

7 
	~<sys/ty³s.h
>

8 
	~<sys/¡©.h
>

9 
	~<uni¡d.h
>

11 ’um { 
	mETAG_USE_INODE
 = 1, 
	mETAG_USE_MTIME
 = 2, 
	mETAG_USE_SIZE
 = 4 } 
	t‘ag_æags_t
;

13 
‘ag_is_equ®
(
bufãr
 *
‘ag
, cÚ¡ *
m©ches
, 
w—k_ok
);

14 
‘ag_ü—‹
(
bufãr
 *
‘ag
, 
¡©
 *
¡
, 
‘ag_æags_t
 
æags
);

15 
‘ag_mu‹
(
bufãr
 *
mut
, bufã¸*
‘ag
);

	@fastcgi.h

15 #iâdeà
_FASTCGI_H


16 
	#_FASTCGI_H


	)

21 
	#FCGI_LISTENSOCK_FILENO
 0

	)

24 
	mv”siÚ
;

25 
	mty³
;

26 
	m»que¡IdB1
;

27 
	m»que¡IdB0
;

28 
	mcÚ‹ÁL’gthB1
;

29 
	mcÚ‹ÁL’gthB0
;

30 
	m·ddšgL’gth
;

31 
	m»£rved
;

32 } 
	tFCGI_H—d”
;

34 
	#FCGI_MAX_LENGTH
 0xffff

	)

40 
	#FCGI_HEADER_LEN
 8

	)

45 
	#FCGI_VERSION_1
 1

	)

50 
	#FCGI_BEGIN_REQUEST
 1

	)

51 
	#FCGI_ABORT_REQUEST
 2

	)

52 
	#FCGI_END_REQUEST
 3

	)

53 
	#FCGI_PARAMS
 4

	)

54 
	#FCGI_STDIN
 5

	)

55 
	#FCGI_STDOUT
 6

	)

56 
	#FCGI_STDERR
 7

	)

57 
	#FCGI_DATA
 8

	)

58 
	#FCGI_GET_VALUES
 9

	)

59 
	#FCGI_GET_VALUES_RESULT
 10

	)

60 
	#FCGI_UNKNOWN_TYPE
 11

	)

61 
	#FCGI_MAXTYPE
 (
FCGI_UNKNOWN_TYPE
)

	)

66 
	#FCGI_NULL_REQUEST_ID
 0

	)

70 
	mrŞeB1
;

71 
	mrŞeB0
;

72 
	mæags
;

73 
	m»£rved
[5];

74 } 
	tFCGI_BegšReque¡Body
;

77 
FCGI_H—d”
 
	mh—d”
;

78 
FCGI_BegšReque¡Body
 
	mbody
;

79 } 
	tFCGI_BegšReque¡RecÜd
;

84 
	#FCGI_KEEP_CONN
 1

	)

89 
	#FCGI_RESPONDER
 1

	)

90 
	#FCGI_AUTHORIZER
 2

	)

91 
	#FCGI_FILTER
 3

	)

95 
	m­pStusB3
;

96 
	m­pStusB2
;

97 
	m­pStusB1
;

98 
	m­pStusB0
;

99 
	m´ÙocŞStus
;

100 
	m»£rved
[3];

101 } 
	tFCGI_EndReque¡Body
;

104 
FCGI_H—d”
 
	mh—d”
;

105 
FCGI_EndReque¡Body
 
	mbody
;

106 } 
	tFCGI_EndReque¡RecÜd
;

111 
	#FCGI_REQUEST_COMPLETE
 0

	)

112 
	#FCGI_CANT_MPX_CONN
 1

	)

113 
	#FCGI_OVERLOADED
 2

	)

114 
	#FCGI_UNKNOWN_ROLE
 3

	)

120 
	#FCGI_MAX_CONNS
 "FCGI_MAX_CONNS"

	)

121 
	#FCGI_MAX_REQS
 "FCGI_MAX_REQS"

	)

122 
	#FCGI_MPXS_CONNS
 "FCGI_MPXS_CONNS"

	)

126 
	mty³
;

127 
	m»£rved
[7];

128 } 
	tFCGI_UnknownTy³Body
;

131 
FCGI_H—d”
 
	mh—d”
;

132 
FCGI_UnknownTy³Body
 
	mbody
;

133 } 
	tFCGI_UnknownTy³RecÜd
;

	@fdevent.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

6 
	~<sys/ty³s.h
>

8 
	~<uni¡d.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<”ºo.h
>

12 
	~<¡dio.h
>

13 
	~<fú.h
>

14 
	~<as£¹.h
>

17 
fdev’ts
 *
	$fdev’t_š™
(
£rv”
 *
¤v
, 
size_t
 
maxfds
, 
fdev’t_hªdËr_t
 
ty³
) {

18 
fdev’ts
 *
ev
;

20 
ev
 = 
	`ÿÎoc
(1, (*ev));

21 
	`fÜû_as£¹
(
NULL
 !ğ
ev
);

22 
ev
->
¤v
 = srv;

23 
ev
->
fd¬¿y
 = 
	`ÿÎoc
(
maxfds
, (*ev->fdarray));

24 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
fd¬¿y
);

25 
ev
->
maxfds
 = maxfds;

26 
ev
->
highfd
 = -1;

28 
ty³
) {

29 
FDEVENT_HANDLER_POLL
:

30 ià(0 !ğ
	`fdev’t_pŞl_š™
(
ev
)) {

31 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

33 
”rÜ
;

35  
ev
;

36 
FDEVENT_HANDLER_SELECT
:

37 ià(0 !ğ
	`fdev’t_£Ëù_š™
(
ev
)) {

38 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

40 
”rÜ
;

42  
ev
;

43 
FDEVENT_HANDLER_LINUX_SYSEPOLL
:

44 ià(0 !ğ
	`fdev’t_lšux_sy£pŞl_š™
(
ev
)) {

45 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

47 
”rÜ
;

49  
ev
;

50 
FDEVENT_HANDLER_SOLARIS_DEVPOLL
:

51 ià(0 !ğ
	`fdev’t_sŞ¬is_devpŞl_š™
(
ev
)) {

52 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

54 
”rÜ
;

56  
ev
;

57 
FDEVENT_HANDLER_SOLARIS_PORT
:

58 ià(0 !ğ
	`fdev’t_sŞ¬is_pÜt_š™
(
ev
)) {

59 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

61 
”rÜ
;

63  
ev
;

64 
FDEVENT_HANDLER_FREEBSD_KQUEUE
:

65 ià(0 !ğ
	`fdev’t_ä“bsd_kqueue_š™
(
ev
)) {

66 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

68 
”rÜ
;

70  
ev
;

71 
FDEVENT_HANDLER_LIBEV
:

72 ià(0 !ğ
	`fdev’t_libev_š™
(
ev
)) {

73 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

75 
”rÜ
;

77  
ev
;

78 
FDEVENT_HANDLER_UNSET
:

82 
”rÜ
:

83 
	`ä“
(
ev
->
fd¬¿y
);

84 
	`ä“
(
ev
);

86 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S",

88  
NULL
;

89 
	}
}

91 
	$fdev’t_ä“
(
fdev’ts
 *
ev
) {

92 
size_t
 
i
;

93 ià(!
ev
) ;

95 ià(
ev
->
ä“
èev->
	`ä“
(ev);

97 
i
 = 0; i < 
ev
->
maxfds
; i++) {

98 ià(
ev
->
fd¬¿y
[
i
] > (
fdnode
 *)0x2è
	`ä“
(ev->fdarray[i]);

101 
	`ä“
(
ev
->
fd¬¿y
);

102 
	`ä“
(
ev
);

103 
	}
}

105 
	$fdev’t_»£t
(
fdev’ts
 *
ev
) {

106 ià(
ev
->
»£t
èƒv->
	`»£t
(ev);

109 
	}
}

111 
fdnode
 *
	$fdnode_š™
() {

112 
fdnode
 *
fdn
;

114 
fdn
 = 
	`ÿÎoc
(1, (*fdn));

115 
	`fÜû_as£¹
(
NULL
 !ğ
fdn
);

116 
fdn
->
fd
 = -1;

117  
fdn
;

118 
	}
}

120 
	$fdnode_ä“
(
fdnode
 *
fdn
) {

121 
	`ä“
(
fdn
);

122 
	}
}

124 
	$fdev’t_»gi¡”
(
fdev’ts
 *
ev
, 
fd
, 
fdev’t_hªdËr
 
hªdËr
, *
ùx
) {

125 
fdnode
 *
fdn
;

127 
fdn
 = 
	`fdnode_š™
();

128 
fdn
->
hªdËr
 = handler;

129 
fdn
->
fd
 = fd;

130 
fdn
->
ùx
 = ctx;

131 
fdn
->
hªdËr_ùx
 = 
NULL
;

132 
fdn
->
ev’ts
 = 0;

134 
ev
->
fd¬¿y
[
fd
] = 
fdn
;

137 
	}
}

139 
	$fdev’t_uÄegi¡”
(
fdev’ts
 *
ev
, 
fd
) {

140 
fdnode
 *
fdn
;

142 ià(!
ev
)  0;

143 
fdn
 = 
ev
->
fd¬¿y
[
fd
];

145 
	`fdnode_ä“
(
fdn
);

147 
ev
->
fd¬¿y
[
fd
] = 
NULL
;

150 
	}
}

152 
	$fdev’t_sched_şo£
(
fdev’ts
 *
ev
, 
fd
, 
issock
) {

153 ià(!
ev
) ;

154 
ev
->
fd¬¿y
[
fd
] = (
issock
 ? (
fdnode
 *)0x1 : (fdnode *)0x2);

155 ià(
ev
->
highfd
 < 
fd
)ƒv->highfd = fd;

156 
	}
}

158 
	$fdev’t_sched_run
(
£rv”
 *
¤v
, 
fdev’ts
 *
ev
) {

159 cÚ¡ 
highfd
 = 
ev
->highfd;

160 
fd
 = 0; fd <ğ
highfd
; ++fd) {

161 
fdnode
 * cÚ¡ 
fdn
 = 
ev
->
fd¬¿y
[
fd
];

162 
rc
;

163 ià(!((
ušŒ_t
)
fdn
 & 0x3)) ;

164 #ifdeà
_WIN32


165 ià(
fdn
 =ğ(
fdnode
 *)0x1) {

166 
rc
 = 
	`şo£sock‘
(
fd
);

168 ià(
fdn
 =ğ(
fdnode
 *)0x2) {

169 
rc
 = 
	`şo£
(
fd
);

172 
rc
 = 
	`şo£
(
fd
);

175 ià(0 !ğ
rc
) {

176 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds", "şo£ faed ", 
fd
, 
	`¡»¼Ü
(
”ºo
));

179 
ev
->
fd¬¿y
[
fd
] = 
NULL
;

180 --
¤v
->
cur_fds
;

182 
ev
->
highfd
 = -1;

183 
	}
}

185 
	$fdev’t_ev’t_d–
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
) {

186 ià(-1 =ğ
fd
) ;

187 ià(
ev
->
fd¬¿y
[
fd
] <ğ(
fdnode
 *)0x2) ;

189 ià(
ev
->
ev’t_d–
è*
fde_ndx
 =ƒv->
	`ev’t_d–
Óv, *fde_ndx, 
fd
);

190 
ev
->
fd¬¿y
[
fd
]->
ev’ts
 = 0;

191 
	}
}

193 
	$fdev’t_ev’t_£t
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
, 
ev’ts
) {

194 ià(-1 =ğ
fd
) ;

200 ià(
ev
->
fd¬¿y
[
fd
]->
ev’ts
 ==ƒvents) ;

202 ià(
ev
->
ev’t_£t
è*
fde_ndx
 =ƒv->
	`ev’t_£t
Óv, *fde_ndx, 
fd
, 
ev’ts
);

203 
ev
->
fd¬¿y
[
fd
]->
ev’ts
 =ƒvents;

204 
	}
}

206 
	$fdev’t_ev’t_add
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
, 
ev’t
) {

207 
ev’ts
;

208 ià(-1 =ğ
fd
) ;

210 
ev’ts
 = 
ev
->
fd¬¿y
[
fd
]->events;

211 ià((
ev’ts
 & 
ev’t
) || 0 ==ƒvent) ;

213 
ev’ts
 |ğ
ev’t
;

214 ià(
ev
->
ev’t_£t
è*
fde_ndx
 =ƒv->
	`ev’t_£t
Óv, *fde_ndx, 
fd
, 
ev’ts
);

215 
ev
->
fd¬¿y
[
fd
]->
ev’ts
 =ƒvents;

216 
	}
}

218 
	$fdev’t_ev’t_şr
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
, 
ev’t
) {

219 
ev’ts
;

220 ià(-1 =ğ
fd
) ;

222 
ev’ts
 = 
ev
->
fd¬¿y
[
fd
]->events;

223 ià(!(
ev’ts
 & 
ev’t
)) ;

225 
ev’ts
 &ğ~
ev’t
;

226 ià(
ev
->
ev’t_£t
è*
fde_ndx
 =ƒv->
	`ev’t_£t
Óv, *fde_ndx, 
fd
, 
ev’ts
);

227 
ev
->
fd¬¿y
[
fd
]->
ev’ts
 =ƒvents;

228 
	}
}

230 
	$fdev’t_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

231 ià(
ev
->
pŞl
 =ğ
NULL
è
	`SEGFAULT
();

232  
ev
->
	`pŞl
Óv, 
timeout_ms
);

233 
	}
}

235 
	$fdev’t_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

236 ià(
ev
->
ev’t_g‘_»v’t
 =ğ
NULL
è
	`SEGFAULT
();

238  
ev
->
	`ev’t_g‘_»v’t
Óv, 
ndx
);

239 
	}
}

241 
	$fdev’t_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

242 ià(
ev
->
ev’t_g‘_fd
 =ğ
NULL
è
	`SEGFAULT
();

244  
ev
->
	`ev’t_g‘_fd
Óv, 
ndx
);

245 
	}
}

247 
fdev’t_hªdËr
 
	$fdev’t_g‘_hªdËr
(
fdev’ts
 *
ev
, 
fd
) {

248 ià(
ev
->
fd¬¿y
[
fd
] =ğ
NULL
è
	`SEGFAULT
();

249 ià((
ušŒ_t
)
ev
->
fd¬¿y
[
fd
] & 0x3è 
NULL
;

250 ià(
ev
->
fd¬¿y
[
fd
]->fd !ğfdè
	`SEGFAULT
();

252  
ev
->
fd¬¿y
[
fd
]->
hªdËr
;

253 
	}
}

255 * 
	$fdev’t_g‘_cÚ‹xt
(
fdev’ts
 *
ev
, 
fd
) {

256 ià(
ev
->
fd¬¿y
[
fd
] =ğ
NULL
è
	`SEGFAULT
();

257 ià((
ušŒ_t
)
ev
->
fd¬¿y
[
fd
] & 0x3è 
NULL
;

258 ià(
ev
->
fd¬¿y
[
fd
]->fd !ğfdè
	`SEGFAULT
();

260  
ev
->
fd¬¿y
[
fd
]->
ùx
;

261 
	}
}

263 
	$fd_şo£_Ú_exec
(
fd
) {

264 #ifdeà
FD_CLOEXEC


265 ià(
fd
 < 0) ;

266 
	`fÜû_as£¹
(-1 !ğ
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
));

268 
	`UNUSED
(
fd
);

270 
	}
}

272 
	$fdev’t_fú_£t
(
fdev’ts
 *
ev
, 
fd
) {

273  ((
ev
è&& (ev->
fú_£t
)è?ƒv->
	`fú_£t
Óv, 
fd
) : 0;

274 
	}
}

276 
	$fdev’t_fú_£t_nb
(
fdev’ts
 *
ev
, 
fd
) {

277 ià((
ev
è&& (ev->
fú_£t
)èƒv->
	`fú_£t
Óv, 
fd
);

278 #ifdeà
O_NONBLOCK


279  
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
 | 
O_RDWR
);

283 
	}
}

285 
	$fdev’t_fú_£t_nb_şÛxec
(
fdev’ts
 *
ev
, 
fd
) {

286 
	`fd_şo£_Ú_exec
(
fd
);

287  
	`fdev’t_fú_£t_nb
(
ev
, 
fd
);

288 
	}
}

290 
	$fdev’t_fú_£t_nb_şÛxec_sock
(
fdev’ts
 *
ev
, 
fd
) {

291 #ià
	`defšed
(
SOCK_CLOEXEC
è&& defšed(
SOCK_NONBLOCK
)

292  ((
ev
è&& (ev->
fú_£t
)è?ƒv->
	`fú_£t
Óv, 
fd
) : 0;

294  
	`fdev’t_fú_£t_nb_şÛxec
(
ev
, 
fd
);

296 
	}
}

298 
	$fdev’t_sock‘_şÛxec
(
domaš
, 
ty³
, 
´ÙocŞ
) {

299 #ifdeà
SOCK_CLOEXEC


300  
	`sock‘
(
domaš
, 
ty³
 | 
SOCK_CLOEXEC
, 
´ÙocŞ
);

302 
fd
;

303 ià(-1 !ğ(
fd
 = 
	`sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
))) {

304 #ifdeà
FD_CLOEXEC


305 
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
);

308  
fd
;

310 
	}
}

312 
	$fdev’t_sock‘_nb_şÛxec
(
domaš
, 
ty³
, 
´ÙocŞ
) {

313 #ifdeà
SOCK_CLOEXEC


314  
	`sock‘
(
domaš
, 
ty³
 | 
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
, 
´ÙocŞ
);

316 
fd
;

317 ià(-1 !ğ(
fd
 = 
	`sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
))) {

318 #ifdeà
FD_CLOEXEC


319 
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
);

321 #ifdeà
O_NONBLOCK


322 
	`fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
 | 
O_RDWR
);

325  
fd
;

327 
	}
}

329 #iâdeà
O_NOCTTY


330 
	#O_NOCTTY
 0

	)

333 
	$fdev’t_İ’_şÛxec
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
) {

334 #ifdeà
O_CLOEXEC


335  
	`İ’
(
·thÇme
, 
æags
 | 
O_CLOEXEC
 | 
O_NOCTTY
, 
mode
);

337 
fd
 = 
	`İ’
(
·thÇme
, 
æags
 | 
O_NOCTTY
, 
mode
);

338 #ifdeà
FD_CLOEXEC


339 ià(
fd
 != -1)

340 
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
);

342  
fd
;

344 
	}
}

347 
	$fdev’t_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

348 ià(
ev
->
ev’t_Ãxt_fdndx
èƒv->
	`ev’t_Ãxt_fdndx
Óv, 
ndx
);

351 
	}
}

354 
	~<Ãtš‘/tı.h
>

355 #ià(
defšed
(
__APPLE__
è&& defšed(
__MACH__
)) \

356 || 
defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
) \

357 || 
defšed
(
__O³nBSD__
è|| 
	$defšed
(
__D¿gÚFly__
)

358 
	~<Ãtš‘/tı_fsm.h
>

362 
	$fdev’t_is_tı_h®f_şo£d
(
fd
) {

363 #ifdeà
TCP_CONNECTION_INFO


364 
tı_cÚÃùiÚ_šfo
 
tıi
;

365 
sockËn_t
 
’
 = (
tıi
);

366  (0 =ğ
	`g‘sockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_CONNECTION_INFO
, &
tıi
, &
’
)

367 && 
tıi
.
tıi_¡©e
 =ğ
TCPS_CLOSE_WAIT
);

368 #–ià
	`defšed
(
TCP_INFO
è&& defšed(
TCPS_CLOSE_WAIT
)

370 
tı_šfo
 
tıi
;

371 
sockËn_t
 
’
 = (
tıi
);

372  (0 =ğ
	`g‘sockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_INFO
, &
tıi
, &
’
)

373 && 
tıi
.
tıi_¡©e
 =ğ
TCPS_CLOSE_WAIT
);

374 #–ià
	`defšed
(
TCP_INFO
è&& defšed(
__lšux__
)

376 
tı_šfo
 
tıi
;

377 
sockËn_t
 
’
 = (
tıi
);

378  (0 =ğ
	`g‘sockİt
(
fd
, 
SOL_TCP
, 
TCP_INFO
, &
tıi
, &
’
)

379 && 
tıi
.
tıi_¡©e
 =ğ
TCP_CLOSE_WAIT
);

381 
	`UNUSED
(
fd
);

386 
	}
}

	@fdevent.h

1 #iâdeà
_FDEVENT_H_


2 
	#_FDEVENT_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£‰šgs.h
"

7 #ià
defšed
 
HAVE_STDINT_H


8 
	~<¡dšt.h
>

9 #–ià
defšed
 
HAVE_INTTYPES_H


10 
	~<š‰y³s.h
>

13 
	~<sys/ty³s.h
>

17 #ià
defšed
(
HAVE_EPOLL_CTL
è&& defšed(
HAVE_SYS_EPOLL_H
)

18 
	#USE_LINUX_EPOLL


	)

19 
	g•Şl_ev’t
;

24 #ià
defšed
 
HAVE_POLL
 && (defšed(
HAVE_SYS_POLL_H
è|| defšed(
HAVE_POLL_H
))

25 
	#USE_POLL


	)

26 
	gpŞlfd
;

29 #ià
defšed
 
HAVE_SELECT


30 #ifdeà
__WIN32


31 
	~<wšsock2.h
>

33 
	#USE_SELECT


	)

34 #ifdeà
HAVE_SYS_SELECT_H


35 
	~<sys/£Ëù.h
>

39 #ià
defšed
 
HAVE_SYS_DEVPOLL_H
 && defšed(
__sun
)

40 
	#USE_SOLARIS_DEVPOLL


	)

41 
	gpŞlfd
;

44 #ià
defšed
 
HAVE_PORT_H
 && defšed 
HAVE_PORT_CREATE
 && defšed(
__sun
)

45 
	#USE_SOLARIS_PORT


	)

46 
	~<pÜt.h
>

49 #ià
defšed
 
HAVE_SYS_EVENT_H
 && defšed 
HAVE_KQUEUE


50 
	#USE_FREEBSD_KQUEUE


	)

51 
	gkev’t
;

54 #ià
defšed
 
HAVE_LIBEV


55 
	#USE_LIBEV


	)

56 
	gev_loİ
;

59 
	g£rv”
;

61 
	$hªdËr_t
 (*
	tfdev’t_hªdËr
)(
	t£rv”
 *
	t¤v
, *
	tùx
, 
	t»v’ts
);

66 
	#FDEVENT_IN
 
	`BV
(0)

	)

67 
	#FDEVENT_PRI
 
	`BV
(1)

	)

68 
	#FDEVENT_OUT
 
	`BV
(2)

	)

69 
	#FDEVENT_ERR
 
	`BV
(3)

	)

70 
	#FDEVENT_HUP
 
	`BV
(4)

	)

71 
	#FDEVENT_NVAL
 
	`BV
(5)

	)

73 
	#FDEVENT_STREAM_REQUEST
 
	`BV
(0)

	)

74 
	#FDEVENT_STREAM_REQUEST_BUFMIN
 
	`BV
(1)

	)

75 
	#FDEVENT_STREAM_REQUEST_POLLIN
 
	`BV
(15)

	)

77 
	#FDEVENT_STREAM_RESPONSE
 
	`BV
(0)

	)

78 
	#FDEVENT_STREAM_RESPONSE_BUFMIN
 
	`BV
(1)

	)

80 ’um { 
FD_EVENT_TYPE_UNSET
 = -1,

81 
FD_EVENT_TYPE_CONNECTION
,

82 
FD_EVENT_TYPE_FCGI_CONNECTION
,

83 
FD_EVENT_TYPE_DIRWATCH
,

84 
FD_EVENT_TYPE_CGI_CONNECTION


85 } 
	tfd_ev’t_t
;

87 ’um { 
FDEVENT_HANDLER_UNSET
,

88 
FDEVENT_HANDLER_SELECT
,

89 
FDEVENT_HANDLER_POLL
,

90 
FDEVENT_HANDLER_LINUX_SYSEPOLL
,

91 
FDEVENT_HANDLER_SOLARIS_DEVPOLL
,

92 
FDEVENT_HANDLER_SOLARIS_PORT
,

93 
FDEVENT_HANDLER_FREEBSD_KQUEUE
,

94 
FDEVENT_HANDLER_LIBEV


95 } 
	tfdev’t_hªdËr_t
;

98 
	s_fdnode
 {

99 
fdev’t_hªdËr
 
hªdËr
;

100 *
ùx
;

101 *
hªdËr_ùx
;

102 
fd
;

103 
ev’ts
;

104 } 
	tfdnode
;

112 *
±r
;

114 
size_t
 
u£d
;

115 
size_t
 
size
;

116 } 
	tbufãr_št
;

122 
	sfdev’ts
 {

123 
£rv”
 *
¤v
;

124 
fdev’t_hªdËr_t
 
ty³
;

126 
fdnode
 **
fd¬¿y
;

127 
size_t
 
maxfds
;

128 
highfd
;

130 #ifdeà
USE_LINUX_EPOLL


131 
•Şl_fd
;

132 
•Şl_ev’t
 *
•Şl_ev’ts
;

134 #ifdeà
USE_POLL


135 
pŞlfd
 *
pŞlfds
;

137 
size_t
 
size
;

138 
size_t
 
u£d
;

140 
bufãr_št
 
unu£d
;

142 #ifdeà
USE_SELECT


143 
fd_£t
 
£Ëù_»ad
;

144 
fd_£t
 
£Ëù_wr™e
;

145 
fd_£t
 
£Ëù_”rÜ
;

147 
fd_£t
 
£Ëù_£t_»ad
;

148 
fd_£t
 
£Ëù_£t_wr™e
;

149 
fd_£t
 
£Ëù_£t_”rÜ
;

151 
£Ëù_max_fd
;

153 #ifdeà
USE_SOLARIS_DEVPOLL


154 
devpŞl_fd
;

155 
pŞlfd
 *
devpŞlfds
;

157 #ifdeà
USE_SOLARIS_PORT


158 
pÜt_ev’t_t
 *
pÜt_ev’ts
;

160 #ifdeà
USE_FREEBSD_KQUEUE


161 
kq_fd
;

162 
kev’t
 *
kq_»suÉs
;

164 #ifdeà
USE_SOLARIS_PORT


165 
pÜt_fd
;

167 #ifdeà
USE_LIBEV


168 
ev_loİ
 *
libev_loİ
;

170 (*
»£t
)(
fdev’ts
 *
ev
);

171 (*
ä“
)(
fdev’ts
 *
ev
);

173 (*
ev’t_£t
)(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
);

174 (*
ev’t_d–
)(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
);

175 (*
ev’t_g‘_»v’t
)(
fdev’ts
 *
ev
, 
size_t
 
ndx
);

176 (*
ev’t_g‘_fd
)(
fdev’ts
 *
ev
, 
size_t
 
ndx
);

178 (*
ev’t_Ãxt_fdndx
)(
fdev’ts
 *
ev
, 
ndx
);

180 (*
pŞl
)(
fdev’ts
 *
ev
, 
timeout_ms
);

182 (*
fú_£t
)(
fdev’ts
 *
ev
, 
fd
);

183 } 
	tfdev’ts
;

185 
fdev’ts
 *
	`fdev’t_š™
(
£rv”
 *
¤v
, 
size_t
 
maxfds
, 
fdev’t_hªdËr_t
 
ty³
);

186 
	`fdev’t_»£t
(
fdev’ts
 *
ev
);

187 
	`fdev’t_ä“
(
fdev’ts
 *
ev
);

189 
	#fdev’t_ev’t_g‘_š‹»¡
(
ev
, 
fd
) \

190 ((
fd
è>ğ0 ? (
ev
)->
fd¬¿y
[(fd)]->
ev’ts
 : 0)

	)

191 
	`fdev’t_ev’t_£t
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
, 
ev’ts
);

192 
	`fdev’t_ev’t_add
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
, 
ev’t
);

193 
	`fdev’t_ev’t_şr
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
, 
ev’t
);

194 
	`fdev’t_ev’t_d–
(
fdev’ts
 *
ev
, *
fde_ndx
, 
fd
);

195 
	`fdev’t_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
);

196 
	`fdev’t_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
);

197 
fdev’t_hªdËr
 
	`fdev’t_g‘_hªdËr
(
fdev’ts
 *
ev
, 
fd
);

198 * 
	`fdev’t_g‘_cÚ‹xt
(
fdev’ts
 *
ev
, 
fd
);

200 
	`fdev’t_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
);

202 
	`fdev’t_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
);

204 
	`fdev’t_»gi¡”
(
fdev’ts
 *
ev
, 
fd
, 
fdev’t_hªdËr
 
hªdËr
, *
ùx
);

205 
	`fdev’t_uÄegi¡”
(
fdev’ts
 *
ev
, 
fd
);

206 
	`fdev’t_sched_şo£
(
fdev’ts
 *
ev
, 
fd
, 
issock
);

207 
	`fdev’t_sched_run
(
£rv”
 *
¤v
, 
fdev’ts
 *
ev
);

209 
	`fd_şo£_Ú_exec
(
fd
);

210 
	`fdev’t_fú_£t
(
fdev’ts
 *
ev
, 
fd
);

211 
	`fdev’t_fú_£t_nb
(
fdev’ts
 *
ev
, 
fd
);

212 
	`fdev’t_fú_£t_nb_şÛxec
(
fdev’ts
 *
ev
, 
fd
);

213 
	`fdev’t_fú_£t_nb_şÛxec_sock
(
fdev’ts
 *
ev
, 
fd
);

214 
	`fdev’t_sock‘_şÛxec
(
domaš
, 
ty³
, 
´ÙocŞ
);

215 
	`fdev’t_sock‘_nb_şÛxec
(
domaš
, 
ty³
, 
´ÙocŞ
);

216 
	`fdev’t_İ’_şÛxec
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
);

218 
	`fdev’t_£Ëù_š™
(
fdev’ts
 *
ev
);

219 
	`fdev’t_pŞl_š™
(
fdev’ts
 *
ev
);

220 
	`fdev’t_lšux_sy£pŞl_š™
(
fdev’ts
 *
ev
);

221 
	`fdev’t_sŞ¬is_devpŞl_š™
(
fdev’ts
 *
ev
);

222 
	`fdev’t_sŞ¬is_pÜt_š™
(
fdev’ts
 *
ev
);

223 
	`fdev’t_ä“bsd_kqueue_š™
(
fdev’ts
 *
ev
);

224 
	`fdev’t_libev_š™
(
fdev’ts
 *
ev
);

227 
	`fdev’t_is_tı_h®f_şo£d
(
fd
);

	@fdevent_freebsd_kqueue.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<sys/ty³s.h
>

9 
	~<uni¡d.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<sigÇl.h
>

15 
	~<fú.h
>

17 #ifdeà
USE_FREEBSD_KQUEUE


18 
	~<sys/ev’t.h
>

19 
	~<sys/time.h
>

21 
	$fdev’t_ä“bsd_kqueue_ä“
(
fdev’ts
 *
ev
) {

22 
	`şo£
(
ev
->
kq_fd
);

23 
	`ä“
(
ev
->
kq_»suÉs
);

24 
	}
}

26 
	$fdev’t_ä“bsd_kqueue_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

27 
»t
, 
n
 = 0;

28 
kev’t
 
kev
[2];

29 
time¥ec
 
ts
;

30 
Ûv’ts
;

32 ià(
fde_ndx
 < 0)  -1;

34 
Ûv’ts
 = 
ev
->
fd¬¿y
[
fd
]->
ev’ts
;

36 ià(
Ûv’ts
 & 
FDEVENT_IN
) {

37 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

38 
n
++;

40 ià(
Ûv’ts
 & 
FDEVENT_OUT
) {

41 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

42 
n
++;

45 ià(0 =ğ
n
)  -1;

47 
ts
.
tv_£c
 = 0;

48 
ts
.
tv_n£c
 = 0;

50 
»t
 = 
	`kev’t
(
ev
->
kq_fd
,

51 
kev
, 
n
,

52 
NULL
, 0,

53 &
ts
);

55 ià(
»t
 == -1) {

56 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SS",

57 "kqueuev’ˆd–‘çed: ", 
	`¡»¼Ü
(
”ºo
));

63 
	}
}

65 
	$fdev’t_ä“bsd_kqueue_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

66 
»t
, 
n
 = 0;

67 
kev’t
 
kev
[2];

68 
time¥ec
 
ts
;

69 
Ûv’ts
 = 
ev
->
fd¬¿y
[
fd
]->
ev’ts
;

70 
addev’ts
 = 
ev’ts
 & ~
Ûv’ts
;

71 
d–ev’ts
 = ~
ev’ts
 & 
Ûv’ts
;

73 
	`UNUSED
(
fde_ndx
);

75 ià(
ev’ts
 =ğ
Ûv’ts
è 
fd
;

77 ià(
addev’ts
 & 
FDEVENT_IN
) {

78 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_READ
, 
EV_ADD
|
EV_CLEAR
, 0, 0, 
NULL
);

79 
n
++;

80 } ià(
d–ev’ts
 & 
FDEVENT_IN
) {

81 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

82 
n
++;

84 ià(
addev’ts
 & 
FDEVENT_OUT
) {

85 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_WRITE
, 
EV_ADD
|
EV_CLEAR
, 0, 0, 
NULL
);

86 
n
++;

87 } ià(
d–ev’ts
 & 
FDEVENT_OUT
) {

88 
	`EV_SET
(&
kev
[
n
], 
fd
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

89 
n
++;

92 ià(0 =ğ
n
è 
fd
;

94 
ts
.
tv_£c
 = 0;

95 
ts
.
tv_n£c
 = 0;

97 
»t
 = 
	`kev’t
(
ev
->
kq_fd
,

98 
kev
, 
n
,

99 
NULL
, 0,

100 &
ts
);

102 ià(
»t
 == -1) {

103 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SS",

104 "kqueuev’ˆ£ˆçed: ", 
	`¡»¼Ü
(
”ºo
));

109  
fd
;

110 
	}
}

112 
	$fdev’t_ä“bsd_kqueue_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

113 
»t
;

114 
time¥ec
 
ts
;

116 
ts
.
tv_£c
 = 
timeout_ms
 / 1000;

117 
ts
.
tv_n£c
 = (
timeout_ms
 % 1000) * 1000000;

119 
»t
 = 
	`kev’t
(
ev
->
kq_fd
,

120 
NULL
, 0,

121 
ev
->
kq_»suÉs
,ƒv->
maxfds
,

122 &
ts
);

124 ià(
»t
 == -1) {

125 
”ºo
) {

126 
EINTR
:

130 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SS",

131 "kqueuçed…Şlšg: ", 
	`¡»¼Ü
(
”ºo
));

136  
»t
;

137 
	}
}

139 
	$fdev’t_ä“bsd_kqueue_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

140 
ev’ts
 = 0, 
e
;

142 
e
 = 
ev
->
kq_»suÉs
[
ndx
].
f‹r
;

144 ià(
e
 =ğ
EVFILT_READ
) {

145 
ev’ts
 |ğ
FDEVENT_IN
;

146 } ià(
e
 =ğ
EVFILT_WRITE
) {

147 
ev’ts
 |ğ
FDEVENT_OUT
;

150 
e
 = 
ev
->
kq_»suÉs
[
ndx
].
æags
;

152 ià(
e
 & 
EV_EOF
) {

153 
ev’ts
 |ğ
FDEVENT_HUP
;

156 ià(
e
 & 
EV_ERROR
) {

157 
ev’ts
 |ğ
FDEVENT_ERR
;

160  
ev’ts
;

161 
	}
}

163 
	$fdev’t_ä“bsd_kqueue_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

164  
ev
->
kq_»suÉs
[
ndx
].
id’t
;

165 
	}
}

167 
	$fdev’t_ä“bsd_kqueue_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

168 
	`UNUSED
(
ev
);

170  (
ndx
 < 0) ? 0 :‚dx + 1;

171 
	}
}

173 
	$fdev’t_ä“bsd_kqueue_»£t
(
fdev’ts
 *
ev
) {

174 ià(-1 =ğ(
ev
->
kq_fd
 = 
	`kqueue
())) {

175 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

176 "kqueuçed (", 
	`¡»¼Ü
(
”ºo
), "),ryo set server.event-handler = \"poll\" or \"select\"");

182 
	}
}

185 
	$fdev’t_ä“bsd_kqueue_š™
(
fdev’ts
 *
ev
) {

186 
ev
->
ty³
 = 
FDEVENT_HANDLER_FREEBSD_KQUEUE
;

187 
	#SET
(
x
) \

188 
ev
->
x
 = 
fdev’t_ä“bsd_kqueue_
##x;

	)

190 
	`SET
(
ä“
);

191 
	`SET
(
pŞl
);

192 
	`SET
(
»£t
);

194 
	`SET
(
ev’t_d–
);

195 
	`SET
(
ev’t_£t
);

197 
	`SET
(
ev’t_Ãxt_fdndx
);

198 
	`SET
(
ev’t_g‘_fd
);

199 
	`SET
(
ev’t_g‘_»v’t
);

201 
ev
->
kq_fd
 = -1;

203 
ev
->
kq_»suÉs
 = 
	`ÿÎoc
Óv->
maxfds
, (*ev->kq_results));

204 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
kq_»suÉs
);

208 ià(-1 =ğ(
ev
->
kq_fd
 = 
	`kqueue
())) {

209 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

210 "kqueuçed (", 
	`¡»¼Ü
(
”ºo
), "),ryo set server.event-handler = \"poll\" or \"select\"");

215 
	`şo£
(
ev
->
kq_fd
);

216 
ev
->
kq_fd
 = -1;

219 
	}
}

221 
	$fdev’t_ä“bsd_kqueue_š™
(
fdev’ts
 *
ev
) {

222 
	`UNUSED
(
ev
);

224 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S",

228 
	}
}

	@fdevent_libev.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<as£¹.h
>

9 #ifdeà
USE_LIBEV


11 
	~<ev.h
>

13 
	$io_w©ch”_cb
(
ev_loİ
 *
loİ
, 
ev_io
 *
w
, 
»v’ts
) {

14 
fdev’ts
 *
ev
 = 
w
->
d©a
;

15 
fdev’t_hªdËr
 
hªdËr
 = 
	`fdev’t_g‘_hªdËr
(
ev
, 
w
->
fd
);

16 *
cÚ‹xt
 = 
	`fdev’t_g‘_cÚ‹xt
(
ev
, 
w
->
fd
);

17 
r
 = 0;

18 
	`UNUSED
(
loİ
);

19 ià(
NULL
 =ğ
hªdËr
) ;

21 ià(
»v’ts
 & 
EV_READ
è
r
 |ğ
FDEVENT_IN
;

22 ià(
»v’ts
 & 
EV_WRITE
è
r
 |ğ
FDEVENT_OUT
;

23 ià(
»v’ts
 & 
EV_ERROR
è
r
 |ğ
FDEVENT_ERR
;

25 
r
 = (*
hªdËr
)(
ev
->
¤v
, 
cÚ‹xt
,„)) {

26 
HANDLER_FINISHED
:

27 
HANDLER_GO_ON
:

28 
HANDLER_WAIT_FOR_EVENT
:

29 
HANDLER_WAIT_FOR_FD
:

31 
HANDLER_ERROR
:

33 
	`SEGFAULT
();

36 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "d", 
r
);

39 
	}
}

41 
	$fdev’t_libev_ä“
(
fdev’ts
 *
ev
) {

42 
	`UNUSED
(
ev
);

43 
	}
}

45 
	$fdev’t_libev_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

46 
fdnode
 *
fdn
;

47 
ev_io
 *
w©ch”
;

49 ià(-1 =ğ
fde_ndx
)  -1;

51 
fdn
 = 
ev
->
fd¬¿y
[
fd
];

52 
w©ch”
 = 
fdn
->
hªdËr_ùx
;

54 ià(!
w©ch”
)  -1;

56 
	`ev_io_¡İ
(
ev
->
libev_loİ
, 
w©ch”
);

57 
	`ä“
(
w©ch”
);

58 
fdn
->
hªdËr_ùx
 = 
NULL
;

61 
	}
}

63 
	$fdev’t_libev_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

64 
fdnode
 *
fdn
 = 
ev
->
fd¬¿y
[
fd
];

65 
ev_io
 *
w©ch”
 = 
fdn
->
hªdËr_ùx
;

66 
ev_ev’ts
 = 0;

67 
	`UNUSED
(
fde_ndx
);

69 ià(
ev’ts
 & 
FDEVENT_IN
è
ev_ev’ts
 |ğ
EV_READ
;

70 ià(
ev’ts
 & 
FDEVENT_OUT
è
ev_ev’ts
 |ğ
EV_WRITE
;

72 ià(!
w©ch”
) {

73 
fdn
->
hªdËr_ùx
 = 
w©ch”
 = 
	`ÿÎoc
(1, (
ev_io
));

74 
	`fÜû_as£¹
(
w©ch”
);

76 
	`ev_io_š™
(
w©ch”
, 
io_w©ch”_cb
, 
fd
, 
ev_ev’ts
);

77 
w©ch”
->
d©a
 = 
ev
;

78 
	`ev_io_¡¬t
(
ev
->
libev_loİ
, 
w©ch”
);

80 ià((
w©ch”
->
ev’ts
 & (
EV_READ
 | 
EV_WRITE
)è!ğ
ev_ev’ts
) {

81 
	`ev_io_¡İ
(
ev
->
libev_loİ
, 
w©ch”
);

82 
	`ev_io_£t
(
w©ch”
, w©ch”->
fd
, 
ev_ev’ts
);

83 
	`ev_io_¡¬t
(
ev
->
libev_loİ
, 
w©ch”
);

87  
fd
;

88 
	}
}

90 
	$timeout_w©ch”_cb
(
ev_loİ
 *
loİ
, 
ev_tim”
 *
w
, 
»v’ts
) {

91 
	`UNUSED
(
loİ
);

92 
	`UNUSED
(
w
);

93 
	`UNUSED
(
»v’ts
);

94 
	}
}

96 
ev_tim”
 
	gtimeout_w©ch”
;

98 
	$fdev’t_libev_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

99 
timeout_w©ch”
.
»³©
 = (
timeout_ms
 > 0) ?imeout_ms/1000.0 : 0.001;

101 
	`ev_tim”_agaš
(
ev
->
libev_loİ
, &
timeout_w©ch”
);

102 
	`ev_run
(
ev
->
libev_loİ
, 
EVRUN_ONCE
);

103 
	`fdev’t_sched_run
(
ev
->
¤v
,ƒv);

106 
	}
}

108 
	$fdev’t_libev_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

109 
	`UNUSED
(
ev
);

110 
	`UNUSED
(
ndx
);

113 
	}
}

115 
	$fdev’t_libev_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

116 
	`UNUSED
(
ev
);

117 
	`UNUSED
(
ndx
);

120 
	}
}

122 
	$fdev’t_libev_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

123 
	`UNUSED
(
ev
);

124 
	`UNUSED
(
ndx
);

127 
	}
}

129 
	$fdev’t_libev_»£t
(
fdev’ts
 *
ev
) {

130 
	`UNUSED
(
ev
);

132 
	`ev_deçuÉ_fÜk
();

135 
	}
}

137 
	$fdev’t_libev_š™
(
fdev’ts
 *
ev
) {

138 
ev_tim”
 * cÚ¡ 
tim”
 = &
timeout_w©ch”
;

140 
ev
->
ty³
 = 
FDEVENT_HANDLER_LIBEV
;

141 
	#SET
(
x
) \

142 
ev
->
x
 = 
fdev’t_libev_
##x;

	)

144 
	`SET
(
ä“
);

145 
	`SET
(
pŞl
);

146 
	`SET
(
»£t
);

148 
	`SET
(
ev’t_d–
);

149 
	`SET
(
ev’t_£t
);

151 
	`SET
(
ev’t_Ãxt_fdndx
);

152 
	`SET
(
ev’t_g‘_fd
);

153 
	`SET
(
ev’t_g‘_»v’t
);

155 ià(
NULL
 =ğ(
ev
->
libev_loİ
 = 
	`ev_deçuÉ_loİ
(0))) {

156 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S",

162 
	`ev_tim”_š™
(
tim”
, 
timeout_w©ch”_cb
, 0.0, 1.0);

165 
	}
}

168 
	$fdev’t_libev_š™
(
fdev’ts
 *
ev
) {

169 
	`UNUSED
(
ev
);

171 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S",

175 
	}
}

	@fdevent_linux_sysepoll.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<sys/ty³s.h
>

9 
	~<uni¡d.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<sigÇl.h
>

15 
	~<fú.h
>

17 #ifdeà
USE_LINUX_EPOLL


19 
	~<sys/•Şl.h
>

21 
	$fdev’t_lšux_sy£pŞl_ä“
(
fdev’ts
 *
ev
) {

22 
	`şo£
(
ev
->
•Şl_fd
);

23 
	`ä“
(
ev
->
•Şl_ev’ts
);

24 
	}
}

26 
	$fdev’t_lšux_sy£pŞl_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

27 
•Şl_ev’t
 
•
;

29 ià(
fde_ndx
 < 0)  -1;

31 
	`mem£t
(&
•
, 0, (ep));

33 
•
.
d©a
.
fd
 = fd;

34 
•
.
d©a
.
±r
 = 
NULL
;

36 ià(0 !ğ
	`•Şl_ùl
(
ev
->
•Şl_fd
, 
EPOLL_CTL_DEL
, 
fd
, &
•
)) {

37 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

38 "•Şl_ùÈçed: ", 
	`¡»¼Ü
(
”ºo
), ", dying");

40 
	`SEGFAULT
();

47 
	}
}

49 
	$fdev’t_lšux_sy£pŞl_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

50 
•Şl_ev’t
 
•
;

51 
add
 = 0;

53 ià(
fde_ndx
 =ğ-1è
add
 = 1;

55 
	`mem£t
(&
•
, 0, (ep));

57 
•
.
ev’ts
 = 0;

59 ià(
ev’ts
 & 
FDEVENT_IN
è
•
.ev’t |ğ
EPOLLIN
;

60 ià(
ev’ts
 & 
FDEVENT_OUT
è
•
.ev’t |ğ
EPOLLOUT
;

70 
•
.
ev’ts
 |ğ
EPOLLERR
 | 
EPOLLHUP
 ;

72 
•
.
d©a
.
±r
 = 
NULL
;

73 
•
.
d©a
.
fd
 = fd;

75 ià(0 !ğ
	`•Şl_ùl
(
ev
->
•Şl_fd
, 
add
 ? 
EPOLL_CTL_ADD
 : 
EPOLL_CTL_MOD
, 
fd
, &
•
)) {

76 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

77 "•Şl_ùÈçed: ", 
	`¡»¼Ü
(
”ºo
), ", dying");

79 
	`SEGFAULT
();

84  
fd
;

85 
	}
}

87 
	$fdev’t_lšux_sy£pŞl_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

88  
	`•Şl_wa™
(
ev
->
•Şl_fd
,ƒv->
•Şl_ev’ts
,ƒv->
maxfds
, 
timeout_ms
);

89 
	}
}

91 
	$fdev’t_lšux_sy£pŞl_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

92 
ev’ts
 = 0, 
e
;

94 
e
 = 
ev
->
•Şl_ev’ts
[
ndx
].
ev’ts
;

95 ià(
e
 & 
EPOLLIN
è
ev’ts
 |ğ
FDEVENT_IN
;

96 ià(
e
 & 
EPOLLOUT
è
ev’ts
 |ğ
FDEVENT_OUT
;

97 ià(
e
 & 
EPOLLERR
è
ev’ts
 |ğ
FDEVENT_ERR
;

98 ià(
e
 & 
EPOLLHUP
è
ev’ts
 |ğ
FDEVENT_HUP
;

99 ià(
e
 & 
EPOLLPRI
è
ev’ts
 |ğ
FDEVENT_PRI
;

101  
ev’ts
;

102 
	}
}

104 
	$fdev’t_lšux_sy£pŞl_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

106 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SD, D",

107 "fdev’t_lšux_sy£pŞl_ev’t_g‘_fd: ", (è
ndx
, 
ev
->
•Şl_ev’ts
[ndx].
d©a
.
fd
);

110  
ev
->
•Şl_ev’ts
[
ndx
].
d©a
.
fd
;

111 
	}
}

113 
	$fdev’t_lšux_sy£pŞl_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

114 
size_t
 
i
;

116 
	`UNUSED
(
ev
);

118 
i
 = (
ndx
 < 0) ? 0 :‚dx + 1;

120  
i
;

121 
	}
}

123 
	$fdev’t_lšux_sy£pŞl_š™
(
fdev’ts
 *
ev
) {

124 
ev
->
ty³
 = 
FDEVENT_HANDLER_LINUX_SYSEPOLL
;

125 
	#SET
(
x
) \

126 
ev
->
x
 = 
fdev’t_lšux_sy£pŞl_
##x;

	)

128 
	`SET
(
ä“
);

129 
	`SET
(
pŞl
);

131 
	`SET
(
ev’t_d–
);

132 
	`SET
(
ev’t_£t
);

134 
	`SET
(
ev’t_Ãxt_fdndx
);

135 
	`SET
(
ev’t_g‘_fd
);

136 
	`SET
(
ev’t_g‘_»v’t
);

138 ià(-1 =ğ(
ev
->
•Şl_fd
 = 
	`•Şl_ü—‹
Óv->
maxfds
))) {

139 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

140 "•Şl_ü—‹ faed (", 
	`¡»¼Ü
(
”ºo
), "),ryo set server.event-handler = \"poll\" or \"select\"");

145 
	`fd_şo£_Ú_exec
(
ev
->
•Şl_fd
);

147 
ev
->
•Şl_ev’ts
 = 
	`m®loc
Óv->
maxfds
 * (*ev->epoll_events));

148 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
•Şl_ev’ts
);

151 
	}
}

154 
	$fdev’t_lšux_sy£pŞl_š™
(
fdev’ts
 *
ev
) {

155 
	`UNUSED
(
ev
);

157 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S",

161 
	}
}

	@fdevent_poll.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<sys/ty³s.h
>

9 
	~<uni¡d.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<sigÇl.h
>

15 
	~<fú.h
>

17 #ifdeà
USE_POLL


19 #ifdeà
HAVE_POLL_H


20 
	~<pŞl.h
>

22 
	~<sys/pŞl.h
>

25 
	$fdev’t_pŞl_ä“
(
fdev’ts
 *
ev
) {

26 
	`ä“
(
ev
->
pŞlfds
);

27 ià(
ev
->
unu£d
.
±r
è
	`ä“
(ev->unused.ptr);

28 
	}
}

30 
	$fdev’t_pŞl_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

31 ià(
fde_ndx
 < 0)  -1;

33 ià((
size_t
)
fde_ndx
 >ğ
ev
->
u£d
) {

34 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SdD",

35 "d–! ouˆoà¿ng", 
fde_ndx
, (è
ev
->
u£d
);

36 
	`SEGFAULT
();

39 ià(
ev
->
pŞlfds
[
fde_ndx
].
fd
 == fd) {

40 
size_t
 
k
 = 
fde_ndx
;

42 
ev
->
pŞlfds
[
k
].
fd
 = -1;

46 ià(
ev
->
unu£d
.
size
 == 0) {

47 
ev
->
unu£d
.
size
 = 16;

48 
ev
->
unu£d
.
±r
 = 
	`m®loc
((*Óv->unu£d.±r)è*ƒv->unu£d.
size
);

49 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
unu£d
.
±r
);

50 } ià(
ev
->
unu£d
.
size
 =ğev->unu£d.
u£d
) {

51 
ev
->
unu£d
.
size
 += 16;

52 
ev
->
unu£d
.
±r
 = 
	`»®loc
Óv->unu£d.±r, (*Óv->unu£d.±r)è*ƒv->unu£d.
size
);

53 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
unu£d
.
±r
);

56 
ev
->
unu£d
.
±r
[ev->unu£d.
u£d
++] = 
k
;

58 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SdD",

59 "d–! ", 
ev
->
pŞlfds
[
fde_ndx
].
fd
, fd);

61 
	`SEGFAULT
();

65 
	}
}

68 
	$fdev’t_pŞl_ev’t_com´ess
(
fdev’ts
 *
ev
) {

69 
size_t
 
j
;

71 ià(
ev
->
u£d
 == 0)  0;

72 ià(
ev
->
unu£d
.
u£d
 != 0)  0;

74 
j
 = 
ev
->
u£d
 - 1; j + 1 > 0 &&ƒv->
pŞlfds
[j].
fd
 == -1; j--)ƒv->used--;

77 
	}
}

80 
	$fdev’t_pŞl_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

81 
³v’ts
 = 0;

82 ià(
ev’ts
 & 
FDEVENT_IN
è
³v’ts
 |ğ
POLLIN
;

83 ià(
ev’ts
 & 
FDEVENT_OUT
è
³v’ts
 |ğ
POLLOUT
;

87 ià(
fde_ndx
 != -1) {

88 ià(
ev
->
pŞlfds
[
fde_ndx
].
fd
 == fd) {

89 
ev
->
pŞlfds
[
fde_ndx
].
ev’ts
 = 
³v’ts
;

91  
fde_ndx
;

93 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SdD",

94 "£t: ", 
fde_ndx
, 
ev
->
pŞlfds
[fde_ndx].
fd
);

95 
	`SEGFAULT
();

98 ià(
ev
->
unu£d
.
u£d
 > 0) {

99 
k
 = 
ev
->
unu£d
.
±r
[--ev->unu£d.
u£d
];

101 
ev
->
pŞlfds
[
k
].
fd
 = fd;

102 
ev
->
pŞlfds
[
k
].
ev’ts
 = 
³v’ts
;

104  
k
;

106 ià(
ev
->
size
 == 0) {

107 
ev
->
size
 = 16;

108 
ev
->
pŞlfds
 = 
	`m®loc
((*ev->pŞlfdsè*ƒv->
size
);

109 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
pŞlfds
);

110 } ià(
ev
->
size
 =ğev->
u£d
) {

111 
ev
->
size
 += 16;

112 
ev
->
pŞlfds
 = 
	`»®loc
Óv->pŞlfds, (*ev->pŞlfdsè*ƒv->
size
);

113 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
pŞlfds
);

116 
ev
->
pŞlfds
[ev->
u£d
].
fd
 = fd;

117 
ev
->
pŞlfds
[ev->
u£d
].
ev’ts
 = 
³v’ts
;

119  
ev
->
u£d
++;

121 
	}
}

123 
	$fdev’t_pŞl_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

125 
	`fdev’t_pŞl_ev’t_com´ess
(
ev
);

127  
	`pŞl
(
ev
->
pŞlfds
,ƒv->
u£d
, 
timeout_ms
);

128 
	}
}

130 
	$fdev’t_pŞl_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

131 
r
, 
pŞl_r
;

133 ià(
ndx
 >ğ
ev
->
u£d
) {

134 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "sii",

135 "dyšg beÿu£:ƒv’t: ", (è
ndx
, (è
ev
->
u£d
);

137 
	`SEGFAULT
();

142 ià(
ev
->
pŞlfds
[
ndx
].
»v’ts
 & 
POLLNVAL
) {

144 
	`SEGFAULT
();

147 
r
 = 0;

148 
pŞl_r
 = 
ev
->
pŞlfds
[
ndx
].
»v’ts
;

152 ià(
pŞl_r
 & 
POLLIN
è
r
 |ğ
FDEVENT_IN
;

153 ià(
pŞl_r
 & 
POLLOUT
è
r
 |ğ
FDEVENT_OUT
;

154 ià(
pŞl_r
 & 
POLLERR
è
r
 |ğ
FDEVENT_ERR
;

155 ià(
pŞl_r
 & 
POLLHUP
è
r
 |ğ
FDEVENT_HUP
;

156 ià(
pŞl_r
 & 
POLLNVAL
è
r
 |ğ
FDEVENT_NVAL
;

157 ià(
pŞl_r
 & 
POLLPRI
è
r
 |ğ
FDEVENT_PRI
;

159  
r
;

160 
	}
}

162 
	$fdev’t_pŞl_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

163  
ev
->
pŞlfds
[
ndx
].
fd
;

164 
	}
}

166 
	$fdev’t_pŞl_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

167 
size_t
 
i
;

169 
i
 = (
ndx
 < 0) ? 0 :‚dx + 1;

170 ; 
i
 < 
ev
->
u£d
; i++) {

171 ià(
ev
->
pŞlfds
[
i
].
»v’ts
)  i;

175 
	}
}

177 
	$fdev’t_pŞl_š™
(
fdev’ts
 *
ev
) {

178 
ev
->
ty³
 = 
FDEVENT_HANDLER_POLL
;

179 
	#SET
(
x
) \

180 
ev
->
x
 = 
fdev’t_pŞl_
##x;

	)

182 
	`SET
(
ä“
);

183 
	`SET
(
pŞl
);

185 
	`SET
(
ev’t_d–
);

186 
	`SET
(
ev’t_£t
);

188 
	`SET
(
ev’t_Ãxt_fdndx
);

189 
	`SET
(
ev’t_g‘_fd
);

190 
	`SET
(
ev’t_g‘_»v’t
);

193 
	}
}

199 
	$fdev’t_pŞl_š™
(
fdev’ts
 *
ev
) {

200 
	`UNUSED
(
ev
);

202 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
,

206 
	}
}

	@fdevent_select.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<sys/time.h
>

8 
	~<sys/ty³s.h
>

10 
	~<uni¡d.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<sigÇl.h
>

15 
	~<fú.h
>

16 
	~<as£¹.h
>

18 #ifdeà
USE_SELECT


20 
	$fdev’t_£Ëù_»£t
(
fdev’ts
 *
ev
) {

21 
	`FD_ZERO
(&(
ev
->
£Ëù_£t_»ad
));

22 
	`FD_ZERO
(&(
ev
->
£Ëù_£t_wr™e
));

23 
	`FD_ZERO
(&(
ev
->
£Ëù_£t_”rÜ
));

24 
ev
->
£Ëù_max_fd
 = -1;

27 
	}
}

29 
	$fdev’t_£Ëù_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

30 ià(
fde_ndx
 < 0)  -1;

32 
	`FD_CLR
(
fd
, &(
ev
->
£Ëù_£t_»ad
));

33 
	`FD_CLR
(
fd
, &(
ev
->
£Ëù_£t_wr™e
));

34 
	`FD_CLR
(
fd
, &(
ev
->
£Ëù_£t_”rÜ
));

37 
	}
}

39 
	$fdev’t_£Ëù_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

40 
	`UNUSED
(
fde_ndx
);

43 
	`fÜû_as£¹
(
fd
 < (()
FD_SETSIZE
));

45 ià(
ev’ts
 & 
FDEVENT_IN
) {

46 
	`FD_SET
(
fd
, &(
ev
->
£Ëù_£t_»ad
));

48 
	`FD_CLR
(
fd
, &(
ev
->
£Ëù_£t_»ad
));

50 ià(
ev’ts
 & 
FDEVENT_OUT
) {

51 
	`FD_SET
(
fd
, &(
ev
->
£Ëù_£t_wr™e
));

53 
	`FD_CLR
(
fd
, &(
ev
->
£Ëù_£t_wr™e
));

55 
	`FD_SET
(
fd
, &(
ev
->
£Ëù_£t_”rÜ
));

57 ià(
fd
 > 
ev
->
£Ëù_max_fd
)ƒv->select_max_fd = fd;

59  
fd
;

60 
	}
}

62 
	$fdev’t_£Ëù_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

63 
timev®
 
tv
;

65 
tv
.
tv_£c
 = 
timeout_ms
 / 1000;

66 
tv
.
tv_u£c
 = (
timeout_ms
 % 1000) * 1000;

68 
ev
->
£Ëù_»ad
 =ƒv->
£Ëù_£t_»ad
;

69 
ev
->
£Ëù_wr™e
 =ƒv->
£Ëù_£t_wr™e
;

70 
ev
->
£Ëù_”rÜ
 =ƒv->
£Ëù_£t_”rÜ
;

72  
	`£Ëù
(
ev
->
£Ëù_max_fd
 + 1, &Óv->
£Ëù_»ad
), &Óv->
£Ëù_wr™e
), &Óv->
£Ëù_”rÜ
), &
tv
);

73 
	}
}

75 
	$fdev’t_£Ëù_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

76 
»v’ts
 = 0;

78 ià(
	`FD_ISSET
(
ndx
, &(
ev
->
£Ëù_»ad
))) {

79 
»v’ts
 |ğ
FDEVENT_IN
;

81 ià(
	`FD_ISSET
(
ndx
, &(
ev
->
£Ëù_wr™e
))) {

82 
»v’ts
 |ğ
FDEVENT_OUT
;

84 ià(
	`FD_ISSET
(
ndx
, &(
ev
->
£Ëù_”rÜ
))) {

85 
»v’ts
 |ğ
FDEVENT_ERR
;

88  
»v’ts
;

89 
	}
}

91 
	$fdev’t_£Ëù_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

92 
	`UNUSED
(
ev
);

94  
ndx
;

95 
	}
}

97 
	$fdev’t_£Ëù_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

98 
i
;

100 
i
 = (
ndx
 < 0) ? 0 :‚dx + 1;

102 ; 
i
 < 
ev
->
£Ëù_max_fd
 + 1; i++) {

103 ià(
	`FD_ISSET
(
i
, &(
ev
->
£Ëù_»ad
)))  i;

104 ià(
	`FD_ISSET
(
i
, &(
ev
->
£Ëù_wr™e
)))  i;

105 ià(
	`FD_ISSET
(
i
, &(
ev
->
£Ëù_”rÜ
)))  i;

109 
	}
}

111 
	$fdev’t_£Ëù_š™
(
fdev’ts
 *
ev
) {

112 
ev
->
ty³
 = 
FDEVENT_HANDLER_SELECT
;

113 
	#SET
(
x
) \

114 
ev
->
x
 = 
fdev’t_£Ëù_
##x;

	)

116 
	`SET
(
»£t
);

117 
	`SET
(
pŞl
);

119 
	`SET
(
ev’t_d–
);

120 
	`SET
(
ev’t_£t
);

122 
	`SET
(
ev’t_Ãxt_fdndx
);

123 
	`SET
(
ev’t_g‘_fd
);

124 
	`SET
(
ev’t_g‘_»v’t
);

127 
	}
}

130 
	$fdev’t_£Ëù_š™
(
fdev’ts
 *
ev
) {

131 
	`UNUSED
(
ev
);

134 
	}
}

	@fdevent_solaris_devpoll.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<sys/ty³s.h
>

9 
	~<uni¡d.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<sigÇl.h
>

15 
	~<fú.h
>

17 #ifdeà
USE_SOLARIS_DEVPOLL


19 
	~<sys/devpŞl.h
>

21 
	$fdev’t_sŞ¬is_devpŞl_ä“
(
fdev’ts
 *
ev
) {

22 
	`ä“
(
ev
->
devpŞlfds
);

23 
	`şo£
(
ev
->
devpŞl_fd
);

24 
	}
}

28 
	$fdev’t_sŞ¬is_devpŞl_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

29 
pŞlfd
 
pfd
;

31 ià(
fde_ndx
 < 0)  -1;

33 
pfd
.
fd
 = fd;

34 
pfd
.
ev’ts
 = 
POLLREMOVE
;

35 
pfd
.
»v’ts
 = 0;

37 ià(-1 =ğ
	`wr™e
(
ev
->
devpŞl_fd
, &
pfd
, (pfd))) {

38 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S(D, S)",

39 "(d–èwr™çed: ", 
fd
, 
	`¡»¼Ü
(
”ºo
));

45 
	}
}

47 
	$fdev’t_sŞ¬is_devpŞl_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

48 
pŞlfd
 
pfd
;

49 
add
 = 0;

51 
³v’ts
 = 0;

52 ià(
ev’ts
 & 
FDEVENT_IN
è
³v’ts
 |ğ
POLLIN
;

53 ià(
ev’ts
 & 
FDEVENT_OUT
è
³v’ts
 |ğ
POLLOUT
;

55 ià(
fde_ndx
 =ğ-1è
add
 = 1;

57 
pfd
.
fd
 = fd;

58 
pfd
.
ev’ts
 = 
³v’ts
;

59 
pfd
.
»v’ts
 = 0;

61 ià(-1 =ğ
	`wr™e
(
ev
->
devpŞl_fd
, &
pfd
, (pfd))) {

62 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S(D, S)",

63 "(£tèwr™çed: ", 
fd
, 
	`¡»¼Ü
(
”ºo
));

68  
fd
;

69 
	}
}

71 
	$fdev’t_sŞ¬is_devpŞl_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

72 
dvpŞl
 
dİŞl
;

73 
»t
;

75 
dİŞl
.
dp_timeout
 = 
timeout_ms
;

76 
dİŞl
.
dp_nfds
 = 
ev
->
maxfds
 - 1;

77 
dİŞl
.
dp_fds
 = 
ev
->
devpŞlfds
;

79 
»t
 = 
	`ioùl
(
ev
->
devpŞl_fd
, 
DP_POLL
, &
dİŞl
);

81  
»t
;

82 
	}
}

84 
	$fdev’t_sŞ¬is_devpŞl_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

85 
r
, 
pŞl_r
;

87 
r
 = 0;

88 
pŞl_r
 = 
ev
->
devpŞlfds
[
ndx
].
»v’ts
;

92 ià(
pŞl_r
 & 
POLLIN
è
r
 |ğ
FDEVENT_IN
;

93 ià(
pŞl_r
 & 
POLLOUT
è
r
 |ğ
FDEVENT_OUT
;

94 ià(
pŞl_r
 & 
POLLERR
è
r
 |ğ
FDEVENT_ERR
;

95 ià(
pŞl_r
 & 
POLLHUP
è
r
 |ğ
FDEVENT_HUP
;

96 ià(
pŞl_r
 & 
POLLNVAL
è
r
 |ğ
FDEVENT_NVAL
;

97 ià(
pŞl_r
 & 
POLLPRI
è
r
 |ğ
FDEVENT_PRI
;

99  
r
;

100 
	}
}

102 
	$fdev’t_sŞ¬is_devpŞl_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

103  
ev
->
devpŞlfds
[
ndx
].
fd
;

104 
	}
}

106 
	$fdev’t_sŞ¬is_devpŞl_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
Ï¡_ndx
) {

107 
size_t
 
i
;

109 
	`UNUSED
(
ev
);

111 
i
 = (
Ï¡_ndx
 < 0) ? 0 :†ast_ndx + 1;

113  
i
;

114 
	}
}

116 
	$fdev’t_sŞ¬is_devpŞl_»£t
(
fdev’ts
 *
ev
) {

119 ià((
ev
->
devpŞl_fd
 = 
	`İ’
("/dev/pŞl", 
O_RDWR
)) < 0) {

120 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

121 "İ’šg /dev/pŞÈçed (", 
	`¡»¼Ü
(
”ºo
), "),ryo set server.event-handler = \"poll\" or \"select\"");

126 
	`fd_şo£_Ú_exec
(
ev
->
devpŞl_fd
);

128 
	}
}

129 
	$fdev’t_sŞ¬is_devpŞl_š™
(
fdev’ts
 *
ev
) {

130 
ev
->
ty³
 = 
FDEVENT_HANDLER_SOLARIS_DEVPOLL
;

131 
	#SET
(
x
) \

132 
ev
->
x
 = 
fdev’t_sŞ¬is_devpŞl_
##x;

	)

134 
	`SET
(
ä“
);

135 
	`SET
(
pŞl
);

136 
	`SET
(
»£t
);

138 
	`SET
(
ev’t_d–
);

139 
	`SET
(
ev’t_£t
);

141 
	`SET
(
ev’t_Ãxt_fdndx
);

142 
	`SET
(
ev’t_g‘_fd
);

143 
	`SET
(
ev’t_g‘_»v’t
);

145 
ev
->
devpŞlfds
 = 
	`m®loc
((*ev->devpŞlfdsè*ƒv->
maxfds
);

146 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
devpŞlfds
);

148 ià((
ev
->
devpŞl_fd
 = 
	`İ’
("/dev/pŞl", 
O_RDWR
)) < 0) {

149 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

150 "İ’šg /dev/pŞÈçed (", 
	`¡»¼Ü
(
”ºo
), "),ryo set server.event-handler = \"poll\" or \"select\"");

156 
	`şo£
(
ev
->
devpŞl_fd
);

158 
ev
->
devpŞl_fd
 = -1;

161 
	}
}

164 
	$fdev’t_sŞ¬is_devpŞl_š™
(
fdev’ts
 *
ev
) {

165 
	`UNUSED
(
ev
);

167 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S",

171 
	}
}

	@fdevent_solaris_port.c

1 
	~"fœ¡.h
"

3 
	~"fdev’t.h
"

4 
	~"bufãr.h
"

5 
	~"log.h
"

7 
	~<sys/ty³s.h
>

9 
	~<uni¡d.h
>

10 
	~<¡dlib.h
>

11 
	~<¡dio.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<sigÇl.h
>

15 
	~<fú.h
>

17 #ifdeà
USE_SOLARIS_PORT


19 cÚ¡ 
	gSOLARIS_PORT_POLL_READ
 = 
POLLIN
;

20 cÚ¡ 
	gSOLARIS_PORT_POLL_WRITE
 = 
POLLOUT
;

21 cÚ¡ 
	gSOLARIS_PORT_POLL_READ_WRITE
 = 
POLLIN
 & 
POLLOUT
;

23 
	$fdev’t_sŞ¬is_pÜt_ev’t_d–
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
) {

24 ià(
fde_ndx
 < 0)  -1;

26 ià(0 !ğ
	`pÜt_dissocŸ‹
(
ev
->
pÜt_fd
, 
PORT_SOURCE_FD
, 
fd
)) {

27 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

28 "pÜt_dissocŸ‹ faed: ", 
	`¡»¼Ü
(
”ºo
), ", dying");

30 
	`SEGFAULT
();

36 
	}
}

38 
	$fdev’t_sŞ¬is_pÜt_ev’t_£t
(
fdev’ts
 *
ev
, 
fde_ndx
, 
fd
, 
ev’ts
) {

39 cÚ¡ * 
u£r_d©a
 = 
NULL
;

41 ià((
ev’ts
 & 
FDEVENT_IN
è&& (ev’t & 
FDEVENT_OUT
)) {

42 
u£r_d©a
 = &
SOLARIS_PORT_POLL_READ_WRITE
;

43 } ià(
ev’ts
 & 
FDEVENT_IN
) {

44 
u£r_d©a
 = &
SOLARIS_PORT_POLL_READ
;

45 } ià(
ev’ts
 & 
FDEVENT_OUT
) {

46 
u£r_d©a
 = &
SOLARIS_PORT_POLL_WRITE
;

49 ià(0 !ğ
	`pÜt_assocŸ‹
(
ev
->
pÜt_fd
, 
PORT_SOURCE_FD
, 
fd
, *
u£r_d©a
, (*) user_data)) {

50 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

51 "pÜt_assocŸ‹ faed: ", 
	`¡»¼Ü
(
”ºo
), ", dying");

53 
	`SEGFAULT
();

58  
fd
;

59 
	}
}

61 
	$fdev’t_sŞ¬is_pÜt_ev’t_g‘_»v’t
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

62 
ev’ts
 = 0, 
e
;

64 
e
 = 
ev
->
pÜt_ev’ts
[
ndx
].
pÜ‹v_ev’ts
;

65 ià(
e
 & 
POLLIN
è
ev’ts
 |ğ
FDEVENT_IN
;

66 ià(
e
 & 
POLLOUT
è
ev’ts
 |ğ
FDEVENT_OUT
;

67 ià(
e
 & 
POLLERR
è
ev’ts
 |ğ
FDEVENT_ERR
;

68 ià(
e
 & 
POLLHUP
è
ev’ts
 |ğ
FDEVENT_HUP
;

69 ià(
e
 & 
POLLPRI
è
ev’ts
 |ğ
FDEVENT_PRI
;

70 ià(
e
 & 
POLLNVAL
è
ev’ts
 |ğ
FDEVENT_NVAL
;

72  
e
;

73 
	}
}

75 
	$fdev’t_sŞ¬is_pÜt_ev’t_g‘_fd
(
fdev’ts
 *
ev
, 
size_t
 
ndx
) {

76  
ev
->
pÜt_ev’ts
[
ndx
].
pÜ‹v_objeù
;

77 
	}
}

79 
	$fdev’t_sŞ¬is_pÜt_ev’t_Ãxt_fdndx
(
fdev’ts
 *
ev
, 
ndx
) {

80 
size_t
 
i
;

82 
	`UNUSED
(
ev
);

84 
i
 = (
ndx
 < 0) ? 0 :‚dx + 1;

86  
i
;

87 
	}
}

89 
	$fdev’t_sŞ¬is_pÜt_ä“
(
fdev’ts
 *
ev
) {

90 
	`şo£
(
ev
->
pÜt_fd
);

91 
	`ä“
(
ev
->
pÜt_ev’ts
);

92 
	}
}

95 
	$fdev’t_sŞ¬is_pÜt_pŞl
(
fdev’ts
 *
ev
, 
timeout_ms
) {

96 
i
 = 0;

97 
»t
;

98 
avaabË_ev’ts
, 
wa™_fÜ_ev’ts
 = 0;

99 cÚ¡ *
u£r_d©a
;

101 
time¥ec
 
timeout
;

103 
timeout
.
tv_£c
 = 
timeout_ms
/1000L;

104 
timeout
.
tv_n£c
 = (
timeout_ms
 % 1000L) * 1000000L;

107 ià((
»t
 = 
	`pÜt_g‘n
(
ev
->
pÜt_fd
,ƒv->
pÜt_ev’ts
, 0, &
wa™_fÜ_ev’ts
, &
timeout
)) < 0) „et;

110 ià(0 =ğ
wa™_fÜ_ev’ts
) wait_for_events = 1;

112 
avaabË_ev’ts
 = 
wa™_fÜ_ev’ts
;

115 ià((
»t
 = 
	`pÜt_g‘n
(
ev
->
pÜt_fd
,ƒv->
pÜt_ev’ts
,ƒv->
maxfds
, &
avaabË_ev’ts
, &
timeout
)) < 0) {

118 ià(!(
”ºo
 =ğ
ETIME
 && 
wa™_fÜ_ev’ts
 !ğ
avaabË_ev’ts
)è 
»t
;

121 
i
 = 0; i < 
avaabË_ev’ts
; ++i) {

122 
u£r_d©a
 = (cÚ¡ *è
ev
->
pÜt_ev’ts
[
i
].
pÜ‹v_u£r
;

124 ià((
»t
 = 
	`pÜt_assocŸ‹
(
ev
->
pÜt_fd
, 
PORT_SOURCE_FD
,ƒv->
pÜt_ev’ts
[
i
].
pÜ‹v_objeù
,

125 *
u£r_d©a
, (*) user_data)) < 0) {

126 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

127 "pÜt_assocŸ‹ faed: ", 
	`¡»¼Ü
(
”ºo
), ", dying");

129 
	`SEGFAULT
();

135  
avaabË_ev’ts
;

136 
	}
}

138 
	$fdev’t_sŞ¬is_pÜt_š™
(
fdev’ts
 *
ev
) {

139 
ev
->
ty³
 = 
FDEVENT_HANDLER_SOLARIS_PORT
;

140 
	#SET
(
x
) \

141 
ev
->
x
 = 
fdev’t_sŞ¬is_pÜt_
##x;

	)

143 
	`SET
(
ä“
);

144 
	`SET
(
pŞl
);

146 
	`SET
(
ev’t_d–
);

147 
	`SET
(
ev’t_£t
);

149 
	`SET
(
ev’t_Ãxt_fdndx
);

150 
	`SET
(
ev’t_g‘_fd
);

151 
	`SET
(
ev’t_g‘_»v’t
);

153 ià((
ev
->
pÜt_fd
 = 
	`pÜt_ü—‹
()) < 0) {

154 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

155 "pÜt_ü—‹(èçed (", 
	`¡»¼Ü
(
”ºo
), "),ryo set server.event-handler = \"poll\" or \"select\"");

160 
ev
->
pÜt_ev’ts
 = 
	`m®loc
Óv->
maxfds
 * (*ev->port_events));

161 
	`fÜû_as£¹
(
NULL
 !ğ
ev
->
pÜt_ev’ts
);

164 
	}
}

167 
	$fdev’t_sŞ¬is_pÜt_š™
(
fdev’ts
 *
ev
) {

168 
	`UNUSED
(
ev
);

170 
	`log_”rÜ_wr™e
(
ev
->
¤v
, 
__FILE__
, 
__LINE__
, "S",

174 
	}
}

	@first.h

1 #iâdeà
LI_FIRST_H


2 
	#LI_FIRST_H


	)

4 #ifdeà
HAVE_CONFIG_H


5 
	~"cÚfig.h
"

7 #iâdeà
_GNU_SOURCE


8 
	#_GNU_SOURCE


	)

12 #iâdeà
__STDC_WANT_LIB_EXT1__


13 
	#__STDC_WANT_LIB_EXT1__
 1

	)

	@http-header-glue.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"¬¿y.h
"

5 
	~"bufãr.h
"

6 
	~"log.h
"

7 
	~"‘ag.h
"

8 
	~"h‰p_chunk.h
"

9 
	~"»¥Ú£.h
"

10 
	~"¡©_ÿche.h
"

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

15 
	~<time.h
>

44 #ifdeà
HAVE_IPV6


45 #iâdeà
SA_LEN


46 #ifdeà
HAVE_SOCKADDR_SA_LEN


47 
	#SA_LEN
(
addr
è(×ddr)->
§_Ën
)

	)

49 #ifdeà
HAVE_STRUCT_SOCKADDR_STORAGE


50 
size_t
 
	$g‘_§_Ën
(cÚ¡ 
sockaddr
 *
addr
) {

51 
addr
->
§_çmy
) {

53 #ifdeà
AF_INET


54 
AF_INET
:

55  ( (
sockaddr_š
));

58 #ifdeà
AF_INET6


59 
AF_INET6
:

60  ( (
sockaddr_š6
));

64  ( (
sockaddr
));

67 
	}
}

68 
	#SA_LEN
(
addr
è(
	`g‘_§_Ën
×ddr))

	)

70 
	#SA_LEN
(
addr
è( (
sockaddr
))

	)

79 
	$»¥Ú£_h—d”_š£¹
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, 
size_t
 
keyËn
, cÚ¡ *
v®ue
, size_ˆ
v®Ën
) {

80 
d©a_¡ršg
 *
ds
;

82 
	`UNUSED
(
¤v
);

84 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

85 
ds
 = 
	`d©a_»¥Ú£_š™
();

87 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
keyËn
);

88 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, v®ue, 
v®Ën
);

90 
	`¬¿y_š£¹_unique
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
ds
);

93 
	}
}

95 
	$»¥Ú£_h—d”_ov”wr™e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, 
size_t
 
keyËn
, cÚ¡ *
v®ue
, size_ˆ
v®Ën
) {

96 
d©a_¡ršg
 *
ds
;

98 
	`UNUSED
(
¤v
);

101 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
key
))) {

102 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, value);

107  
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
key
, 
keyËn
, 
v®ue
, 
v®Ën
);

108 
	}
}

110 
	$»¥Ú£_h—d”_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, 
size_t
 
keyËn
, cÚ¡ *
v®ue
, size_ˆ
v®Ën
) {

111 
d©a_¡ršg
 *
ds
;

113 
	`UNUSED
(
¤v
);

116 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
key
))) {

117 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
(", "));

118 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, v®ue, 
v®Ën
);

122  
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
key
, 
keyËn
, 
v®ue
, 
v®Ën
);

123 
	}
}

125 
	$h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

126 
bufãr
 *
o
;

128 
o
 = 
	`bufãr_š™
();

130 
	`bufãr_cİy_bufãr
(
o
, 
cÚ
->
uri
.
scheme
);

131 
	`bufãr_­³nd_¡ršg_Ën
(
o
, 
	`CONST_STR_LEN
("://"));

132 ià(!
	`bufãr_is_em±y
(
cÚ
->
uri
.
authÜ™y
)) {

133 
	`bufãr_­³nd_¡ršg_bufãr
(
o
, 
cÚ
->
uri
.
authÜ™y
);

136 
ho¡’t
 *
he
;

137 #ifdeà
HAVE_IPV6


138 
hbuf
[256];

140 
sock_addr
 
our_addr
;

141 
sockËn_t
 
our_addr_Ën
;

143 
our_addr_Ën
 = (
our_addr
);

145 ià(-1 =ğ
	`g‘sockÇme
(
cÚ
->
fd
, (
sockaddr
 *)&
our_addr
, &
our_addr_Ën
)

146 || 
our_addr_Ën
 > (
sockËn_t
)(
our_addr
)) {

147 
cÚ
->
h‰p_¡©us
 = 500;

149 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

150 "ÿn'ˆg‘ sockÇme", 
	`¡»¼Ü
(
”ºo
));

152 
	`bufãr_ä“
(
o
);

158 
our_addr
.
¶aš
.
§_çmy
) {

159 #ifdeà
HAVE_IPV6


160 
AF_INET6
:

161 ià(0 !ğ
	`g‘Çmešfo
((cÚ¡ 
sockaddr
 *)(&
our_addr
.
v6
),

162 
	`SA_LEN
((cÚ¡ 
sockaddr
 *)&
our_addr
.
v6
),

163 
hbuf
, (hbuf), 
NULL
, 0, 0)) {

165 
d¡
[
INET6_ADDRSTRLEN
];

167 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

169 
	`¡»¼Ü
(
”ºo
), ", using ip-address instead");

171 
	`bufãr_­³nd_¡ršg_Ën
(
o
, 
	`CONST_STR_LEN
("["));

172 
	`bufãr_­³nd_¡ršg
(
o
,

173 
	`š‘_Áİ
(
AF_INET6
, (*)&
our_addr
.
v6
.
sš6_addr
,

174 
d¡
, (dst)));

175 
	`bufãr_­³nd_¡ršg_Ën
(
o
, 
	`CONST_STR_LEN
("]"));

177 
	`bufãr_­³nd_¡ršg
(
o
, 
hbuf
);

181 
AF_INET
:

182 ià(
NULL
 =ğ(
he
 = 
	`g‘ho¡byaddr
((*)&
our_addr
.
v4
.
sš_addr
, (
š_addr
), 
AF_INET
))) {

183 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

185 
h_”ºo
, ", using ip-address instead");

187 
	`bufãr_­³nd_¡ršg
(
o
, 
	`š‘_Áß
(
our_addr
.
v4
.
sš_addr
));

189 
	`bufãr_­³nd_¡ršg
(
o
, 
he
->
h_Çme
);

193 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

196 
	`bufãr_ä“
(
o
);

201 
deçuÉ_pÜt
 = 80;

202 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
cÚ
->
uri
.
scheme
, 
	`CONST_STR_LEN
("https"))) {

203 
deçuÉ_pÜt
 = 443;

205 ià(
deçuÉ_pÜt
 !ğ
¤v
->
¤vcÚf
.
pÜt
) {

206 
	`bufãr_­³nd_¡ršg_Ën
(
o
, 
	`CONST_STR_LEN
(":"));

207 
	`bufãr_­³nd_št
(
o
, 
¤v
->
¤vcÚf
.
pÜt
);

211 
	`bufãr_­³nd_¡ršg_’coded
(
o
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
), 
ENCODING_REL_URI
);

212 
	`bufãr_­³nd_¡ršg_Ën
(
o
, 
	`CONST_STR_LEN
("/"));

213 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
)) {

214 
	`bufãr_­³nd_¡ršg_Ën
(
o
, 
	`CONST_STR_LEN
("?"));

215 
	`bufãr_­³nd_¡ršg_bufãr
(
o
, 
cÚ
->
uri
.
qu”y
);

218 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("LoÿtiÚ"), 
	`CONST_BUF_LEN
(
o
));

220 
cÚ
->
h‰p_¡©us
 = 301;

221 
cÚ
->
fe_fšished
 = 1;

223 
	`bufãr_ä“
(
o
);

226 
	}
}

228 
bufãr
 * 
	$¡ráime_ÿche_g‘
(
£rv”
 *
¤v
, 
time_t
 
Ï¡_mod
) {

229 
tm
 *tm;

230 
size_t
 
i
;

232 
i
 = 0; i < 
FILE_CACHE_MAX
; i++) {

234 ià(
¤v
->
mtime_ÿche
[
i
].
mtime
 =ğ
Ï¡_mod
è srv->mtime_ÿche[i].
¡r
;

237 ià(
¤v
->
mtime_ÿche
[
i
].
mtime
 == 0) ;

240 ià(
i
 =ğ
FILE_CACHE_MAX
) {

241 
i
 = 0;

244 
¤v
->
mtime_ÿche
[
i
].
mtime
 = 
Ï¡_mod
;

245 
	`bufãr_¡ršg_´•¬e_cİy
(
¤v
->
mtime_ÿche
[
i
].
¡r
, 1023);

246 
tm
 = 
	`gmtime
(&(
¤v
->
mtime_ÿche
[
i
].
mtime
));

247 
	`bufãr_­³nd_¡ráime
(
¤v
->
mtime_ÿche
[
i
].
¡r
, "%a, %d %b %Y %H:%M:%S GMT", 
tm
);

249  
¤v
->
mtime_ÿche
[
i
].
¡r
;

250 
	}
}

253 
	$h‰p_»¥Ú£_hªdË_ÿchabË
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
mtime
) {

254 
h—d_Ü_g‘
 =

255 Ğ
HTTP_METHOD_GET
 =ğ
cÚ
->
»que¡
.
h‰p_m‘hod


256 || 
HTTP_METHOD_HEAD
 =ğ
cÚ
->
»que¡
.
h‰p_m‘hod
);

257 
	`UNUSED
(
¤v
);

269 ià(
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
) {

273 ià(
	`‘ag_is_equ®
(
cÚ
->
physiÿl
.
‘ag
, cÚ->
»que¡
.
h‰p_if_nÚe_m©ch
, 0)) {

274 ià(
h—d_Ü_g‘
) {

275 
cÚ
->
h‰p_¡©us
 = 304;

276  
HANDLER_FINISHED
;

278 
cÚ
->
h‰p_¡©us
 = 412;

279 
cÚ
->
mode
 = 
DIRECT
;

280  
HANDLER_FINISHED
;

283 } ià(
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
 && 
h—d_Ü_g‘
) {

285 
size_t
 
u£d_Ën
;

286 *
£micŞÚ
;

288 ià(
NULL
 =ğ(
£micŞÚ
 = 
	`¡rchr
(
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
, ';'))) {

289 
u£d_Ën
 = 
	`¡¾’
(
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
);

291 
u£d_Ën
 = 
£micŞÚ
 - 
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
;

294 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
, 
mtime
->
±r
, 
u£d_Ën
)) {

295 ià('\0' =ğ
mtime
->
±r
[
u£d_Ën
]è
cÚ
->
h‰p_¡©us
 = 304;

296  
HANDLER_FINISHED
;

298 
buf
[("Sat, 23 Jul 2005 21:20:01 GMT")];

299 
time_t
 
t_h—d”
, 
t_fe
;

300 
tm
m;

303 ià(
u£d_Ën
 >ğ(
buf
)è 
HANDLER_GO_ON
;

305 
	`¡ºıy
(
buf
, 
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
, 
u£d_Ën
);

306 
buf
[
u£d_Ën
] = '\0';

308 ià(
NULL
 =ğ
	`¡½time
(
buf
, "%a, %d %b %Y %H:%M:%S GMT", &
tm
)) {

312  
HANDLER_GO_ON
;

314 
tm
.
tm_isd¡
 = 0;

315 
t_h—d”
 = 
	`mktime
(&
tm
);

317 
	`¡½time
(
mtime
->
±r
, "%a, %d %b %Y %H:%M:%S GMT", &
tm
);

318 
tm
.
tm_isd¡
 = 0;

319 
t_fe
 = 
	`mktime
(&
tm
);

321 ià(
t_fe
 > 
t_h—d”
è 
HANDLER_GO_ON
;

323 
cÚ
->
h‰p_¡©us
 = 304;

324  
HANDLER_FINISHED
;

328  
HANDLER_GO_ON
;

329 
	}
}

332 
	$h‰p_»¥Ú£_·r£_¿nge
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
·th
, 
¡©_ÿche_’Œy
 *
sû
) {

333 
muÉ¬t
 = 0;

334 
”rÜ
;

335 
off_t
 
¡¬t
, 
’d
;

336 cÚ¡ *
s
, *
mšus
;

337 *
bound¬y
 = "fkj49sn38dcn3";

338 
d©a_¡ršg
 *
ds
;

339 
bufãr
 *
cÚ‹Á_ty³
 = 
NULL
;

341 
¡¬t
 = 0;

342 
’d
 = 
sû
->
¡
.
¡_size
 - 1;

344 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 0;

346 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Type"))) {

347 
cÚ‹Á_ty³
 = 
ds
->
v®ue
;

350 
s
 = 
cÚ
->
»que¡
.
h‰p_¿nge
, 
”rÜ
 = 0;

351 !
”rÜ
 && *
s
 && 
NULL
 !ğ(
mšus
 = 
	`¡rchr
(s, '-')); ) {

352 *
”r
;

353 
off_t
 
Ï
, 
Ë
;

355 ià(
s
 =ğ
mšus
) {

358 
Ë
 = 
	`¡¹Şl
(
s
, &
”r
, 10);

360 ià(
Ë
 == 0) {

363 
cÚ
->
h‰p_¡©us
 = 416;

364 
”rÜ
 = 1;

365 } ià(*
”r
 == '\0') {

367 
s
 = 
”r
;

369 
’d
 = 
sû
->
¡
.
¡_size
 - 1;

370 
¡¬t
 = 
sû
->
¡
.
¡_size
 + 
Ë
;

371 } ià(*
”r
 == ',') {

372 
muÉ¬t
 = 1;

373 
s
 = 
”r
 + 1;

375 
’d
 = 
sû
->
¡
.
¡_size
 - 1;

376 
¡¬t
 = 
sû
->
¡
.
¡_size
 + 
Ë
;

378 
”rÜ
 = 1;

381 } ià(*(
mšus
+1) == '\0' || *(minus+1) == ',') {

384 
Ï
 = 
	`¡¹Şl
(
s
, &
”r
, 10);

386 ià(
”r
 =ğ
mšus
) {

389 ià(*(
”r
 + 1) == '\0') {

390 
s
 = 
”r
 + 1;

392 
’d
 = 
sû
->
¡
.
¡_size
 - 1;

393 
¡¬t
 = 
Ï
;

395 } ià(*(
”r
 + 1) == ',') {

396 
muÉ¬t
 = 1;

397 
s
 = 
”r
 + 2;

399 
’d
 = 
sû
->
¡
.
¡_size
 - 1;

400 
¡¬t
 = 
Ï
;

402 
”rÜ
 = 1;

406 
”rÜ
 = 1;

411 
Ï
 = 
	`¡¹Şl
(
s
, &
”r
, 10);

413 ià(
”r
 =ğ
mšus
) {

414 
Ë
 = 
	`¡¹Şl
(
mšus
+1, &
”r
, 10);

417 ià(
Ï
 > 
Ë
) {

418 
”rÜ
 = 1;

421 ià(*
”r
 == '\0') {

423 
s
 = 
”r
;

425 
’d
 = 
Ë
;

426 
¡¬t
 = 
Ï
;

427 } ià(*
”r
 == ',') {

428 
muÉ¬t
 = 1;

429 
s
 = 
”r
 + 1;

431 
’d
 = 
Ë
;

432 
¡¬t
 = 
Ï
;

436 
”rÜ
 = 1;

441 
”rÜ
 = 1;

445 ià(!
”rÜ
) {

446 ià(
¡¬t
 < 0) start = 0;

449 ià(
’d
 > 
sû
->
¡
.
¡_size
 - 1)ƒnd = sce->st.st_size - 1;

451 ià(
¡¬t
 > 
sû
->
¡
.
¡_size
 - 1) {

452 
”rÜ
 = 1;

454 
cÚ
->
h‰p_¡©us
 = 416;

458 ià(!
”rÜ
) {

459 ià(
muÉ¬t
) {

461 
bufãr
 *
b
 = 
	`bufãr_š™
();

463 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n--"));

464 
	`bufãr_­³nd_¡ršg
(
b
, 
bound¬y
);

467 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\nContent-Range: bytes "));

468 
	`bufãr_­³nd_št
(
b
, 
¡¬t
);

469 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

470 
	`bufãr_­³nd_št
(
b
, 
’d
);

471 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("/"));

472 
	`bufãr_­³nd_št
(
b
, 
sû
->
¡
.
¡_size
);

474 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\nContent-Type: "));

475 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ‹Á_ty³
);

478 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n\r\n"));

480 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 +ğ
	`bufãr_¡ršg_Ëngth
(
b
);

481 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

482 
	`bufãr_ä“
(
b
);

485 
	`chunkqueue_­³nd_fe
(
cÚ
->
wr™e_queue
, 
·th
, 
¡¬t
, 
’d
 - start + 1);

486 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 +ğ
’d
 - 
¡¬t
 + 1;

491 ià(
”rÜ
)  -1;

493 ià(
muÉ¬t
) {

495 
bufãr
 *
b
 = 
	`bufãr_š™
();

497 
	`bufãr_cİy_¡ršg_Ën
(
b
, "\r\n--", 4);

498 
	`bufãr_­³nd_¡ršg
(
b
, 
bound¬y
);

499 
	`bufãr_­³nd_¡ršg_Ën
(
b
, "--\r\n", 4);

501 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 +ğ
	`bufãr_¡ršg_Ëngth
(
b
);

502 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

503 
	`bufãr_ä“
(
b
);

507 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("multipart/byteranges; boundary="));

508 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
bound¬y
);

511 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(¤v->
tmp_buf
));

515 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("bytes "));

516 
	`bufãr_­³nd_št
(
¤v
->
tmp_buf
, 
¡¬t
);

517 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("-"));

518 
	`bufãr_­³nd_št
(
¤v
->
tmp_buf
, 
’d
);

519 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("/"));

520 
	`bufãr_­³nd_št
(
¤v
->
tmp_buf
, 
sû
->
¡
.
¡_size
);

522 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Rªge"), 
	`CONST_BUF_LEN
(¤v->
tmp_buf
));

527 
	}
}

530 
	$h‰p_»¥Ú£_£nd_fe
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
·th
) {

531 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

532 
bufãr
 *
mtime
 = 
NULL
;

533 
d©a_¡ršg
 *
ds
;

534 
®low_ÿchšg
 = (0 =ğ
cÚ
->
h‰p_¡©us
 || 200 == con->http_status);

536 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
·th
, &
sû
)) {

537 
cÚ
->
h‰p_¡©us
 = (
”ºo
 =ğ
ENOENT
) ? 404 : 403;

539 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsb",

540 "nÙ‡„eguÏ¸fe:", 
cÚ
->
uri
.
·th
,

541 "->", 
·th
);

547 #ifdeà
HAVE_LSTAT


548 ià((
sû
->
is_symlšk
 =ğ1è&& !
cÚ
->
cÚf
.
fŞlow_symlšk
) {

549 
cÚ
->
h‰p_¡©us
 = 403;

551 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

552 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--‡ccess denied due symlink„estriction");

553 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
·th
);

559 ià(!
	`S_ISREG
(
sû
->
¡
.
¡_mode
)) {

560 
cÚ
->
h‰p_¡©us
 = 403;

562 ià(
cÚ
->
cÚf
.
log_fe_nÙ_found
) {

563 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsb",

564 "nÙ‡„eguÏ¸fe:", 
cÚ
->
uri
.
·th
,

565 "->", 
sû
->
Çme
);

575 ià(
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Type")) {

576 ià(
	`bufãr_¡ršg_is_em±y
(
sû
->
cÚ‹Á_ty³
)) {

583 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("application/octet-stream"));

585 
®low_ÿchšg
 = 0;

587 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
sû
->
cÚ‹Á_ty³
));

591 ià(
cÚ
->
cÚf
.
¿nge_»que¡s
) {

592 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Accept-Ranges"), CONST_STR_LEN("bytes"));

595 ià(
®low_ÿchšg
) {

596 ià(
cÚ
->
‘ag_æags
 !ğ0 && !
	`bufãr_¡ršg_is_em±y
(
sû
->
‘ag
)) {

597 ià(
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "ETag")) {

599 
	`‘ag_mu‹
(
cÚ
->
physiÿl
.
‘ag
, 
sû
->etag);

601 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("ETag"), 
	`CONST_BUF_LEN
(cÚ->
physiÿl
.
‘ag
));

606 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Last-Modified"))) {

607 
mtime
 = 
	`¡ráime_ÿche_g‘
(
¤v
, 
sû
->
¡
.
¡_mtime
);

608 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("La¡-Modif›d"), 
	`CONST_BUF_LEN
(
mtime
));

610 
mtime
 = 
ds
->
v®ue
;

613 ià(
HANDLER_FINISHED
 =ğ
	`h‰p_»¥Ú£_hªdË_ÿchabË
(
¤v
, 
cÚ
, 
mtime
)) {

618 ià(
cÚ
->
»que¡
.
h‰p_¿nge
 && cÚ->
cÚf
.
¿nge_»que¡s


619 && (200 =ğ
cÚ
->
h‰p_¡©us
 || 0 == con->http_status)

620 && 
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Encoding")) {

621 
do_¿nge_»que¡
 = 1;

624 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "If-Range"))) {

628 ià(
ds
->
v®ue
->
±r
[0] == '"') {

632 ià(!
cÚ
->
physiÿl
.
‘ag
) {

633 
do_¿nge_»que¡
 = 0;

634 } ià(!
	`bufãr_is_equ®
(
ds
->
v®ue
, 
cÚ
->
physiÿl
.
‘ag
)) {

635 
do_¿nge_»que¡
 = 0;

637 } ià(!
mtime
) {

643 
do_¿nge_»que¡
 = 0;

644 } ià(!
	`bufãr_is_equ®
(
ds
->
v®ue
, 
mtime
)) {

645 
do_¿nge_»que¡
 = 0;

649 ià(
do_¿nge_»que¡
) {

651 
cÚ
->
fe_fšished
 = 1;

653 ià(0 =ğ
	`h‰p_»¥Ú£_·r£_¿nge
(
¤v
, 
cÚ
, 
·th
, 
sû
)) {

654 
cÚ
->
h‰p_¡©us
 = 206;

665 ià(0 =ğ
sû
->
¡
.
¡_size
 || 0 =ğ
	`h‰p_chunk_­³nd_fe
(
¤v
, 
cÚ
, 
·th
)) {

666 
cÚ
->
h‰p_¡©us
 = 200;

667 
cÚ
->
fe_fšished
 = 1;

669 
cÚ
->
h‰p_¡©us
 = 403;

671 
	}
}

673 
	$h‰p_»¥Ú£_x£ndfe
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
·th
, cÚ¡ 
¬¿y
 *
xdoüoÙ
) {

674 cÚ¡ 
¡©us
 = 
cÚ
->
h‰p_¡©us
;

675 
v®id
 = 1;

677 
cÚ
->
fe_¡¬‹d
 = 1;

683 ià(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_CONTENT_LENGTH
) {

684 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Length");

685 ià(
ds
è
	`bufãr_»£t
(ds->
v®ue
);

686 
cÚ
->
·r£d_»¥Ú£
 &ğ~
HTTP_CONTENT_LENGTH
;

687 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = -1;

690 
	`bufãr_u¾decode_·th
(
·th
);

691 
	`bufãr_·th_sim¶ify
(
·th
,…ath);

692 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

693 
	`bufãr_to_low”
(
·th
);

700 ià(
xdoüoÙ
->
u£d
) {

701 
size_t
 
i
, 
xËn
 = 
	`bufãr_¡ršg_Ëngth
(
·th
);

702 
i
 = 0; i < 
xdoüoÙ
->
u£d
; ++i) {

703 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
xdoüoÙ
->
d©a
[
i
];

704 
size_t
 
dËn
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

705 ià(
dËn
 <ğ
xËn


706 && (!
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames


707 ? 0 =ğ
	`memcmp
(
·th
->
±r
, 
ds
->
v®ue
->±r, 
dËn
)

708 : 0 =ğ
	`¡ºÿ£cmp
(
·th
->
±r
, 
ds
->
v®ue
->±r, 
dËn
))) {

712 ià(
i
 =ğ
xdoüoÙ
->
u£d
) {

713 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBs",

714 "X-S’df(", 
·th
,

716 
cÚ
->
h‰p_¡©us
 = 403;

717 
v®id
 = 0;

721 ià(
v®id
è
	`h‰p_»¥Ú£_£nd_fe
(
¤v
, 
cÚ
, 
·th
);

723 ià(
cÚ
->
h‰p_¡©us
 >ğ400 && 
¡©us
 < 300) {

724 
cÚ
->
mode
 = 
DIRECT
;

725 } ià(0 !ğ
¡©us
 && 200 != status) {

726 
cÚ
->
h‰p_¡©us
 = 
¡©us
;

728 
	}
}

730 
	$h‰p_»¥Ú£_back’d_”rÜ
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

731 
	`UNUSED
(
¤v
);

732 ià(
cÚ
->
fe_¡¬‹d
) {

735 
cÚ
->
mode
 = 
DIRECT
;

736 
cÚ
->
k“p_®ive
 = 0;

737 
cÚ
->
fe_fšished
 = 1;

739 
	}
}

741 
	$h‰p_»¥Ú£_back’d_dÚe
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

745 
cÚ
->
¡©e
) {

746 
CON_STATE_HANDLE_REQUEST
:

747 
CON_STATE_READ_POST
:

748 ià(!
cÚ
->
fe_¡¬‹d
) {

750 
cÚ
->
h‰p_¡©us
 = 500;

751 
cÚ
->
mode
 = 
DIRECT
;

754 
CON_STATE_WRITE
:

755 ià(!
cÚ
->
fe_fšished
) {

756 
	`h‰p_chunk_şo£
(
¤v
, 
cÚ
);

757 
cÚ
->
fe_fšished
 = 1;

762 
	}
}

765 
	$h‰p_cgi_h—d”s
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
h‰p_cgi_İts
 *
İts
, 
h‰p_cgi_h—d”_­³nd_cb
 
cb
, *
vd©a
) {

769 
rc
 = 0;

770 
pÜt
;

771 
£rv”_sock‘
 *
¤v_sock
 = 
cÚ
->
¤v_sock‘
;

772 cÚ¡ *
s
;

773 
size_t
 
n
;

774 
buf
[
LI_ITOSTRING_LENGTH
];

775 #ifdeà
HAVE_IPV6


776 
b2
[
INET6_ADDRSTRLEN
 + 1];

778 
sock_addr
 *
addr
;

779 
sock_addr
 
addrbuf
;

782 ià(!
İts
->
authÜiz”
) {

783 
	`li_™o¡º
(
buf
, (buf), 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
);

784 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("CONTENT_LENGTH"), 
buf
, 
	`¡¾’
(buf));

787 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
)) {

788 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("QUERY_STRING"),

789 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
qu”y
));

791 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("QUERY_STRING"),

792 
	`CONST_STR_LEN
(""));

794 ià(!
	`bufãr_¡ršg_is_em±y
(
İts
->
¡r_»que¡_uri
)) {

803 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
İts
->
¡r_»que¡_uri
);

804 ià('/' =ğ
İts
->
¡r_»que¡_uri
->
±r
[
Ën
-1]) {

805 --
Ën
;

808 ià(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.
Üig_uri
è>ğ
Ën


809 && 0 =ğ
	`memcmp
(
cÚ
->
»que¡
.
Üig_uri
->
±r
,

810 
İts
->
¡r_»que¡_uri
->
±r
, 
Ën
)

811 && 
cÚ
->
»que¡
.
Üig_uri
->
±r
[
Ën
] == '/') {

812 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REQUEST_URI"),

813 
cÚ
->
»que¡
.
Üig_uri
->
±r
+
Ën
,

814 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.
Üig_uri
è- 
Ën
);

816 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REQUEST_URI"),

817 
	`CONST_BUF_LEN
(
cÚ
->
»que¡
.
Üig_uri
));

820 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REQUEST_URI"),

821 
	`CONST_BUF_LEN
(
cÚ
->
»que¡
.
Üig_uri
));

823 ià(!
	`bufãr_is_equ®
(
cÚ
->
»que¡
.
uri
, cÚ->»que¡.
Üig_uri
)) {

824 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REDIRECT_URI"),

825 
	`CONST_BUF_LEN
(
cÚ
->
»que¡
.
uri
));

829 ià(0 =ğ
cÚ
->
”rÜ_hªdËr_§ved_¡©us
) {

830 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REDIRECT_STATUS"),

831 
	`CONST_STR_LEN
("200"));

839 ià(!
İts
->
authÜiz”
) {

840 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SCRIPT_NAME"),

841 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
));

842 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
·thšfo
)) {

843 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("PATH_INFO"),

844 
	`CONST_BUF_LEN
(
cÚ
->
»que¡
.
·thšfo
));

846 ià(!
	`bufãr_¡ršg_is_em±y
(
İts
->
doüoÙ
)) {

847 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
İts
->
doüoÙ
);

849 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
physiÿl
.
ba£dœ
);

851 
	`bufãr_­³nd_¡ršg_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
»que¡
.
·thšfo
);

852 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("PATH_TRANSLATED"),

853 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
));

864 ià(!
	`bufãr_¡ršg_is_em±y
(
İts
->
doüoÙ
)) {

866 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
İts
->
doüoÙ
);

867 
	`bufãr_­³nd_¡ršg_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
uri
.
·th
);

868 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SCRIPT_FILENAME"),

869 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
));

870 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("DOCUMENT_ROOT"),

871 
	`CONST_BUF_LEN
(
İts
->
doüoÙ
));

873 ià(
İts
->
b»ak_sütf’ame_fÜ_php
) {

879 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
physiÿl
.
·th
);

880 
	`bufãr_­³nd_¡ršg_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
»que¡
.
·thšfo
);

881 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SCRIPT_FILENAME"),

882 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
));

884 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SCRIPT_FILENAME"),

885 
	`CONST_BUF_LEN
(
cÚ
->
physiÿl
.
·th
));

887 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("DOCUMENT_ROOT"),

888 
	`CONST_BUF_LEN
(
cÚ
->
physiÿl
.
ba£dœ
));

891 
s
 = 
	`g‘_h‰p_m‘hod_Çme
(
cÚ
->
»que¡
.
h‰p_m‘hod
);

892 
	`fÜû_as£¹
(
s
);

893 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REQUEST_METHOD"), 
s
, 
	`¡¾’
(s));

895 
s
 = 
	`g‘_h‰p_v”siÚ_Çme
(
cÚ
->
»que¡
.
h‰p_v”siÚ
);

896 
	`fÜû_as£¹
(
s
);

897 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SERVER_PROTOCOL"), 
s
, 
	`¡¾’
(s));

899 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SERVER_SOFTWARE"),

900 
	`CONST_BUF_LEN
(
cÚ
->
cÚf
.
£rv”_g
));

902 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("GATEWAY_INTERFACE"),

903 
	`CONST_STR_LEN
("CGI/1.1"));

905 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
cÚ
->
uri
.
scheme
,

906 
	`CONST_STR_LEN
("https"))) {

907 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("HTTPS"), CONST_STR_LEN("on"));

910 
addr
 = &
¤v_sock
->addr;

911 #ifdeà
HAVE_IPV6


912 
pÜt
 = 
addr
->
¶aš
.
§_çmy
 =ğ
AF_INET6


913 ? 
addr
->
v6
.
sš6_pÜt


914 : 
addr
->
v4
.
sš_pÜt
;

916 
pÜt
 = 
addr
->
v4
.
sš_pÜt
;

918 
	`li_uto¡º
(
buf
, (buf), 
	`Áohs
(
pÜt
));

919 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SERVER_PORT"), 
buf
, 
	`¡¾’
(buf));

921 
addr
->
¶aš
.
§_çmy
) {

922 #ifdeà
HAVE_IPV6


923 
AF_INET6
:

924 ià(0 ==
	`memcmp
(&
addr
->
v6
.
sš6_addr
,&
š6addr_ªy
,(in6addr_any))){

925 
sockËn_t
 
add¾’
 = (
addrbuf
);

926 ià(0 =ğ
	`g‘sockÇme
(
cÚ
->
fd
,(
sockaddr
 *)&
addrbuf
,&
add¾’
)){

927 
addr
 = &
addrbuf
;

929 
s
 = "";

933 
s
 = 
	`š‘_Áİ
(
AF_INET6
, (cÚ¡ *è&(
addr
->
v6
.
sš6_addr
),

934 
b2
, (b2)-1);

937 
AF_INET
:

938 ià(
¤v_sock
->
addr
.
v4
.
sš_addr
.
s_addr
 =ğ
INADDR_ANY
) {

939 
sockËn_t
 
add¾’
 = (
addrbuf
);

940 ià(0 =ğ
	`g‘sockÇme
(
cÚ
->
fd
,(
sockaddr
 *)&
addrbuf
,&
add¾’
)){

941 
addr
 = &
addrbuf
;

943 
s
 = "";

947 #ifdeà
HAVE_IPV6


948 
s
 = 
	`š‘_Áİ
(
AF_INET
, (cÚ¡ *è&(
addr
->
v4
.
sš_addr
),

949 
b2
, (b2)-1);

951 
s
 = 
	`š‘_Áß
(
addr
->
v4
.
sš_addr
);

955 
s
 = "";

958 
	`fÜû_as£¹
(
s
);

959 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SERVER_ADDR"), 
s
, 
	`¡¾’
(s));

961 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
£rv”_Çme
)) {

962 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
£rv”_Çme
);

964 ià(
cÚ
->
£rv”_Çme
->
±r
[0] == '[') {

965 cÚ¡ *
cŞÚ
 = 
	`¡r¡r
(
cÚ
->
£rv”_Çme
->
±r
, "]:");

966 ià(
cŞÚ
è
Ën
 = (cŞÚ + 1è- 
cÚ
->
£rv”_Çme
->
±r
;

968 cÚ¡ *
cŞÚ
 = 
	`¡rchr
(
cÚ
->
£rv”_Çme
->
±r
, ':');

969 ià(
cŞÚ
è
Ën
 = cŞÚ - 
cÚ
->
£rv”_Çme
->
±r
;

972 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SERVER_NAME"),

973 
cÚ
->
£rv”_Çme
->
±r
, 
Ën
);

976 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("SERVER_NAME"), 
s
, 
	`¡¾’
(s));

979 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REMOTE_ADDR"),

980 
	`CONST_BUF_LEN
(
cÚ
->
d¡_addr_buf
));

982 #ifdeà
HAVE_IPV6


983 
pÜt
 = 
cÚ
->
d¡_addr
.
¶aš
.
§_çmy
 =ğ
AF_INET6


984 ? 
cÚ
->
d¡_addr
.
v6
.
sš6_pÜt


985 : 
cÚ
->
d¡_addr
.
v4
.
sš_pÜt
;

987 
pÜt
 = 
cÚ
->
d¡_addr
.
v4
.
sš_pÜt
;

989 
	`li_uto¡º
(
buf
, (buf), 
	`Áohs
(
pÜt
));

990 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_STR_LEN
("REMOTE_PORT"), 
buf
, 
	`¡¾’
(buf));

992 
n
 = 0;‚ < 
cÚ
->
»que¡
.
h—d”s
->
u£d
;‚++) {

993 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
cÚ
->
»que¡
.
h—d”s
->
d©a
[
n
];

994 ià(!
	`bufãr_is_em±y
(
ds
->
v®ue
è&& !bufãr_is_em±y(ds->
key
)) {

998 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
ds
->
key
,

999 
	`CONST_STR_LEN
("Proxy"))) {

1002 
	`bufãr_cİy_¡ršg_’coded_cgi_v¬Çmes
(
¤v
->
tmp_buf
,

1003 
	`CONST_BUF_LEN
(
ds
->
key
), 1);

1004 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
),

1005 
	`CONST_BUF_LEN
(
ds
->
v®ue
));

1009 #ifdeà
USE_OPENSSL


1010 ià(
cÚ
->
s¦
è
	`h‰p_cgi_s¦_’v
(
¤v
, con);

1013 
n
 = 0;‚ < 
cÚ
->
’vœÚm’t
->
u£d
;‚++) {

1014 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
cÚ
->
’vœÚm’t
->
d©a
[
n
];

1015 ià(!
	`bufãr_is_em±y
(
ds
->
v®ue
è&& !bufãr_is_em±y(ds->
key
)) {

1016 
	`bufãr_cİy_¡ršg_’coded_cgi_v¬Çmes
(
¤v
->
tmp_buf
,

1017 
	`CONST_BUF_LEN
(
ds
->
key
), 0);

1018 
rc
 |ğ
	`cb
(
vd©a
, 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
),

1019 
	`CONST_BUF_LEN
(
ds
->
v®ue
));

1023  
rc
;

1024 
	}
}

1027 #ifdeà
USE_OPENSSL


1028 
	$h‰p_cgi_s¦_’v
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

1029 cÚ¡ *
s
;

1030 cÚ¡ 
SSL_CIPHER
 *
ch”
;

1031 
	`UNUSED
(
¤v
);

1033 ià(!
cÚ
->
s¦
) ;

1035 
s
 = 
	`SSL_g‘_v”siÚ
(
cÚ
->
s¦
);

1036 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

1037 
	`CONST_STR_LEN
("SSL_PROTOCOL"),

1038 
s
, 
	`¡¾’
(s));

1040 ià((
ch”
 = 
	`SSL_g‘_cu¼’t_ch”
(
cÚ
->
s¦
))) {

1041 
u£keysize
, 
®gkeysize
;

1042 
buf
[
LI_ITOSTRING_LENGTH
];

1043 
s
 = 
	`SSL_CIPHER_g‘_Çme
(
ch”
);

1044 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

1045 
	`CONST_STR_LEN
("SSL_CIPHER"),

1046 
s
, 
	`¡¾’
(s));

1047 
u£keysize
 = 
	`SSL_CIPHER_g‘_b™s
(
ch”
, &
®gkeysize
);

1048 
	`li_™o¡º
(
buf
, (buf), 
u£keysize
);

1049 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

1050 
	`CONST_STR_LEN
("SSL_CIPHER_USEKEYSIZE"),

1051 
buf
, 
	`¡¾’
(buf));

1052 
	`li_™o¡º
(
buf
, (buf), 
®gkeysize
);

1053 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

1054 
	`CONST_STR_LEN
("SSL_CIPHER_ALGKEYSIZE"),

1055 
buf
, 
	`¡¾’
(buf));

1057 
	}
}

	@http_auth.c

1 
	~"fœ¡.h
"

3 
	~"h‰p_auth.h
"

5 
	~<¡ršg.h
>

8 
h‰p_auth_scheme_t
 
	gh‰p_auth_schemes
[8];

10 cÚ¡ 
h‰p_auth_scheme_t
 * 
	$h‰p_auth_scheme_g‘
 (cÚ¡ 
bufãr
 *
Çme
)

12 
i
 = 0;

13 
NULL
 !ğ
h‰p_auth_schemes
[
i
].
Çme


14 && 0 !ğ
	`¡rcmp
(
h‰p_auth_schemes
[
i
].
Çme
,‚ame->
±r
)) {

15 ++
i
;

17  (
NULL
 !ğ
h‰p_auth_schemes
[
i
].
Çme
) ? http_auth_schemes+i : NULL;

18 
	}
}

20 
	$h‰p_auth_scheme_£t
 (cÚ¡ 
h‰p_auth_scheme_t
 *
scheme
)

22 
i
 = 0;

23 
NULL
 !ğ
h‰p_auth_schemes
[
i
].
Çme
) ++i;

25 
	`fÜû_as£¹
(
i
<((
h‰p_auth_schemes
)/(
h‰p_auth_scheme_t
))-1);

26 
	`memıy
(
h‰p_auth_schemes
+
i
, 
scheme
, (
h‰p_auth_scheme_t
));

27 
	}
}

30 
h‰p_auth_back’d_t
 
	gh‰p_auth_back’ds
[8];

32 cÚ¡ 
h‰p_auth_back’d_t
 * 
	$h‰p_auth_back’d_g‘
 (cÚ¡ 
bufãr
 *
Çme
)

34 
i
 = 0;

35 
NULL
 !ğ
h‰p_auth_back’ds
[
i
].
Çme


36 && 0 !ğ
	`¡rcmp
(
h‰p_auth_back’ds
[
i
].
Çme
,‚ame->
±r
)) {

37 ++
i
;

39  (
NULL
 !ğ
h‰p_auth_back’ds
[
i
].
Çme
) ? http_auth_backends+i : NULL;

40 
	}
}

42 
	$h‰p_auth_back’d_£t
 (cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
)

44 
i
 = 0;

45 
NULL
 !ğ
h‰p_auth_back’ds
[
i
].
Çme
) ++i;

47 
	`fÜû_as£¹
(
i
<((
h‰p_auth_back’ds
)/(
h‰p_auth_back’d_t
))-1);

48 
	`memıy
(
h‰p_auth_back’ds
+
i
, 
back’d
, (
h‰p_auth_back’d_t
));

49 
	}
}

51 
h‰p_auth_»quœe_t
 * 
	$h‰p_auth_»quœe_š™
 ()

53 
h‰p_auth_»quœe_t
 *
»quœe
 = 
	`ÿÎoc
(1, (http_auth_require_t));

54 
	`fÜû_as£¹
(
NULL
 !ğ
»quœe
);

56 
»quœe
->
»®m
 = 
	`bufãr_š™
();

57 
»quœe
->
v®id_u£r
 = 0;

58 
»quœe
->
u£r
 = 
	`¬¿y_š™
();

59 
»quœe
->
group
 = 
	`¬¿y_š™
();

60 
»quœe
->
ho¡
 = 
	`¬¿y_š™
();

62  
»quœe
;

63 
	}
}

65 
	$h‰p_auth_»quœe_ä“
 (
h‰p_auth_»quœe_t
 * cÚ¡ 
»quœe
)

67 
	`bufãr_ä“
(
»quœe
->
»®m
);

68 
	`¬¿y_ä“
(
»quœe
->
u£r
);

69 
	`¬¿y_ä“
(
»quœe
->
group
);

70 
	`¬¿y_ä“
(
»quœe
->
ho¡
);

71 
	`ä“
(
»quœe
);

72 
	}
}

77 
	$h‰p_auth_¬¿y_cÚšs
 (cÚ¡ 
¬¿y
 * cÚ¡ 
a
, cÚ¡ * cÚ¡ 
k
, cÚ¡ 
size_t
 
kËn
)

79 
size_t
 
i
 = 0, 
u£d
 = 
a
->used; i < used; ++i) {

80 ià(
	`bufãr_is_equ®_¡ršg
(
a
->
d©a
[
i
]->
key
, 
k
, 
kËn
)) {

85 
	}
}

87 
	$h‰p_auth_m©ch_ruËs
 (cÚ¡ 
h‰p_auth_»quœe_t
 * cÚ¡ 
»quœe
, cÚ¡ * cÚ¡ 
u£r
, cÚ¡ * cÚ¡ 
group
, cÚ¡ * cÚ¡ 
ho¡
)

89 ià(
NULL
 !ğ
u£r


90 && (
»quœe
->
v®id_u£r


91 || 
	`h‰p_auth_¬¿y_cÚšs
(
»quœe
->
u£r
, u£r, 
	`¡¾’
(user)))) {

95 ià(
NULL
 !ğ
group


96 && 
	`h‰p_auth_¬¿y_cÚšs
(
»quœe
->
group
, group, 
	`¡¾’
(group))) {

100 ià(
NULL
 !ğ
ho¡


101 && 
	`h‰p_auth_¬¿y_cÚšs
(
»quœe
->
ho¡
, ho¡, 
	`¡¾’
(host))) {

106 
	}
}

108 
	$h‰p_auth_£‹nv
(
¬¿y
 *
’v
, cÚ¡ *
u£ºame
, 
size_t
 
uËn
, cÚ¡ *
auth_ty³
, size_ˆ
®’
) {

109 
d©a_¡ršg
 *
ds
;

113 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
’v
, "REMOTE_USER"))) {

114 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
’v
, 
TYPE_STRING
))) {

115 
ds
 = 
	`d©a_¡ršg_š™
();

117 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("REMOTE_USER"));

118 
	`¬¿y_š£¹_unique
(
’v
, (
d©a_un£t
 *)
ds
);

120 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
u£ºame
, 
uËn
);

124 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
’v
, "AUTH_TYPE"))) {

125 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
’v
, 
TYPE_STRING
))) {

126 
ds
 = 
	`d©a_¡ršg_š™
();

128 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("AUTH_TYPE"));

129 
	`¬¿y_š£¹_unique
(
’v
, (
d©a_un£t
 *)
ds
);

131 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
auth_ty³
, 
®’
);

132 
	}
}

134 
	$h‰p_auth_md5_hex2bš
 (cÚ¡ *
md5hex
, 
size_t
 
Ën
, 
md5bš
[16])

137 ià(32 !ğ
Ën
)  -1;

138 
i
 = 0; i < 32; i+=2) {

139 
hi
 = 
md5hex
[
i
];

140 
lo
 = 
md5hex
[
i
+1];

141 ià('0' <ğ
hi
 && hi <= '9') hi -= '0';

142 ià((
hi
 |= 0x20), 'a' <= hi && hi <= 'f') hi += -'a' + 10;

144 ià('0' <ğ
lo
 &&†o <= '9')†o -= '0';

145 ià((
lo
 |= 0x20), 'a' <=†o &&†o <= 'f')†o += -'a' + 10;

147 
md5bš
[(
i
 >> 1)] = ()((
hi
 << 4è| 
lo
);

150 
	}
}

153 
	$h‰p_auth_md5_hex2lc
 (*
md5hex
)

156 
i
;

157 
i
 = 0; 
md5hex
[i]; ++i) {

158 
c
 = 
md5hex
[
i
];

159 ià('0' <ğ
c
 && c <= '9') ;

160 ià((
c
 |ğ0x20), 'a' <ğø&& c <ğ'f'è
md5hex
[
i
] = c;

163  (32 =ğ
i
) ? 0 : -1;

164 
	}
}

	@http_auth.h

1 #iâdeà
_HTTP_AUTH_H_


2 
	#_HTTP_AUTH_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

7 
	gh‰p_auth_scheme_t
;

8 
	gh‰p_auth_»quœe_t
;

9 
	gh‰p_auth_back’d_t
;

11 
	sh‰p_auth_»quœe_t
 {

12 cÚ¡ 
h‰p_auth_scheme_t
 *
	mscheme
;

13 
bufãr
 *
	m»®m
;

14 
	mv®id_u£r
;

15 
¬¿y
 *
	mu£r
;

16 
¬¿y
 *
	mgroup
;

17 
¬¿y
 *
	mho¡
;

18 } 
	th‰p_auth_»quœe_t
;

20 
h‰p_auth_»quœe_t
 * 
h‰p_auth_»quœe_š™
 ();

21 
h‰p_auth_»quœe_ä“
 (
h‰p_auth_»quœe_t
 *
»quœe
);

22 
h‰p_auth_m©ch_ruËs
 (cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ *
u£r
, cÚ¡ *
group
, cÚ¡ *
ho¡
);

24 
	sh‰p_auth_back’d_t
 {

25 cÚ¡ *
	mÇme
;

26 
hªdËr_t
(*
basic
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
	m»quœe
, cÚ¡ 
bufãr
 *
	mu£ºame
, cÚ¡ *
	mpw
);

27 
hªdËr_t
(*
dige¡
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
, cÚ¡ *
	mu£ºame
, cÚ¡ *
	m»®m
, 
	mHA1
[16]);

28 *
	mp_d
;

29 } 
	th‰p_auth_back’d_t
;

31 
	sh‰p_auth_scheme_t
 {

32 cÚ¡ *
	mÇme
;

33 
hªdËr_t
(*
checkâ
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
	m»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
	mback’d
);

35 *
	mp_d
;

36 } 
	th‰p_auth_scheme_t
;

38 cÚ¡ 
h‰p_auth_scheme_t
 * 
h‰p_auth_scheme_g‘
 (cÚ¡ 
bufãr
 *
Çme
);

39 
h‰p_auth_scheme_£t
 (cÚ¡ 
h‰p_auth_scheme_t
 *
scheme
);

40 cÚ¡ 
h‰p_auth_back’d_t
 * 
h‰p_auth_back’d_g‘
 (cÚ¡ 
bufãr
 *
Çme
);

41 
h‰p_auth_back’d_£t
 (cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
);

43 
h‰p_auth_£‹nv
(
¬¿y
 *
’v
, cÚ¡ *
u£ºame
, 
size_t
 
uËn
, cÚ¡ *
auth_ty³
, size_ˆ
®’
);

45 
h‰p_auth_md5_hex2bš
 (cÚ¡ *
md5hex
, 
size_t
 
Ën
, 
md5bš
[16]);

	@http_chunk.c

1 
	~"fœ¡.h
"

9 
	~"£rv”.h
"

10 
	~"chunk.h
"

11 
	~"h‰p_chunk.h
"

12 
	~"¡©_ÿche.h
"

13 
	~"log.h
"

15 
	~<sys/ty³s.h
>

16 
	~<sys/¡©.h
>

18 
	~<¡dlib.h
>

19 
	~<fú.h
>

20 
	~<uni¡d.h
>

22 
	~<¡dio.h
>

23 
	~<”ºo.h
>

24 
	~<¡ršg.h
>

26 
	$h‰p_chunk_­³nd_Ën
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
uštmax_t
 
Ën
) {

27 
bufãr
 *
b
;

29 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
);

31 
b
 = 
¤v
->
tmp_chunk_Ën
;

33 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 0);

34 
	`bufãr_­³nd_ušt_hex
(
b
, 
Ën
);

35 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n"));

37 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

38 
	}
}

40 
	$h‰p_chunk_­³nd_fe_İ’_f¡©
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
â
, 
¡©
 *
¡
) {

41 ià(!
cÚ
->
cÚf
.
fŞlow_symlšk
) {

43 
¡©_ÿche_’Œy
 *
sû
;

44 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
â
, &
sû
))  -1;

47  
	`¡©_ÿche_İ’_rdÚly_f¡©
(
¤v
, 
cÚ
, 
â
, 
¡
);

48 
	}
}

50 
	$h‰p_chunk_­³nd_fe_fd_¿nge
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
â
, 
fd
, 
off_t
 
off£t
, off_ˆ
Ën
) {

51 
chunkqueue
 *
cq
 = 
cÚ
->
wr™e_queue
;

53 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

54 
	`h‰p_chunk_­³nd_Ën
(
¤v
, 
cÚ
, (
uštmax_t
)
Ën
);

57 
	`chunkqueue_­³nd_fe_fd
(
cq
, 
â
, 
fd
, 
off£t
, 
Ën
);

59 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

60 
	`chunkqueue_­³nd_mem
(
cq
, 
	`CONST_STR_LEN
("\r\n"));

62 
	}
}

64 
	$h‰p_chunk_­³nd_fe_¿nge
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
â
, 
off_t
 
off£t
, off_ˆ
Ën
) {

65 
¡©
 
¡
;

66 cÚ¡ 
fd
 = 
	`h‰p_chunk_­³nd_fe_İ’_f¡©
(
¤v
, 
cÚ
, 
â
, &
¡
);

67 ià(
fd
 < 0)  -1;

69 ià(-1 =ğ
Ën
) {

70 ià(
off£t
 >ğ
¡
.
¡_size
) {

71 
	`şo£
(
fd
);

72  (
off£t
 =ğ
¡
.
¡_size
) ? 0 : -1;

74 
Ën
 = 
¡
.
¡_size
 - 
off£t
;

75 } ià(
¡
.
¡_size
 - 
off£t
 < 
Ën
) {

76 
	`şo£
(
fd
);

80 
	`h‰p_chunk_­³nd_fe_fd_¿nge
(
¤v
, 
cÚ
, 
â
, 
fd
, 
off£t
, 
Ën
);

82 
	}
}

84 
	$h‰p_chunk_­³nd_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
â
) {

85 
¡©
 
¡
;

86 cÚ¡ 
fd
 = 
	`h‰p_chunk_­³nd_fe_İ’_f¡©
(
¤v
, 
cÚ
, 
â
, &
¡
);

87 ià(
fd
 < 0)  -1;

89 ià(0 !ğ
¡
.
¡_size
) {

90 
	`h‰p_chunk_­³nd_fe_fd_¿nge
(
¤v
, 
cÚ
, 
â
, 
fd
, 0, 
¡
.
¡_size
);

92 
	`şo£
(
fd
);

95 
	}
}

97 
	$h‰p_chunk_­³nd_to_‹mpfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ * 
mem
, 
size_t
 
Ën
) {

98 
chunkqueue
 * cÚ¡ 
cq
 = 
cÚ
->
wr™e_queue
;

100 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

102 
bufãr
 *
b
 = 
¤v
->
tmp_chunk_Ën
;

104 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 0);

105 
	`bufãr_­³nd_ušt_hex
(
b
, 
Ën
);

106 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n"));

108 ià(0 !ğ
	`chunkqueue_­³nd_mem_to_‹mpfe
(
¤v
, 
cq
, 
	`CONST_BUF_LEN
(
b
))) {

113 ià(0 !ğ
	`chunkqueue_­³nd_mem_to_‹mpfe
(
¤v
, 
cq
, 
mem
, 
Ën
)) {

117 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

118 ià(0 !ğ
	`chunkqueue_­³nd_mem_to_‹mpfe
(
¤v
, 
cq
, 
	`CONST_STR_LEN
("\r\n"))) {

124 
	}
}

126 
	$h‰p_chunk_­³nd_d©a
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
b
, cÚ¡ * 
mem
, 
size_t
 
Ën
) {

128 
chunkqueue
 * cÚ¡ 
cq
 = 
cÚ
->
wr™e_queue
;

129 
chunk
 *
c
 = 
cq
->
Ï¡
;

130 ià(0 =ğ
Ën
)  0;

140 ià((
c
 && c->
ty³
 =ğ
FILE_CHUNK
 && c->
fe
.
is_‹mp
)

141 || 
cq
->
by‹s_š
 - cq->
by‹s_out
 + 
Ën


142 > 1024 * ((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
) ? 128 : 64)) {

143  
	`h‰p_chunk_­³nd_to_‹mpfe
(
¤v
, 
cÚ
, 
b
 ? b->
±r
 : 
mem
, 
Ën
);

149 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

150 
	`h‰p_chunk_­³nd_Ën
(
¤v
, 
cÚ
, 
Ën
);

154 
b
 ? 
	`chunkqueue_­³nd_bufãr
(
cq
, bè: 
	`chunkqueue_­³nd_mem
(cq, 
mem
, 
Ën
);

156 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

157 
	`chunkqueue_­³nd_mem
(
cq
, 
	`CONST_STR_LEN
("\r\n"));

161 
	}
}

163 
	$h‰p_chunk_­³nd_bufãr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
mem
) {

164 
	`fÜû_as£¹
(
NULL
 !ğ
cÚ
);

166  
	`h‰p_chunk_­³nd_d©a
(
¤v
, 
cÚ
, 
mem
, 
NULL
, 
	`bufãr_¡ršg_Ëngth
(mem));

167 
	}
}

169 
	$h‰p_chunk_­³nd_mem
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ * 
mem
, 
size_t
 
Ën
) {

170 
	`fÜû_as£¹
(
NULL
 !ğ
cÚ
);

171 
	`fÜû_as£¹
(
NULL
 !ğ
mem
 || 0 =ğ
Ën
);

173  
	`h‰p_chunk_­³nd_d©a
(
¤v
, 
cÚ
, 
NULL
, 
mem
, 
Ën
);

174 
	}
}

176 
	$h‰p_chunk_şo£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

177 
	`UNUSED
(
¤v
);

178 
	`fÜû_as£¹
(
NULL
 !ğ
cÚ
);

180 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

181 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("0\r\n\r\n"));

183 
	}
}

	@http_chunk.h

1 #iâdeà
_HTTP_CHUNK_H_


2 
	#_HTTP_CHUNK_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£rv”.h
"

6 
	~<sys/ty³s.h
>

8 
h‰p_chunk_­³nd_mem
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ * 
mem
, 
size_t
 
Ën
);

9 
h‰p_chunk_­³nd_bufãr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
mem
);

10 
h‰p_chunk_­³nd_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
â
);

11 
h‰p_chunk_­³nd_fe_¿nge
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
â
, 
off_t
 
off£t
, off_ˆ
Ën
);

12 
h‰p_chunk_şo£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

	@inet_ntop_cache.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"š‘_Áİ_ÿche.h
"

5 
	~"sys-sock‘.h
"

7 
	~<sys/ty³s.h
>

9 
	~<¡ršg.h
>

11 cÚ¡ * 
	$š‘_Áİ_ÿche_g‘_
(
£rv”
 *
¤v
, 
sock_addr
 *
addr
) {

12 #ifdeà
HAVE_IPV6


13 
size_t
 
ndx
 = 0, 
i
;

14 
i
 = 0; i < 
INET_NTOP_CACHE_MAX
; i++) {

15 ià(
¤v
->
š‘_Áİ_ÿche
[
i
].
ts
 !ğ0 && srv->š‘_Áİ_ÿche[i].
çmy
 =ğ
addr
->
¶aš
.
§_çmy
) {

16 ià(
¤v
->
š‘_Áİ_ÿche
[
i
].
çmy
 =ğ
AF_INET6
 &&

17 0 =ğ
	`memcmp
(
¤v
->
š‘_Áİ_ÿche
[
i
].
addr
.
v6
.
s6_addr
,‡ddr->v6.
sš6_addr
.s6_addr, 16)) {

20 } ià(
¤v
->
š‘_Áİ_ÿche
[
i
].
çmy
 =ğ
AF_INET
 &&

21 
¤v
->
š‘_Áİ_ÿche
[
i
].
addr
.
v4
.
s_addr
 =ğaddr->v4.
sš_addr
.s_addr) {

29 ià(
i
 =ğ
INET_NTOP_CACHE_MAX
) {

32 
i
 = 
ndx
;

33 
	`š‘_Áİ
(
addr
->
¶aš
.
§_çmy
,

34 
addr
->
¶aš
.
§_çmy
 =ğ
AF_INET6
 ?

35 (cÚ¡ *è&(
addr
->
v6
.
sš6_addr
) :

36 (cÚ¡ *è&(
addr
->
v4
.
sš_addr
),

37 
¤v
->
š‘_Áİ_ÿche
[
i
].
b2
, 
INET6_ADDRSTRLEN
);

39 
¤v
->
š‘_Áİ_ÿche
[
i
].
ts
 = srv->
cur_ts
;

40 
¤v
->
š‘_Áİ_ÿche
[
i
].
çmy
 = 
addr
->
¶aš
.
§_çmy
;

42 ià(
¤v
->
š‘_Áİ_ÿche
[
i
].
çmy
 =ğ
AF_INET
) {

43 
¤v
->
š‘_Áİ_ÿche
[
i
].
addr
.
v4
.
s_addr
 =‡ddr->v4.
sš_addr
.s_addr;

44 } ià(
¤v
->
š‘_Áİ_ÿche
[
i
].
çmy
 =ğ
AF_INET6
) {

45 
	`memıy
(
¤v
->
š‘_Áİ_ÿche
[
i
].
addr
.
v6
.
s6_addr
,‡ddr->v6.
sš6_addr
.s6_addr, 16);

49  
¤v
->
š‘_Áİ_ÿche
[
i
].
b2
;

51 
	`UNUSED
(
¤v
);

52  
	`š‘_Áß
(
addr
->
v4
.
sš_addr
);

54 
	}
}

	@inet_ntop_cache.h

1 #iâdeà
_INET_NTOP_CACHE_H_


2 
	#_INET_NTOP_CACHE_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

6 cÚ¡ * 
š‘_Áİ_ÿche_g‘_
(
£rv”
 *
¤v
, 
sock_addr
 *
addr
);

	@joblist.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"jobli¡.h
"

5 
	~"log.h
"

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

10 
	$jobli¡_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

11 ià(
cÚ
->
š_jobli¡
)  0;

13 ià(
¤v
->
jobli¡
->
size
 == 0) {

14 
¤v
->
jobli¡
->
size
 = 16;

15 
¤v
->
jobli¡
->
±r
 = 
	`m®loc
((*¤v->jobli¡->±rè* srv->jobli¡->
size
);

16 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
jobli¡
->
±r
);

17 } ià(
¤v
->
jobli¡
->
u£d
 =ğ¤v->jobli¡->
size
) {

18 
¤v
->
jobli¡
->
size
 += 16;

19 
¤v
->
jobli¡
->
±r
 = 
	`»®loc
(¤v->jobli¡->±r, (*¤v->jobli¡->±rè* srv->jobli¡->
size
);

20 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
jobli¡
->
±r
);

23 
¤v
->
jobli¡
->
±r
[¤v->jobli¡->
u£d
++] = 
cÚ
;

26 
	}
}

28 
	$jobli¡_ä“
(
£rv”
 *
¤v
, 
cÚÃùiÚs
 *
jobli¡
) {

29 
	`UNUSED
(
¤v
);

31 
	`ä“
(
jobli¡
->
±r
);

32 
	`ä“
(
jobli¡
);

33 
	}
}

35 
cÚÃùiÚ
 *
	$fdwa™queue_unshiá
(
£rv”
 *
¤v
, 
cÚÃùiÚs
 *
fdwa™queue
) {

36 
cÚÃùiÚ
 *
cÚ
;

37 
	`UNUSED
(
¤v
);

40 ià(
fdwa™queue
->
u£d
 =ğ0è 
NULL
;

42 
cÚ
 = 
fdwa™queue
->
±r
[0];

44 
	`memmove
(
fdwa™queue
->
±r
, &(fdwa™queue->±r[1]), --fdwa™queue->
u£d
 * (*(fdwaitqueue->ptr)));

46  
cÚ
;

47 
	}
}

49 
	$fdwa™queue_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

50 ià(
¤v
->
fdwa™queue
->
size
 == 0) {

51 
¤v
->
fdwa™queue
->
size
 = 16;

52 
¤v
->
fdwa™queue
->
±r
 = 
	`m®loc
((*(¤v->fdwa™queue->±r)è* srv->fdwa™queue->
size
);

53 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
fdwa™queue
->
±r
);

54 } ià(
¤v
->
fdwa™queue
->
u£d
 =ğ¤v->fdwa™queue->
size
) {

55 
¤v
->
fdwa™queue
->
size
 += 16;

56 
¤v
->
fdwa™queue
->
±r
 = 
	`»®loc
(¤v->fdwa™queue->±r, (*(¤v->fdwa™queue->±r)è* srv->fdwa™queue->
size
);

57 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
fdwa™queue
->
±r
);

60 
¤v
->
fdwa™queue
->
±r
[¤v->fdwa™queue->
u£d
++] = 
cÚ
;

63 
	}
}

65 
	$fdwa™queue_ä“
(
£rv”
 *
¤v
, 
cÚÃùiÚs
 *
fdwa™queue
) {

66 
	`UNUSED
(
¤v
);

67 
	`ä“
(
fdwa™queue
->
±r
);

68 
	`ä“
(
fdwa™queue
);

69 
	}
}

	@joblist.h

1 #iâdeà
_JOB_LIST_H_


2 
	#_JOB_LIST_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

7 
jobli¡_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

8 
jobli¡_ä“
(
£rv”
 *
¤v
, 
cÚÃùiÚs
 *
jobli¡
);

10 
fdwa™queue_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

11 
fdwa™queue_ä“
(
£rv”
 *
¤v
, 
cÚÃùiÚs
 *
fdwa™queue
);

12 
cÚÃùiÚ
 *
fdwa™queue_unshiá
(
£rv”
 *
¤v
, 
cÚÃùiÚs
 *
fdwa™queue
);

	@keyvalue.c

1 
	~"fœ¡.h
"

3 
	~"£rv”.h
"

4 
	~"keyv®ue.h
"

5 
	~"log.h
"

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<¡dio.h
>

11 
keyv®ue
 
	gh‰p_v”siÚs
[] = {

12 { 
HTTP_VERSION_1_1
, "HTTP/1.1" },

13 { 
HTTP_VERSION_1_0
, "HTTP/1.0" },

14 { 
HTTP_VERSION_UNSET
, 
NULL
 }

17 
keyv®ue
 
	gh‰p_m‘hods
[] = {

18 { 
HTTP_METHOD_GET
, "GET" },

19 { 
HTTP_METHOD_HEAD
, "HEAD" },

20 { 
HTTP_METHOD_POST
, "POST" },

21 { 
HTTP_METHOD_PUT
, "PUT" },

22 { 
HTTP_METHOD_DELETE
, "DELETE" },

23 { 
HTTP_METHOD_CONNECT
, "CONNECT" },

24 { 
HTTP_METHOD_OPTIONS
, "OPTIONS" },

25 { 
HTTP_METHOD_TRACE
, "TRACE" },

26 { 
HTTP_METHOD_ACL
, "ACL" },

27 { 
HTTP_METHOD_BASELINE_CONTROL
, "BASELINE-CONTROL" },

28 { 
HTTP_METHOD_BIND
, "BIND" },

29 { 
HTTP_METHOD_CHECKIN
, "CHECKIN" },

30 { 
HTTP_METHOD_CHECKOUT
, "CHECKOUT" },

31 { 
HTTP_METHOD_COPY
, "COPY" },

32 { 
HTTP_METHOD_LABEL
, "LABEL" },

33 { 
HTTP_METHOD_LINK
, "LINK" },

34 { 
HTTP_METHOD_LOCK
, "LOCK" },

35 { 
HTTP_METHOD_MERGE
, "MERGE" },

36 { 
HTTP_METHOD_MKACTIVITY
, "MKACTIVITY" },

37 { 
HTTP_METHOD_MKCALENDAR
, "MKCALENDAR" },

38 { 
HTTP_METHOD_MKCOL
, "MKCOL" },

39 { 
HTTP_METHOD_MKREDIRECTREF
, "MKREDIRECTREF" },

40 { 
HTTP_METHOD_MKWORKSPACE
, "MKWORKSPACE" },

41 { 
HTTP_METHOD_MOVE
, "MOVE" },

42 { 
HTTP_METHOD_ORDERPATCH
, "ORDERPATCH" },

43 { 
HTTP_METHOD_PATCH
, "PATCH" },

44 { 
HTTP_METHOD_PROPFIND
, "PROPFIND" },

45 { 
HTTP_METHOD_PROPPATCH
, "PROPPATCH" },

46 { 
HTTP_METHOD_REBIND
, "REBIND" },

47 { 
HTTP_METHOD_REPORT
, "REPORT" },

48 { 
HTTP_METHOD_SEARCH
, "SEARCH" },

49 { 
HTTP_METHOD_UNBIND
, "UNBIND" },

50 { 
HTTP_METHOD_UNCHECKOUT
, "UNCHECKOUT" },

51 { 
HTTP_METHOD_UNLINK
, "UNLINK" },

52 { 
HTTP_METHOD_UNLOCK
, "UNLOCK" },

53 { 
HTTP_METHOD_UPDATE
, "UPDATE" },

54 { 
HTTP_METHOD_UPDATEREDIRECTREF
, "UPDATEREDIRECTREF" },

55 { 
HTTP_METHOD_VERSION_CONTROL
, "VERSION-CONTROL" },

57 { 
HTTP_METHOD_UNSET
, 
NULL
 }

60 
keyv®ue
 
	gh‰p_¡©us
[] = {

110 { -1, 
NULL
 }

113 
keyv®ue
 
	gh‰p_¡©us_body
[] = {

125 { -1, 
NULL
 }

129 cÚ¡ *
	$keyv®ue_g‘_v®ue
(
keyv®ue
 *
kv
, 
k
) {

130 
i
;

131 
i
 = 0; 
kv
[i].
v®ue
; i++) {

132 ià(
kv
[
i
].
key
 =ğ
k
è kv[i].
v®ue
;

134  
NULL
;

135 
	}
}

137 
	$keyv®ue_g‘_key
(
keyv®ue
 *
kv
, cÚ¡ *
s
) {

138 
i
;

139 
i
 = 0; 
kv
[i].
v®ue
; i++) {

140 ià(0 =ğ
	`¡rcmp
(
kv
[
i
].
v®ue
, 
s
)è kv[i].
key
;

143 
	}
}

146 cÚ¡ *
	$g‘_h‰p_v”siÚ_Çme
(
i
) {

147  
	`keyv®ue_g‘_v®ue
(
h‰p_v”siÚs
, 
i
);

148 
	}
}

150 cÚ¡ *
	$g‘_h‰p_¡©us_Çme
(
i
) {

151  
	`keyv®ue_g‘_v®ue
(
h‰p_¡©us
, 
i
);

152 
	}
}

154 cÚ¡ *
	$g‘_h‰p_m‘hod_Çme
(
h‰p_m‘hod_t
 
i
) {

155  
	`keyv®ue_g‘_v®ue
(
h‰p_m‘hods
, 
i
);

156 
	}
}

158 cÚ¡ *
	$g‘_h‰p_¡©us_body_Çme
(
i
) {

159  
	`keyv®ue_g‘_v®ue
(
h‰p_¡©us_body
, 
i
);

160 
	}
}

162 
	$g‘_h‰p_v”siÚ_key
(cÚ¡ *
s
) {

163  
	`keyv®ue_g‘_key
(
h‰p_v”siÚs
, 
s
);

164 
	}
}

166 
h‰p_m‘hod_t
 
	$g‘_h‰p_m‘hod_key
(cÚ¡ *
s
) {

167  (
h‰p_m‘hod_t
)
	`keyv®ue_g‘_key
(
h‰p_m‘hods
, 
s
);

168 
	}
}

173 
püe_keyv®ue_bufãr
 *
	$püe_keyv®ue_bufãr_š™
() {

174 
püe_keyv®ue_bufãr
 *
kvb
;

176 
kvb
 = 
	`ÿÎoc
(1, (*kvb));

177 
	`fÜû_as£¹
(
NULL
 !ğ
kvb
);

179  
kvb
;

180 
	}
}

182 
	$püe_keyv®ue_bufãr_­³nd
(
£rv”
 *
¤v
, 
püe_keyv®ue_bufãr
 *
kvb
, cÚ¡ *
key
, cÚ¡ *
v®ue
) {

183 #ifdeà
HAVE_PCRE_H


184 
size_t
 
i
;

185 cÚ¡ *
”½Œ
;

186 
”roff
;

187 
püe_keyv®ue
 *
kv
;

190 ià(!
key
)  -1;

192 #ifdeà
HAVE_PCRE_H


193 ià(
kvb
->
size
 == 0) {

194 
kvb
->
size
 = 4;

195 
kvb
->
u£d
 = 0;

197 
kvb
->
kv
 = 
	`m®loc
(kvb->
size
 * (*kvb->kv));

198 
	`fÜû_as£¹
(
NULL
 !ğ
kvb
->
kv
);

200 
i
 = 0; i < 
kvb
->
size
; i++) {

201 
kvb
->
kv
[
i
] = 
	`ÿÎoc
(1, (**kvb->kv));

202 
	`fÜû_as£¹
(
NULL
 !ğ
kvb
->
kv
[
i
]);

204 } ià(
kvb
->
u£d
 =ğkvb->
size
) {

205 
kvb
->
size
 += 4;

207 
kvb
->
kv
 = 
	`»®loc
(kvb->kv, kvb->
size
 * (*kvb->kv));

208 
	`fÜû_as£¹
(
NULL
 !ğ
kvb
->
kv
);

210 
i
 = 
kvb
->
u£d
; i < kvb->
size
; i++) {

211 
kvb
->
kv
[
i
] = 
	`ÿÎoc
(1, (**kvb->kv));

212 
	`fÜû_as£¹
(
NULL
 !ğ
kvb
->
kv
[
i
]);

216 
kv
 = 
kvb
->kv[kvb->
u£d
];

217 ià(
NULL
 =ğ(
kv
->
key
 = 
	`püe_compe
(key,

218 0, &
”½Œ
, &
”roff
, 
NULL
))) {

220 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SS",

221 "»xex°comp©iÚƒ¼Ü‡ˆ", 
”½Œ
);

225 ià(
NULL
 =ğ(
kv
->
key_exŒa
 = 
	`püe_¡udy
(kv->
key
, 0, &
”½Œ
)) &&

226 
”½Œ
 !ğ
NULL
) {

230 
kv
->
v®ue
 = 
	`bufãr_š™_¡ršg
(value);

232 
kvb
->
u£d
++;

236 
	`UNUSED
(
kvb
);

237 
	`UNUSED
(
v®ue
);

241 
	}
}

243 
	$püe_keyv®ue_bufãr_ä“
(
püe_keyv®ue_bufãr
 *
kvb
) {

244 #ifdeà
HAVE_PCRE_H


245 
size_t
 
i
;

246 
püe_keyv®ue
 *
kv
;

248 
i
 = 0; i < 
kvb
->
size
; i++) {

249 
kv
 = 
kvb
->kv[
i
];

250 ià(
kv
->
key
è
	`püe_ä“
(kv->key);

251 ià(
kv
->
key_exŒa
è
	`püe_ä“
(kv->key_extra);

252 ià(
kv
->
v®ue
è
	`bufãr_ä“
(kv->value);

253 
	`ä“
(
kv
);

256 ià(
kvb
->
kv
è
	`ä“
(kvb->kv);

259 
	`ä“
(
kvb
);

260 
	}
}

	@keyvalue.h

1 #iâdeà
_KEY_VALUE_H_


2 
	#_KEY_VALUE_H_


	)

3 
	~"fœ¡.h
"

5 #ifdeà
HAVE_PCRE_H


6 
	~<püe.h
>

9 
	g£rv”
;

22 
	mHTTP_METHOD_UNSET
 = -1,

23 
	mHTTP_METHOD_GET
,

24 
	mHTTP_METHOD_HEAD
,

25 
	mHTTP_METHOD_POST
,

26 
	mHTTP_METHOD_PUT
,

27 
	mHTTP_METHOD_DELETE
,

28 
	mHTTP_METHOD_CONNECT
,

29 
	mHTTP_METHOD_OPTIONS
,

30 
	mHTTP_METHOD_TRACE
,

31 
	mHTTP_METHOD_ACL
,

32 
	mHTTP_METHOD_BASELINE_CONTROL
,

33 
	mHTTP_METHOD_BIND
,

34 
	mHTTP_METHOD_CHECKIN
,

35 
	mHTTP_METHOD_CHECKOUT
,

36 
	mHTTP_METHOD_COPY
,

37 
	mHTTP_METHOD_LABEL
,

38 
	mHTTP_METHOD_LINK
,

39 
	mHTTP_METHOD_LOCK
,

40 
	mHTTP_METHOD_MERGE
,

41 
	mHTTP_METHOD_MKACTIVITY
,

42 
	mHTTP_METHOD_MKCALENDAR
,

43 
	mHTTP_METHOD_MKCOL
,

44 
	mHTTP_METHOD_MKREDIRECTREF
,

45 
	mHTTP_METHOD_MKWORKSPACE
,

46 
	mHTTP_METHOD_MOVE
,

47 
	mHTTP_METHOD_ORDERPATCH
,

48 
	mHTTP_METHOD_PATCH
,

49 
	mHTTP_METHOD_PROPFIND
,

50 
	mHTTP_METHOD_PROPPATCH
,

51 
	mHTTP_METHOD_REBIND
,

52 
	mHTTP_METHOD_REPORT
,

53 
	mHTTP_METHOD_SEARCH
,

54 
	mHTTP_METHOD_UNBIND
,

55 
	mHTTP_METHOD_UNCHECKOUT
,

56 
	mHTTP_METHOD_UNLINK
,

57 
	mHTTP_METHOD_UNLOCK
,

58 
	mHTTP_METHOD_UPDATE
,

59 
	mHTTP_METHOD_UPDATEREDIRECTREF
,

60 
	mHTTP_METHOD_VERSION_CONTROL


61 } 
	th‰p_m‘hod_t
;

63 ’um { 
	mHTTP_VERSION_UNSET
 = -1, 
	mHTTP_VERSION_1_0
, 
	mHTTP_VERSION_1_1
 } 
	th‰p_v”siÚ_t
;

66 
	mkey
;

68 *
	mv®ue
;

69 } 
	tkeyv®ue
;

72 #ifdeà
HAVE_PCRE_H


73 
püe
 *
	mkey
;

74 
püe_exŒa
 *
	mkey_exŒa
;

77 
bufãr
 *
	mv®ue
;

78 } 
	tpüe_keyv®ue
;

81 
püe_keyv®ue
 **
	mkv
;

82 
size_t
 
	mu£d
;

83 
size_t
 
	msize
;

84 } 
	tpüe_keyv®ue_bufãr
;

86 cÚ¡ *
g‘_h‰p_¡©us_Çme
(
i
);

87 cÚ¡ *
g‘_h‰p_v”siÚ_Çme
(
i
);

88 cÚ¡ *
g‘_h‰p_m‘hod_Çme
(
h‰p_m‘hod_t
 
i
);

89 cÚ¡ *
g‘_h‰p_¡©us_body_Çme
(
i
);

90 
g‘_h‰p_v”siÚ_key
(cÚ¡ *
s
);

91 
h‰p_m‘hod_t
 
g‘_h‰p_m‘hod_key
(cÚ¡ *
s
);

93 cÚ¡ *
keyv®ue_g‘_v®ue
(
keyv®ue
 *
kv
, 
k
);

94 
keyv®ue_g‘_key
(
keyv®ue
 *
kv
, cÚ¡ *
s
);

96 
püe_keyv®ue_bufãr
 *
püe_keyv®ue_bufãr_š™
();

97 
püe_keyv®ue_bufãr_­³nd
(
£rv”
 *
¤v
, 
püe_keyv®ue_bufãr
 *
kvb
, cÚ¡ *
key
, cÚ¡ *
v®ue
);

98 
püe_keyv®ue_bufãr_ä“
(
püe_keyv®ue_bufãr
 *
kvb
);

	@lemon.c

1 #iâdeà
_GNU_SOURCE


2 
	#_GNU_SOURCE


	)

13 
	~<¡dio.h
>

14 
	~<¡d¬g.h
>

15 
	~<¡ršg.h
>

16 
	~<ùy³.h
>

17 
	~<¡dlib.h
>

18 
	~<š‰y³s.h
>

19 
	~<uni¡d.h
>

21 
	#UNUSED
(
x
èĞ()(xè)

	)

23 #iâdeà
__WIN32__


24 #ià
defšed
(
_WIN32
è|| defšed(
WIN32
)

25 
	#__WIN32__


	)

29 #ià
__GNUC__
 > 2

30 
	#NORETURN
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

	)

32 
	#NORETURN


	)

36 
	#PRIVATE
 

	)

38 #ifdeà
TEST


39 
	#MAXRHS
 5

	)

41 
	#MAXRHS
 1000

	)

44 *
msÜt
(*
li¡
, **
Ãxt
, (*
cmp
)(*, *));

46 
	$memÜy_”rÜ
(è
NORETURN
;

49 
aùiÚ
 *
	`AùiÚ_Ãw
();

50 
aùiÚ
 *
	`AùiÚ_sÜt
();

51 
	`AùiÚ_add
();

54 
	$myas£¹
(è
NORETURN
;

55 #iâdeà
NDEBUG


56 
	#as£¹
(
X
èif(!(X))
	`myas£¹
(
__FILE__
,
__LINE__
)

	)

58 
	#as£¹
(
X
)

	)

62 
	`FšdRuËP»ûd’ûs
();

63 
	`FšdFœ¡S‘s
();

64 
	`FšdS‹s
();

65 
	`FšdLšks
();

66 
	`FšdFŞlowS‘s
();

67 
	`FšdAùiÚs
();

70 
	`CÚfigli¡_š™
( );

71 
cÚfig
 *
	`CÚfigli¡_add
( );

72 
cÚfig
 *
	`CÚfigli¡_addbasis
( );

73 
	`CÚfigli¡_şosu»
( );

74 
	`CÚfigli¡_sÜt
( );

75 
	`CÚfigli¡_sÜtbasis
( );

76 
cÚfig
 *
	`CÚfigli¡_»tuº
( );

77 
cÚfig
 *
	`CÚfigli¡_basis
( );

78 
	`CÚfigli¡_—t
( );

79 
	`CÚfigli¡_»£t
( );

82 
	`E¼ÜMsg
(const *, ,const *, ...);

85 
	ss_İtiÚs
 {

86 ’um { 
OPT_FLAG
=1, 
OPT_INT
, 
OPT_DBL
, 
OPT_STR
,

87 
OPT_FFLAG
, 
OPT_FINT
, 
OPT_FDBL
, 
OPT_FSTR
} 
ty³
;

88 *
Ïb–
;

89 *
¬g
;

90 cÚ¡ *
mes§ge
;

92 
	`O±In™
( );

93 
	`O±NArgs
( );

94 *
	`O±Arg
( );

95 
	`O±E¼
( );

96 
	`O±Pršt
( );

99 
	`P¬£
( );

102 
¶šk
 *
	`Plšk_Ãw
( );

103 
	`Plšk_add
( );

104 
	`Plšk_cİy
( );

105 
	`Plšk_d–‘e
( );

108 
	`R•ršt
( );

109 
	`R•ÜtOuut
( );

110 
	`R•ÜtTabË
( );

111 
	`R•ÜtH—d”
( );

112 
	`Com´essTabËs
( );

115 
	`S‘Size
( );

116 *
	`S‘New
( );

117 
	`S‘F»e
( );

119 
	`S‘Add
( );

120 
	`S‘UniÚ
( );

122 
	#S‘Fšd
(
X
,
Y
è(X[Y]è

	)

129 ’um {
Bo_FALSE
=0, 
Bo_TRUE
} 
	tBoŞ—n
;

133 
	ssymbŞ
 {

134 *
Çme
;

135 
šdex
;

137 
TERMINAL
,

138 
NONTERMINAL


139 } 
ty³
;

140 
ruË
 *rule;

141 
symbŞ
 *
çÎback
;

142 
´ec
;

143 
	ee_assoc
 {

144 
LEFT
,

145 
RIGHT
,

146 
NONE
,

147 
UNK


148 } 
assoc
;

149 *
fœ¡£t
;

150 
BoŞ—n
 
Ïmbda
;

151 *
de¡ruùÜ
;

153 
de¡ruùÜÊ
;

154 *
d©©y³
;

156 
dŠum
;

163 
	sruË
 {

164 
symbŞ
 *
lhs
;

165 *
lh§lŸs
;

166 
ruËlše
;

167 
Ähs
;

168 
symbŞ
 **
rhs
;

169 **
rh§lŸs
;

170 
lše
;

171 *
code
;

172 
symbŞ
 *
´ecsym
;

173 
šdex
;

174 
BoŞ—n
 
ÿnReduû
;

175 
ruË
 *
Ãxhs
;

176 
ruË
 *
Ãxt
;

184 
	scÚfig
 {

185 
ruË
 *
½
;

186 
dÙ
;

187 *
fws
;

188 
¶šk
 *
åÍ
;

189 
¶šk
 *
b¶p
;

190 
¡©e
 *
¡p
;

192 
COMPLETE
,

193 
INCOMPLETE


194 } 
¡©us
;

195 
cÚfig
 *
Ãxt
;

196 
cÚfig
 *
bp
;

200 
	saùiÚ
 {

201 
symbŞ
 *
¥
;

202 
	ee_aùiÚ
 {

203 
SHIFT
,

204 
ACCEPT
,

205 
REDUCE
,

206 
ERROR
,

207 
CONFLICT
,

208 
SH_RESOLVED
,

209 
RD_RESOLVED
,

210 
NOT_USED


211 } 
ty³
;

213 
¡©e
 *
¡p
;

214 
ruË
 *
½
;

215 } 
x
;

216 
aùiÚ
 *
Ãxt
;

217 
aùiÚ
 *
cŞlide
;

222 
	s¡©e
 {

223 
cÚfig
 *
bp
;

224 
cÚfig
 *
cå
;

225 
šdex
;

226 
aùiÚ
 *
­
;

227 
nTknAù
, 
nNtAù
;

228 
iTknOf¡
, 
iNtOf¡
;

229 
iDæt
;

231 
	#NO_OFFSET
 (-2147483647)

	)

236 
	s¶šk
 {

237 
cÚfig
 *
cå
;

238 
¶šk
 *
Ãxt
;

245 
	sËmÚ
 {

246 
¡©e
 **
sÜ‹d
;

247 
ruË
 *rule;

248 
n¡©e
;

249 
ÄuË
;

250 
nsymbŞ
;

251 
Á”mš®
;

252 
symbŞ
 **
symbŞs
;

253 
”rÜút
;

254 
symbŞ
 *
”rsym
;

255 *
Çme
;

256 *
¬g
;

257 *
tok’ty³
;

258 *
v¬ty³
;

259 *
¡¬t
;

260 *
¡acksize
;

261 *
šşude
;

262 
šşud–n
;

263 *
”rÜ
;

264 
”rÜÊ
;

265 *
ov”æow
;

266 
ov”æowÊ
;

267 *
çu»
;

268 
çu»Ê
;

269 *
acû±
;

270 
acû±Ê
;

271 *
exŒacode
;

272 
exŒacod–n
;

273 *
tok’de¡
;

274 
tok’de¡Ê
;

275 *
v¬de¡
;

276 
v¬de¡Ê
;

277 *
f’ame
;

278 *
tm¶Çme
;

279 *
ouŠame
;

280 *
tok’´efix
;

281 
ncÚæiù
;

282 
bËsize
;

283 
basisæag
;

284 
has_çÎback
;

285 *
¬gv0
;

288 
	#MemÜyCheck
(
X
) if((X)==0){ \

289 
	`memÜy_”rÜ
(); \

290 
	}

	)
}

307 *
SŒ§ã
();

309 
SŒ§ã_š™
( );

310 
SŒ§ã_š£¹
( );

311 *
SŒ§ã_fšd
( );

315 
symbŞ
 *
SymbŞ_Ãw
();

316 
SymbŞcmµ
( );

317 
SymbŞ_š™
( );

318 
SymbŞ_š£¹
( );

319 
symbŞ
 *
SymbŞ_fšd
( );

320 
symbŞ
 *
SymbŞ_Nth
( );

321 
SymbŞ_couÁ
( );

322 
S‹_couÁ
();

323 
symbŞ
 **
SymbŞ_¬¿yof
( );

327 
CÚfigcmp
( );

328 
¡©e
 *
S‹_Ãw
();

329 
S‹_š™
( );

330 
S‹_š£¹
( );

331 
¡©e
 *
S‹_fšd
( );

332 
¡©e
 **
S‹_¬¿yof
( );

336 
CÚfigbË_š™
( );

337 
CÚfigbË_š£¹
( );

338 
cÚfig
 *
CÚfigbË_fšd
( );

339 
CÚfigbË_ş—r
( );

346 
aùiÚ
 *
	$AùiÚ_Ãw
(){

347 
aùiÚ
 *
ä“li¡
 = 
NULL
;

348 
aùiÚ
 *
Ãw
;

350 ifĞ
ä“li¡
==
NULL
 ){

351 
i
;

352 
amt
 = 100;

353 
ä“li¡
 = (
aùiÚ
 *)
	`m®loc
Ğ(aùiÚ)*
amt
 );

354 ifĞ
ä“li¡
==0 ){

355 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew…arser‡ction.");

356 
	`ex™
(1);

358 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

359 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

361 
Ãw
 = 
ä“li¡
;

362 
ä“li¡
 = f»–i¡->
Ãxt
;

363  
Ãw
;

364 
	}
}

367 
	$aùiÚcmp
(
­1
,
­2
)

368 
aùiÚ
 *
­1
;

369 
aùiÚ
 *
­2
;

371 
rc
;

372 
rc
 = 
­1
->
¥
->
šdex
 - 
­2
->sp->index;

373 ifĞ
rc
==0 )„øğ()
­1
->
ty³
 - ()
­2
->type;

374 ifĞ
rc
==0 ){

375 
	`as£¹
Ğ
­1
->
ty³
==
REDUCE
 ||‡p1->ty³==
RD_RESOLVED
 ||‡p1->ty³==
CONFLICT
);

376 
	`as£¹
Ğ
­2
->
ty³
==
REDUCE
 ||‡p2->ty³==
RD_RESOLVED
 ||‡p2->ty³==
CONFLICT
);

377 
rc
 = 
­1
->
x
.
½
->
šdex
 - 
­2
->x.rp->index;

379  
rc
;

380 
	}
}

383 
aùiÚ
 *
	$AùiÚ_sÜt
(
­
)

384 
aùiÚ
 *
­
;

386 
­
 = (
aùiÚ
 *)
	`msÜt
×p,(**)&­->
Ãxt
,
aùiÚcmp
);

387  
­
;

388 
	}
}

390 
	$AùiÚ_add
(
­p
,
ty³
,
¥
,
¬g
)

391 
aùiÚ
 **
­p
;

392 
e_aùiÚ
 
ty³
;

393 
symbŞ
 *
¥
;

394 *
¬g
;

396 
aùiÚ
 *
Ãw
;

397 
Ãw
 = 
	`AùiÚ_Ãw
();

398 
Ãw
->
Ãxt
 = *
­p
;

399 *
­p
 = 
Ãw
;

400 
Ãw
->
ty³
 =ype;

401 
Ãw
->
¥
 = sp;

402 ifĞ
ty³
==
SHIFT
 ){

403 
Ãw
->
x
.
¡p
 = (
¡©e
 *)
¬g
;

405 
Ãw
->
x
.
½
 = (
ruË
 *)
¬g
;

407 
	}
}

417 
aùb
 
	taùb
;

418 
	saùb
 {

419 
	mnAùiÚ
;

420 
	mnAùiÚAÎoc
;

422 
	mlookah—d
;

423 
	maùiÚ
;

424 } *
	maAùiÚ
,

425 *
	maLookah—d
;

426 
	mmnLookah—d
;

427 
	mmnAùiÚ
;

428 
	mmxLookah—d
;

429 
	mnLookah—d
;

430 
	mnLookah—dAÎoc
;

434 
	#aùb_size
(
X
è((X)->
nAùiÚ
)

	)

437 
	#aùb_yyaùiÚ
(
X
,
N
è((X)->
aAùiÚ
[N].
aùiÚ
)

	)

440 
	#aùb_yylookah—d
(
X
,
N
è((X)->
aAùiÚ
[N].
lookah—d
)

	)

452 
PRIVATE
 
aùb
 *
	$aùb_®loc
(){

453 
aùb
 *
p
 = 
	`m®loc
( (*p) );

454 ifĞ
p
==0 ){

455 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew‡cttab.");

456 
	`ex™
(1);

458 
	`mem£t
(
p
, 0, (*p));

459  
p
;

460 
	}
}

464 
PRIVATE
 
	$aùb_aùiÚ
(
aùb
 *
p
, 
lookah—d
, 
aùiÚ
){

465 ifĞ
p
->
nLookah—d
>õ->
nLookah—dAÎoc
 ){

466 
p
->
nLookah—dAÎoc
 += 25;

467 
p
->
aLookah—d
 = 
	`»®loc
(…->aLookahead,

468 (
p
->
aLookah—d
[0])*p->
nLookah—dAÎoc
 );

469 ifĞ
p
->
aLookah—d
==0 ){

470 
	`årštf
(
¡d”r
,"malloc failed\n");

471 
	`ex™
(1);

474 ifĞ
p
->
nLookah—d
==0 ){

475 
p
->
mxLookah—d
 = 
lookah—d
;

476 
p
->
mnLookah—d
 = 
lookah—d
;

477 
p
->
mnAùiÚ
 = 
aùiÚ
;

479 ifĞ
p
->
mxLookah—d
<
lookah—d
 )…->mxLookahead =†ookahead;

480 ifĞ
p
->
mnLookah—d
>
lookah—d
 ){

481 
p
->
mnLookah—d
 = 
lookah—d
;

482 
p
->
mnAùiÚ
 = 
aùiÚ
;

485 
p
->
aLookah—d
[p->
nLookah—d
].
lookah—d
 =†ookahead;

486 
p
->
aLookah—d
[p->
nLookah—d
].
aùiÚ
 =‡ction;

487 
p
->
nLookah—d
++;

488 
	}
}

497 
PRIVATE
 
	$aùb_š£¹
(
aùb
 *
p
){

498 
i
, 
j
, 
k
, 
n
;

499 
	`as£¹
Ğ
p
->
nLookah—d
>0 );

505 
n
 = 
p
->
mxLookah—d
 + 1;

506 ifĞ
p
->
nAùiÚ
 + 
n
 >ğp->
nAùiÚAÎoc
 ){

507 
ŞdAÎoc
 = 
p
->
nAùiÚAÎoc
;

508 
p
->
nAùiÚAÎoc
 =…->
nAùiÚ
 + 
n
 +…->nActionAlloc + 20;

509 
p
->
aAùiÚ
 = 
	`»®loc
(…->aAction,

510 (
p
->
aAùiÚ
[0])*p->
nAùiÚAÎoc
);

511 ifĞ
p
->
aAùiÚ
==0 ){

512 
	`årštf
(
¡d”r
,"malloc failed\n");

513 
	`ex™
(1);

515 
i
=
ŞdAÎoc
; i<
p
->
nAùiÚAÎoc
; i++){

516 
p
->
aAùiÚ
[
i
].
lookah—d
 = -1;

517 
p
->
aAùiÚ
[
i
].
aùiÚ
 = -1;

528 
i
=0; i<
p
->
nAùiÚ
+p->
mnLookah—d
; i++){

529 ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
<0 ){

530 
j
=0; j<
p
->
nLookah—d
; j++){

531 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

532 ifĞ
k
<0 ) ;

533 ifĞ
p
->
aAùiÚ
[
k
].
lookah—d
>=0 ) ;

535 ifĞ
j
<
p
->
nLookah—d
 ) ;

536 
j
=0; j<
p
->
nAùiÚ
; j++){

537 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) ;

539 ifĞ
j
==
p
->
nAùiÚ
 ){

542 }ifĞ
p
->
aAùiÚ
[
i
].
lookah—d
=õ->
mnLookah—d
 ){

543 ifĞ
p
->
aAùiÚ
[
i
].
aùiÚ
!õ->
mnAùiÚ
 ) ;

544 
j
=0; j<
p
->
nLookah—d
; j++){

545 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

546 ifĞ
k
<0 || k>=
p
->
nAùiÚ
 ) ;

547 ifĞ
p
->
aLookah—d
[
j
].
lookah—d
!õ->
aAùiÚ
[
k
].lookahead ) ;

548 ifĞ
p
->
aLookah—d
[
j
].
aùiÚ
!õ->
aAùiÚ
[
k
].action ) ;

550 ifĞ
j
<
p
->
nLookah—d
 ) ;

551 
n
 = 0;

552 
j
=0; j<
p
->
nAùiÚ
; j++){

553 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
<0 ) ;

554 ifĞ
p
->
aAùiÚ
[
j
].
lookah—d
==j+p->
mnLookah—d
-
i
 ) 
n
++;

556 ifĞ
n
==
p
->
nLookah—d
 ){

562 
j
=0; j<
p
->
nLookah—d
; j++){

563 
k
 = 
p
->
aLookah—d
[
j
].
lookah—d
 -…->
mnLookah—d
 + 
i
;

564 
p
->
aAùiÚ
[
k
] =…->
aLookah—d
[
j
];

565 ifĞ
k
>=
p
->
nAùiÚ
 )…->nAction = k+1;

567 
p
->
nLookah—d
 = 0;

571  
i
 - 
p
->
mnLookah—d
;

572 
	}
}

578 
	$myas£¹
(
fe
,
lše
)

579 *
fe
;

580 
lše
;

582 
	`årštf
(
¡d”r
,"As£¹iÚ faed oÀlš%d oàf\"%s\"\n",
lše
,
fe
);

583 
	`ex™
(1);

584 
	}
}

600 
	$FšdRuËP»ûd’ûs
(
xp
)

601 
ËmÚ
 *
xp
;

603 
ruË
 *
½
;

604 
½
=
xp
->
ruË
;„p;„pôp->
Ãxt
){

605 ifĞ
½
->
´ecsym
==0 ){

606 
i
;

607 
i
=0; i<
½
->
Ähs
; i++){

608 ifĞ
½
->
rhs
[
i
]->
´ec
>=0 ){

609 
½
->
´ecsym
 =„p->
rhs
[
i
];

616 
	}
}

623 
	$FšdFœ¡S‘s
(
Ëmp
)

624 
ËmÚ
 *
Ëmp
;

626 
i
;

627 
ruË
 *
½
;

628 
´og»ss
;

630 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

631 
Ëmp
->
symbŞs
[
i
]->
Ïmbda
 = 
Bo_FALSE
;

633 
i
=
Ëmp
->
Á”mš®
; i<Ëmp->
nsymbŞ
; i++){

634 
Ëmp
->
symbŞs
[
i
]->
fœ¡£t
 = 
	`S‘New
();

639 
´og»ss
 = 0;

640 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

641 ifĞ
½
->
lhs
->
Ïmbda
 ) ;

642 
i
=0; i<
½
->
Ähs
; i++){

643 ifĞ
½
->
rhs
[
i
]->
Ïmbda
==
Bo_FALSE
 ) ;

645 ifĞ
i
==
½
->
Ähs
 ){

646 
½
->
lhs
->
Ïmbda
 = 
Bo_TRUE
;

647 
´og»ss
 = 1;

650 } 
´og»ss
 );

654 
symbŞ
 *
s1
, *
s2
;

655 
´og»ss
 = 0;

656 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

657 
s1
 = 
½
->
lhs
;

658 
i
=0; i<
½
->
Ähs
; i++){

659 
s2
 = 
½
->
rhs
[
i
];

660 ifĞ
s2
->
ty³
==
TERMINAL
 ){

661 
´og»ss
 +ğ
	`S‘Add
(
s1
->
fœ¡£t
,
s2
->
šdex
);

663 }ifĞ
s1
==
s2
 ){

664 ifĞ
s1
->
Ïmbda
==
Bo_FALSE
 ) ;

666 
´og»ss
 +ğ
	`S‘UniÚ
(
s1
->
fœ¡£t
,
s2
->firstset);

667 ifĞ
s2
->
Ïmbda
==
Bo_FALSE
 ) ;

671 } 
´og»ss
 );

673 
	}
}

679 
PRIVATE
 
¡©e
 *
g‘¡©e
( );

680 
	$FšdS‹s
(
Ëmp
)

681 
ËmÚ
 *
Ëmp
;

683 
symbŞ
 *
¥
;

684 
ruË
 *
½
;

686 
	`CÚfigli¡_š™
();

689 ifĞ
Ëmp
->
¡¬t
 ){

690 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

691 ifĞ
¥
==0 ){

692 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

693 "Th¥ecif›d s¹ symbŞ \"%s\" i nÙ \
‡‚Ú‹rmš® oàthg¿mm¬. \"%s\" wÈbu£d‡ th¡¬ˆ\
 in¡—d.",
Ëmp
->
¡¬t
,Ëmp->
ruË
->
lhs
->
Çme
);

696 
Ëmp
->
”rÜút
++;

697 
¥
 = 
Ëmp
->
ruË
->
lhs
;

700 
¥
 = 
Ëmp
->
ruË
->
lhs
;

706 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

707 
i
;

708 
i
=0; i<
½
->
Ähs
; i++){

709 ifĞ
½
->
rhs
[
i
]==
¥
 ){

710 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

711 "Th¡¬ˆsymbŞ \"%s\" occur Úh\
-hªd sidoà¨ruË. Thi wÈ»suÉ iÀ¨·r£¸which \
‚Ù wÜk…rİ”ly.",
¥
->
Çme
);

714 
Ëmp
->
”rÜút
++;

722 
½
=
¥
->
ruË
;„p;„pôp->
Ãxhs
){

723 
cÚfig
 *
Ãwcå
;

724 
Ãwcå
 = 
	`CÚfigli¡_addbasis
(
½
,0);

725 
	`S‘Add
(
Ãwcå
->
fws
,0);

731 ()
	`g‘¡©e
(
Ëmp
);

733 
	}
}

738 
PRIVATE
 
budshiás
( );

739 
PRIVATE
 
¡©e
 *
	$g‘¡©e
(
Ëmp
)

740 
ËmÚ
 *
Ëmp
;

742 
cÚfig
 *
cå
, *
bp
;

743 
¡©e
 *
¡p
;

747 
	`CÚfigli¡_sÜtbasis
();

748 
bp
 = 
	`CÚfigli¡_basis
();

751 
¡p
 = 
	`S‹_fšd
(
bp
);

752 ifĞ
¡p
 ){

756 
cÚfig
 *
x
, *
y
;

757 
x
=
bp
, 
y
=
¡p
->bp; x && y; x=x->bp, y=y->bp){

758 
	`Plšk_cİy
(&
y
->
b¶p
,
x
->bplp);

759 
	`Plšk_d–‘e
(
x
->
åÍ
);

760 
x
->
åÍ
 = x->
b¶p
 = 0;

762 
cå
 = 
	`CÚfigli¡_»tuº
();

763 
	`CÚfigli¡_—t
(
cå
);

766 
	`CÚfigli¡_şosu»
(
Ëmp
);

767 
	`CÚfigli¡_sÜt
();

768 
cå
 = 
	`CÚfigli¡_»tuº
();

769 
¡p
 = 
	`S‹_Ãw
();

770 
	`MemÜyCheck
(
¡p
);

771 
¡p
->
bp
 = bp;

772 
¡p
->
cå
 = cfp;

773 
¡p
->
šdex
 = 
Ëmp
->
n¡©e
++;

774 
¡p
->
­
 = 0;

775 
	`S‹_š£¹
(
¡p
,¡p->
bp
);

776 
	`budshiás
(
Ëmp
,
¡p
);

778  
¡p
;

779 
	}
}

784 
PRIVATE
 
	$budshiás
(
Ëmp
,
¡p
)

785 
ËmÚ
 *
Ëmp
;

786 
¡©e
 *
¡p
;

788 
cÚfig
 *
cå
;

789 
cÚfig
 *
bcå
;

790 
cÚfig
 *
Ãw
;

791 
symbŞ
 *
¥
;

792 
symbŞ
 *
b¥
;

793 
¡©e
 *
Ãw¡p
;

797 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
ècå->
¡©us
 = 
INCOMPLETE
;

800 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

801 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

802 ifĞ
cå
->
dÙ
>=cå->
½
->
Ähs
 ) ;

803 
	`CÚfigli¡_»£t
();

804 
¥
 = 
cå
->
½
->
rhs
[cå->
dÙ
];

809 
bcå
=
cå
; bcå; bcå=bcå->
Ãxt
){

810 ifĞ
bcå
->
¡©us
==
COMPLETE
 ) ;

811 ifĞ
bcå
->
dÙ
>=bcå->
½
->
Ähs
 ) ;

812 
b¥
 = 
bcå
->
½
->
rhs
[bcå->
dÙ
];

813 ifĞ
b¥
!=
¥
 ) ;

814 
bcå
->
¡©us
 = 
COMPLETE
;

815 
Ãw
 = 
	`CÚfigli¡_addbasis
(
bcå
->
½
,bcå->
dÙ
+1);

816 
	`Plšk_add
(&
Ãw
->
b¶p
,
bcå
);

821 
Ãw¡p
 = 
	`g‘¡©e
(
Ëmp
);

825 
	`AùiÚ_add
(&
¡p
->
­
,
SHIFT
,
¥
,
Ãw¡p
);

827 
	}
}

832 
	$FšdLšks
(
Ëmp
)

833 
ËmÚ
 *
Ëmp
;

835 
i
;

836 
cÚfig
 *
cå
, *
Ùh”
;

837 
¡©e
 *
¡p
;

838 
¶šk
 *
¶p
;

843 
i
=0; i<
Ëmp
->
n¡©e
; i++){

844 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

845 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

846 
cå
->
¡p
 = stp;

852 
i
=0; i<
Ëmp
->
n¡©e
; i++){

853 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

854 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

855 
¶p
=
cå
->
b¶p
;…Í;…ÍõÍ->
Ãxt
){

856 
Ùh”
 = 
¶p
->
cå
;

857 
	`Plšk_add
(&
Ùh”
->
åÍ
,
cå
);

861 
	}
}

868 
	$FšdFŞlowS‘s
(
Ëmp
)

869 
ËmÚ
 *
Ëmp
;

871 
i
;

872 
cÚfig
 *
cå
;

873 
¡©e
 *
¡p
;

874 
¶šk
 *
¶p
;

875 
´og»ss
;

876 
chªge
;

878 
i
=0; i<
Ëmp
->
n¡©e
; i++){

879 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

880 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

881 
cå
->
¡©us
 = 
INCOMPLETE
;

886 
´og»ss
 = 0;

887 
i
=0; i<
Ëmp
->
n¡©e
; i++){

888 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

889 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

890 ifĞ
cå
->
¡©us
==
COMPLETE
 ) ;

891 
¶p
=
cå
->
åÍ
;…Í;…ÍõÍ->
Ãxt
){

892 
chªge
 = 
	`S‘UniÚ
(
¶p
->
cå
->
fws
,cfp->fws);

893 ifĞ
chªge
 ){

894 
¶p
->
cå
->
¡©us
 = 
INCOMPLETE
;

895 
´og»ss
 = 1;

898 
cå
->
¡©us
 = 
COMPLETE
;

901 } 
´og»ss
 );

902 
	}
}

904 
»sŞve_cÚæiù
();

908 
	$FšdAùiÚs
(
Ëmp
)

909 
ËmÚ
 *
Ëmp
;

911 
i
,
j
;

912 
cÚfig
 *
cå
;

913 
symbŞ
 *
¥
;

914 
ruË
 *
½
;

920 
i
=0; i<
Ëmp
->
n¡©e
; i++){

921 
¡©e
 *
¡p
;

922 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

923 
cå
=
¡p
->cå; cå; cå=cå->
Ãxt
){

924 ifĞ
cå
->
½
->
Ähs
==cå->
dÙ
 ){

925 
j
=0; j<
Ëmp
->
Á”mš®
; j++){

926 ifĞ
	`S‘Fšd
(
cå
->
fws
,
j
) ){

929 
	`AùiÚ_add
(&
¡p
->
­
,
REDUCE
,
Ëmp
->
symbŞs
[
j
],
cå
->
½
);

937 ifĞ
Ëmp
->
¡¬t
 ){

938 
¥
 = 
	`SymbŞ_fšd
(
Ëmp
->
¡¬t
);

939 ifĞ
¥
==0 ) s°ğ
Ëmp
->
ruË
->
lhs
;

941 
¥
 = 
Ëmp
->
ruË
->
lhs
;

946 ià(
Ëmp
->
n¡©e
) {

947 
¡©e
 *
¡p
;

948 
¡p
 = 
Ëmp
->
sÜ‹d
[0];

949 
	`AùiÚ_add
(&
¡p
->
­
,
ACCEPT
,
¥
,0);

953 
i
=0; i<
Ëmp
->
n¡©e
; i++){

954 
aùiÚ
 *
­
, *
Çp
;

955 
¡©e
 *
¡p
;

956 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

957 
	`as£¹
Ğ
¡p
->
­
 );

958 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

959 
­
=
¡p
->­;‡°&&‡p->
Ãxt
;‡p=ap->next){

960 
Çp
=
­
->
Ãxt
;‚­ &&‚­->
¥
==ap->sp;‚ap=nap->next){

963 
Ëmp
->
ncÚæiù
 +ğ
	`»sŞve_cÚæiù
(
­
,
Çp
,Ëmp->
”rsym
);

969 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
è½->
ÿnReduû
 = 
Bo_FALSE
;

970 
i
=0; i<
Ëmp
->
n¡©e
; i++){

971 
aùiÚ
 *
­
;

972 
­
=
Ëmp
->
sÜ‹d
[
i
]->­;‡p;‡p÷p->
Ãxt
){

973 ifĞ
­
->
ty³
==
REDUCE
 )‡p->
x
.
½
->
ÿnReduû
 = 
Bo_TRUE
;

976 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

977 ifĞ
½
->
ÿnReduû
 ) ;

978 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,"This„ule can‚ot be„educed.\n");

979 
Ëmp
->
”rÜút
++;

981 
	}
}

996 
	$»sŞve_cÚæiù
(
­x
,
­y
,
”rsym
)

997 
aùiÚ
 *
­x
;

998 
aùiÚ
 *
­y
;

999 
symbŞ
 *
”rsym
;

1001 
symbŞ
 *
¥x
, *
¥y
;

1002 
”rút
 = 0;

1003 
	`UNUSED
(
”rsym
);

1004 
	`as£¹
Ğ
­x
->
¥
==
­y
->sp );

1005 ifĞ
­x
->
ty³
==
SHIFT
 && 
­y
->ty³==
REDUCE
 ){

1006 
¥x
 = 
­x
->
¥
;

1007 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1008 ifĞ
¥y
==0 || 
¥x
->
´ec
<0 || spy->prec<0 ){

1010 
­y
->
ty³
 = 
CONFLICT
;

1011 
”rút
++;

1012 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1013 
­y
->
ty³
 = 
RD_RESOLVED
;

1014 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1015 
­x
->
ty³
 = 
SH_RESOLVED
;

1016 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
RIGHT
 ){

1017 
­y
->
ty³
 = 
RD_RESOLVED
;

1018 }ifĞ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
LEFT
 ){

1019 
­x
->
ty³
 = 
SH_RESOLVED
;

1021 
	`as£¹
Ğ
¥x
->
´ec
==
¥y
->´eø&& spx->
assoc
==
NONE
 );

1022 
­y
->
ty³
 = 
CONFLICT
;

1023 
”rút
++;

1025 }ifĞ
­x
->
ty³
==
REDUCE
 && 
­y
->type==REDUCE ){

1026 
¥x
 = 
­x
->
x
.
½
->
´ecsym
;

1027 
¥y
 = 
­y
->
x
.
½
->
´ecsym
;

1028 ifĞ
¥x
==0 || 
¥y
==0 || spx->
´ec
<0 ||

1029 
¥y
->
´ec
<0 || 
¥x
->prec==spy->prec ){

1030 
­y
->
ty³
 = 
CONFLICT
;

1031 
”rút
++;

1032 }ifĞ
¥x
->
´ec
>
¥y
->prec ){

1033 
­y
->
ty³
 = 
RD_RESOLVED
;

1034 }ifĞ
¥x
->
´ec
<
¥y
->prec ){

1035 
­x
->
ty³
 = 
RD_RESOLVED
;

1038 
	`as£¹
(

1039 
­x
->
ty³
==
SH_RESOLVED
 ||

1040 
­x
->
ty³
==
RD_RESOLVED
 ||

1041 
­x
->
ty³
==
CONFLICT
 ||

1042 
­y
->
ty³
==
SH_RESOLVED
 ||

1043 
­y
->
ty³
==
RD_RESOLVED
 ||

1044 
­y
->
ty³
==
CONFLICT


1050  
”rút
;

1051 
	}
}

1058 
cÚfig
 *
	gä“li¡
 = 0;

1059 
cÚfig
 *
	gcu¼’t
 = 0;

1060 
cÚfig
 **
	gcu¼’‹nd
 = 0;

1061 
cÚfig
 *
	gbasis
 = 0;

1062 
cÚfig
 **
	gbasi£nd
 = 0;

1065 
PRIVATE
 
cÚfig
 *
	$ÃwcÚfig
(){

1066 
cÚfig
 *
Ãw
;

1067 ifĞ
ä“li¡
==0 ){

1068 
i
;

1069 
amt
 = 3;

1070 
ä“li¡
 = (
cÚfig
 *)
	`m®loc
Ğ(cÚfig)*
amt
 );

1071 ifĞ
ä“li¡
==0 ){

1072 
	`årštf
(
¡d”r
,"Unableo‡llocate memory for‡‚ew configuration.");

1073 
	`ex™
(1);

1075 
i
=0; i<
amt
-1; i++è
ä“li¡
[i].
Ãxt
 = &freelist[i+1];

1076 
ä“li¡
[
amt
-1].
Ãxt
 = 0;

1078 
Ãw
 = 
ä“li¡
;

1079 
ä“li¡
 = f»–i¡->
Ãxt
;

1080  
Ãw
;

1081 
	}
}

1084 
PRIVATE
 
	$d–‘ecÚfig
(
Şd
)

1085 
cÚfig
 *
Şd
;

1087 
Şd
->
Ãxt
 = 
ä“li¡
;

1088 
ä“li¡
 = 
Şd
;

1089 
	}
}

1092 
	$CÚfigli¡_š™
(){

1093 
cu¼’t
 = 0;

1094 
cu¼’‹nd
 = &
cu¼’t
;

1095 
basis
 = 0;

1096 
basi£nd
 = &
basis
;

1097 
	`CÚfigbË_š™
();

1099 
	}
}

1102 
	$CÚfigli¡_»£t
(){

1103 
cu¼’t
 = 0;

1104 
cu¼’‹nd
 = &
cu¼’t
;

1105 
basis
 = 0;

1106 
basi£nd
 = &
basis
;

1107 
	`CÚfigbË_ş—r
(0);

1109 
	}
}

1112 
cÚfig
 *
	$CÚfigli¡_add
(
½
,
dÙ
)

1113 
ruË
 *
½
;

1114 
dÙ
;

1116 
cÚfig
 *
cå
, 
mod–
;

1118 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1119 
mod–
.
½
 =„p;

1120 
mod–
.
dÙ
 = dot;

1121 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1122 ifĞ
cå
==0 ){

1123 
cå
 = 
	`ÃwcÚfig
();

1124 
cå
->
½
 =„p;

1125 
cå
->
dÙ
 = dot;

1126 
cå
->
fws
 = 
	`S‘New
();

1127 
cå
->
¡p
 = 0;

1128 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1129 
cå
->
Ãxt
 = 0;

1130 
cå
->
bp
 = 0;

1131 *
cu¼’‹nd
 = 
cå
;

1132 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1133 
	`CÚfigbË_š£¹
(
cå
);

1135  
cå
;

1136 
	}
}

1139 
cÚfig
 *
	$CÚfigli¡_addbasis
(
½
,
dÙ
)

1140 
ruË
 *
½
;

1141 
dÙ
;

1143 
cÚfig
 *
cå
, 
mod–
;

1145 
	`as£¹
Ğ
basi£nd
!=0 );

1146 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1147 
mod–
.
½
 =„p;

1148 
mod–
.
dÙ
 = dot;

1149 
cå
 = 
	`CÚfigbË_fšd
(&
mod–
);

1150 ifĞ
cå
==0 ){

1151 
cå
 = 
	`ÃwcÚfig
();

1152 
cå
->
½
 =„p;

1153 
cå
->
dÙ
 = dot;

1154 
cå
->
fws
 = 
	`S‘New
();

1155 
cå
->
¡p
 = 0;

1156 
cå
->
åÍ
 = cå->
b¶p
 = 0;

1157 
cå
->
Ãxt
 = 0;

1158 
cå
->
bp
 = 0;

1159 *
cu¼’‹nd
 = 
cå
;

1160 
cu¼’‹nd
 = &
cå
->
Ãxt
;

1161 *
basi£nd
 = 
cå
;

1162 
basi£nd
 = &
cå
->
bp
;

1163 
	`CÚfigbË_š£¹
(
cå
);

1165  
cå
;

1166 
	}
}

1169 
	$CÚfigli¡_şosu»
(
Ëmp
)

1170 
ËmÚ
 *
Ëmp
;

1172 
cÚfig
 *
cå
, *
Ãwcå
;

1173 
ruË
 *
½
, *
Ãw½
;

1174 
symbŞ
 *
¥
, *
x¥
;

1175 
i
, 
dÙ
;

1177 
	`as£¹
Ğ
cu¼’‹nd
!=0 );

1178 
cå
=
cu¼’t
; cå; cå=cå->
Ãxt
){

1179 
½
 = 
cå
->rp;

1180 
dÙ
 = 
cå
->dot;

1181 ifĞ
dÙ
>=
½
->
Ähs
 ) ;

1182 
¥
 = 
½
->
rhs
[
dÙ
];

1183 ifĞ
¥
->
ty³
==
NONTERMINAL
 ){

1184 ifĞ
¥
->
ruË
==0 && sp!=
Ëmp
->
”rsym
 ){

1185 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
lše
,"Nonterminal \"%s\" has‚o„ules.",

1186 
¥
->
Çme
);

1187 
Ëmp
->
”rÜút
++;

1189 
Ãw½
=
¥
->
ruË
;‚ew½;‚ew½òew½->
Ãxhs
){

1190 
Ãwcå
 = 
	`CÚfigli¡_add
(
Ãw½
,0);

1191 
i
=
dÙ
+1; i<
½
->
Ähs
; i++){

1192 
x¥
 = 
½
->
rhs
[
i
];

1193 ifĞ
x¥
->
ty³
==
TERMINAL
 ){

1194 
	`S‘Add
(
Ãwcå
->
fws
,
x¥
->
šdex
);

1197 
	`S‘UniÚ
(
Ãwcå
->
fws
,
x¥
->
fœ¡£t
);

1198 ifĞ
x¥
->
Ïmbda
==
Bo_FALSE
 ) ;

1201 ifĞ
i
==
½
->
Ähs
 ) 
	`Plšk_add
(&
cå
->
åÍ
,
Ãwcå
);

1206 
	}
}

1209 
	$CÚfigli¡_sÜt
(){

1210 
cu¼’t
 = (
cÚfig
 *)
	`msÜt
(cu¼’t,(**)&(cu¼’t->
Ãxt
),
CÚfigcmp
);

1211 
cu¼’‹nd
 = 0;

1213 
	}
}

1216 
	$CÚfigli¡_sÜtbasis
(){

1217 
basis
 = (
cÚfig
 *)
	`msÜt
(
cu¼’t
,(**)&(cu¼’t->
bp
),
CÚfigcmp
);

1218 
basi£nd
 = 0;

1220 
	}
}

1224 
cÚfig
 *
	$CÚfigli¡_»tuº
(){

1225 
cÚfig
 *
Şd
;

1226 
Şd
 = 
cu¼’t
;

1227 
cu¼’t
 = 0;

1228 
cu¼’‹nd
 = 0;

1229  
Şd
;

1230 
	}
}

1234 
cÚfig
 *
	$CÚfigli¡_basis
(){

1235 
cÚfig
 *
Şd
;

1236 
Şd
 = 
basis
;

1237 
basis
 = 0;

1238 
basi£nd
 = 0;

1239  
Şd
;

1240 
	}
}

1243 
	$CÚfigli¡_—t
(
cå
)

1244 
cÚfig
 *
cå
;

1246 
cÚfig
 *
Ãxtcå
;

1247 ; 
cå
; cå=
Ãxtcå
){

1248 
Ãxtcå
 = 
cå
->
Ãxt
;

1249 
	`as£¹
Ğ
cå
->
åÍ
==0 );

1250 
	`as£¹
Ğ
cå
->
b¶p
==0 );

1251 ifĞ
cå
->
fws
 ) 
	`S‘F»e
(cfp->fws);

1252 
	`d–‘ecÚfig
(
cå
);

1255 
	}
}

1264 
	$fšdb»ak
(
msg
,
mš
,
max
)

1265 *
msg
;

1266 
mš
;

1267 
max
;

1269 
i
,
¥Ù
;

1270 
c
;

1271 
i
=
¥Ù
=
mš
; i<=
max
; i++){

1272 
c
 = 
msg
[
i
];

1273 ifĞ
c
=='\t' ) 
msg
[
i
] = ' ';

1274 ifĞ
c
=='\n' ){ 
msg
[
i
] = ' '; 
¥Ù
 = i; ; }

1275 ifĞ
c
==0 ){ 
¥Ù
 = 
i
; ; }

1276 ifĞ
c
=='-' && 
i
<
max
-1 ) 
¥Ù
 = i+1;

1277 ifĞ
c
==' ' ) 
¥Ù
 = 
i
;

1279  
¥Ù
;

1280 
	}
}

1287 
	#ERRMSGSIZE
 10000

	)

1288 
	#LINEWIDTH
 79

	)

1289 
	#PREFIXLIMIT
 30

	)

1290 
	$E¼ÜMsg
(cÚ¡ *
f’ame
, 
lš’o
, cÚ¡ *
fÜm©
, ...){

1291 
”rmsg
[
ERRMSGSIZE
];

1292 
´efix
[
PREFIXLIMIT
+10];

1293 
”rmsgsize
;

1294 
´efixsize
;

1295 
avaabËwidth
;

1296 
va_li¡
 
­
;

1297 
’d
, 
»¡¬t
, 
ba£
;

1299 
	`va_¡¬t
(
­
, 
fÜm©
);

1301 ifĞ
lš’o
>0 ){

1302 
	`¥rštf
(
´efix
,"%.*s:%d: ",
PREFIXLIMIT
-10,
f’ame
,
lš’o
);

1304 
	`¥rštf
(
´efix
,"%.*s: ",
PREFIXLIMIT
-10,
f’ame
);

1306 
´efixsize
 = 
	`¡¾’
(
´efix
);

1307 
avaabËwidth
 = 
LINEWIDTH
 - 
´efixsize
;

1310 
	`v¥rštf
(
”rmsg
,
fÜm©
,
­
);

1311 
	`va_’d
(
­
);

1312 
”rmsgsize
 = 
	`¡¾’
(
”rmsg
);

1314  
”rmsgsize
>0 && 
”rmsg
[errmsgsize-1]=='\n' ){

1315 
”rmsg
[--
”rmsgsize
] = 0;

1319 
ba£
 = 0;

1320  
”rmsg
[
ba£
]!=0 ){

1321 
’d
 = 
»¡¬t
 = 
	`fšdb»ak
(&
”rmsg
[
ba£
],0,
avaabËwidth
);

1322 
»¡¬t
 +ğ
ba£
;

1323  
”rmsg
[
»¡¬t
]==' ' )„estart++;

1324 
	`årštf
(
¡dout
,"%s%.*s\n",
´efix
,
’d
,&
”rmsg
[
ba£
]);

1325 
ba£
 = 
»¡¬t
;

1327 
	}
}

1336 
	$memÜy_”rÜ
() {

1337 
	`årštf
(
¡d”r
,"Out of memory. Aborting...\n");

1338 
	`ex™
(1);

1339 
	}
}

1343 
	$maš
(
¬gc
,
¬gv
)

1344 
¬gc
;

1345 **
¬gv
;

1347 
v”siÚ
 = 0;

1348 
½æag
 = 0;

1349 
basisæag
 = 0;

1350 
com´ess
 = 0;

1351 
qu›t
 = 0;

1352 
¡©i¡ics
 = 0;

1353 
mhæag
 = 0;

1354 
s_İtiÚs
 
İtiÚs
[] = {

1355 {
OPT_FLAG
, "b", (*)&
basisæag
, "Print onlyhe basis in„eport."},

1356 {
OPT_FLAG
, "c", (*)&
com´ess
, "Don't compresshe‡ctionable."},

1357 {
OPT_FLAG
, "g", (*)&
½æag
, "Print grammar without‡ctions."},

1358 {
OPT_FLAG
, "m", (*)&
mhæag
, "Output‡ makeheaders compatible file"},

1359 {
OPT_FLAG
, "q", (*)&
qu›t
, "(Quiet) Don't…rinthe„eport file."},

1360 {
OPT_FLAG
, "s", (*)&
¡©i¡ics
, "Print…arser statso standard output."},

1361 {
OPT_FLAG
, "x", (*)&
v”siÚ
, "Printhe version‚umber."},

1362 {
OPT_FLAG
,0,0,0}

1364 
i
;

1365 
ËmÚ
 
Ëm
;

1366 *
def_tm¶_Çme
 = "lempar.c";

1368 
	`UNUSED
(
¬gc
);

1369 
	`O±In™
(
¬gv
,
İtiÚs
,
¡d”r
);

1370 ifĞ
v”siÚ
 ){

1371 
	`´štf
("Lemon version 1.0\n");

1372 
	`ex™
(0);

1374 ifĞ
	`O±NArgs
() < 1 ){

1375 
	`årštf
(
¡d”r
,"Exactly one filename‡rgument is„equired.\n");

1376 
	`ex™
(1);

1378 
Ëm
.
”rÜút
 = 0;

1381 
	`SŒ§ã_š™
();

1382 
	`SymbŞ_š™
();

1383 
	`S‹_š™
();

1384 
Ëm
.
¬gv0
 = 
¬gv
[0];

1385 
Ëm
.
f’ame
 = 
	`O±Arg
(0);

1386 
Ëm
.
tm¶Çme
 = (
	`O±NArgs
(è=ğ2è? 
	`O±Arg
(1è: 
def_tm¶_Çme
;

1387 
Ëm
.
basisæag
 = basisflag;

1388 
Ëm
.
has_çÎback
 = 0;

1389 
Ëm
.
ncÚæiù
 = 0;

1390 
Ëm
.
Çme
 =†em.
šşude
 =†em.
¬g
 =†em.
tok’ty³
 =†em.
¡¬t
 = 0;

1391 
Ëm
.
v¬ty³
 = 0;

1392 
Ëm
.
¡acksize
 = 0;

1393 
Ëm
.
”rÜ
 =†em.
ov”æow
 =†em.
çu»
 =†em.
acû±
 =†em.
tok’de¡
 =

1394 
Ëm
.
tok’´efix
 =†em.
ouŠame
 =†em.
exŒacode
 = 0;

1395 
Ëm
.
v¬de¡
 = 0;

1396 
Ëm
.
bËsize
 = 0;

1397 
	`SymbŞ_Ãw
("$");

1398 
Ëm
.
”rsym
 = 
	`SymbŞ_Ãw
("error");

1401 
	`P¬£
(&
Ëm
);

1402 ifĞ
Ëm
.
”rÜút
 ) 
	`ex™
(lem.errorcnt);

1403 ifĞ
Ëm
.
ruË
==0 ){

1404 
	`årštf
(
¡d”r
,"Empty grammar.\n");

1405 
	`ex™
(1);

1409 
	`SymbŞ_Ãw
("{default}");

1410 
Ëm
.
nsymbŞ
 = 
	`SymbŞ_couÁ
();

1411 
Ëm
.
symbŞs
 = 
	`SymbŞ_¬¿yof
();

1412 
i
=0; i<
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1413 
	`qsÜt
(
Ëm
.
symbŞs
,Ëm.
nsymbŞ
,(
symbŞ
*),

1414 ((*)())
SymbŞcmµ
);

1415 
i
=0; i<
Ëm
.
nsymbŞ
; i++èËm.
symbŞs
[i]->
šdex
 = i;

1416 
i
=1; i<
Ëm
.
nsymbŞ
 && 
	`isuµ”
Öem.
symbŞs
[i]->
Çme
[0]); i++);

1417 
Ëm
.
nsymbŞ
--;

1418 
Ëm
.
Á”mš®
 = 
i
;

1421 ifĞ
½æag
 ){

1422 
	`R•ršt
(&
Ëm
);

1425 
	`S‘Size
(
Ëm
.
Á”mš®
);

1428 
	`FšdRuËP»ûd’ûs
(&
Ëm
);

1432 
	`FšdFœ¡S‘s
(&
Ëm
);

1436 
Ëm
.
n¡©e
 = 0;

1437 
	`FšdS‹s
(&
Ëm
);

1438 
Ëm
.
n¡©e
 = 
	`S‹_couÁ
();

1439 
Ëm
.
sÜ‹d
 = 
	`S‹_¬¿yof
();

1442 
	`FšdLšks
(&
Ëm
);

1445 
	`FšdFŞlowS‘s
(&
Ëm
);

1448 
	`FšdAùiÚs
(&
Ëm
);

1451 ifĞ
com´ess
==0 ) 
	`Com´essTabËs
(&
Ëm
);

1454 ifĞ!
qu›t
 ) 
	`R•ÜtOuut
(&
Ëm
);

1457 
	`R•ÜtTabË
(&
Ëm
, 
mhæag
);

1462 ifĞ!
mhæag
 ) 
	`R•ÜtH—d”
(&
Ëm
);

1464 ifĞ
¡©i¡ics
 ){

1465 
	`´štf
("Parser statistics: %derminals, %d‚onterminals, %d„ules\n",

1466 
Ëm
.
Á”mš®
,†em.
nsymbŞ
 -†em.Á”mš®,†em.
ÄuË
);

1467 
	`´štf
(" %d states, %d…arserableƒntries, %d conflicts\n",

1468 
Ëm
.
n¡©e
,†em.
bËsize
,†em.
ncÚæiù
);

1470 ifĞ
Ëm
.
ncÚæiù
 ){

1471 
	`årštf
(
¡d”r
,"%d…¬sšg cÚæiùs.\n",
Ëm
.
ncÚæiù
);

1473 
	`ex™
(
Ëm
.
”rÜút
 +†em.
ncÚæiù
);

1474 
	}
}

1502 
	#NEXT
(
A
è(*(**)((()A)+
off£t
))

	)

1519 *
	$m”ge
(
a
,
b
,
cmp
,
off£t
)

1520 *
a
;

1521 *
b
;

1522 (*
cmp
)();

1523 
off£t
;

1525 *
±r
, *
h—d
;

1527 ifĞ
a
==0 ){

1528 
h—d
 = 
b
;

1529 }ifĞ
b
==0 ){

1530 
h—d
 = 
a
;

1532 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1533 
±r
 = 
a
;

1534 
a
 = 
	`NEXT
(a);

1536 
±r
 = 
b
;

1537 
b
 = 
	`NEXT
(b);

1539 
h—d
 = 
±r
;

1540  
a
 && 
b
 ){

1541 ifĞ(*
cmp
)(
a
,
b
)<0 ){

1542 
	`NEXT
(
±r
èğ
a
;

1543 
±r
 = 
a
;

1544 
a
 = 
	`NEXT
(a);

1546 
	`NEXT
(
±r
èğ
b
;

1547 
±r
 = 
b
;

1548 
b
 = 
	`NEXT
(b);

1551 ifĞ
a
 ) 
	`NEXT
(
±r
) =‡;

1552 
	`NEXT
(
±r
èğ
b
;

1554  
h—d
;

1555 
	}
}

1570 
	#LISTSIZE
 30

	)

1571 *
	$msÜt
(*
li¡
, **
Ãxt
, (*
cmp
)(*, *))

1573 
off£t
;

1574 *
•
;

1575 *
£t
[
LISTSIZE
];

1576 
i
;

1577 
off£t
 = ()
Ãxt
 - ()
li¡
;

1578 
i
=0; i<
LISTSIZE
; i++è
£t
[i] = 0;

1579  
li¡
 ){

1580 
•
 = 
li¡
;

1581 
li¡
 = 
	`NEXT
(list);

1582 
	`NEXT
(
•
) = 0;

1583 
i
=0; i<
LISTSIZE
-1 && 
£t
[i]!=0; i++){

1584 
•
 = 
	`m”ge
Óp,
£t
[
i
],
cmp
,
off£t
);

1585 
£t
[
i
] = 0;

1587 
£t
[
i
] = 
•
;

1589 
•
 = 0;

1590 
i
=0; i<
LISTSIZE
; i++èifĞ
£t
[i] ) 
•
 = 
	`m”ge
Óp,£t[i],
cmp
,
off£t
);

1591  
•
;

1592 
	}
}

1594 **
	g¬gv
;

1595 
s_İtiÚs
 *
	gİ
;

1596 
FILE
 *
	g”r¡»am
;

1598 
	#ISOPT
(
X
è((X)[0]=='-'||(X)[0]=='+'||
	`¡rchr
((X),'=')!=0)

	)

1604 
	$”¾še
(
n
,
k
,
”r
)

1605 
n
;

1606 
k
;

1607 
FILE
 *
”r
;

1609 
¥út
 = 0, 
i
;

1610 ifĞ
¬gv
[0] ) {

1611 
	`årštf
(
”r
,"%s",
¬gv
[0]);

1612 
¥út
 +ğ
	`¡¾’
(
¬gv
[0]) + 1;

1614 
i
=1; i<
n
 && 
¬gv
[i]; i++){

1615 
	`årštf
(
”r
," %s",
¬gv
[
i
]);

1616 
¥út
 +ğ
	`¡¾’
(
¬gv
[
i
]) + 1;

1618 
¥út
 +ğ
k
;

1619 ; 
¬gv
[
i
]; i++è
	`årštf
(
”r
," %s",argv[i]);

1620 ifĞ
¥út
<20 ){

1621 
	`årštf
(
”r
,"\n%*s^-- h”e\n",
¥út
,"");

1623 
	`årštf
(
”r
,"\n%*sh”--^\n",
¥út
-7,"");

1625 
	}
}

1631 
	$¬gšdex
(
n
)

1632 
n
;

1634 
i
;

1635 
dashdash
 = 0;

1636 ifĞ
¬gv
!=0 && *argv!=0 ){

1637 
i
=1; 
¬gv
[i]; i++){

1638 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]) ){

1639 ifĞ
n
==0 )  
i
;

1640 
n
--;

1642 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1646 
	}
}

1648 
	gemsg
[] = "Command†ine syntaxƒrror: ";

1653 
	$hªdËæags
(
i
,
”r
)

1654 
i
;

1655 
FILE
 *
”r
;

1657 
v
;

1658 
”rút
 = 0;

1659 
j
;

1660 
j
=0; 
İ
[j].
Ïb–
; j++){

1661 ifĞ
	`¡rcmp
(&
¬gv
[
i
][1],
İ
[
j
].
Ïb–
)==0 ) ;

1663 
v
 = 
¬gv
[
i
][0]=='-' ? 1 : 0;

1664 ifĞ
İ
[
j
].
Ïb–
==0 ){

1665 ifĞ
”r
 ){

1666 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1667 
	`”¾še
(
i
,1,
”r
);

1669 
”rút
++;

1670 }ifĞ
İ
[
j
].
ty³
==
OPT_FLAG
 ){

1671 *((*)
İ
[
j
].
¬g
èğ
v
;

1672 }ifĞ
İ
[
j
].
ty³
==
OPT_FFLAG
 ){

1673 (*((*)())(
šŒ_t
)(
İ
[
j
].
¬g
))(
v
);

1675 ifĞ
”r
 ){

1676 
	`årštf
(
”r
,"%smissšg‡rgum’ˆÚ sw™ch.\n",
emsg
);

1677 
	`”¾še
(
i
,1,
”r
);

1679 
”rút
++;

1681  
”rút
;

1682 
	}
}

1687 
	$hªdËsw™ch
(
i
,
”r
)

1688 
i
;

1689 
FILE
 *
”r
;

1691 
lv
 = 0;

1692 
dv
 = 0.0;

1693 *
sv
 = 0, *
’d
;

1694 *
ı
;

1695 
j
;

1696 
”rút
 = 0;

1697 
ı
 = 
	`¡rchr
(
¬gv
[
i
],'=');

1698 *
ı
 = 0;

1699 
j
=0; 
İ
[j].
Ïb–
; j++){

1700 ifĞ
	`¡rcmp
(
¬gv
[
i
],
İ
[
j
].
Ïb–
)==0 ) ;

1702 *
ı
 = '=';

1703 ifĞ
İ
[
j
].
Ïb–
==0 ){

1704 ifĞ
”r
 ){

1705 
	`årštf
(
”r
,"%sundefšed o±iÚ.\n",
emsg
);

1706 
	`”¾še
(
i
,0,
”r
);

1708 
”rút
++;

1710 
ı
++;

1711  
İ
[
j
].
ty³
 ){

1712 
OPT_FLAG
:

1713 
OPT_FFLAG
:

1714 ifĞ
”r
 ){

1715 
	`årštf
(
”r
,"%sİtiÚ„equœe ª‡rgum’t.\n",
emsg
);

1716 
	`”¾še
(
i
,0,
”r
);

1718 
”rút
++;

1720 
OPT_DBL
:

1721 
OPT_FDBL
:

1722 
dv
 = 
	`¡¹od
(
ı
,&
’d
);

1723 ifĞ*
’d
 ){

1724 ifĞ
”r
 ){

1725 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀæßtšg-pošˆ¬gum’t.\n",
emsg
);

1726 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1728 
”rút
++;

1731 
OPT_INT
:

1732 
OPT_FINT
:

1733 
lv
 = 
	`¡¹Ş
(
ı
,&
’d
,0);

1734 ifĞ*
’d
 ){

1735 ifĞ
”r
 ){

1736 
	`årštf
(
”r
,"%sËg® ch¬aù” iÀš‹g”‡rgum’t.\n",
emsg
);

1737 
	`”¾še
(
i
,(()
’d
)-()
¬gv
[i],
”r
);

1739 
”rút
++;

1742 
OPT_STR
:

1743 
OPT_FSTR
:

1744 
sv
 = 
ı
;

1747  
İ
[
j
].
ty³
 ){

1748 
OPT_FLAG
:

1749 
OPT_FFLAG
:

1751 
OPT_DBL
:

1752 *(*)(
İ
[
j
].
¬g
èğ
dv
;

1754 
OPT_FDBL
:

1755 (*((*)())(
šŒ_t
)(
İ
[
j
].
¬g
))(
dv
);

1757 
OPT_INT
:

1758 *(*)(
İ
[
j
].
¬g
èğ
lv
;

1760 
OPT_FINT
:

1761 (*((*)())(
šŒ_t
)(
İ
[
j
].
¬g
))(()
lv
);

1763 
OPT_STR
:

1764 *(**)(
İ
[
j
].
¬g
èğ
sv
;

1766 
OPT_FSTR
:

1767 (*((*)())(
šŒ_t
)(
İ
[
j
].
¬g
))(
sv
);

1771  
”rút
;

1772 
	}
}

1774 
	$O±In™
(
a
,
o
,
”r
)

1775 **
a
;

1776 
s_İtiÚs
 *
o
;

1777 
FILE
 *
”r
;

1779 
”rút
 = 0;

1780 
¬gv
 = 
a
;

1781 
İ
 = 
o
;

1782 
”r¡»am
 = 
”r
;

1783 ifĞ
¬gv
 && *¬gv && 
İ
 ){

1784 
i
;

1785 
i
=1; 
¬gv
[i]; i++){

1786 ifĞ
¬gv
[
i
][0]=='+' ||‡rgv[i][0]=='-' ){

1787 
”rút
 +ğ
	`hªdËæags
(
i
,
”r
);

1788 }ifĞ
	`¡rchr
(
¬gv
[
i
],'=') ){

1789 
”rút
 +ğ
	`hªdËsw™ch
(
i
,
”r
);

1793 ifĞ
”rút
>0 ){

1794 
	`årštf
(
”r
,"V®id commªd†šİtiÚ fÜ \"%s\"‡»:\n",*
a
);

1795 
	`O±Pršt
();

1796 
	`ex™
(1);

1799 
	}
}

1801 
	$O±NArgs
(){

1802 
út
 = 0;

1803 
dashdash
 = 0;

1804 
i
;

1805 ifĞ
¬gv
!=0 &&‡rgv[0]!=0 ){

1806 
i
=1; 
¬gv
[i]; i++){

1807 ifĞ
dashdash
 || !
	`ISOPT
(
¬gv
[
i
]èè
út
++;

1808 ifĞ
	`¡rcmp
(
¬gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1811  
út
;

1812 
	}
}

1814 *
	$O±Arg
(
n
)

1815 
n
;

1817 
i
;

1818 
i
 = 
	`¬gšdex
(
n
);

1819  
i
>=0 ? 
¬gv
[i] : 0;

1820 
	}
}

1822 
	$O±E¼
(
n
)

1823 
n
;

1825 
i
;

1826 
i
 = 
	`¬gšdex
(
n
);

1827 ifĞ
i
>=0 ) 
	`”¾še
(i,0,
”r¡»am
);

1828 
	}
}

1830 
	$O±Pršt
(){

1831 
i
;

1832 
max
, 
Ën
;

1833 
max
 = 0;

1834 
i
=0; 
İ
[i].
Ïb–
; i++){

1835 
Ën
 = 
	`¡¾’
(
İ
[
i
].
Ïb–
) + 1;

1836  
İ
[
i
].
ty³
 ){

1837 
OPT_FLAG
:

1838 
OPT_FFLAG
:

1840 
OPT_INT
:

1841 
OPT_FINT
:

1842 
Ën
 += 9;

1844 
OPT_DBL
:

1845 
OPT_FDBL
:

1846 
Ën
 += 6;

1848 
OPT_STR
:

1849 
OPT_FSTR
:

1850 
Ën
 += 8;

1853 ifĞ
Ën
>
max
 ) max =†en;

1855 
i
=0; 
İ
[i].
Ïb–
; i++){

1856  
İ
[
i
].
ty³
 ){

1857 
OPT_FLAG
:

1858 
OPT_FFLAG
:

1859 
	`årštf
(
”r¡»am
," -%-*  %s\n",
max
,
İ
[
i
].
Ïb–
,İ[i].
mes§ge
);

1861 
OPT_INT
:

1862 
OPT_FINT
:

1863 
	`årštf
(
”r¡»am
," %s=<š‹g”>%*  %s\n",
İ
[
i
].
Ïb–
,

1864 ()(
max
-
	`¡¾’
(
İ
[
i
].
Ïb–
)-9),"",İ[i].
mes§ge
);

1866 
OPT_DBL
:

1867 
OPT_FDBL
:

1868 
	`årštf
(
”r¡»am
," %s=<»®>%*  %s\n",
İ
[
i
].
Ïb–
,

1869 ()(
max
-
	`¡¾’
(
İ
[
i
].
Ïb–
)-6),"",İ[i].
mes§ge
);

1871 
OPT_STR
:

1872 
OPT_FSTR
:

1873 
	`årštf
(
”r¡»am
," %s=<¡ršg>%*  %s\n",
İ
[
i
].
Ïb–
,

1874 ()(
max
-
	`¡¾’
(
İ
[
i
].
Ïb–
)-8),"",İ[i].
mes§ge
);

1878 
	}
}

1885 
	sp¡©e
 {

1886 *
	mf’ame
;

1887 
	mtok’lš’o
;

1888 
	m”rÜút
;

1889 *
	mtok’¡¬t
;

1890 
ËmÚ
 *
	mgp
;

1891 
	ee_¡©e
 {

1892 
	mINITIALIZE
,

1893 
	mWAITING_FOR_DECL_OR_RULE
,

1894 
	mWAITING_FOR_DECL_KEYWORD
,

1895 
	mWAITING_FOR_DECL_ARG
,

1896 
	mWAITING_FOR_PRECEDENCE_SYMBOL
,

1897 
	mWAITING_FOR_ARROW
,

1898 
	mIN_RHS
,

1899 
	mLHS_ALIAS_1
,

1900 
	mLHS_ALIAS_2
,

1901 
	mLHS_ALIAS_3
,

1902 
	mRHS_ALIAS_1
,

1903 
	mRHS_ALIAS_2
,

1904 
	mPRECEDENCE_MARK_1
,

1905 
	mPRECEDENCE_MARK_2
,

1906 
	mRESYNC_AFTER_RULE_ERROR
,

1907 
	mRESYNC_AFTER_DECL_ERROR
,

1908 
	mWAITING_FOR_DESTRUCTOR_SYMBOL
,

1909 
	mWAITING_FOR_DATATYPE_SYMBOL
,

1910 
	mWAITING_FOR_FALLBACK_ID


1911 } 
	m¡©e
;

1912 
symbŞ
 *
	mçÎback
;

1913 
symbŞ
 *
	mlhs
;

1914 *
	mlh§lŸs
;

1915 
	mÄhs
;

1916 
symbŞ
 *
	mrhs
[
MAXRHS
];

1917 *
	m®Ÿs
[
MAXRHS
];

1918 
ruË
 *
	m´evruË
;

1919 *
	mdeşkeywÜd
;

1920 **
	mdeş¬g¦Ù
;

1921 *
	mdeşÊ¦Ù
;

1922 
e_assoc
 
	mdeşassoc
;

1923 
	m´eccouÁ”
;

1924 
ruË
 *
	mfœ¡ruË
;

1925 
ruË
 *
	mÏ¡ruË
;

1929 
	$·r£Ú‘ok’
(
p¥
)

1930 
p¡©e
 *
p¥
;

1932 *
x
;

1933 
x
 = 
	`SŒ§ã
(
p¥
->
tok’¡¬t
);

1935 
	`´štf
("%s:%d: Tok’=[%s] s‹=%d\n",
p¥
->
f’ame
,p¥->
tok’lš’o
,

1936 
x
,
p¥
->
¡©e
);

1938  
p¥
->
¡©e
 ){

1939 
INITIALIZE
:

1940 
p¥
->
´evruË
 = 0;

1941 
p¥
->
´eccouÁ”
 = 0;

1942 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 0;

1943 
p¥
->
gp
->
ÄuË
 = 0;

1945 
WAITING_FOR_DECL_OR_RULE
:

1946 ifĞ
x
[0]=='%' ){

1947 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

1948 }ifĞ
	`i¦ow”
(
x
[0]) ){

1949 
p¥
->
lhs
 = 
	`SymbŞ_Ãw
(
x
);

1950 
p¥
->
Ähs
 = 0;

1951 
p¥
->
lh§lŸs
 = 0;

1952 
p¥
->
¡©e
 = 
WAITING_FOR_ARROW
;

1953 }ifĞ
x
[0]=='{' ){

1954 ifĞ
p¥
->
´evruË
==0 ){

1955 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

1958 
p¥
->
”rÜút
++;

1959 }ifĞ
p¥
->
´evruË
->
code
!=0 ){

1960 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

1963 
p¥
->
”rÜút
++;

1965 
p¥
->
´evruË
->
lše
 =…¥->
tok’lš’o
;

1966 
p¥
->
´evruË
->
code
 = &
x
[1];

1968 }ifĞ
x
[0]=='[' ){

1969 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_1
;

1971 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

1973 
x
);

1974 
p¥
->
”rÜút
++;

1977 
PRECEDENCE_MARK_1
:

1978 ifĞ!
	`isuµ”
(
x
[0]) ){

1979 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

1981 
p¥
->
”rÜút
++;

1982 }ifĞ
p¥
->
´evruË
==0 ){

1983 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

1984 "Th”i nØ´iÜ„uËØassigÀ´eûd’û \"[%s]\".",
x
);

1985 
p¥
->
”rÜút
++;

1986 }ifĞ
p¥
->
´evruË
->
´ecsym
!=0 ){

1987 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

1990 
p¥
->
”rÜút
++;

1992 
p¥
->
´evruË
->
´ecsym
 = 
	`SymbŞ_Ãw
(
x
);

1994 
p¥
->
¡©e
 = 
PRECEDENCE_MARK_2
;

1996 
PRECEDENCE_MARK_2
:

1997 ifĞ
x
[0]!=']' ){

1998 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2000 
p¥
->
”rÜút
++;

2002 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2004 
WAITING_FOR_ARROW
:

2005 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2006 
p¥
->
¡©e
 = 
IN_RHS
;

2007 }ifĞ
x
[0]=='(' ){

2008 
p¥
->
¡©e
 = 
LHS_ALIAS_1
;

2010 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2012 
p¥
->
lhs
->
Çme
);

2013 
p¥
->
”rÜút
++;

2014 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2017 
LHS_ALIAS_1
:

2018 ifĞ
	`i§Íha
(
x
[0]) ){

2019 
p¥
->
lh§lŸs
 = 
x
;

2020 
p¥
->
¡©e
 = 
LHS_ALIAS_2
;

2022 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2024 
x
,
p¥
->
lhs
->
Çme
);

2025 
p¥
->
”rÜút
++;

2026 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2029 
LHS_ALIAS_2
:

2030 ifĞ
x
[0]==')' ){

2031 
p¥
->
¡©e
 = 
LHS_ALIAS_3
;

2033 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2034 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2035 
p¥
->
”rÜút
++;

2036 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2039 
LHS_ALIAS_3
:

2040 ifĞ
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2041 
p¥
->
¡©e
 = 
IN_RHS
;

2043 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2045 
p¥
->
lhs
->
Çme
,p¥->
lh§lŸs
);

2046 
p¥
->
”rÜút
++;

2047 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2050 
IN_RHS
:

2051 ifĞ
x
[0]=='.' ){

2052 
ruË
 *
½
;

2053 
½
 = (
ruË
 *)
	`m®loc
( (rule) +

2054 (
symbŞ
*)*
p¥
->
Ähs
 + (*)*psp->nrhs );

2055 ifĞ
½
==0 ){

2056 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2058 
p¥
->
”rÜút
++;

2059 
p¥
->
´evruË
 = 0;

2061 
i
;

2062 
½
->
ruËlše
 = 
p¥
->
tok’lš’o
;

2063 
½
->
rhs
 = (
symbŞ
**)&rp[1];

2064 
½
->
rh§lŸs
 = (**)&Ôp->
rhs
[
p¥
->
Ähs
]);

2065 
i
=0; i<
p¥
->
Ähs
; i++){

2066 
½
->
rhs
[
i
] = 
p¥
->rhs[i];

2067 
½
->
rh§lŸs
[
i
] = 
p¥
->
®Ÿs
[i];

2069 
½
->
lhs
 = 
p¥
->lhs;

2070 
½
->
lh§lŸs
 = 
p¥
->lhsalias;

2071 
½
->
Ähs
 = 
p¥
->nrhs;

2072 
½
->
code
 = 0;

2073 
½
->
´ecsym
 = 0;

2074 
½
->
šdex
 = 
p¥
->
gp
->
ÄuË
++;

2075 
½
->
Ãxhs
 =„p->
lhs
->
ruË
;

2076 
½
->
lhs
->
ruË
 =„p;

2077 
½
->
Ãxt
 = 0;

2078 ifĞ
p¥
->
fœ¡ruË
==0 ){

2079 
p¥
->
fœ¡ruË
 =…¥->
Ï¡ruË
 = 
½
;

2081 
p¥
->
Ï¡ruË
->
Ãxt
 = 
½
;

2082 
p¥
->
Ï¡ruË
 = 
½
;

2084 
p¥
->
´evruË
 = 
½
;

2086 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2087 }ifĞ
	`i§Íha
(
x
[0]) ){

2088 ifĞ
p¥
->
Ähs
>=
MAXRHS
 ){

2089 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2091 
x
);

2092 
p¥
->
”rÜút
++;

2093 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2095 
p¥
->
rhs
[p¥->
Ähs
] = 
	`SymbŞ_Ãw
(
x
);

2096 
p¥
->
®Ÿs
[p¥->
Ähs
] = 0;

2097 
p¥
->
Ähs
++;

2099 }ifĞ
x
[0]=='(' && 
p¥
->
Ähs
>0 ){

2100 
p¥
->
¡©e
 = 
RHS_ALIAS_1
;

2102 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2103 "IÎeg® ch¬aù” oÀRHS oàruË: \"%s\".",
x
);

2104 
p¥
->
”rÜút
++;

2105 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2108 
RHS_ALIAS_1
:

2109 ifĞ
	`i§Íha
(
x
[0]) ){

2110 
p¥
->
®Ÿs
[p¥->
Ähs
-1] = 
x
;

2111 
p¥
->
¡©e
 = 
RHS_ALIAS_2
;

2113 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2115 
x
,
p¥
->
rhs
[p¥->
Ähs
-1]->
Çme
);

2116 
p¥
->
”rÜút
++;

2117 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2120 
RHS_ALIAS_2
:

2121 ifĞ
x
[0]==')' ){

2122 
p¥
->
¡©e
 = 
IN_RHS
;

2124 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2125 "Missšg \")\" fŞlowšg LHS‡lŸ Çm\"%s\".",
p¥
->
lh§lŸs
);

2126 
p¥
->
”rÜút
++;

2127 
p¥
->
¡©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2130 
WAITING_FOR_DECL_KEYWORD
:

2131 ifĞ
	`i§Íha
(
x
[0]) ){

2132 
p¥
->
deşkeywÜd
 = 
x
;

2133 
p¥
->
deş¬g¦Ù
 = 0;

2134 
p¥
->
deşÊ¦Ù
 = 0;

2135 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2136 ifĞ
	`¡rcmp
(
x
,"name")==0 ){

2137 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
Çme
);

2138 }ifĞ
	`¡rcmp
(
x
,"include")==0 ){

2139 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
šşude
);

2140 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
šşud–n
;

2141 }ifĞ
	`¡rcmp
(
x
,"code")==0 ){

2142 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
exŒacode
);

2143 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
exŒacod–n
;

2144 }ifĞ
	`¡rcmp
(
x
,"token_destructor")==0 ){

2145 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’de¡
;

2146 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
tok’de¡Ê
;

2147 }ifĞ
	`¡rcmp
(
x
,"default_destructor")==0 ){

2148 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
v¬de¡
;

2149 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
v¬de¡Ê
;

2150 }ifĞ
	`¡rcmp
(
x
,"token_prefix")==0 ){

2151 
p¥
->
deş¬g¦Ù
 = &p¥->
gp
->
tok’´efix
;

2152 }ifĞ
	`¡rcmp
(
x
,"syntax_error")==0 ){

2153 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
”rÜ
);

2154 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
”rÜÊ
;

2155 }ifĞ
	`¡rcmp
(
x
,"parse_accept")==0 ){

2156 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
acû±
);

2157 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
acû±Ê
;

2158 }ifĞ
	`¡rcmp
(
x
,"parse_failure")==0 ){

2159 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
çu»
);

2160 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
çu»Ê
;

2161 }ifĞ
	`¡rcmp
(
x
,"stack_overflow")==0 ){

2162 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
ov”æow
);

2163 
p¥
->
deşÊ¦Ù
 = &p¥->
gp
->
ov”æowÊ
;

2164 }ifĞ
	`¡rcmp
(
x
,"extra_argument")==0 ){

2165 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¬g
);

2166 }ifĞ
	`¡rcmp
(
x
,"token_type")==0 ){

2167 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
tok’ty³
);

2168 }ifĞ
	`¡rcmp
(
x
,"default_type")==0 ){

2169 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
v¬ty³
);

2170 }ifĞ
	`¡rcmp
(
x
,"stack_size")==0 ){

2171 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡acksize
);

2172 }ifĞ
	`¡rcmp
(
x
,"start_symbol")==0 ){

2173 
p¥
->
deş¬g¦Ù
 = &Õ¥->
gp
->
¡¬t
);

2174 }ifĞ
	`¡rcmp
(
x
,"left")==0 ){

2175 
p¥
->
´eccouÁ”
++;

2176 
p¥
->
deşassoc
 = 
LEFT
;

2177 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2178 }ifĞ
	`¡rcmp
(
x
,"right")==0 ){

2179 
p¥
->
´eccouÁ”
++;

2180 
p¥
->
deşassoc
 = 
RIGHT
;

2181 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2182 }ifĞ
	`¡rcmp
(
x
,"nonassoc")==0 ){

2183 
p¥
->
´eccouÁ”
++;

2184 
p¥
->
deşassoc
 = 
NONE
;

2185 
p¥
->
¡©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2186 }ifĞ
	`¡rcmp
(
x
,"destructor")==0 ){

2187 
p¥
->
¡©e
 = 
WAITING_FOR_DESTRUCTOR_SYMBOL
;

2188 }ifĞ
	`¡rcmp
(
x
,"type")==0 ){

2189 
p¥
->
¡©e
 = 
WAITING_FOR_DATATYPE_SYMBOL
;

2190 }ifĞ
	`¡rcmp
(
x
,"fallback")==0 ){

2191 
p¥
->
çÎback
 = 0;

2192 
p¥
->
¡©e
 = 
WAITING_FOR_FALLBACK_ID
;

2194 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2195 "UnknowÀdeş¬©iÚ keywÜd: \"%%%s\".",
x
);

2196 
p¥
->
”rÜút
++;

2197 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2200 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2201 "IÎeg® deş¬©iÚ keywÜd: \"%s\".",
x
);

2202 
p¥
->
”rÜút
++;

2203 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2206 
WAITING_FOR_DESTRUCTOR_SYMBOL
:

2207 ifĞ!
	`i§Íha
(
x
[0]) ){

2208 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2210 
p¥
->
”rÜút
++;

2211 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2213 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2214 
p¥
->
deş¬g¦Ù
 = &
¥
->
de¡ruùÜ
;

2215 
p¥
->
deşÊ¦Ù
 = &
¥
->
de¡ruùÜÊ
;

2216 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2219 
WAITING_FOR_DATATYPE_SYMBOL
:

2220 ifĞ!
	`i§Íha
(
x
[0]) ){

2221 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2223 
p¥
->
”rÜút
++;

2224 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2226 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2227 
p¥
->
deş¬g¦Ù
 = &
¥
->
d©©y³
;

2228 
p¥
->
deşÊ¦Ù
 = 0;

2229 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_ARG
;

2232 
WAITING_FOR_PRECEDENCE_SYMBOL
:

2233 ifĞ
x
[0]=='.' ){

2234 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2235 }ifĞ
	`isuµ”
(
x
[0]) ){

2236 
symbŞ
 *
¥
;

2237 
¥
 = 
	`SymbŞ_Ãw
(
x
);

2238 ifĞ
¥
->
´ec
>=0 ){

2239 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2240 "SymbŞ \"%s\" ha ®»ady bgiv’‡…»ûd’û.",
x
);

2241 
p¥
->
”rÜút
++;

2243 
¥
->
´ec
 = 
p¥
->
´eccouÁ”
;

2244 
¥
->
assoc
 = 
p¥
->
deşassoc
;

2247 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2248 "Cª'ˆassigÀ¨´eûd’ûØ\"%s\".",
x
);

2249 
p¥
->
”rÜút
++;

2252 
WAITING_FOR_DECL_ARG
:

2253 ifĞ(
x
[0]=='{' || x[0]=='\"' || 
	`i§Êum
(x[0])) ){

2254 ifĞ*(
p¥
->
deş¬g¦Ù
)!=0 ){

2255 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2257 
x
[0]=='\"' ? &x[1] : x,
p¥
->
deşkeywÜd
);

2258 
p¥
->
”rÜút
++;

2259 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2261 *(
p¥
->
deş¬g¦Ù
èğ(
x
[0]=='\"' || x[0]=='{') ? &x[1] : x;

2262 ifĞ
p¥
->
deşÊ¦Ù
 ) *p¥->deşÊ¦Ù =…¥->
tok’lš’o
;

2263 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2266 
	`E¼ÜMsg
(
p¥
->
f’ame
,p¥->
tok’lš’o
,

2267 "IÎeg®‡rgum’ˆtØ%%%s: %s",
p¥
->
deşkeywÜd
,
x
);

2268 
p¥
->
”rÜút
++;

2269 
p¥
->
¡©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2272 
WAITING_FOR_FALLBACK_ID
:

2273 ifĞ
x
[0]=='.' ){

2274 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2275 }ifĞ!
	`isuµ”
(
x
[0]) ){

2276 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2277 "%%çÎback‡rgum’ˆ\"%s\" should b¨tok’", 
x
);

2278 
p¥
->
”rÜút
++;

2280 
symbŞ
 *
¥
 = 
	`SymbŞ_Ãw
(
x
);

2281 ifĞ
p¥
->
çÎback
==0 ){

2282 
p¥
->
çÎback
 = 
¥
;

2283 }ifĞ
¥
->
çÎback
 ){

2284 
	`E¼ÜMsg
(
p¥
->
f’ame
,…¥->
tok’lš’o
,

2285 "MÜthª oÃ f®lback‡ssigÃdØtok’ %s", 
x
);

2286 
p¥
->
”rÜút
++;

2288 
¥
->
çÎback
 = 
p¥
->fallback;

2289 
p¥
->
gp
->
has_çÎback
 = 1;

2293 
RESYNC_AFTER_RULE_ERROR
:

2296 
RESYNC_AFTER_DECL_ERROR
:

2297 ifĞ
x
[0]=='.' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2298 ifĞ
x
[0]=='%' ) 
p¥
->
¡©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2301 
	}
}

2308 
p¡©e
 
	gps
;

2309 
	$P¬£
(
gp
)

2310 
ËmÚ
 *
gp
;

2312 
FILE
 *
å
;

2313 *
febuf
;

2314 
size_t
 
fesize
;

2315 
lš’o
;

2316 
c
;

2317 *
ı
, *
Ãxtı
;

2318 
¡¬še
 = 0;

2320 
ps
.
gp
 = gp;

2321 
ps
.
f’ame
 = 
gp
->filename;

2322 
ps
.
”rÜút
 = 0;

2323 
ps
.
¡©e
 = 
INITIALIZE
;

2326 
å
 = 
	`fİ’
(
ps
.
f’ame
,"rb");

2327 ifĞ
å
==0 ){

2328 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't openhis file for„eading.");

2329 
gp
->
”rÜút
++;

2332 
	`f£ek
(
å
,0,2);

2333 
fesize
 = 
	`á–l
(
å
);

2334 
	`»wšd
(
å
);

2335 
febuf
 = (*)
	`m®loc
Ğ
fesize
+1 );

2336 ifĞ
febuf
==0 ){

2337 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't‡llocate %d of memoryo holdhis file.",

2338 
fesize
+1);

2339 
	`fşo£
(
å
);

2340 
gp
->
”rÜút
++;

2343 ifĞ
	`ä—d
(
febuf
,1,
fesize
,
å
)!=filesize ){

2344 
	`E¼ÜMsg
(
ps
.
f’ame
,0,"Can't„ead in‡ll %d bytes ofhis file.",

2345 
fesize
);

2346 
	`ä“
(
febuf
);

2347 
	`fşo£
(
å
);

2348 
gp
->
”rÜút
++;

2351 
	`fşo£
(
å
);

2352 
febuf
[
fesize
] = 0;

2355 
lš’o
 = 1;

2356 
ı
=
febuf
; (
c
= *cp)!=0; ){

2357 ifĞ
c
=='\n' ) 
lš’o
++;

2358 ifĞ
	`is¥aû
(
c
è){ 
ı
++; ; }

2359 ifĞ
c
=='/' && 
ı
[1]=='/' ){

2360 
ı
+=2;

2361  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2364 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2365 
ı
+=2;

2366  (
c
ğ*
ı
)!=0 && (c!='/' || cp[-1]!='*') ){

2367 ifĞ
c
=='\n' ) 
lš’o
++;

2368 
ı
++;

2370 ifĞ
c
 ) 
ı
++;

2373 
ps
.
tok’¡¬t
 = 
ı
;

2374 
ps
.
tok’lš’o
 = 
lš’o
;

2375 ifĞ
c
=='\"' ){

2376 
ı
++;

2377  (
c
ğ*
ı
)!=0 && c!='\"' ){

2378 ifĞ
c
=='\n' ) 
lš’o
++;

2379 
ı
++;

2381 ifĞ
c
==0 ){

2382 
	`E¼ÜMsg
(
ps
.
f’ame
,
¡¬še
,

2384 
ps
.
”rÜút
++;

2385 
Ãxtı
 = 
ı
;

2387 
Ãxtı
 = 
ı
+1;

2389 }ifĞ
c
=='{' ){

2390 
Ëv–
;

2391 
ı
++;

2392 
Ëv–
=1; (
c
ğ*
ı
)!=0 && (level>1 || c!='}'); cp++){

2393 ifĞ
c
=='\n' ) 
lš’o
++;

2394 ifĞ
c
=='{' ) 
Ëv–
++;

2395 ifĞ
c
=='}' ) 
Ëv–
--;

2396 ifĞ
c
=='/' && 
ı
[1]=='*' ){

2397 
´evc
;

2398 
ı
 = &cp[2];

2399 
´evc
 = 0;

2400  (
c
ğ*
ı
)!=0 && (c!='/' || 
´evc
!='*') ){

2401 ifĞ
c
=='\n' ) 
lš’o
++;

2402 
´evc
 = 
c
;

2403 
ı
++;

2405 }ifĞ
c
=='/' && 
ı
[1]=='/' ){

2406 
ı
 = &cp[2];

2407  (
c
ğ*
ı
)!=0 && c!='\n' ) cp++;

2408 ifĞ
c
 ) 
lš’o
++;

2409 }ifĞ
c
=='\'' || c=='\"' ){

2410 
¡¬tch¬
, 
´evc
;

2411 
¡¬tch¬
 = 
c
;

2412 
´evc
 = 0;

2413 
ı
++; (
c
ğ*ı)!=0 && (c!=
¡¬tch¬
 || 
´evc
=='\\'); cp++){

2414 ifĞ
c
=='\n' ) 
lš’o
++;

2415 ifĞ
´evc
=='\\' )…revc = 0;

2416 
´evc
 = 
c
;

2420 ifĞ
c
==0 ){

2421 
	`E¼ÜMsg
(
ps
.
f’ame
,ps.
tok’lš’o
,

2423 
ps
.
”rÜút
++;

2424 
Ãxtı
 = 
ı
;

2426 
Ãxtı
 = 
ı
+1;

2428 }ifĞ
	`i§Êum
(
c
) ){

2429  (
c
ğ*
ı
)!=0 && (
	`i§Êum
(c) || c=='_') ) cp++;

2430 
Ãxtı
 = 
ı
;

2431 }ifĞ
c
==':' && 
ı
[1]==':' && cp[2]=='=' ){

2432 
ı
 += 3;

2433 
Ãxtı
 = 
ı
;

2435 
ı
++;

2436 
Ãxtı
 = 
ı
;

2438 
c
 = *
ı
;

2439 *
ı
 = 0;

2440 
	`·r£Ú‘ok’
(&
ps
);

2441 *
ı
 = 
c
;

2442 
ı
 = 
Ãxtı
;

2444 
	`ä“
(
febuf
);

2445 
gp
->
ruË
 = 
ps
.
fœ¡ruË
;

2446 
gp
->
”rÜút
 = 
ps
.errorcnt;

2447 
	}
}

2453 
¶šk
 *
	g¶šk_ä“li¡
 = 0;

2456 
¶šk
 *
	$Plšk_Ãw
(){

2457 
¶šk
 *
Ãw
;

2459 ifĞ
¶šk_ä“li¡
==0 ){

2460 
i
;

2461 
amt
 = 100;

2462 
¶šk_ä“li¡
 = (
¶šk
 *)
	`m®loc
Ğ(¶šk)*
amt
 );

2463 ifĞ
¶šk_ä“li¡
==0 ){

2464 
	`årštf
(
¡d”r
,

2466 
	`ex™
(1);

2468 
i
=0; i<
amt
-1; i++è
¶šk_ä“li¡
[i].
Ãxt
 = &plink_freelist[i+1];

2469 
¶šk_ä“li¡
[
amt
-1].
Ãxt
 = 0;

2471 
Ãw
 = 
¶šk_ä“li¡
;

2472 
¶šk_ä“li¡
 =…lšk_ä“li¡->
Ãxt
;

2473  
Ãw
;

2474 
	}
}

2477 
	$Plšk_add
(
¶µ
,
cå
)

2478 
¶šk
 **
¶µ
;

2479 
cÚfig
 *
cå
;

2481 
¶šk
 *
Ãw
;

2482 
Ãw
 = 
	`Plšk_Ãw
();

2483 
Ãw
->
Ãxt
 = *
¶µ
;

2484 *
¶µ
 = 
Ãw
;

2485 
Ãw
->
cå
 = cfp;

2486 
	}
}

2489 
	$Plšk_cİy
(
to
,
äom
)

2490 
¶šk
 **
to
;

2491 
¶šk
 *
äom
;

2493 
¶šk
 *
Ãxl
;

2494  
äom
 ){

2495 
Ãxl
 = 
äom
->
Ãxt
;

2496 
äom
->
Ãxt
 = *
to
;

2497 *
to
 = 
äom
;

2498 
äom
 = 
Ãxl
;

2500 
	}
}

2503 
	$Plšk_d–‘e
(
¶p
)

2504 
¶šk
 *
¶p
;

2506 
¶šk
 *
Ãxl
;

2508  
¶p
 ){

2509 
Ãxl
 = 
¶p
->
Ãxt
;

2510 
¶p
->
Ãxt
 = 
¶šk_ä“li¡
;

2511 
¶šk_ä“li¡
 = 
¶p
;

2512 
¶p
 = 
Ãxl
;

2514 
	}
}

2524 
PRIVATE
 *
	$fe_mak’ame
(
Ëmp
,
suffix
)

2525 
ËmÚ
 *
Ëmp
;

2526 *
suffix
;

2528 *
Çme
;

2529 *
ı
;

2531 
Çme
 = 
	`m®loc
Ğ
	`¡¾’
(
Ëmp
->
f’ame
è+ sŒËn(
suffix
) + 5 );

2532 ifĞ
Çme
==0 ){

2533 
	`årštf
(
¡d”r
,"Can't‡llocate space for‡ filename.\n");

2534 
	`ex™
(1);

2537 ià(
NULL
 =ğ(
ı
 = 
	`¡¼chr
(
Ëmp
->
f’ame
, '/'))) {

2538 
ı
 = 
Ëmp
->
f’ame
;

2540 
ı
++;

2542 
	`¡rıy
(
Çme
,
ı
);

2543 
ı
 = 
	`¡¼chr
(
Çme
,'.');

2544 ifĞ
ı
 ) *cp = 0;

2545 
	`¡rÿt
(
Çme
,
suffix
);

2546  
Çme
;

2547 
	}
}

2552 
PRIVATE
 
FILE
 *
	$fe_İ’
(
Ëmp
,
suffix
,
mode
)

2553 
ËmÚ
 *
Ëmp
;

2554 *
suffix
;

2555 *
mode
;

2557 
FILE
 *
å
;

2559 ifĞ
Ëmp
->
ouŠame
 ) 
	`ä“
(lemp->outname);

2560 
Ëmp
->
ouŠame
 = 
	`fe_mak’ame
Öemp, 
suffix
);

2561 
å
 = 
	`fİ’
(
Ëmp
->
ouŠame
,
mode
);

2562 ifĞ
å
==0 && *
mode
=='w' ){

2563 
	`årštf
(
¡d”r
,"Cª'ˆİ’ f\"%s\".\n",
Ëmp
->
ouŠame
);

2564 
Ëmp
->
”rÜút
++;

2567  
å
;

2568 
	}
}

2572 
	$R•ršt
(
Ëmp
)

2573 
ËmÚ
 *
Ëmp
;

2575 
ruË
 *
½
;

2576 
symbŞ
 *
¥
;

2577 
i
, 
j
, 
maxËn
, 
Ën
, 
ncŞumns
, 
sk
;

2578 
	`´štf
("// R•ršˆoàšpuˆf\"%s\".\n// SymbŞs:\n",
Ëmp
->
f’ame
);

2579 
maxËn
 = 10;

2580 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

2581 
¥
 = 
Ëmp
->
symbŞs
[
i
];

2582 
Ën
 = 
	`¡¾’
(
¥
->
Çme
);

2583 ifĞ
Ën
>
maxËn
 ) maxlen =†en;

2585 
ncŞumns
 = 76/(
maxËn
+5);

2586 ifĞ
ncŞumns
<1 )‚columns = 1;

2587 
sk
 = (
Ëmp
->
nsymbŞ
 + 
ncŞumns
 - 1)/ncolumns;

2588 
i
=0; i<
sk
; i++){

2589 
	`´štf
("//");

2590 
j
=
i
; j<
Ëmp
->
nsymbŞ
; j+=
sk
){

2591 
¥
 = 
Ëmp
->
symbŞs
[
j
];

2592 
	`as£¹
Ğ
¥
->
šdex
==
j
 );

2593 
	`´štf
(" %3d %-*.*s",
j
,
maxËn
,maxËn,
¥
->
Çme
);

2595 
	`´štf
("\n");

2597 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

2598 
	`´štf
("%s",
½
->
lhs
->
Çme
);

2600 
	`´štf
(" ::=");

2601 
i
=0; i<
½
->
Ähs
; i++){

2602 
	`´štf
(" %s",
½
->
rhs
[
i
]->
Çme
);

2605 
	`´štf
(".");

2606 ifĞ
½
->
´ecsym
 ) 
	`´štf
(" [%s]",½->´ecsym->
Çme
);

2608 
	`´štf
("\n");

2610 
	}
}

2612 
PRIVATE
 
	$CÚfigPršt
(
å
,
cå
)

2613 
FILE
 *
å
;

2614 
cÚfig
 *
cå
;

2616 
ruË
 *
½
;

2617 
i
;

2618 
½
 = 
cå
->rp;

2619 
	`årštf
(
å
,"% ::=",
½
->
lhs
->
Çme
);

2620 
i
=0; i<=
½
->
Ähs
; i++){

2621 ifĞ
i
==
cå
->
dÙ
 ) 
	`årštf
(
å
," *");

2622 ifĞ
i
==
½
->
Ähs
 ) ;

2623 
	`årštf
(
å
," %s",
½
->
rhs
[
i
]->
Çme
);

2625 
	}
}

2628 #ifdeà
TEST


2630 
PRIVATE
 
	$S‘Pršt
(
out
,
£t
,
Ëmp
)

2631 
FILE
 *
out
;

2632 *
£t
;

2633 
ËmÚ
 *
Ëmp
;

2635 
i
;

2636 *
¥aûr
;

2637 
¥aûr
 = "";

2638 
	`årštf
(
out
,"%12s[","");

2639 
i
=0; i<
Ëmp
->
Á”mš®
; i++){

2640 ifĞ
	`S‘Fšd
(
£t
,
i
) ){

2641 
	`årštf
(
out
,"%s%s",
¥aûr
,
Ëmp
->
symbŞs
[
i
]->
Çme
);

2642 
¥aûr
 = " ";

2645 
	`årštf
(
out
,"]\n");

2646 
	}
}

2649 
	$PlškPršt
(
out
,
¶p
,
g
)

2650 
FILE
 *
out
;

2651 
¶šk
 *
¶p
;

2652 *
g
;

2654  
¶p
 ){

2655 
	`årštf
(
out
,"%12s% (¡©%2dè","",
g
,
¶p
->
cå
->
¡p
->
šdex
);

2656 
	`CÚfigPršt
(
out
,
¶p
->
cå
);

2657 
	`årštf
(
out
,"\n");

2658 
¶p
 =…Í->
Ãxt
;

2660 
	}
}

2666 
PRIVATE
 
	$PrštAùiÚ
(
aùiÚ
 *
­
, 
FILE
 *
å
, 
šd’t
){

2667 
»suÉ
 = 1;

2668  
­
->
ty³
 ){

2669 
SHIFT
:

2670 
	`årštf
(
å
,"%* shiá %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
¡p
->
šdex
);

2672 
REDUCE
:

2673 
	`årštf
(
å
,"%* »duû %d",
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2675 
ACCEPT
:

2676 
	`årštf
(
å
,"%* acû±",
šd’t
,
­
->
¥
->
Çme
);

2678 
ERROR
:

2679 
	`årštf
(
å
,"%* ”rÜ",
šd’t
,
­
->
¥
->
Çme
);

2681 
CONFLICT
:

2682 
	`årštf
(
å
,"%*s„educe %-3d ** Parsing conflict **",

2683 
šd’t
,
­
->
¥
->
Çme
,­->
x
.
½
->
šdex
);

2685 
SH_RESOLVED
:

2686 
RD_RESOLVED
:

2687 
NOT_USED
:

2688 
»suÉ
 = 0;

2691  
»suÉ
;

2692 
	}
}

2695 
	$R•ÜtOuut
(
Ëmp
)

2696 
ËmÚ
 *
Ëmp
;

2698 
i
;

2699 
¡©e
 *
¡p
;

2700 
cÚfig
 *
cå
;

2701 
aùiÚ
 *
­
;

2702 
FILE
 *
å
;

2704 
å
 = 
	`fe_İ’
(
Ëmp
,".out","w");

2705 ifĞ
å
==0 ) ;

2706 
	`årštf
(
å
," \b");

2707 
i
=0; i<
Ëmp
->
n¡©e
; i++){

2708 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

2709 
	`årštf
(
å
,"S‹ %d:\n",
¡p
->
šdex
);

2710 ifĞ
Ëmp
->
basisæag
 ) 
cå
=
¡p
->
bp
;

2711 
cå
=
¡p
->cfp;

2712  
cå
 ){

2713 
buf
[20];

2714 ifĞ
cå
->
dÙ
==cå->
½
->
Ähs
 ){

2715 
	`¥rštf
(
buf
,"(%d)",
cå
->
½
->
šdex
);

2716 
	`årštf
(
å
," %5 ",
buf
);

2718 
	`årštf
(
å
," ");

2720 
	`CÚfigPršt
(
å
,
cå
);

2721 
	`årštf
(
å
,"\n");

2722 #ifdeà
TEST


2723 
	`S‘Pršt
(
å
,
cå
->
fws
,
Ëmp
);

2724 
	`PlškPršt
(
å
,
cå
->
åÍ
,"To ");

2725 
	`PlškPršt
(
å
,
cå
->
b¶p
,"From");

2727 ifĞ
Ëmp
->
basisæag
 ) 
cå
=cå->
bp
;

2728 
cå
=cå->
Ãxt
;

2730 
	`årštf
(
å
,"\n");

2731 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

2732 ifĞ
	`PrštAùiÚ
(
­
,
å
,30èè
	`årštf
(fp,"\n");

2734 
	`årštf
(
å
,"\n");

2736 
	`fşo£
(
å
);

2738 
	}
}

2742 
PRIVATE
 *
	$·th£¬ch
(
¬gv0
,
Çme
,
modemask
)

2743 *
¬gv0
;

2744 *
Çme
;

2745 
modemask
;

2747 *
·thli¡
;

2748 *
·th
,*
ı
;

2749 
c
;

2751 #ifdeà
__WIN32__


2752 
ı
 = 
	`¡¼chr
(
¬gv0
,'\\');

2754 
ı
 = 
	`¡¼chr
(
¬gv0
,'/');

2756 ifĞ
ı
 ){

2757 
c
 = *
ı
;

2758 *
ı
 = 0;

2759 
·th
 = (*)
	`m®loc
Ğ
	`¡¾’
(
¬gv0
è+ sŒËn(
Çme
) + 2 );

2760 ifĞ
·th
 ) 
	`¥rštf
Õ©h,"%s/%s",
¬gv0
,
Çme
);

2761 *
ı
 = 
c
;

2763 
·thli¡
 = 
	`g‘’v
("PATH");

2764 ifĞ
·thli¡
==0 )…athlist = ".:/bin:/usr/bin";

2765 
·th
 = (*)
	`m®loc
Ğ
	`¡¾’
(
·thli¡
)+¡¾’(
Çme
)+2 );

2766 ifĞ
·th
!=0 ){

2767  *
·thli¡
 ){

2768 
ı
 = 
	`¡rchr
(
·thli¡
,':');

2769 ifĞ
ı
==0 ) c°ğ&
·thli¡
[
	`¡¾’
(pathlist)];

2770 
c
 = *
ı
;

2771 *
ı
 = 0;

2772 
	`¥rštf
(
·th
,"%s/%s",
·thli¡
,
Çme
);

2773 *
ı
 = 
c
;

2774 ifĞ
c
==0 ) 
·thli¡
 = "";

2775 
·thli¡
 = &
ı
[1];

2776 ifĞ
	`acûss
(
·th
,
modemask
)==0 ) ;

2780  
·th
;

2781 
	}
}

2787 
PRIVATE
 
	$compu‹_aùiÚ
(
Ëmp
,
­
)

2788 
ËmÚ
 *
Ëmp
;

2789 
aùiÚ
 *
­
;

2791 
aù
;

2792  
­
->
ty³
 ){

2793 
SHIFT
: 
aù
 = 
­
->
x
.
¡p
->
šdex
; ;

2794 
REDUCE
: 
aù
 = 
­
->
x
.
½
->
šdex
 + 
Ëmp
->
n¡©e
; ;

2795 
ERROR
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
; ;

2796 
ACCEPT
: 
aù
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
 + 1; ;

2797 : 
aù
 = -1; ;

2799  
aù
;

2800 
	}
}

2802 
	#LINESIZE
 1000

	)

2812 
PRIVATE
 
	$É_xãr
(
Çme
,
š
,
out
,
lš’o
)

2813 *
Çme
;

2814 
FILE
 *
š
;

2815 
FILE
 *
out
;

2816 *
lš’o
;

2818 
i
, 
iS¹
;

2819 
lše
[
LINESIZE
];

2820  
	`fg‘s
(
lše
,
LINESIZE
,
š
) && (line[0]!='%' ||†ine[1]!='%') ){

2821 (*
lš’o
)++;

2822 
iS¹
 = 0;

2823 ifĞ
Çme
 ){

2824 
i
=0; 
lše
[i]; i++){

2825 ifĞ
lše
[
i
]=='P' && 
	`¡ºcmp
(&line[i],"Parse",5)==0

2826 && (
i
==0 || !
	`i§Íha
(
lše
[i-1]))

2828 ifĞ
i
>
iS¹
 ) 
	`årštf
(
out
,"%.*s",i-iS¹,&
lše
[iStart]);

2829 
	`årštf
(
out
,"%s",
Çme
);

2830 
i
 += 4;

2831 
iS¹
 = 
i
+1;

2835 
	`årštf
(
out
,"%s",&
lše
[
iS¹
]);

2837 
	}
}

2841 
PRIVATE
 
FILE
 *
	$É_İ’
(
Ëmp
)

2842 
ËmÚ
 *
Ëmp
;

2845 
buf
[1000];

2846 
FILE
 *
š
;

2847 *
ÉÇme
;

2848 *
ÉÇme_®loc
 = 
NULL
;

2849 *
ı
;

2851 
ı
 = 
	`¡¼chr
(
Ëmp
->
f’ame
,'.');

2852 ifĞ
ı
 ){

2853 
	`¥rštf
(
buf
,"%.*s.É",()(
ı
-
Ëmp
->
f’ame
),lemp->filename);

2855 
	`¥rštf
(
buf
,"%s.É",
Ëmp
->
f’ame
);

2857 ifĞ
	`acûss
(
buf
,004)==0 ){

2858 
ÉÇme
 = 
buf
;

2859 }ifĞ
	`acûss
(
Ëmp
->
tm¶Çme
,004)==0 ){

2860 
ÉÇme
 = 
Ëmp
->
tm¶Çme
;

2862 
ÉÇme
 = 
ÉÇme_®loc
 = 
	`·th£¬ch
(
Ëmp
->
¬gv0
,Ëmp->
tm¶Çme
,0);

2864 ifĞ
ÉÇme
==0 ){

2865 
	`årštf
(
¡d”r
,"Can't findhe…arser driveremplate file \"%s\".\n",

2866 
Ëmp
->
tm¶Çme
);

2867 
Ëmp
->
”rÜút
++;

2870 
š
 = 
	`fİ’
(
ÉÇme
,"r");

2871 ifĞ
š
==0 ){

2872 
	`årštf
(
¡d”r
,"Cª'ˆİ’h‹m¶©f\"%s\".\n",
ÉÇme
);

2873 
Ëmp
->
”rÜút
++;

2875 ià(
ÉÇme_®loc
è
	`ä“
(tpltname_alloc);

2876  
š
;

2877 
	}
}

2880 
PRIVATE
 
	$É_´št
(
out
,
Ëmp
,
¡r
,
¡¾n
,
lš’o
)

2881 
FILE
 *
out
;

2882 
ËmÚ
 *
Ëmp
;

2883 *
¡r
;

2884 
¡¾n
;

2885 *
lš’o
;

2887 ifĞ
¡r
==0 ) ;

2888 
	`årštf
(
out
,"#lš%d \"%s\"\n",
¡¾n
,
Ëmp
->
f’ame
); (*
lš’o
)++;

2889  *
¡r
 ){

2890 ifĞ*
¡r
=='\n' ) (*
lš’o
)++;

2891 
	`putc
(*
¡r
,
out
);

2892 
¡r
++;

2894 
	`årštf
(
out
,"\n#lš%d \"%s\"\n",*
lš’o
+2,
Ëmp
->
ouŠame
); (*lineno)+=2;

2896 
	}
}

2902 
PRIVATE
 
	$em™_de¡ruùÜ_code
(
out
,
¥
,
Ëmp
,
lš’o
)

2903 
FILE
 *
out
;

2904 
symbŞ
 *
¥
;

2905 
ËmÚ
 *
Ëmp
;

2906 *
lš’o
;

2908 *
ı
 = 0;

2910 
lšeút
 = 0;

2911 ifĞ
¥
->
ty³
==
TERMINAL
 ){

2912 
ı
 = 
Ëmp
->
tok’de¡
;

2913 ifĞ
ı
==0 ) ;

2914 
	`årštf
(
out
,"#lš%d \"%s\"\n{",
Ëmp
->
tok’de¡Ê
,Ëmp->
f’ame
);

2915 }ifĞ
¥
->
de¡ruùÜ
 ){

2916 
ı
 = 
¥
->
de¡ruùÜ
;

2917 
	`årštf
(
out
,"#lš%d \"%s\"\n{",
¥
->
de¡ruùÜÊ
,
Ëmp
->
f’ame
);

2919 
ı
 = 
Ëmp
->
v¬de¡
;

2920 ifĞ
ı
==0 ) ;

2921 
	`årštf
(
out
,"#lš%d \"%s\"\n{",
Ëmp
->
v¬de¡Ê
,Ëmp->
f’ame
);

2923 ; *
ı
; cp++){

2924 ifĞ*
ı
=='$' && cp[1]=='$' ){

2925 
	`årštf
(
out
,"(yypmšÜ->yy%d)",
¥
->
dŠum
);

2926 
ı
++;

2929 ifĞ*
ı
=='\n' ) 
lšeút
++;

2930 
	`åutc
(*
ı
,
out
);

2932 (*
lš’o
è+ğ3 + 
lšeút
;

2933 
	`årštf
(
out
,"}\n#lš%d \"%s\"\n",*
lš’o
,
Ëmp
->
ouŠame
);

2935 
	}
}

2940 
PRIVATE
 
	$has_de¡ruùÜ
(
¥
, 
Ëmp
)

2941 
symbŞ
 *
¥
;

2942 
ËmÚ
 *
Ëmp
;

2944 
»t
;

2945 ifĞ
¥
->
ty³
==
TERMINAL
 ){

2946 
»t
 = 
Ëmp
->
tok’de¡
!=0;

2948 
»t
 = 
Ëmp
->
v¬de¡
!=0 || 
¥
->
de¡ruùÜ
!=0;

2950  
»t
;

2951 
	}
}

2957 
PRIVATE
 
	$em™_code
(
out
,
½
,
Ëmp
,
lš’o
)

2958 
FILE
 *
out
;

2959 
ruË
 *
½
;

2960 
ËmÚ
 *
Ëmp
;

2961 *
lš’o
;

2963 *
ı
, *
xp
;

2964 
lšeút
 = 0;

2965 
i
;

2966 
lhsu£d
 = 0;

2967 
u£d
[
MAXRHS
];

2969 
i
=0; i<
½
->
Ähs
; i++è
u£d
[i] = 0;

2970 
lhsu£d
 = 0;

2973 ifĞ
½
->
code
 ){

2974 
	`årštf
(
out
,"#lš%d \"%s\"\n{",
½
->
lše
,
Ëmp
->
f’ame
);

2975 
ı
=
½
->
code
; *cp; cp++){

2976 ifĞ
	`i§Íha
(*
ı
è&& (ı==
½
->
code
 || (!
	`i§Êum
(cp[-1]) && cp[-1]!='_')) ){

2977 
§ved
;

2978 
xp
ğ&
ı
[1]; 
	`i§Êum
(*xp) || *xp=='_'; xp++);

2979 
§ved
 = *
xp
;

2980 *
xp
 = 0;

2981 ifĞ
½
->
lh§lŸs
 && 
	`¡rcmp
(
ı
,rp->lhsalias)==0 ){

2982 
	`årštf
(
out
,"yygÙomšÜ.yy%d",
½
->
lhs
->
dŠum
);

2983 
ı
 = 
xp
;

2984 
lhsu£d
 = 1;

2986 
i
=0; i<
½
->
Ähs
; i++){

2987 ifĞ
½
->
rh§lŸs
[
i
] && 
	`¡rcmp
(
ı
,rp->rhsalias[i])==0 ){

2988 
	`årštf
(
out
,"yym¥[%d].mšÜ.yy%d",
i
-
½
->
Ähs
+1,½->
rhs
[i]->
dŠum
);

2989 
ı
 = 
xp
;

2990 
u£d
[
i
] = 1;

2995 *
xp
 = 
§ved
;

2997 ifĞ*
ı
=='\n' ) 
lšeút
++;

2998 
	`åutc
(*
ı
,
out
);

3000 (*
lš’o
è+ğ3 + 
lšeút
;

3001 
	`årštf
(
out
,"}\n#lš%d \"%s\"\n",*
lš’o
,
Ëmp
->
ouŠame
);

3005 ifĞ
½
->
lh§lŸs
 && !
lhsu£d
 ){

3006 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3008 
½
->
lh§lŸs
,½->
lhs
->
Çme
,rp->lhsalias);

3009 
Ëmp
->
”rÜút
++;

3014 
i
=0; i<
½
->
Ähs
; i++){

3015 ifĞ
½
->
rh§lŸs
[
i
] && !
u£d
[i] ){

3016 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,
½
->
ruËlše
,

3018 
½
->
rh§lŸs
[
i
],½->
rhs
[i]->
Çme
,rp->rhsalias[i]);

3019 
Ëmp
->
”rÜút
++;

3020 }ifĞ
½
->
rh§lŸs
[
i
]==0 ){

3021 ifĞ
	`has_de¡ruùÜ
(
½
->
rhs
[
i
],
Ëmp
) ){

3022 
	`årštf
(
out
," yy_destructor(%d,&yymsp[%d].minor);\n",

3023 
½
->
rhs
[
i
]->
šdex
,i-½->
Ähs
+1); (*
lš’o
)++;

3025 
	`årštf
(
out
," /* No destructor defined for %s */\n",

3026 
½
->
rhs
[
i
]->
Çme
);

3027 (*
lš’o
)++;

3032 
	}
}

3041 
PRIVATE
 
	$´št_¡ack_uniÚ
(
out
,
Ëmp
,
¶š’o
,
mhæag
)

3042 
FILE
 *
out
;

3043 
ËmÚ
 *
Ëmp
;

3044 *
¶š’o
;

3045 
mhæag
;

3047 
lš’o
;

3048 **
ty³s
;

3049 
¬¿ysize
;

3050 
maxd’gth
;

3051 *
¡ddt
;

3052 
i
,
j
;

3053 
hash
;

3054 *
Çme
;

3057 
¬¿ysize
 = 
Ëmp
->
nsymbŞ
 * 2;

3058 
ty³s
 = (**)
	`m®loc
Ğ
¬¿ysize
 * (*) );

3059 
i
=0; i<
¬¿ysize
; i++è
ty³s
[i] = 0;

3060 
maxd’gth
 = 0;

3061 ifĞ
Ëmp
->
v¬ty³
 ){

3062 
maxd’gth
 = 
	`¡¾’
(
Ëmp
->
v¬ty³
);

3064 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3065 
Ën
;

3066 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3067 ifĞ
¥
->
d©©y³
==0 ) ;

3068 
Ën
 = 
	`¡¾’
(
¥
->
d©©y³
);

3069 ifĞ
Ën
>
maxd’gth
 ) maxdtlength =†en;

3071 
¡ddt
 = (*)
	`m®loc
Ğ
maxd’gth
*2 + 1 );

3072 ifĞ
ty³s
==0 || 
¡ddt
==0 ){

3073 
	`årštf
(
¡d”r
,"Out of memory.\n");

3074 
	`ex™
(1);

3083 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3084 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3085 *
ı
;

3086 ifĞ
¥
==
Ëmp
->
”rsym
 ){

3087 
¥
->
dŠum
 = 
¬¿ysize
+1;

3090 ifĞ
¥
->
ty³
!=
NONTERMINAL
 || (¥->
d©©y³
==0 && 
Ëmp
->
v¬ty³
==0) ){

3091 
¥
->
dŠum
 = 0;

3094 
ı
 = 
¥
->
d©©y³
;

3095 ifĞ
ı
==0 ) c°ğ
Ëmp
->
v¬ty³
;

3096 
j
 = 0;

3097  
	`is¥aû
(*
ı
) ) cp++;

3098  *
ı
 ) 
¡ddt
[
j
++] = *cp++;

3099  
j
>0 && 
	`is¥aû
(
¡ddt
[j-1]) ) j--;

3100 
¡ddt
[
j
] = 0;

3101 
hash
 = 0;

3102 
j
=0; 
¡ddt
[j]; j++){

3103 
hash
 = ()hash*53u + (è
¡ddt
[
j
];

3105 
hash
 = (hash & 0x7fffffff)%
¬¿ysize
;

3106  
ty³s
[
hash
] ){

3107 ifĞ
	`¡rcmp
(
ty³s
[
hash
],
¡ddt
)==0 ){

3108 
¥
->
dŠum
 = 
hash
 + 1;

3111 
hash
++;

3112 ifĞ
hash
>=
¬¿ysize
 ) hash = 0;

3114 ifĞ
ty³s
[
hash
]==0 ){

3115 
¥
->
dŠum
 = 
hash
 + 1;

3116 
ty³s
[
hash
] = (*)
	`m®loc
Ğ
	`¡¾’
(
¡ddt
)+1 );

3117 ifĞ
ty³s
[
hash
]==0 ){

3118 
	`årštf
(
¡d”r
,"Out of memory.\n");

3119 
	`ex™
(1);

3121 
	`¡rıy
(
ty³s
[
hash
],
¡ddt
);

3126 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3127 
lš’o
 = *
¶š’o
;

3128 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++; }

3129 
	`årštf
(
out
,"#defš%sTOKENTYPE %s\n",
Çme
,

3130 
Ëmp
->
tok’ty³
?Ëmp->tok’ty³:"void*"); 
lš’o
++;

3131 ifĞ
mhæag
 ){ 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++; }

3132 
	`årštf
(
out
,"ty³deàuniÚ {\n"); 
lš’o
++;

3133 
	`årštf
(
out
," %sTOKENTYPE yy0;\n",
Çme
); 
lš’o
++;

3134 
i
=0; i<
¬¿ysize
; i++){

3135 ifĞ
ty³s
[
i
]==0 ) ;

3136 
	`årštf
(
out
," % yy%d;\n",
ty³s
[
i
],i+1); 
lš’o
++;

3137 
	`ä“
(
ty³s
[
i
]);

3139 
	`årštf
(
out
," iÁ yy%d;\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3140 
	`ä“
(
¡ddt
);

3141 
	`ä“
(
ty³s
);

3142 
	`årštf
(
out
,"} YYMINORTYPE;\n"); 
lš’o
++;

3143 *
¶š’o
 = 
lš’o
;

3144 
	}
}

3150 cÚ¡ *
	$mšimum_size_ty³
(
lwr
, 
u´
){

3151 ifĞ
lwr
>=0 ){

3152 ifĞ
u´
<=255 ){

3154 }ifĞ
u´
<65535 ){

3159 }ifĞ
lwr
>=-127 && 
u´
<=127 ){

3161 }ifĞ
lwr
>=-32767 && 
u´
<32767 ){

3166 
	}
}

3174 
	sax£t
 {

3175 
¡©e
 *
	m¡p
;

3176 
	misTkn
;

3177 
	mnAùiÚ
;

3183 
	$ax£t_com·»
(cÚ¡ *
a
, cÚ¡ *
b
){

3184 
ax£t
 *
p1
 = (ax£t*)
a
;

3185 
ax£t
 *
p2
 = (ax£t*)
b
;

3186  
p2
->
nAùiÚ
 - 
p1
->nAction;

3187 
	}
}

3190 
	$R•ÜtTabË
(
Ëmp
, 
mhæag
)

3191 
ËmÚ
 *
Ëmp
;

3192 
mhæag
;

3194 
FILE
 *
out
, *
š
;

3195 
lše
[
LINESIZE
];

3196 
lš’o
;

3197 
¡©e
 *
¡p
;

3198 
aùiÚ
 *
­
;

3199 
ruË
 *
½
;

3200 
aùb
 *
pAùb
;

3201 
i
, 
j
, 
n
;

3202 
mnTknOf¡
, 
mxTknOf¡
;

3203 
mnNtOf¡
, 
mxNtOf¡
;

3204 
ax£t
 *
ax
;

3205 *
Çme
;

3207 
š
 = 
	`É_İ’
(
Ëmp
);

3208 ifĞ
š
==0 ) ;

3209 
out
 = 
	`fe_İ’
(
Ëmp
,".c","w");

3210 ifĞ
out
==0 ){

3211 
	`fşo£
(
š
);

3214 
lš’o
 = 1;

3215 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3218 
	`É_´št
(
out
,
Ëmp
,Ëmp->
šşude
,Ëmp->
šşud–n
,&
lš’o
);

3219 ifĞ
mhæag
 ){

3220 
Çme
 = 
	`fe_mak’ame
(
Ëmp
, ".h");

3221 
	`årštf
(
out
,"#šşud\"%s\"\n", 
Çme
); 
lš’o
++;

3222 
	`ä“
(
Çme
);

3224 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3227 ifĞ
mhæag
 ){

3228 *
´efix
;

3229 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3230 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3231 
´efix
 = "";

3232 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

3233 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

3234 
lš’o
++;

3236 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3238 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3241 
	`årštf
(
out
,"/* \001 */\n");

3242 
	`årštf
(
out
,"#define YYCODETYPE %s\n",

3243 
	`mšimum_size_ty³
(0, 
Ëmp
->
nsymbŞ
+5)); 
lš’o
++;

3244 
	`årštf
(
out
,"#defšYYNOCODE %d\n",
Ëmp
->
nsymbŞ
+1); 
lš’o
++;

3245 
	`årštf
(
out
,"#define YYACTIONTYPE %s\n",

3246 
	`mšimum_size_ty³
(0, 
Ëmp
->
n¡©e
+Ëmp->
ÄuË
+5)); 
lš’o
++;

3247 
	`´št_¡ack_uniÚ
(
out
,
Ëmp
,&
lš’o
,
mhæag
);

3248 ifĞ
Ëmp
->
¡acksize
 ){

3249 ifĞ
	`©oi
(
Ëmp
->
¡acksize
)<=0 ){

3250 
	`E¼ÜMsg
(
Ëmp
->
f’ame
,0,

3252 
Ëmp
->
¡acksize
);

3253 
Ëmp
->
”rÜút
++;

3254 
Ëmp
->
¡acksize
 = "100";

3256 
	`årštf
(
out
,"#defšYYSTACKDEPTH %s\n",
Ëmp
->
¡acksize
); 
lš’o
++;

3258 
	`årštf
(
out
,"#defšYYSTACKDEPTH 100\n"); 
lš’o
++;

3260 ifĞ
mhæag
 ){

3261 
	`årštf
(
out
,"#iàINTERFACE\n"); 
lš’o
++;

3263 
Çme
 = 
Ëmp
->name ?†emp->name : "Parse";

3264 ifĞ
Ëmp
->
¬g
 &&†emp->arg[0] ){

3265 
i
 = 
	`¡¾’
(
Ëmp
->
¬g
);

3266  
i
>=1 && 
	`is¥aû
(
Ëmp
->
¬g
[i-1]) ) i--;

3267  
i
>=1 && (
	`i§Êum
(
Ëmp
->
¬g
[i-1]) ||†emp->arg[i-1]=='_') ) i--;

3268 
	`årštf
(
out
,"#defš%sARG_SDECL %s;\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3269 
	`årštf
(
out
,"#defš%sARG_PDECL ,%s\n",
Çme
,
Ëmp
->
¬g
); 
lš’o
++;

3270 
	`årštf
(
out
,"#define %sARG_FETCH %s = yypParser->%s\n",

3271 
Çme
,
Ëmp
->
¬g
,&Ëmp->¬g[
i
]); 
lš’o
++;

3272 
	`årštf
(
out
,"#define %sARG_STORE yypParser->%s = %s\n",

3273 
Çme
,&
Ëmp
->
¬g
[
i
],&Ëmp->¬g[i]); 
lš’o
++;

3275 
	`årštf
(
out
,"#defš%sARG_SDECL\n",
Çme
); 
lš’o
++;

3276 
	`årštf
(
out
,"#defš%sARG_PDECL\n",
Çme
); 
lš’o
++;

3277 
	`årštf
(
out
,"#defš%sARG_FETCH\n",
Çme
); 
lš’o
++;

3278 
	`årštf
(
out
,"#defš%sARG_STORE\n",
Çme
); 
lš’o
++;

3280 ifĞ
mhæag
 ){

3281 
	`årštf
(
out
,"#’dif\n"); 
lš’o
++;

3283 
	`årštf
(
out
,"#defšYYNSTATE %d\n",
Ëmp
->
n¡©e
); 
lš’o
++;

3284 
	`årštf
(
out
,"#defšYYNRULE %d\n",
Ëmp
->
ÄuË
); 
lš’o
++;

3285 
	`årštf
(
out
,"#defšYYERRORSYMBOL %d\n",
Ëmp
->
”rsym
->
šdex
); 
lš’o
++;

3286 
	`årštf
(
out
,"#defšYYERRSYMDT yy%d\n",
Ëmp
->
”rsym
->
dŠum
); 
lš’o
++;

3287 ifĞ
Ëmp
->
has_çÎback
 ){

3288 
	`årštf
(
out
,"#defšYYFALLBACK 1\n"); 
lš’o
++;

3290 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3305 
ax
 = 
	`m®loc
Ğ×x[0])*
Ëmp
->
n¡©e
*2 );

3306 ifĞ
ax
==0 ){

3307 
	`årštf
(
¡d”r
,"malloc failed\n");

3308 
	`ex™
(1);

3310 
i
=0; i<
Ëmp
->
n¡©e
; i++){

3311 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3312 
¡p
->
nTknAù
 = s->
nNtAù
 = 0;

3313 
¡p
->
iDæt
 = 
Ëmp
->
n¡©e
 +†emp->
ÄuË
;

3314 
¡p
->
iTknOf¡
 = 
NO_OFFSET
;

3315 
¡p
->
iNtOf¡
 = 
NO_OFFSET
;

3316 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3317 ifĞ
	`compu‹_aùiÚ
(
Ëmp
,
­
)>=0 ){

3318 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ){

3319 
¡p
->
nTknAù
++;

3320 }ifĞ
­
->
¥
->
šdex
<
Ëmp
->
nsymbŞ
 ){

3321 
¡p
->
nNtAù
++;

3323 
¡p
->
iDæt
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3327 
ax
[
i
*2].
¡p
 = stp;

3328 
ax
[
i
*2].
isTkn
 = 1;

3329 
ax
[
i
*2].
nAùiÚ
 = 
¡p
->
nTknAù
;

3330 
ax
[
i
*2+1].
¡p
 = stp;

3331 
ax
[
i
*2+1].
isTkn
 = 0;

3332 
ax
[
i
*2+1].
nAùiÚ
 = 
¡p
->
nNtAù
;

3334 
mxTknOf¡
 = 
mnTknOf¡
 = 0;

3335 
mxNtOf¡
 = 
mnNtOf¡
 = 0;

3341 
	`qsÜt
(
ax
, 
Ëmp
->
n¡©e
*2, ×x[0]), 
ax£t_com·»
);

3342 
pAùb
 = 
	`aùb_®loc
();

3343 
i
=0; i<
Ëmp
->
n¡©e
*2 && 
ax
[i].
nAùiÚ
>0; i++){

3344 
¡p
 = 
ax
[
i
].stp;

3345 ifĞ
ax
[
i
].
isTkn
 ){

3346 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3347 
aùiÚ
;

3348 ifĞ
­
->
¥
->
šdex
>=
Ëmp
->
Á”mš®
 ) ;

3349 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3350 ifĞ
aùiÚ
<0 ) ;

3351 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3353 
¡p
->
iTknOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3354 ifĞ
¡p
->
iTknOf¡
<
mnTknOf¡
 ) mnTknOfst = stp->iTknOfst;

3355 ifĞ
¡p
->
iTknOf¡
>
mxTknOf¡
 ) mxTknOfst = stp->iTknOfst;

3357 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3358 
aùiÚ
;

3359 ifĞ
­
->
¥
->
šdex
<
Ëmp
->
Á”mš®
 ) ;

3360 ifĞ
­
->
¥
->
šdex
==
Ëmp
->
nsymbŞ
 ) ;

3361 
aùiÚ
 = 
	`compu‹_aùiÚ
(
Ëmp
, 
­
);

3362 ifĞ
aùiÚ
<0 ) ;

3363 
	`aùb_aùiÚ
(
pAùb
, 
­
->
¥
->
šdex
, 
aùiÚ
);

3365 
¡p
->
iNtOf¡
 = 
	`aùb_š£¹
(
pAùb
);

3366 ifĞ
¡p
->
iNtOf¡
<
mnNtOf¡
 ) mnNtOfst = stp->iNtOfst;

3367 ifĞ
¡p
->
iNtOf¡
>
mxNtOf¡
 ) mxNtOfst = stp->iNtOfst;

3370 
	`ä“
(
ax
);

3373 
	`årštf
(
out
,"¡©iøYYACTIONTYPE yy_aùiÚ[] = {\n"); 
lš’o
++;

3374 
n
 = 
	`aùb_size
(
pAùb
);

3375 
i
=
j
=0; i<
n
; i++){

3376 
aùiÚ
 = 
	`aùb_yyaùiÚ
(
pAùb
, 
i
);

3377 ifĞ
aùiÚ
<0 )‡ùiÚ = 
Ëmp
->
nsymbŞ
 +†emp->
ÄuË
 + 2;

3378 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3379 
	`årštf
(
out
, " %4d,", 
aùiÚ
);

3380 ifĞ
j
==9 || 
i
==
n
-1 ){

3381 
	`årštf
(
out
, "\n"); 
lš’o
++;

3382 
j
 = 0;

3384 
j
++;

3387 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3390 
	`årštf
(
out
,"¡©iøYYCODETYPE yy_lookah—d[] = {\n"); 
lš’o
++;

3391 
i
=
j
=0; i<
n
; i++){

3392 
Ï
 = 
	`aùb_yylookah—d
(
pAùb
, 
i
);

3393 ifĞ
Ï
<0 )†¨ğ
Ëmp
->
nsymbŞ
;

3394 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3395 
	`årštf
(
out
, " %4d,", 
Ï
);

3396 ifĞ
j
==9 || 
i
==
n
-1 ){

3397 
	`årštf
(
out
, "\n"); 
lš’o
++;

3398 
j
 = 0;

3400 
j
++;

3403 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3406 
	`årštf
(
out
, "#defšYY_SHIFT_USE_DFLT (%d)\n", 
mnTknOf¡
-1); 
lš’o
++;

3407 
	`årštf
(
out
, "static %s yy_shift_ofst[] = {\n",

3408 
	`mšimum_size_ty³
(
mnTknOf¡
-1, 
mxTknOf¡
)); 
lš’o
++;

3409 
n
 = 
Ëmp
->
n¡©e
;

3410 
i
=
j
=0; i<
n
; i++){

3411 
of¡
;

3412 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3413 
of¡
 = 
¡p
->
iTknOf¡
;

3414 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnTknOf¡
 - 1;

3415 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3416 
	`årštf
(
out
, " %4d,", 
of¡
);

3417 ifĞ
j
==9 || 
i
==
n
-1 ){

3418 
	`årštf
(
out
, "\n"); 
lš’o
++;

3419 
j
 = 0;

3421 
j
++;

3424 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3427 
	`årštf
(
out
, "#defšYY_REDUCE_USE_DFLT (%d)\n", 
mnNtOf¡
-1); 
lš’o
++;

3428 
	`årštf
(
out
, "static %s yy_reduce_ofst[] = {\n",

3429 
	`mšimum_size_ty³
(
mnNtOf¡
-1, 
mxNtOf¡
)); 
lš’o
++;

3430 
n
 = 
Ëmp
->
n¡©e
;

3431 
i
=
j
=0; i<
n
; i++){

3432 
of¡
;

3433 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3434 
of¡
 = 
¡p
->
iNtOf¡
;

3435 ifĞ
of¡
==
NO_OFFSET
 ) of¡ = 
mnNtOf¡
 - 1;

3436 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3437 
	`årštf
(
out
, " %4d,", 
of¡
);

3438 ifĞ
j
==9 || 
i
==
n
-1 ){

3439 
	`årštf
(
out
, "\n"); 
lš’o
++;

3440 
j
 = 0;

3442 
j
++;

3445 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3448 
	`årštf
(
out
, "¡©iøYYACTIONTYPE yy_deçuÉ[] = {\n"); 
lš’o
++;

3449 
n
 = 
Ëmp
->
n¡©e
;

3450 
i
=
j
=0; i<
n
; i++){

3451 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3452 ifĞ
j
==0 ) 
	`årštf
(
out
," /* %5d */ ", 
i
);

3453 
	`årštf
(
out
, " %4d,", 
¡p
->
iDæt
);

3454 ifĞ
j
==9 || 
i
==
n
-1 ){

3455 
	`årštf
(
out
, "\n"); 
lš’o
++;

3456 
j
 = 0;

3458 
j
++;

3461 
	`årštf
(
out
, "};\n"); 
lš’o
++;

3462 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3466 ifĞ
Ëmp
->
has_çÎback
 ){

3467 
i
=0; i<
Ëmp
->
Á”mš®
; i++){

3468 
symbŞ
 *
p
 = 
Ëmp
->
symbŞs
[
i
];

3469 ifĞ
p
->
çÎback
==0 ){

3470 
	`årštf
(
out
, " 0, /* %10 =>‚Ùhšg */\n", 
p
->
Çme
);

3472 
	`årštf
(
out
, " %3d, /* %10 => % */\n", 
p
->
çÎback
->
šdex
,

3473 
p
->
Çme
,…->
çÎback
->name);

3475 
lš’o
++;

3478 
	`É_xãr
(
Ëmp
->
Çme
, 
š
, 
out
, &
lš’o
);

3482 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3483 
	`¥rštf
(
lše
,"\"%s\",",
Ëmp
->
symbŞs
[
i
]->
Çme
);

3484 
	`årštf
(
out
," %-15s",
lše
);

3485 ifĞ(
i
&3)==3 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3487 ifĞ(
i
&3)!=0 ){ 
	`årštf
(
out
,"\n"); 
lš’o
++; }

3488 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3494 
i
=0, 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
, i++){

3495 
	`as£¹
Ğ
½
->
šdex
==
i
 );

3496 
	`årštf
(
out
," /* %3d */ \"% ::=", 
i
, 
½
->
lhs
->
Çme
);

3497 
j
=0; j<
½
->
Ähs
; j++è
	`årštf
(
out
," %s",½->
rhs
[j]->
Çme
);

3498 
	`årštf
(
out
,"\",\n"); 
lš’o
++;

3500 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3506 ifĞ
Ëmp
->
tok’de¡
 ){

3507 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3508 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3509 ifĞ
¥
==0 || sp->
ty³
!=
TERMINAL
 ) ;

3510 
	`årštf
(
out
," ca£ %d:\n",
¥
->
šdex
); 
lš’o
++;

3512 
i
=0; i<
Ëmp
->
nsymbŞ
 &&†emp->
symbŞs
[i]->
ty³
!=
TERMINAL
; i++);

3513 ifĞ
i
<
Ëmp
->
nsymbŞ
 ){

3514 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3515 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3518 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3519 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3520 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 || sp->
de¡ruùÜ
==0 ) ;

3521 
	`årštf
(
out
," ca£ %d:\n",
¥
->
šdex
); 
lš’o
++;

3522 
	`em™_de¡ruùÜ_code
(
out
,
Ëmp
->
symbŞs
[
i
],Ëmp,&
lš’o
);

3523 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3525 ifĞ
Ëmp
->
v¬de¡
 ){

3526 
symbŞ
 *
dæt_¥
 = 0;

3527 
i
=0; i<
Ëmp
->
nsymbŞ
; i++){

3528 
symbŞ
 *
¥
 = 
Ëmp
->
symbŞs
[
i
];

3529 ifĞ
¥
==0 || sp->
ty³
==
TERMINAL
 ||

3530 
¥
->
šdex
<=0 || sp->
de¡ruùÜ
!=0 ) ;

3531 
	`årštf
(
out
," ca£ %d:\n",
¥
->
šdex
); 
lš’o
++;

3532 
dæt_¥
 = 
¥
;

3534 ifĞ
dæt_¥
!=0 ){

3535 
	`em™_de¡ruùÜ_code
(
out
,
dæt_¥
,
Ëmp
,&
lš’o
);

3536 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3539 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3542 
	`É_´št
(
out
,
Ëmp
,Ëmp->
ov”æow
,Ëmp->
ov”æowÊ
,&
lš’o
);

3543 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3550 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3551 
	`årštf
(
out
," { %d, %d },\n",
½
->
lhs
->
šdex
,½->
Ähs
); 
lš’o
++;

3553 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3556 
½
=
Ëmp
->
ruË
;„p;„pôp->
Ãxt
){

3557 
	`årštf
(
out
," ca£ %d:\n",
½
->
šdex
); 
lš’o
++;

3558 
	`em™_code
(
out
,
½
,
Ëmp
,&
lš’o
);

3559 
	`årštf
(
out
," b»ak;\n"); 
lš’o
++;

3561 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3564 
	`É_´št
(
out
,
Ëmp
,Ëmp->
çu»
,Ëmp->
çu»Ê
,&
lš’o
);

3565 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3568 
	`É_´št
(
out
,
Ëmp
,Ëmp->
”rÜ
,Ëmp->
”rÜÊ
,&
lš’o
);

3569 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3572 
	`É_´št
(
out
,
Ëmp
,Ëmp->
acû±
,Ëmp->
acû±Ê
,&
lš’o
);

3573 
	`É_xãr
(
Ëmp
->
Çme
,
š
,
out
,&
lš’o
);

3576 
	`É_´št
(
out
,
Ëmp
,Ëmp->
exŒacode
,Ëmp->
exŒacod–n
,&
lš’o
);

3578 
	`fşo£
(
š
);

3579 
	`fşo£
(
out
);

3581 
	}
}

3584 
	$R•ÜtH—d”
(
Ëmp
)

3585 
ËmÚ
 *
Ëmp
;

3587 
FILE
 *
out
, *
š
;

3588 *
´efix
;

3589 
lše
[
LINESIZE
];

3590 
·‰”n
[
LINESIZE
];

3591 
i
;

3593 ifĞ
Ëmp
->
tok’´efix
 ) 
´efix
 =†emp->tokenprefix;

3594 
´efix
 = "";

3595 
š
 = 
	`fe_İ’
(
Ëmp
,".h","r");

3596 ifĞ
š
 ){

3597 
i
=1; i<
Ëmp
->
Á”mš®
 && 
	`fg‘s
(
lše
,
LINESIZE
,
š
); i++){

3598 
	`¥rštf
(
·‰”n
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

3599 ifĞ
	`¡rcmp
(
lše
,
·‰”n
) ) ;

3601 
	`fşo£
(
š
);

3602 ifĞ
i
==
Ëmp
->
Á”mš®
 ){

3607 
out
 = 
	`fe_İ’
(
Ëmp
,".h","w");

3608 ifĞ
out
 ){

3609 
i
=1; i<
Ëmp
->
Á”mš®
; i++){

3610 
	`årštf
(
out
,"#defš%s%-30 %2d\n",
´efix
,
Ëmp
->
symbŞs
[
i
]->
Çme
,i);

3612 
	`fşo£
(
out
);

3615 
	}
}

3623 
	$Com´essTabËs
(
Ëmp
)

3624 
ËmÚ
 *
Ëmp
;

3626 
¡©e
 *
¡p
;

3627 
aùiÚ
 *
­
, *
­2
;

3628 
ruË
 *
½
, *
½2
, *
rbe¡
;

3629 
nbe¡
, 
n
;

3630 
i
;

3632 
i
=0; i<
Ëmp
->
n¡©e
; i++){

3633 
¡p
 = 
Ëmp
->
sÜ‹d
[
i
];

3634 
nbe¡
 = 0;

3635 
rbe¡
 = 0;

3637 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3638 ifĞ
­
->
ty³
!=
REDUCE
 ) ;

3639 
½
 = 
­
->
x
.rp;

3640 ifĞ
½
==
rbe¡
 ) ;

3641 
n
 = 1;

3642 
­2
=
­
->
Ãxt
;‡p2;‡p2=ap2->next){

3643 ifĞ
­2
->
ty³
!=
REDUCE
 ) ;

3644 
½2
 = 
­2
->
x
.
½
;

3645 ifĞ
½2
==
rbe¡
 ) ;

3646 ifĞ
½2
==
½
 ) 
n
++;

3648 ifĞ
n
>
nbe¡
 ){

3649 
nbe¡
 = 
n
;

3650 
rbe¡
 = 
½
;

3656 ifĞ
nbe¡
<2 ) ;

3660 
­
=
¡p
->­;‡p;‡p÷p->
Ãxt
){

3661 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 ) ;

3663 
	`as£¹
Ğ
­
 );

3664 
­
->
¥
 = 
	`SymbŞ_Ãw
("{default}");

3665 
­
÷p->
Ãxt
;‡p;‡p=ap->next){

3666 ifĞ
­
->
ty³
==
REDUCE
 &&‡p->
x
.
½
==
rbe¡
 )‡p->ty³ = 
NOT_USED
;

3668 
¡p
->
­
 = 
	`AùiÚ_sÜt
(stp->ap);

3670 
	}
}

3677 
	gglob®_size
 = 0;

3680 
	$S‘Size
(
n
)

3681 
n
;

3683 
glob®_size
 = 
n
+1;

3684 
	}
}

3687 *
	$S‘New
(){

3688 *
s
;

3689 
i
;

3690 
s
 = (*)
	`m®loc
Ğ
glob®_size
 );

3691 ifĞ
s
==0 ){

3692 
	`memÜy_”rÜ
();

3694 
i
=0; i<
glob®_size
; i++è
s
[i] = 0;

3695  
s
;

3696 
	}
}

3699 
	$S‘F»e
(
s
)

3700 *
s
;

3702 
	`ä“
(
s
);

3703 
	}
}

3707 
	$S‘Add
(
s
,
e
)

3708 *
s
;

3709 
e
;

3711 
rv
;

3712 
rv
 = 
s
[
e
];

3713 
s
[
e
] = 1;

3714  !
rv
;

3715 
	}
}

3718 
	$S‘UniÚ
(
s1
,
s2
)

3719 *
s1
;

3720 *
s2
;

3722 
i
, 
´og»ss
;

3723 
´og»ss
 = 0;

3724 
i
=0; i<
glob®_size
; i++){

3725 ifĞ
s2
[
i
]==0 ) ;

3726 ifĞ
s1
[
i
]==0 ){

3727 
´og»ss
 = 1;

3728 
s1
[
i
] = 1;

3731  
´og»ss
;

3732 
	}
}

3746 
PRIVATE
 
	$¡rhash
(
x
)

3747 *
x
;

3749 
h
 = 0;

3750  *
x
è
h
 = h*13u + () *(x++);

3751  
h
;

3752 
	}
}

3758 *
	$SŒ§ã
(
y
)

3759 *
y
;

3761 *
z
;

3763 
z
 = 
	`SŒ§ã_fšd
(
y
);

3764 ifĞ
z
==0 && (z=
	`m®loc
Ğ
	`¡¾’
(
y
)+1 ))!=0 ){

3765 
	`¡rıy
(
z
,
y
);

3766 
	`SŒ§ã_š£¹
(
z
);

3768 
	`MemÜyCheck
(
z
);

3769  
z
;

3770 
	}
}

3775 
	ss_x1
 {

3776 
	msize
;

3779 
	mcouÁ
;

3780 
s_x1node
 *
	mtbl
;

3781 
s_x1node
 **
	mht
;

3787 
	ss_x1node
 {

3788 *
	md©a
;

3789 
s_x1node
 *
	mÃxt
;

3790 
s_x1node
 **
	mäom
;

3791 } 
	tx1node
;

3794 
s_x1
 *
	gx1a
;

3797 
	$SŒ§ã_š™
(){

3798 ifĞ
x1a
 ) ;

3799 
x1a
 = (
s_x1
*)
	`m®loc
( (s_x1) );

3800 ifĞ
x1a
 ){

3801 
x1a
->
size
 = 1024;

3802 
x1a
->
couÁ
 = 0;

3803 
x1a
->
tbl
 = (
x1node
*)
	`m®loc
(

3804 ((
x1node
) + (x1node*))*1024 );

3805 ifĞ
x1a
->
tbl
==0 ){

3806 
	`ä“
(
x1a
);

3807 
x1a
 = 0;

3809 
i
;

3810 
x1a
->
ht
 = (
x1node
**)&(x1a->
tbl
[1024]);

3811 
i
=0; i<1024; i++è
x1a
->
ht
[i] = 0;

3814 
	}
}

3817 
	$SŒ§ã_š£¹
(
d©a
)

3818 *
d©a
;

3820 
x1node
 *
Å
;

3821 
h
;

3822 
ph
;

3824 ifĞ
x1a
==0 )  0;

3825 
ph
 = 
	`¡rhash
(
d©a
);

3826 
h
 = 
ph
 & (
x1a
->
size
-1);

3827 
Å
 = 
x1a
->
ht
[
h
];

3828  
Å
 ){

3829 ifĞ
	`¡rcmp
(
Å
->
d©a
,data)==0 ){

3834 
Å
 =‚p->
Ãxt
;

3836 ifĞ
x1a
->
couÁ
>=x1a->
size
 ){

3838 
i
,
size
;

3839 
s_x1
 
¬¿y
;

3840 
¬¿y
.
size
 = sizğ
x1a
->size*2;

3841 
¬¿y
.
couÁ
 = 
x1a
->count;

3842 
¬¿y
.
tbl
 = (
x1node
*)
	`m®loc
(

3843 ((
x1node
è+ (x1node*))*
size
 );

3844 ifĞ
¬¿y
.
tbl
==0 )  0;

3845 
¬¿y
.
ht
 = (
x1node
**)&×¼ay.
tbl
[
size
]);

3846 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

3847 
i
=0; i<
x1a
->
couÁ
; i++){

3848 
x1node
 *
ŞdÅ
, *
ÃwÅ
;

3849 
ŞdÅ
 = &(
x1a
->
tbl
[
i
]);

3850 
h
 = 
	`¡rhash
(
ŞdÅ
->
d©a
è& (
size
-1);

3851 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

3852 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

3853 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

3854 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

3855 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

3856 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

3858 
	`ä“
(
x1a
->
tbl
);

3860 
	`memıy
(
x1a
, &
¬¿y
, (array));

3863 
h
 = 
ph
 & (
x1a
->
size
-1);

3864 
Å
 = &(
x1a
->
tbl
[x1a->
couÁ
++]);

3865 
Å
->
d©a
 = data;

3866 ifĞ
x1a
->
ht
[
h
] ) x1a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

3867 
Å
->
Ãxt
 = 
x1a
->
ht
[
h
];

3868 
x1a
->
ht
[
h
] = 
Å
;

3869 
Å
->
äom
 = &(
x1a
->
ht
[
h
]);

3871 
	}
}

3875 *
	$SŒ§ã_fšd
(
key
)

3876 *
key
;

3878 
h
;

3879 
x1node
 *
Å
;

3881 ifĞ
x1a
==0 )  0;

3882 
h
 = 
	`¡rhash
(
key
è& (
x1a
->
size
-1);

3883 
Å
 = 
x1a
->
ht
[
h
];

3884  
Å
 ){

3885 ifĞ
	`¡rcmp
(
Å
->
d©a
,
key
)==0 ) ;

3886 
Å
 =‚p->
Ãxt
;

3888  
Å
 ?‚p->
d©a
 : 0;

3889 
	}
}

3894 
symbŞ
 *
	$SymbŞ_Ãw
(
x
)

3895 *
x
;

3897 
symbŞ
 *
¥
;

3899 
¥
 = 
	`SymbŞ_fšd
(
x
);

3900 ifĞ
¥
==0 ){

3901 
¥
 = (
symbŞ
 *)
	`m®loc
( (symbol) );

3902 
	`MemÜyCheck
(
¥
);

3903 
¥
->
Çme
 = 
	`SŒ§ã
(
x
);

3904 
¥
->
ty³
 = 
	`isuµ”
(*
x
è? 
TERMINAL
 : 
NONTERMINAL
;

3905 
¥
->
ruË
 = 0;

3906 
¥
->
çÎback
 = 0;

3907 
¥
->
´ec
 = -1;

3908 
¥
->
assoc
 = 
UNK
;

3909 
¥
->
fœ¡£t
 = 0;

3910 
¥
->
Ïmbda
 = 
Bo_FALSE
;

3911 
¥
->
de¡ruùÜ
 = 0;

3912 
¥
->
d©©y³
 = 0;

3913 
	`SymbŞ_š£¹
(
¥
,¥->
Çme
);

3915  
¥
;

3916 
	}
}

3928 
	$SymbŞcmµ
(
symbŞ
 **
a
, symbŞ **
b
){

3929 
i1
 = (**
a
).
šdex
 + 10000000*((**a).
Çme
[0]>'Z');

3930 
i2
 = (**
b
).
šdex
 + 10000000*((**b).
Çme
[0]>'Z');

3931  
i1
-
i2
;

3932 
	}
}

3937 
	ss_x2
 {

3938 
	msize
;

3941 
	mcouÁ
;

3942 
s_x2node
 *
	mtbl
;

3943 
s_x2node
 **
	mht
;

3949 
	ss_x2node
 {

3950 
symbŞ
 *
	md©a
;

3951 *
	mkey
;

3952 
s_x2node
 *
	mÃxt
;

3953 
s_x2node
 **
	mäom
;

3954 } 
	tx2node
;

3957 
s_x2
 *
	gx2a
;

3960 
	$SymbŞ_š™
(){

3961 ifĞ
x2a
 ) ;

3962 
x2a
 = (
s_x2
*)
	`m®loc
( (s_x2) );

3963 ifĞ
x2a
 ){

3964 
x2a
->
size
 = 128;

3965 
x2a
->
couÁ
 = 0;

3966 
x2a
->
tbl
 = (
x2node
*)
	`m®loc
(

3967 ((
x2node
) + (x2node*))*128 );

3968 ifĞ
x2a
->
tbl
==0 ){

3969 
	`ä“
(
x2a
);

3970 
x2a
 = 0;

3972 
i
;

3973 
x2a
->
ht
 = (
x2node
**)&(x2a->
tbl
[128]);

3974 
i
=0; i<128; i++è
x2a
->
ht
[i] = 0;

3977 
	}
}

3980 
	$SymbŞ_š£¹
(
d©a
,
key
)

3981 
symbŞ
 *
d©a
;

3982 *
key
;

3984 
x2node
 *
Å
;

3985 
h
;

3986 
ph
;

3988 ifĞ
x2a
==0 )  0;

3989 
ph
 = 
	`¡rhash
(
key
);

3990 
h
 = 
ph
 & (
x2a
->
size
-1);

3991 
Å
 = 
x2a
->
ht
[
h
];

3992  
Å
 ){

3993 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ){

3998 
Å
 =‚p->
Ãxt
;

4000 ifĞ
x2a
->
couÁ
>=x2a->
size
 ){

4002 
i
,
size
;

4003 
s_x2
 
¬¿y
;

4004 
¬¿y
.
size
 = sizğ
x2a
->size*2;

4005 
¬¿y
.
couÁ
 = 
x2a
->count;

4006 
¬¿y
.
tbl
 = (
x2node
*)
	`m®loc
(

4007 ((
x2node
è+ (x2node*))*
size
 );

4008 ifĞ
¬¿y
.
tbl
==0 )  0;

4009 
¬¿y
.
ht
 = (
x2node
**)&×¼ay.
tbl
[
size
]);

4010 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4011 
i
=0; i<
x2a
->
couÁ
; i++){

4012 
x2node
 *
ŞdÅ
, *
ÃwÅ
;

4013 
ŞdÅ
 = &(
x2a
->
tbl
[
i
]);

4014 
h
 = 
	`¡rhash
(
ŞdÅ
->
key
è& (
size
-1);

4015 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4016 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4017 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4018 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4019 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4020 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4021 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4023 
	`ä“
(
x2a
->
tbl
);

4025 
	`memıy
(
x2a
, &
¬¿y
, (array));

4028 
h
 = 
ph
 & (
x2a
->
size
-1);

4029 
Å
 = &(
x2a
->
tbl
[x2a->
couÁ
++]);

4030 
Å
->
key
 = key;

4031 
Å
->
d©a
 = data;

4032 ifĞ
x2a
->
ht
[
h
] ) x2a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4033 
Å
->
Ãxt
 = 
x2a
->
ht
[
h
];

4034 
x2a
->
ht
[
h
] = 
Å
;

4035 
Å
->
äom
 = &(
x2a
->
ht
[
h
]);

4037 
	}
}

4041 
symbŞ
 *
	$SymbŞ_fšd
(
key
)

4042 *
key
;

4044 
h
;

4045 
x2node
 *
Å
;

4047 ifĞ
x2a
==0 )  0;

4048 
h
 = 
	`¡rhash
(
key
è& (
x2a
->
size
-1);

4049 
Å
 = 
x2a
->
ht
[
h
];

4050  
Å
 ){

4051 ifĞ
	`¡rcmp
(
Å
->
key
,key)==0 ) ;

4052 
Å
 =‚p->
Ãxt
;

4054  
Å
 ?‚p->
d©a
 : 0;

4055 
	}
}

4058 
symbŞ
 *
	$SymbŞ_Nth
(
n
)

4059 
n
;

4061 
symbŞ
 *
d©a
;

4062 ifĞ
x2a
 && 
n
>0 &&‚<=x2a->
couÁ
 ){

4063 
d©a
 = 
x2a
->
tbl
[
n
-1].data;

4065 
d©a
 = 0;

4067  
d©a
;

4068 
	}
}

4071 
	$SymbŞ_couÁ
()

4073  
x2a
 ? x2a->
couÁ
 : 0;

4074 
	}
}

4079 
symbŞ
 **
	$SymbŞ_¬¿yof
()

4081 
symbŞ
 **
¬¿y
;

4082 
i
,
size
;

4083 ifĞ
x2a
==0 )  0;

4084 
size
 = 
x2a
->
couÁ
;

4085 
¬¿y
 = (
symbŞ
 **)
	`m®loc
Ğ(symbŞ *)*
size
 );

4086 ifĞ
¬¿y
 ){

4087 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x2a
->
tbl
[i].
d©a
;

4089  
¬¿y
;

4090 
	}
}

4093 
	$CÚfigcmp
(
a
,
b
)

4094 
cÚfig
 *
a
;

4095 
cÚfig
 *
b
;

4097 
x
;

4098 
x
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4099 ifĞ
x
==0 ) x = 
a
->
dÙ
 - 
b
->dot;

4100  
x
;

4101 
	}
}

4104 
PRIVATE
 
	$¡©ecmp
(
a
,
b
)

4105 
cÚfig
 *
a
;

4106 
cÚfig
 *
b
;

4108 
rc
;

4109 
rc
=0;„c==0 && 
a
 && 
b
;‡÷->
bp
, b=b->bp){

4110 
rc
 = 
a
->
½
->
šdex
 - 
b
->rp->index;

4111 ifĞ
rc
==0 )„øğ
a
->
dÙ
 - 
b
->dot;

4113 ifĞ
rc
==0 ){

4114 ifĞ
a
 ) 
rc
 = 1;

4115 ifĞ
b
 ) 
rc
 = -1;

4117  
rc
;

4118 
	}
}

4121 
PRIVATE
 
	$¡©ehash
(
a
)

4122 
cÚfig
 *
a
;

4124 
h
=0;

4125  
a
 ){

4126 
h
 = h*571u + ()
a
->
½
->
šdex
*37u + (ï->
dÙ
;

4127 
a
 =‡->
bp
;

4129  
h
;

4130 
	}
}

4133 
¡©e
 *
	$S‹_Ãw
()

4135 
¡©e
 *
Ãw
;

4136 
Ãw
 = (
¡©e
 *)
	`m®loc
( (state) );

4137 
	`MemÜyCheck
(
Ãw
);

4138  
Ãw
;

4139 
	}
}

4144 
	ss_x3
 {

4145 
	msize
;

4148 
	mcouÁ
;

4149 
s_x3node
 *
	mtbl
;

4150 
s_x3node
 **
	mht
;

4156 
	ss_x3node
 {

4157 
¡©e
 *
	md©a
;

4158 
cÚfig
 *
	mkey
;

4159 
s_x3node
 *
	mÃxt
;

4160 
s_x3node
 **
	mäom
;

4161 } 
	tx3node
;

4164 
s_x3
 *
	gx3a
;

4167 
	$S‹_š™
(){

4168 ifĞ
x3a
 ) ;

4169 
x3a
 = (
s_x3
*)
	`m®loc
( (s_x3) );

4170 ifĞ
x3a
 ){

4171 
x3a
->
size
 = 128;

4172 
x3a
->
couÁ
 = 0;

4173 
x3a
->
tbl
 = (
x3node
*)
	`m®loc
(

4174 ((
x3node
) + (x3node*))*128 );

4175 ifĞ
x3a
->
tbl
==0 ){

4176 
	`ä“
(
x3a
);

4177 
x3a
 = 0;

4179 
i
;

4180 
x3a
->
ht
 = (
x3node
**)&(x3a->
tbl
[128]);

4181 
i
=0; i<128; i++è
x3a
->
ht
[i] = 0;

4184 
	}
}

4187 
	$S‹_š£¹
(
d©a
,
key
)

4188 
¡©e
 *
d©a
;

4189 
cÚfig
 *
key
;

4191 
x3node
 *
Å
;

4192 
h
;

4193 
ph
;

4195 ifĞ
x3a
==0 )  0;

4196 
ph
 = 
	`¡©ehash
(
key
);

4197 
h
 = 
ph
 & (
x3a
->
size
-1);

4198 
Å
 = 
x3a
->
ht
[
h
];

4199  
Å
 ){

4200 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ){

4205 
Å
 =‚p->
Ãxt
;

4207 ifĞ
x3a
->
couÁ
>=x3a->
size
 ){

4209 
i
,
size
;

4210 
s_x3
 
¬¿y
;

4211 
¬¿y
.
size
 = sizğ
x3a
->size*2;

4212 
¬¿y
.
couÁ
 = 
x3a
->count;

4213 
¬¿y
.
tbl
 = (
x3node
*)
	`m®loc
(

4214 ((
x3node
è+ (x3node*))*
size
 );

4215 ifĞ
¬¿y
.
tbl
==0 )  0;

4216 
¬¿y
.
ht
 = (
x3node
**)&×¼ay.
tbl
[
size
]);

4217 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4218 
i
=0; i<
x3a
->
couÁ
; i++){

4219 
x3node
 *
ŞdÅ
, *
ÃwÅ
;

4220 
ŞdÅ
 = &(
x3a
->
tbl
[
i
]);

4221 
h
 = 
	`¡©ehash
(
ŞdÅ
->
key
è& (
size
-1);

4222 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4223 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4224 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4225 
ÃwÅ
->
key
 = 
ŞdÅ
->key;

4226 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4227 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4228 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4230 
	`ä“
(
x3a
->
tbl
);

4232 
	`memıy
(
x3a
, &
¬¿y
, (array));

4235 
h
 = 
ph
 & (
x3a
->
size
-1);

4236 
Å
 = &(
x3a
->
tbl
[x3a->
couÁ
++]);

4237 
Å
->
key
 = key;

4238 
Å
->
d©a
 = data;

4239 ifĞ
x3a
->
ht
[
h
] ) x3a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4240 
Å
->
Ãxt
 = 
x3a
->
ht
[
h
];

4241 
x3a
->
ht
[
h
] = 
Å
;

4242 
Å
->
äom
 = &(
x3a
->
ht
[
h
]);

4244 
	}
}

4248 
¡©e
 *
	$S‹_fšd
(
key
)

4249 
cÚfig
 *
key
;

4251 
h
;

4252 
x3node
 *
Å
;

4254 ifĞ
x3a
==0 )  0;

4255 
h
 = 
	`¡©ehash
(
key
è& (
x3a
->
size
-1);

4256 
Å
 = 
x3a
->
ht
[
h
];

4257  
Å
 ){

4258 ifĞ
	`¡©ecmp
(
Å
->
key
,key)==0 ) ;

4259 
Å
 =‚p->
Ãxt
;

4261  
Å
 ?‚p->
d©a
 : 0;

4262 
	}
}

4265 
	$S‹_couÁ
()

4267  
x3a
 ? x3a->
couÁ
 : 0;

4268 
	}
}

4273 
¡©e
 **
	$S‹_¬¿yof
()

4275 
¡©e
 **
¬¿y
;

4276 
i
,
size
;

4277 ifĞ
x3a
==0 )  0;

4278 
size
 = 
x3a
->
couÁ
;

4279 
¬¿y
 = (
¡©e
 **)
	`m®loc
Ğ(¡©*)*
size
 );

4280 ifĞ
¬¿y
 ){

4281 
i
=0; i<
size
; i++è
¬¿y
[i] = 
x3a
->
tbl
[i].
d©a
;

4283  
¬¿y
;

4284 
	}
}

4287 
PRIVATE
 
	$cÚfighash
(
a
)

4288 
cÚfig
 *
a
;

4290 
h
=0;

4291 
h
 = h*571 + 
a
->
½
->
šdex
*37 +‡->
dÙ
;

4292  
h
;

4293 
	}
}

4298 
	ss_x4
 {

4299 
	msize
;

4302 
	mcouÁ
;

4303 
s_x4node
 *
	mtbl
;

4304 
s_x4node
 **
	mht
;

4310 
	ss_x4node
 {

4311 
cÚfig
 *
	md©a
;

4312 
s_x4node
 *
	mÃxt
;

4313 
s_x4node
 **
	mäom
;

4314 } 
	tx4node
;

4317 
s_x4
 *
	gx4a
;

4320 
	$CÚfigbË_š™
(){

4321 ifĞ
x4a
 ) ;

4322 
x4a
 = (
s_x4
*)
	`m®loc
( (s_x4) );

4323 ifĞ
x4a
 ){

4324 
x4a
->
size
 = 64;

4325 
x4a
->
couÁ
 = 0;

4326 
x4a
->
tbl
 = (
x4node
*)
	`m®loc
(

4327 ((
x4node
) + (x4node*))*64 );

4328 ifĞ
x4a
->
tbl
==0 ){

4329 
	`ä“
(
x4a
);

4330 
x4a
 = 0;

4332 
i
;

4333 
x4a
->
ht
 = (
x4node
**)&(x4a->
tbl
[64]);

4334 
i
=0; i<64; i++è
x4a
->
ht
[i] = 0;

4337 
	}
}

4340 
	$CÚfigbË_š£¹
(
d©a
)

4341 
cÚfig
 *
d©a
;

4343 
x4node
 *
Å
;

4344 
h
;

4345 
ph
;

4347 ifĞ
x4a
==0 )  0;

4348 
ph
 = 
	`cÚfighash
(
d©a
);

4349 
h
 = 
ph
 & (
x4a
->
size
-1);

4350 
Å
 = 
x4a
->
ht
[
h
];

4351  
Å
 ){

4352 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,data)==0 ){

4357 
Å
 =‚p->
Ãxt
;

4359 ifĞ
x4a
->
couÁ
>=x4a->
size
 ){

4361 
i
,
size
;

4362 
s_x4
 
¬¿y
;

4363 
¬¿y
.
size
 = sizğ
x4a
->size*2;

4364 
¬¿y
.
couÁ
 = 
x4a
->count;

4365 
¬¿y
.
tbl
 = (
x4node
*)
	`m®loc
(

4366 ((
x4node
è+ (x4node*))*
size
 );

4367 ifĞ
¬¿y
.
tbl
==0 )  0;

4368 
¬¿y
.
ht
 = (
x4node
**)&×¼ay.
tbl
[
size
]);

4369 
i
=0; i<
size
; i++è
¬¿y
.
ht
[i] = 0;

4370 
i
=0; i<
x4a
->
couÁ
; i++){

4371 
x4node
 *
ŞdÅ
, *
ÃwÅ
;

4372 
ŞdÅ
 = &(
x4a
->
tbl
[
i
]);

4373 
h
 = 
	`cÚfighash
(
ŞdÅ
->
d©a
è& (
size
-1);

4374 
ÃwÅ
 = &(
¬¿y
.
tbl
[
i
]);

4375 ifĞ
¬¿y
.
ht
[
h
] )‡¼ay.ht[h]->
äom
 = &(
ÃwÅ
->
Ãxt
);

4376 
ÃwÅ
->
Ãxt
 = 
¬¿y
.
ht
[
h
];

4377 
ÃwÅ
->
d©a
 = 
ŞdÅ
->data;

4378 
ÃwÅ
->
äom
 = &(
¬¿y
.
ht
[
h
]);

4379 
¬¿y
.
ht
[
h
] = 
ÃwÅ
;

4381 
	`ä“
(
x4a
->
tbl
);

4383 
	`memıy
(
x4a
, &
¬¿y
, (array));

4386 
h
 = 
ph
 & (
x4a
->
size
-1);

4387 
Å
 = &(
x4a
->
tbl
[x4a->
couÁ
++]);

4388 
Å
->
d©a
 = data;

4389 ifĞ
x4a
->
ht
[
h
] ) x4a->ht[h]->
äom
 = &(
Å
->
Ãxt
);

4390 
Å
->
Ãxt
 = 
x4a
->
ht
[
h
];

4391 
x4a
->
ht
[
h
] = 
Å
;

4392 
Å
->
äom
 = &(
x4a
->
ht
[
h
]);

4394 
	}
}

4398 
cÚfig
 *
	$CÚfigbË_fšd
(
key
)

4399 
cÚfig
 *
key
;

4401 
h
;

4402 
x4node
 *
Å
;

4404 ifĞ
x4a
==0 )  0;

4405 
h
 = 
	`cÚfighash
(
key
è& (
x4a
->
size
-1);

4406 
Å
 = 
x4a
->
ht
[
h
];

4407  
Å
 ){

4408 ifĞ
	`CÚfigcmp
(
Å
->
d©a
,
key
)==0 ) ;

4409 
Å
 =‚p->
Ãxt
;

4411  
Å
 ?‚p->
d©a
 : 0;

4412 
	}
}

4416 
	$CÚfigbË_ş—r
(
f
)

4417 (*
f
)( );

4419 
i
;

4420 ifĞ
x4a
==0 || x4a->
couÁ
==0 ) ;

4421 ifĞ
f
 ) 
i
=0; i<
x4a
->
couÁ
; i++è(*f)(x4a->
tbl
[i].
d©a
);

4422 
i
=0; i<
x4a
->
size
; i++èx4a->
ht
[i] = 0;

4423 
x4a
->
couÁ
 = 0;

4425 
	}
}

	@lempar.c

6 
	~"fœ¡.h
"

7 
	~<¡dio.h
>

8 %% /* 
	$yy·r£
 */ 
	`yyËx
()

19 
	}
%%

22 #iâdeà
INTERFACE


23 
	#INTERFACE
 1

	)

58 %% /* 
	$yy·r£
 */ 
	`yyËx
()

59 #
defše
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

60 #
defše
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

61 #
defše
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

110 
	}
%%

111 
	#YY_SZ_ACTTAB
 ((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

123 #ifdeà
YYFALLBACK


124 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

125 %% /* 
	$yy·r£
 */ 
	`yyËx
()

127 #
’dif


141 
	syySckEÁry
 {

142 
	m¡©’o
;

143 
	mmajÜ
;

145 
YYMINORTYPE
 
	mmšÜ
;

148 
yySckEÁry
 
	tyySckEÁry
;

152 
	syyP¬£r
 {

153 
	myyidx
;

154 
	myy”rút
;

155 
P¬£ARG_SDECL


156 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

158 
yyP¬£r
 
	tyyP¬£r
;

160 #
iâdef
 
NDEBUG


161 #
šşude
 <
¡dio
.
h
>

162 
FILE
 *
	gyyT¿ûFILE
 = 
NULL
;

163 *
	gyyT¿ûProm±
 = 
NULL
;

164 #
’dif


166 #
iâdef
 
NDEBUG


185 
	`P¬£T¿û
(
FILE
 *
	gT¿ûFILE
, *
	gzT¿ûProm±
){

186 
	gyyT¿ûFILE
 = 
T¿ûFILE
;

187 
	gyyT¿ûProm±
 = 
zT¿ûProm±
;

188 ifĞ
	gyyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

189 ifĞ
	gyyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

191 #
’dif


192 #
’dif


194 #
iâdef
 
NDEBUG


197 cÚ¡ *
	gyyTok’Name
[] = {

198 
	}
%%

202 #iâdeà
NDEBUG


205 cÚ¡ *
	gyyRuËName
[] = {

206 %% /* 
	$yy·r£
 */ 
	`yyËx
()

208 #
’dif


215 cÚ¡ *
	`P¬£Tok’Name
(
	gtok’Ty³
){

216 #
iâdef
 
NDEBUG


217 ifĞ
	gtok’Ty³
>0 && (
	gsize_t
éok’Ty³<((
	gyyTok’Name
)/(yyTokenName[0])) ){

218  
	gyyTok’Name
[
tok’Ty³
];

224 #
’dif


226 #
’dif


240 *
	`P¬£AÎoc
(*(*
	gm®locProc
)(
	gsize_t
)){

241 
yyP¬£r
 *
	gpP¬£r
;

242 
	gpP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

243 ifĞ
	gpP¬£r
 ){

244 
	gpP¬£r
->
	gyyidx
 = -1;

246  
	gpP¬£r
;

254 
	`yy_de¡ruùÜ
(
YYCODETYPE
 
	gyymajÜ
, 
YYMINORTYPE
 *
	gyypmšÜ
){

255  
	gyymajÜ
 ){

266 
	}
%%

279 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

280 
YYCODETYPE
 
yymajÜ
;

281 
yySckEÁry
 *
yytos
;

283 ifĞ
pP¬£r
->
yyidx
<0 )  0;

284 
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

285 #iâdeà
NDEBUG


286 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

287 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

288 
yyT¿ûProm±
,

289 
yyTok’Name
[
yytos
->
majÜ
]);

292 
yymajÜ
 = 
yytos
->
majÜ
;

293 
	`yy_de¡ruùÜ
Ğ
yymajÜ
, &
yytos
->
mšÜ
);

294 
pP¬£r
->
yyidx
--;

295  
yymajÜ
;

296 
	}
}

310 
	$P¬£F»e
(

311 *
p
,

312 (*
ä“Proc
)(*)

314 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

315 ifĞ
pP¬£r
==
NULL
 ) ;

316  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

317 (*
ä“Proc
)((*)
pP¬£r
);

318 
	}
}

328 
	$yy_fšd_shiá_aùiÚ
(

329 
yyP¬£r
 *
pP¬£r
,

330 
iLookAh—d


332 
i
;

333 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

336 
i
 = 
yy_shiá_of¡
[
¡©’o
];

337 ifĞ
i
==
YY_SHIFT_USE_DFLT
 ){

338  
yy_deçuÉ
[
¡©’o
];

340 ifĞ
iLookAh—d
==
YYNOCODE
 ){

341  
YY_NO_ACTION
;

343 
i
 +ğ
iLookAh—d
;

344 ifĞ
i
<0 || (
size_t
)i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

345 #ifdeà
YYFALLBACK


346 
iF®lback
;

347 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

348 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

349 #iâdeà
NDEBUG


350 ifĞ
yyT¿ûFILE
 ){

351 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

352 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

355  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

358  
yy_deçuÉ
[
¡©’o
];

360  
yy_aùiÚ
[
i
];

362 
	}
}

372 
	$yy_fšd_»duû_aùiÚ
(

373 
yyP¬£r
 *
pP¬£r
,

374 
iLookAh—d


376 
i
;

377 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

379 
i
 = 
yy_»duû_of¡
[
¡©’o
];

380 ifĞ
i
==
YY_REDUCE_USE_DFLT
 ){

381  
yy_deçuÉ
[
¡©’o
];

383 ifĞ
iLookAh—d
==
YYNOCODE
 ){

384  
YY_NO_ACTION
;

386 
i
 +ğ
iLookAh—d
;

387 ifĞ
i
<0 || (
size_t
)i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

388  
yy_deçuÉ
[
¡©’o
];

390  
yy_aùiÚ
[
i
];

392 
	}
}

397 
	$yy_shiá
(

398 
yyP¬£r
 *
yypP¬£r
,

399 
yyNewS‹
,

400 
yyMajÜ
,

401 
YYMINORTYPE
 *
yypMšÜ


403 
yySckEÁry
 *
yytos
;

404 
yypP¬£r
->
yyidx
++;

405 ifĞ
yypP¬£r
->
yyidx
>=
YYSTACKDEPTH
 ){

406 
P¬£ARG_FETCH
;

407 
yypP¬£r
->
yyidx
--;

408 #iâdeà
NDEBUG


409 ifĞ
yyT¿ûFILE
 ){

410 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

413  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

416 %% /* 
	$yy·r£
 */ 
	`yyËx
()

417 
P¬£ARG_STORE
;

419 
	}
}

420 
	gyytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

421 
	gyytos
->
	g¡©’o
 = 
yyNewS‹
;

422 
	gyytos
->
	gmajÜ
 = 
yyMajÜ
;

423 
	gyytos
->
	gmšÜ
 = *
yypMšÜ
;

424 #
iâdef
 
NDEBUG


425 ifĞ
	gyyT¿ûFILE
 && 
	gyypP¬£r
->
	gyyidx
>0 ){

426 
	gi
;

427 
	`årštf
(
	gyyT¿ûFILE
,"%sShiá %d\n",
	gyyT¿ûProm±
,
	gyyNewS‹
);

428 
	`årštf
(
	gyyT¿ûFILE
,"%sSck:",
	gyyT¿ûProm±
);

429 
	gi
=1; i<=
yypP¬£r
->
yyidx
; i++)

430 
	`årštf
(
	gyyT¿ûFILE
," %s",
	gyyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
	gmajÜ
]);

431 
	`årštf
(
	gyyT¿ûFILE
,"\n");

433 #
’dif


440 
YYCODETYPE
 
	mlhs
;

441 
	mÄhs
;

442 } 
	gyyRuËInfo
[] = {

443 
	}
%%

446 
yy_acû±
(
yyP¬£r
*);

452 
	$yy_»duû
(

453 
yyP¬£r
 *
yypP¬£r
,

454 
yyruËno


456 
yygÙo
;

457 
yyaù
;

458 
YYMINORTYPE
 
yygÙomšÜ
;

459 
yySckEÁry
 *
yym¥
;

460 
yysize
;

461 
P¬£ARG_FETCH
;

462 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

463 #iâdeà
NDEBUG


464 ifĞ
yyT¿ûFILE
 ) {

465 ià(
yyruËno
>=0

466 && (
size_t
)
yyruËno
<(
yyRuËName
)/(yyRuleName[0]) ){

467 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

468 
yyRuËName
[
yyruËno
]);

475  
yyruËno
 ){

484 %% /* 
	$yy·r£
 */ 
	`yyËx
()

485 
	}
};

486 
	gyygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

487 
	gyysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

488 
	gyypP¬£r
->
	gyyidx
 -ğ
yysize
;

489 
	gyyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yypP¬£r
,
	gyygÙo
);

490 ifĞ
	gyyaù
 < 
	gYYNSTATE
 ){

491 
	`yy_shiá
(
	gyypP¬£r
,
	gyyaù
,
	gyygÙo
,&
	gyygÙomšÜ
);

492 }ifĞ
	gyyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 ){

493 
	`yy_acû±
(
yypP¬£r
);

500 
	`yy_·r£_çed
(

501 
yyP¬£r
 *
	gyypP¬£r


503 
	gP¬£ARG_FETCH
;

504 #
iâdef
 
NDEBUG


505 ifĞ
	gyyT¿ûFILE
 ){

506 
	`årštf
(
	gyyT¿ûFILE
,"%sFa!\n",
	gyyT¿ûProm±
);

508 #
’dif


509  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

512 
	}
%%

513 
	gP¬£ARG_STORE
;

519 
	$yy_syÁax_”rÜ
(

520 
yyP¬£r
 *
yypP¬£r
,

521 
yymajÜ
,

522 
YYMINORTYPE
 
yymšÜ


524 
P¬£ARG_FETCH
;

525 
	`UNUSED
(
yymajÜ
);

526 
	`UNUSED
(
yymšÜ
);

527 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

528 %% /* 
	$yy·r£
 */ 
	`yyËx
()

529 
P¬£ARG_STORE
;

530 
	}
}

535 
	`yy_acû±
(

536 
yyP¬£r
 *
	gyypP¬£r


538 
	gP¬£ARG_FETCH
;

539 #
iâdef
 
NDEBUG


540 ifĞ
	gyyT¿ûFILE
 ){

541 
	`årštf
(
	gyyT¿ûFILE
,"%sAcû±!\n",
	gyyT¿ûProm±
);

543 #
’dif


544  
	gyypP¬£r
->
	gyyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

547 
	}
%%

548 
	gP¬£ARG_STORE
;

570 
	$P¬£
(

571 *
yyp
,

572 
yymajÜ
,

573 
P¬£TOKENTYPE
 
yymšÜ


574 
P¬£ARG_PDECL


576 
YYMINORTYPE
 
yymšÜuniÚ
;

577 
yyaù
;

578 
yy’dofšput
;

579 
yy”rÜh™
 = 0;

580 
yyP¬£r
 *
yypP¬£r
;

583 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

584 ifĞ
yypP¬£r
->
yyidx
<0 ){

585 ifĞ
yymajÜ
==0 ) ;

586 
yypP¬£r
->
yyidx
 = 0;

587 
yypP¬£r
->
yy”rút
 = -1;

588 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

589 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

591 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

592 
yy’dofšput
 = (
yymajÜ
==0);

593 
P¬£ARG_STORE
;

595 #iâdeà
NDEBUG


596 ifĞ
yyT¿ûFILE
 ){

597 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

602 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,
yymajÜ
);

603 ifĞ
yyaù
<
YYNSTATE
 ){

604 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

605 
yypP¬£r
->
yy”rút
--;

606 ifĞ
yy’dofšput
 && 
yypP¬£r
->
yyidx
>=0 ){

607 
yymajÜ
 = 0;

609 
yymajÜ
 = 
YYNOCODE
;

611 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

612 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

613 }ifĞ
yyaù
 =ğ
YY_ERROR_ACTION
 ){

614 
yymx
;

615 #iâdeà
NDEBUG


616 ifĞ
yyT¿ûFILE
 ){

617 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

620 #ifdeà
YYERRORSYMBOL


640 ifĞ
yypP¬£r
->
yy”rút
<0 ){

641 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

643 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

644 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

645 #iâdeà
NDEBUG


646 ifĞ
yyT¿ûFILE
 ){

647 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

648 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

651 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

652 
yymajÜ
 = 
YYNOCODE
;

655 
yypP¬£r
->
yyidx
 >= 0 &&

656 
yymx
 !ğ
YYERRORSYMBOL
 &&

657 (
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,
YYERRORSYMBOL
)è>ğ
YYNSTATE


659 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

661 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

662 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

663 
	`yy_·r£_çed
(
yypP¬£r
);

664 
yymajÜ
 = 
YYNOCODE
;

665 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

666 
YYMINORTYPE
 
u2
;

667 
u2
.
YYERRSYMDT
 = 0;

668 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

671 
yypP¬£r
->
yy”rút
 = 3;

672 
yy”rÜh™
 = 1;

683 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

684 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

686 
yypP¬£r
->
yy”rút
 = 3;

687 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

688 ifĞ
yy’dofšput
 ){

689 
	`yy_·r£_çed
(
yypP¬£r
);

691 
yymajÜ
 = 
YYNOCODE
;

694 
	`yy_acû±
(
yypP¬£r
);

695 
yymajÜ
 = 
YYNOCODE
;

697 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

699 
	}
}

	@lighttpd-angel.c

1 
	~"fœ¡.h
"

14 
	~<sys/wa™.h
>

16 
	~<¡dlib.h
>

17 
	~<¡dio.h
>

18 
	~<¡ršg.h
>

19 
	~<”ºo.h
>

20 
	~<uni¡d.h
>

21 
	~<time.h
>

22 
	~<sigÇl.h
>

24 
	#BINPATH
 
SBIN_DIR
"/ligh‰pd"

	)

26 
sigšfo_t
 
	gÏ¡_sig‹rm_šfo
;

27 
sigšfo_t
 
	gÏ¡_sighup_šfo
;

29 vŞ©
sig_©omic_t
 
	g¡¬t_´oûss
 = 1;

30 vŞ©
pid_t
 
	gpid
 = -1;

32 
	#UNUSED
(
x
èĞ()(xè)

	)

34 
	$sigaùiÚ_hªdËr
(
sig
, 
sigšfo_t
 *
si
, *
cÚ‹xt
) {

35 
ex™code
;

37 
	`UNUSED
(
cÚ‹xt
);

38 
sig
) {

39 
SIGINT
:

40 
SIGTERM
:

41 
	`memıy
(&
Ï¡_sig‹rm_šfo
, 
si
, (*si));

44 
	`kl
(
pid
, 
sig
);

46 
SIGHUP
:

47 
	`memıy
(&
Ï¡_sighup_šfo
, 
si
, (*si));

50 
	`kl
(
pid
, 
SIGINT
);

52 
	`u¦“p
(5 * 1000);

54 
¡¬t_´oûss
 = 1;

56 
SIGCHLD
:

58 
	`wa™
(&
ex™code
);

61 
	}
}

63 
	$maš
(
¬gc
, **
¬gv
) {

64 
is_shutdown
 = 0;

65 
sigaùiÚ
 
aù
;

67 
	`UNUSED
(
¬gc
);

73 
	`mem£t
(&
aù
, 0, (act));

74 
aù
.
§_hªdËr
 = 
SIG_IGN
;

75 
	`sigaùiÚ
(
SIGPIPE
, &
aù
, 
NULL
);

76 
	`sigaùiÚ
(
SIGUSR1
, &
aù
, 
NULL
);

78 
aù
.
§_sigaùiÚ
 = 
sigaùiÚ_hªdËr
;

79 
	`sigem±y£t
(&
aù
.
§_mask
);

80 
aù
.
§_æags
 = 
SA_SIGINFO
;

82 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

83 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

84 
	`sigaùiÚ
(
SIGHUP
, &
aù
, 
NULL
);

85 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

86 
	`sigaùiÚ
(
SIGCHLD
, &
aù
, 
NULL
);

93 !
is_shutdown
) {

94 
ex™code
 = 0;

96 ià(
¡¬t_´oûss
) {

97 
pid
 = 
	`fÜk
();

99 ià(0 =ğ
pid
) {

102 
¬gv
[0] = 
BINPATH
;

104 
	`execvp
(
BINPATH
, 
¬gv
);

106 
	`ex™
(1);

107 } ià(-1 =ğ
pid
) {

114 
¡¬t_´oûss
 = 0;

117 ià((
pid_t
)-1 =ğ
	`wa™pid
(
pid
, &
ex™code
, 0)) {

118 
”ºo
) {

119 
EINTR
:

123 
ECHILD
:

127 ià(!
¡¬t_´oûss
è
is_shutdown
 = 1;

135 ià(
	`WIFEXITED
(
ex™code
)) {

138 
is_shutdown
 = 1;

140 
	`årštf
(
¡d”r
, "%s.%d: child (pid=%d)ƒxited‚ormally withƒxitcode: %d\n",

141 
__FILE__
, 
__LINE__
,

142 
pid
,

143 
	`WEXITSTATUS
(
ex™code
));

145 } ià(
	`WIFSIGNALED
(
ex™code
)) {

148 
	`årštf
(
¡d”r
, "%s.%d: child (pid=%d)ƒxited unexpectedly with signal %d,„estarting\n",

149 
__FILE__
, 
__LINE__
,

150 
pid
,

151 
	`WTERMSIG
(
ex™code
));

153 
¡¬t_´oûss
 = 1;

159 
	}
}

	@log.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"¬¿y.h
"

7 
	~<sys/ty³s.h
>

9 
	~<”ºo.h
>

10 
	~<fú.h
>

11 
	~<time.h
>

12 
	~<uni¡d.h
>

13 
	~<¡ršg.h
>

14 
	~<¡dlib.h
>

16 
	~<¡d¬g.h
>

17 
	~<¡dio.h
>

19 #ifdeà
HAVE_SYSLOG_H


20 
	~<sy¦og.h
>

23 #ifdeà
HAVE_VALGRIND_VALGRIND_H


24 
	~<v®gršd/v®gršd.h
>

27 #iâdeà
O_LARGEFILE


28 
	#O_LARGEFILE
 0

	)

31 #iâdeà
HAVE_CLOCK_GETTIME


32 #ifdeà
HAVE_SYS_TIME_H


33 
	~<sys/time.h
>

37 
	$log_şock_g‘time_»®time
 (
time¥ec
 *
ts
) {

38 #ifdeà
HAVE_CLOCK_GETTIME


39  
	`şock_g‘time
(
CLOCK_REALTIME
, 
ts
);

43 
timev®
 
tv
;

44 
	`g‘timeofday
(&
tv
, 
NULL
);

45 
ts
->
tv_£c
 = 
tv
.tv_sec;

46 
ts
->
tv_n£c
 = 
tv
.
tv_u£c
 * 1000;

49 
	}
}

52 
ssize_t
 
	$wr™e_®l
(
fd
, cÚ¡ * 
buf
, 
size_t
 
couÁ
) {

53 
ssize_t
 
wr™‹n
 = 0;

55 
couÁ
 > 0) {

56 
ssize_t
 
r
 = 
	`wr™e
(
fd
, 
buf
, 
couÁ
);

57 ià(
r
 < 0) {

58 
”ºo
) {

59 
EINTR
:

66 } ià(0 =ğ
r
) {

68 
”ºo
 = 
EIO
;

71 
	`fÜû_as£¹
(
r
 <ğ(
ssize_t
è
couÁ
);

72 
wr™‹n
 +ğ
r
;

73 
buf
 = 
r
 + (const*) buf;

74 
couÁ
 -ğ
r
;

78  
wr™‹n
;

79 
	}
}

88 
	$İ’DevNuÎ
(
fd
) {

89 
tmpfd
;

90 
	`şo£
(
fd
);

91 #ià
	`defšed
(
__WIN32
)

93 
tmpfd
 = 
	`İ’
("nul", 
O_RDWR
);

95 
tmpfd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

97 ià(
tmpfd
 !ğ-1 &&mpfd !ğ
fd
) {

98 
	`dup2
(
tmpfd
, 
fd
);

99 
	`şo£
(
tmpfd
);

102  (
tmpfd
 != -1) ? 0 : -1;

103 
	}
}

105 
	$İ’_logfe_Ü_pe
(
£rv”
 *
¤v
, cÚ¡ * 
logfe
) {

106 
fd
;

108 ià(
logfe
[0] == '|') {

109 #ifdeà
HAVE_FORK


112 
to_log_fds
[2];

114 ià(
	`pe
(
to_log_fds
)) {

115 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "pçed: ", 
	`¡»¼Ü
(
”ºo
));

120 
	`fÜk
()) {

123 
	`şo£
(
STDIN_FILENO
);

126 ià(
to_log_fds
[0] !ğ
STDIN_FILENO
) {

127 ià(
STDIN_FILENO
 !ğ
	`dup2
(
to_log_fds
[0], STDIN_FILENO)) {

128 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

129 "dup2 faed: ", 
	`¡»¼Ü
(
”ºo
));

130 
	`ex™
(-1);

132 
	`şo£
(
to_log_fds
[0]);

134 
	`şo£
(
to_log_fds
[1]);

136 #iâdeà
FD_CLOEXEC


138 
i
;

140 
i
 = 3; i < 256; i++) {

141 
	`şo£
(
i
);

147 
	`İ’DevNuÎ
(
STDERR_FILENO
);

150 
	`exeş
("/bš/sh", "sh", "-c", 
logfe
 + 1, 
NULL
);

151 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

152 "¥awnšg†og…roûs çed: ", 
	`¡»¼Ü
(
”ºo
),

153 
logfe
 + 1);

155 
	`ex™
(-1);

159 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fÜk faed: ", 
	`¡»¼Ü
(
”ºo
));

162 
	`şo£
(
to_log_fds
[0]);

163 
fd
 = 
to_log_fds
[1];

170 } ià(-1 =ğ(
fd
 = 
	`İ’
(
logfe
, 
O_APPEND
 | 
O_WRONLY
 | 
O_CREAT
 | 
O_LARGEFILE
, 0644))) {

171 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSSS",

172 "İ’šgƒ¼Ülog '", 
logfe
,

173 "' faed: ", 
	`¡»¼Ü
(
”ºo
));

178 
	`fd_şo£_Ú_exec
(
fd
);

180  
fd
;

181 
	}
}

197 
	$log_”rÜ_İ’
(
£rv”
 *
¤v
) {

198 #ifdeà
HAVE_SYSLOG_H


200 
	`İ’log
("ligh‰pd", 
LOG_CONS
 | 
LOG_PID
, 
LOG_DAEMON
);

203 
¤v
->
”rÜlog_mode
 = 
ERRORLOG_FD
;

204 
¤v
->
”rÜlog_fd
 = 
STDERR_FILENO
;

206 ià(
¤v
->
¤vcÚf
.
”rÜlog_u£_sy¦og
) {

207 
¤v
->
”rÜlog_mode
 = 
ERRORLOG_SYSLOG
;

208 } ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
”rÜlog_fe
)) {

209 cÚ¡ *
logfe
 = 
¤v
->
¤vcÚf
.
”rÜlog_fe
->
±r
;

211 ià(-1 =ğ(
¤v
->
”rÜlog_fd
 = 
	`İ’_logfe_Ü_pe
(¤v, 
logfe
))) {

214 
¤v
->
”rÜlog_mode
 = (
logfe
[0] =ğ'|'è? 
ERRORLOG_PIPE
 : 
ERRORLOG_FILE
;

217 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "server started");

219 ià(
¤v
->
”rÜlog_mode
 =ğ
ERRORLOG_FD
 && !¤v->
¤vcÚf
.
dÚt_d«mÚize
) {

223 
¤v
->
”rÜlog_fd
 = -1;

226 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
b»akag–og_fe
)) {

227 
b»akage_fd
;

228 cÚ¡ *
logfe
 = 
¤v
->
¤vcÚf
.
b»akag–og_fe
->
±r
;

230 ià(
¤v
->
”rÜlog_mode
 =ğ
ERRORLOG_FD
) {

231 
¤v
->
”rÜlog_fd
 = 
	`dup
(
STDERR_FILENO
);

232 
	`fd_şo£_Ú_exec
(
¤v
->
”rÜlog_fd
);

235 ià(-1 =ğ(
b»akage_fd
 = 
	`İ’_logfe_Ü_pe
(
¤v
, 
logfe
))) {

239 ià(
STDERR_FILENO
 !ğ
b»akage_fd
) {

240 
	`dup2
(
b»akage_fd
, 
STDERR_FILENO
);

241 
	`şo£
(
b»akage_fd
);

243 } ià(!
¤v
->
¤vcÚf
.
dÚt_d«mÚize
) {

245 
	`İ’DevNuÎ
(
STDERR_FILENO
);

248 
	}
}

258 
	$log_”rÜ_cyşe
(
£rv”
 *
¤v
) {

261 ià(
¤v
->
”rÜlog_mode
 =ğ
ERRORLOG_FILE
) {

262 cÚ¡ *
logfe
 = 
¤v
->
¤vcÚf
.
”rÜlog_fe
->
±r
;

265 
Ãw_fd
;

267 ià(-1 =ğ(
Ãw_fd
 = 
	`İ’_logfe_Ü_pe
(
¤v
, 
logfe
))) {

269 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSSSS",

270 "cyşšgƒ¼Ülog '", 
logfe
,

271 "' faed: ", 
	`¡»¼Ü
(
”ºo
),

274 
	`şo£
(
¤v
->
”rÜlog_fd
);

275 
¤v
->
”rÜlog_fd
 = -1;

276 #ifdeà
HAVE_SYSLOG_H


277 
¤v
->
”rÜlog_mode
 = 
ERRORLOG_SYSLOG
;

281 
	`şo£
(
¤v
->
”rÜlog_fd
);

282 
¤v
->
”rÜlog_fd
 = 
Ãw_fd
;

283 
	`fd_şo£_Ú_exec
(
¤v
->
”rÜlog_fd
);

288 
	}
}

290 
	$log_”rÜ_şo£
(
£rv”
 *
¤v
) {

291 
¤v
->
”rÜlog_mode
) {

292 
ERRORLOG_PIPE
:

293 
ERRORLOG_FILE
:

294 
ERRORLOG_FD
:

295 ià(-1 !ğ
¤v
->
”rÜlog_fd
) {

297 ià(
STDERR_FILENO
 !ğ
¤v
->
”rÜlog_fd
)

298 
	`şo£
(
¤v
->
”rÜlog_fd
);

299 
¤v
->
”rÜlog_fd
 = -1;

302 
ERRORLOG_SYSLOG
:

303 #ifdeà
HAVE_SYSLOG_H


304 
	`şo£log
();

310 
	}
}

313 
	$log_bufãr_­³nd_´štf
(
bufãr
 *
out
, cÚ¡ *
fmt
, 
va_li¡
 
­
) {

314 ; *
fmt
; fmt++) {

315 
d
;

316 *
s
;

317 
bufãr
 *
b
;

318 
off_t
 
o
;

320 *
fmt
) {

322 
s
 = 
	`va_¬g
(
­
, *);

323 
	`bufãr_­³nd_¡ršg_c_esÿ³d
(
out
, 
s
, (
NULL
 !ğsè? 
	`¡¾’
(s) : 0);

324 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(" "));

327 
b
 = 
	`va_¬g
(
­
, 
bufãr
 *);

328 
	`bufãr_­³nd_¡ršg_c_esÿ³d
(
out
, 
	`CONST_BUF_LEN
(
b
));

329 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(" "));

332 
d
 = 
	`va_¬g
(
­
, );

333 
	`bufãr_­³nd_št
(
out
, 
d
);

334 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(" "));

337 
o
 = 
	`va_¬g
(
­
, 
off_t
);

338 
	`bufãr_­³nd_št
(
out
, 
o
);

339 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(" "));

342 
d
 = 
	`va_¬g
(
­
, );

343 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("0x"));

344 
	`bufãr_­³nd_ušt_hex
(
out
, 
d
);

345 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(" "));

348 
s
 = 
	`va_¬g
(
­
, *);

349 
	`bufãr_­³nd_¡ršg_c_esÿ³d
(
out
, 
s
, (
NULL
 !ğsè? 
	`¡¾’
(s) : 0);

352 
b
 = 
	`va_¬g
(
­
, 
bufãr
 *);

353 
	`bufãr_­³nd_¡ršg_c_esÿ³d
(
out
, 
	`CONST_BUF_LEN
(
b
));

356 
d
 = 
	`va_¬g
(
­
, );

357 
	`bufãr_­³nd_št
(
out
, 
d
);

360 
o
 = 
	`va_¬g
(
­
, 
off_t
);

361 
	`bufãr_­³nd_št
(
out
, 
o
);

364 
d
 = 
	`va_¬g
(
­
, );

365 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("0x"));

366 
	`bufãr_­³nd_ušt_hex
(
out
, 
d
);

374 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
fmt
, 1);

378 
	}
}

380 
	$log_bufãr_´•¬e
(
bufãr
 *
b
, 
£rv”
 *
¤v
, cÚ¡ *
f’ame
, 
lše
) {

381 
¤v
->
”rÜlog_mode
) {

382 
ERRORLOG_PIPE
:

383 
ERRORLOG_FILE
:

384 
ERRORLOG_FD
:

385 ià(-1 =ğ
¤v
->
”rÜlog_fd
)  -1;

387 ià(
¤v
->
cur_ts
 !ğ¤v->
Ï¡_g’”©ed_debug_ts
) {

388 
	`bufãr_¡ršg_´•¬e_cİy
(
¤v
->
ts_debug_¡r
, 255);

389 
	`bufãr_­³nd_¡ráime
(
¤v
->
ts_debug_¡r
, "%Y-%m-%d %H:%M:%S", 
	`loÿÉime
(&(¤v->
cur_ts
)));

391 
¤v
->
Ï¡_g’”©ed_debug_ts
 = srv->
cur_ts
;

394 
	`bufãr_cİy_bufãr
(
b
, 
¤v
->
ts_debug_¡r
);

395 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(": ("));

397 
ERRORLOG_SYSLOG
:

399 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("("));

403 
	`bufãr_­³nd_¡ršg
(
b
, 
f’ame
);

404 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("."));

405 
	`bufãr_­³nd_št
(
b
, 
lše
);

406 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(") "));

409 
	}
}

411 
	$log_wr™e
(
£rv”
 *
¤v
, 
bufãr
 *
b
) {

412 
¤v
->
”rÜlog_mode
) {

413 
ERRORLOG_PIPE
:

414 
ERRORLOG_FILE
:

415 
ERRORLOG_FD
:

416 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

417 
	`wr™e_®l
(
¤v
->
”rÜlog_fd
, 
	`CONST_BUF_LEN
(
b
));

419 
ERRORLOG_SYSLOG
:

420 
	`sy¦og
("%s", 
b
->
±r
);

423 
	}
}

425 
	$log_”rÜ_wr™e
(
£rv”
 *
¤v
, cÚ¡ *
f’ame
, 
lše
, cÚ¡ *
fmt
, ...) {

426 
va_li¡
 
­
;

428 ià(-1 =ğ
	`log_bufãr_´•¬e
(
¤v
->
”rÜlog_buf
, srv, 
f’ame
, 
lše
))  0;

430 
	`va_¡¬t
(
­
, 
fmt
);

431 
	`log_bufãr_­³nd_´štf
(
¤v
->
”rÜlog_buf
, 
fmt
, 
­
);

432 
	`va_’d
(
­
);

434 
	`log_wr™e
(
¤v
, srv->
”rÜlog_buf
);

437 
	}
}

439 
	$log_”rÜ_wr™e_muÉše_bufãr
(
£rv”
 *
¤v
, cÚ¡ *
f’ame
, 
lše
, 
bufãr
 *
muÉše
, cÚ¡ *
fmt
, ...) {

440 
va_li¡
 
­
;

441 
size_t
 
´efix_Ën
;

442 
bufãr
 *
b
 = 
¤v
->
”rÜlog_buf
;

443 *
pos
, *
’d
, *
cu¼’t_lše
;

445 ià(
	`bufãr_¡ršg_is_em±y
(
muÉše
))  0;

447 ià(-1 =ğ
	`log_bufãr_´•¬e
(
b
, 
¤v
, 
f’ame
, 
lše
))  0;

449 
	`va_¡¬t
(
­
, 
fmt
);

450 
	`log_bufãr_­³nd_´štf
(
b
, 
fmt
, 
­
);

451 
	`va_’d
(
­
);

453 
´efix_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

455 
cu¼’t_lše
 = 
pos
 = 
muÉše
->
±r
;

456 
’d
 = 
muÉše
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(multiline);

458  ; 
pos
 <ğ
’d
 ; ++pos) {

459 *
pos
) {

463 ià(
cu¼’t_lše
 < 
pos
) {

465 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 
´efix_Ën
);

467 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
cu¼’t_lše
, 
pos
 - current_line);

468 
	`log_wr™e
(
¤v
, 
b
);

470 
cu¼’t_lše
 = 
pos
 + 1;

478 
	}
}

	@log.h

1 #iâdeà
_LOG_H_


2 
	#_LOG_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£rv”.h
"

7 
	gtime¥ec
;

8 
log_şock_g‘time_»®time
 (
time¥ec
 *
ts
);

10 
ssize_t
 
wr™e_®l
(
fd
, cÚ¡ * 
buf
, 
size_t
 
couÁ
);

15 
İ’DevNuÎ
(
fd
);

17 
İ’_logfe_Ü_pe
(
£rv”
 *
¤v
, cÚ¡ * 
logfe
);

19 
log_”rÜ_İ’
(
£rv”
 *
¤v
);

20 
log_”rÜ_şo£
(
£rv”
 *
¤v
);

21 
log_”rÜ_wr™e
(
£rv”
 *
¤v
, cÚ¡ *
f’ame
, 
lše
, cÚ¡ *
fmt
, ...);

22 
log_”rÜ_wr™e_muÉše_bufãr
(
£rv”
 *
¤v
, cÚ¡ *
f’ame
, 
lše
, 
bufãr
 *
muÉše
, cÚ¡ *
fmt
, ...);

23 
log_”rÜ_cyşe
(
£rv”
 *
¤v
);

	@md5.c

1 
	~"fœ¡.h
"

29 
	~"md5.h
"

31 #iâdeà
USE_OPENSSL


32 
	~<¡ršg.h
>

37 
	#S11
 7

	)

38 
	#S12
 12

	)

39 
	#S13
 17

	)

40 
	#S14
 22

	)

41 
	#S21
 5

	)

42 
	#S22
 9

	)

43 
	#S23
 14

	)

44 
	#S24
 20

	)

45 
	#S31
 4

	)

46 
	#S32
 11

	)

47 
	#S33
 16

	)

48 
	#S34
 23

	)

49 
	#S41
 6

	)

50 
	#S42
 10

	)

51 
	#S43
 15

	)

52 
	#S44
 21

	)

54 
li_MD5T¿nsfÜm
 (
UINT4
 [4], const [64]);

55 
Encode
 (*, 
UINT4
 *, );

56 
Decode
 (
UINT4
 *, const *, );

58 #ifdeà
HAVE_MEMCPY


59 
	#MD5_memıy
(
ouut
, 
šput
, 
Ën
è
	`memıy
((ouut), (šput), (Ën))

	)

61 
MD5_memıy
 (
POINTER
, POINTER, );

63 #ifdeà
HAVE_MEMSET


64 
	#MD5_mem£t
(
ouut
, 
v®ue
, 
Ën
è
	`mem£t
((ouut), (v®ue), (Ën))

	)

66 
MD5_mem£t
 (
POINTER
, , );

69 
	gPADDING
[64] = {

77 
	#F
(
x
, 
y
, 
z
è(((xè& (y)è| ((~xè& (z)))

	)

78 
	#G
(
x
, 
y
, 
z
è(((xè& (z)è| ((yè& (~z)))

	)

79 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

80 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| (~z)))

	)

84 
	#ROTATE_LEFT
(
x
, 
n
è(((xè<< (n)è| ((xè>> (32-Ò))))

	)

89 
	#FF
(
a
, 
b
, 
c
, 
d
, 
x
, 
s
, 
ac
) { \

90 (
a
è+ğ
	`F
 ((
b
), (
c
), (
d
)è+ (
x
è+ (
UINT4
)(
ac
); \

91 (
a
èğ
	`ROTATE_LEFT
 (×), (
s
)); \

92 (
a
è+ğ(
b
); \

93 }

	)

94 
	#GG
(
a
, 
b
, 
c
, 
d
, 
x
, 
s
, 
ac
) { \

95 (
a
è+ğ
	`G
 ((
b
), (
c
), (
d
)è+ (
x
è+ (
UINT4
)(
ac
); \

96 (
a
èğ
	`ROTATE_LEFT
 (×), (
s
)); \

97 (
a
è+ğ(
b
); \

98 }

	)

99 
	#HH
(
a
, 
b
, 
c
, 
d
, 
x
, 
s
, 
ac
) { \

100 (
a
è+ğ
	`H
 ((
b
), (
c
), (
d
)è+ (
x
è+ (
UINT4
)(
ac
); \

101 (
a
èğ
	`ROTATE_LEFT
 (×), (
s
)); \

102 (
a
è+ğ(
b
); \

103 }

	)

104 
	#II
(
a
, 
b
, 
c
, 
d
, 
x
, 
s
, 
ac
) { \

105 (
a
è+ğ
	`I
 ((
b
), (
c
), (
d
)è+ (
x
è+ (
UINT4
)(
ac
); \

106 (
a
èğ
	`ROTATE_LEFT
 (×), (
s
)); \

107 (
a
è+ğ(
b
); \

108 }

	)

112 
	$li_MD5_In™
 (
li_MD5_CTX
 *
cÚ‹xt
)

114 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

117 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

118 
cÚ‹xt
->
¡©e
[1] = 0xefcdab89;

119 
cÚ‹xt
->
¡©e
[2] = 0x98badcfe;

120 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

121 
	}
}

127 
	$li_MD5_Upd©e
 (
li_MD5_CTX
 *
cÚ‹xt
, cÚ¡ *
_šput
, 
šputL’
)

129 
i
, 
ndx
, 
·¹L’
;

130 cÚ¡ *
šput
 = (cÚ¡ *è
_šput
;

133 
ndx
 = ()((
cÚ‹xt
->
couÁ
[0] >> 3) & 0x3F);

136 ià((
cÚ‹xt
->
couÁ
[0] +ğ((
UINT4
)
šputL’
 << 3))

138 < ((
UINT4
)
šputL’
 << 3))

139 
cÚ‹xt
->
couÁ
[1]++;

140 
cÚ‹xt
->
couÁ
[1] +ğ((
UINT4
)
šputL’
 >> 29);

142 
·¹L’
 = 64 - 
ndx
;

146 ià(
šputL’
 >ğ
·¹L’
) {

147 
MD5_memıy


148 ((
POINTER
)&
cÚ‹xt
->
bufãr
[
ndx
], (POINTER)
šput
, 
·¹L’
);

149 
	`li_MD5T¿nsfÜm
 (
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

151 
i
 = 
·¹L’
; i + 63 < 
šputL’
; i += 64)

152 
	`li_MD5T¿nsfÜm
 (
cÚ‹xt
->
¡©e
, &
šput
[
i
]);

154 
ndx
 = 0;

157 
i
 = 0;

160 
MD5_memıy


161 ((
POINTER
)&
cÚ‹xt
->
bufãr
[
ndx
], (POINTER)&
šput
[
i
],

162 
šputL’
-
i
);

163 
	}
}

168 
	$li_MD5_Fš®
 (
dige¡
[16], 
li_MD5_CTX
 *
cÚ‹xt
)

170 
b™s
[8];

171 
ndx
, 
·dL’
;

174 
	`Encode
 (
b™s
, 
cÚ‹xt
->
couÁ
, 8);

178 
ndx
 = ()((
cÚ‹xt
->
couÁ
[0] >> 3) & 0x3f);

179 
·dL’
 = (
ndx
 < 56) ? (56 -‚dx) : (120 -‚dx);

180 
	`li_MD5_Upd©e
 (
cÚ‹xt
, 
PADDING
, 
·dL’
);

183 
	`li_MD5_Upd©e
 (
cÚ‹xt
, 
b™s
, 8);

186 
	`Encode
 (
dige¡
, 
cÚ‹xt
->
¡©e
, 16);

190 
	`MD5_mem£t
 ((
POINTER
)
cÚ‹xt
, 0,  (*context));

191 
	}
}

195 
	$li_MD5T¿nsfÜm
 (
UINT4
 
¡©e
[4], cÚ¡ 
block
[64])

197 
UINT4
 
a
 = 
¡©e
[0], 
b
 = s‹[1], 
c
 = s‹[2], 
d
 = s‹[3], 
x
[16];

199 
	`Decode
 (
x
, 
block
, 64);

202 
	`FF
 (
a
, 
b
, 
c
, 
d
, 
x
[ 0], 
S11
, 0xd76aa478);

203 
	`FF
 (
d
, 
a
, 
b
, 
c
, 
x
[ 1], 
S12
, 0xe8c7b756);

204 
	`FF
 (
c
, 
d
, 
a
, 
b
, 
x
[ 2], 
S13
, 0x242070db);

205 
	`FF
 (
b
, 
c
, 
d
, 
a
, 
x
[ 3], 
S14
, 0xc1bdceee);

206 
	`FF
 (
a
, 
b
, 
c
, 
d
, 
x
[ 4], 
S11
, 0xf57c0faf);

207 
	`FF
 (
d
, 
a
, 
b
, 
c
, 
x
[ 5], 
S12
, 0x4787c62a);

208 
	`FF
 (
c
, 
d
, 
a
, 
b
, 
x
[ 6], 
S13
, 0xa8304613);

209 
	`FF
 (
b
, 
c
, 
d
, 
a
, 
x
[ 7], 
S14
, 0xfd469501);

210 
	`FF
 (
a
, 
b
, 
c
, 
d
, 
x
[ 8], 
S11
, 0x698098d8);

211 
	`FF
 (
d
, 
a
, 
b
, 
c
, 
x
[ 9], 
S12
, 0x8b44f7af);

212 
	`FF
 (
c
, 
d
, 
a
, 
b
, 
x
[10], 
S13
, 0xffff5bb1);

213 
	`FF
 (
b
, 
c
, 
d
, 
a
, 
x
[11], 
S14
, 0x895cd7be);

214 
	`FF
 (
a
, 
b
, 
c
, 
d
, 
x
[12], 
S11
, 0x6b901122);

215 
	`FF
 (
d
, 
a
, 
b
, 
c
, 
x
[13], 
S12
, 0xfd987193);

216 
	`FF
 (
c
, 
d
, 
a
, 
b
, 
x
[14], 
S13
, 0xa679438e);

217 
	`FF
 (
b
, 
c
, 
d
, 
a
, 
x
[15], 
S14
, 0x49b40821);

220 
	`GG
 (
a
, 
b
, 
c
, 
d
, 
x
[ 1], 
S21
, 0xf61e2562);

221 
	`GG
 (
d
, 
a
, 
b
, 
c
, 
x
[ 6], 
S22
, 0xc040b340);

222 
	`GG
 (
c
, 
d
, 
a
, 
b
, 
x
[11], 
S23
, 0x265e5a51);

223 
	`GG
 (
b
, 
c
, 
d
, 
a
, 
x
[ 0], 
S24
, 0xe9b6c7aa);

224 
	`GG
 (
a
, 
b
, 
c
, 
d
, 
x
[ 5], 
S21
, 0xd62f105d);

225 
	`GG
 (
d
, 
a
, 
b
, 
c
, 
x
[10], 
S22
, 0x2441453);

226 
	`GG
 (
c
, 
d
, 
a
, 
b
, 
x
[15], 
S23
, 0xd8a1e681);

227 
	`GG
 (
b
, 
c
, 
d
, 
a
, 
x
[ 4], 
S24
, 0xe7d3fbc8);

228 
	`GG
 (
a
, 
b
, 
c
, 
d
, 
x
[ 9], 
S21
, 0x21e1cde6);

229 
	`GG
 (
d
, 
a
, 
b
, 
c
, 
x
[14], 
S22
, 0xc33707d6);

230 
	`GG
 (
c
, 
d
, 
a
, 
b
, 
x
[ 3], 
S23
, 0xf4d50d87);

232 
	`GG
 (
b
, 
c
, 
d
, 
a
, 
x
[ 8], 
S24
, 0x455a14ed);

233 
	`GG
 (
a
, 
b
, 
c
, 
d
, 
x
[13], 
S21
, 0xa9e3e905);

234 
	`GG
 (
d
, 
a
, 
b
, 
c
, 
x
[ 2], 
S22
, 0xfcefa3f8);

235 
	`GG
 (
c
, 
d
, 
a
, 
b
, 
x
[ 7], 
S23
, 0x676f02d9);

236 
	`GG
 (
b
, 
c
, 
d
, 
a
, 
x
[12], 
S24
, 0x8d2a4c8a);

239 
	`HH
 (
a
, 
b
, 
c
, 
d
, 
x
[ 5], 
S31
, 0xfffa3942);

240 
	`HH
 (
d
, 
a
, 
b
, 
c
, 
x
[ 8], 
S32
, 0x8771f681);

241 
	`HH
 (
c
, 
d
, 
a
, 
b
, 
x
[11], 
S33
, 0x6d9d6122);

242 
	`HH
 (
b
, 
c
, 
d
, 
a
, 
x
[14], 
S34
, 0xfde5380c);

243 
	`HH
 (
a
, 
b
, 
c
, 
d
, 
x
[ 1], 
S31
, 0xa4beea44);

244 
	`HH
 (
d
, 
a
, 
b
, 
c
, 
x
[ 4], 
S32
, 0x4bdecfa9);

245 
	`HH
 (
c
, 
d
, 
a
, 
b
, 
x
[ 7], 
S33
, 0xf6bb4b60);

246 
	`HH
 (
b
, 
c
, 
d
, 
a
, 
x
[10], 
S34
, 0xbebfbc70);

247 
	`HH
 (
a
, 
b
, 
c
, 
d
, 
x
[13], 
S31
, 0x289b7ec6);

248 
	`HH
 (
d
, 
a
, 
b
, 
c
, 
x
[ 0], 
S32
, 0xeaa127fa);

249 
	`HH
 (
c
, 
d
, 
a
, 
b
, 
x
[ 3], 
S33
, 0xd4ef3085);

250 
	`HH
 (
b
, 
c
, 
d
, 
a
, 
x
[ 6], 
S34
, 0x4881d05);

251 
	`HH
 (
a
, 
b
, 
c
, 
d
, 
x
[ 9], 
S31
, 0xd9d4d039);

252 
	`HH
 (
d
, 
a
, 
b
, 
c
, 
x
[12], 
S32
, 0xe6db99e5);

253 
	`HH
 (
c
, 
d
, 
a
, 
b
, 
x
[15], 
S33
, 0x1fa27cf8);

254 
	`HH
 (
b
, 
c
, 
d
, 
a
, 
x
[ 2], 
S34
, 0xc4ac5665);

257 
	`II
 (
a
, 
b
, 
c
, 
d
, 
x
[ 0], 
S41
, 0xf4292244);

258 
	`II
 (
d
, 
a
, 
b
, 
c
, 
x
[ 7], 
S42
, 0x432aff97);

259 
	`II
 (
c
, 
d
, 
a
, 
b
, 
x
[14], 
S43
, 0xab9423a7);

260 
	`II
 (
b
, 
c
, 
d
, 
a
, 
x
[ 5], 
S44
, 0xfc93a039);

261 
	`II
 (
a
, 
b
, 
c
, 
d
, 
x
[12], 
S41
, 0x655b59c3);

262 
	`II
 (
d
, 
a
, 
b
, 
c
, 
x
[ 3], 
S42
, 0x8f0ccc92);

263 
	`II
 (
c
, 
d
, 
a
, 
b
, 
x
[10], 
S43
, 0xffeff47d);

264 
	`II
 (
b
, 
c
, 
d
, 
a
, 
x
[ 1], 
S44
, 0x85845dd1);

265 
	`II
 (
a
, 
b
, 
c
, 
d
, 
x
[ 8], 
S41
, 0x6fa87e4f);

266 
	`II
 (
d
, 
a
, 
b
, 
c
, 
x
[15], 
S42
, 0xfe2ce6e0);

267 
	`II
 (
c
, 
d
, 
a
, 
b
, 
x
[ 6], 
S43
, 0xa3014314);

268 
	`II
 (
b
, 
c
, 
d
, 
a
, 
x
[13], 
S44
, 0x4e0811a1);

269 
	`II
 (
a
, 
b
, 
c
, 
d
, 
x
[ 4], 
S41
, 0xf7537e82);

270 
	`II
 (
d
, 
a
, 
b
, 
c
, 
x
[11], 
S42
, 0xbd3af235);

271 
	`II
 (
c
, 
d
, 
a
, 
b
, 
x
[ 2], 
S43
, 0x2ad7d2bb);

272 
	`II
 (
b
, 
c
, 
d
, 
a
, 
x
[ 9], 
S44
, 0xeb86d391);

274 
¡©e
[0] +ğ
a
;

275 
¡©e
[1] +ğ
b
;

276 
¡©e
[2] +ğ
c
;

277 
¡©e
[3] +ğ
d
;

282 
	`MD5_mem£t
 ((
POINTER
)
x
, 0,  (x));

283 
	}
}

288 
	$Encode
 (*
ouut
, 
UINT4
 *
šput
, 
Ën
)

290 
i
, 
j
;

292 
i
 = 0, 
j
 = 0; j < 
Ën
; i++, j += 4) {

293 
ouut
[
j
] = ()(
šput
[
i
] & 0xff);

294 
ouut
[
j
+1] = ()((
šput
[
i
] >> 8) & 0xff);

295 
ouut
[
j
+2] = ()((
šput
[
i
] >> 16) & 0xff);

296 
ouut
[
j
+3] = ()((
šput
[
i
] >> 24) & 0xff);

298 
	}
}

303 
	$Decode
 (
UINT4
 *
ouut
, cÚ¡ *
šput
, 
Ën
)

305 
i
, 
j
;

307 
i
 = 0, 
j
 = 0; j < 
Ën
; i++, j += 4)

308 
ouut
[
i
] = ((
UINT4
)
šput
[
j
]) | (((UINT4)input[j+1]) << 8) |

309 (((
UINT4
)
šput
[
j
+2]) << 16) | (((UINT4)input[j+3]) << 24);

310 
	}
}

314 #iâdeà
HAVE_MEMCPY


315 
	$MD5_memıy
 (
POINTER
 
ouut
, POINTER 
šput
, 
Ën
)

317 
i
;

319 
i
 = 0; i < 
Ën
; i++)

321 
ouut
[
i
] = 
šput
[i];

322 
	}
}

326 #iâdeà
HAVE_MEMSET


327 
	$MD5_mem£t
 (
POINTER
 
ouut
, 
v®ue
, 
Ën
)

329 
i
;

331 
i
 = 0; i < 
Ën
; i++)

332 ((*)
ouut
)[
i
] = ()
v®ue
;

333 
	}
}

	@md5.h

1 #iâdeà
LI_MD5_H


2 
	#LI_MD5_H


	)

3 
	~"fœ¡.h
"

30 
	~<lim™s.h
>

31 #ifdeà
HAVE_STDINT_H


32 
	~<¡dšt.h
>

34 #ifdeà
HAVE_INTTYPES_H


35 
	~<š‰y³s.h
>

38 
	#UINT4
 
ušt32_t


	)

39 
	#UINT2
 
ušt16_t


	)

40 
	#POINTER
 *

	)

44 
UINT4
 
	m¡©e
[4];

45 
UINT4
 
	mcouÁ
[2];

46 
	mbufãr
[64];

47 } 
	tli_MD5_CTX
;

49 
li_MD5_In™
 (
li_MD5_CTX
 *);

50 
li_MD5_Upd©e
 (
li_MD5_CTX
 *, const *, );

51 
li_MD5_Fš®
 ([16], 
li_MD5_CTX
 *);

	@mod_access.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~<ùy³.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

14 
¬¿y
 *
	macûss_®low
;

15 
¬¿y
 *
	macûss_d’y
;

16 } 
	t¶ugš_cÚfig
;

19 
	mPLUGIN_DATA
;

21 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

23 
¶ugš_cÚfig
 
	mcÚf
;

24 } 
	t¶ugš_d©a
;

26 
	$INIT_FUNC
(
mod_acûss_š™
) {

27 
¶ugš_d©a
 *
p
;

29 
p
 = 
	`ÿÎoc
(1, (*p));

31  
p
;

32 
	}
}

34 
	$FREE_FUNC
(
mod_acûss_ä“
) {

35 
¶ugš_d©a
 *
p
 = 
p_d
;

37 
	`UNUSED
(
¤v
);

39 ià(!
p
è 
HANDLER_GO_ON
;

41 ià(
p
->
cÚfig_¡Üage
) {

42 
size_t
 
i
;

43 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

44 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

46 ià(
NULL
 =ğ
s
) ;

48 
	`¬¿y_ä“
(
s
->
acûss_®low
);

49 
	`¬¿y_ä“
(
s
->
acûss_d’y
);

51 
	`ä“
(
s
);

53 
	`ä“
(
p
->
cÚfig_¡Üage
);

56 
	`ä“
(
p
);

58  
HANDLER_GO_ON
;

59 
	}
}

61 
	$SETDEFAULTS_FUNC
(
mod_acûss_£t_deçuÉs
) {

62 
¶ugš_d©a
 *
p
 = 
p_d
;

63 
size_t
 
i
 = 0;

65 
cÚfig_v®ues_t
 
cv
[] = {

66 { "u¾.acûss-d’y", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

67 { "u¾.acûss-®low", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

68 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

71 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

73 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

74 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

75 
¶ugš_cÚfig
 *
s
;

77 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

78 
s
->
acûss_d’y
 = 
	`¬¿y_š™
();

79 
s
->
acûss_®low
 = 
	`¬¿y_š™
();

81 
cv
[0].
de¡š©iÚ
 = 
s
->
acûss_d’y
;

82 
cv
[1].
de¡š©iÚ
 = 
s
->
acûss_®low
;

84 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

86 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

87  
HANDLER_ERROR
;

91  
HANDLER_GO_ON
;

92 
	}
}

94 
	#PATCH
(
x
) \

95 
p
->
cÚf
.
x
 = 
s
->x;

	)

96 
	$mod_acûss_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

97 
size_t
 
i
, 
j
;

98 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

100 
	`PATCH
(
acûss_®low
);

101 
	`PATCH
(
acûss_d’y
);

104 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

105 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

106 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

109 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

112 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

113 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

115 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.access-deny"))) {

116 
	`PATCH
(
acûss_d’y
);

117 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.access-allow"))) {

118 
	`PATCH
(
acûss_®low
);

124 
	}
}

125 #undeà
PATCH


136 
	$URIHANDLER_FUNC
(
mod_acûss_uri_hªdËr
) {

137 
¶ugš_d©a
 *
p
 = 
p_d
;

138 
s_Ën
;

139 
size_t
 
k
;

141 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

143 
	`mod_acûss_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

145 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
);

147 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

148 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

152 
k
 = 0; k < 
p
->
cÚf
.
acûss_®low
->
u£d
; ++k) {

153 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
acûss_®low
->
d©a
[
k
];

154 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

155 
®lowed
 = 0;

157 ià(
ù_Ën
 > 
s_Ën
) ;

158 ià(
	`bufãr_is_em±y
(
ds
->
v®ue
)) ;

162 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

163 ià(0 =ğ
	`¡ºÿ£cmp
(
cÚ
->
uri
.
·th
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
v®ue
->ptr, ct_len)) {

164 
®lowed
 = 1;

167 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
v®ue
->ptr, ct_len)) {

168 
®lowed
 = 1;

172 ià(
®lowed
) {

173  
HANDLER_GO_ON
;

177 ià(
k
 > 0) {

178 
cÚ
->
h‰p_¡©us
 = 403;

179 
cÚ
->
mode
 = 
DIRECT
;

181 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

182 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

183 "u¾ d’›d‡ çedØm©ch‡ny from‡cûss_®low", 
cÚ
->
uri
.
·th
);

186  
HANDLER_FINISHED
;

189 
k
 = 0; k < 
p
->
cÚf
.
acûss_d’y
->
u£d
; k++) {

190 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
acûss_d’y
->
d©a
[
k
];

191 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

192 
d’›d
 = 0;

195 ià(
ù_Ën
 > 
s_Ën
) ;

196 ià(
	`bufãr_is_em±y
(
ds
->
v®ue
)) ;

200 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

201 ià(0 =ğ
	`¡ºÿ£cmp
(
cÚ
->
uri
.
·th
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
v®ue
->ptr, ct_len)) {

202 
d’›d
 = 1;

205 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
v®ue
->ptr, ct_len)) {

206 
d’›d
 = 1;

210 ià(
d’›d
) {

211 
cÚ
->
h‰p_¡©us
 = 403;

212 
cÚ
->
mode
 = 
DIRECT
;

214 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

215 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

216 "u¾ d’›d‡ wm©ch:", 
ds
->
v®ue
);

219  
HANDLER_FINISHED
;

224  
HANDLER_GO_ON
;

225 
	}
}

228 
mod_acûss_¶ugš_š™
(
¶ugš
 *
p
);

229 
	$mod_acûss_¶ugš_š™
(
¶ugš
 *
p
) {

230 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

231 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("access");

233 
p
->
š™
 = 
mod_acûss_š™
;

234 
p
->
£t_deçuÉs
 = 
mod_acûss_£t_deçuÉs
;

235 
p
->
hªdË_uri_ş—n
 = 
mod_acûss_uri_hªdËr
;

236 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_acûss_uri_hªdËr
;

237 
p
->
ş—nup
 = 
mod_acûss_ä“
;

239 
p
->
d©a
 = 
NULL
;

242 
	}
}

	@mod_accesslog.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~<sys/ty³s.h
>

10 
	~<sys/¡©.h
>

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<fú.h
>

16 
	~<uni¡d.h
>

17 
	~<”ºo.h
>

18 
	~<time.h
>

20 
	~<¡dio.h
>

22 #ifdeà
HAVE_SYSLOG_H


23 
	~<sy¦og.h
>

27 
	mkey
;

29 
	mFORMAT_UNSET
,

30 
	mFORMAT_UNSUPPORTED
,

31 
	mFORMAT_PERCENT
,

32 
	mFORMAT_REMOTE_HOST
,

33 
	mFORMAT_REMOTE_IDENT
,

34 
	mFORMAT_REMOTE_USER
,

35 
	mFORMAT_TIMESTAMP
,

36 
	mFORMAT_REQUEST_LINE
,

37 
	mFORMAT_STATUS
,

38 
	mFORMAT_BYTES_OUT_NO_HEADER
,

39 
	mFORMAT_HEADER
,

41 
	mFORMAT_REMOTE_ADDR
,

42 
	mFORMAT_LOCAL_ADDR
,

43 
	mFORMAT_COOKIE
,

44 
	mFORMAT_TIME_USED_US
,

45 
	mFORMAT_ENV
,

46 
	mFORMAT_FILENAME
,

47 
	mFORMAT_REQUEST_PROTOCOL
,

48 
	mFORMAT_REQUEST_METHOD
,

49 
	mFORMAT_SERVER_PORT
,

50 
	mFORMAT_QUERY_STRING
,

51 
	mFORMAT_TIME_USED
,

52 
	mFORMAT_URL
,

53 
	mFORMAT_SERVER_NAME
,

54 
	mFORMAT_HTTP_HOST
,

55 
	mFORMAT_CONNECTION_STATUS
,

56 
	mFORMAT_BYTES_IN
,

57 
	mFORMAT_BYTES_OUT
,

59 
	mFORMAT_KEEPALIVE_COUNT
,

60 
	mFORMAT_RESPONSE_HEADER
,

61 
	mFORMAT_NOTE


62 } 
	mty³
;

63 } 
	tfÜm©_m­pšg
;

72 cÚ¡ 
fÜm©_m­pšg
 
	gfm­
[] =

74 { '%', 
FORMAT_PERCENT
 },

75 { 'h', 
FORMAT_REMOTE_HOST
 },

76 { 'l', 
FORMAT_REMOTE_IDENT
 },

77 { 'u', 
FORMAT_REMOTE_USER
 },

78 { 't', 
FORMAT_TIMESTAMP
 },

79 { 'r', 
FORMAT_REQUEST_LINE
 },

80 { 's', 
FORMAT_STATUS
 },

81 { 'b', 
FORMAT_BYTES_OUT_NO_HEADER
 },

82 { 'i', 
FORMAT_HEADER
 },

84 { 'a', 
FORMAT_REMOTE_ADDR
 },

85 { 'A', 
FORMAT_LOCAL_ADDR
 },

86 { 'B', 
FORMAT_BYTES_OUT_NO_HEADER
 },

87 { 'C', 
FORMAT_COOKIE
 },

88 { 'D', 
FORMAT_TIME_USED_US
 },

89 { 'e', 
FORMAT_ENV
 },

90 { 'f', 
FORMAT_FILENAME
 },

91 { 'H', 
FORMAT_REQUEST_PROTOCOL
 },

92 { 'k', 
FORMAT_KEEPALIVE_COUNT
 },

93 { 'm', 
FORMAT_REQUEST_METHOD
 },

94 { 'n', 
FORMAT_NOTE
 },

95 { 'p', 
FORMAT_SERVER_PORT
 },

96 { 'P', 
FORMAT_UNSUPPORTED
 },

97 { 'q', 
FORMAT_QUERY_STRING
 },

98 { 'T', 
FORMAT_TIME_USED
 },

99 { 'U', 
FORMAT_URL
 },

100 { 'v', 
FORMAT_SERVER_NAME
 },

101 { 'V', 
FORMAT_HTTP_HOST
 },

102 { 'X', 
FORMAT_CONNECTION_STATUS
 },

103 { 'I', 
FORMAT_BYTES_IN
 },

104 { 'O', 
FORMAT_BYTES_OUT
 },

106 { 'o', 
FORMAT_RESPONSE_HEADER
 },

108 { '\0', 
FORMAT_UNSET
 }

112 
	ee_İtæags_time
 {

115 
	mFORMAT_FLAG_TIME_END
 = 0x00,

116 
	mFORMAT_FLAG_TIME_BEGIN
 = 0x01,

117 
	mFORMAT_FLAG_TIME_SEC
 = 0x02,

118 
	mFORMAT_FLAG_TIME_MSEC
 = 0x04,

119 
	mFORMAT_FLAG_TIME_USEC
 = 0x08,

120 
	mFORMAT_FLAG_TIME_NSEC
 = 0x10,

121 
	mFORMAT_FLAG_TIME_MSEC_FRAC
 = 0x20,

122 
	mFORMAT_FLAG_TIME_USEC_FRAC
 = 0x40,

123 
	mFORMAT_FLAG_TIME_NSEC_FRAC
 = 0x80

128 ’um { 
	mFIELD_UNSET
, 
	mFIELD_STRING
, 
	mFIELD_FORMAT
 } 
	mty³
;

130 
bufãr
 *
	m¡ršg
;

131 
	mf›ld
;

132 
	mİt
;

133 } 
	tfÜm©_f›ld
;

136 
fÜm©_f›ld
 **
	m±r
;

138 
size_t
 
	mu£d
;

139 
size_t
 
	msize
;

140 } 
	tfÜm©_f›lds
;

143 
bufãr
 *
	macûss_logfe
;

144 
	mlog_acûss_fd
;

145 
bufãr
 *
	macûss_logbufãr
;

147 
	mu£_sy¦og
;

148 
	msy¦og_Ëv–
;

150 
bufãr
 *
	mfÜm©
;

152 
time_t
 
	mÏ¡_g’”©ed_acûs¦og_ts
;

153 
time_t
 *
	mÏ¡_g’”©ed_acûs¦og_ts_±r
;

155 
bufãr
 *
	mts_acûs¦og_¡r
;

157 
fÜm©_f›lds
 *
	m·r£d_fÜm©
;

158 } 
	t¶ugš_cÚfig
;

161 
	mPLUGIN_DATA
;

163 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

164 
¶ugš_cÚfig
 
	mcÚf
;

166 
bufãr
 *
	msy¦og_logbufãr
;

167 } 
	t¶ugš_d©a
;

169 
	$INIT_FUNC
(
mod_acûs¦og_š™
) {

170 
¶ugš_d©a
 *
p
;

172 
p
 = 
	`ÿÎoc
(1, (*p));

173 
p
->
sy¦og_logbufãr
 = 
	`bufãr_š™
();

175  
p
;

176 
	}
}

178 
	$acûs¦og_wr™e_®l
(
£rv”
 *
¤v
, cÚ¡ 
bufãr
 *
f’ame
, 
fd
, cÚ¡ * 
buf
, 
size_t
 
couÁ
) {

179 ià(-1 =ğ
	`wr™e_®l
(
fd
, 
buf
, 
couÁ
)) {

180 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

181 "wr™šg‡cûs logƒÁry faed:", 
f’ame
, 
	`¡»¼Ü
(
”ºo
));

183 
	}
}

185 
	$acûs¦og_­³nd_esÿ³d
(
bufãr
 *
de¡
, bufã¸*
¡r
) {

186 *
±r
, *
¡¬t
, *
’d
;

190 ià(
	`bufãr_¡ršg_is_em±y
(
¡r
)) ;

191 
	`bufãr_¡ršg_´•¬e_­³nd
(
de¡
, 
	`bufãr_¡ršg_Ëngth
(
¡r
));

193 
±r
 = 
¡¬t
 = 
¡r
->±r, 
’d
 = sŒ->±¸+ 
	`bufãr_¡ršg_Ëngth
(str);…tr <ƒnd;…tr++) {

194 cÚ¡ 
c
 = (è*
±r
;

195 ià(
c
 >= ' ' && c <= '~' && c != '"' && c != '\\') {

199 ià(
¡¬t
 < 
±r
) {

200 
	`bufãr_­³nd_¡ršg_Ën
(
de¡
, 
¡¬t
, 
±r
 - start);

202 
¡¬t
 = 
±r
 + 1;

204 
c
) {

206 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\\"");

209 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\\\");

212 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\b");

215 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\n");

218 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\r");

221 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\t");

224 
	`BUFFER_APPEND_STRING_CONST
(
de¡
, "\\v");

228 
hh
[5] = {'\\','x',0,0,0};

229 
h
 = 
c
 / 16;

230 
hh
[2] = (
h
 > 9) ? (h - 10 + 'A') : (h + '0');

231 
h
 = 
c
 % 16;

232 
hh
[3] = (
h
 > 9) ? (h - 10 + 'A') : (h + '0');

233 
	`bufãr_­³nd_¡ršg_Ën
(
de¡
, &
hh
[0], 4);

240 ià(
¡¬t
 < 
’d
) {

241 
	`bufãr_­³nd_¡ršg_Ën
(
de¡
, 
¡¬t
, 
’d
 - start);

243 
	}
}

245 
	$acûs¦og_·r£_fÜm©
(
£rv”
 *
¤v
, 
fÜm©_f›lds
 *
f›lds
, 
bufãr
 *
fÜm©
) {

246 
size_t
 
i
, 
j
, 
k
 = 0, 
¡¬t
 = 0;

248 ià(
	`bufãr_is_em±y
(
fÜm©
))  -1;

250 
i
 = 0; i < 
	`bufãr_¡ršg_Ëngth
(
fÜm©
); i++) {

251 
fÜm©
->
±r
[
i
]) {

253 ià(
i
 > 0 && 
¡¬t
 != i) {

255 ià(
f›lds
->
size
 == 0) {

256 
f›lds
->
size
 = 16;

257 
f›lds
->
u£d
 = 0;

258 
f›lds
->
±r
 = 
	`m®loc
(f›lds->
size
 * (
fÜm©_f›ld
 * ));

259 } ià(
f›lds
->
u£d
 =ğf›lds->
size
) {

260 
f›lds
->
size
 += 16;

261 
f›lds
->
±r
 = 
	`»®loc
(f›lds->±r, f›lds->
size
 * (
fÜm©_f›ld
 * ));

264 
f›lds
->
±r
[f›lds->
u£d
] = 
	`m®loc
((
fÜm©_f›ld
));

265 
f›lds
->
±r
[f›lds->
u£d
]->
ty³
 = 
FIELD_STRING
;

266 
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
 = 
	`bufãr_š™
();

268 
	`bufãr_cİy_¡ršg_Ën
(
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
, 
fÜm©
->±¸+ 
¡¬t
, 
i
 - start);

270 
f›lds
->
u£d
++;

275 ià(
f›lds
->
size
 == 0) {

276 
f›lds
->
size
 = 16;

277 
f›lds
->
u£d
 = 0;

278 
f›lds
->
±r
 = 
	`m®loc
(f›lds->
size
 * (
fÜm©_f›ld
 * ));

279 } ià(
f›lds
->
u£d
 =ğf›lds->
size
) {

280 
f›lds
->
size
 += 16;

281 
f›lds
->
±r
 = 
	`»®loc
(f›lds->±r, f›lds->
size
 * (
fÜm©_f›ld
 * ));

285 
fÜm©
->
±r
[
i
+1]) {

289 ià(
fÜm©
->
±r
[
i
+2] == '\0') {

290 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "%<‡nd %> haveo be followed by‡ format-specifier");

295 
j
 = 0; 
fm­
[j].
key
 != '\0'; j++) {

296 ià(
fm­
[
j
].
key
 !ğ
fÜm©
->
±r
[
i
+2]) ;

300 
f›lds
->
±r
[f›lds->
u£d
] = 
	`m®loc
((
fÜm©_f›ld
));

301 
f›lds
->
±r
[f›lds->
u£d
]->
ty³
 = 
FIELD_FORMAT
;

302 
f›lds
->
±r
[f›lds->
u£d
]->
f›ld
 = 
fm­
[
j
].
ty³
;

303 
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
 = 
NULL
;

304 
f›lds
->
±r
[f›lds->
u£d
]->
İt
 = 0;

306 
f›lds
->
u£d
++;

311 ià(
fm­
[
j
].
key
 == '\0') {

312 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "%<‡nd %> haveo be followed by‡ valid format-specifier");

316 
¡¬t
 = 
i
 + 3;

317 
i
 = 
¡¬t
 - 1;

323 
k
 = 
i
+2; k < 
	`bufãr_¡ršg_Ëngth
(
fÜm©
); k++) {

324 ià(
fÜm©
->
±r
[
k
] == '}') ;

327 ià(
k
 =ğ
	`bufãr_¡ršg_Ëngth
(
fÜm©
)) {

328 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "%{ haso beerminated by‡ }");

333 ià(
fÜm©
->
±r
[
k
+1] == '\0') {

334 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "%{...} haso be followed by‡ format-specifier");

338 ià(
k
 =ğ
i
 + 2) {

339 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "%{...} haso be contain‡ string");

343 
j
 = 0; 
fm­
[j].
key
 != '\0'; j++) {

344 ià(
fm­
[
j
].
key
 !ğ
fÜm©
->
±r
[
k
+1]) ;

348 
f›lds
->
±r
[f›lds->
u£d
] = 
	`m®loc
((
fÜm©_f›ld
));

349 
f›lds
->
±r
[f›lds->
u£d
]->
ty³
 = 
FIELD_FORMAT
;

350 
f›lds
->
±r
[f›lds->
u£d
]->
f›ld
 = 
fm­
[
j
].
ty³
;

351 
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
 = 
	`bufãr_š™
();

352 
f›lds
->
±r
[f›lds->
u£d
]->
İt
 = 0;

354 
	`bufãr_cİy_¡ršg_Ën
(
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
, 
fÜm©
->±¸+ 
i
 + 2, 
k
 - (i + 2));

356 
f›lds
->
u£d
++;

361 ià(
fm­
[
j
].
key
 == '\0') {

362 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "%{...} haso be followed by‡ valid format-specifier");

366 
¡¬t
 = 
k
 + 2;

367 
i
 = 
¡¬t
 - 1;

372 ià(
fÜm©
->
±r
[
i
+1] == '\0') {

373 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "% haso be followed by‡ format-specifier");

377 
j
 = 0; 
fm­
[j].
key
 != '\0'; j++) {

378 ià(
fm­
[
j
].
key
 !ğ
fÜm©
->
±r
[
i
+1]) ;

382 
f›lds
->
±r
[f›lds->
u£d
] = 
	`m®loc
((
fÜm©_f›ld
));

383 
f›lds
->
±r
[f›lds->
u£d
]->
ty³
 = 
FIELD_FORMAT
;

384 
f›lds
->
±r
[f›lds->
u£d
]->
f›ld
 = 
fm­
[
j
].
ty³
;

385 
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
 = 
NULL
;

386 
f›lds
->
±r
[f›lds->
u£d
]->
İt
 = 0;

388 
f›lds
->
u£d
++;

393 ià(
fm­
[
j
].
key
 == '\0') {

394 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "% haso be followed by‡ valid format-specifier");

398 
¡¬t
 = 
i
 + 2;

399 
i
 = 
¡¬t
 - 1;

408 ià(
¡¬t
 < 
i
) {

410 ià(
f›lds
->
size
 == 0) {

411 
f›lds
->
size
 = 16;

412 
f›lds
->
u£d
 = 0;

413 
f›lds
->
±r
 = 
	`m®loc
(f›lds->
size
 * (
fÜm©_f›ld
 * ));

414 } ià(
f›lds
->
u£d
 =ğf›lds->
size
) {

415 
f›lds
->
size
 += 16;

416 
f›lds
->
±r
 = 
	`»®loc
(f›lds->±r, f›lds->
size
 * (
fÜm©_f›ld
 * ));

419 
f›lds
->
±r
[f›lds->
u£d
] = 
	`m®loc
((
fÜm©_f›ld
));

420 
f›lds
->
±r
[f›lds->
u£d
]->
ty³
 = 
FIELD_STRING
;

421 
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
 = 
	`bufãr_š™
();

423 
	`bufãr_cİy_¡ršg_Ën
(
f›lds
->
±r
[f›lds->
u£d
]->
¡ršg
, 
fÜm©
->±¸+ 
¡¬t
, 
i
 - start);

425 
f›lds
->
u£d
++;

429 
	}
}

431 
	$FREE_FUNC
(
mod_acûs¦og_ä“
) {

432 
¶ugš_d©a
 *
p
 = 
p_d
;

433 
size_t
 
i
;

435 ià(!
p
è 
HANDLER_GO_ON
;

437 ià(
p
->
cÚfig_¡Üage
) {

439 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

440 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

442 ià(
NULL
 =ğ
s
) ;

444 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
acûss_logbufãr
)) {

445 ià(
s
->
log_acûss_fd
 != -1) {

446 
	`acûs¦og_wr™e_®l
(
¤v
, 
s
->
acûss_logfe
, s->
log_acûss_fd
, 
	`CONST_BUF_LEN
(s->
acûss_logbufãr
));

450 ià(
s
->
log_acûss_fd
 !ğ-1è
	`şo£
(s->log_access_fd);

452 
	`bufãr_ä“
(
s
->
ts_acûs¦og_¡r
);

453 
	`bufãr_ä“
(
s
->
acûss_logbufãr
);

454 
	`bufãr_ä“
(
s
->
fÜm©
);

455 
	`bufãr_ä“
(
s
->
acûss_logfe
);

457 ià(
s
->
·r£d_fÜm©
) {

458 
size_t
 
j
;

459 
j
 = 0; j < 
s
->
·r£d_fÜm©
->
u£d
; j++) {

460 ià(
s
->
·r£d_fÜm©
->
±r
[
j
]->
¡ršg
è
	`bufãr_ä“
(s->parsed_format->ptr[j]->string);

461 
	`ä“
(
s
->
·r£d_fÜm©
->
±r
[
j
]);

463 
	`ä“
(
s
->
·r£d_fÜm©
->
±r
);

464 
	`ä“
(
s
->
·r£d_fÜm©
);

467 
	`ä“
(
s
);

470 
	`ä“
(
p
->
cÚfig_¡Üage
);

473 ià(
p
->
sy¦og_logbufãr
è
	`bufãr_ä“
(p->syslog_logbuffer);

474 
	`ä“
(
p
);

476  
HANDLER_GO_ON
;

477 
	}
}

479 
	$SETDEFAULTS_FUNC
(
log_acûss_İ’
) {

480 
¶ugš_d©a
 *
p
 = 
p_d
;

481 
size_t
 
i
 = 0;

483 
cÚfig_v®ues_t
 
cv
[] = {

484 { "acûs¦og.f’ame", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

485 { "acûs¦og.u£-sy¦og", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

486 { "acûs¦og.fÜm©", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

487 { "acûs¦og.sy¦og-Ëv–", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

488 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

491 ià(!
p
è 
HANDLER_ERROR
;

493 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

495 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

496 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

497 
¶ugš_cÚfig
 *
s
;

499 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

500 
s
->
acûss_logfe
 = 
	`bufãr_š™
();

501 
s
->
fÜm©
 = 
	`bufãr_š™
();

502 
s
->
acûss_logbufãr
 = 
	`bufãr_š™
();

503 
s
->
ts_acûs¦og_¡r
 = 
	`bufãr_š™
();

504 
s
->
log_acûss_fd
 = -1;

505 
s
->
Ï¡_g’”©ed_acûs¦og_ts
 = 0;

506 
s
->
Ï¡_g’”©ed_acûs¦og_ts_±r
 = &(s->
Ï¡_g’”©ed_acûs¦og_ts
);

507 
s
->
sy¦og_Ëv–
 = 
LOG_INFO
;

510 
cv
[0].
de¡š©iÚ
 = 
s
->
acûss_logfe
;

511 
cv
[1].
de¡š©iÚ
 = &(
s
->
u£_sy¦og
);

512 
cv
[2].
de¡š©iÚ
 = 
s
->
fÜm©
;

513 
cv
[3].
de¡š©iÚ
 = &(
s
->
sy¦og_Ëv–
);

515 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

517 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

518  
HANDLER_ERROR
;

521 ià(
i
 =ğ0 && 
	`bufãr_¡ršg_is_em±y
(
s
->
fÜm©
)) {

524 
	`bufãr_cİy_¡ršg_Ën
(
s
->
fÜm©
, 
	`CONST_STR_LEN
("%h %V %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\""));

529 ià(!
	`bufãr_is_em±y
(
s
->
fÜm©
)) {

530 
size_t
 
j
, 
tcouÁ
 = 0;

532 
s
->
·r£d_fÜm©
 = 
	`ÿÎoc
(1, (*(s->parsed_format)));

534 ià(-1 =ğ
	`acûs¦og_·r£_fÜm©
(
¤v
, 
s
->
·r£d_fÜm©
, s->
fÜm©
)) {

536 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

537 "·rsšg‡cûs¦og-defš™iÚ faed:", 
s
->
fÜm©
);

539  
HANDLER_ERROR
;

542 
j
 = 0; j < 
s
->
·r£d_fÜm©
->
u£d
; ++j) {

543 
fÜm©_f›ld
 * cÚ¡ 
f
 = 
s
->
·r£d_fÜm©
->
±r
[
j
];

544 ià(
FIELD_FORMAT
 !ğ
f
->
ty³
) ;

545 ià(
FORMAT_TIMESTAMP
 =ğ
f
->
f›ld
) {

546 ià(!
	`bufãr_¡ršg_is_em±y
(
f
->
¡ršg
)) {

547 cÚ¡ *
±r
 = 
f
->
¡ršg
->ptr;

548 ià(0 =ğ
	`¡ºcmp
(
±r
, "begin:", ("begin:")-1)) {

549 
f
->
İt
 |ğ
FORMAT_FLAG_TIME_BEGIN
;

550 
±r
 += ("begin:")-1;

551 } ià(0 =ğ
	`¡ºcmp
(
±r
, "end:", ("end:")-1)) {

552 
f
->
İt
 |ğ
FORMAT_FLAG_TIME_END
;

553 
±r
 += ("end:")-1;

555 ià(0 =ğ
	`¡rcmp
(
±r
, "£c")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_SEC
;

556 ià(0 =ğ
	`¡rcmp
(
±r
, "m£c")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_MSEC
;

557 ià(0 =ğ
	`¡rcmp
(
±r
, "u£c")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_USEC
;

558 ià(0 =ğ
	`¡rcmp
(
±r
, "n£c")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_NSEC
;

559 ià(0 =ğ
	`¡rcmp
(
±r
, "m£c_äac")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_MSEC_FRAC
;

560 ià(0 =ğ
	`¡rcmp
(
±r
, "u£c_äac")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_USEC_FRAC
;

561 ià(0 =ğ
	`¡rcmp
(
±r
, "n£c_äac")è
f
->
İt
 |ğ
FORMAT_FLAG_TIME_NSEC_FRAC
;

562 ià(
NULL
 =ğ
	`¡rchr
(
±r
, '%')) {

563 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

564 "cÚ¡ªˆ¡ršg fÜimfÜm© (mis¥–Ëdok’? o¸missšg '%'):", 
s
->
fÜm©
);

566  
HANDLER_ERROR
;

572 ià(!(
f
->
İt
 & ~(
FORMAT_FLAG_TIME_BEGIN
|
FORMAT_FLAG_TIME_END
|
FORMAT_FLAG_TIME_SEC
)è&& ++
tcouÁ
 > 1) {

573 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

574 "you may‚Ù u£ sŒáimtime¡am°fÜm© %{}ˆtwiû iÀth§macûs log:", 
s
->
fÜm©
);

576  
HANDLER_ERROR
;

579 ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_BEGIN
è
¤v
->
¤vcÚf
.
high_´ecisiÚ_time¡amps
 = 1;

580 } ià(
FORMAT_TIME_USED_US
 =ğ
f
->
f›ld
) {

581 
f
->
İt
 |ğ
FORMAT_FLAG_TIME_USEC
;

582 
¤v
->
¤vcÚf
.
high_´ecisiÚ_time¡amps
 = 1;

583 } ià(
FORMAT_TIME_USED
 =ğ
f
->
f›ld
) {

584 ià(
f
->
İt
 & ~(
FORMAT_FLAG_TIME_SEC
)è
¤v
->
¤vcÚf
.
high_´ecisiÚ_time¡amps
 = 1;

586 ià(
	`bufãr_¡ršg_is_em±y
(
f
->
¡ršg
)

587 || 
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("s"))

588 || 
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("£c"))èf->
İt
 |ğ
FORMAT_FLAG_TIME_SEC
;

589 ià(
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("ms"))

590 || 
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("m£c"))èf->
İt
 |ğ
FORMAT_FLAG_TIME_MSEC
;

591 ià(
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("us"))

592 || 
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("u£c"))èf->
İt
 |ğ
FORMAT_FLAG_TIME_USEC
;

593 ià(
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("ns"))

594 || 
	`bufãr_is_equ®_¡ršg
(
f
->
¡ršg
, 
	`CONST_STR_LEN
("n£c"))èf->
İt
 |ğ
FORMAT_FLAG_TIME_NSEC
;

596 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

597 "šv®idimun™ iÀ%{UNIT}T:", 
s
->
fÜm©
);

599  
HANDLER_ERROR
;

601 } ià(
FORMAT_COOKIE
 =ğ
f
->
f›ld
) {

602 ià(
	`bufãr_¡ršg_is_em±y
(
f
->
¡ršg
)èf->
ty³
 = 
FIELD_STRING
;

608 
j
 = 0; j < 
s
->
·r£d_fÜm©
->
u£d
; j++) {

609 
s
->
·r£d_fÜm©
->
±r
[
j
]->
ty³
) {

610 
FIELD_FORMAT
:

611 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssds",

612 "cÚfig:", "fÜm©", 
s
->
·r£d_fÜm©
->
±r
[
j
]->
f›ld
,

613 
s
->
·r£d_fÜm©
->
±r
[
j
]->
¡ršg
 ?

614 
s
->
·r£d_fÜm©
->
±r
[
j
]->
¡ršg
->ptr : "" );

616 
FIELD_STRING
:

617 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbs", "cÚfig:", "¡ršg '", 
s
->
·r£d_fÜm©
->
±r
[
j
]->
¡ršg
, "'");

626 ià(
s
->
u£_sy¦og
) {

631 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
acûss_logfe
)) ;

633 ià(
¤v
->
¤vcÚf
.
´eæight_check
) ;

635 ià(-1 =ğ(
s
->
log_acûss_fd
 = 
	`İ’_logfe_Ü_pe
(
¤v
, s->
acûss_logfe
->
±r
)))

636  
HANDLER_ERROR
;

640  
HANDLER_GO_ON
;

641 
	}
}

643 
	$SIGHUP_FUNC
(
log_acûss_cyşe
) {

644 
¶ugš_d©a
 *
p
 = 
p_d
;

645 
size_t
 
i
;

647 ià(!
p
->
cÚfig_¡Üage
è 
HANDLER_GO_ON
;

649 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

650 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

652 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
acûss_logbufãr
)) {

653 ià(
s
->
log_acûss_fd
 != -1) {

654 
	`acûs¦og_wr™e_®l
(
¤v
, 
s
->
acûss_logfe
, s->
log_acûss_fd
, 
	`CONST_BUF_LEN
(s->
acûss_logbufãr
));

657 
	`bufãr_»£t
(
s
->
acûss_logbufãr
);

660 ià(
s
->
u£_sy¦og
 == 0

661 && !
	`bufãr_¡ršg_is_em±y
(
s
->
acûss_logfe
)

662 && 
s
->
acûss_logfe
->
±r
[0] != '|') {

664 ià(-1 !ğ
s
->
log_acûss_fd
è
	`şo£
(s->log_access_fd);

666 ià(-1 =ğ(
s
->
log_acûss_fd
 =

667 
	`fdev’t_İ’_şÛxec
(
s
->
acûss_logfe
->
±r
, 
O_APPEND
 | 
O_WRONLY
 | 
O_CREAT
 | 
O_LARGEFILE
, 0644))) {

669 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "cyşšg‡cûss-log faed:", 
	`¡»¼Ü
(
”ºo
));

671  
HANDLER_ERROR
;

676  
HANDLER_GO_ON
;

677 
	}
}

679 
	#PATCH
(
x
) \

680 
p
->
cÚf
.
x
 = 
s
->x;

	)

681 
	$mod_acûs¦og_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

682 
size_t
 
i
, 
j
;

683 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

685 
	`PATCH
(
acûss_logfe
);

686 
	`PATCH
(
log_acûss_fd
);

687 
	`PATCH
(
Ï¡_g’”©ed_acûs¦og_ts_±r
);

688 
	`PATCH
(
acûss_logbufãr
);

689 
	`PATCH
(
ts_acûs¦og_¡r
);

690 
	`PATCH
(
·r£d_fÜm©
);

691 
	`PATCH
(
u£_sy¦og
);

692 
	`PATCH
(
sy¦og_Ëv–
);

695 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

696 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

697 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

700 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

703 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

704 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

706 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("accesslog.filename"))) {

707 
	`PATCH
(
acûss_logfe
);

708 
	`PATCH
(
log_acûss_fd
);

709 
	`PATCH
(
acûss_logbufãr
);

710 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("accesslog.format"))) {

711 
	`PATCH
(
·r£d_fÜm©
);

712 
	`PATCH
(
Ï¡_g’”©ed_acûs¦og_ts_±r
);

713 
	`PATCH
(
ts_acûs¦og_¡r
);

714 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("accesslog.use-syslog"))) {

715 
	`PATCH
(
u£_sy¦og
);

716 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("accesslog.syslog-level"))) {

717 
	`PATCH
(
sy¦og_Ëv–
);

723 
	}
}

724 #undeà
PATCH


726 
	$REQUESTDONE_FUNC
(
log_acûss_wr™e
) {

727 
¶ugš_d©a
 *
p
 = 
p_d
;

728 
bufãr
 *
b
;

729 
size_t
 
j
;

731 
Ãwts
 = 0;

732 
d©a_¡ršg
 *
ds
;

733 
time¥ec
 
ts
 = { 0, 0 };

735 
	`mod_acûs¦og_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

738 ià(!
p
->
cÚf
.
u£_sy¦og
 &&…->cÚf.
log_acûss_fd
 =ğ-1è 
HANDLER_GO_ON
;

740 ià(
p
->
cÚf
.
u£_sy¦og
) {

741 
b
 = 
p
->
sy¦og_logbufãr
;

743 
b
 = 
p
->
cÚf
.
acûss_logbufãr
;

746 ià(
	`bufãr_is_em±y
(
b
)) {

747 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 0);

750 
j
 = 0; j < 
p
->
cÚf
.
·r£d_fÜm©
->
u£d
; j++) {

751 cÚ¡ 
fÜm©_f›ld
 * cÚ¡ 
f
 = 
p
->
cÚf
.
·r£d_fÜm©
->
±r
[
j
];

752 
f
->
ty³
) {

753 
FIELD_STRING
:

754 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
f
->
¡ršg
);

756 
FIELD_FORMAT
:

757 
f
->
f›ld
) {

758 
FORMAT_TIMESTAMP
:

760 ià(
f
->
İt
 & ~(
FORMAT_FLAG_TIME_BEGIN
|
FORMAT_FLAG_TIME_END
)) {

761 ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_SEC
) {

762 
time_t
 
t
 = (!(
f
->
İt
 & 
FORMAT_FLAG_TIME_BEGIN
)è? 
¤v
->
cur_ts
 : 
cÚ
->
»que¡_¡¬t
;

763 
	`bufãr_­³nd_št
(
b
, (
štmax_t
)
t
);

764 } ià(
f
->
İt
 & (
FORMAT_FLAG_TIME_MSEC
|
FORMAT_FLAG_TIME_USEC
|
FORMAT_FLAG_TIME_NSEC
)) {

765 
off_t
 
t
;

766 
ns
;

767 ià(!(
f
->
İt
 & 
FORMAT_FLAG_TIME_BEGIN
)) {

768 ià(0 =ğ
ts
.
tv_£c
è
	`log_şock_g‘time_»®time
(&ts);

769 
t
 = (
off_t
)
ts
.
tv_£c
;

770 
ns
 = 
ts
.
tv_n£c
;

772 
t
 = (
off_t
)
cÚ
->
»que¡_¡¬t_hp
.
tv_£c
;

773 
ns
 = 
cÚ
->
»que¡_¡¬t_hp
.
tv_n£c
;

775 ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_MSEC
) {

776 
t
 *= 1000;

777 
t
 +ğ(
ns
 + 999999) / 1000000;

778 } ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_USEC
) {

779 
t
 *= 1000000;

780 
t
 +ğ(
ns
 + 999) / 1000;

782 
t
 *= 1000000000;

783 
t
 +ğ
ns
;

785 
	`bufãr_­³nd_št
(
b
, (
štmax_t
)
t
);

787 
ns
;

788 *
±r
;

789 ià(!(
f
->
İt
 & 
FORMAT_FLAG_TIME_BEGIN
)) {

790 ià(0 =ğ
ts
.
tv_£c
è
	`log_şock_g‘time_»®time
(&ts);

791 
ns
 = 
ts
.
tv_n£c
;

793 
ns
 = 
cÚ
->
»que¡_¡¬t_hp
.
tv_n£c
;

796 ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_MSEC_FRAC
) {

797 
ns
 += 999999;

798 
ns
 /= 1000000;

799 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("000"));

800 } ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_USEC_FRAC
) {

801 
ns
 += 999;

802 
ns
 /= 1000;

803 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("000000"));

805 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("000000000"));

807 
±r
 = 
b
->±¸+ 
	`bufãr_¡ršg_Ëngth
(b); 
ns
 > 0;‚s /= 10)

808 *--
±r
 = (
ns
 % 10) + '0';

810 } ià(!(
f
->
İt
 & 
FORMAT_FLAG_TIME_BEGIN
è&& 
¤v
->
cur_ts
 =ğ*(
p
->
cÚf
.
Ï¡_g’”©ed_acûs¦og_ts_±r
)) {

811 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
p
->
cÚf
.
ts_acûs¦og_¡r
);

814 
tm
 *
tm±r
;

815 
time_t
 
t
;

816 #ià
	`defšed
(
HAVE_STRUCT_TM_GMTOFF
)

817 #ifdeà
HAVE_LOCALTIME_R


818 
tm
m;

821 #ifdeà
HAVE_GMTIME_R


822 
tm
m;

826 ià(!(
f
->
İt
 & 
FORMAT_FLAG_TIME_BEGIN
)) {

827 
t
 = *(
p
->
cÚf
.
Ï¡_g’”©ed_acûs¦og_ts_±r
èğ
¤v
->
cur_ts
;

828 
Ãwts
 = 1;

830 
t
 = 
cÚ
->
»que¡_¡¬t
;

833 #ià
	`defšed
(
HAVE_STRUCT_TM_GMTOFF
)

834 #ifdeà
HAVE_LOCALTIME_R


835 
tm±r
 = 
	`loÿÉime_r
(&
t
, &
tm
);

837 
tm±r
 = 
	`loÿÉime
(&
t
);

840 #ifdeà
HAVE_GMTIME_R


841 
tm±r
 = 
	`gmtime_r
(&
t
, &
tm
);

843 
tm±r
 = 
	`gmtime
(&
t
);

847 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 255);

849 ià(
	`bufãr_¡ršg_is_em±y
(
f
->
¡ršg
)) {

850 #ià
	`defšed
(
HAVE_STRUCT_TM_GMTOFF
)

851 
scd
, 
hrs
, 
mš
;

852 
	`bufãr_­³nd_¡ráime
(
p
->
cÚf
.
ts_acûs¦og_¡r
, "[%d/%b/%Y:%H:%M:%S ", 
tm±r
);

853 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
tm±r
->
tm_gmtoff
 >= 0 ? "+" : "-", 1);

855 
scd
 = 
	`Ïbs
(
tm±r
->
tm_gmtoff
);

856 
hrs
 = 
scd
 / 3600;

857 
mš
 = (
scd
 % 3600) / 60;

860 ià(
hrs
 < 10è
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
	`CONST_STR_LEN
("0"));

861 
	`bufãr_­³nd_št
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
hrs
);

863 ià(
mš
 < 10è
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
	`CONST_STR_LEN
("0"));

864 
	`bufãr_­³nd_št
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
mš
);

865 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
	`CONST_STR_LEN
("]"));

867 
	`bufãr_­³nd_¡ráime
(
p
->
cÚf
.
ts_acûs¦og_¡r
, "[%d/%b/%Y:%H:%M:%S +0000]", 
tm±r
);

870 
	`bufãr_­³nd_¡ráime
(
p
->
cÚf
.
ts_acûs¦og_¡r
, 
f
->
¡ršg
->
±r
, 
tm±r
);

873 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
p
->
cÚf
.
ts_acûs¦og_¡r
);

876 
FORMAT_TIME_USED
:

877 
FORMAT_TIME_USED_US
:

878 ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_SEC
) {

879 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cur_ts
 - 
cÚ
->
»que¡_¡¬t
);

881 cÚ¡ 
time¥ec
 * cÚ¡ 
bs
 = &
cÚ
->
»que¡_¡¬t_hp
;

882 
off_t
 
tdiff
;

883 ià(0 =ğ
ts
.
tv_£c
è
	`log_şock_g‘time_»®time
(&ts);

884 
tdiff
 = (
off_t
)(
ts
.
tv_£c
 - 
bs
->tv_£c)*1000000000 + (ts.
tv_n£c
 - bs->tv_nsec);

885 ià(
tdiff
 <= 0) {

888 
tdiff
 = -1;

889 } ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_MSEC
) {

890 
tdiff
 += 999999;

891 
tdiff
 /= 1000000;

892 } ià(
f
->
İt
 & 
FORMAT_FLAG_TIME_USEC
) {

893 
tdiff
 += 999;

894 
tdiff
 /= 1000;

896 
	`bufãr_­³nd_št
(
b
, (
štmax_t
)
tdiff
);

899 
FORMAT_REMOTE_ADDR
:

900 
FORMAT_REMOTE_HOST
:

901 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
d¡_addr_buf
);

903 
FORMAT_REMOTE_IDENT
:

905 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

907 
FORMAT_REMOTE_USER
:

908 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "REMOTE_USER")è&& !
	`bufãr_¡ršg_is_em±y
(ds->
v®ue
)) {

909 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
ds
->
v®ue
);

911 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

914 
FORMAT_REQUEST_LINE
:

915 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
»que¡_lše
)) {

916 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
cÚ
->
»que¡
.
»que¡_lše
);

919 
FORMAT_STATUS
:

920 
	`bufãr_­³nd_št
(
b
, 
cÚ
->
h‰p_¡©us
);

923 
FORMAT_BYTES_OUT_NO_HEADER
:

924 ià(
cÚ
->
by‹s_wr™‹n
 > 0) {

925 
	`bufãr_­³nd_št
(
b
,

926 
cÚ
->
by‹s_wr™‹n
 - cÚ->
by‹s_h—d”
 <= 0 ? 0 : con->bytes_written - con->bytes_header);

928 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

931 
FORMAT_HEADER
:

932 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
f
->
¡ršg
->
±r
))) {

933 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
ds
->
v®ue
);

935 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

938 
FORMAT_RESPONSE_HEADER
:

939 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
f
->
¡ršg
->
±r
))) {

940 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
ds
->
v®ue
);

942 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

945 
FORMAT_ENV
:

946 
FORMAT_NOTE
:

947 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, 
f
->
¡ršg
->
±r
))) {

948 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
ds
->
v®ue
);

950 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

953 
FORMAT_FILENAME
:

954 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
physiÿl
.
·th
)) {

955 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
physiÿl
.
·th
);

957 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

960 
FORMAT_BYTES_OUT
:

961 ià(
cÚ
->
by‹s_wr™‹n
 > 0) {

962 
	`bufãr_­³nd_št
(
b
, 
cÚ
->
by‹s_wr™‹n
);

964 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

967 
FORMAT_BYTES_IN
:

968 ià(
cÚ
->
by‹s_»ad
 > 0) {

969 
	`bufãr_­³nd_št
(
b
, 
cÚ
->
by‹s_»ad
);

971 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

974 
FORMAT_SERVER_NAME
:

975 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
£rv”_Çme
)) {

976 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
£rv”_Çme
);

978 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

981 
FORMAT_HTTP_HOST
:

982 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
authÜ™y
)) {

983 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
cÚ
->
uri
.
authÜ™y
);

985 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

988 
FORMAT_REQUEST_PROTOCOL
:

989 
	`bufãr_­³nd_¡ršg_Ën
(
b
,

990 
cÚ
->
»que¡
.
h‰p_v”siÚ
 =ğ
HTTP_VERSION_1_1
 ? "HTTP/1.1" : "HTTP/1.0", 8);

992 
FORMAT_REQUEST_METHOD
:

993 
	`bufãr_­³nd_¡ršg
(
b
, 
	`g‘_h‰p_m‘hod_Çme
(
cÚ
->
»que¡
.
h‰p_m‘hod
));

995 
FORMAT_PERCENT
:

996 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("%"));

998 
FORMAT_LOCAL_ADDR
:

1002 cÚ¡ *
cŞÚ
;

1003 
bufãr
 *
¤vtok’
 = 
cÚ
->
¤v_sock‘
->
¤v_tok’
;

1004 ià(
¤vtok’
->
±r
[0] == '[') {

1005 
cŞÚ
 = 
	`¡r¡r
(
¤vtok’
->
±r
, "]:");

1007 
cŞÚ
 = 
	`¡rchr
(
¤vtok’
->
±r
, ':');

1009 ià(
cŞÚ
) {

1010 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
¤vtok’
->
±r
, (
size_t
)(
cŞÚ
 - srvtoken->ptr));

1012 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
¤vtok’
);

1016 
FORMAT_SERVER_PORT
:

1018 cÚ¡ *
cŞÚ
;

1019 
bufãr
 *
¤vtok’
 = ((
£rv”_sock‘
*)(
cÚ
->
¤v_sock‘
))->
¤v_tok’
;

1020 ià(
¤vtok’
->
±r
[0] == '[') {

1021 
cŞÚ
 = 
	`¡r¡r
(
¤vtok’
->
±r
, "]:");

1023 
cŞÚ
 = 
	`¡rchr
(
¤vtok’
->
±r
, ':');

1025 ià(
cŞÚ
) {

1026 
	`bufãr_­³nd_¡ršg
(
b
, 
cŞÚ
+1);

1028 
	`bufãr_­³nd_št
(
b
, 
¤v
->
¤vcÚf
.
pÜt
);

1032 
FORMAT_QUERY_STRING
:

1033 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
cÚ
->
uri
.
qu”y
);

1035 
FORMAT_URL
:

1036 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
cÚ
->
uri
.
·th_¿w
);

1038 
FORMAT_CONNECTION_STATUS
:

1039 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_RESPONSE_END
) {

1040 ià(0 =ğ
cÚ
->
k“p_®ive
) {

1041 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("-"));

1043 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("+"));

1046 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("X"));

1049 
FORMAT_KEEPALIVE_COUNT
:

1050 ià(
cÚ
->
»que¡_couÁ
 > 1) {

1051 
	`bufãr_­³nd_št
(
b
, (
štmax_t
)(
cÚ
->
»que¡_couÁ
-1));

1053 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("0"));

1056 
FORMAT_COOKIE
:

1057 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Cookie"))) {

1058 *
¡r
 = 
ds
->
v®ue
->
±r
;

1059 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
f
->
¡ršg
);

1061 *
¡r
 == ' ' || *str == '\t') ++str;

1062 ià(0 =ğ
	`¡ºcmp
(
¡r
, 
f
->
¡ršg
->
±r
, 
Ën
) && str[len] == '=') {

1063 *
v
 = 
¡r
+
Ën
+1;

1064 
bufãr
 *
b¡r
;

1065 
¡r
 = 
v
; *str != '\0' && *str != ';'; ++str) ;

1066 ià(
¡r
 =ğ
v
) ;

1067 dØ{ --
¡r
; } ¡¸> 
v
 && (*str == ' ' || *str == '\t'));

1068 
b¡r
 = 
	`bufãr_š™
();

1069 
	`bufãr_cİy_¡ršg_Ën
(
b¡r
, 
v
, 
¡r
 - v + 1);

1070 
	`acûs¦og_­³nd_esÿ³d
(
b
, 
b¡r
);

1071 
	`bufãr_ä“
(
b¡r
);

1074 dØ{ ++
¡r
; } *str != ' ' && *str != '\t' && *str != '\0');

1076 *
¡r
 == ' ' || *str == '\t') ++str;

1077 } *
¡r
++ == ';');

1089 ià(
p
->
cÚf
.
u£_sy¦og
) {

1090 #ifdeà
HAVE_SYSLOG_H


1091 ià(!
	`bufãr_¡ršg_is_em±y
(
b
)) {

1093 
	`sy¦og
(
p
->
cÚf
.
sy¦og_Ëv–
, "%s", 
b
->
±r
);

1094 
	`bufãr_»£t
(
b
);

1097  
HANDLER_GO_ON
;

1100 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

1102 ià((!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
acûss_logfe
è&&…->cÚf.acûss_logfe->
±r
[0] == '|') ||

1103 
Ãwts
 ||

1104 
	`bufãr_¡ršg_Ëngth
(
b
è>ğ
BUFFER_MAX_REUSE_SIZE
) {

1105 ià(
p
->
cÚf
.
log_acûss_fd
 >= 0) {

1106 
	`acûs¦og_wr™e_®l
(
¤v
, 
p
->
cÚf
.
acûss_logfe
,…->cÚf.
log_acûss_fd
, 
	`CONST_BUF_LEN
(
b
));

1108 
	`bufãr_»£t
(
b
);

1111  
HANDLER_GO_ON
;

1112 
	}
}

1115 
mod_acûs¦og_¶ugš_š™
(
¶ugš
 *
p
);

1116 
	$mod_acûs¦og_¶ugš_š™
(
¶ugš
 *
p
) {

1117 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1118 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("accesslog");

1120 
p
->
š™
 = 
mod_acûs¦og_š™
;

1121 
p
->
£t_deçuÉs
ğ
log_acûss_İ’
;

1122 
p
->
ş—nup
 = 
mod_acûs¦og_ä“
;

1124 
p
->
hªdË_»que¡_dÚe
 = 
log_acûss_wr™e
;

1125 
p
->
hªdË_sighup
 = 
log_acûss_cyşe
;

1127 
p
->
d©a
 = 
NULL
;

1130 
	}
}

	@mod_alias.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~<ùy³.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dio.h
>

16 
¬¿y
 *
	m®Ÿs
;

17 } 
	t¶ugš_cÚfig
;

20 
	mPLUGIN_DATA
;

22 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

24 
¶ugš_cÚfig
 
	mcÚf
;

25 } 
	t¶ugš_d©a
;

28 
	$INIT_FUNC
(
mod_®Ÿs_š™
) {

29 
¶ugš_d©a
 *
p
;

31 
p
 = 
	`ÿÎoc
(1, (*p));

35  
p
;

36 
	}
}

39 
	$FREE_FUNC
(
mod_®Ÿs_ä“
) {

40 
¶ugš_d©a
 *
p
 = 
p_d
;

42 ià(!
p
è 
HANDLER_GO_ON
;

44 ià(
p
->
cÚfig_¡Üage
) {

45 
size_t
 
i
;

47 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

48 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

50 ià(
NULL
 =ğ
s
) ;

52 
	`¬¿y_ä“
(
s
->
®Ÿs
);

54 
	`ä“
(
s
);

56 
	`ä“
(
p
->
cÚfig_¡Üage
);

59 
	`ä“
(
p
);

61  
HANDLER_GO_ON
;

62 
	}
}

66 
	$SETDEFAULTS_FUNC
(
mod_®Ÿs_£t_deçuÉs
) {

67 
¶ugš_d©a
 *
p
 = 
p_d
;

68 
size_t
 
i
 = 0;

70 
cÚfig_v®ues_t
 
cv
[] = {

71 { "®Ÿs.u¾", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

72 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

75 ià(!
p
è 
HANDLER_ERROR
;

77 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

79 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

80 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

81 
¶ugš_cÚfig
 *
s
;

83 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

84 
s
->
®Ÿs
 = 
	`¬¿y_š™
();

85 
cv
[0].
de¡š©iÚ
 = 
s
->
®Ÿs
;

87 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

89 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

90  
HANDLER_ERROR
;

92 ià(
s
->
®Ÿs
->
u£d
 >= 2) {

93 cÚ¡ 
¬¿y
 *
a
 = 
s
->
®Ÿs
;

94 
size_t
 
j
, 
k
;

96 
j
 = 0; j < 
a
->
u£d
; j ++) {

97 cÚ¡ 
bufãr
 *
´efix
 = 
a
->
d©a
[a->
sÜ‹d
[
j
]]->
key
;

98 
k
 = 
j
 + 1; k < 
a
->
u£d
; k ++) {

99 cÚ¡ 
bufãr
 *
key
 = 
a
->
d©a
[a->
sÜ‹d
[
k
]]->key;

101 ià(
	`bufãr_¡ršg_Ëngth
(
key
è< bufãr_¡ršg_Ëngth(
´efix
)) {

104 ià(
	`memcmp
(
key
->
±r
, 
´efix
->±r, 
	`bufãr_¡ršg_Ëngth
(prefix)) != 0) {

108 ià(
a
->
sÜ‹d
[
j
] <‡->sÜ‹d[
k
]) {

109 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBSBS",

110 "u¾.®Ÿs: `", 
key
, "' wÈÃv” m©ch‡ `", 
´efix
, "' matched first");

111  
HANDLER_ERROR
;

118  
HANDLER_GO_ON
;

119 
	}
}

121 
	#PATCH
(
x
) \

122 
p
->
cÚf
.
x
 = 
s
->x;

	)

123 
	$mod_®Ÿs_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

124 
size_t
 
i
, 
j
;

125 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

127 
	`PATCH
(
®Ÿs
);

130 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

131 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

132 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

135 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

138 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

139 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

141 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("alias.url"))) {

142 
	`PATCH
(
®Ÿs
);

148 
	}
}

149 #undeà
PATCH


151 
	$PHYSICALPATH_FUNC
(
mod_®Ÿs_physiÿl_hªdËr
) {

152 
¶ugš_d©a
 *
p
 = 
p_d
;

153 
uri_Ën
, 
ba£dœ_Ën
;

154 *
uri_±r
;

155 
size_t
 
k
;

157 ià(
	`bufãr_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

159 
	`mod_®Ÿs_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

162 
ba£dœ_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
physiÿl
.
ba£dœ
);

163 ià('/' =ğ
cÚ
->
physiÿl
.
ba£dœ
->
±r
[
ba£dœ_Ën
-1]) --basedir_len;

164 
uri_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
physiÿl
.
·th
è- 
ba£dœ_Ën
;

165 
uri_±r
 = 
cÚ
->
physiÿl
.
·th
->
±r
 + 
ba£dœ_Ën
;

167 
k
 = 0; k < 
p
->
cÚf
.
®Ÿs
->
u£d
; k++) {

168 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
®Ÿs
->
d©a
[
k
];

169 
®Ÿs_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
key
);

171 ià(
®Ÿs_Ën
 > 
uri_Ën
) ;

172 ià(
	`bufãr_is_em±y
(
ds
->
key
)) ;

174 ià(0 =ğ(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
 ?

175 
	`¡ºÿ£cmp
(
uri_±r
, 
ds
->
key
->
±r
, 
®Ÿs_Ën
) :

176 
	`¡ºcmp
(
uri_±r
, 
ds
->
key
->
±r
, 
®Ÿs_Ën
))) {

179 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
ba£dœ
, 
ds
->
v®ue
);

180 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
ds
->
v®ue
);

181 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
uri_±r
 + 
®Ÿs_Ën
);

182 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
¤v
->
tmp_buf
);

184  
HANDLER_GO_ON
;

189  
HANDLER_GO_ON
;

190 
	}
}

194 
mod_®Ÿs_¶ugš_š™
(
¶ugš
 *
p
);

195 
	$mod_®Ÿs_¶ugš_š™
(
¶ugš
 *
p
) {

196 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

197 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("alias");

199 
p
->
š™
 = 
mod_®Ÿs_š™
;

200 
p
->
hªdË_physiÿl
ğ
mod_®Ÿs_physiÿl_hªdËr
;

201 
p
->
£t_deçuÉs
 = 
mod_®Ÿs_£t_deçuÉs
;

202 
p
->
ş—nup
 = 
mod_®Ÿs_ä“
;

204 
p
->
d©a
 = 
NULL
;

207 
	}
}

	@mod_auth.c

1 
	~"fœ¡.h
"

3 
	~"¶ugš.h
"

4 
	~"h‰p_auth.h
"

5 
	~"log.h
"

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

16 
¬¿y
 *
	mauth_»quœe
;

17 
bufãr
 *
	mauth_back’d_cÚf
;

20 cÚ¡ 
h‰p_auth_back’d_t
 *
	mauth_back’d
;

21 } 
	t¶ugš_cÚfig
;

24 
	mPLUGIN_DATA
;

26 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

28 
¶ugš_cÚfig
 
	mcÚf
;

29 } 
	t¶ugš_d©a
;

31 
hªdËr_t
 
mod_auth_check_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
);

32 
hªdËr_t
 
mod_auth_check_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
);

33 
hªdËr_t
 
mod_auth_check_ex‹º
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
);

35 
	$INIT_FUNC
(
mod_auth_š™
) {

36 cÚ¡ 
h‰p_auth_scheme_t
 
h‰p_auth_scheme_basic
 = { "basic", 
mod_auth_check_basic
, 
NULL
 };

37 cÚ¡ 
h‰p_auth_scheme_t
 
h‰p_auth_scheme_dige¡
 = { "dige¡", 
mod_auth_check_dige¡
, 
NULL
 };

38 cÚ¡ 
h‰p_auth_scheme_t
 
h‰p_auth_scheme_ex‹º
 = { "ex‹º", 
mod_auth_check_ex‹º
, 
NULL
 };

39 
¶ugš_d©a
 *
p
;

42 
	`h‰p_auth_scheme_£t
(&
h‰p_auth_scheme_basic
);

43 
	`h‰p_auth_scheme_£t
(&
h‰p_auth_scheme_dige¡
);

44 
	`h‰p_auth_scheme_£t
(&
h‰p_auth_scheme_ex‹º
);

46 
p
 = 
	`ÿÎoc
(1, (*p));

48  
p
;

49 
	}
}

51 
	$FREE_FUNC
(
mod_auth_ä“
) {

52 
¶ugš_d©a
 *
p
 = 
p_d
;

54 
	`UNUSED
(
¤v
);

56 ià(!
p
è 
HANDLER_GO_ON
;

58 ià(
p
->
cÚfig_¡Üage
) {

59 
size_t
 
i
;

60 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

61 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

63 ià(
NULL
 =ğ
s
) ;

65 
	`¬¿y_ä“
(
s
->
auth_»quœe
);

66 
	`bufãr_ä“
(
s
->
auth_back’d_cÚf
);

68 
	`ä“
(
s
);

70 
	`ä“
(
p
->
cÚfig_¡Üage
);

73 
	`ä“
(
p
);

75  
HANDLER_GO_ON
;

76 
	}
}

81 
	mDATA_UNSET
;

82 
h‰p_auth_»quœe_t
 *
	m»quœe
;

83 } 
	td©a_auth
;

85 
	$d©a_auth_ä“
(
d©a_un£t
 *
d
)

87 
d©a_auth
 * cÚ¡ 
dauth
 = (d©a_auth *)
d
;

88 
	`bufãr_ä“
(
dauth
->
key
);

89 
	`h‰p_auth_»quœe_ä“
(
dauth
->
»quœe
);

90 
	`ä“
(
dauth
);

91 
	}
}

93 
d©a_auth
 *
	$d©a_auth_š™
()

95 
d©a_auth
 * cÚ¡ 
dauth
 = 
	`ÿÎoc
(1, (*dauth));

96 
	`fÜû_as£¹
(
NULL
 !ğ
dauth
);

97 
dauth
->
cİy
 = 
NULL
;

98 
dauth
->
ä“
 = 
d©a_auth_ä“
;

99 
dauth
->
»£t
 = 
NULL
;

100 
dauth
->
š£¹_dup
 = 
NULL
;

101 
dauth
->
´št
 = 
NULL
;

102 
dauth
->
ty³
 = 
TYPE_OTHER
;

104 
dauth
->
key
 = 
	`bufãr_š™
();

105 
dauth
->
»quœe
 = 
	`h‰p_auth_»quœe_š™
();

107  
dauth
;

108 
	}
}

110 
	$mod_auth_»quœe_·r£
 (
£rv”
 *
¤v
, 
h‰p_auth_»quœe_t
 * cÚ¡ 
»quœe
, cÚ¡ 
bufãr
 *
b
)

114 cÚ¡ *
¡r
 = 
b
->
±r
;

115 cÚ¡ *
p
;

117 ià(
	`bufãr_is_equ®_¡ršg
(
b
, 
	`CONST_STR_LEN
("valid-user"))) {

118 
»quœe
->
v®id_u£r
 = 1;

123 cÚ¡ *
eq
;

124 
size_t
 
Ën
;

125 
p
 = 
	`¡rchr
(
¡r
, '|');

126 
Ën
 = 
NULL
 !ğ
p
 ? (
size_t
)Õ - 
¡r
è: 
	`¡¾’
(str);

127 
eq
 = 
	`memchr
(
¡r
, '=', 
Ën
);

128 ià(
NULL
 =ğ
eq
) {

129 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbss",

132 "”rÜ v®ue:", 
b
, "”rÜ‚—r:", 
¡r
);

135 ià(
p
-1 =ğ
eq
) {

136 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbss",

139 "”rÜ v®ue:", 
b
, "”rÜ‚—r:", 
¡r
);

143 ()(
eq
 - 
¡r
)) {

145 ià(0 =ğ
	`memcmp
(
¡r
, 
	`CONST_STR_LEN
("user"))) {

146 
d©a_¡ršg
 *
ds
 = 
	`d©a_¡ršg_š™
();

147 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
,
¡r
+5,
Ën
-5);

148 
	`¬¿y_š£¹_unique
(
»quœe
->
u£r
, (
d©a_un£t
 *)
ds
);

151 ià(0 =ğ
	`memcmp
(
¡r
, 
	`CONST_STR_LEN
("host"))) {

152 
d©a_¡ršg
 *
ds
 = 
	`d©a_¡ršg_š™
();

153 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
,
¡r
+5,
Ën
-5);

154 
	`¬¿y_š£¹_unique
(
»quœe
->
ho¡
, (
d©a_un£t
 *)
ds
);

155 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb",

157 "f›ld v®ue:", 
b
);

162 ià(0 =ğ
	`memcmp
(
¡r
, 
	`CONST_STR_LEN
("group"))) {

163 
d©a_¡ršg
 *
ds
 = 
	`d©a_¡ršg_š™
();

164 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
,
¡r
+6,
Ën
-6);

165 
	`¬¿y_š£¹_unique
(
»quœe
->
group
, (
d©a_un£t
 *)
ds
);

166 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb",

168 "f›ld v®ue:", 
b
);

173 ià(0 =ğ
	`memcmp
(
¡r
, 
	`CONST_STR_LEN
("valid-user"))) {

174 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssb",

177 "”rÜ v®ue:", 
b
);

185 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbss",

188 "”rÜ v®ue:", 
b
, "”rÜ‚—r:", 
¡r
);

191 } 
p
 && *((
¡r
 =…+1)));

194 
	}
}

196 
	$SETDEFAULTS_FUNC
(
mod_auth_£t_deçuÉs
) {

197 
¶ugš_d©a
 *
p
 = 
p_d
;

198 
size_t
 
i
;

200 
cÚfig_v®ues_t
 
cv
[] = {

201 { "auth.back’d", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

202 { "auth.»quœe", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

203 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

206 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

208 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

209 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

210 
¶ugš_cÚfig
 *
s
;

211 
size_t
 
n
;

212 
d©a_¬¿y
 *
da
;

214 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

215 
s
->
auth_back’d_cÚf
 = 
	`bufãr_š™
();

217 
s
->
auth_»quœe
 = 
	`¬¿y_š™
();

219 
cv
[0].
de¡š©iÚ
 = 
s
->
auth_back’d_cÚf
;

220 
cv
[1].
de¡š©iÚ
 = 
s
->
auth_»quœe
;

222 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

224 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

225  
HANDLER_ERROR
;

228 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
auth_back’d_cÚf
)) {

229 
s
->
auth_back’d
 = 
	`h‰p_auth_back’d_g‘
(s->
auth_back’d_cÚf
);

230 ià(
NULL
 =ğ
s
->
auth_back’d
) {

231 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "auth.back’d‚Ù suµÜ‹d:", 
s
->
auth_back’d_cÚf
);

233  
HANDLER_ERROR
;

238 ià(
NULL
 =ğ(
da
 = (
d©a_¬¿y
 *)
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "auth.require"))) ;

240 ià(
da
->
ty³
 !ğ
TYPE_ARRAY
) ;

242 
n
 = 0;‚ < 
da
->
v®ue
->
u£d
;‚++) {

243 
size_t
 
m
;

244 
d©a_¬¿y
 *
da_fe
 = (d©a_¬¿y *)
da
->
v®ue
->
d©a
[
n
];

245 cÚ¡ 
bufãr
 *
m‘hod
 = 
NULL
, *
»®m
 = NULL, *
»quœe
 = NULL;

246 cÚ¡ 
h‰p_auth_scheme_t
 *
auth_scheme
;

248 ià(
da
->
v®ue
->
d©a
[
n
]->
ty³
 !ğ
TYPE_ARRAY
) {

249 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

253  
HANDLER_ERROR
;

256 
m
 = 0; m < 
da_fe
->
v®ue
->
u£d
; m++) {

257 ià(
da_fe
->
v®ue
->
d©a
[
m
]->
ty³
 =ğ
TYPE_STRING
) {

258 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
da_fe
->
v®ue
->
d©a
[
m
];

259 ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("method"))) {

260 
m‘hod
 = 
ds
->
v®ue
;

261 } ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("realm"))) {

262 
»®m
 = 
ds
->
v®ue
;

263 } ià(
	`bufãr_is_equ®_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("require"))) {

264 
»quœe
 = 
ds
->
v®ue
;

266 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbs",

269 
da_fe
->
v®ue
->
d©a
[
m
]->
key
,

272  
HANDLER_ERROR
;

275 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbs",

278 
da_fe
->
v®ue
->
d©a
[
m
]->
key
,

281  
HANDLER_ERROR
;

285 ià(
	`bufãr_¡ršg_is_em±y
(
m‘hod
)) {

286 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

289  
HANDLER_ERROR
;

291 
auth_scheme
 = 
	`h‰p_auth_scheme_g‘
(
m‘hod
);

292 ià(
NULL
 =ğ
auth_scheme
) {

293 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

294 "unknowÀm‘hod", 
m‘hod
, "(e.g. \"basic\", \"digest\" or \"extern\") in",

296  
HANDLER_ERROR
;

300 ià(
	`bufãr_is_em±y
(
»®m
)) {

301 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

304  
HANDLER_ERROR
;

307 ià(
	`bufãr_¡ršg_is_em±y
(
»quœe
)) {

308 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

311  
HANDLER_ERROR
;

314 ià(
»quœe
) {

315 
d©a_auth
 * cÚ¡ 
dauth
 = 
	`d©a_auth_š™
();

316 
	`bufãr_cİy_bufãr
(
dauth
->
key
, 
da_fe
->key);

317 
dauth
->
»quœe
->
scheme
 = 
auth_scheme
;

318 
	`bufãr_cİy_bufãr
(
dauth
->
»quœe
->
»®m
,„ealm);

319 ià(!
	`mod_auth_»quœe_·r£
(
¤v
, 
dauth
->
»quœe
,„equire)) {

320 
dauth
->
	`ä“
((
d©a_un£t
 *)dauth);

321  
HANDLER_ERROR
;

323 
	`¬¿y_š£¹_unique
(
s
->
auth_»quœe
, (
d©a_un£t
 *)
dauth
);

328  
HANDLER_GO_ON
;

329 
	}
}

331 
	#PATCH
(
x
) \

332 
p
->
cÚf
.
x
 = 
s
->x;

	)

333 
	$mod_auth_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

334 
size_t
 
i
, 
j
;

335 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

337 
	`PATCH
(
auth_back’d
);

338 
	`PATCH
(
auth_»quœe
);

341 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

342 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

343 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

346 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

349 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

350 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

352 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend"))) {

353 
	`PATCH
(
auth_back’d
);

354 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.require"))) {

355 
	`PATCH
(
auth_»quœe
);

361 
	}
}

362 #undeà
PATCH


364 
hªdËr_t
 
	$mod_auth_uri_hªdËr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

365 
size_t
 
k
;

366 
¶ugš_d©a
 *
p
 = 
p_d
;

368 
	`mod_auth_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

370 ià(
p
->
cÚf
.
auth_»quœe
 =ğ
NULL
è 
HANDLER_GO_ON
;

373 
k
 = 0; k < 
p
->
cÚf
.
auth_»quœe
->
u£d
; k++) {

374 cÚ¡ 
d©a_auth
 * cÚ¡ 
dauth
 = (d©a_auth *)
p
->
cÚf
.
auth_»quœe
->
d©a
[
k
];

375 cÚ¡ 
bufãr
 *
·th
 = 
dauth
->
key
;

377 ià(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
) < buffer_string_length(path)) ;

381 ià(!
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames


382 ? 0 =ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
,…©h->±r, 
	`bufãr_¡ršg_Ëngth
(path))

383 : 0 =ğ
	`¡ºÿ£cmp
(
cÚ
->
uri
.
·th
->
±r
,…©h->±r, 
	`bufãr_¡ršg_Ëngth
(path))) {

384 cÚ¡ 
h‰p_auth_scheme_t
 * cÚ¡ 
scheme
 = 
dauth
->
»quœe
->scheme;

385  
scheme
->
	`checkâ
(
¤v
, 
cÚ
, scheme->
p_d
, 
dauth
->
»quœe
, 
p
->
cÚf
.
auth_back’d
);

390  
HANDLER_GO_ON
;

391 
	}
}

393 
mod_auth_¶ugš_š™
(
¶ugš
 *
p
);

394 
	$mod_auth_¶ugš_š™
(
¶ugš
 *
p
) {

395 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

396 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("auth");

397 
p
->
š™
 = 
mod_auth_š™
;

398 
p
->
£t_deçuÉs
 = 
mod_auth_£t_deçuÉs
;

399 
p
->
hªdË_uri_ş—n
 = 
mod_auth_uri_hªdËr
;

400 
p
->
ş—nup
 = 
mod_auth_ä“
;

402 
p
->
d©a
 = 
NULL
;

405 
	}
}

416 
	~"»¥Ú£.h
"

417 
	~"ba£64.h
"

418 
	~"md5.h
"

419 
	~"¿nd.h
"

421 
hªdËr_t
 
	$mod_auth_£nd_400_bad_»que¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

422 
	`UNUSED
(
¤v
);

425 
cÚ
->
h‰p_¡©us
 = 400;

426 
cÚ
->
mode
 = 
DIRECT
;

428  
HANDLER_FINISHED
;

429 
	}
}

431 
hªdËr_t
 
	$mod_auth_£nd_401_uÇuthÜized_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
»®m
) {

432 
cÚ
->
h‰p_¡©us
 = 401;

433 
cÚ
->
mode
 = 
DIRECT
;

435 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("Basic„ealm=\""));

436 
	`bufãr_­³nd_¡ršg_bufãr
(
¤v
->
tmp_buf
, 
»®m
);

437 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("\", charset=\"UTF-8\""));

439 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("WWW-Auth’tiÿ‹"), 
	`CONST_BUF_LEN
(¤v->
tmp_buf
));

441  
HANDLER_FINISHED
;

442 
	}
}

444 
hªdËr_t
 
	$mod_auth_check_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
) {

445 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Authorization");

446 
bufãr
 *
u£ºame
;

447 
bufãr
 *
b
;

448 *
pw
;

449 
hªdËr_t
 
rc
 = 
HANDLER_UNSET
;

451 
	`UNUSED
(
p_d
);

453 ià(
NULL
 =ğ
back’d
) {

454 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "auth.back’d‚Ù cÚfigu»d fÜ", 
cÚ
->
uri
.
·th
);

455 
cÚ
->
h‰p_¡©us
 = 500;

456 
cÚ
->
mode
 = 
DIRECT
;

457  
HANDLER_FINISHED
;

460 ià(
NULL
 =ğ
ds
 || 
	`bufãr_is_em±y
(ds->
v®ue
)) {

461  
	`mod_auth_£nd_401_uÇuthÜized_basic
(
¤v
, 
cÚ
, 
»quœe
->
»®m
);

464 ià(0 !ğ
	`¡ºÿ£cmp
(
ds
->
v®ue
->
±r
, "Basic ", ("Basic ")-1)) {

465  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

468 
u£ºame
 = 
	`bufãr_š™
();

470 
b
 = 
ds
->
v®ue
;

472 ià(!
	`bufãr_­³nd_ba£64_decode
(
u£ºame
, 
b
->
±r
+("Basiø")-1, 
	`bufãr_¡ršg_Ëngth
(b)-(("Basiø")-1), 
BASE64_STANDARD
)) {

473 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "decodšg ba£64-¡ršg faed", 
u£ºame
);

475 
	`bufãr_ä“
(
u£ºame
);

476  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

480 ià(
NULL
 =ğ(
pw
 = 
	`¡rchr
(
u£ºame
->
±r
, ':'))) {

481 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "missšg ':' in", 
u£ºame
);

483 
	`bufãr_ä“
(
u£ºame
);

484  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

487 
	`bufãr_¡ršg_£t_Ëngth
(
u£ºame
, 
pw
 - u£ºame->
±r
);

488 
pw
++;

490 
rc
 = 
back’d
->
	`basic
(
¤v
, 
cÚ
, back’d->
p_d
, 
»quœe
, 
u£ºame
, 
pw
);

491 
rc
) {

492 
HANDLER_GO_ON
:

493 
	`h‰p_auth_£‹nv
(
cÚ
->
’vœÚm’t
, 
	`CONST_BUF_LEN
(
u£ºame
), 
	`CONST_STR_LEN
("Basic"));

495 
HANDLER_WAIT_FOR_EVENT
:

496 
HANDLER_FINISHED
:

498 
HANDLER_ERROR
:

500 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsBsB", "·sswÜd dÛ¢'ˆm©ch fÜ", 
cÚ
->
uri
.
·th
, "u£ºame:", 
u£ºame
, ", IP:", cÚ->
d¡_addr_buf
);

501 
rc
 = 
HANDLER_UNSET
;

505 
	`bufãr_ä“
(
u£ºame
);

506  (
HANDLER_UNSET
 !ğ
rc
è?„ø: 
	`mod_auth_£nd_401_uÇuthÜized_basic
(
¤v
, 
cÚ
, 
»quœe
->
»®m
);

507 
	}
}

509 
	#HASHLEN
 16

	)

510 
	#HASHHEXLEN
 32

	)

511 
	tHASH
[
HASHLEN
];

512 
	tHASHHEX
[
HASHHEXLEN
+1];

514 
CvtHex
(cÚ¡ 
HASH
 
Bš
, (*
Hex
)[33]) {

515 
li_tohex
(*
Hex
, (*Hex), (cÚ¡ *è
Bš
, 16);

519 cÚ¡ *
	mkey
;

520 
	mkey_Ën
;

521 **
	m±r
;

522 } 
	tdige¡_kv
;

524 
hªdËr_t
 
mod_auth_£nd_401_uÇuthÜized_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
»®m
, 
nÚû_¡®e
);

526 
hªdËr_t
 
	$mod_auth_check_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
) {

527 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Authorization");

529 
a1
[33];

530 
a2
[33];

532 *
u£ºame
 = 
NULL
;

533 *
»®m
 = 
NULL
;

534 *
nÚû
 = 
NULL
;

535 *
uri
 = 
NULL
;

536 *
®gÜ™hm
 = 
NULL
;

537 *
qİ
 = 
NULL
;

538 *
úÚû
 = 
NULL
;

539 *
nc
 = 
NULL
;

540 *
»¥Ús
 = 
NULL
;

542 *
e
, *
c
;

543 cÚ¡ *
m
 = 
NULL
;

544 
i
;

545 
bufãr
 *
b
;

547 
li_MD5_CTX
 
Md5Ctx
;

548 
HASH
 
HA1
;

549 
HASH
 
HA2
;

550 
HASH
 
Re¥Hash
;

551 
HASHHEX
 
HA2Hex
;

555 
	#S
(
x
) \

556 
x
, (x)-1, 
NULL


	)

557 
dige¡_kv
 
dkv
[10] = {

558 { 
	`S
("username=") },

559 { 
	`S
("realm=") },

560 { 
	`S
("nonce=") },

561 { 
	`S
("uri=") },

562 { 
	`S
("algorithm=") },

563 { 
	`S
("qop=") },

564 { 
	`S
("cnonce=") },

565 { 
	`S
("nc=") },

566 { 
	`S
("response=") },

568 { 
NULL
, 0, NULL }

570 #undeà
S


572 
dkv
[0].
±r
 = &
u£ºame
;

573 
dkv
[1].
±r
 = &
»®m
;

574 
dkv
[2].
±r
 = &
nÚû
;

575 
dkv
[3].
±r
 = &
uri
;

576 
dkv
[4].
±r
 = &
®gÜ™hm
;

577 
dkv
[5].
±r
 = &
qİ
;

578 
dkv
[6].
±r
 = &
úÚû
;

579 
dkv
[7].
±r
 = &
nc
;

580 
dkv
[8].
±r
 = &
»¥Ús
;

582 
	`UNUSED
(
p_d
);

584 ià(
NULL
 =ğ
back’d
) {

585 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "auth.back’d‚Ù cÚfigu»d fÜ", 
cÚ
->
uri
.
·th
);

586 
cÚ
->
h‰p_¡©us
 = 500;

587 
cÚ
->
mode
 = 
DIRECT
;

588  
HANDLER_FINISHED
;

591 ià(
NULL
 =ğ
ds
 || 
	`bufãr_is_em±y
(ds->
v®ue
)) {

592  
	`mod_auth_£nd_401_uÇuthÜized_dige¡
(
¤v
, 
cÚ
, 
»quœe
->
»®m
, 0);

595 ià(0 !ğ
	`¡ºÿ£cmp
(
ds
->
v®ue
->
±r
, "Digest ", ("Digest ")-1)) {

596  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

599 
b
 = 
	`bufãr_š™
();

601 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
ds
->
v®ue
->
±r
+("Dige¡ ")-1, 
	`bufãr_¡ršg_Ëngth
(ds->value)-(("Digest ")-1));

604 
c
 = 
b
->
±r
; *c; c++) {

606 *
c
 == ' ' || *c == '\t') c++;

607 ià(!*
c
) ;

609 
i
 = 0; 
dkv
[i].
key
; i++) {

610 ià((0 =ğ
	`¡ºcmp
(
c
, 
dkv
[
i
].
key
, dkv[i].
key_Ën
))) {

611 ià((
c
[
dkv
[
i
].
key_Ën
] == '"') &&

612 (
NULL
 !ğ(
e
 = 
	`¡rchr
(
c
 + 
dkv
[
i
].
key_Ën
 + 1, '"')))) {

614 *(
dkv
[
i
].
±r
èğ
c
 + dkv[i].
key_Ën
 + 1;

615 
c
 = 
e
;

617 *
e
 = '\0';

618 } ià(
NULL
 !ğ(
e
 = 
	`¡rchr
(
c
 + 
dkv
[
i
].
key_Ën
, ','))) {

620 *(
dkv
[
i
].
±r
èğ
c
 + dkv[i].
key_Ën
;

621 
c
 = 
e
;

623 *
e
 = '\0';

626 *(
dkv
[
i
].
±r
èğ
c
 + dkv[i].
key_Ën
;

627 
c
 +ğ
	`¡¾’
(c) - 1;

635 ià(!
u£ºame
 ||

636 !
»®m
 ||

637 !
nÚû
 ||

638 !
uri
 ||

639 (
qİ
 && (!
nc
 || !
úÚû
)) ||

640 !
»¥Ús
 ) {

643 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

646 
	`bufãr_ä“
(
b
);

647  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

653 ià(
®gÜ™hm
 &&

654 0 =ğ
	`¡rÿ£cmp
(
®gÜ™hm
, "md5-sess") &&

655 (!
nÚû
 || !
úÚû
)) {

656 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

659 
	`bufãr_ä“
(
b
);

660  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

663 ià(
qİ
 && 
	`¡rÿ£cmp
(qop, "auth-int") == 0) {

664 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

667 
	`bufãr_ä“
(
b
);

668  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

671 
m
 = 
	`g‘_h‰p_m‘hod_Çme
(
cÚ
->
»que¡
.
h‰p_m‘hod
);

672 
	`fÜû_as£¹
(
m
);

683 cÚ¡ 
size_t
 
uËn
 = 
	`¡¾’
(
uri
);

684 cÚ¡ 
size_t
 
¾’
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.
Üig_uri
);

685 ià(!
	`bufãr_is_equ®_¡ršg
(
cÚ
->
»que¡
.
Üig_uri
, 
uri
, 
uËn
)

686 && !(
¾’
 < 
uËn
 && 0 =ğ
	`memcmp
(
cÚ
->
»que¡
.
Üig_uri
->
±r
, 
uri
,„len) && uri[rlen] == '?')) {

687 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsssB",

688 "dige¡:‡uth faed: ur˜mism©ch (", 
cÚ
->
»que¡
.
Üig_uri
, "!=", 
uri
, "), IP:", cÚ->
d¡_addr_buf
);

689 
	`bufãr_ä“
(
b
);

690  
	`mod_auth_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

695 
back’d
->
	`dige¡
(
¤v
, 
cÚ
, back’d->
p_d
, 
u£ºame
, 
»®m
, 
HA1
)) {

696 
HANDLER_GO_ON
:

698 
HANDLER_WAIT_FOR_EVENT
:

699 
	`bufãr_ä“
(
b
);

700  
HANDLER_WAIT_FOR_EVENT
;

701 
HANDLER_FINISHED
:

702 
	`bufãr_ä“
(
b
);

703  
HANDLER_FINISHED
;

704 
HANDLER_ERROR
:

706 
	`bufãr_ä“
(
b
);

707  
	`mod_auth_£nd_401_uÇuthÜized_dige¡
(
¤v
, 
cÚ
, 
»quœe
->
»®m
, 0);

710 ià(
®gÜ™hm
 &&

711 
	`¡rÿ£cmp
(
®gÜ™hm
, "md5-sess") == 0) {

712 
	`li_MD5_In™
(&
Md5Ctx
);

714 
	`CvtHex
(
HA1
, &
a1
);

715 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
a1
, 
HASHHEXLEN
);

716 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

717 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
nÚû
, 
	`¡¾’
(nonce));

718 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

719 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
úÚû
, 
	`¡¾’
(cnonce));

720 
	`li_MD5_Fš®
(
HA1
, &
Md5Ctx
);

723 
	`CvtHex
(
HA1
, &
a1
);

726 
	`li_MD5_In™
(&
Md5Ctx
);

727 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
m
, 
	`¡¾’
(m));

728 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

729 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
uri
, 
	`¡¾’
(uri));

737 
	`li_MD5_Fš®
(
HA2
, &
Md5Ctx
);

738 
	`CvtHex
(
HA2
, &
HA2Hex
);

741 
	`li_MD5_In™
(&
Md5Ctx
);

742 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
a1
, 
HASHHEXLEN
);

743 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

744 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
nÚû
, 
	`¡¾’
(nonce));

745 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

746 ià(
qİ
 && *qop) {

747 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
nc
, 
	`¡¾’
(nc));

748 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

749 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
úÚû
, 
	`¡¾’
(cnonce));

750 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

751 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
qİ
, 
	`¡¾’
(qop));

752 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

754 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
HA2Hex
, 
HASHHEXLEN
);

755 
	`li_MD5_Fš®
(
Re¥Hash
, &
Md5Ctx
);

756 
	`CvtHex
(
Re¥Hash
, &
a2
);

758 ià(0 !ğ
	`¡rcmp
(
a2
, 
»¥Ús
)) {

760 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssB",

761 "dige¡:‡uth faed fÜ ", 
u£ºame
, ": wrÚg…asswÜd, IP:", 
cÚ
->
d¡_addr_buf
);

763 
	`bufãr_ä“
(
b
);

764  
	`mod_auth_£nd_401_uÇuthÜized_dige¡
(
¤v
, 
cÚ
, 
»quœe
->
»®m
, 0);

768 ià(!
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
u£ºame
, 
NULL
, NULL)) {

769 
	`bufãr_ä“
(
b
);

770  
	`mod_auth_£nd_401_uÇuthÜized_dige¡
(
¤v
, 
cÚ
, 
»quœe
->
»®m
, 0);

783 
time_t
 
ts
 = 0;

784 cÚ¡ * cÚ¡ 
nÚû_uns
 = (*)
nÚû
;

785 
i
 = 0; i < 8 && 
	`light_isxdig™
(
nÚû_uns
[i]); ++i) {

786 
ts
 = (t << 4è+ 
	`hex2št
(
nÚû_uns
[
i
]);

788 ià(
i
 !ğ8 || 
nÚû
[8] != ':'

789 || 
ts
 > 
¤v
->
cur_ts
 || srv->cur_ts -s > 600) {

791 
	`bufãr_ä“
(
b
);

792  
	`mod_auth_£nd_401_uÇuthÜized_dige¡
(
¤v
, 
cÚ
, 
»quœe
->
»®m
, 1);

796 
	`h‰p_auth_£‹nv
(
cÚ
->
’vœÚm’t
, 
u£ºame
, 
	`¡¾’
(u£ºame), 
	`CONST_STR_LEN
("Digest"));

798 
	`bufãr_ä“
(
b
);

800  
HANDLER_GO_ON
;

801 
	}
}

803 
hªdËr_t
 
	$mod_auth_£nd_401_uÇuthÜized_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
»®m
, 
nÚû_¡®e
) {

804 
li_MD5_CTX
 
Md5Ctx
;

805 
HASH
 
h
;

806 
hh
[33];

808 
	`fÜû_as£¹
(33 >ğ
LI_ITOSTRING_LENGTH
);

813 
	`li_MD5_In™
(&
Md5Ctx
);

815 
	`li_™o¡º
(
hh
, (hh), 
¤v
->
cur_ts
);

816 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
hh
, 
	`¡¾’
(hh));

817 
	`li_™o¡º
(
hh
, (hh), 
	`li_¿nd_p£udo_by‹s
());

818 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
hh
, 
	`¡¾’
(hh));

820 
	`li_MD5_Fš®
(
h
, &
Md5Ctx
);

822 
	`CvtHex
(
h
, &
hh
);

826 
cÚ
->
h‰p_¡©us
 = 401;

827 
cÚ
->
mode
 = 
DIRECT
;

829 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("Digest„ealm=\""));

830 
	`bufãr_­³nd_¡ršg_bufãr
(
¤v
->
tmp_buf
, 
»®m
);

831 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("\", charset=\"UTF-8\",‚once=\""));

832 
	`bufãr_­³nd_ušt_hex
(
¤v
->
tmp_buf
, (
uštmax_t
)¤v->
cur_ts
);

833 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
(":"));

834 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
hh
);

835 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("\", qop=\"auth\""));

836 ià(
nÚû_¡®e
) {

837 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
(", stale=true"));

840 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("WWW-Auth’tiÿ‹"), 
	`CONST_BUF_LEN
(¤v->
tmp_buf
));

842  
HANDLER_FINISHED
;

843 
	}
}

845 
hªdËr_t
 
	$mod_auth_check_ex‹º
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
) {

847 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "REMOTE_USER");

848 
	`UNUSED
(
¤v
);

849 
	`UNUSED
(
p_d
);

850 
	`UNUSED
(
back’d
);

851 ià(
NULL
 !ğ
ds
 && 
	`h‰p_auth_m©ch_ruËs
(
»quœe
, ds->
v®ue
->
±r
, NULL, NULL)) {

852  
HANDLER_GO_ON
;

854 
cÚ
->
h‰p_¡©us
 = 401;

855 
cÚ
->
mode
 = 
DIRECT
;

856  
HANDLER_FINISHED
;

858 
	}
}

	@mod_authn_file.c

1 
	~"fœ¡.h
"

5 #ifdeà
HAVE_CRYPT_H


6 
	~<üy±.h
>

7 #–ià
defšed
(
__lšux__
)

9 
	#_XOPEN_SOURCE


	)

12 #ià
defšed
(
HAVE_LIBCRYPT
è&& !defšed(
HAVE_CRYPT
)

14 
	#HAVE_CRYPT


	)

17 
	~"ba£.h
"

19 #ifdeà
USE_OPENSSL


20 
	~"ba£64.h
"

21 
	~<İ’s¦/md4.h
>

22 
	~<İ’s¦/sha.h
>

25 
	~"§ã_memş—r.h
"

29 
	~"¶ugš.h
"

30 
	~"h‰p_auth.h
"

31 
	~"log.h
"

32 
	~"»¥Ú£.h
"

34 
	~"š‘_Áİ_ÿche.h
"

35 
	~"ba£64.h
"

36 
	~"md5.h
"

38 
	~<sys/ty³s.h
>

39 
	~<sys/¡©.h
>

41 
	~<¡dlib.h
>

42 
	~<¡ršg.h
>

43 
	~<”ºo.h
>

44 
	~<fú.h
>

45 
	~<uni¡d.h
>

52 
bufãr
 *
	mauth_¶aš_groupfe
;

53 
bufãr
 *
	mauth_¶aš_u£rfe
;

54 
bufãr
 *
	mauth_htdige¡_u£rfe
;

55 
bufãr
 *
	mauth_hasswd_u£rfe
;

56 } 
	t¶ugš_cÚfig
;

59 
	mPLUGIN_DATA
;

60 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

61 
¶ugš_cÚfig
 
	mcÚf
;

62 } 
	t¶ugš_d©a
;

64 
hªdËr_t
 
mod_authn_fe_htdige¡_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, 
HA1
[16]);

65 
hªdËr_t
 
mod_authn_fe_htdige¡_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
);

66 
hªdËr_t
 
mod_authn_fe_¶aš_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, 
HA1
[16]);

67 
hªdËr_t
 
mod_authn_fe_¶aš_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
);

68 
hªdËr_t
 
mod_authn_fe_hasswd_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
);

70 
	$INIT_FUNC
(
mod_authn_fe_š™
) {

71 
h‰p_auth_back’d_t
 
h‰p_auth_back’d_htdige¡
 =

72 { "htdige¡", 
mod_authn_fe_htdige¡_basic
, 
mod_authn_fe_htdige¡_dige¡
, 
NULL
 };

73 
h‰p_auth_back’d_t
 
h‰p_auth_back’d_hasswd
 =

74 { "hasswd", 
mod_authn_fe_hasswd_basic
, 
NULL
, NULL };

75 
h‰p_auth_back’d_t
 
h‰p_auth_back’d_¶aš
 =

76 { "¶aš", 
mod_authn_fe_¶aš_basic
, 
mod_authn_fe_¶aš_dige¡
, 
NULL
 };

77 
¶ugš_d©a
 *
p
 = 
	`ÿÎoc
(1, (*p));

80 
h‰p_auth_back’d_htdige¡
.
p_d
 = 
p
;

81 
	`h‰p_auth_back’d_£t
(&
h‰p_auth_back’d_htdige¡
);

84 
h‰p_auth_back’d_hasswd
.
p_d
 = 
p
;

85 
	`h‰p_auth_back’d_£t
(&
h‰p_auth_back’d_hasswd
);

88 
h‰p_auth_back’d_¶aš
.
p_d
 = 
p
;

89 
	`h‰p_auth_back’d_£t
(&
h‰p_auth_back’d_¶aš
);

91  
p
;

92 
	}
}

94 
	$FREE_FUNC
(
mod_authn_fe_ä“
) {

95 
¶ugš_d©a
 *
p
 = 
p_d
;

97 
	`UNUSED
(
¤v
);

99 ià(!
p
è 
HANDLER_GO_ON
;

101 ià(
p
->
cÚfig_¡Üage
) {

102 
size_t
 
i
;

103 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

104 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

106 ià(
NULL
 =ğ
s
) ;

108 
	`bufãr_ä“
(
s
->
auth_¶aš_groupfe
);

109 
	`bufãr_ä“
(
s
->
auth_¶aš_u£rfe
);

110 
	`bufãr_ä“
(
s
->
auth_htdige¡_u£rfe
);

111 
	`bufãr_ä“
(
s
->
auth_hasswd_u£rfe
);

113 
	`ä“
(
s
);

115 
	`ä“
(
p
->
cÚfig_¡Üage
);

118 
	`ä“
(
p
);

120  
HANDLER_GO_ON
;

121 
	}
}

123 
	$SETDEFAULTS_FUNC
(
mod_authn_fe_£t_deçuÉs
) {

124 
¶ugš_d©a
 *
p
 = 
p_d
;

125 
size_t
 
i
;

127 
cÚfig_v®ues_t
 
cv
[] = {

128 { "auth.back’d.¶aš.groupfe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

129 { "auth.back’d.¶aš.u£rfe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

130 { "auth.back’d.htdige¡.u£rfe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

131 { "auth.back’d.hasswd.u£rfe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

132 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

135 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

137 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

138 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

139 
¶ugš_cÚfig
 *
s
;

141 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

142 
s
->
auth_¶aš_groupfe
 = 
	`bufãr_š™
();

143 
s
->
auth_¶aš_u£rfe
 = 
	`bufãr_š™
();

144 
s
->
auth_htdige¡_u£rfe
 = 
	`bufãr_š™
();

145 
s
->
auth_hasswd_u£rfe
 = 
	`bufãr_š™
();

147 
cv
[0].
de¡š©iÚ
 = 
s
->
auth_¶aš_groupfe
;

148 
cv
[1].
de¡š©iÚ
 = 
s
->
auth_¶aš_u£rfe
;

149 
cv
[2].
de¡š©iÚ
 = 
s
->
auth_htdige¡_u£rfe
;

150 
cv
[3].
de¡š©iÚ
 = 
s
->
auth_hasswd_u£rfe
;

152 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

154 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

155  
HANDLER_ERROR
;

159  
HANDLER_GO_ON
;

160 
	}
}

162 
	#PATCH
(
x
) \

163 
p
->
cÚf
.
x
 = 
s
->x;

	)

164 
	$mod_authn_fe_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

165 
size_t
 
i
, 
j
;

166 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

168 
	`PATCH
(
auth_¶aš_groupfe
);

169 
	`PATCH
(
auth_¶aš_u£rfe
);

170 
	`PATCH
(
auth_htdige¡_u£rfe
);

171 
	`PATCH
(
auth_hasswd_u£rfe
);

174 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

175 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

176 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

179 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

182 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

183 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

185 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.plain.groupfile"))) {

186 
	`PATCH
(
auth_¶aš_groupfe
);

187 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.plain.userfile"))) {

188 
	`PATCH
(
auth_¶aš_u£rfe
);

189 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.htdigest.userfile"))) {

190 
	`PATCH
(
auth_htdige¡_u£rfe
);

191 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.htpasswd.userfile"))) {

192 
	`PATCH
(
auth_hasswd_u£rfe
);

198 
	}
}

199 #undeà
PATCH


202 
	$mod_authn_fe_htdige¡_g‘
(
£rv”
 *
¤v
, cÚ¡ 
bufãr
 *
auth_â
, cÚ¡ bufã¸*
u£ºame
, cÚ¡ bufã¸*
»®m
, 
HA1
[16]) {

203 
FILE
 *
å
;

204 
f_u£r
[1024];

206 ià(
	`bufãr_¡ršg_is_em±y
(
auth_â
))  -1;

207 ià(
	`bufãr_is_em±y
(
u£ºame
è|| bufãr_is_em±y(
»®m
))  -1;

209 
å
 = 
	`fİ’
(
auth_â
->
±r
, "r");

210 ià(
NULL
 =ğ
å
) {

211 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "İ’šg dige¡-u£rfe", 
auth_â
, "çed:", 
	`¡»¼Ü
(
”ºo
));

216 
NULL
 !ğ
	`fg‘s
(
f_u£r
, (f_u£r), 
å
)) {

217 *
f_pwd
, *
f_»®m
;

218 
size_t
 
u_Ën
, 
r_Ën
;

221 ià(
f_u£r
[0] == '#' || f_user[0] == '\n' || f_user[0] == '\0') ;

229 ià(
NULL
 =ğ(
f_»®m
 = 
	`¡rchr
(
f_u£r
, ':'))) {

230 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

231 "·r£dƒ¼Ü in", 
auth_â
,

237 ià(
NULL
 =ğ(
f_pwd
 = 
	`¡rchr
(
f_»®m
 + 1, ':'))) {

238 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

239 "·r£dƒ¼Ü in", 
auth_â
,

246 
u_Ën
 = 
f_»®m
 - 
f_u£r
;

247 
f_»®m
++;

248 
r_Ën
 = 
f_pwd
 - 
f_»®m
;

249 
f_pwd
++;

251 ià(
	`bufãr_¡ršg_Ëngth
(
u£ºame
è=ğ
u_Ën
 &&

252 (
	`bufãr_¡ršg_Ëngth
(
»®m
è=ğ
r_Ën
) &&

253 (0 =ğ
	`¡ºcmp
(
u£ºame
->
±r
, 
f_u£r
, 
u_Ën
)) &&

254 (0 =ğ
	`¡ºcmp
(
»®m
->
±r
, 
f_»®m
, 
r_Ën
))) {

257 
size_t
 
pwd_Ën
 = 
	`¡¾’
(
f_pwd
);

258 ià(
f_pwd
[
pwd_Ën
-1] == '\n') --pwd_len;

260 
	`fşo£
(
å
);

262  
	`h‰p_auth_md5_hex2bš
(
f_pwd
, 
pwd_Ën
, 
HA1
);

266 
	`fşo£
(
å
);

268 
	}
}

270 
hªdËr_t
 
	$mod_authn_fe_htdige¡_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, 
HA1
[16]) {

271 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

272 
bufãr
 *
u£ºame_buf
 = 
	`bufãr_š™_¡ršg
(
u£ºame
);

273 
bufãr
 *
»®m_buf
 = 
	`bufãr_š™_¡ršg
(
»®m
);

274 
rc
;

275 
	`mod_authn_fe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

276 
rc
 = 
	`mod_authn_fe_htdige¡_g‘
(
¤v
, 
p
->
cÚf
.
auth_htdige¡_u£rfe
, 
u£ºame_buf
, 
»®m_buf
, 
HA1
);

277 
	`bufãr_ä“
(
»®m_buf
);

278 
	`bufãr_ä“
(
u£ºame_buf
);

279 
	`UNUSED
(
cÚ
);

280  (0 =ğ
rc
è? 
HANDLER_GO_ON
 : 
HANDLER_ERROR
;

281 
	}
}

283 
hªdËr_t
 
	$mod_authn_fe_htdige¡_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
) {

284 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

285 
li_MD5_CTX
 
Md5Ctx
;

286 
HA1
[16];

287 
htdige¡
[16];

289 
	`mod_authn_fe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

290 ià(
	`mod_authn_fe_htdige¡_g‘
(
¤v
, 
p
->
cÚf
.
auth_htdige¡_u£rfe
, 
u£ºame
, 
»quœe
->
»®m
, 
htdige¡
)è 
HANDLER_ERROR
;

292 
	`li_MD5_In™
(&
Md5Ctx
);

293 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_BUF_LEN
(
u£ºame
));

294 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

295 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_BUF_LEN
(
»quœe
->
»®m
));

296 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

297 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
pw
, 
	`¡¾’
(pw));

298 
	`li_MD5_Fš®
(
HA1
, &
Md5Ctx
);

300 
	`UNUSED
(
cÚ
);

301  (0 =ğ
	`memcmp
(
HA1
, 
htdige¡
, (HA1))

302 && 
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
u£ºame
->
±r
, 
NULL
, NULL))

303 ? 
HANDLER_GO_ON


304 : 
HANDLER_ERROR
;

305 
	}
}

310 
	$mod_authn_fe_hasswd_g‘
(
£rv”
 *
¤v
, cÚ¡ 
bufãr
 *
auth_â
, cÚ¡ bufã¸*
u£ºame
, bufã¸*
·sswÜd
) {

311 
FILE
 *
å
;

312 
f_u£r
[1024];

314 ià(
	`bufãr_is_em±y
(
u£ºame
))  -1;

316 ià(
	`bufãr_¡ršg_is_em±y
(
auth_â
))  -1;

317 
å
 = 
	`fİ’
(
auth_â
->
±r
, "r");

318 ià(
NULL
 =ğ
å
) {

319 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

320 "İ’šg…Ïš-u£rfe", 
auth_â
, "çed:", 
	`¡»¼Ü
(
”ºo
));

325 
NULL
 !ğ
	`fg‘s
(
f_u£r
, (f_u£r), 
å
)) {

326 *
f_pwd
;

327 
size_t
 
u_Ën
;

330 ià(
f_u£r
[0] == '#' || f_user[0] == '\n' || f_user[0] == '\0') ;

338 ià(
NULL
 =ğ(
f_pwd
 = 
	`¡rchr
(
f_u£r
, ':'))) {

339 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

340 "·r£dƒ¼Ü in", 
auth_â
,

347 
u_Ën
 = 
f_pwd
 - 
f_u£r
;

348 
f_pwd
++;

350 ià(
	`bufãr_¡ršg_Ëngth
(
u£ºame
è=ğ
u_Ën
 &&

351 (0 =ğ
	`¡ºcmp
(
u£ºame
->
±r
, 
f_u£r
, 
u_Ën
))) {

354 
size_t
 
pwd_Ën
 = 
	`¡¾’
(
f_pwd
);

355 ià(
f_pwd
[
pwd_Ën
-1] == '\n') --pwd_len;

357 
	`bufãr_cİy_¡ršg_Ën
(
·sswÜd
, 
f_pwd
, 
pwd_Ën
);

359 
	`fşo£
(
å
);

364 
	`fşo£
(
å
);

366 
	}
}

368 
hªdËr_t
 
	$mod_authn_fe_¶aš_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, 
HA1
[16]) {

369 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

370 
bufãr
 *
u£ºame_buf
 = 
	`bufãr_š™_¡ršg
(
u£ºame
);

371 
bufãr
 *
·sswÜd_buf
 = 
	`bufãr_š™
();

372 
rc
;

373 
	`mod_authn_fe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

374 
rc
 = 
	`mod_authn_fe_hasswd_g‘
(
¤v
, 
p
->
cÚf
.
auth_¶aš_u£rfe
, 
u£ºame_buf
, 
·sswÜd_buf
);

375 ià(0 =ğ
rc
) {

377 
li_MD5_CTX
 
Md5Ctx
;

378 
	`li_MD5_In™
(&
Md5Ctx
);

379 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
u£ºame_buf
->
±r
, 
	`bufãr_¡ršg_Ëngth
(username_buf));

380 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

381 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
»®m
, 
	`¡¾’
(realm));

382 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
(":"));

383 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
·sswÜd_buf
->
±r
, 
	`bufãr_¡ršg_Ëngth
(password_buf));

384 
	`li_MD5_Fš®
(
HA1
, &
Md5Ctx
);

386 
	`bufãr_ä“
(
·sswÜd_buf
);

387 
	`bufãr_ä“
(
u£ºame_buf
);

388 
	`UNUSED
(
cÚ
);

389  (0 =ğ
rc
è? 
HANDLER_GO_ON
 : 
HANDLER_ERROR
;

390 
	}
}

392 
hªdËr_t
 
	$mod_authn_fe_¶aš_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
) {

393 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

394 
bufãr
 *
·sswÜd_buf
 = 
	`bufãr_š™
();

395 
rc
;

396 
	`mod_authn_fe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

397 
rc
 = 
	`mod_authn_fe_hasswd_g‘
(
¤v
, 
p
->
cÚf
.
auth_¶aš_u£rfe
, 
u£ºame
, 
·sswÜd_buf
);

398 ià(0 =ğ
rc
) {

399 
rc
 = 
	`bufãr_is_equ®_¡ršg
(
·sswÜd_buf
, 
pw
, 
	`¡¾’
(pw)) ? 0 : -1;

401 
	`bufãr_ä“
(
·sswÜd_buf
);

402 
	`UNUSED
(
cÚ
);

403  0 =ğ
rc
 && 
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
u£ºame
->
±r
, 
NULL
, NULL)

404 ? 
HANDLER_GO_ON


405 : 
HANDLER_ERROR
;

406 
	}
}

426 
	#APR_MD5_DIGESTSIZE
 16

	)

427 
	#APR1_ID
 "$­r1$"

	)

435 
	$to64
(*
s
, 
v
, 
n
)

437 cÚ¡ 
™ß64
[] =

440 --
n
 >= 0) {

441 *
s
++ = 
™ß64
[
v
&0x3f];

442 
v
 >>= 6;

444 
	}
}

446 
	$­r_md5_’code
(cÚ¡ *
pw
, cÚ¡ *
§É
, *
»suÉ
, 
size_t
 
nby‹s
) {

453 
·sswd
[120], *
p
;

454 cÚ¡ *
¥
, *
•
;

455 
fš®
[
APR_MD5_DIGESTSIZE
];

456 
ssize_t
 
¦
, 
¶
, 
i
;

457 
li_MD5_CTX
 
ùx
, 
ùx1
;

458 
l
;

465 
¥
 = 
§É
;

470 ià(!
	`¡ºcmp
(
¥
, 
APR1_ID
, 
	`¡¾’
(APR1_ID))) {

471 
¥
 +ğ
	`¡¾’
(
APR1_ID
);

477 
•
 = 
¥
; (*ep != '\0') && (*ep != '$') && (ep < (sp + 8));ƒp++) {

484 
¦
 = 
•
 - 
¥
;

489 
	`li_MD5_In™
(&
ùx
);

494 
	`li_MD5_Upd©e
(&
ùx
, 
pw
, 
	`¡¾’
(pw));

499 
	`li_MD5_Upd©e
(&
ùx
, 
APR1_ID
, 
	`¡¾’
(APR1_ID));

504 
	`li_MD5_Upd©e
(&
ùx
, 
¥
, 
¦
);

509 
	`li_MD5_In™
(&
ùx1
);

510 
	`li_MD5_Upd©e
(&
ùx1
, 
pw
, 
	`¡¾’
(pw));

511 
	`li_MD5_Upd©e
(&
ùx1
, 
¥
, 
¦
);

512 
	`li_MD5_Upd©e
(&
ùx1
, 
pw
, 
	`¡¾’
(pw));

513 
	`li_MD5_Fš®
(
fš®
, &
ùx1
);

514 
¶
 = 
	`¡¾’
(
pw
);…È> 0;…È-ğ
APR_MD5_DIGESTSIZE
) {

515 
	`li_MD5_Upd©e
(&
ùx
, 
fš®
,

516 (
¶
 > 
APR_MD5_DIGESTSIZE
) ? APR_MD5_DIGESTSIZE :…l);

522 
	`mem£t
(
fš®
, 0, (final));

527 
i
 = 
	`¡¾’
(
pw
); i != 0; i >>= 1) {

528 ià(
i
 & 1) {

529 
	`li_MD5_Upd©e
(&
ùx
, 
fš®
, 1);

532 
	`li_MD5_Upd©e
(&
ùx
, 
pw
, 1);

540 
	`¡rıy
(
·sswd
, 
APR1_ID
);

541 
	`¡ºÿt
(
·sswd
, 
¥
, 
¦
);

542 
	`¡rÿt
(
·sswd
, "$");

544 
	`li_MD5_Fš®
(
fš®
, &
ùx
);

551 
i
 = 0; i < 1000; i++) {

552 
	`li_MD5_In™
(&
ùx1
);

553 ià(
i
 & 1) {

554 
	`li_MD5_Upd©e
(&
ùx1
, 
pw
, 
	`¡¾’
(pw));

557 
	`li_MD5_Upd©e
(&
ùx1
, 
fš®
, 
APR_MD5_DIGESTSIZE
);

559 ià(
i
 % 3) {

560 
	`li_MD5_Upd©e
(&
ùx1
, 
¥
, 
¦
);

563 ià(
i
 % 7) {

564 
	`li_MD5_Upd©e
(&
ùx1
, 
pw
, 
	`¡¾’
(pw));

567 ià(
i
 & 1) {

568 
	`li_MD5_Upd©e
(&
ùx1
, 
fš®
, 
APR_MD5_DIGESTSIZE
);

571 
	`li_MD5_Upd©e
(&
ùx1
, 
pw
, 
	`¡¾’
(pw));

573 
	`li_MD5_Fš®
(
fš®
,&
ùx1
);

576 
p
 = 
·sswd
 + 
	`¡¾’
(passwd);

578 
l
 = (
fš®
[ 0]<<16è| (fš®[ 6]<<8è| fš®[12]; 
	`to64
(
p
,†, 4);… += 4;

579 
l
 = (
fš®
[ 1]<<16è| (fš®[ 7]<<8è| fš®[13]; 
	`to64
(
p
,†, 4);… += 4;

580 
l
 = (
fš®
[ 2]<<16è| (fš®[ 8]<<8è| fš®[14]; 
	`to64
(
p
,†, 4);… += 4;

581 
l
 = (
fš®
[ 3]<<16è| (fš®[ 9]<<8è| fš®[15]; 
	`to64
(
p
,†, 4);… += 4;

582 
l
 = (
fš®
[ 4]<<16è| (fš®[10]<<8è| fš®[ 5]; 
	`to64
(
p
,†, 4);… += 4;

583 
l
 = 
fš®
[11] ; 
	`to64
(
p
,†, 2);… += 2;

584 *
p
 = '\0';

589 
	`§ã_memş—r
(
fš®
, (final));

593 
	#­r_ıy¡º
 
¡ºıy


	)

594 
	`­r_ıy¡º
(
»suÉ
, 
·sswd
, 
nby‹s
 - 1);

595 
	}
}

597 #ifdeà
USE_OPENSSL


598 
	$­r_sha_’code
(cÚ¡ *
pw
, *
»suÉ
, 
size_t
 
nby‹s
) {

599 
dige¡
[20];

600 
size_t
 
ba£64_wr™‹n
;

602 
	`SHA1
((cÚ¡ *è
pw
, 
	`¡¾’
Õw), 
dige¡
);

604 
	`mem£t
(
»suÉ
, 0, 
nby‹s
);

607 ià(
nby‹s
 < 5 + 28 + 1) ;

609 
	`memıy
(
»suÉ
, "{SHA}", 5);

610 
ba£64_wr™‹n
 = 
	`li_to_ba£64
(
»suÉ
 + 5, 
nby‹s
 - 5, 
dige¡
, 20, 
BASE64_STANDARD
);

611 
	`fÜû_as£¹
(
ba£64_wr™‹n
 == 28);

612 
»suÉ
[5 + 
ba£64_wr™‹n
] = '\0';

613 
	}
}

616 
hªdËr_t
 
	$mod_authn_fe_hasswd_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
) {

617 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

618 
bufãr
 *
·sswÜd
 = 
	`bufãr_š™
();

619 
rc
;

620 
	`mod_authn_fe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

621 
rc
 = 
	`mod_authn_fe_hasswd_g‘
(
¤v
, 
p
->
cÚf
.
auth_hasswd_u£rfe
, 
u£ºame
, 
·sswÜd
);

622 ià(0 =ğ
rc
) {

623 
§m¶e
[256];

624 
rc
 = -1;

625 ià(!
	`¡ºcmp
(
·sswÜd
->
±r
, 
APR1_ID
, 
	`¡¾’
(APR1_ID))) {

629 
	`­r_md5_’code
(
pw
, 
·sswÜd
->
±r
, 
§m¶e
, (sample));

630 
rc
 = 
	`¡rcmp
(
§m¶e
, 
·sswÜd
->
±r
);

632 #ifdeà
USE_OPENSSL


633 ià(0 =ğ
	`¡ºcmp
(
·sswÜd
->
±r
, "{SHA}", 5)) {

634 
	`­r_sha_’code
(
pw
, 
§m¶e
, (sample));

635 
rc
 = 
	`¡rcmp
(
§m¶e
, 
·sswÜd
->
±r
);

638 #ià
	`defšed
(
HAVE_CRYPT_R
è|| defšed(
HAVE_CRYPT
)

640 ià(
	`bufãr_¡ršg_Ëngth
(
·sswÜd
) >= 13) {

641 *
üy±ed
;

642 #ià
	`defšed
(
HAVE_CRYPT_R
)

643 
üy±_d©a
 
üy±_tmp_d©a
;

644 #ifdeà
_AIX


645 
	`mem£t
(&
üy±_tmp_d©a
, 0, (crypt_tmp_data));

647 
üy±_tmp_d©a
.
š™Ÿlized
 = 0;

650 #ifdeà
USE_OPENSSL


651 ià(0 =ğ
	`memcmp
(
·sswÜd
->
±r
, 
	`CONST_STR_LEN
("$1+ntlm$"))) {

661 *
b
 = 
·sswÜd
->
±r
+("$1+ntlm$")-1;

662 *
e
 = 
	`¡rchr
(
b
, '$');

663 
size_t
 
¦’
 = (
NULL
 !ğ
e
è? (size_t)Ó - 
b
è: (
§m¶e
);

664 
size_t
 
pwËn
 = 
	`¡¾’
(
pw
) * 2;

665 ià(
¦’
 < (
§m¶e
) - (("$1$")-1)

666 && 
pwËn
 < (
§m¶e
)) {

669 
Álmhash
[16];

670 
Álmhex
[33];

671 
MD4_CTX
 
c
;

672 
	`MD4_In™
(&
c
);

673 ià(
pwËn
) {

677 
i
=0; i < ()
pwËn
; i+=2) {

678 
§m¶e
[
i
] = 
pw
[(i >> 1)];

679 
§m¶e
[
i
+1] = 0;

681 
	`MD4_Upd©e
(&
c
, (*)
§m¶e
, 
pwËn
);

683 
	`MD4_Fš®
((*)
Álmhash
, &
c
);

684 
	`li_tohex
(
Álmhex
,Òmhex),
Álmhash
,(ntlmhash));

687 
	`memıy
(
§m¶e
, "$1$", ("$1$")-1);

688 
	`memıy
(
§m¶e
+("$1$")-1, 
b
, 
¦’
);

689 
§m¶e
[("$1$")-1+
¦’
] = '\0';

690 #ià
	`defšed
(
HAVE_CRYPT_R
)

691 
üy±ed
 = 
	`üy±_r
(
Álmhex
, 
§m¶e
, &
üy±_tmp_d©a
);

693 
üy±ed
 = 
	`üy±
(
Álmhex
, 
§m¶e
);

695 ià(
NULL
 !ğ
üy±ed


696 && 0 =ğ
	`¡ºcmp
(
üy±ed
, "$1$", ("$1$")-1)) {

697 
rc
 = 
	`¡rcmp
(
b
, 
üy±ed
+3);

704 #ià
	`defšed
(
HAVE_CRYPT_R
)

705 
üy±ed
 = 
	`üy±_r
(
pw
, 
·sswÜd
->
±r
, &
üy±_tmp_d©a
);

707 
üy±ed
 = 
	`üy±
(
pw
, 
·sswÜd
->
±r
);

709 ià(
NULL
 !ğ
üy±ed
) {

710 
rc
 = 
	`¡rcmp
(
·sswÜd
->
±r
, 
üy±ed
);

716 
	`bufãr_ä“
(
·sswÜd
);

717 
	`UNUSED
(
cÚ
);

718  0 =ğ
rc
 && 
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
u£ºame
->
±r
, 
NULL
, NULL)

719 ? 
HANDLER_GO_ON


720 : 
HANDLER_ERROR
;

721 
	}
}

724 
mod_authn_fe_¶ugš_š™
(
¶ugš
 *
p
);

725 
	$mod_authn_fe_¶ugš_š™
(
¶ugš
 *
p
) {

726 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

727 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("authn_file");

728 
p
->
š™
 = 
mod_authn_fe_š™
;

729 
p
->
£t_deçuÉs
ğ
mod_authn_fe_£t_deçuÉs
;

730 
p
->
ş—nup
 = 
mod_authn_fe_ä“
;

732 
p
->
d©a
 = 
NULL
;

735 
	}
}

	@mod_authn_gssapi.c

1 
	~"fœ¡.h
"

23 
	~"¶ugš.h
"

25 
	~<krb5.h
>

26 
	~<gs§pi.h
>

27 
	~<gs§pi/gs§pi_krb5.h
>

29 
	~"h‰p_auth.h
"

30 
	~"ba£.h
"

31 
	~"log.h
"

32 
	~"md5.h
"

33 
	~"ba£64.h
"

34 
	~"»¥Ú£.h
"

36 
	~<”ºo.h
>

37 
	~<¡dlib.h
>

38 
	~<¡ršg.h
>

41 
bufãr
 *
	mauth_gs§pi_keyb
;

42 
bufãr
 *
	mauth_gs§pi_´šc®
;

43 } 
	t¶ugš_cÚfig
;

46 
	mPLUGIN_DATA
;

47 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

48 
¶ugš_cÚfig
 
	mcÚf
;

49 } 
	t¶ugš_d©a
;

51 
hªdËr_t
 
mod_authn_gs§pi_check
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
);

52 
hªdËr_t
 
mod_authn_gs§pi_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
);

54 
	$INIT_FUNC
(
mod_authn_gs§pi_š™
) {

55 
h‰p_auth_scheme_t
 
h‰p_auth_scheme_gs§pi
 =

56 { "gs§pi", 
mod_authn_gs§pi_check
, 
NULL
 };

57 
h‰p_auth_back’d_t
 
h‰p_auth_back’d_gs§pi
 =

58 { "gs§pi", 
mod_authn_gs§pi_basic
, 
NULL
, NULL };

59 
¶ugš_d©a
 *
p
 = 
	`ÿÎoc
(1, (*p));

62 
h‰p_auth_scheme_gs§pi
.
p_d
 = 
p
;

63 
	`h‰p_auth_scheme_£t
(&
h‰p_auth_scheme_gs§pi
);

64 
h‰p_auth_back’d_gs§pi
.
p_d
 = 
p
;

65 
	`h‰p_auth_back’d_£t
(&
h‰p_auth_back’d_gs§pi
);

67  
p
;

68 
	}
}

70 
	$FREE_FUNC
(
mod_authn_gs§pi_ä“
) {

71 
¶ugš_d©a
 *
p
 = 
p_d
;

73 
	`UNUSED
(
¤v
);

75 ià(!
p
è 
HANDLER_GO_ON
;

77 ià(
p
->
cÚfig_¡Üage
) {

78 
size_t
 
i
;

79 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

80 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

82 ià(
NULL
 =ğ
s
) ;

84 
	`bufãr_ä“
(
s
->
auth_gs§pi_keyb
);

85 
	`bufãr_ä“
(
s
->
auth_gs§pi_´šc®
);

87 
	`ä“
(
s
);

89 
	`ä“
(
p
->
cÚfig_¡Üage
);

92 
	`ä“
(
p
);

94  
HANDLER_GO_ON
;

95 
	}
}

97 
	$SETDEFAULTS_FUNC
(
mod_authn_gs§pi_£t_deçuÉs
) {

98 
¶ugš_d©a
 *
p
 = 
p_d
;

99 
size_t
 
i
;

100 
cÚfig_v®ues_t
 
cv
[] = {

101 { "auth.back’d.gs§pi.keyb", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

102 { "auth.back’d.gs§pi.´šc®", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

103 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

106 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

108 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

109 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

110 
¶ugš_cÚfig
 *
s
;

112 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

114 
s
->
auth_gs§pi_keyb
 = 
	`bufãr_š™
();

115 
s
->
auth_gs§pi_´šc®
 = 
	`bufãr_š™
();

117 
cv
[0].
de¡š©iÚ
 = 
s
->
auth_gs§pi_keyb
;

118 
cv
[1].
de¡š©iÚ
 = 
s
->
auth_gs§pi_´šc®
;

120 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

122 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

123  
HANDLER_ERROR
;

127  
HANDLER_GO_ON
;

128 
	}
}

130 
	#PATCH
(
x
) \

131 
p
->
cÚf
.
x
 = 
s
->x;

	)

132 
	$mod_authn_gs§pi_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
)

134 
size_t
 
i
, 
j
;

135 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

137 
	`PATCH
(
auth_gs§pi_keyb
);

138 
	`PATCH
(
auth_gs§pi_´šc®
);

141 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

142 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

143 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

146 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

149 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

150 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

152 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.gssapi.keytab"))) {

153 
	`PATCH
(
auth_gs§pi_keyb
);

154 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.gssapi.principal"))) {

155 
	`PATCH
(
auth_gs§pi_´šc®
);

161 
	}
}

162 #undeà
PATCH


164 
hªdËr_t
 
	$mod_authn_gs§pi_£nd_400_bad_»que¡
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
)

166 
	`UNUSED
(
¤v
);

167 
cÚ
->
h‰p_¡©us
 = 400;

168 
cÚ
->
mode
 = 
DIRECT
;

169  
HANDLER_FINISHED
;

170 
	}
}

172 
	$mod_authn_gs§pi_log_gss_”rÜ
(
£rv”
 *
¤v
, cÚ¡ *
fe
, 
lše
, cÚ¡ *
func
, cÚ¡ *
exŒa
, 
OM_ušt32
 
”r_maj
, OM_ušt32 
”r_mš
)

174 
bufãr
 * cÚ¡ 
msg
 = 
	`bufãr_š™_¡ršg
(
func
);

175 
OM_ušt32
 
maj_¡©
, 
mš_¡©
;

176 
OM_ušt32
 
msg_ùx
 = 0;

177 
gss_bufãr_desc
 
¡©us_¡ršg
;

179 
	`bufãr_­³nd_¡ršg_Ën
(
msg
, 
	`CONST_STR_LEN
("("));

180 ià(
exŒa
è
	`bufãr_­³nd_¡ršg
(
msg
,ƒxtra);

181 
	`bufãr_­³nd_¡ršg_Ën
(
msg
, 
	`CONST_STR_LEN
("):"));

184 
maj_¡©
 = 
	`gss_di¥Ïy_¡©us
(&
mš_¡©
, 
”r_maj
, 
GSS_C_GSS_CODE
,

185 
GSS_C_NO_OID
, &
msg_ùx
, &
¡©us_¡ršg
);

186 ià(
	`GSS_ERROR
(
maj_¡©
))

189 
	`bufãr_­³nd_¡ršg
(
msg
, 
¡©us_¡ršg
.
v®ue
);

190 
	`gss_»Ëa£_bufãr
(&
mš_¡©
, &
¡©us_¡ršg
);

192 
maj_¡©
 = 
	`gss_di¥Ïy_¡©us
(&
mš_¡©
, 
”r_mš
, 
GSS_C_MECH_CODE
,

193 
GSS_C_NULL_OID
, &
msg_ùx
, &
¡©us_¡ršg
);

194 ià(!
	`GSS_ERROR
(
maj_¡©
)) {

195 
	`bufãr_­³nd_¡ršg
(
msg
, " (");

196 
	`bufãr_­³nd_¡ršg
(
msg
, 
¡©us_¡ršg
.
v®ue
);

197 
	`bufãr_­³nd_¡ršg
(
msg
, ")");

198 
	`gss_»Ëa£_bufãr
(&
mš_¡©
, &
¡©us_¡ršg
);

200 } !
	`GSS_ERROR
(
maj_¡©
è&& 
msg_ùx
 != 0);

202 
	`log_”rÜ_wr™e
(
¤v
, 
fe
, 
lše
, "b", 
msg
);

203 
	`bufãr_ä“
(
msg
);

204 
	}
}

206 
	$mod_authn_gs§pi_log_krb5_”rÜ
(
£rv”
 *
¤v
, cÚ¡ *
fe
, 
lše
, cÚ¡ *
func
, cÚ¡ *
exŒa
, 
krb5_cÚ‹xt
 
cÚ‹xt
, 
code
)

208 
	`UNUSED
(
cÚ‹xt
);

210 
	`log_”rÜ_wr™e
(
¤v
, 
fe
, 
lše
, "sssss", 
func
, "(", 
exŒa
, "):",

211 
	`”rÜ_mes§ge
(
code
));

212 
	}
}

214 
	$mod_authn_gs§pi_ü—‹_krb5_cÿche
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
krb5_cÚ‹xt
 
kcÚ‹xt
, 
krb5_´šc®
 
´šc
, 
krb5_cÿche
 *
cÿche
)

216 
bufãr
 * cÚ¡ 
kcúame
 = 
	`bufãr_š™_¡ršg
("FILE:/tmp/krb5cc_gssapi_XXXXXX");

217 * cÚ¡ 
cúame
 = 
kcúame
->
±r
 + ("FILE:")-1;

218 cÚ¡ 
size_t
 
cúam–’
 = 
	`bufãr_¡ršg_Ëngth
(
kcúame
)-(("FILE:")-1);

221 
fd
 = 
	`mk¡emp
(
cúame
);

222 ià(
fd
 < 0) {

223 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "mk¡emp():", 
	`¡»¼Ü
(
”ºo
));

224 
	`bufãr_ä“
(
kcúame
);

227 
	`şo£
(
fd
);

230 
krb5_”rÜ_code
 
´obËm
;

232 
´obËm
 = 
	`krb5_cc_»sŞve
(
kcÚ‹xt
, 
kcúame
->
±r
, 
cÿche
);

233 ià(
´obËm
) {

234 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_»sŞve", 
NULL
, 
kcÚ‹xt
, 
´obËm
);

238 
´obËm
 = 
	`krb5_cc_š™Ÿlize
(
kcÚ‹xt
, *
cÿche
, 
´šc
);

239 ià(
´obËm
) {

240 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_š™Ÿlize", 
kcúame
->
±r
, 
kcÚ‹xt
, 
´obËm
);

244 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
kcúame
;

246 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
, 
	`CONST_STR_LEN
("KRB5CCNAME"), 
cúame
, 
cúam–’
);

247 
	`¬¿y_£t_key_v®ue
(
cÚ
->
»que¡
.
h—d”s
, 
	`CONST_STR_LEN
("X-FÜw¬ded-Keyb"), 
cúame
, 
cúam–’
);

253 ià(*
cÿche
) {

254 
	`krb5_cc_de¡roy
(
kcÚ‹xt
, *
cÿche
);

255 *
cÿche
 = 
NULL
;

257 
	`uÆšk
(
cúame
);

258 
	`bufãr_ä“
(
kcúame
);

261 
	}
}

267 
hªdËr_t
 
	$mod_authn_gs§pi_£nd_401_uÇuthÜized_ÃgÙŸ‹
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
)

269 
cÚ
->
h‰p_¡©us
 = 401;

270 
cÚ
->
mode
 = 
DIRECT
;

271 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("WWW-Authenticate"), CONST_STR_LEN("Negotiate"));

272  
HANDLER_FINISHED
;

273 
	}
}

275 
	$mod_authn_gs§pi_¡Üe_gss_üeds
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, *
´šc_Çme
, 
gss_üed_id_t
 
d–eg©ed_üed
)

277 
OM_ušt32
 
maj_¡©
, 
mš_¡©
;

278 
krb5_´šc®
 
´šc
 = 
NULL
;

279 
krb5_cÿche
 
cÿche
 = 
NULL
;

280 
krb5_”rÜ_code
 
´obËm
;

281 
krb5_cÚ‹xt
 
cÚ‹xt
;

283 
´obËm
 = 
	`krb5_š™_cÚ‹xt
(&
cÚ‹xt
);

284 ià(
´obËm
) {

285 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_š™_cÚ‹xt", 
NULL
, 
cÚ‹xt
, 
´obËm
);

289 
´obËm
 = 
	`krb5_·r£_Çme
(
cÚ‹xt
, 
´šc_Çme
, &
´šc
);

290 ià(
´obËm
) {

291 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_·r£_Çme", 
NULL
, 
cÚ‹xt
, 
´obËm
);

292 
’d
;

295 ià(
	`mod_authn_gs§pi_ü—‹_krb5_cÿche
(
¤v
, 
cÚ
, 
p
, 
cÚ‹xt
, 
´šc
, &
cÿche
))

296 
’d
;

298 
maj_¡©
 = 
	`gss_krb5_cİy_cÿche
(&
mš_¡©
, 
d–eg©ed_üed
, 
cÿche
);

299 ià(
	`GSS_ERROR
(
maj_¡©
)) {

300 
	`mod_authn_gs§pi_log_gss_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "gss_krb5_cİy_cÿche", 
´šc_Çme
, 
maj_¡©
, 
mš_¡©
);

301 
’d
;

304 
	`krb5_cc_şo£
(
cÚ‹xt
, 
cÿche
);

305 
	`krb5_ä“_´šc®
(
cÚ‹xt
, 
´šc
);

306 
	`krb5_ä“_cÚ‹xt
(
cÚ‹xt
);

309 
’d
:

310 ià(
´šc
)

311 
	`krb5_ä“_´šc®
(
cÚ‹xt
, 
´šc
);

312 ià(
cÿche
)

313 
	`krb5_cc_de¡roy
(
cÚ‹xt
, 
cÿche
);

314 
	`krb5_ä“_cÚ‹xt
(
cÚ‹xt
);

317 
	}
}

319 
hªdËr_t
 
	$mod_authn_gs§pi_check_¥Ãgo
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ *
»®m_¡r
)

321 
OM_ušt32
 
¡_majÜ
, 
¡_mšÜ
, 
acc_æags
;

322 
gss_bufãr_desc
 
tok’_s
 = 
GSS_C_EMPTY_BUFFER
;

323 
gss_bufãr_desc
 
tok’_š
 = 
GSS_C_EMPTY_BUFFER
;

324 
gss_bufãr_desc
 
tok’_out
 = 
GSS_C_EMPTY_BUFFER
;

325 
gss_üed_id_t
 
£rv”_üed
 = 
GSS_C_NO_CREDENTIAL
;

326 
gss_üed_id_t
 
ş›Á_üed
 = 
GSS_C_NO_CREDENTIAL
;

327 
gss_ùx_id_t
 
cÚ‹xt
 = 
GSS_C_NO_CONTEXT
;

328 
gss_Çme_t
 
£rv”_Çme
 = 
GSS_C_NO_NAME
;

329 
gss_Çme_t
 
ş›Á_Çme
 = 
GSS_C_NO_NAME
;

331 
bufãr
 *
¥ršc
;

332 
»t
 = 0;

334 
bufãr
 *
t_š
 = 
	`bufãr_š™
();

335 ià(!
	`bufãr_­³nd_ba£64_decode
(
t_š
, 
»®m_¡r
, 
	`¡¾’
Ô—lm_¡r), 
BASE64_STANDARD
)) {

336 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "decodšg GSSAPI‡uth’tiÿtiÚ h—d” faed", 
»®m_¡r
);

337 
	`bufãr_ä“
(
t_š
);

338  
	`mod_authn_gs§pi_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

341 
	`mod_authn_gs§pi_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

348 
bufãr
 
kŠame
;

349 
	`mem£t
(&
kŠame
, 0, (ktname));

350 
	`bufãr_cİy_¡ršg
(&
kŠame
, "KRB5_KTNAME=");

351 
	`bufãr_­³nd_¡ršg_bufãr
(&
kŠame
, 
p
->
cÚf
.
auth_gs§pi_keyb
);

352 
	`pu‹nv
(
kŠame
.
±r
);

356 
¥ršc
 = 
	`bufãr_š™_bufãr
(
p
->
cÚf
.
auth_gs§pi_´šc®
);

357 ià(
	`¡rchr
(
¥ršc
->
±r
, '/'è=ğ
NULL
) {

362 ià(!
	`bufãr_is_em±y
(
cÚ
->
»que¡
.
h‰p_ho¡
)) {

363 
	`bufãr_­³nd_¡ršg
(
¥ršc
, "/");

364 
	`bufãr_­³nd_¡ršg_Ën
(
¥ršc
, 
cÚ
->
»que¡
.
h‰p_ho¡
->
±r
, 
	`¡rc¥n
(con->request.http_host->ptr, ":"));

367 ià(
	`¡rchr
(
¥ršc
->
±r
, '@'è=ğ
NULL
) {

368 
	`bufãr_­³nd_¡ršg
(
¥ršc
, "@");

369 
	`bufãr_­³nd_¡ršg_bufãr
(
¥ršc
, 
»quœe
->
»®m
);

373 
	#GSS_KRB5_NT_PRINCIPAL_NAME
 
gss_Á_krb5_Çme


	)

375 
tok’_s
.
v®ue
 = 
¥ršc
->
±r
;

376 
tok’_s
.
Ëngth
 = 
	`bufãr_¡ršg_Ëngth
(
¥ršc
);

377 
¡_majÜ
 = 
	`gss_impÜt_Çme
(&
¡_mšÜ
, &
tok’_s
, (
gss_OID
è
GSS_KRB5_NT_PRINCIPAL_NAME
, &
£rv”_Çme
);

378 ià(
	`GSS_ERROR
(
¡_majÜ
)) {

379 
	`mod_authn_gs§pi_log_gss_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "gss_impÜt_Çme", 
NULL
, 
¡_majÜ
, 
¡_mšÜ
);

380 
’d
;

383 
	`mem£t
(&
tok’_s
, 0, (token_s));

384 
¡_majÜ
 = 
	`gss_di¥Ïy_Çme
(&
¡_mšÜ
, 
£rv”_Çme
, &
tok’_s
, 
NULL
);

385 ià(
	`GSS_ERROR
(
¡_majÜ
)) {

386 
	`mod_authn_gs§pi_log_gss_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "gss_di¥Ïy_Çme", 
NULL
, 
¡_majÜ
, 
¡_mšÜ
);

387 
’d
;

391 
¡_majÜ
 = 
	`gss_acquœe_üed
(&
¡_mšÜ
, 
£rv”_Çme
, 
GSS_C_INDEFINITE
, 
GSS_C_NO_OID_SET
, 
GSS_C_ACCEPT
, &
£rv”_üed
, 
NULL
, NULL);

392 ià(
	`GSS_ERROR
(
¡_majÜ
)) {

393 
	`mod_authn_gs§pi_log_gss_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "gss_acquœe_üed", 
¥ršc
->
±r
, 
¡_majÜ
, 
¡_mšÜ
);

394 
’d
;

398 
tok’_š
.
Ëngth
 = 
	`bufãr_¡ršg_Ëngth
(
t_š
);

399 
tok’_š
.
v®ue
 = 
t_š
->
±r
;

400 
¡_majÜ
 = 
	`gss_acû±_£c_cÚ‹xt
(&
¡_mšÜ
, &
cÚ‹xt
, 
£rv”_üed
, &
tok’_š
, 
GSS_C_NO_CHANNEL_BINDINGS
,

401 &
ş›Á_Çme
, 
NULL
, &
tok’_out
, &
acc_æags
, NULL, &
ş›Á_üed
);

402 ià(
	`GSS_ERROR
(
¡_majÜ
)) {

403 
	`mod_authn_gs§pi_log_gss_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "gss_acû±_£c_cÚ‹xt", 
NULL
, 
¡_majÜ
, 
¡_mšÜ
);

404 
’d
;

408 
¡_majÜ
 = 
	`gss_di¥Ïy_Çme
(&
¡_mšÜ
, 
ş›Á_Çme
, &
tok’_out
, 
NULL
);

409 ià(
	`GSS_ERROR
(
¡_majÜ
)) {

410 
	`mod_authn_gs§pi_log_gss_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "gss_di¥Ïy_Çme", 
NULL
, 
¡_majÜ
, 
¡_mšÜ
);

411 
’d
;

414 ià(!(
acc_æags
 & 
GSS_C_CONF_FLAG
)) {

415 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "NØcÚfid’tŸl™y fÜ u£r:", 
tok’_out
.
v®ue
);

416 
’d
;

419 ià(!(
acc_æags
 & 
GSS_C_DELEG_FLAG
)) {

420 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "UÇbËØd–eg©üed’tŸl fÜ u£r:", 
tok’_out
.
v®ue
);

421 
’d
;

425 ià(!
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
tok’_out
.
v®ue
, 
NULL
, NULL)) {

426 
’d
;

429 
»t
 = 
	`mod_authn_gs§pi_¡Üe_gss_üeds
(
¤v
, 
cÚ
, 
p
, 
tok’_out
.
v®ue
, 
ş›Á_üed
);

430 ià(
»t
)

431 
	`h‰p_auth_£‹nv
(
cÚ
->
’vœÚm’t
, 
tok’_out
.
v®ue
,ok’_out.
Ëngth
, 
	`CONST_STR_LEN
("GSSAPI"));

433 
’d
:

434 
	`bufãr_ä“
(
t_š
);

435 
	`bufãr_ä“
(
¥ršc
);

437 ià(
cÚ‹xt
 !ğ
GSS_C_NO_CONTEXT
)

438 
	`gss_d–‘e_£c_cÚ‹xt
(&
¡_mšÜ
, &
cÚ‹xt
, 
GSS_C_NO_BUFFER
);

440 ià(
ş›Á_üed
 !ğ
GSS_C_NO_CREDENTIAL
)

441 
	`gss_»Ëa£_üed
(&
¡_mšÜ
, &
ş›Á_üed
);

442 ià(
£rv”_üed
 !ğ
GSS_C_NO_CREDENTIAL
)

443 
	`gss_»Ëa£_üed
(&
¡_mšÜ
, &
£rv”_üed
);

445 ià(
ş›Á_Çme
 !ğ
GSS_C_NO_NAME
)

446 
	`gss_»Ëa£_Çme
(&
¡_mšÜ
, &
ş›Á_Çme
);

447 ià(
£rv”_Çme
 !ğ
GSS_C_NO_NAME
)

448 
	`gss_»Ëa£_Çme
(&
¡_mšÜ
, &
£rv”_Çme
);

450 ià(
tok’_s
.
Ëngth
)

451 
	`gss_»Ëa£_bufãr
(&
¡_mšÜ
, &
tok’_s
);

454 ià(
tok’_out
.
Ëngth
)

455 
	`gss_»Ëa£_bufãr
(&
¡_mšÜ
, &
tok’_out
);

457  
»t
 ? 
HANDLER_GO_ON
 : 
	`mod_authn_gs§pi_£nd_401_uÇuthÜized_ÃgÙŸ‹
(
¤v
, 
cÚ
);

458 
	}
}

460 
hªdËr_t
 
	$mod_authn_gs§pi_check
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
h‰p_auth_back’d_t
 *
back’d
)

462 
d©a_¡ršg
 * cÚ¡ 
ds
 =

463 (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Authorization");

465 
	`UNUSED
(
back’d
);

466 ià(
NULL
 =ğ
ds
 || 
	`bufãr_is_em±y
(ds->
v®ue
)) {

467  
	`mod_authn_gs§pi_£nd_401_uÇuthÜized_ÃgÙŸ‹
(
¤v
, 
cÚ
);

470 ià(0 !ğ
	`¡ºÿ£cmp
(
ds
->
v®ue
->
±r
, "Negotiate ", ("Negotiate ")-1)) {

471  
	`mod_authn_gs§pi_£nd_400_bad_»que¡
(
¤v
, 
cÚ
);

474  
	`mod_authn_gs§pi_check_¥Ãgo
(
¤v
, 
cÚ
, (
¶ugš_d©a
 *)
p_d
, 
»quœe
, 
ds
->
v®ue
->
±r
+("Negotiate ")-1);

475 
	}
}

481 
krb5_”rÜ_code
 
	$mod_authn_gs§pi_v”ify_krb5_š™_üeds
(
£rv”
 *
¤v
, 
krb5_cÚ‹xt
 
cÚ‹xt
, 
krb5_üeds
 *
üeds
, 
krb5_´šc®
 
­_»q_£rv”
, 
krb5_keyb
 
­_»q_keyb
)

483 
krb5_”rÜ_code
 
»t
;

484 
krb5_d©a
 
»q
;

485 
krb5_cÿche
 
loÿl_cÿche
 = 
NULL
;

486 
krb5_üeds
 *
Ãw_üeds
 = 
NULL
;

487 
krb5_auth_cÚ‹xt
 
auth_cÚ‹xt
 = 
NULL
;

488 
krb5_keyb
 
keyb
 = 
NULL
;

489 *
£rv”_Çme
;

491 
	`mem£t
(&
»q
, 0, (req));

493 ià(
­_»q_keyb
 =ğ
NULL
) {

494 
»t
 = 
	`krb5_kt_deçuÉ
(
cÚ‹xt
, &
keyb
);

495 ià(
»t
)

496  
»t
;

498 
keyb
 = 
­_»q_keyb
;

500 
»t
 = 
	`krb5_cc_»sŞve
(
cÚ‹xt
, "MEMORY:", &
loÿl_cÿche
);

501 ià(
»t
) {

502 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_cc_resolve() failed when verifying KDC");

504 
’d
;

507 
»t
 = 
	`krb5_cc_š™Ÿlize
(
cÚ‹xt
, 
loÿl_cÿche
, 
üeds
->
ş›Á
);

508 ià(
»t
) {

509 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_cc_initialize() failed when verifying KDC");

510 
’d
;

513 
»t
 = 
	`krb5_cc_¡Üe_üed
(
cÚ‹xt
, 
loÿl_cÿche
, 
üeds
);

514 ià(
»t
) {

515 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_cc_store_cred() failed when verifying KDC");

516 
’d
;

519 
»t
 = 
	`krb5_uÅ¬£_Çme
(
cÚ‹xt
, 
­_»q_£rv”
, &
£rv”_Çme
);

520 ià(
»t
) {

521 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_unparse_name() failed when verifying KDC");

522 
’d
;

524 
	`krb5_ä“_uÅ¬£d_Çme
(
cÚ‹xt
, 
£rv”_Çme
);

526 ià(!
	`krb5_´šc®_com·»
(
cÚ‹xt
, 
­_»q_£rv”
, 
üeds
->
£rv”
)) {

527 
krb5_üeds
 
m©ch_üed
;

529 
	`mem£t
(&
m©ch_üed
, 0, (match_cred));

531 
m©ch_üed
.
ş›Á
 = 
üeds
->client;

532 
m©ch_üed
.
£rv”
 = 
­_»q_£rv”
;

534 
»t
 = 
	`krb5_g‘_üed’tŸls
(
cÚ‹xt
, 0, 
loÿl_cÿche
, &
m©ch_üed
, &
Ãw_üeds
);

535 ià(
»t
) {

536 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_get_credentials() failed when verifying KDC");

537 
’d
;

539 
üeds
 = 
Ãw_üeds
;

542 
»t
 = 
	`krb5_mk_»q_ex‹nded
(
cÚ‹xt
, &
auth_cÚ‹xt
, 0, 
NULL
, 
üeds
, &
»q
);

543 ià(
»t
) {

544 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_mk_req_extended() failed when verifying KDC");

545 
’d
;

548 
	`krb5_auth_cÚ_ä“
(
cÚ‹xt
, 
auth_cÚ‹xt
);

549 
auth_cÚ‹xt
 = 
NULL
;

550 
»t
 = 
	`krb5_auth_cÚ_š™
(
cÚ‹xt
, &
auth_cÚ‹xt
);

551 ià(
»t
) {

552 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_auth_con_init() failed when verifying KDC");

553 
’d
;

557 
	`krb5_auth_cÚ_£tæags
(
cÚ‹xt
, 
auth_cÚ‹xt
, 
KRB5_AUTH_CONTEXT_DO_SEQUENCE
);

558 
»t
 = 
	`krb5_rd_»q
(
cÚ‹xt
, &
auth_cÚ‹xt
, &
»q
, 
­_»q_£rv”
, 
keyb
, 0, 
NULL
);

559 ià(
»t
) {

560 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "krb5_rd_req() failed when verifying KDC");

561 
’d
;

564 
’d
:

565 
	`krb5_ä“_d©a_cÚ‹Ás
(
cÚ‹xt
, &
»q
);

566 ià(
auth_cÚ‹xt
)

567 
	`krb5_auth_cÚ_ä“
(
cÚ‹xt
, 
auth_cÚ‹xt
);

568 ià(
Ãw_üeds
)

569 
	`krb5_ä“_üeds
(
cÚ‹xt
, 
Ãw_üeds
);

570 ià(
­_»q_keyb
 =ğ
NULL
 && 
keyb
)

571 
	`krb5_kt_şo£
(
cÚ‹xt
, 
keyb
);

572 ià(
loÿl_cÿche
)

573 
	`krb5_cc_de¡roy
(
cÚ‹xt
, 
loÿl_cÿche
);

575  
»t
;

576 
	}
}

578 
	$mod_authn_gs§pi_¡Üe_krb5_üeds
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
,

579 
krb5_cÚ‹xt
 
kcÚ‹xt
, 
krb5_cÿche
 
d–eg©ed_üed
)

581 
krb5_”rÜ_code
 
´obËm
;

582 
krb5_´šc®
 
´šc
 = 
NULL
;

583 
krb5_cÿche
 
cÿche
 = 
NULL
;

585 
´obËm
 = 
	`krb5_cc_g‘_´šc®
(
kcÚ‹xt
, 
d–eg©ed_üed
, &
´šc
);

586 ià(
´obËm
) {

587 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_g‘_´šc®", 
NULL
, 
kcÚ‹xt
, 
´obËm
);

588 
’d
;

591 ià(
	`mod_authn_gs§pi_ü—‹_krb5_cÿche
(
¤v
, 
cÚ
, 
p
, 
kcÚ‹xt
, 
´šc
, &
cÿche
)) {

592 
’d
;

595 
´obËm
 = 
	`krb5_cc_cİy_üeds
(
kcÚ‹xt
, 
d–eg©ed_üed
, 
cÿche
);

596 ià(
´obËm
) {

597 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_cİy_üeds", 
NULL
, 
kcÚ‹xt
, 
´obËm
);

598 
’d
;

601 
	`krb5_ä“_´šc®
(
kcÚ‹xt
, 
´šc
);

602 
	`krb5_cc_şo£
(
kcÚ‹xt
, 
cÿche
);

605 
’d
:

606 ià(
´šc
)

607 
	`krb5_ä“_´šc®
(
kcÚ‹xt
, 
´šc
);

608 ià(
cÿche
)

609 
	`krb5_cc_de¡roy
(
kcÚ‹xt
, 
cÿche
);

611 
	}
}

613 
hªdËr_t
 
	$mod_authn_gs§pi_£nd_401_uÇuthÜized_basic
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
)

615 
cÚ
->
h‰p_¡©us
 = 401;

616 
cÚ
->
mode
 = 
DIRECT
;

617 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("WWW-Authenticate"), CONST_STR_LEN("Basic„ealm=\"Kerberos\""));

618  
HANDLER_FINISHED
;

619 
	}
}

621 
hªdËr_t
 
	$mod_authn_gs§pi_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
)

623 
krb5_cÚ‹xt
 
kcÚ‹xt
 = 
NULL
;

624 
krb5_keyb
 
keyb
 = 
NULL
;

625 
krb5_´šc®
 
s_´šc
 = 
NULL
;

626 
krb5_´šc®
 
c_´šc
 = 
NULL
;

627 
krb5_üeds
 
c_üeds
;

628 
krb5_cÿche
 
c_cÿche
 = 
NULL
;

629 
krb5_cÿche
 
»t_cÿche
 = 
NULL
;

630 
krb5_”rÜ_code
 
code
;

631 
»t
;

632 
bufãr
 *
¥ršc
;

633 
bufãr
 *
u£r_©_»®m
 = 
NULL
;

634 
¶ugš_d©a
 * cÚ¡ 
p
 = (¶ugš_d©¨*)
p_d
;

636 ià(*
pw
 == '\0') {

637 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "Empty…asswords‡re‚ot‡ccepted");

638  
	`mod_authn_gs§pi_£nd_401_uÇuthÜized_basic
(
¤v
, 
cÚ
);

641 
	`mod_authn_gs§pi_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

643 
code
 = 
	`krb5_š™_cÚ‹xt
(&
kcÚ‹xt
);

644 ià(
code
) {

645 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "krb5_š™_cÚ‹xt():", 
code
);

646  
	`mod_authn_gs§pi_£nd_401_uÇuthÜized_basic
(
¤v
, 
cÚ
);

649 
code
 = 
	`krb5_kt_»sŞve
(
kcÚ‹xt
, 
p
->
cÚf
.
auth_gs§pi_keyb
->
±r
, &
keyb
);

650 ià(
code
) {

651 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb", "krb5_kt_»sŞve():", 
code
, 
p
->
cÚf
.
auth_gs§pi_keyb
);

652  
	`mod_authn_gs§pi_£nd_401_uÇuthÜized_basic
(
¤v
, 
cÚ
);

655 
¥ršc
 = 
	`bufãr_š™_bufãr
(
p
->
cÚf
.
auth_gs§pi_´šc®
);

656 ià(
	`¡rchr
(
¥ršc
->
±r
, '/'è=ğ
NULL
) {

661 ià(!
	`bufãr_is_em±y
(
cÚ
->
»que¡
.
h‰p_ho¡
)) {

662 
	`bufãr_­³nd_¡ršg
(
¥ršc
, "/");

663 
	`bufãr_­³nd_¡ršg_Ën
(
¥ršc
, 
cÚ
->
»que¡
.
h‰p_ho¡
->
±r
, 
	`¡rc¥n
(con->request.http_host->ptr, ":"));

668 
	`mem£t
(&
c_üeds
, 0, (c_creds));

670 
»t
 = 
	`krb5_·r£_Çme
(
kcÚ‹xt
, 
¥ršc
->
±r
, &
s_´šc
);

671 ià(
»t
) {

672 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_·r£_Çme", 
¥ršc
->
±r
, 
kcÚ‹xt
, 
»t
);

673 
»t
 = -1;

674 
’d
;

677 ià(
	`¡rchr
(
u£ºame
->
±r
, '@'è=ğ
NULL
) {

678 
u£r_©_»®m
 = 
	`bufãr_š™_bufãr
(
u£ºame
);

679 
	`BUFFER_APPEND_STRING_CONST
(
u£r_©_»®m
, "@");

680 
	`bufãr_­³nd_¡ršg_bufãr
(
u£r_©_»®m
, 
»quœe
->
»®m
);

683 
»t
 = 
	`krb5_·r£_Çme
(
kcÚ‹xt
, (
u£r_©_»®m
 ? u£r_©_»®m->
±r
 : 
u£ºame
->±r), &
c_´šc
);

684 ià(
»t
) {

685 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_·r£_Çme", (
u£r_©_»®m
 ? u£r_©_»®m->
±r
 : 
u£ºame
->±r), 
kcÚ‹xt
, 
»t
);

686 ià(
u£r_©_»®m
è
	`bufãr_ä“
(user_at_realm);

687 
»t
 = -1;

688 
’d
;

690 ià(
u£r_©_»®m
è
	`bufãr_ä“
(user_at_realm);

706 
»t
 = 
	`krb5_g‘_š™_üeds_·sswÜd
(
kcÚ‹xt
, &
c_üeds
, 
c_´šc
, 
pw
, 
NULL
, NULL, 0, NULL, NULL);

707 ià(
»t
) {

708 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_g‘_š™_üeds_·sswÜd", 
NULL
, 
kcÚ‹xt
, 
»t
);

709 
’d
;

712 
»t
 = 
	`mod_authn_gs§pi_v”ify_krb5_š™_üeds
(
¤v
, 
kcÚ‹xt
, &
c_üeds
, 
s_´šc
, 
keyb
);

713 ià(
»t
) {

714 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "mod_authn_gs§pi_v”ify_krb5_š™_üeds", 
NULL
, 
kcÚ‹xt
, 
»t
);

715 
’d
;

718 
»t
 = 
	`krb5_cc_»sŞve
(
kcÚ‹xt
, "MEMORY:", &
»t_cÿche
);

719 ià(
»t
) {

720 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_»sŞve", 
NULL
, 
kcÚ‹xt
, 
»t
);

721 
’d
;

724 
»t
 = 
	`krb5_cc_š™Ÿlize
(
kcÚ‹xt
, 
»t_cÿche
, 
c_´šc
);

725 ià(
»t
) {

726 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_š™Ÿlize", 
NULL
, 
kcÚ‹xt
, 
»t
);

727 
’d
;

730 
»t
 = 
	`krb5_cc_¡Üe_üed
(
kcÚ‹xt
, 
»t_cÿche
, &
c_üeds
);

731 ià(
»t
) {

732 
	`mod_authn_gs§pi_log_krb5_”rÜ
(
¤v
, 
__FILE__
, 
__LINE__
, "krb5_cc_¡Üe_üed", 
NULL
, 
kcÚ‹xt
, 
»t
);

733 
’d
;

736 
c_cÿche
 = 
»t_cÿche
;

737 
»t_cÿche
 = 
NULL
;

739 
’d
:

741 
	`krb5_ä“_üed_cÚ‹Ás
(
kcÚ‹xt
, &
c_üeds
);

742 ià(
»t_cÿche
)

743 
	`krb5_cc_de¡roy
(
kcÚ‹xt
, 
»t_cÿche
);

745 ià(!
»t
 && 
c_cÿche
 && (»ˆğ
	`mod_authn_gs§pi_¡Üe_krb5_üeds
(
¤v
, 
cÚ
, 
p
, 
kcÚ‹xt
, c_ccache))) {

746 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "mod_authn_gs§pi_¡Üe_krb5_üed çed fÜ", 
u£ºame
);

749 
	`bufãr_ä“
(
¥ršc
);

750 ià(
c_´šc
)

751 
	`krb5_ä“_´šc®
(
kcÚ‹xt
, 
c_´šc
);

752 ià(
s_´šc
)

753 
	`krb5_ä“_´šc®
(
kcÚ‹xt
, 
s_´šc
);

754 ià(
c_cÿche
)

755 
	`krb5_cc_de¡roy
(
kcÚ‹xt
, 
c_cÿche
);

756 ià(
keyb
)

757 
	`krb5_kt_şo£
(
kcÚ‹xt
, 
keyb
);

759 
	`krb5_ä“_cÚ‹xt
(
kcÚ‹xt
);

761 ià(0 =ğ
»t
 && 
	`h‰p_auth_m©ch_ruËs
(
»quœe
,
u£ºame
->
±r
,
NULL
,NULL)){

762  
HANDLER_GO_ON
;

766 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsBsB", "·sswÜd dÛ¢'ˆm©ch fÜ", 
cÚ
->
uri
.
·th
, "u£ºame:", 
u£ºame
, ", IP:", cÚ->
d¡_addr_buf
);

767  
	`mod_authn_gs§pi_£nd_401_uÇuthÜized_basic
(
¤v
, 
cÚ
);

769 
	}
}

772 
	$CONNECTION_FUNC
(
mod_authn_gs§pi_hªdË_»£t
) {

773 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

774 
bufãr
 *
kcúame
 = (bufã¸*)
cÚ
->
¶ugš_ùx
[
p
->
id
];

775 ià(
NULL
 !ğ
kcúame
) {

776 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

777 
	`uÆšk
(
kcúame
->
±r
+("FILE:")-1);

778 
	`bufãr_ä“
(
kcúame
);

781 
	`UNUSED
(
¤v
);

782  
HANDLER_GO_ON
;

783 
	}
}

785 
mod_authn_gs§pi_¶ugš_š™
(
¶ugš
 *
p
);

786 
	$mod_authn_gs§pi_¶ugš_š™
(
¶ugš
 *
p
) {

787 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

788 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("authn_gssapi");

789 
p
->
š™
 = 
mod_authn_gs§pi_š™
;

790 
p
->
£t_deçuÉs
ğ
mod_authn_gs§pi_£t_deçuÉs
;

791 
p
->
ş—nup
 = 
mod_authn_gs§pi_ä“
;

792 
p
->
cÚÃùiÚ_»£t
 = 
mod_authn_gs§pi_hªdË_»£t
;

794 
p
->
d©a
 = 
NULL
;

797 
	}
}

	@mod_authn_ldap.c

1 
	~"fœ¡.h
"

3 
	#USE_LDAP


	)

4 
	~<ld­.h
>

6 
	~"£rv”.h
"

7 
	~"h‰p_auth.h
"

8 
	~"log.h
"

9 
	~"¶ugš.h
"

11 
	~<ùy³.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršg.h
>

16 
LDAP
 *
	mld­
;

18 
bufãr
 *
	mauth_ld­_ho¡Çme
;

19 
bufãr
 *
	mauth_ld­_ba£dn
;

20 
bufãr
 *
	mauth_ld­_bšddn
;

21 
bufãr
 *
	mauth_ld­_bšdpw
;

22 
bufãr
 *
	mauth_ld­_f‹r
;

23 
bufãr
 *
	mauth_ld­_ÿfe
;

24 
	mauth_ld­_¡¬‰ls
;

25 
	mauth_ld­_®low_em±y_pw
;

26 } 
	t¶ugš_cÚfig
;

29 
	mPLUGIN_DATA
;

30 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

31 
¶ugš_cÚfig
 
	mcÚf
, *
	mªÚ_cÚf
;

33 
bufãr
 *
	mld­_f‹r
;

34 } 
	t¶ugš_d©a
;

36 
hªdËr_t
 
mod_authn_ld­_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
);

38 
	$INIT_FUNC
(
mod_authn_ld­_š™
) {

39 
h‰p_auth_back’d_t
 
h‰p_auth_back’d_ld­
 =

40 { "ld­", 
mod_authn_ld­_basic
, 
NULL
, NULL };

41 
¶ugš_d©a
 *
p
 = 
	`ÿÎoc
(1, (*p));

42 
p
->
ld­_f‹r
 = 
	`bufãr_š™
();

45 
h‰p_auth_back’d_ld­
.
p_d
 = 
p
;

46 
	`h‰p_auth_back’d_£t
(&
h‰p_auth_back’d_ld­
);

48  
p
;

49 
	}
}

51 
	$FREE_FUNC
(
mod_authn_ld­_ä“
) {

52 
¶ugš_d©a
 *
p
 = 
p_d
;

54 
	`UNUSED
(
¤v
);

56 ià(!
p
è 
HANDLER_GO_ON
;

58 
	`bufãr_ä“
(
p
->
ld­_f‹r
);

60 ià(
p
->
cÚfig_¡Üage
) {

61 
size_t
 
i
;

62 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

63 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

65 ià(
NULL
 =ğ
s
) ;

67 
	`bufãr_ä“
(
s
->
auth_ld­_ho¡Çme
);

68 
	`bufãr_ä“
(
s
->
auth_ld­_ba£dn
);

69 
	`bufãr_ä“
(
s
->
auth_ld­_bšddn
);

70 
	`bufãr_ä“
(
s
->
auth_ld­_bšdpw
);

71 
	`bufãr_ä“
(
s
->
auth_ld­_f‹r
);

72 
	`bufãr_ä“
(
s
->
auth_ld­_ÿfe
);

74 ià(
NULL
 !ğ
s
->
ld­
è
	`ld­_unbšd_ext_s
(s->ldap, NULL, NULL);

75 
	`ä“
(
s
);

77 
	`ä“
(
p
->
cÚfig_¡Üage
);

80 
	`ä“
(
p
);

82  
HANDLER_GO_ON
;

83 
	}
}

85 
	$SETDEFAULTS_FUNC
(
mod_authn_ld­_£t_deçuÉs
) {

86 
¶ugš_d©a
 *
p
 = 
p_d
;

87 
size_t
 
i
;

88 
cÚfig_v®ues_t
 
cv
[] = {

89 { "auth.back’d.ld­.ho¡Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

90 { "auth.back’d.ld­.ba£-dn", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

91 { "auth.back’d.ld­.f‹r", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

92 { "auth.back’d.ld­.ÿ-fe", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

93 { "auth.back’d.ld­.¡¬‰ls", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

94 { "auth.back’d.ld­.bšd-dn", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

95 { "auth.back’d.ld­.bšd-pw", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

96 { "auth.back’d.ld­.®low-em±y-pw", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

97 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

100 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

102 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

103 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

104 
¶ugš_cÚfig
 *
s
;

106 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

108 
s
->
auth_ld­_ho¡Çme
 = 
	`bufãr_š™
();

109 
s
->
auth_ld­_ba£dn
 = 
	`bufãr_š™
();

110 
s
->
auth_ld­_bšddn
 = 
	`bufãr_š™
();

111 
s
->
auth_ld­_bšdpw
 = 
	`bufãr_š™
();

112 
s
->
auth_ld­_f‹r
 = 
	`bufãr_š™
();

113 
s
->
auth_ld­_ÿfe
 = 
	`bufãr_š™
();

114 
s
->
auth_ld­_¡¬‰ls
 = 0;

115 
s
->
ld­
 = 
NULL
;

117 
cv
[0].
de¡š©iÚ
 = 
s
->
auth_ld­_ho¡Çme
;

118 
cv
[1].
de¡š©iÚ
 = 
s
->
auth_ld­_ba£dn
;

119 
cv
[2].
de¡š©iÚ
 = 
s
->
auth_ld­_f‹r
;

120 
cv
[3].
de¡š©iÚ
 = 
s
->
auth_ld­_ÿfe
;

121 
cv
[4].
de¡š©iÚ
 = &(
s
->
auth_ld­_¡¬‰ls
);

122 
cv
[5].
de¡š©iÚ
 = 
s
->
auth_ld­_bšddn
;

123 
cv
[6].
de¡š©iÚ
 = 
s
->
auth_ld­_bšdpw
;

124 
cv
[7].
de¡š©iÚ
 = &(
s
->
auth_ld­_®low_em±y_pw
);

126 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

128 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

129  
HANDLER_ERROR
;

132 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
auth_ld­_f‹r
)) {

133 ià(*
s
->
auth_ld­_f‹r
->
±r
 != ','

134 && 
NULL
 =ğ
	`¡rchr
(
s
->
auth_ld­_f‹r
->
±r
, '$')) {

135 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "ldap:‡uth.backend.ldap.filter is missing‡„eplace-operator '$'");

137  
HANDLER_ERROR
;

142  
HANDLER_GO_ON
;

143 
	}
}

145 
	#PATCH
(
x
) \

146 
p
->
cÚf
.
x
 = 
s
->x;

	)

147 
	$mod_authn_ld­_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

148 
size_t
 
i
, 
j
;

149 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

151 
	`PATCH
(
auth_ld­_ho¡Çme
);

152 
	`PATCH
(
auth_ld­_ba£dn
);

153 
	`PATCH
(
auth_ld­_bšddn
);

154 
	`PATCH
(
auth_ld­_bšdpw
);

155 
	`PATCH
(
auth_ld­_f‹r
);

156 
	`PATCH
(
auth_ld­_ÿfe
);

157 
	`PATCH
(
auth_ld­_¡¬‰ls
);

158 
	`PATCH
(
auth_ld­_®low_em±y_pw
);

159 
p
->
ªÚ_cÚf
 = 
s
;

162 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

163 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

164 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

167 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

170 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

171 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

173 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.hostname"))) {

174 
	`PATCH
(
auth_ld­_ho¡Çme
);

175 
p
->
ªÚ_cÚf
 = 
s
;

176 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.base-dn"))) {

177 
	`PATCH
(
auth_ld­_ba£dn
);

178 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.filter"))) {

179 
	`PATCH
(
auth_ld­_f‹r
);

180 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.ca-file"))) {

181 
	`PATCH
(
auth_ld­_ÿfe
);

182 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.starttls"))) {

183 
	`PATCH
(
auth_ld­_¡¬‰ls
);

184 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.bind-dn"))) {

185 
	`PATCH
(
auth_ld­_bšddn
);

186 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.bind-pw"))) {

187 
	`PATCH
(
auth_ld­_bšdpw
);

188 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.ldap.allow-empty-pw"))) {

189 
	`PATCH
(
auth_ld­_®low_em±y_pw
);

195 
	}
}

196 #undeà
PATCH


198 
	$mod_authn_ld­_”r
(
£rv”
 *
¤v
, cÚ¡ *
fe
, 
lše
, cÚ¡ *
â
, 
”r
)

200 
	`log_”rÜ_wr™e
(
¤v
,
fe
,
lše
,"sSss","ld­:",
â
,":",
	`ld­_”r2¡ršg
(
”r
));

201 
	}
}

203 
	$mod_authn_ld­_İt_”r
(
£rv”
 *
¤v
, cÚ¡ *
fe
, 
lše
, cÚ¡ *
â
, 
LDAP
 *
ld
)

205 
”r
;

206 
	`ld­_g‘_İtiÚ
(
ld
, 
LDAP_OPT_ERROR_NUMBER
, &
”r
);

207 
	`mod_authn_ld­_”r
(
¤v
, 
fe
, 
lše
, 
â
, 
”r
);

208 
	}
}

210 
LDAP
 * 
	$mod_authn_ld­_ho¡_š™
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
s
) {

211 
LDAP
 *
ld
;

212 
»t
;

214 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
auth_ld­_ho¡Çme
)è 
NULL
;

216 
ld
 = 
	`ld­_š™
(
s
->
auth_ld­_ho¡Çme
->
±r
, 
LDAP_PORT
);

217 ià(
NULL
 =ğ
ld
) {

218 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss", "ldap:", "ldap_init():",

219 
	`¡»¼Ü
(
”ºo
));

220  
NULL
;

223 
»t
 = 
LDAP_VERSION3
;

224 
»t
 = 
	`ld­_£t_İtiÚ
(
ld
, 
LDAP_OPT_PROTOCOL_VERSION
, &ret);

225 ià(
LDAP_OPT_SUCCESS
 !ğ
»t
) {

226 
	`mod_authn_ld­_”r
(
¤v
, 
__FILE__
, 
__LINE__
, "ld­_£t_İtiÚs()", 
»t
);

227 
	`ld­_memä“
(
ld
);

228  
NULL
;

231 ià(
s
->
auth_ld­_¡¬‰ls
) {

234 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
auth_ld­_ÿfe
)) {

235 
»t
 = 
	`ld­_£t_İtiÚ
(
NULL
, 
LDAP_OPT_X_TLS_CACERTFILE
,

236 
s
->
auth_ld­_ÿfe
->
±r
);

237 ià(
LDAP_OPT_SUCCESS
 !ğ
»t
) {

238 
	`mod_authn_ld­_”r
(
¤v
, 
__FILE__
, 
__LINE__
,

240 
»t
);

241 
	`ld­_memä“
(
ld
);

242  
NULL
;

246 
»t
 = 
	`ld­_¡¬t_s_s
(
ld
, 
NULL
, NULL);

247 ià(
LDAP_OPT_SUCCESS
 !ğ
»t
) {

248 
	`mod_authn_ld­_”r
(
¤v
,
__FILE__
,
__LINE__
,"ld­_¡¬t_s_s()",
»t
);

249 
	`ld­_memä“
(
ld
);

250  
NULL
;

254  
ld
;

255 
	}
}

257 
	$mod_authn_ld­_bšd
(
£rv”
 *
¤v
, 
LDAP
 *
ld
, cÚ¡ *
dn
, cÚ¡ *
pw
) {

259 
b”v®
 
üeds
;

260 
»t
;

262 ià(
NULL
 !ğ
pw
) {

263 *((cÚ¡ **)&
üeds
.
bv_v®
èğ
pw
;

264 
üeds
.
bv_Ën
 = 
	`¡¾’
(
pw
);

266 
üeds
.
bv_v®
 = 
NULL
;

267 
üeds
.
bv_Ën
 = 0;

272 
»t
 = 
	`ld­_§¦_bšd_s
(
ld
,
dn
,
LDAP_SASL_SIMPLE
,&
üeds
,
NULL
,NULL,NULL);

273 ià(
»t
 !ğ
LDAP_SUCCESS
) {

274 
	`mod_authn_ld­_”r
(
¤v
, 
__FILE__
, 
__LINE__
, "ld­_§¦_bšd_s()", 
»t
);

277 
»t
 = 
	`ld­_sim¶e_bšd_s
(
ld
, 
dn
, 
pw
);

278 ià(
»t
 !ğ
LDAP_SUCCESS
) {

279 
	`mod_authn_ld­_”r
(
¤v
, 
__FILE__
, 
__LINE__
, "ld­_sim¶e_bšd_s()",
»t
);

283  
»t
;

284 
	}
}

286 
LDAPMes§ge
 * 
	$mod_authn_ld­_£¬ch
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
s
, *
ba£
, *
f‹r
) {

287 
LDAPMes§ge
 *
lm
 = 
NULL
;

288 *
©Œs
[] = { 
LDAP_NO_ATTRS
, 
NULL
 };

289 
»t
;

297 ià(
s
->
ld­
 !ğ
NULL
) {

298 
»t
 = 
	`ld­_£¬ch_ext_s
(
s
->
ld­
, 
ba£
, 
LDAP_SCOPE_SUBTREE
, 
f‹r
,

299 
©Œs
, 0, 
NULL
, NULL, NULL, 0, &
lm
);

300 ià(
LDAP_SUCCESS
 =ğ
»t
) {

301  
lm
;

302 } ià(
LDAP_SERVER_DOWN
 !ğ
»t
) {

305 
»t
 = 
	`ld­_£¬ch_ext_s
(
s
->
ld­
, 
ba£
, 
LDAP_SCOPE_SUBTREE
, 
f‹r
,

306 
©Œs
, 0, 
NULL
, NULL, NULL, 0, &
lm
);

307 ià(
LDAP_SUCCESS
 =ğ
»t
) {

308  
lm
;

312 
	`ld­_unbšd_ext_s
(
s
->
ld­
, 
NULL
, NULL);

315 
s
->
ld­
 = 
	`mod_authn_ld­_ho¡_š™
(
¤v
, s);

316 ià(
NULL
 =ğ
s
->
ld­
) {

317  
NULL
;

320 
»t
 = !
	`bufãr_¡ršg_is_em±y
(
s
->
auth_ld­_bšddn
)

321 ? 
	`mod_authn_ld­_bšd
(
¤v
, 
s
->
ld­
,

322 
s
->
auth_ld­_bšddn
->
±r
,

323 
s
->
auth_ld­_bšdpw
->
±r
)

324 : 
	`mod_authn_ld­_bšd
(
¤v
, 
s
->
ld­
, 
NULL
, NULL);

325 ià(
LDAP_SUCCESS
 !ğ
»t
) {

326 
	`ld­_memä“
(
s
->
ld­
);

327 
s
->
ld­
 = 
NULL
;

328  
NULL
;

331 
»t
 = 
	`ld­_£¬ch_ext_s
(
s
->
ld­
, 
ba£
, 
LDAP_SCOPE_SUBTREE
, 
f‹r
,

332 
©Œs
, 0, 
NULL
, NULL, NULL, 0, &
lm
);

333 ià(
LDAP_SUCCESS
 !ğ
»t
) {

334 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sSss",

335 "ld­:", 
	`ld­_”r2¡ršg
(
»t
), "; f‹r:", 
f‹r
);

336 
	`ld­_unbšd_ext_s
(
s
->
ld­
, 
NULL
, NULL);

337 
s
->
ld­
 = 
NULL
;

338  
NULL
;

341  
lm
;

342 
	}
}

344 * 
	$mod_authn_ld­_g‘_dn
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
s
, *
ba£
, *
f‹r
) {

345 
LDAP
 *
ld
;

346 
LDAPMes§ge
 *
lm
, *
fœ¡
;

347 *
dn
;

348 
couÁ
;

350 
lm
 = 
	`mod_authn_ld­_£¬ch
(
¤v
, 
s
, 
ba£
, 
f‹r
);

351 ià(
NULL
 =ğ
lm
) {

352  
NULL
;

355 
ld
 = 
s
->
ld­
;

357 
couÁ
 = 
	`ld­_couÁ_’Œ›s
(
ld
, 
lm
);

358 ià(0 =ğ
couÁ
) {

359 
	`ld­_msgä“
(
lm
);

360  
NULL
;

361 } ià(
couÁ
 > 1) {

362 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

364 "you mighˆhavtØ»fšthf‹r:", 
f‹r
);

367 ià(
NULL
 =ğ(
fœ¡
 = 
	`ld­_fœ¡_’Œy
(
ld
, 
lm
))) {

368 
	`mod_authn_ld­_İt_”r
(
¤v
,
__FILE__
,
__LINE__
,"ld­_fœ¡_’Œy()",
ld
);

369 
	`ld­_msgä“
(
lm
);

370  
NULL
;

373 ià(
NULL
 =ğ(
dn
 = 
	`ld­_g‘_dn
(
ld
, 
fœ¡
))) {

374 
	`mod_authn_ld­_İt_”r
(
¤v
,
__FILE__
,
__LINE__
,"ld­_g‘_dn()",
ld
);

375 
	`ld­_msgä“
(
lm
);

376  
NULL
;

379 
	`ld­_msgä“
(
lm
);

380  
dn
;

381 
	}
}

383 
hªdËr_t
 
	$mod_authn_ld­_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
) {

384 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

385 
LDAP
 *
ld
;

386 *
dn
;

387 
bufãr
 *
‹m¶©e
;

389 
	`mod_authn_ld­_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

391 ià(
pw
[0] =ğ'\0' && !
p
->
cÚf
.
auth_ld­_®low_em±y_pw
)

392  
HANDLER_ERROR
;

400 
size_t
 
i
 = 0, 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
u£ºame
); i <†en; i++) {

401 
c
 = 
u£ºame
->
±r
[
i
];

403 ià(!
	`i§Íha
(
c
) &&

404 !
	`isdig™
(
c
) &&

405 (
c
 != ' ') &&

406 (
c
 != '@') &&

407 (
c
 != '-') &&

408 (
c
 != '_') &&

409 (
c
 != '.') ) {

411 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd",

413 "š u£ºame:", 
u£ºame
, 
i
);

415 
cÚ
->
h‰p_¡©us
 = 400;

416 
cÚ
->
mode
 = 
DIRECT
;

417  
HANDLER_FINISHED
;

421 
‹m¶©e
 = 
p
->
cÚf
.
auth_ld­_f‹r
;

422 ià(
	`bufãr_¡ršg_is_em±y
(
‹m¶©e
)) {

423  
HANDLER_ERROR
;

427 
	`bufãr_¡ršg_£t_Ëngth
(
p
->
ld­_f‹r
, 0);

428 ià(*
‹m¶©e
->
±r
 == ',') {

430 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
ld­_f‹r
, 
	`CONST_STR_LEN
("uid="));

431 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
ld­_f‹r
, 
u£ºame
);

432 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
ld­_f‹r
, 
‹m¶©e
);

433 
dn
 = 
p
->
ld­_f‹r
->
±r
;

435 *
b
 = 
‹m¶©e
->
±r
, *
d
; *b; b = d+1) {

436 ià(
NULL
 !ğ(
d
 = 
	`¡rchr
(
b
, '$'))) {

437 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
ld­_f‹r
, 
b
, (
size_t
)(
d
 - b));

438 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
ld­_f‹r
, 
u£ºame
);

440 
d
 = 
‹m¶©e
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(template);

441 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
ld­_f‹r
, 
b
, (
size_t
)(
d
 - b));

447 
dn
 = 
	`mod_authn_ld­_g‘_dn
(
¤v
, 
p
->
ªÚ_cÚf
,

448 
p
->
cÚf
.
auth_ld­_ba£dn
->
±r
,

449 
p
->
ld­_f‹r
->
±r
);

450 ià(
NULL
 =ğ
dn
) {

451  
HANDLER_ERROR
;

457 
ld
 = 
	`mod_authn_ld­_ho¡_š™
(
¤v
, &
p
->
cÚf
);

458 ià(
NULL
 =ğ
ld
) {

459 ià(
dn
 !ğ
p
->
ld­_f‹r
->
±r
è
	`ld­_memä“
(dn);

460  
HANDLER_ERROR
;

463 ià(
LDAP_SUCCESS
 !ğ
	`mod_authn_ld­_bšd
(
¤v
, 
ld
, 
dn
, 
pw
)) {

464 
	`ld­_memä“
(
ld
);

465 ià(
dn
 !ğ
p
->
ld­_f‹r
->
±r
è
	`ld­_memä“
(dn);

466  
HANDLER_ERROR
;

469 
	`ld­_unbšd_ext_s
(
ld
, 
NULL
, NULL);

470 ià(
dn
 !ğ
p
->
ld­_f‹r
->
±r
è
	`ld­_memä“
(dn);

471  
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
u£ºame
->
±r
, 
NULL
, NULL)

472 ? 
HANDLER_GO_ON


473 : 
HANDLER_ERROR
;

474 
	}
}

476 
mod_authn_ld­_¶ugš_š™
(
¶ugš
 *
p
);

477 
	$mod_authn_ld­_¶ugš_š™
(
¶ugš
 *
p
) {

478 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

479 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("authn_ldap");

480 
p
->
š™
 = 
mod_authn_ld­_š™
;

481 
p
->
£t_deçuÉs
 = 
mod_authn_ld­_£t_deçuÉs
;

482 
p
->
ş—nup
 = 
mod_authn_ld­_ä“
;

484 
p
->
d©a
 = 
NULL
;

487 
	}
}

	@mod_authn_mysql.c

1 
	~"fœ¡.h
"

21 
	~<mysql.h
>

23 
	~"£rv”.h
"

24 
	~"h‰p_auth.h
"

25 
	~"log.h
"

26 
	~"md5.h
"

27 
	~"¶ugš.h
"

29 
	~<ùy³.h
>

30 
	~<”ºo.h
>

31 
	~<¡ršg.h
>

33 #ifdeà
HAVE_CRYPT_H


34 
	~<üy±.h
>

38 
MYSQL
 *
	mmysql_cÚn
;

39 
bufãr
 *
	mmysql_cÚn_ho¡
;

40 
bufãr
 *
	mmysql_cÚn_u£r
;

41 
bufãr
 *
	mmysql_cÚn_·ss
;

42 
bufãr
 *
	mmysql_cÚn_db
;

43 
	mmysql_cÚn_pÜt
;

44 
	mauth_mysql_pÜt
;

45 
bufãr
 *
	mauth_mysql_ho¡
;

46 
bufãr
 *
	mauth_mysql_u£r
;

47 
bufãr
 *
	mauth_mysql_·ss
;

48 
bufãr
 *
	mauth_mysql_db
;

49 
bufãr
 *
	mauth_mysql_sock‘
;

50 
bufãr
 *
	mauth_mysql_u£rs_bË
;

51 
bufãr
 *
	mauth_mysql_cŞ_u£r
;

52 
bufãr
 *
	mauth_mysql_cŞ_·ss
;

53 
bufãr
 *
	mauth_mysql_cŞ_»®m
;

54 } 
	t¶ugš_cÚfig
;

57 
	mPLUGIN_DATA
;

58 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

59 
¶ugš_cÚfig
 
	mcÚf
;

60 } 
	t¶ugš_d©a
;

62 
	$mod_authn_mysql_sock_şo£
(
¶ugš_cÚfig
 *
pcÚf
) {

63 ià(
NULL
 !ğ
pcÚf
->
mysql_cÚn
) {

64 
	`mysql_şo£
(
pcÚf
->
mysql_cÚn
);

65 
pcÚf
->
mysql_cÚn
 = 
NULL
;

67 
	}
}

69 
MYSQL
 * 
	$mod_authn_mysql_sock_cÚÃù
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
pcÚf
) {

70 ià(
NULL
 !ğ
pcÚf
->
mysql_cÚn
) {

72 iàĞ
pcÚf
->
mysql_cÚn_ho¡
 =ğpcÚf->
auth_mysql_ho¡


73 && 
pcÚf
->
mysql_cÚn_u£r
 =ğpcÚf->
auth_mysql_u£r


74 && 
pcÚf
->
mysql_cÚn_·ss
 =ğpcÚf->
auth_mysql_·ss


75 && 
pcÚf
->
mysql_cÚn_db
 =ğpcÚf->
auth_mysql_db


76 && 
pcÚf
->
mysql_cÚn_pÜt
 =ğpcÚf->
auth_mysql_pÜt
) {

77  
pcÚf
->
mysql_cÚn
;

79 
	`mod_authn_mysql_sock_şo£
(
pcÚf
);

83 
pcÚf
->
mysql_cÚn
 = 
	`mysql_š™
(
NULL
);

84 ià(
	`mysql_»®_cÚÃù
(
pcÚf
->
mysql_cÚn
,

85 
pcÚf
->
auth_mysql_ho¡
->
±r
,

86 
pcÚf
->
auth_mysql_u£r
->
±r
,

87 
pcÚf
->
auth_mysql_·ss
->
±r
,

88 
pcÚf
->
auth_mysql_db
->
±r
,

89 
pcÚf
->
auth_mysql_pÜt
,

90 !
	`bufãr_¡ršg_is_em±y
(
pcÚf
->
auth_mysql_sock‘
)

91 ? 
pcÚf
->
auth_mysql_sock‘
->
±r


92 : 
NULL
,

93 
CLIENT_IGNORE_SIGPIPE
)) {

95 
pcÚf
->
mysql_cÚn_ho¡
 =…cÚf->
auth_mysql_ho¡
;

96 
pcÚf
->
mysql_cÚn_u£r
 =…cÚf->
auth_mysql_u£r
;

97 
pcÚf
->
mysql_cÚn_·ss
 =…cÚf->
auth_mysql_·ss
;

98 
pcÚf
->
mysql_cÚn_db
 =…cÚf->
auth_mysql_db
;

99 
pcÚf
->
mysql_cÚn_pÜt
 =…cÚf->
auth_mysql_pÜt
;

100  
pcÚf
->
mysql_cÚn
;

104 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsb" "sbss",

105 "İ’šg cÚÃùiÚØmysql:", 
pcÚf
->
auth_mysql_ho¡
,

106 "u£r:", 
pcÚf
->
auth_mysql_u£r
,

108 "db:", 
pcÚf
->
auth_mysql_db
,

109 "çed:", 
	`mysql_”rÜ
(
pcÚf
->
mysql_cÚn
));

110 
	`mod_authn_mysql_sock_şo£
(
pcÚf
);

111  
NULL
;

113 
	}
}

115 
MYSQL
 * 
	$mod_authn_mysql_sock_acquœe
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
pcÚf
) {

116  
	`mod_authn_mysql_sock_cÚÃù
(
¤v
, 
pcÚf
);

117 
	}
}

119 
	$mod_authn_mysql_sock_»Ëa£
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
pcÚf
) {

120 
	`UNUSED
(
¤v
);

121 
	`UNUSED
(
pcÚf
);

126 
	}
}

128 
	$mod_authn_mysql_sock_”rÜ
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
pcÚf
) {

129 
	`UNUSED
(
¤v
);

130 
	`mod_authn_mysql_sock_şo£
(
pcÚf
);

131 
	}
}

133 
hªdËr_t
 
mod_authn_mysql_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
);

134 
hªdËr_t
 
mod_authn_mysql_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, 
HA1
[16]);

136 
	$INIT_FUNC
(
mod_authn_mysql_š™
) {

137 
h‰p_auth_back’d_t
 
h‰p_auth_back’d_mysql
 =

138 { "mysql", 
mod_authn_mysql_basic
, 
mod_authn_mysql_dige¡
, 
NULL
 };

139 
¶ugš_d©a
 *
p
 = 
	`ÿÎoc
(1, (*p));

142 
h‰p_auth_back’d_mysql
.
p_d
 = 
p
;

143 
	`h‰p_auth_back’d_£t
(&
h‰p_auth_back’d_mysql
);

145  
p
;

146 
	}
}

148 
	$FREE_FUNC
(
mod_authn_mysql_ä“
) {

149 
¶ugš_d©a
 *
p
 = 
p_d
;

151 
	`UNUSED
(
¤v
);

153 ià(!
p
è 
HANDLER_GO_ON
;

155 ià(
p
->
cÚfig_¡Üage
) {

156 
size_t
 
i
;

157 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

158 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

160 ià(
NULL
 =ğ
s
) ;

162 
	`bufãr_ä“
(
s
->
auth_mysql_ho¡
);

163 
	`bufãr_ä“
(
s
->
auth_mysql_u£r
);

164 
	`bufãr_ä“
(
s
->
auth_mysql_·ss
);

165 
	`bufãr_ä“
(
s
->
auth_mysql_db
);

166 
	`bufãr_ä“
(
s
->
auth_mysql_sock‘
);

167 
	`bufãr_ä“
(
s
->
auth_mysql_u£rs_bË
);

168 
	`bufãr_ä“
(
s
->
auth_mysql_cŞ_u£r
);

169 
	`bufãr_ä“
(
s
->
auth_mysql_cŞ_·ss
);

170 
	`bufãr_ä“
(
s
->
auth_mysql_cŞ_»®m
);

172 ià(
s
->
mysql_cÚn
è
	`mod_authn_mysql_sock_şo£
(s);

174 
	`ä“
(
s
);

176 
	`ä“
(
p
->
cÚfig_¡Üage
);

178 
	`mod_authn_mysql_sock_şo£
(&
p
->
cÚf
);

180 
	`ä“
(
p
);

182  
HANDLER_GO_ON
;

183 
	}
}

185 
	$SETDEFAULTS_FUNC
(
mod_authn_mysql_£t_deçuÉs
) {

186 
¶ugš_d©a
 *
p
 = 
p_d
;

187 
size_t
 
i
;

188 
cÚfig_v®ues_t
 
cv
[] = {

189 { "auth.back’d.mysql.ho¡", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

190 { "auth.back’d.mysql.u£r", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

191 { "auth.back’d.mysql.·ss", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

192 { "auth.back’d.mysql.db", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

193 { "auth.back’d.mysql.pÜt", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

194 { "auth.back’d.mysql.sock‘", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

195 { "auth.back’d.mysql.u£rs_bË", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

196 { "auth.back’d.mysql.cŞ_u£r", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

197 { "auth.back’d.mysql.cŞ_·ss", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

198 { "auth.back’d.mysql.cŞ_»®m", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

199 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

202 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

204 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

205 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

206 
¶ugš_cÚfig
 *
s
;

208 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

210 
s
->
mysql_cÚn
 = 
NULL
;

211 
s
->
auth_mysql_ho¡
 = 
	`bufãr_š™
();

212 
s
->
auth_mysql_u£r
 = 
	`bufãr_š™
();

213 
s
->
auth_mysql_·ss
 = 
	`bufãr_š™
();

214 
s
->
auth_mysql_db
 = 
	`bufãr_š™
();

215 
s
->
auth_mysql_sock‘
 = 
	`bufãr_š™
();

216 
s
->
auth_mysql_u£rs_bË
 = 
	`bufãr_š™
();

217 
s
->
auth_mysql_cŞ_u£r
 = 
	`bufãr_š™
();

218 
s
->
auth_mysql_cŞ_·ss
 = 
	`bufãr_š™
();

219 
s
->
auth_mysql_cŞ_»®m
 = 
	`bufãr_š™
();

221 
cv
[0].
de¡š©iÚ
 = 
s
->
auth_mysql_ho¡
;

222 
cv
[1].
de¡š©iÚ
 = 
s
->
auth_mysql_u£r
;

223 
cv
[2].
de¡š©iÚ
 = 
s
->
auth_mysql_·ss
;

224 
cv
[3].
de¡š©iÚ
 = 
s
->
auth_mysql_db
;

225 
cv
[4].
de¡š©iÚ
 = &
s
->
auth_mysql_pÜt
;

226 
cv
[5].
de¡š©iÚ
 = 
s
->
auth_mysql_sock‘
;

227 
cv
[6].
de¡š©iÚ
 = 
s
->
auth_mysql_u£rs_bË
;

228 
cv
[7].
de¡š©iÚ
 = 
s
->
auth_mysql_cŞ_u£r
;

229 
cv
[8].
de¡š©iÚ
 = 
s
->
auth_mysql_cŞ_·ss
;

230 
cv
[9].
de¡š©iÚ
 = 
s
->
auth_mysql_cŞ_»®m
;

232 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

234 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

235  
HANDLER_ERROR
;

238 ià(!
	`bufãr_is_em±y
(
s
->
auth_mysql_cŞ_u£r
)

239 && 
	`bufãr_¡ršg_is_em±y
(
s
->
auth_mysql_cŞ_u£r
)) {

240 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

242  
HANDLER_ERROR
;

244 ià(!
	`bufãr_is_em±y
(
s
->
auth_mysql_cŞ_·ss
)

245 && 
	`bufãr_¡ršg_is_em±y
(
s
->
auth_mysql_cŞ_·ss
)) {

246 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

248  
HANDLER_ERROR
;

250 ià(!
	`bufãr_is_em±y
(
s
->
auth_mysql_cŞ_»®m
)

251 && 
	`bufãr_¡ršg_is_em±y
(
s
->
auth_mysql_cŞ_»®m
)) {

252 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

254  
HANDLER_ERROR
;

258 ià(
p
->
cÚfig_¡Üage
[0]) {

259 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

260 ià(
	`bufãr_is_em±y
(
s
->
auth_mysql_cŞ_u£r
)) {

261 
s
->
auth_mysql_cŞ_u£r
 = 
	`bufãr_š™_¡ršg
("user");

263 ià(
	`bufãr_is_em±y
(
s
->
auth_mysql_cŞ_·ss
)) {

264 
s
->
auth_mysql_cŞ_·ss
 = 
	`bufãr_š™_¡ršg
("password");

266 ià(
	`bufãr_is_em±y
(
s
->
auth_mysql_cŞ_»®m
)) {

267 
s
->
auth_mysql_cŞ_»®m
 = 
	`bufãr_š™_¡ršg
("realm");

271  
HANDLER_GO_ON
;

272 
	}
}

274 
	#PATCH
(
x
) \

275 
p
->
cÚf
.
x
 = 
s
->x;

	)

276 
	$mod_authn_mysql_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

277 
size_t
 
i
, 
j
;

278 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

280 
	`PATCH
(
auth_mysql_ho¡
);

281 
	`PATCH
(
auth_mysql_u£r
);

282 
	`PATCH
(
auth_mysql_·ss
);

283 
	`PATCH
(
auth_mysql_db
);

284 
	`PATCH
(
auth_mysql_pÜt
);

285 
	`PATCH
(
auth_mysql_sock‘
);

286 
	`PATCH
(
auth_mysql_u£rs_bË
);

287 
	`PATCH
(
auth_mysql_cŞ_u£r
);

288 
	`PATCH
(
auth_mysql_cŞ_·ss
);

289 
	`PATCH
(
auth_mysql_cŞ_»®m
);

292 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

293 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

294 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

297 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

300 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

301 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

303 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.host"))) {

304 
	`PATCH
(
auth_mysql_ho¡
);

305 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.user"))) {

306 
	`PATCH
(
auth_mysql_u£r
);

307 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.pass"))) {

308 
	`PATCH
(
auth_mysql_·ss
);

309 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.db"))) {

310 
	`PATCH
(
auth_mysql_db
);

311 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.port"))) {

312 
	`PATCH
(
auth_mysql_pÜt
);

313 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.socket"))) {

314 
	`PATCH
(
auth_mysql_sock‘
);

315 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.users_table"))) {

316 
	`PATCH
(
auth_mysql_u£rs_bË
);

317 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.col_user"))) {

318 
	`PATCH
(
auth_mysql_cŞ_u£r
);

319 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.col_pass"))) {

320 
	`PATCH
(
auth_mysql_cŞ_·ss
);

321 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("auth.backend.mysql.col_realm"))) {

322 
	`PATCH
(
auth_mysql_cŞ_»®m
);

328 
	}
}

329 #undeà
PATCH


331 
	$mod_authn_mysql_·sswÜd_cmp
(cÚ¡ *
u£½w
, 
u£½wËn
, cÚ¡ *
»qpw
) {

332 #ià
	`defšed
(
HAVE_CRYPT_R
è|| defšed(
HAVE_CRYPT
)

333 ià(
u£½wËn
 >ğ3 && 
u£½w
[0] == '$' && userpw[2] == '$') {

336 cÚ¡ *
§Éb
 = 
u£½w
+3;

337 cÚ¡ *
§Ée
 = 
	`¡rchr
(
§Éb
, '$');

338 
§É
[32];

339 
size_t
 
¦’
 = (
NULL
 !ğ
§Ée
è? (size_t)(§É- 
§Éb
è: (
§É
);

341 ià(
¦’
 < (
§É
)) {

342 *
üy±ed
;

343 #ià
	`defšed
(
HAVE_CRYPT_R
)

344 
üy±_d©a
 
üy±_tmp_d©a
;

345 #ifdeà
_AIX


346 
	`mem£t
(&
üy±_tmp_d©a
, 0, (crypt_tmp_data));

348 
üy±_tmp_d©a
.
š™Ÿlized
 = 0;

351 
	`memıy
(
§É
, 
§Éb
, 
¦’
);

352 
§É
[
¦’
] = '\0';

354 #ià
	`defšed
(
HAVE_CRYPT_R
)

355 
üy±ed
 = 
	`üy±_r
(
»qpw
, 
§É
, &
üy±_tmp_d©a
);

357 
üy±ed
 = 
	`üy±
(
»qpw
, 
§É
);

359 ià(
NULL
 !ğ
üy±ed
) {

360  
	`¡rcmp
(
u£½w
, 
üy±ed
);

366 ià(32 =ğ
u£½wËn
) {

368 
li_MD5_CTX
 
Md5Ctx
;

369 
HA1
[16];

370 
md5pw
[16];

372 
	`li_MD5_In™
(&
Md5Ctx
);

373 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
»qpw
, 
	`¡¾’
(reqpw));

374 
	`li_MD5_Fš®
(
HA1
, &
Md5Ctx
);

378  (0 =ğ
	`h‰p_auth_md5_hex2bš
(
u£½w
, 32 , 
md5pw
))

379 ? 
	`memcmp
(
HA1
, 
md5pw
, (md5pw))

384 
	}
}

386 
	$mod_authn_mysql_»suÉ
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, cÚ¡ *
pw
, 
HA1
[16]) {

387 
MYSQL_RES
 *
»suÉ
 = 
	`mysql_¡Üe_»suÉ
(
p
->
cÚf
.
mysql_cÚn
);

388 
rc
 = -1;

389 
my_ulÚglÚg
 
num_rows
;

391 ià(
NULL
 =ğ
»suÉ
) {

394 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "mysql_store_result:",

395 
	`mysql_”rÜ
(
p
->
cÚf
.
mysql_cÚn
));

397 
	`mod_authn_mysql_sock_”rÜ
(
¤v
, &
p
->
cÚf
);

401 
num_rows
 = 
	`mysql_num_rows
(
»suÉ
);

402 ià(1 =ğ
num_rows
) {

403 
MYSQL_ROW
 
row
 = 
	`mysql_ãtch_row
(
»suÉ
);

404 *
Ëngths
 = 
	`mysql_ãtch_Ëngths
(
»suÉ
);

405 ià(
NULL
 =ğ
Ëngths
) {

408 ià(
pw
) {

409 
rc
 = 
	`mod_authn_mysql_·sswÜd_cmp
(
row
[0], 
Ëngths
[0], 
pw
);

412 
rc
 = 
	`h‰p_auth_md5_hex2bš
(
row
[0], 
Ëngths
[0], 
HA1
);

415 ià(0 =ğ
num_rows
) {

422 
	`mysql_ä“_»suÉ
(
»suÉ
);

423  
rc
;

424 
	}
}

426 
hªdËr_t
 
	$mod_authn_mysql_qu”y
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, cÚ¡ *
pw
, 
HA1
[16]) {

427 
¶ugš_d©a
 *
p
 = (¶ugš_d©¨*)
p_d
;

428 
rc
 = -1;

430 
	`mod_authn_mysql_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

432 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
auth_mysql_u£rs_bË
)) {

434 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

436 
cÚ
->
»que¡
.
uri
);

437  
HANDLER_ERROR
;

441 
size_t
 
uÇm–’
 = 
	`¡¾’
(
u£ºame
);

442 
size_t
 
u»®mËn
 = 
	`¡¾’
(
»®m
);

443 
q
[1024], 
uÇme
[512], 
u»®m
[512];

444 
mrc
;

446 ià(
uÇm–’
 > (
uÇme
)/2-1)

447  
HANDLER_ERROR
;

448 ià(
u»®mËn
 > (
u»®m
)/2-1)

449  
HANDLER_ERROR
;

451 ià(!
	`mod_authn_mysql_sock_acquœe
(
¤v
, &
p
->
cÚf
)) {

452  
HANDLER_ERROR
;

456 
mrc
 = 
	`mysql_»®_esÿ³_¡ršg_quÙe
(
p
->
cÚf
.
mysql_cÚn
,
uÇme
,
u£ºame
,

457 ()
uÇm–’
, '\'');

458 ià(()~0 =ğ
mrc
) ;

460 
mrc
 = 
	`mysql_»®_esÿ³_¡ršg_quÙe
(
p
->
cÚf
.
mysql_cÚn
,
u»®m
,
»®m
,

461 ()
u»®mËn
, '\'');

462 ià(()~0 =ğ
mrc
) ;

464 
mrc
 = 
	`mysql_»®_esÿ³_¡ršg
(
p
->
cÚf
.
mysql_cÚn
, 
uÇme
,

465 
u£ºame
, ()
uÇm–’
);

466 ià(()~0 =ğ
mrc
) ;

468 
mrc
 = 
	`mysql_»®_esÿ³_¡ršg
(
p
->
cÚf
.
mysql_cÚn
, 
u»®m
,

469 
»®m
, ()
u»®mËn
);

470 ià(()~0 =ğ
mrc
) ;

473 
rc
 = 
	`¢´štf
(
q
, (q),

475 
p
->
cÚf
.
auth_mysql_cŞ_·ss
->
±r
,

476 
p
->
cÚf
.
auth_mysql_u£rs_bË
->
±r
,

477 
p
->
cÚf
.
auth_mysql_cŞ_u£r
->
±r
,

478 
uÇme
,

479 
p
->
cÚf
.
auth_mysql_cŞ_»®m
->
±r
,

480 
u»®m
);

482 ià(
rc
 >ğ()(
q
)) {

483 
rc
 = -1;

488 ià(0 !ğ
	`mysql_qu”y
(
p
->
cÚf
.
mysql_cÚn
, 
q
)) {

490 
	`mod_authn_mysql_sock_”rÜ
(
¤v
, &
p
->
cÚf
);

491 ià(!
	`mod_authn_mysql_sock_acquœe
(
¤v
, &
p
->
cÚf
)) {

492 
rc
 = -1;

495 ià(0 !ğ
	`mysql_qu”y
(
p
->
cÚf
.
mysql_cÚn
, 
q
)) {

497 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsb" "sbssss",

498 "mysql_qu”y ho¡:", 
p
->
cÚf
.
auth_mysql_ho¡
,

499 "u£r:", 
p
->
cÚf
.
auth_mysql_u£r
,

502 "db:", 
p
->
cÚf
.
auth_mysql_db
,

503 "qu”y:", 
q
,

504 "çed:", 
	`mysql_”rÜ
(
p
->
cÚf
.
mysql_cÚn
));

505 
rc
 = -1;

510 
rc
 = 
	`mod_authn_mysql_»suÉ
(
¤v
, 
p
, 
pw
, 
HA1
);

514 
	`mod_authn_mysql_sock_»Ëa£
(
¤v
, &
p
->
cÚf
);

516  (0 =ğ
rc
è? 
HANDLER_GO_ON
 : 
HANDLER_ERROR
;

517 
	}
}

519 
hªdËr_t
 
	$mod_authn_mysql_basic
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ 
h‰p_auth_»quœe_t
 *
»quœe
, cÚ¡ 
bufãr
 *
u£ºame
, cÚ¡ *
pw
) {

522 
HA1
[16];

523 *
»®m
 = 
»quœe
->»®m->
±r
;

524 
hªdËr_t
 
rc
 =
	`mod_authn_mysql_qu”y
(
¤v
,
cÚ
,
p_d
,
u£ºame
->
±r
,
»®m
,
pw
,
HA1
);

525 ià(
HANDLER_GO_ON
 !ğ
rc
) „c;

526  
	`h‰p_auth_m©ch_ruËs
(
»quœe
, 
u£ºame
->
±r
, 
NULL
, NULL)

527 ? 
HANDLER_GO_ON


528 : 
HANDLER_ERROR
;

529 
	}
}

531 
hªdËr_t
 
	$mod_authn_mysql_dige¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, cÚ¡ *
u£ºame
, cÚ¡ *
»®m
, 
HA1
[16]) {

532  
	`mod_authn_mysql_qu”y
(
¤v
,
cÚ
,
p_d
,
u£ºame
,
»®m
,
NULL
,
HA1
);

533 
	}
}

535 
mod_authn_mysql_¶ugš_š™
(
¶ugš
 *
p
);

536 
	$mod_authn_mysql_¶ugš_š™
(
¶ugš
 *
p
) {

537 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

538 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("authn_mysql");

539 
p
->
š™
 = 
mod_authn_mysql_š™
;

540 
p
->
£t_deçuÉs
ğ
mod_authn_mysql_£t_deçuÉs
;

541 
p
->
ş—nup
 = 
mod_authn_mysql_ä“
;

543 
p
->
d©a
 = 
NULL
;

546 
	}
}

	@mod_cgi.c

1 
	~"fœ¡.h
"

3 
	~"£rv”.h
"

4 
	~"¡©_ÿche.h
"

5 
	~"keyv®ue.h
"

6 
	~"log.h
"

7 
	~"cÚÃùiÚs.h
"

8 
	~"jobli¡.h
"

9 
	~"»¥Ú£.h
"

10 
	~"h‰p_chunk.h
"

12 
	~"¶ugš.h
"

14 
	~<sys/ty³s.h
>

15 
	~"sys-mm­.h
"

17 #ifdeà
__WIN32


18 
	~<wšsock2.h
>

20 
	~<sys/sock‘.h
>

21 
	~<sys/wa™.h
>

22 
	~<Ãtš‘/š.h
>

23 
	~<¬·/š‘.h
>

26 
	~<uni¡d.h
>

27 
	~<”ºo.h
>

28 
	~<¡dlib.h
>

29 
	~<¡ršg.h
>

30 
	~<fdev’t.h
>

31 
	~<sigÇl.h
>

32 
	~<ùy³.h
>

33 
	~<as£¹.h
>

35 
	~<¡dio.h
>

36 
	~<fú.h
>

38 
	$pe_şÛxec
(
pefd
[2]) {

39 #ifdeà
HAVE_PIPE2


40 ià(0 =ğ
	`pe2
(
pefd
, 
O_CLOEXEC
))  0;

42  0 =ğ
	`pe
(
pefd
)

43 #ifdeà
FD_CLOEXEC


44 && 0 =ğ
	`fú
(
pefd
[0], 
F_SETFD
, 
FD_CLOEXEC
)

45 && 0 =ğ
	`fú
(
pefd
[1], 
F_SETFD
, 
FD_CLOEXEC
)

49 
	}
}

51 ’um {
	mEOL_UNSET
, 
	mEOL_N
, 
	mEOL_RN
};

54 **
	m±r
;

56 
size_t
 
	msize
;

57 
size_t
 
	mu£d
;

58 } 
	tch¬_¬¿y
;

61 
pid_t
 *
	m±r
;

62 
size_t
 
	mu£d
;

63 
size_t
 
	msize
;

64 } 
	tbufãr_pid_t
;

67 
¬¿y
 *
	mcgi
;

68 
	mexecu‹_x_Úly
;

69 
	mx£ndfe_®low
;

70 
¬¿y
 *
	mx£ndfe_doüoÙ
;

71 } 
	t¶ugš_cÚfig
;

74 
	mPLUGIN_DATA
;

75 
bufãr_pid_t
 
	mcgi_pid
;

77 
bufãr
 *
	m·r£_»¥Ú£
;

79 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

81 
¶ugš_cÚfig
 
	mcÚf
;

82 } 
	t¶ugš_d©a
;

85 
pid_t
 
	mpid
;

86 
	mfd
;

87 
	mfdtocgi
;

88 
	mfde_ndx
;

89 
	mfde_ndx_tocgi
;

91 
cÚÃùiÚ
 *
	m»mÙe_cÚn
;

92 
¶ugš_d©a
 *
	m¶ugš_d©a
;

94 
bufãr
 *
	m»¥Ú£
;

95 
bufãr
 *
	m»¥Ú£_h—d”
;

96 
bufãr
 *
	mcgi_hªdËr
;

97 
¶ugš_cÚfig
 
	mcÚf
;

98 } 
	thªdËr_ùx
;

100 
hªdËr_ùx
 * 
	$cgi_hªdËr_ùx_š™
() {

101 
hªdËr_ùx
 *
hùx
 = 
	`ÿÎoc
(1, (*hctx));

103 
	`fÜû_as£¹
(
hùx
);

105 
hùx
->
»¥Ú£
 = 
	`bufãr_š™
();

106 
hùx
->
»¥Ú£_h—d”
 = 
	`bufãr_š™
();

107 
hùx
->
fd
 = -1;

108 
hùx
->
fdtocgi
 = -1;

110  
hùx
;

111 
	}
}

113 
	$cgi_hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

114 
	`bufãr_ä“
(
hùx
->
»¥Ú£
);

115 
	`bufãr_ä“
(
hùx
->
»¥Ú£_h—d”
);

117 
	`ä“
(
hùx
);

118 
	}
}

120 ’um {
	mFDEVENT_HANDLED_UNSET
, 
	mFDEVENT_HANDLED_FINISHED
, 
	mFDEVENT_HANDLED_NOT_FINISHED
, 
	mFDEVENT_HANDLED_COMEBACK
, 
	mFDEVENT_HANDLED_ERROR
};

122 
	$INIT_FUNC
(
mod_cgi_š™
) {

123 
¶ugš_d©a
 *
p
;

125 
p
 = 
	`ÿÎoc
(1, (*p));

127 
	`fÜû_as£¹
(
p
);

129 
p
->
·r£_»¥Ú£
 = 
	`bufãr_š™
();

131  
p
;

132 
	}
}

135 
	$FREE_FUNC
(
mod_cgi_ä“
) {

136 
¶ugš_d©a
 *
p
 = 
p_d
;

137 
bufãr_pid_t
 *
r
 = &(
p
->
cgi_pid
);

139 
	`UNUSED
(
¤v
);

141 ià(
p
->
cÚfig_¡Üage
) {

142 
size_t
 
i
;

143 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

144 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

146 ià(
NULL
 =ğ
s
) ;

148 
	`¬¿y_ä“
(
s
->
cgi
);

149 
	`¬¿y_ä“
(
s
->
x£ndfe_doüoÙ
);

151 
	`ä“
(
s
);

153 
	`ä“
(
p
->
cÚfig_¡Üage
);

157 ià(
r
->
±r
è
	`ä“
(r->ptr);

159 
	`bufãr_ä“
(
p
->
·r£_»¥Ú£
);

161 
	`ä“
(
p
);

163  
HANDLER_GO_ON
;

164 
	}
}

166 
	$SETDEFAULTS_FUNC
(
mod_ç¡cgi_£t_deçuÉs
) {

167 
¶ugš_d©a
 *
p
 = 
p_d
;

168 
size_t
 
i
 = 0;

170 
cÚfig_v®ues_t
 
cv
[] = {

171 { "cgi.assign", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

172 { "cgi.execu‹-x-Úly", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

173 { "cgi.x-£ndfe", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

174 { "cgi.x-£ndfe-doüoÙ", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

175 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
}

178 ià(!
p
è 
HANDLER_ERROR
;

180 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

181 
	`fÜû_as£¹
(
p
->
cÚfig_¡Üage
);

183 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

184 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

185 
¶ugš_cÚfig
 *
s
;

187 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

188 
	`fÜû_as£¹
(
s
);

190 
s
->
cgi
 = 
	`¬¿y_š™
();

191 
s
->
execu‹_x_Úly
 = 0;

192 
s
->
x£ndfe_®low
= 0;

193 
s
->
x£ndfe_doüoÙ
 = 
	`¬¿y_š™
();

195 
cv
[0].
de¡š©iÚ
 = 
s
->
cgi
;

196 
cv
[1].
de¡š©iÚ
 = &(
s
->
execu‹_x_Úly
);

197 
cv
[2].
de¡š©iÚ
 = &(
s
->
x£ndfe_®low
);

198 
cv
[3].
de¡š©iÚ
 = 
s
->
x£ndfe_doüoÙ
;

200 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

202 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

203  
HANDLER_ERROR
;

206 ià(
s
->
x£ndfe_doüoÙ
->
u£d
) {

207 
size_t
 
j
;

208 
j
 = 0; j < 
s
->
x£ndfe_doüoÙ
->
u£d
; ++j) {

209 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
x£ndfe_doüoÙ
->
d©a
[
j
];

210 ià(
ds
->
ty³
 !ğ
TYPE_STRING
) {

211 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

213  
HANDLER_ERROR
;

215 ià(
ds
->
v®ue
->
±r
[0] != '/') {

216 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBs",

217 "cgi.x-£ndfe-doüoÙ…©h mu¡ begš w™h '/'; inv®id: \"", 
ds
->
v®ue
, "\"");

218  
HANDLER_ERROR
;

220 
	`bufãr_·th_sim¶ify
(
ds
->
v®ue
, ds->value);

221 
	`bufãr_­³nd_¦ash
(
ds
->
v®ue
);

226  
HANDLER_GO_ON
;

227 
	}
}

230 
	$cgi_pid_add
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, 
pid_t
 
pid
) {

231 
m
 = -1;

232 
size_t
 
i
;

233 
bufãr_pid_t
 *
r
 = &(
p
->
cgi_pid
);

235 
	`UNUSED
(
¤v
);

237 
i
 = 0; i < 
r
->
u£d
; i++) {

238 ià(
r
->
±r
[
i
] > 
m
) m =„->ptr[i];

241 ià(
r
->
size
 == 0) {

242 
r
->
size
 = 16;

243 
r
->
±r
 = 
	`m®loc
((*r->±rè*„->
size
);

244 
	`fÜû_as£¹
(
r
->
±r
);

245 } ià(
r
->
u£d
 =ğr->
size
) {

246 
r
->
size
 += 16;

247 
r
->
±r
 = 
	`»®loc
Ô->±r, (*r->±rè*„->
size
);

248 
	`fÜû_as£¹
(
r
->
±r
);

251 
r
->
±r
[r->
u£d
++] = 
pid
;

253  
m
;

254 
	}
}

256 
	$cgi_pid_d–
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, 
pid_t
 
pid
) {

257 
size_t
 
i
;

258 
bufãr_pid_t
 *
r
 = &(
p
->
cgi_pid
);

260 
	`UNUSED
(
¤v
);

262 
i
 = 0; i < 
r
->
u£d
; i++) {

263 ià(
r
->
±r
[
i
] =ğ
pid
) ;

266 ià(
i
 !ğ
r
->
u£d
) {

269 ià(
i
 !ğ
r
->
u£d
 - 1) {

270 
r
->
±r
[
i
] =„->±r[r->
u£d
 - 1];

272 
r
->
u£d
--;

276 
	}
}

278 
	$cgi_»¥Ú£_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
š
) {

279 *
ns
;

280 cÚ¡ *
s
;

281 
lše
 = 0;

283 
	`UNUSED
(
¤v
);

285 
	`bufãr_cİy_bufãr
(
p
->
·r£_»¥Ú£
, 
š
);

287 
s
 = 
p
->
·r£_»¥Ú£
->
±r
;

288 
NULL
 !ğ(
ns
 = 
	`¡rchr
(
s
, '\n'));

289 
s
 = 
ns
 + 1, 
lše
++) {

290 cÚ¡ *
key
, *
v®ue
;

291 
key_Ën
;

292 
d©a_¡ršg
 *
ds
;

295 
ns
[0] = '\0';

297 ià(
ns
 > 
s
 &&‚s[-1] == '\r')‚s[-1] = '\0';

299 ià(
lše
 == 0 &&

300 0 =ğ
	`¡ºcmp
(
s
, "HTTP/1.", 7)) {

303 ià((
s
[7] == '1' ||

304 
s
[7] == '0') &&

305 
s
[8] == ' ') {

306 
¡©us
;

309 
¡©us
 = 
	`¡¹Ş
(
s
+9, 
NULL
, 10);

311 ià(
¡©us
 >= 100 &&

312 
¡©us
 < 1000) {

314 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_STATUS
;

315 
cÚ
->
h‰p_¡©us
 = 
¡©us
;

320 
key
 = 
s
;

321 ià(
NULL
 =ğ(
v®ue
 = 
	`¡rchr
(
s
, ':'))) {

326 
key_Ën
 = 
v®ue
 - 
key
;

327 
v®ue
 += 1;

330 *
v®ue
 == ' ' || *value == '\t') value++;

332 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

333 
ds
 = 
	`d©a_»¥Ú£_š™
();

335 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
key_Ën
);

336 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, value);

338 
	`¬¿y_š£¹_unique
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
ds
);

340 
key_Ën
) {

342 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "D©e", 
key_Ën
)) {

343 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_DATE
;

347 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "Stus", 
key_Ën
)) {

348 
¡©us
 = 
	`¡¹Ş
(
v®ue
, 
NULL
, 10);

349 ià(
¡©us
 >= 100 && status < 1000) {

350 
cÚ
->
h‰p_¡©us
 = 
¡©us
;

351 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_STATUS
;

353 
cÚ
->
h‰p_¡©us
 = 502;

358 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "LoÿtiÚ", 
key_Ën
)) {

359 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_LOCATION
;

363 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚÃùiÚ", 
key_Ën
)) {

364 
cÚ
->
»¥Ú£
.
k“p_®ive
 = (0 =ğ
	`¡rÿ£cmp
(
v®ue
, "Keep-Alive")) ? 1 : 0;

365 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONNECTION
;

369 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚ‹Á-L’gth", 
key_Ën
)) {

370 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
	`¡¹oul
(
v®ue
, 
NULL
, 10);

371 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONTENT_LENGTH
;

381 ià((
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_LOCATION
) &&

382 !(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_STATUS
)) {

383 
cÚ
->
h‰p_¡©us
 = 302;

387 
	}
}

390 
	$cgi_demux_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

391 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

392 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

395 
n
;

396 
tÜ—d
;

398 #ià
	`defšed
(
__WIN32
)

399 
	`bufãr_¡ršg_´•¬e_cİy
(
hùx
->
»¥Ú£
, 4 * 1024);

401 ià(
	`ioùl
(
hùx
->
fd
, 
FIONREAD
, &
tÜ—d
) ||oread <= 4*1024) {

402 
	`bufãr_¡ršg_´•¬e_cİy
(
hùx
->
»¥Ú£
, 4 * 1024);

404 ià(
tÜ—d
 > 
MAX_READ_LIMIT
)oread = MAX_READ_LIMIT;

405 
	`bufãr_¡ršg_´•¬e_cİy
(
hùx
->
»¥Ú£
, 
tÜ—d
);

409 ià(-1 =ğ(
n
 = 
	`»ad
(
hùx
->
fd
, hùx->
»¥Ú£
->
±r
, hùx->»¥Ú£->
size
 - 1))) {

410 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
) {

412 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

413  
FDEVENT_HANDLED_NOT_FINISHED
;

416 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd", 
	`¡»¼Ü
(
”ºo
), 
cÚ
->
fd
, 
hùx
->fd);

417  
FDEVENT_HANDLED_ERROR
;

420 ià(
n
 == 0) {

422  
FDEVENT_HANDLED_FINISHED
;

425 
	`bufãr_comm™
(
hùx
->
»¥Ú£
, 
n
);

429 ià(
cÚ
->
fe_¡¬‹d
 == 0) {

430 
is_h—d”
 = 0;

431 
is_h—d”_’d
 = 0;

432 
size_t
 
Ï¡_eŞ
 = 0;

433 
size_t
 
i
, 
h—d”_Ën
;

435 
	`bufãr_­³nd_¡ršg_bufãr
(
hùx
->
»¥Ú£_h—d”
, hùx->
»¥Ú£
);

459 ià(0 =ğ
	`¡ºcmp
(
hùx
->
»¥Ú£_h—d”
->
±r
, "HTTP/1.", 7)è
is_h—d”
 = 1;

461 
h—d”_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£_h—d”
);

462 
i
 = 0; !
is_h—d”_’d
 && i < 
h—d”_Ën
; i++) {

463 
c
 = 
hùx
->
»¥Ú£_h—d”
->
±r
[
i
];

465 
c
) {

471 
is_h—d”
 = 1;

475 ià(
is_h—d”
 == 0) {

478 
is_h—d”_’d
 = 1;

486 ià(
Ï¡_eŞ
 > 0 &&

487 ((
i
 - 
Ï¡_eŞ
 == 1) ||

488 (
i
 - 
Ï¡_eŞ
 =ğ2 && 
hùx
->
»¥Ú£_h—d”
->
±r
[i - 1] == '\r'))) {

489 
is_h—d”_’d
 = 1;

493 
Ï¡_eŞ
 = 
i
;

499 ià(
is_h—d”_’d
) {

500 ià(!
is_h—d”
) {

502 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£_h—d”
)) {

503  
FDEVENT_HANDLED_ERROR
;

506 cÚ¡ *
b¡¬t
;

507 
size_t
 
bËn
;

510 
b¡¬t
 = 
hùx
->
»¥Ú£_h—d”
->
±r
 + 
i
;

511 
bËn
 = 
h—d”_Ën
 - 
i
;

518 
i
--;

521 ià(
i
 > 0 && (
hùx
->
»¥Ú£_h—d”
->
±r
[i - 1] == '\r')) {

522 
i
--;

525 
	`bufãr_¡ršg_£t_Ëngth
(
hùx
->
»¥Ú£_h—d”
, 
i
);

528 
	`cgi_»¥Ú£_·r£
(
¤v
, 
cÚ
, 
p
, 
hùx
->
»¥Ú£_h—d”
);

530 ià(
cÚ
->
h‰p_¡©us
 >= 300 && con->http_status < 400) {

532 
size_t
 
uËn
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
);

533 
d©a_¡ršg
 *
ds
;

534 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Location"))

535 && 
ds
->
v®ue
->
±r
[0] == '/'

536 && (0 !ğ
	`¡ºcmp
(
ds
->
v®ue
->
±r
, 
cÚ
->
uri
.
·th
->±r, 
uËn
)

537 || (
ds
->
v®ue
->
±r
[
uËn
] != '\0' && ds->value->ptr[ulen] != '/' && ds->value->ptr[ulen] != '?'))

538 && 
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Set-Cookie")) {

539 ià(++
cÚ
->
loİs_³r_»que¡
 > 5) {

540 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "toØmªy iÁ”ÇÈloİ wh´oûssšg„eque¡:", 
cÚ
->
»que¡
.
Üig_uri
);

541 
cÚ
->
h‰p_¡©us
 = 500;

542 
cÚ
->
mode
 = 
DIRECT
;

543  
FDEVENT_HANDLED_FINISHED
;

546 
	`bufãr_cİy_bufãr
(
cÚ
->
»que¡
.
uri
, 
ds
->
v®ue
);

548 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

549 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 !ğcÚ->
»que¡_cÚ‹Á_queue
->
by‹s_š
) {

550 
cÚ
->
k“p_®ive
 = 0;

552 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 = 0;

553 
	`chunkqueue_»£t
(
cÚ
->
»que¡_cÚ‹Á_queue
);

556 ià(
cÚ
->
h‰p_¡©us
 != 307 && con->http_status != 308) {

559 
cÚ
->
»que¡
.
h‰p_m‘hod
 = 
HTTP_METHOD_GET
;

562 
	`cÚÃùiÚ_»¥Ú£_»£t
(
¤v
, 
cÚ
);

564 
cÚ
->
mode
 = 
DIRECT
;

565  
FDEVENT_HANDLED_COMEBACK
;

569 ià(
hùx
->
cÚf
.
x£ndfe_®low
) {

570 
d©a_¡ršg
 *
ds
;

571 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "X-Sendfile"))) {

572 
	`h‰p_»¥Ú£_x£ndfe
(
¤v
, 
cÚ
, 
ds
->
v®ue
, 
hùx
->
cÚf
.
x£ndfe_doüoÙ
);

573  
FDEVENT_HANDLED_FINISHED
;

577 ià(
bËn
 > 0) {

578 ià(0 !ğ
	`h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
b¡¬t
, 
bËn
)) {

579  
FDEVENT_HANDLED_ERROR
;

584 
cÚ
->
fe_¡¬‹d
 = 1;

587 ià(
h—d”_Ën
 > 
MAX_HTTP_REQUEST_HEADER
) {

588 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "»¥Ú£ h—d” toØÏrgfÜ", 
cÚ
->
uri
.
·th
);

589 
cÚ
->
h‰p_¡©us
 = 502;

590 
cÚ
->
mode
 = 
DIRECT
;

591  
FDEVENT_HANDLED_FINISHED
;

595 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£
)) {

596  
FDEVENT_HANDLED_ERROR
;

598 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

599 && 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

600 ià(!
cÚ
->
is_wr™abË
) {

606 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

613 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ddss", 
cÚ
->
fd
, 
hùx
->fd, 
	`cÚÃùiÚ_g‘_¡©e
(cÚ->
¡©e
), 
b
->
±r
);

617  
FDEVENT_HANDLED_NOT_FINISHED
;

618 
	}
}

620 
	$cgi_cÚÃùiÚ_şo£_fdtocgi
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

622 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
hùx
->
fde_ndx_tocgi
), hùx->
fdtocgi
);

623 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
hùx
->
fdtocgi
);

624 
	`fdev’t_sched_şo£
(
¤v
->
ev
, 
hùx
->
fdtocgi
, 0);

625 
hùx
->
fdtocgi
 = -1;

626 
	}
}

628 
	$cgi_cÚÃùiÚ_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

629 
¡©us
;

630 
pid_t
 
pid
;

631 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

632 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

634 #iâdeà
__WIN32


642 ià(
hùx
->
fd
 != -1) {

644 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
);

645 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
hùx
->
fd
);

646 
	`fdev’t_sched_şo£
(
¤v
->
ev
, 
hùx
->
fd
, 0);

649 ià(
hùx
->
fdtocgi
 != -1) {

650 
	`cgi_cÚÃùiÚ_şo£_fdtocgi
(
¤v
, 
hùx
);

653 
pid
 = 
hùx
->pid;

655 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

657 
	`cgi_hªdËr_ùx_ä“
(
hùx
);

660 ià(
pid
) {

662 
	`wa™pid
(
pid
, &
¡©us
, 
WNOHANG
)) {

666 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "(debugèchd i¢'ˆdÚy‘,…id:", 
pid
);

671 ià(
”ºo
 =ğ
EINTR
) ;

683 ià(
”ºo
 !ğ
ECHILD
) {

684 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "wa™pid faed: ", 
	`¡»¼Ü
(
”ºo
));

687 
pid
 = 0;

690 ià(
	`WIFEXITED
(
¡©us
)) {

692 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "(debugècg˜ex™ed fše,…id:", 
pid
);

695 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "cg˜d›d,…id:", 
pid
);

698 
pid
 = 0;

702 ià(
pid
) {

703 
	`kl
(
pid
, 
SIGTERM
);

706 
	`cgi_pid_add
(
¤v
, 
p
, 
pid
);

712 ià(
cÚ
->
mode
 =ğ
p
->
id
) {

713 
	`h‰p_»¥Ú£_back’d_dÚe
(
¤v
, 
cÚ
);

715 
	}
}

717 
hªdËr_t
 
	$cgi_cÚÃùiÚ_şo£_ÿÎback
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

718 
¶ugš_d©a
 *
p
 = 
p_d
;

719 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

720 ià(
hùx
è
	`cgi_cÚÃùiÚ_şo£
(
¤v
, hctx);

722  
HANDLER_GO_ON
;

723 
	}
}

726 
cgi_wr™e_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
fd
);

729 
hªdËr_t
 
	$cgi_hªdË_fdev’t_£nd
 (
£rv”
 *
¤v
, *
ùx
, 
»v’ts
) {

730 
hªdËr_ùx
 *
hùx
 = 
ùx
;

731 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

734 
	`jobli¡_­³nd
(
¤v
, 
cÚ
);

736 ià(
»v’ts
 & 
FDEVENT_OUT
) {

737 ià(0 !ğ
	`cgi_wr™e_»que¡
(
¤v
, 
hùx
, hùx->
fdtocgi
)) {

738 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

739  
HANDLER_ERROR
;

744 ià(
»v’ts
 & 
FDEVENT_HUP
) {

746 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

747 
chunkqueue
 *
cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

748 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
	`chunkqueue_Ëngth
(cq));

749 ià(
cq
->
by‹s_š
 !ğ(
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

750 
cÚ
->
k“p_®ive
 = 0;

754 
	`cgi_cÚÃùiÚ_şo£_fdtocgi
(
¤v
, 
hùx
);

755 } ià(
»v’ts
 & 
FDEVENT_ERR
) {

758 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cgi-FDEVENT_ERR");

760 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

761  
HANDLER_ERROR
;

764  
HANDLER_FINISHED
;

765 
	}
}

768 
	$cgi_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

769 
	`cgi_demux_»¥Ú£
(
¤v
, 
hùx
)) {

770 
FDEVENT_HANDLED_NOT_FINISHED
:

772 
FDEVENT_HANDLED_FINISHED
:

776 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ddss", 
cÚ
->
fd
, 
hùx
->fd, 
	`cÚÃùiÚ_g‘_¡©e
(cÚ->
¡©e
), "finished");

778 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

781  
HANDLER_FINISHED
;

782 
FDEVENT_HANDLED_COMEBACK
:

783 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

784  
HANDLER_COMEBACK
;

785 
FDEVENT_HANDLED_ERROR
:

786 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "demuxer failed: ");

788 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

789  
HANDLER_FINISHED
;

792  
HANDLER_GO_ON
;

793 
	}
}

796 
hªdËr_t
 
	$cgi_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
) {

797 
hªdËr_ùx
 *
hùx
 = 
ùx
;

798 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

800 
	`jobli¡_­³nd
(
¤v
, 
cÚ
);

802 ià(
»v’ts
 & 
FDEVENT_IN
) {

803 
hªdËr_t
 
rc
 = 
	`cgi_»cv_»¥Ú£
(
¤v
, 
hùx
);

804 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

808 ià(
»v’ts
 & 
FDEVENT_HUP
) {

809 ià(
cÚ
->
fe_¡¬‹d
) {

815 
hªdËr_t
 
rc
;

817 
rc
 = 
	`cgi_»cv_»¥Ú£
(
¤v
,
hùx
);

818 } 
rc
 =ğ
HANDLER_GO_ON
);

819  
rc
;

820 } ià(!
	`bufãr_¡ršg_is_em±y
(
hùx
->
»¥Ú£_h—d”
)) {

822 
cÚ
->
fe_¡¬‹d
 = 1;

823 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£_h—d”
)) {

824 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

825  
HANDLER_ERROR
;

829 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddd", "gÙ HUP from cgi", 
cÚ
->
fd
, 
hùx
->fd, 
»v’ts
);

832 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

833 } ià(
»v’ts
 & 
FDEVENT_ERR
) {

835 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

837 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cgi-FDEVENT_ERR");

839  
HANDLER_ERROR
;

842  
HANDLER_FINISHED
;

843 
	}
}

846 
	$cgi_’v_add
(*
v’v
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

847 
ch¬_¬¿y
 *
’v
 = 
v’v
;

848 *
d¡
;

850 ià(!
key
 || !
v®
)  -1;

852 
d¡
 = 
	`m®loc
(
key_Ën
 + 
v®_Ën
 + 2);

853 
	`fÜû_as£¹
(
d¡
);

854 
	`memıy
(
d¡
, 
key
, 
key_Ën
);

855 
d¡
[
key_Ën
] = '=';

856 
	`memıy
(
d¡
 + 
key_Ën
 + 1, 
v®
, 
v®_Ën
);

857 
d¡
[
key_Ën
 + 1 + 
v®_Ën
] = '\0';

859 ià(
’v
->
size
 == 0) {

860 
’v
->
size
 = 16;

861 
’v
->
±r
 = 
	`m®loc
Ónv->
size
 * (*env->ptr));

862 
	`fÜû_as£¹
(
’v
->
±r
);

863 } ià(
’v
->
size
 =ğ’v->
u£d
) {

864 
’v
->
size
 += 16;

865 
’v
->
±r
 = 
	`»®loc
Ónv->±r,ƒnv->
size
 * (*env->ptr));

866 
	`fÜû_as£¹
(
’v
->
±r
);

869 
’v
->
±r
[’v->
u£d
++] = 
d¡
;

872 
	}
}

875 
off_t
 
	$mm­_®ign_off£t
(
off_t
 
¡¬t
) {

876 
off_t
 
·gemask
 = 0;

877 ià(0 =ğ
·gemask
) {

878 
·gesize
 = 
	`syscÚf
(
_SC_PAGESIZE
);

879 ià(-1 =ğ
·gesize
)…agesize = 4096;

880 
·gemask
 = ~((
off_t
)
·gesize
 - 1);

882  (
¡¬t
 & 
·gemask
);

883 
	}
}

892 
ssize_t
 
	$cgi_wr™e_fe_chunk_mm­
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
) {

893 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

894 
off_t
 
off£t
, 
toS’d
, 
fe_’d
;

895 
ssize_t
 
r
;

896 
size_t
 
mm­_off£t
, 
mm­_ava
;

897 *
d©a
;

899 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

900 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

901 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

903 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

904 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

905 
fe_’d
 = 
c
->
fe
.
¡¬t
 + c->fe.
Ëngth
;

907 ià(0 =ğ
toS’d
) {

908 
	`chunkqueue_»move_fšished_chunks
(
cq
);

913 
	`UNUSED
(
cÚ
);

914 ià(-1 =ğ
c
->
fe
.
fd
) {

915 ià(-1 =ğ(
c
->
fe
.
fd
 = 
	`fdev’t_İ’_şÛxec
(c->fe.
Çme
->
±r
, 
O_RDONLY
, 0))) {

916 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "İ’ faed:", 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
);

922 ià(
MAP_FAILED
 =ğ
c
->
fe
.
mm­
.
¡¬t


923 || 
off£t
 < 
c
->
fe
.
mm­
.offset

924 || 
fe_’d
 > (
off_t
)(
c
->
fe
.
mm­
.
off£t
 + c->fe.mm­.
Ëngth
)) {

926 ià(
MAP_FAILED
 !ğ
c
->
fe
.
mm­
.
¡¬t
) {

927 
	`munm­
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
);

928 
c
->
fe
.
mm­
.
¡¬t
 = 
MAP_FAILED
;

931 
c
->
fe
.
mm­
.
off£t
 = 
	`mm­_®ign_off£t
(offset);

932 
c
->
fe
.
mm­
.
Ëngth
 = 
fe_’d
 - c->fe.mm­.
off£t
;

934 ià(
MAP_FAILED
 =ğ(
c
->
fe
.
mm­
.
¡¬t
 = 
	`mm­
(
NULL
, c->fe.mm­.
Ëngth
, 
PROT_READ
, 
MAP_PRIVATE
, c->fe.
fd
, c->fe.mm­.
off£t
))) {

935 ià(
toS’d
 > 65536)oSend = 65536;

936 
d©a
 = 
	`m®loc
(
toS’d
);

937 
	`fÜû_as£¹
(
d©a
);

938 ià(-1 =ğ
	`l£ek
(
c
->
fe
.
fd
, 
off£t
, 
SEEK_SET
)

939 || 0 >ğ(
toS’d
 = 
	`»ad
(
c
->
fe
.
fd
, 
d©a
,oSend))) {

940 ià(-1 =ğ
toS’d
) {

941 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbdo", "lseek/read failed:",

942 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
, c->fe.
fd
, 
off£t
);

944 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdo", "unexpected EOF (inputruncated?):",

945 
c
->
fe
.
Çme
, c->fe.
fd
, 
off£t
);

947 
	`ä“
(
d©a
);

953 ià(
MAP_FAILED
 !ğ
c
->
fe
.
mm­
.
¡¬t
) {

954 
	`fÜû_as£¹
(
off£t
 >ğ
c
->
fe
.
mm­
.offset);

955 
mm­_off£t
 = 
off£t
 - 
c
->
fe
.
mm­
.offset;

956 
	`fÜû_as£¹
(
c
->
fe
.
mm­
.
Ëngth
 > 
mm­_off£t
);

957 
mm­_ava
 = 
c
->
fe
.
mm­
.
Ëngth
 - 
mm­_off£t
;

958 
	`fÜû_as£¹
(
toS’d
 <ğ(
off_t
è
mm­_ava
);

960 
d©a
 = 
c
->
fe
.
mm­
.
¡¬t
 + 
mm­_off£t
;

963 
r
 = 
	`wr™e
(
fd
, 
d©a
, 
toS’d
);

965 ià(
MAP_FAILED
 =ğ
c
->
fe
.
mm­
.
¡¬t
è
	`ä“
(
d©a
);

967 ià(
r
 < 0) {

968 
”ºo
) {

969 
EAGAIN
:

970 
EINTR
:

972 
EPIPE
:

973 
ECONNRESET
:

976 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

977 "wr™çed:", 
	`¡»¼Ü
(
”ºo
), 
fd
);

982 ià(
r
 >= 0) {

983 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

986  
r
;

987 
	}
}

989 
	$cgi_wr™e_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
fd
) {

990 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

991 
chunkqueue
 *
cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

992 
chunk
 *
c
;

999 
c
 = 
cq
->
fœ¡
; c; c = cq->first) {

1000 
ssize_t
 
r
 = -1;

1002 
c
->
ty³
) {

1003 
FILE_CHUNK
:

1004 
r
 = 
	`cgi_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
);

1007 
MEM_CHUNK
:

1008 ià((
r
 = 
	`wr™e
(
fd
, 
c
->
mem
->
±r
 + c->
off£t
, 
	`bufãr_¡ršg_Ëngth
(c->mem) - c->offset)) < 0) {

1009 
”ºo
) {

1010 
EAGAIN
:

1011 
EINTR
:

1013 
r
 = 0;

1015 
EPIPE
:

1016 
ECONNRESET
:

1018 
r
 = -2;

1022 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "wr™çed duto: ", 
	`¡»¼Ü
(
”ºo
));

1023 
r
 = -1;

1026 } ià(
r
 > 0) {

1027 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

1032 ià(0 =ğ
r
) ;

1034 
r
) {

1040 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "failedo send…ost datao cgi, connection closed by CGI");

1042 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
	`chunkqueue_Ëngth
(cq));

1049 ià(
cq
->
by‹s_out
 =ğ(
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1052 ià(-1 =ğ
hùx
->
fdtocgi
) {

1053 --
¤v
->
cur_fds
;

1054 ià(
	`şo£
(
fd
)) {

1055 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds", "cg˜¡dš clo£ faed ", 
fd
, 
	`¡»¼Ü
(
”ºo
));

1058 
	`cgi_cÚÃùiÚ_şo£_fdtocgi
(
¤v
, 
hùx
);

1061 
off_t
 
cqËn
 = 
cq
->
by‹s_š
 - cq->
by‹s_out
;

1062 ià(
cq
->
by‹s_š
 !ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 && 
cqËn
 < 65536 - 16384) {

1064 ià(!(
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_POLLIN
)) {

1065 
cÚ
->
cÚf
.
¡»am_»que¡_body
 |ğ
FDEVENT_STREAM_REQUEST_POLLIN
;

1066 
cÚ
->
is_»adabË
 = 1;

1069 ià(-1 =ğ
hùx
->
fdtocgi
) {

1070 
hùx
->
fdtocgi
 = 
fd
;

1071 
hùx
->
fde_ndx_tocgi
 = -1;

1072 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
hùx
->
fdtocgi
, 
cgi_hªdË_fdev’t_£nd
, hctx);

1074 ià(0 =ğ
cqËn
) {

1075 ià((
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fdtocgi
è& 
FDEVENT_OUT
)) {

1076 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
hùx
->
fde_ndx_tocgi
), hùx->
fdtocgi
, 0);

1080 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
hùx
->
fde_ndx_tocgi
), hùx->
fdtocgi
, 
FDEVENT_OUT
);

1085 
	}
}

1087 
	$cgi_ü—‹_’v
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
hªdËr_ùx
 *
hùx
, 
bufãr
 *
cgi_hªdËr
) {

1088 
pid_t
 
pid
;

1090 
to_cgi_fds
[2];

1091 
äom_cgi_fds
[2];

1092 
¡©
 
¡
;

1093 
	`UNUSED
(
p
);

1095 #iâdeà
__WIN32


1097 ià(!
	`bufãr_¡ršg_is_em±y
(
cgi_hªdËr
)) {

1099 ià(-1 =ğ(
	`¡©
(
cgi_hªdËr
->
±r
, &
¡
))) {

1100 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

1101 "¡© fÜ cgi-hªdËr", 
cgi_hªdËr
,

1102 "çed:", 
	`¡»¼Ü
(
”ºo
));

1107 ià(
	`pe_şÛxec
(
to_cgi_fds
)) {

1108 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "pçed:", 
	`¡»¼Ü
(
”ºo
));

1112 ià(
	`pe_şÛxec
(
äom_cgi_fds
)) {

1113 
	`şo£
(
to_cgi_fds
[0]);

1114 
	`şo£
(
to_cgi_fds
[1]);

1115 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "pçed:", 
	`¡»¼Ü
(
”ºo
));

1120 
pid
 = 
	`fÜk
()) {

1123 **
¬gs
;

1124 
¬gc
;

1125 
i
 = 0;

1126 
ch¬_¬¿y
 
’v
;

1127 *
c
;

1128 cÚ¡ *
s
;

1129 
h‰p_cgi_İts
 
İts
 = { 0, 0, 
NULL
, NULL };

1132 
	`dup2
(
äom_cgi_fds
[1], 
STDOUT_FILENO
);

1133 #iâdeà
FD_CLOEXEC


1134 
	`şo£
(
äom_cgi_fds
[1]);

1136 
	`şo£
(
äom_cgi_fds
[0]);

1140 
	`dup2
(
to_cgi_fds
[0], 
STDIN_FILENO
);

1141 #iâdeà
FD_CLOEXEC


1142 
	`şo£
(
to_cgi_fds
[0]);

1144 
	`şo£
(
to_cgi_fds
[1]);

1148 
’v
.
±r
 = 
NULL
;

1149 
’v
.
size
 = 0;

1150 
’v
.
u£d
 = 0;

1152 
	`h‰p_cgi_h—d”s
(
¤v
, 
cÚ
, &
İts
, 
cgi_’v_add
, &
’v
);

1155 ià(
NULL
 !ğ(
s
 = 
	`g‘’v
("LD_PRELOAD"))) {

1156 
	`cgi_’v_add
(&
’v
, 
	`CONST_STR_LEN
("LD_PRELOAD"), 
s
, 
	`¡¾’
(s));

1159 ià(
NULL
 !ğ(
s
 = 
	`g‘’v
("LD_LIBRARY_PATH"))) {

1160 
	`cgi_’v_add
(&
’v
, 
	`CONST_STR_LEN
("LD_LIBRARY_PATH"), 
s
, 
	`¡¾’
(s));

1162 #ifdeà
__CYGWIN__


1164 ià(
NULL
 !ğ(
s
 = 
	`g‘’v
("SYSTEMROOT"))) {

1165 
	`cgi_’v_add
(&
’v
, 
	`CONST_STR_LEN
("SYSTEMROOT"), 
s
, 
	`¡¾’
(s));

1169 ià(
’v
.
size
 =ğ’v.
u£d
) {

1170 
’v
.
size
 += 16;

1171 
’v
.
±r
 = 
	`»®loc
Ónv.±r,ƒnv.
size
 * (*env.ptr));

1174 
’v
.
±r
[’v.
u£d
] = 
NULL
;

1177 
¬gc
 = 3;

1178 
¬gs
 = 
	`m®loc
((*¬gsè* 
¬gc
);

1179 
	`fÜû_as£¹
(
¬gs
);

1180 
i
 = 0;

1182 ià(!
	`bufãr_¡ršg_is_em±y
(
cgi_hªdËr
)) {

1183 
¬gs
[
i
++] = 
cgi_hªdËr
->
±r
;

1185 
¬gs
[
i
++] = 
cÚ
->
physiÿl
.
·th
->
±r
;

1186 
¬gs
[
i
 ] = 
NULL
;

1189 ià(
NULL
 !ğ(
c
 = 
	`¡¼chr
(
cÚ
->
physiÿl
.
·th
->
±r
, '/'))) {

1191 cÚ¡ * 
physdœ
 = (
c
 =ğ
cÚ
->
physiÿl
.
·th
->
±r
) ? "/" : con->physical.path->ptr;

1194 *
c
 = '\0';

1196 ià(-1 =ğ
	`chdœ
(
physdœ
)) {

1197 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "chdœ faed:", 
	`¡»¼Ü
(
”ºo
), 
cÚ
->
physiÿl
.
·th
);

1199 *
c
 = '/';

1203 
i
 = 3; i < 256; i++) {

1204 ià(
i
 !ğ
¤v
->
”rÜlog_fd
è
	`şo£
(i);

1208 
	`execve
(
¬gs
[0],‡rgs, 
’v
.
±r
);

1212 
	`³¼Ü
(
¬gs
[0]);

1213 
	`_ex™
(1);

1217 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fÜk faed:", 
	`¡»¼Ü
(
”ºo
));

1218 
	`şo£
(
äom_cgi_fds
[0]);

1219 
	`şo£
(
äom_cgi_fds
[1]);

1220 
	`şo£
(
to_cgi_fds
[0]);

1221 
	`şo£
(
to_cgi_fds
[1]);

1226 
	`şo£
(
äom_cgi_fds
[1]);

1227 
	`şo£
(
to_cgi_fds
[0]);

1231 
hùx
->
pid
 =…id;

1232 
hùx
->
fd
 = 
äom_cgi_fds
[0];

1233 
hùx
->
fde_ndx
 = -1;

1235 ++
¤v
->
cur_fds
;

1237 ià(0 =ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1238 
	`şo£
(
to_cgi_fds
[1]);

1241 ià(-1 =ğ
	`fdev’t_fú_£t_nb
(
¤v
->
ev
, 
to_cgi_fds
[1])) {

1242 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fú faed: ", 
	`¡»¼Ü
(
”ºo
));

1243 
	`şo£
(
to_cgi_fds
[1]);

1244 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1248 ià(0 !ğ
	`cgi_wr™e_»que¡
(
¤v
, 
hùx
, 
to_cgi_fds
[1])) {

1249 
	`şo£
(
to_cgi_fds
[1]);

1250 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1254 ++
¤v
->
cur_fds
;

1257 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
hùx
->
fd
, 
cgi_hªdË_fdev’t
, hctx);

1258 ià(-1 =ğ
	`fdev’t_fú_£t_nb
(
¤v
->
ev
, 
hùx
->
fd
)) {

1259 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fú faed: ", 
	`¡»¼Ü
(
”ºo
));

1260 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1263 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

1273 
	}
}

1275 
bufãr
 * 
	$cgi_g‘_hªdËr
(
¬¿y
 *
a
, 
bufãr
 *
â
) {

1276 
size_t
 
k
, 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
â
);

1277 
k
 = 0; k < 
a
->
u£d
; ++k) {

1278 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
a
->
d©a
[
k
];

1279 
size_t
 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
key
);

1281 ià(
	`bufãr_is_em±y
(
ds
->
key
)) ;

1282 ià(
s_Ën
 < 
ù_Ën
) ;

1284 ià(0 =ğ
	`¡ºcmp
(
â
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
key
->ptr, ct_len)) {

1285  
ds
->
v®ue
;

1289  
NULL
;

1290 
	}
}

1292 
	#PATCH
(
x
) \

1293 
p
->
cÚf
.
x
 = 
s
->x;

	)

1294 
	$mod_cgi_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

1295 
size_t
 
i
, 
j
;

1296 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

1298 
	`PATCH
(
cgi
);

1299 
	`PATCH
(
execu‹_x_Úly
);

1300 
	`PATCH
(
x£ndfe_®low
);

1301 
	`PATCH
(
x£ndfe_doüoÙ
);

1304 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1305 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

1306 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

1309 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

1312 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

1313 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

1315 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cgi.assign"))) {

1316 
	`PATCH
(
cgi
);

1317 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cgi.execute-x-only"))) {

1318 
	`PATCH
(
execu‹_x_Úly
);

1319 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cgi.x-sendfile"))) {

1320 
	`PATCH
(
x£ndfe_®low
);

1321 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cgi.x-sendfile-docroot"))) {

1322 
	`PATCH
(
x£ndfe_doüoÙ
);

1328 
	}
}

1329 #undeà
PATCH


1331 
	$URIHANDLER_FUNC
(
cgi_is_hªdËd
) {

1332 
¶ugš_d©a
 *
p
 = 
p_d
;

1333 
bufãr
 *
â
 = 
cÚ
->
physiÿl
.
·th
;

1334 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

1335 
¡©
 
¡buf
;

1336 
¡©
 *
¡
;

1337 
bufãr
 *
cgi_hªdËr
;

1339 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

1341 ià(
	`bufãr_is_em±y
(
â
)è 
HANDLER_GO_ON
;

1343 
	`mod_cgi_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1345 ià(
HANDLER_ERROR
 !ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

1346 
¡
 = &
sû
->st;

1350 ià(0 !ğ
	`¡©
(
cÚ
->
physiÿl
.
·th
->
±r
, &
¡buf
)è 
HANDLER_GO_ON
;

1351 
¡
 = &
¡buf
;

1354 ià(!
	`S_ISREG
(
¡
->
¡_mode
)è 
HANDLER_GO_ON
;

1355 ià(
p
->
cÚf
.
execu‹_x_Úly
 =ğ1 && (
¡
->
¡_mode
 & (
S_IXUSR
 | 
S_IXGRP
 | 
S_IXOTH
)è=ğ0è 
HANDLER_GO_ON
;

1357 ià(
NULL
 !ğ(
cgi_hªdËr
 = 
	`cgi_g‘_hªdËr
(
p
->
cÚf
.
cgi
, 
â
))) {

1358 
hªdËr_ùx
 *
hùx
 = 
	`cgi_hªdËr_ùx_š™
();

1359 
hùx
->
»mÙe_cÚn
 = 
cÚ
;

1360 
hùx
->
¶ugš_d©a
 = 
p
;

1361 
hùx
->
cgi_hªdËr
 = cgi_handler;

1362 
	`memıy
(&
hùx
->
cÚf
, &
p
->cÚf, (
¶ugš_cÚfig
));

1363 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

1364 
cÚ
->
mode
 = 
p
->
id
;

1367  
HANDLER_GO_ON
;

1368 
	}
}

1370 
	$TRIGGER_FUNC
(
cgi_Œigg”
) {

1371 
¶ugš_d©a
 *
p
 = 
p_d
;

1372 
size_t
 
ndx
;

1374 #iâdeà
__WIN32


1376 
ndx
 = 0;‚dx < 
p
->
cgi_pid
.
u£d
;‚dx++) {

1377 
¡©us
;

1379 
	`wa™pid
(
p
->
cgi_pid
.
±r
[
ndx
], &
¡©us
, 
WNOHANG
)) {

1383 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "(debugèchd i¢'ˆdÚy‘,…id:", 
p
->
cgi_pid
.
±r
[
ndx
]);

1387 ià(
”ºo
 =ğ
ECHILD
) {

1389 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cgi child vanished,…robably someoneƒlse called waitpid");

1391 
	`cgi_pid_d–
(
¤v
, 
p
,…->
cgi_pid
.
±r
[
ndx
]);

1392 
ndx
--;

1396 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "wa™pid faed: ", 
	`¡»¼Ü
(
”ºo
));

1398  
HANDLER_ERROR
;

1401 ià(
	`WIFEXITED
(
¡©us
)) {

1403 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "(debugècg˜ex™ed fše,…id:", 
p
->
cgi_pid
.
±r
[
ndx
]);

1405 } ià(
	`WIFSIGNALED
(
¡©us
)) {

1408 ià(
	`WTERMSIG
(
¡©us
è!ğ
SIGTERM
) {

1409 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "ş—nšg u°CGI:…roûs d›d w™h sigÇl", 
	`WTERMSIG
(
¡©us
));

1412 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cleaning up CGI:ƒnded unexpectedly");

1415 
	`cgi_pid_d–
(
¤v
, 
p
,…->
cgi_pid
.
±r
[
ndx
]);

1420 
ndx
--;

1424  
HANDLER_GO_ON
;

1425 
	}
}

1432 
	$SUBREQUEST_FUNC
(
mod_cgi_hªdË_sub»que¡
) {

1433 
¶ugš_d©a
 *
p
 = 
p_d
;

1434 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1435 
chunkqueue
 *
cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

1437 ià(
cÚ
->
mode
 !ğ
p
->
id
è 
HANDLER_GO_ON
;

1438 ià(
NULL
 =ğ
hùx
è 
HANDLER_GO_ON
;

1440 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

1441 && 
cÚ
->
fe_¡¬‹d
) {

1442 ià(
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

1443 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

1444 } ià(!(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_IN
)) {

1446 
hªdËr_t
 
rc
 = 
	`cgi_»cv_»¥Ú£
(
¤v
, 
hùx
);

1447 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

1451 ià(
cq
->
by‹s_š
 !ğ(
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1454 ià(
cq
->
by‹s_š
 - cq->
by‹s_out
 > 65536 - 4096

1455 && (
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_BUFMIN
)){

1456 
cÚ
->
cÚf
.
¡»am_»que¡_body
 &ğ~
FDEVENT_STREAM_REQUEST_POLLIN
;

1457 ià(-1 !ğ
hùx
->
fd
è 
HANDLER_WAIT_FOR_EVENT
;

1459 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

1460 ià(!
	`chunkqueue_is_em±y
(
cq
)) {

1461 ià(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fdtocgi
è& 
FDEVENT_OUT
) {

1462  (
r
 =ğ
HANDLER_GO_ON
è? 
HANDLER_WAIT_FOR_EVENT
 :„;

1465 ià(
r
 !ğ
HANDLER_GO_ON
) „;

1471 ià(-1 =ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1472  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 411);

1477 ià(-1 =ğ
hùx
->
fd
) {

1478 ià(
	`cgi_ü—‹_’v
(
¤v
, 
cÚ
, 
p
, 
hùx
, hùx->
cgi_hªdËr
)) {

1479 
cÚ
->
h‰p_¡©us
 = 500;

1480 
cÚ
->
mode
 = 
DIRECT
;

1482  
HANDLER_FINISHED
;

1485 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd", "sub»que¡,…id =", 
hùx
, hùx->
pid
);

1487 } ià(!
	`chunkqueue_is_em±y
(
cÚ
->
»que¡_cÚ‹Á_queue
)) {

1488 ià(0 !ğ
	`cgi_wr™e_»que¡
(
¤v
, 
hùx
, hùx->
fdtocgi
)) {

1489 
	`cgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1490  
HANDLER_ERROR
;

1495  
HANDLER_WAIT_FOR_EVENT
;

1496 
	}
}

1499 
mod_cgi_¶ugš_š™
(
¶ugš
 *
p
);

1500 
	$mod_cgi_¶ugš_š™
(
¶ugš
 *
p
) {

1501 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1502 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("cgi");

1504 
p
->
cÚÃùiÚ_»£t
 = 
cgi_cÚÃùiÚ_şo£_ÿÎback
;

1505 
p
->
hªdË_sub»que¡_¡¬t
 = 
cgi_is_hªdËd
;

1506 
p
->
hªdË_sub»que¡
 = 
mod_cgi_hªdË_sub»que¡
;

1507 
p
->
hªdË_Œigg”
 = 
cgi_Œigg”
;

1508 
p
->
š™
 = 
mod_cgi_š™
;

1509 
p
->
ş—nup
 = 
mod_cgi_ä“
;

1510 
p
->
£t_deçuÉs
 = 
mod_ç¡cgi_£t_deçuÉs
;

1512 
p
->
d©a
 = 
NULL
;

1515 
	}
}

	@mod_cml.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"£rv”.h
"

5 
	~"log.h
"

6 
	~"¶ugš.h
"

7 
	~"»¥Ú£.h
"

9 
	~"mod_cml.h
"

11 
	~<sys/¡©.h
>

12 
	~<time.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

16 
	~<”ºo.h
>

17 
	~<uni¡d.h
>

18 
	~<¡dio.h
>

21 
	$INIT_FUNC
(
mod_cml_š™
) {

22 
¶ugš_d©a
 *
p
;

24 
p
 = 
	`ÿÎoc
(1, (*p));

26 
p
->
ba£dœ
 = 
	`bufãr_š™
();

27 
p
->
ba£u¾
 = 
	`bufãr_š™
();

28 
p
->
Œigg”_hªdËr
 = 
	`bufãr_š™
();

30  
p
;

31 
	}
}

34 
	$FREE_FUNC
(
mod_cml_ä“
) {

35 
¶ugš_d©a
 *
p
 = 
p_d
;

37 
	`UNUSED
(
¤v
);

39 ià(!
p
è 
HANDLER_GO_ON
;

41 ià(
p
->
cÚfig_¡Üage
) {

42 
size_t
 
i
;

43 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

44 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

46 ià(
NULL
 =ğ
s
) ;

48 
	`bufãr_ä“
(
s
->
ext
);

50 
	`bufãr_ä“
(
s
->
mc_Çme¥aû
);

51 
	`bufãr_ä“
(
s
->
pow”_magÃt
);

52 
	`¬¿y_ä“
(
s
->
mc_ho¡s
);

54 #ià
	`defšed
(
USE_MEMCACHED
)

55 ià(
s
->
memc
è
	`memÿched_ä“
(s->memc);

58 
	`ä“
(
s
);

60 
	`ä“
(
p
->
cÚfig_¡Üage
);

63 
	`bufãr_ä“
(
p
->
Œigg”_hªdËr
);

64 
	`bufãr_ä“
(
p
->
ba£dœ
);

65 
	`bufãr_ä“
(
p
->
ba£u¾
);

67 
	`ä“
(
p
);

69  
HANDLER_GO_ON
;

70 
	}
}

74 
	$SETDEFAULTS_FUNC
(
mod_cml_£t_deçuÉs
) {

75 
¶ugš_d©a
 *
p
 = 
p_d
;

76 
size_t
 
i
 = 0;

78 
cÚfig_v®ues_t
 
cv
[] = {

79 { "cml.ex‹nsiÚ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

80 { "cml.memÿche-ho¡s", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

81 { "cml.memÿche-Çme¥aû", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

82 { "cml.pow”-magÃt", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

83 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

86 ià(!
p
è 
HANDLER_ERROR
;

88 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

90 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

91 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

92 
¶ugš_cÚfig
 *
s
;

94 
s
 = 
	`m®loc
((
¶ugš_cÚfig
));

95 
s
->
ext
 = 
	`bufãr_š™
();

96 
s
->
mc_ho¡s
 = 
	`¬¿y_š™
();

97 
s
->
mc_Çme¥aû
 = 
	`bufãr_š™
();

98 
s
->
pow”_magÃt
 = 
	`bufãr_š™
();

99 #ià
	`defšed
(
USE_MEMCACHED
)

100 
s
->
memc
 = 
NULL
;

103 
cv
[0].
de¡š©iÚ
 = 
s
->
ext
;

104 
cv
[1].
de¡š©iÚ
 = 
s
->
mc_ho¡s
;

105 
cv
[2].
de¡š©iÚ
 = 
s
->
mc_Çme¥aû
;

106 
cv
[3].
de¡š©iÚ
 = 
s
->
pow”_magÃt
;

108 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

110 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

111  
HANDLER_ERROR
;

114 ià(
s
->
mc_ho¡s
->
u£d
) {

115 #ià
	`defšed
(
USE_MEMCACHED
)

116 
bufãr
 *
İtiÚ_¡ršg
 = 
	`bufãr_š™
();

117 
size_t
 
k
;

120 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
mc_ho¡s
->
d©a
[0];

122 
	`bufãr_­³nd_¡ršg_Ën
(
İtiÚ_¡ršg
, 
	`CONST_STR_LEN
("--SERVER="));

123 
	`bufãr_­³nd_¡ršg_bufãr
(
İtiÚ_¡ršg
, 
ds
->
v®ue
);

126 
k
 = 1; k < 
s
->
mc_ho¡s
->
u£d
; k++) {

127 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
mc_ho¡s
->
d©a
[
k
];

129 
	`bufãr_­³nd_¡ršg_Ën
(
İtiÚ_¡ršg
, 
	`CONST_STR_LEN
(" --SERVER="));

130 
	`bufãr_­³nd_¡ršg_bufãr
(
İtiÚ_¡ršg
, 
ds
->
v®ue
);

133 
s
->
memc
 = 
	`memÿched
(
	`CONST_BUF_LEN
(
İtiÚ_¡ršg
));

135 ià(
NULL
 =ğ
s
->
memc
) {

136 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

138 
İtiÚ_¡ršg
);

140 
	`bufãr_ä“
(
İtiÚ_¡ršg
);

142 ià(
NULL
 =ğ
s
->
memc
è 
HANDLER_ERROR
;

144 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

146  
HANDLER_ERROR
;

151  
HANDLER_GO_ON
;

152 
	}
}

154 
	#PATCH
(
x
) \

155 
p
->
cÚf
.
x
 = 
s
->x;

	)

156 
	$mod_cml_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

157 
size_t
 
i
, 
j
;

158 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

160 
	`PATCH
(
ext
);

161 #ià
	`defšed
(
USE_MEMCACHED
)

162 
	`PATCH
(
memc
);

164 
	`PATCH
(
mc_Çme¥aû
);

165 
	`PATCH
(
pow”_magÃt
);

168 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

169 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

170 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

173 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

176 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

177 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

179 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cml.extension"))) {

180 
	`PATCH
(
ext
);

181 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cml.memcache-hosts"))) {

182 #ià
	`defšed
(
USE_MEMCACHED
)

183 
	`PATCH
(
memc
);

185 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cml.memcache-namespace"))) {

186 
	`PATCH
(
mc_Çme¥aû
);

187 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("cml.power-magnet"))) {

188 
	`PATCH
(
pow”_magÃt
);

194 
	}
}

195 #undeà
PATCH


197 
	$ÿche_ÿÎ_lua
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
cml_fe
) {

198 
bufãr
 *
b
;

199 *
c
;

202 
b
 = 
p
->
ba£u¾
;

203 
	`bufãr_cİy_bufãr
(
b
, 
cÚ
->
uri
.
·th
);

204 
c
 = 
b
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(b); c > b->ptr && *c != '/'; c--);

206 ià(*
c
 == '/') {

207 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 
c
 - b->
±r
 + 1);

210 
b
 = 
p
->
ba£dœ
;

211 
	`bufãr_cİy_bufãr
(
b
, 
cÚ
->
physiÿl
.
·th
);

212 
c
 = 
b
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(b); c > b->ptr && *c != '/'; c--);

214 ià(*
c
 == '/') {

215 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 
c
 - b->
±r
 + 1);

223  
	`ÿche_·r£_lua
(
¤v
, 
cÚ
, 
p
, 
cml_fe
);

224 
	}
}

226 
	$URIHANDLER_FUNC
(
mod_cml_pow”_magÃt
) {

227 
¶ugš_d©a
 *
p
 = 
p_d
;

229 
	`mod_cml_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

231 
	`bufãr_»£t
(
p
->
ba£dœ
);

232 
	`bufãr_»£t
(
p
->
ba£u¾
);

233 
	`bufãr_»£t
(
p
->
Œigg”_hªdËr
);

235 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
pow”_magÃt
)è 
HANDLER_GO_ON
;

254 
	`ÿche_ÿÎ_lua
(
¤v
, 
cÚ
, 
p
,…->
cÚf
.
pow”_magÃt
)) {

257 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

258 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cache-error");

260 
cÚ
->
h‰p_¡©us
 = 500;

261  
HANDLER_COMEBACK
;

263 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

264 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cache-hit");

267 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

268  
HANDLER_FINISHED
;

271  
HANDLER_GO_ON
;

273 
cÚ
->
h‰p_¡©us
 = 500;

274  
HANDLER_COMEBACK
;

276 
	}
}

278 
	$URIHANDLER_FUNC
(
mod_cml_is_hªdËd
) {

279 
¶ugš_d©a
 *
p
 = 
p_d
;

281 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_ERROR
;

283 
	`mod_cml_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

285 
	`bufãr_»£t
(
p
->
ba£dœ
);

286 
	`bufãr_»£t
(
p
->
ba£u¾
);

287 
	`bufãr_»£t
(
p
->
Œigg”_hªdËr
);

289 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
ext
)è 
HANDLER_GO_ON
;

291 ià(!
	`bufãr_is_equ®_right_Ën
(
cÚ
->
physiÿl
.
·th
, 
p
->
cÚf
.
ext
, 
	`bufãr_¡ršg_Ëngth
(p->conf.ext))) {

292  
HANDLER_GO_ON
;

295 
	`ÿche_ÿÎ_lua
(
¤v
, 
cÚ
, 
p
, cÚ->
physiÿl
.
·th
)) {

298 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

299 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cache-error");

301 
cÚ
->
h‰p_¡©us
 = 500;

302  
HANDLER_COMEBACK
;

304 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

305 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cache-hit");

308 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

309  
HANDLER_FINISHED
;

311 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

312 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cache-miss");

315  
HANDLER_COMEBACK
;

317 
cÚ
->
h‰p_¡©us
 = 500;

318  
HANDLER_COMEBACK
;

320 
	}
}

322 
mod_cml_¶ugš_š™
(
¶ugš
 *
p
);

323 
	$mod_cml_¶ugš_š™
(
¶ugš
 *
p
) {

324 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

325 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("cache");

327 
p
->
š™
 = 
mod_cml_š™
;

328 
p
->
ş—nup
 = 
mod_cml_ä“
;

329 
p
->
£t_deçuÉs
 = 
mod_cml_£t_deçuÉs
;

331 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_cml_is_hªdËd
;

332 
p
->
hªdË_physiÿl
 = 
mod_cml_pow”_magÃt
;

334 
p
->
d©a
 = 
NULL
;

337 
	}
}

	@mod_cml.h

1 #iâdeà
_MOD_CACHE_H_


2 
	#_MOD_CACHE_H_


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

6 
	~"£rv”.h
"

7 
	~"»¥Ú£.h
"

9 
	~"¶ugš.h
"

11 #ià
defšed
(
USE_MEMCACHED
)

12 
	~<libmemÿched/memÿched.h
>

15 
	#¶ugš_d©a
 
mod_ÿche_¶ugš_d©a


	)

18 
bufãr
 *
	mext
;

20 
¬¿y
 *
	mmc_ho¡s
;

21 
bufãr
 *
	mmc_Çme¥aû
;

22 #ià
defšed
(
USE_MEMCACHED
)

23 
memÿched_¡
 *
	mmemc
;

25 
bufãr
 *
	mpow”_magÃt
;

26 } 
	t¶ugš_cÚfig
;

29 
	mPLUGIN_DATA
;

31 
bufãr
 *
	mba£dœ
;

32 
bufãr
 *
	mba£u¾
;

34 
bufãr
 *
	mŒigg”_hªdËr
;

36 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

38 
¶ugš_cÚfig
 
	mcÚf
;

39 } 
	t¶ugš_d©a
;

41 
ÿche_·r£_lua
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
â
);

	@mod_cml_funcs.c

1 
	~"fœ¡.h
"

3 
	~<sys/¡©.h
>

4 
	~<time.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<”ºo.h
>

9 
	~<uni¡d.h
>

10 
	~<dœ’t.h
>

11 
	~<¡dio.h
>

13 
	~<Ïuxlib.h
>

15 
	~"mod_cml_funcs.h
"

16 
	~"mod_cml.h
"

18 
	~"bufãr.h
"

19 
	~"£rv”.h
"

20 
	~"log.h
"

21 
	~"¶ugš.h
"

22 
	~"»¥Ú£.h
"

24 
	~"md5.h
"

26 
	#HASHLEN
 16

	)

27 
	tHASH
[
HASHLEN
];

28 
	#HASHHEXLEN
 32

	)

29 
	tHASHHEX
[
HASHHEXLEN
+1];

31 
	$f_üy±o_md5
(
lua_S‹
 *
L
) {

32 
li_MD5_CTX
 
Md5Ctx
;

33 
HASH
 
HA1
;

34 
hex
[33];

35 
n
 = 
	`lua_g‘tİ
(
L
);

36 
size_t
 
s_Ën
;

37 cÚ¡ *
s
;

39 ià(
n
 != 1) {

40 
	`lua_push¡ršg
(
L
, "md5:ƒxpected one‡rgument");

41 
	`lua_”rÜ
(
L
);

44 ià(!
	`lua_is¡ršg
(
L
, 1)) {

45 
	`lua_push¡ršg
(
L
, "md5:‡rgument haso be‡ string");

46 
	`lua_”rÜ
(
L
);

49 
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
s_Ën
);

51 
	`li_MD5_In™
(&
Md5Ctx
);

52 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*è
s
, (è
s_Ën
);

53 
	`li_MD5_Fš®
(
HA1
, &
Md5Ctx
);

55 
	`li_tohex
(
hex
, (hex), (cÚ¡ *è
HA1
, 16);

57 
	`lua_push¡ršg
(
L
, 
hex
);

60 
	}
}

63 
	$f_fe_mtime
(
lua_S‹
 *
L
) {

64 
¡©
 
¡
;

65 
n
 = 
	`lua_g‘tİ
(
L
);

67 ià(
n
 != 1) {

68 
	`lua_push¡ršg
(
L
, "file_mtime:ƒxpected one‡rgument");

69 
	`lua_”rÜ
(
L
);

72 ià(!
	`lua_is¡ršg
(
L
, 1)) {

73 
	`lua_push¡ršg
(
L
, "file_mtime:‡rgument haso be‡ string");

74 
	`lua_”rÜ
(
L
);

77 ià(-1 =ğ
	`¡©
(
	`lua_to¡ršg
(
L
, 1), &
¡
)) {

78 
	`lua_pushn
(
L
);

82 
	`lua_pushš‹g”
(
L
, 
¡
.
¡_mtime
);

85 
	}
}

87 
	$f_dœ_fes_™”
(
lua_S‹
 *
L
) {

88 
DIR
 *
d
;

89 
dœ’t
 *
de
;

91 
d
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

93 ià(
NULL
 =ğ(
de
 = 
	`»addœ
(
d
))) {

95 
	`şo£dœ
(
d
);

99 
	`lua_push¡ršg
(
L
, 
de
->
d_Çme
);

102 
	}
}

104 
	$f_dœ_fes
(
lua_S‹
 *
L
) {

105 
DIR
 *
d
;

106 
n
 = 
	`lua_g‘tİ
(
L
);

108 ià(
n
 != 1) {

109 
	`lua_push¡ršg
(
L
, "dir_files:ƒxpected one‡rgument");

110 
	`lua_”rÜ
(
L
);

113 ià(!
	`lua_is¡ršg
(
L
, 1)) {

114 
	`lua_push¡ršg
(
L
, "dir_files:‡rgument haso be‡ string");

115 
	`lua_”rÜ
(
L
);

119 ià(
NULL
 =ğ(
d
 = 
	`İ’dœ
(
	`lua_to¡ršg
(
L
, 1)))) {

120 
	`lua_pushn
(
L
);

125 
	`lua_pushlightu£rd©a
(
L
, 
d
);

126 
	`lua_pushcşosu»
(
L
, 
f_dœ_fes_™”
, 1);

129 
	}
}

131 
	$f_fe_i¤eg
(
lua_S‹
 *
L
) {

132 
¡©
 
¡
;

133 
n
 = 
	`lua_g‘tİ
(
L
);

135 ià(
n
 != 1) {

136 
	`lua_push¡ršg
(
L
, "file_isreg:ƒxpected one‡rgument");

137 
	`lua_”rÜ
(
L
);

140 ià(!
	`lua_is¡ršg
(
L
, 1)) {

141 
	`lua_push¡ršg
(
L
, "file_isreg:‡rgument haso be‡ string");

142 
	`lua_”rÜ
(
L
);

145 ià(-1 =ğ
	`¡©
(
	`lua_to¡ršg
(
L
, 1), &
¡
)) {

146 
	`lua_pushn
(
L
);

150 
	`lua_pushš‹g”
(
L
, 
	`S_ISREG
(
¡
.
¡_mode
));

153 
	}
}

155 
	$f_fe_isdœ
(
lua_S‹
 *
L
) {

156 
¡©
 
¡
;

157 
n
 = 
	`lua_g‘tİ
(
L
);

159 ià(
n
 != 1) {

160 
	`lua_push¡ršg
(
L
, "file_isreg:ƒxpected one‡rgument");

161 
	`lua_”rÜ
(
L
);

164 ià(!
	`lua_is¡ršg
(
L
, 1)) {

165 
	`lua_push¡ršg
(
L
, "file_isreg:‡rgument haso be‡ string");

166 
	`lua_”rÜ
(
L
);

169 ià(-1 =ğ
	`¡©
(
	`lua_to¡ršg
(
L
, 1), &
¡
)) {

170 
	`lua_pushn
(
L
);

174 
	`lua_pushš‹g”
(
L
, 
	`S_ISDIR
(
¡
.
¡_mode
));

177 
	}
}

181 #ifdeà
USE_MEMCACHED


182 
	$f_memÿche_exi¡s
(
lua_S‹
 *
L
) {

183 
size_t
 
key_Ën
;

184 cÚ¡ *
key
;

185 
memÿched_¡
 *
memc
;

187 ià(!
	`lua_i¦ightu£rd©a
(
L
, 
	`lua_upv®uešdex
(1))) {

188 
	`lua_push¡ršg
(
L
, "where is my userdata ?");

189 
	`lua_”rÜ
(
L
);

192 
memc
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

194 ià(1 !ğ
	`lua_g‘tİ
(
L
)) {

195 
	`lua_push¡ršg
(
L
, "expected one‡rgument");

196 
	`lua_”rÜ
(
L
);

199 
key
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
key_Ën
);

200 
	`lua_pushboŞ—n
(
L
, (
MEMCACHED_SUCCESS
 =ğ
	`memÿched_exi¡
(
memc
, 
key
, 
key_Ën
)));

202 
	}
}

204 
	$f_memÿche_g‘_¡ršg
(
lua_S‹
 *
L
) {

205 
size_t
 
key_Ën
, 
v®ue_Ën
;

206 *
v®ue
;

207 cÚ¡ *
key
;

208 
memÿched_¡
 *
memc
;

210 ià(!
	`lua_i¦ightu£rd©a
(
L
, 
	`lua_upv®uešdex
(1))) {

211 
	`lua_push¡ršg
(
L
, "where is my userdata ?");

212 
	`lua_”rÜ
(
L
);

215 
memc
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

217 ià(1 !ğ
	`lua_g‘tİ
(
L
)) {

218 
	`lua_push¡ršg
(
L
, "expected one‡rgument");

219 
	`lua_”rÜ
(
L
);

222 
key
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
key_Ën
);

223 ià(
NULL
 =ğ(
v®ue
 = 
	`memÿched_g‘
(
memc
, 
key
, 
key_Ën
, &
v®ue_Ën
, NULL, NULL))) {

224 
	`lua_pushn
(
L
);

228 
	`lua_pushl¡ršg
(
L
, 
v®ue
, 
v®ue_Ën
);

230 
	`ä“
(
v®ue
);

233 
	}
}

235 
	$f_memÿche_g‘_lÚg
(
lua_S‹
 *
L
) {

236 
size_t
 
key_Ën
, 
v®ue_Ën
;

237 *
v®ue
;

238 cÚ¡ *
key
;

239 
memÿched_¡
 *
memc
;

240 *
’d±r
;

241 
v
;

243 ià(!
	`lua_i¦ightu£rd©a
(
L
, 
	`lua_upv®uešdex
(1))) {

244 
	`lua_push¡ršg
(
L
, "where is my userdata ?");

245 
	`lua_”rÜ
(
L
);

248 
memc
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

250 ià(1 !ğ
	`lua_g‘tİ
(
L
)) {

251 
	`lua_push¡ršg
(
L
, "expected one‡rgument");

252 
	`lua_”rÜ
(
L
);

255 
key
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
key_Ën
);

256 ià(
NULL
 =ğ(
v®ue
 = 
	`memÿched_g‘
(
memc
, 
key
, 
key_Ën
, &
v®ue_Ën
, NULL, NULL))) {

257 
	`lua_pushn
(
L
);

261 
”ºo
 = 0;

262 
v
 = 
	`¡¹Ş
(
v®ue
, &
’d±r
, 10);

263 ià(0 =ğ
”ºo
 && *
’d±r
 == '\0') {

264 
	`lua_pushš‹g”
(
L
, 
v
);

266 
	`lua_pushn
(
L
);

269 
	`ä“
(
v®ue
);

272 
	}
}

	@mod_cml_funcs.h

1 #iâdeà
_MOD_CML_FUNCS_H_


2 
	#_MOD_CML_FUNCS_H_


	)

3 
	~"fœ¡.h
"

5 
	~<lua.h
>

7 
f_üy±o_md5
(
lua_S‹
 *
L
);

8 
f_fe_mtime
(
lua_S‹
 *
L
);

9 
f_fe_i¤eg
(
lua_S‹
 *
L
);

10 
f_fe_isdœ
(
lua_S‹
 *
L
);

11 
f_dœ_fes
(
lua_S‹
 *
L
);

13 
f_memÿche_exi¡s
(
lua_S‹
 *
L
);

14 
f_memÿche_g‘_¡ršg
(
lua_S‹
 *
L
);

15 
f_memÿche_g‘_lÚg
(
lua_S‹
 *
L
);

	@mod_cml_lua.c

1 
	~"fœ¡.h
"

3 
	~<lua.h
>

4 
	~<lu®ib.h
>

5 
	~<Ïuxlib.h
>

7 
	~<as£¹.h
>

8 
	~<¡dio.h
>

9 
	~<”ºo.h
>

10 
	~<time.h
>

11 
	~<¡ršg.h
>

13 
	~"mod_cml_funcs.h
"

14 
	~"mod_cml.h
"

16 
	~"log.h
"

17 
	~"¡©_ÿche.h
"

19 
	#HASHLEN
 16

	)

20 
	tHASH
[
HASHLEN
];

21 
	#HASHHEXLEN
 32

	)

22 
	tHASHHEX
[
HASHHEXLEN
+1];

24 
	$lua_to_c_g‘_¡ršg
(
lua_S‹
 *
L
, cÚ¡ *
v¬Çme
, 
bufãr
 *
b
) {

25 
cu»Ëm
 = 
	`lua_g‘tİ
(
L
);

26 
»suÉ
;

28 
	`lua_g‘glob®
(
L
, 
v¬Çme
);

30 ià(
	`lua_is¡ršg
(
L
, 
cu»Ëm
)) {

31 
	`bufãr_cİy_¡ršg
(
b
, 
	`lua_to¡ršg
(
L
, 
cu»Ëm
));

32 
»suÉ
 = 0;

34 
»suÉ
 = -1;

37 
	`lua_pİ
(
L
, 1);

38 
	`fÜû_as£¹
(
cu»Ëm
 =ğ
	`lua_g‘tİ
(
L
));

39  
»suÉ
;

40 
	}
}

42 
	$lua_to_c_is_bË
(
lua_S‹
 *
L
, cÚ¡ *
v¬Çme
) {

43 
cu»Ëm
 = 
	`lua_g‘tİ
(
L
);

44 
»suÉ
;

46 
	`lua_g‘glob®
(
L
, 
v¬Çme
);

48 
»suÉ
 = 
	`lua_i¡abË
(
L
, 
cu»Ëm
) ? 1 : 0;

50 
	`lua_pİ
(
L
, 1);

51 
	`fÜû_as£¹
(
cu»Ëm
 =ğ
	`lua_g‘tİ
(
L
));

52  
»suÉ
;

53 
	}
}

55 
	$c_to_lua_push
(
lua_S‹
 *
L
, 
tbl
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

56 
	`lua_pushl¡ršg
(
L
, 
key
, 
key_Ën
);

57 
	`lua_pushl¡ršg
(
L
, 
v®
, 
v®_Ën
);

58 
	`lua_£‰abË
(
L
, 
tbl
);

61 
	}
}

63 
	$ÿche_expÜt_g‘_·¿ms
(
lua_S‹
 *
L
, 
tbl
, 
bufãr
 *
qry¡r
) {

64 
size_t
 
is_key
 = 1;

65 
size_t
 
i
, 
Ën
;

66 *
key
 = 
NULL
, *
v®
 = NULL;

68 
key
 = 
qry¡r
->
±r
;

71 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
qry¡r
);

72 
i
 = 0; i <ğ
Ën
; i++) {

73 
qry¡r
->
±r
[
i
]) {

75 ià(
is_key
) {

76 
v®
 = 
qry¡r
->
±r
 + 
i
 + 1;

78 
qry¡r
->
±r
[
i
] = '\0';

80 
is_key
 = 0;

86 ià(!
is_key
) {

90 
qry¡r
->
±r
[
i
] = '\0';

92 
	`c_to_lua_push
(
L
, 
tbl
,

93 
key
, 
	`¡¾’
(key),

94 
v®
, 
	`¡¾’
(val));

97 
key
 = 
qry¡r
->
±r
 + 
i
 + 1;

98 
v®
 = 
NULL
;

99 
is_key
 = 1;

105 
	}
}

107 
	$ÿche_·r£_lua
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
â
) {

108 
lua_S‹
 *
L
;

109 
»t
 = -1;

110 
bufãr
 *
b
;

112 
b
 = 
	`bufãr_š™
();

114 
L
 = 
	`luaL_Ãw¡©e
();

115 
	`luaL_İ’libs
(
L
);

118 
	`lua_»gi¡”
(
L
, "md5", 
f_üy±o_md5
);

119 
	`lua_»gi¡”
(
L
, "fe_mtime", 
f_fe_mtime
);

120 
	`lua_»gi¡”
(
L
, "fe_i¤eg", 
f_fe_i¤eg
);

121 
	`lua_»gi¡”
(
L
, "fe_isdœ", 
f_fe_i¤eg
);

122 
	`lua_»gi¡”
(
L
, "dœ_fes", 
f_dœ_fes
);

124 #ifdeà
USE_MEMCACHED


125 
	`lua_pushlightu£rd©a
(
L
, 
p
->
cÚf
.
memc
);

126 
	`lua_pushcşosu»
(
L
, 
f_memÿche_g‘_lÚg
, 1);

127 
	`lua_£tglob®
(
L
, "memcache_get_long");

129 
	`lua_pushlightu£rd©a
(
L
, 
p
->
cÚf
.
memc
);

130 
	`lua_pushcşosu»
(
L
, 
f_memÿche_g‘_¡ršg
, 1);

131 
	`lua_£tglob®
(
L
, "memcache_get_string");

133 
	`lua_pushlightu£rd©a
(
L
, 
p
->
cÚf
.
memc
);

134 
	`lua_pushcşosu»
(
L
, 
f_memÿche_exi¡s
, 1);

135 
	`lua_£tglob®
(
L
, "memcache_exists");

139 
	`lua_ÃwbË
(
L
);

141 
h—d”_tbl
 = 
	`lua_g‘tİ
(
L
);

143 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("REQUEST_URI"), 
	`CONST_BUF_LEN
(
cÚ
->
»que¡
.
Üig_uri
));

144 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("SCRIPT_NAME"), 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
));

145 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("SCRIPT_FILENAME"), 
	`CONST_BUF_LEN
(
cÚ
->
physiÿl
.
·th
));

146 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("DOCUMENT_ROOT"), 
	`CONST_BUF_LEN
(
cÚ
->
physiÿl
.
ba£dœ
));

147 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
·thšfo
)) {

148 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("PATH_INFO"), 
	`CONST_BUF_LEN
(
cÚ
->
»que¡
.
·thšfo
));

151 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("CWD"), 
	`CONST_BUF_LEN
(
p
->
ba£dœ
));

152 
	`c_to_lua_push
(
L
, 
h—d”_tbl
, 
	`CONST_STR_LEN
("BASEURL"), 
	`CONST_BUF_LEN
(
p
->
ba£u¾
));

154 
	`lua_£tglob®
(
L
, "request");

157 
	`lua_ÃwbË
(
L
);

159 
g‘_tbl
 = 
	`lua_g‘tİ
(
L
);

161 
	`bufãr_cİy_bufãr
(
b
, 
cÚ
->
uri
.
qu”y
);

162 
	`ÿche_expÜt_g‘_·¿ms
(
L
, 
g‘_tbl
, 
b
);

163 
	`bufãr_»£t
(
b
);

165 
	`lua_£tglob®
(
L
, "get");

168 
	`lua_pushš‹g”
(
L
, 0);

169 
	`lua_£tglob®
(
L
, "CACHE_HIT");

171 
	`lua_pushš‹g”
(
L
, 1);

172 
	`lua_£tglob®
(
L
, "CACHE_MISS");

175 
»t
 = 
	`luaL_lßdfe
(
L
, 
â
->
±r
);

176 ià(0 !ğ
»t
) {

177 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsS",

179 
â
,

181 
	`lua_to¡ršg
(
L
, -1));

182 
”rÜ
;

185 ià(
	`lua_pÿÎ
(
L
, 0, 1, 0)) {

186 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsS",

188 
â
,

190 
	`lua_to¡ršg
(
L
, -1));

191 
”rÜ
;

195 
»t
 = ()
	`lua_toš‹g”
(
L
, -1);

196 
	`lua_pİ
(
L
, 1);

199 
	`lua_to_c_g‘_¡ršg
(
L
, "Œigg”_hªdËr", 
p
->
Œigg”_hªdËr
);

201 ià(0 =ğ
	`lua_to_c_g‘_¡ršg
(
L
, "ouut_cÚ‹Áty³", 
b
)) {

202 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
b
));

205 ià(
»t
 == 0) {

208 
cu»Ëm
;

209 
time_t
 
mtime
 = 0;

211 ià(!
	`lua_to_c_is_bË
(
L
, "output_include")) {

212 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

214 
»t
 = -1;

216 
”rÜ
;

219 
	`lua_g‘glob®
(
L
, "output_include");

220 
cu»Ëm
 = 
	`lua_g‘tİ
(
L
);

231 
	`lua_pushn
(
L
);

232 
	`lua_Ãxt
(
L
, 
cu»Ëm
) != 0) {

235 ià(
	`lua_is¡ršg
(
L
, -1)) {

236 cÚ¡ *
s
 = 
	`lua_to¡ršg
(
L
, -1);

237 
¡©
 
¡
;

238 
fd
;

241 ià(
s
[0] != '/') {

242 
	`bufãr_cİy_bufãr
(
b
, 
p
->
ba£dœ
);

243 
	`bufãr_­³nd_¡ršg
(
b
, 
	`lua_to¡ršg
(
L
, -1));

245 
	`bufãr_cİy_¡ršg
(
b
, 
	`lua_to¡ršg
(
L
, -1));

248 
fd
 = 
	`¡©_ÿche_İ’_rdÚly_f¡©
(
¤v
, 
cÚ
, 
b
, &
¡
);

249 ià(
fd
 < 0) {

252 
”ºo
) {

253 
ENOENT
:

255 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
Œigg”_hªdËr
)) {

256 
»t
 = 1;

258 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

264 
»t
 = -1;

266 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

276 
	`chunkqueue_­³nd_fe_fd
(
cÚ
->
wr™e_queue
, 
b
, 
fd
, 0, 
¡
.
¡_size
);

277 ià(
¡
.
¡_mtime
 > 
mtime
) mtime = st.st_mtime;

281 
»t
 = -1;

282 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

287 
	`lua_pİ
(
L
, 1);

290 
	`lua_£‰İ
(
L
, 
cu»Ëm
 - 1);

292 ià(
»t
 == 0) {

293 
d©a_¡ršg
 *
ds
;

294 
timebuf
[("Sat, 23 Jul 2005 21:20:01 GMT")];

296 
cÚ
->
fe_fšished
 = 1;

298 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Last-Modified");

299 ià(0 =ğ
mtime
èmtimğ
	`time
(
NULL
);

302 ià(
NULL
 =ğ
ds
) {

304 
	`¡ráime
(
timebuf
, Ñimebuf), "%a, %d %b %Y %H:%M:%S GMT", 
	`gmtime
(&
mtime
));

306 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("La¡-Modif›d"), 
timebuf
, (timebuf) - 1);

307 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Last-Modified");

308 
	`fÜû_as£¹
(
NULL
 !ğ
ds
);

311 ià(
HANDLER_FINISHED
 =ğ
	`h‰p_»¥Ú£_hªdË_ÿchabË
(
¤v
, 
cÚ
, 
ds
->
v®ue
)) {

315 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

316 
»t
 = 0;

319 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

323 ià(
»t
 =ğ1 && !
	`bufãr_¡ršg_is_em±y
(
p
->
Œigg”_hªdËr
)) {

325 
	`bufãr_cİy_bufãr
(
cÚ
->
uri
.
·th
, 
p
->
ba£u¾
);

326 
	`bufãr_­³nd_¡ršg_bufãr
(
cÚ
->
uri
.
·th
, 
p
->
Œigg”_hªdËr
);

328 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
p
->
ba£dœ
);

329 
	`bufãr_­³nd_¡ršg_bufãr
(
cÚ
->
physiÿl
.
·th
, 
p
->
Œigg”_hªdËr
);

331 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

334 
”rÜ
:

335 
	`lua_şo£
(
L
);

337 
	`bufãr_ä“
(
b
);

339  
»t
 ;

340 
	}
}

	@mod_compress.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"»¥Ú£.h
"

7 
	~"¡©_ÿche.h
"

9 
	~"¶ugš.h
"

11 
	~"üc32.h
"

12 
	~"‘ag.h
"

14 
	~<sys/ty³s.h
>

15 
	~<sys/¡©.h
>

17 
	~<as£¹.h
>

18 
	~<fú.h
>

19 
	~<uni¡d.h
>

20 
	~<ùy³.h
>

21 
	~<¡dlib.h
>

22 
	~<¡ršg.h
>

23 
	~<¡ršgs.h
>

24 
	~<”ºo.h
>

25 
	~<time.h
>

27 #ià
defšed
 
HAVE_ZLIB_H
 && defšed 
HAVE_LIBZ


28 
	#USE_ZLIB


	)

29 
	~<zlib.h
>

32 #ià
defšed
 
HAVE_BZLIB_H
 && defšed 
HAVE_LIBBZ2


33 
	#USE_BZ2LIB


	)

35 
	#BZ_NO_STDIO


	)

36 
	~<bzlib.h
>

39 #ià
defšed
 
HAVE_SYS_MMAN_H
 && defšed 
HAVE_MMAP
 && defšed 
ENABLE_MMAP


40 
	#USE_MMAP


	)

42 
	~"sys-mm­.h
"

43 
	~<£tjmp.h
>

44 
	~<sigÇl.h
>

46 vŞ©
	gsigbus_jmp_v®id
;

47 
sigjmp_buf
 
	gsigbus_jmp
;

49 
	$sigbus_hªdËr
(
sig
) {

50 
	`UNUSED
(
sig
);

51 ià(
sigbus_jmp_v®id
è
	`siglÚgjmp
(
sigbus_jmp
, 1);

52 
	`log_çed_as£¹
(
__FILE__
, 
__LINE__
, "SIGBUS");

53 
	}
}

57 
	#HTTP_ACCEPT_ENCODING_IDENTITY
 
	`BV
(0)

	)

58 
	#HTTP_ACCEPT_ENCODING_GZIP
 
	`BV
(1)

	)

59 
	#HTTP_ACCEPT_ENCODING_DEFLATE
 
	`BV
(2)

	)

60 
	#HTTP_ACCEPT_ENCODING_COMPRESS
 
	`BV
(3)

	)

61 
	#HTTP_ACCEPT_ENCODING_BZIP2
 
	`BV
(4)

	)

62 
	#HTTP_ACCEPT_ENCODING_X_GZIP
 
	`BV
(5)

	)

63 
	#HTTP_ACCEPT_ENCODING_X_BZIP2
 
	`BV
(6)

	)

65 #ifdeà
__WIN32


66 
	#mkdœ
(
x
,
y
è
	`mkdœ
(x)

	)

70 
bufãr
 *
	mcom´ess_ÿche_dœ
;

71 
¬¿y
 *
	mcom´ess
;

72 
off_t
 
	mcom´ess_max_fesize
;

73 
	m®lowed_’codšgs
;

74 
	mmax_lßdavg
;

75 } 
	t¶ugš_cÚfig
;

78 
	mPLUGIN_DATA
;

79 
bufãr
 *
	moâ
;

80 
bufãr
 *
	mb
;

82 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

83 
¶ugš_cÚfig
 
	mcÚf
;

84 } 
	t¶ugš_d©a
;

86 
	$INIT_FUNC
(
mod_com´ess_š™
) {

87 
¶ugš_d©a
 *
p
;

89 
p
 = 
	`ÿÎoc
(1, (*p));

91 
p
->
oâ
 = 
	`bufãr_š™
();

92 
p
->
b
 = 
	`bufãr_š™
();

94  
p
;

95 
	}
}

97 
	$FREE_FUNC
(
mod_com´ess_ä“
) {

98 
¶ugš_d©a
 *
p
 = 
p_d
;

100 
	`UNUSED
(
¤v
);

102 ià(!
p
è 
HANDLER_GO_ON
;

104 
	`bufãr_ä“
(
p
->
oâ
);

105 
	`bufãr_ä“
(
p
->
b
);

107 ià(
p
->
cÚfig_¡Üage
) {

108 
size_t
 
i
;

109 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

110 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

112 ià(
NULL
 =ğ
s
) ;

114 
	`¬¿y_ä“
(
s
->
com´ess
);

115 
	`bufãr_ä“
(
s
->
com´ess_ÿche_dœ
);

117 
	`ä“
(
s
);

119 
	`ä“
(
p
->
cÚfig_¡Üage
);

123 
	`ä“
(
p
);

125  
HANDLER_GO_ON
;

126 
	}
}

129 
	$mkdœ_»cursive
(*
dœ
) {

130 *
p
 = 
dœ
;

132 ià(!
dœ
 || !dir[0])

135 (
p
 = 
	`¡rchr
Õ + 1, '/')è!ğ
NULL
) {

137 *
p
 = '\0';

138 ià((
	`mkdœ
(
dœ
, 0700è!ğ0è&& (
”ºo
 !ğ
EEXIST
)) {

139 *
p
 = '/';

143 *
p
++ = '/';

144 ià(!*
p
)  0;

147  (
	`mkdœ
(
dœ
, 0700è!ğ0è&& (
”ºo
 !ğ
EEXIST
) ? -1 : 0;

148 
	}
}

151 
	$mkdœ_fÜ_fe
(*
f’ame
) {

152 *
p
 = 
f’ame
;

154 ià(!
f’ame
 || !filename[0])

157 (
p
 = 
	`¡rchr
Õ + 1, '/')è!ğ
NULL
) {

159 *
p
 = '\0';

160 ià((
	`mkdœ
(
f’ame
, 0700è!ğ0è&& (
”ºo
 !ğ
EEXIST
)) {

161 *
p
 = '/';

165 *
p
++ = '/';

166 ià(!*
p
)  -1;

170 
	}
}

172 
	$SETDEFAULTS_FUNC
(
mod_com´ess_£tdeçuÉs
) {

173 
¶ugš_d©a
 *
p
 = 
p_d
;

174 
size_t
 
i
 = 0;

176 
cÚfig_v®ues_t
 
cv
[] = {

177 { "com´ess.ÿche-dœ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

178 { "com´ess.f‘y³", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

179 { "com´ess.max-fesize", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

180 { "com´ess.®lowed-’codšgs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

181 { "com´ess.max-lßdavg", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

182 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

185 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

187 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

188 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

189 
¶ugš_cÚfig
 *
s
;

190 
¬¿y
 *
’codšgs_¬r
 = 
	`¬¿y_š™
();

192 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

193 
s
->
com´ess_ÿche_dœ
 = 
	`bufãr_š™
();

194 
s
->
com´ess
 = 
	`¬¿y_š™
();

195 
s
->
com´ess_max_fesize
 = 0;

196 
s
->
®lowed_’codšgs
 = 0;

197 
s
->
max_lßdavg
 = 0.0;

199 
cv
[0].
de¡š©iÚ
 = 
s
->
com´ess_ÿche_dœ
;

200 
cv
[1].
de¡š©iÚ
 = 
s
->
com´ess
;

201 
cv
[2].
de¡š©iÚ
 = &(
s
->
com´ess_max_fesize
);

202 
cv
[3].
de¡š©iÚ
 = 
’codšgs_¬r
;

203 
cv
[4].
de¡š©iÚ
 = 
¤v
->
tmp_buf
;

204 
	`bufãr_¡ršg_£t_Ëngth
(
¤v
->
tmp_buf
, 0);

206 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

208 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

209  
HANDLER_ERROR
;

212 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
tmp_buf
)) {

213 
s
->
max_lßdavg
 = 
	`¡¹od
(
¤v
->
tmp_buf
->
±r
, 
NULL
);

216 ià(
’codšgs_¬r
->
u£d
) {

217 
size_t
 
j
 = 0;

218 
j
 = 0; j < 
’codšgs_¬r
->
u£d
; j++) {

219 #ià
	`defšed
(
USE_ZLIB
è|| defšed(
USE_BZ2LIB
)

220 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
’codšgs_¬r
->
d©a
[
j
];

222 #ifdeà
USE_ZLIB


223 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "gzip"))

224 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_GZIP
 | 
HTTP_ACCEPT_ENCODING_X_GZIP
;

225 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "x-gzip"))

226 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_X_GZIP
;

227 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "deflate"))

228 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_DEFLATE
;

234 #ifdeà
USE_BZ2LIB


235 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "bzip2"))

236 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_BZIP2
 | 
HTTP_ACCEPT_ENCODING_X_BZIP2
;

237 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "x-bzip2"))

238 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_X_BZIP2
;

243 
s
->
®lowed_’codšgs
 = 0

244 #ifdeà
USE_ZLIB


245 | 
HTTP_ACCEPT_ENCODING_GZIP
 | 
HTTP_ACCEPT_ENCODING_X_GZIP
 | 
HTTP_ACCEPT_ENCODING_DEFLATE


247 #ifdeà
USE_BZ2LIB


248 | 
HTTP_ACCEPT_ENCODING_BZIP2
 | 
HTTP_ACCEPT_ENCODING_X_BZIP2


253 
	`¬¿y_ä“
(
’codšgs_¬r
);

255 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
com´ess_ÿche_dœ
)) {

256 
¡©
 
¡
;

257 
	`mkdœ_»cursive
(
s
->
com´ess_ÿche_dœ
->
±r
);

259 ià(0 !ğ
	`¡©
(
s
->
com´ess_ÿche_dœ
->
±r
, &
¡
)) {

260 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "can't stat compress.cache-dir",

261 
s
->
com´ess_ÿche_dœ
, 
	`¡»¼Ü
(
”ºo
));

263  
HANDLER_ERROR
;

268  
HANDLER_GO_ON
;

270 
	}
}

272 #ifdeà
USE_ZLIB


273 
	$deæ©e_fe_to_bufãr_gz
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, *
¡¬t
, 
off_t
 
¡_size
, 
time_t
 
mtime
) {

274 *
c
;

275 
üc
;

276 
z_¡»am
 
z
;

277 
size_t
 
ou’
;

279 
	`UNUSED
(
¤v
);

280 
	`UNUSED
(
cÚ
);

282 
z
.
z®loc
 = 
Z_NULL
;

283 
z
.
zä“
 = 
Z_NULL
;

284 
z
.
İaque
 = 
Z_NULL
;

286 ià(
Z_OK
 !ğ
	`deæ©eIn™2
(&
z
,

287 
Z_DEFAULT_COMPRESSION
,

288 
Z_DEFLATED
,

289 -
MAX_WBITS
,

291 
Z_DEFAULT_STRATEGY
)) {

295 
z
.
Ãxt_š
 = (*)
¡¬t
;

296 
z
.
ava_š
 = 
¡_size
;

297 
z
.
tÙ®_š
 = 0;

300 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
b
, (
z
.
ava_š
 * 1.1) + 12 + 18);

304 
c
 = (*)
p
->
b
->
±r
;

305 
c
[0] = 0x1f;

306 
c
[1] = 0x8b;

307 
c
[2] = 
Z_DEFLATED
;

308 
c
[3] = 0;

309 
c
[4] = (
mtime
 >> 0) & 0xff;

310 
c
[5] = (
mtime
 >> 8) & 0xff;

311 
c
[6] = (
mtime
 >> 16) & 0xff;

312 
c
[7] = (
mtime
 >> 24) & 0xff;

313 
c
[8] = 0x00;

314 
c
[9] = 0x03;

316 
ou’
 = 10;

317 
z
.
Ãxt_out
 = (*)
p
->
b
->
±r
 + 
ou’
;

318 
z
.
ava_out
 = 
p
->
b
->
size
 - 
ou’
 - 9;

319 
z
.
tÙ®_out
 = 0;

321 ià(
Z_STREAM_END
 !ğ
	`deæ©e
(&
z
, 
Z_FINISH
)) {

322 
	`deæ©eEnd
(&
z
);

327 
ou’
 +ğ
z
.
tÙ®_out
;

329 
üc
 = 
	`g’”©e_üc32c
(
¡¬t
, 
¡_size
);

331 
c
 = (*)
p
->
b
->
±r
 + 
ou’
;

333 
c
[0] = (
üc
 >> 0) & 0xff;

334 
c
[1] = (
üc
 >> 8) & 0xff;

335 
c
[2] = (
üc
 >> 16) & 0xff;

336 
c
[3] = (
üc
 >> 24) & 0xff;

337 
c
[4] = (
z
.
tÙ®_š
 >> 0) & 0xff;

338 
c
[5] = (
z
.
tÙ®_š
 >> 8) & 0xff;

339 
c
[6] = (
z
.
tÙ®_š
 >> 16) & 0xff;

340 
c
[7] = (
z
.
tÙ®_š
 >> 24) & 0xff;

341 
ou’
 += 8;

342 
	`bufãr_comm™
(
p
->
b
, 
ou’
);

344 ià(
Z_OK
 !ğ
	`deæ©eEnd
(&
z
)) {

349 
	}
}

351 
	$deæ©e_fe_to_bufãr_deæ©e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, *
¡¬t
, 
off_t
 
¡_size
) {

352 
z_¡»am
 
z
;

354 
	`UNUSED
(
¤v
);

355 
	`UNUSED
(
cÚ
);

357 
z
.
z®loc
 = 
Z_NULL
;

358 
z
.
zä“
 = 
Z_NULL
;

359 
z
.
İaque
 = 
Z_NULL
;

361 ià(
Z_OK
 !ğ
	`deæ©eIn™2
(&
z
,

362 
Z_DEFAULT_COMPRESSION
,

363 
Z_DEFLATED
,

364 -
MAX_WBITS
,

366 
Z_DEFAULT_STRATEGY
)) {

370 
z
.
Ãxt_š
 = 
¡¬t
;

371 
z
.
ava_š
 = 
¡_size
;

372 
z
.
tÙ®_š
 = 0;

374 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
b
, (
z
.
ava_š
 * 1.1) + 12);

376 
z
.
Ãxt_out
 = (*)
p
->
b
->
±r
;

377 
z
.
ava_out
 = 
p
->
b
->
size
 - 1;

378 
z
.
tÙ®_out
 = 0;

380 ià(
Z_STREAM_END
 !ğ
	`deæ©e
(&
z
, 
Z_FINISH
)) {

381 
	`deæ©eEnd
(&
z
);

385 ià(
Z_OK
 !ğ
	`deæ©eEnd
(&
z
)) {

390 
	`bufãr_comm™
(
p
->
b
, 
z
.
tÙ®_out
);

393 
	}
}

397 #ifdeà
USE_BZ2LIB


398 
	$deæ©e_fe_to_bufãr_bz2
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, *
¡¬t
, 
off_t
 
¡_size
) {

399 
bz_¡»am
 
bz
;

401 
	`UNUSED
(
¤v
);

402 
	`UNUSED
(
cÚ
);

404 
bz
.
bz®loc
 = 
NULL
;

405 
bz
.
bzä“
 = 
NULL
;

406 
bz
.
İaque
 = 
NULL
;

408 ià(
BZ_OK
 !ğ
	`BZ2_bzCom´essIn™
(&
bz
,

415 
bz
.
Ãxt_š
 = (*)
¡¬t
;

416 
bz
.
ava_š
 = 
¡_size
;

417 
bz
.
tÙ®_š_lo32
 = 0;

418 
bz
.
tÙ®_š_hi32
 = 0;

420 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
b
, (
bz
.
ava_š
 * 1.1) + 12);

422 
bz
.
Ãxt_out
 = 
p
->
b
->
±r
;

423 
bz
.
ava_out
 = 
p
->
b
->
size
 - 1;

424 
bz
.
tÙ®_out_lo32
 = 0;

425 
bz
.
tÙ®_out_hi32
 = 0;

427 ià(
BZ_STREAM_END
 !ğ
	`BZ2_bzCom´ess
(&
bz
, 
BZ_FINISH
)) {

428 
	`BZ2_bzCom´essEnd
(&
bz
);

432 ià(
BZ_OK
 !ğ
	`BZ2_bzCom´essEnd
(&
bz
)) {

437 ià(
bz
.
tÙ®_out_hi32
)  -1;

440 
	`bufãr_comm™
(
p
->
b
, 
bz
.
tÙ®_out_lo32
);

443 
	}
}

446 
	$mod_com´ess_nÙe_¿tio
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
off_t
 
š
, off_ˆ
out
) {

451 
¿tio
[
LI_ITOSTRING_LENGTH
];

452 ià(0 =ğ
š
) ;

453 
	`li_™o¡º
(
¿tio
, Ô©io), 
out
 * 100 / 
š
);

454 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

455 
	`CONST_STR_LEN
("ratio"),

456 
¿tio
, 
	`¡¾’
(ratio));

457 
	`UNUSED
(
¤v
);

458 
	}
}

460 
	$deæ©e_fe_to_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
â
, 
¡©_ÿche_’Œy
 *
sû
, 
ty³
) {

461 
ifd
, 
ofd
;

462 
»t
;

463 #ifdeà
USE_MMAP


464 vŞ©
m­³d
 = 0;

466 *
¡¬t
;

467 cÚ¡ *
f’ame
 = 
â
->
±r
;

468 
¡©_ÿche_’Œy
 *
sû_oâ
;

469 
ssize_t
 
r
;

472 ià((
off_t
)(
sû
->
¡
.
¡_size
 * 1.1) < sce->st.st_size)  -1;

479 ià(
sû
->
¡
.
¡_size
 > 128 * 1024 * 1024)  -1;

481 
	`bufãr_»£t
(
p
->
oâ
);

482 
	`bufãr_cİy_bufãr
(
p
->
oâ
,…->
cÚf
.
com´ess_ÿche_dœ
);

483 
	`bufãr_­³nd_¦ash
(
p
->
oâ
);

485 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
physiÿl
.
·th
->
±r
, cÚ->physiÿl.
doc_roÙ
->±r, 
	`bufãr_¡ršg_Ëngth
(con->physical.doc_root))) {

486 
	`bufãr_­³nd_¡ršg
(
p
->
oâ
, 
cÚ
->
physiÿl
.
·th
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(cÚ->physiÿl.
doc_roÙ
));

488 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
oâ
, 
cÚ
->
uri
.
·th
);

491 
ty³
) {

492 
HTTP_ACCEPT_ENCODING_GZIP
:

493 
HTTP_ACCEPT_ENCODING_X_GZIP
:

494 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
oâ
, 
	`CONST_STR_LEN
("-gzip-"));

496 
HTTP_ACCEPT_ENCODING_DEFLATE
:

497 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
oâ
, 
	`CONST_STR_LEN
("-deflate-"));

499 
HTTP_ACCEPT_ENCODING_BZIP2
:

500 
HTTP_ACCEPT_ENCODING_X_BZIP2
:

501 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
oâ
, 
	`CONST_STR_LEN
("-bzip2-"));

504 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "unknowÀcom´essiÚy³", 
ty³
);

508 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
oâ
, 
sû
->
‘ag
);

510 ià(
HANDLER_ERROR
 !ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
p
->
oâ
, &
sû_oâ
)) {

511 ià(0 =ğ
sû
->
¡
.
¡_size
)  -1;

514 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "bs", 
p
->
oâ
, "compress-cache hit");

516 
	`mod_com´ess_nÙe_¿tio
(
¤v
, 
cÚ
, 
sû
->
¡
.
¡_size
, 
sû_oâ
->st.st_size);

517 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
p
->
oâ
);

521 ià(0.0 < 
p
->
cÚf
.
max_lßdavg
 &&…->cÚf.max_lßdavg < 
¤v
->
¤vcÚf
.
lßdavg
[0]) {

525 ià(-1 =ğ
	`mkdœ_fÜ_fe
(
p
->
oâ
->
±r
)) {

526 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "couldn'ˆü—‹ dœeùÜy fÜ fe", 
p
->
oâ
);

530 ià(-1 =ğ(
ofd
 = 
	`İ’
(
p
->
oâ
->
±r
, 
O_WRONLY
 | 
O_CREAT
 | 
O_EXCL
 | 
O_BINARY
, 0600))) {

531 ià(
”ºo
 =ğ
EEXIST
) {

535 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "ü—tšg cachefe", 
p
->
oâ
, "çed", 
	`¡»¼Ü
(
”ºo
));

540 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "bs", 
p
->
oâ
, "compress-cache miss");

542 ià(-1 =ğ(
ifd
 = 
	`İ’
(
f’ame
, 
O_RDONLY
 | 
O_BINARY
))) {

543 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "İ’šg…Ïš-fe", 
â
, "çed", 
	`¡»¼Ü
(
”ºo
));

545 
	`şo£
(
ofd
);

548 ià(-1 =ğ
	`uÆšk
(
p
->
oâ
->
±r
)) {

549 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "uÆškšg incom¶‘ÿchefe", 
p
->
oâ
, "çed:", 
	`¡»¼Ü
(
”ºo
));

555 #ifdeà
USE_MMAP


556 ià(
MAP_FAILED
 !ğ(
¡¬t
 = 
	`mm­
(
NULL
, 
sû
->
¡
.
¡_size
, 
PROT_READ
, 
MAP_SHARED
, 
ifd
, 0))) {

557 
m­³d
 = 1;

558 
	`sigÇl
(
SIGBUS
, 
sigbus_hªdËr
);

559 
sigbus_jmp_v®id
 = 1;

560 ià(0 !ğ
	`sig£tjmp
(
sigbus_jmp
, 1)) {

561 
sigbus_jmp_v®id
 = 0;

563 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd", "SIGBUS in mmap:",

564 
â
, 
ifd
);

566 
	`munm­
(
¡¬t
, 
sû
->
¡
.
¡_size
);

567 
	`şo£
(
ofd
);

568 
	`şo£
(
ifd
);

571 ià(-1 =ğ
	`uÆšk
(
p
->
oâ
->
±r
)) {

572 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "uÆškšg incom¶‘ÿchefe", 
p
->
oâ
, "çed:", 
	`¡»¼Ü
(
”ºo
));

579 ià(
NULL
 =ğ(
¡¬t
 = 
	`m®loc
(
sû
->
¡
.
¡_size
)è|| sû->¡.¡_siz!ğ
	`»ad
(
ifd
, start, sce->st.st_size)) {

580 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "»adšg", 
â
, "çed", 
	`¡»¼Ü
(
”ºo
));

582 
	`şo£
(
ofd
);

583 
	`şo£
(
ifd
);

584 
	`ä“
(
¡¬t
);

587 ià(-1 =ğ
	`uÆšk
(
p
->
oâ
->
±r
)) {

588 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "uÆškšg incom¶‘ÿchefe", 
p
->
oâ
, "çed:", 
	`¡»¼Ü
(
”ºo
));

594 
»t
 = -1;

595 
ty³
) {

596 #ifdeà
USE_ZLIB


597 
HTTP_ACCEPT_ENCODING_GZIP
:

598 
HTTP_ACCEPT_ENCODING_X_GZIP
:

599 
»t
 = 
	`deæ©e_fe_to_bufãr_gz
(
¤v
, 
cÚ
, 
p
, 
¡¬t
, 
sû
->
¡
.
¡_size
, sû->¡.
¡_mtime
);

601 
HTTP_ACCEPT_ENCODING_DEFLATE
:

602 
»t
 = 
	`deæ©e_fe_to_bufãr_deæ©e
(
¤v
, 
cÚ
, 
p
, 
¡¬t
, 
sû
->
¡
.
¡_size
);

605 #ifdeà
USE_BZ2LIB


606 
HTTP_ACCEPT_ENCODING_BZIP2
:

607 
HTTP_ACCEPT_ENCODING_X_BZIP2
:

608 
»t
 = 
	`deæ©e_fe_to_bufãr_bz2
(
¤v
, 
cÚ
, 
p
, 
¡¬t
, 
sû
->
¡
.
¡_size
);

613 ià(
»t
 == 0) {

614 
r
 = 
	`wr™e
(
ofd
, 
	`CONST_BUF_LEN
(
p
->
b
));

615 ià(-1 =ğ
r
) {

616 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "wr™šg cachefe", 
p
->
oâ
, "çed:", 
	`¡»¼Ü
(
”ºo
));

617 
»t
 = -1;

618 } ià((
size_t
)
r
 !ğ
	`bufãr_¡ršg_Ëngth
(
p
->
b
)) {

619 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "wr™šg cachefe", 
p
->
oâ
, "failed:‚otƒnough bytes written");

620 
»t
 = -1;

624 #ifdeà
USE_MMAP


625 ià(
m­³d
) {

626 
sigbus_jmp_v®id
 = 0;

627 
	`munm­
(
¡¬t
, 
sû
->
¡
.
¡_size
);

630 
	`ä“
(
¡¬t
);

632 
	`şo£
(
ifd
);

634 ià(0 !ğ
	`şo£
(
ofd
è|| 
»t
 != 0) {

635 ià(0 =ğ
»t
) {

636 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "wr™šg cachefe", 
p
->
oâ
, "çed:", 
	`¡»¼Ü
(
”ºo
));

640 ià(-1 =ğ
	`uÆšk
(
p
->
oâ
->
±r
)) {

641 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "uÆškšg incom¶‘ÿchefe", 
p
->
oâ
, "çed:", 
	`¡»¼Ü
(
”ºo
));

647 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
p
->
oâ
);

648 
	`mod_com´ess_nÙe_¿tio
(
¤v
, 
cÚ
, 
sû
->
¡
.
¡_size
,

649 (
off_t
)
	`bufãr_¡ršg_Ëngth
(
p
->
b
));

652 
	}
}

654 
	$deæ©e_fe_to_bufãr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
â
, 
¡©_ÿche_’Œy
 *
sû
, 
ty³
) {

655 
ifd
;

656 
»t
 = -1;

657 #ifdeà
USE_MMAP


658 vŞ©
m­³d
 = 0;

660 *
¡¬t
;

663 ià((
off_t
)(
sû
->
¡
.
¡_size
 * 1.1) < sce->st.st_size)  -1;

670 ià(
sû
->
¡
.
¡_size
 > 128 * 1024 * 1024)  -1;

672 ià(0.0 < 
p
->
cÚf
.
max_lßdavg
 &&…->cÚf.max_lßdavg < 
¤v
->
¤vcÚf
.
lßdavg
[0]) {

676 ià(-1 =ğ(
ifd
 = 
	`İ’
(
â
->
±r
, 
O_RDONLY
 | 
O_BINARY
))) {

677 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "İ’šg…Ïš-fe", 
â
, "çed", 
	`¡»¼Ü
(
”ºo
));

682 #ifdeà
USE_MMAP


683 ià(
MAP_FAILED
 !ğ(
¡¬t
 = 
	`mm­
(
NULL
, 
sû
->
¡
.
¡_size
, 
PROT_READ
, 
MAP_SHARED
, 
ifd
, 0))) {

684 
m­³d
 = 1;

685 
	`sigÇl
(
SIGBUS
, 
sigbus_hªdËr
);

686 
sigbus_jmp_v®id
 = 1;

687 ià(0 !ğ
	`sig£tjmp
(
sigbus_jmp
, 1)) {

688 
sigbus_jmp_v®id
 = 0;

690 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd", "SIGBUS in mmap:",

691 
â
, 
ifd
);

693 
	`munm­
(
¡¬t
, 
sû
->
¡
.
¡_size
);

694 
	`şo£
(
ifd
);

699 ià(
NULL
 =ğ(
¡¬t
 = 
	`m®loc
(
sû
->
¡
.
¡_size
)è|| sû->¡.¡_siz!ğ
	`»ad
(
ifd
, start, sce->st.st_size)) {

700 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "»adšg", 
â
, "çed", 
	`¡»¼Ü
(
”ºo
));

702 
	`şo£
(
ifd
);

703 
	`ä“
(
¡¬t
);

707 
ty³
) {

708 #ifdeà
USE_ZLIB


709 
HTTP_ACCEPT_ENCODING_GZIP
:

710 
HTTP_ACCEPT_ENCODING_X_GZIP
:

711 
»t
 = 
	`deæ©e_fe_to_bufãr_gz
(
¤v
, 
cÚ
, 
p
, 
¡¬t
, 
sû
->
¡
.
¡_size
, sû->¡.
¡_mtime
);

713 
HTTP_ACCEPT_ENCODING_DEFLATE
:

714 
»t
 = 
	`deæ©e_fe_to_bufãr_deæ©e
(
¤v
, 
cÚ
, 
p
, 
¡¬t
, 
sû
->
¡
.
¡_size
);

717 #ifdeà
USE_BZ2LIB


718 
HTTP_ACCEPT_ENCODING_BZIP2
:

719 
HTTP_ACCEPT_ENCODING_X_BZIP2
:

720 
»t
 = 
	`deæ©e_fe_to_bufãr_bz2
(
¤v
, 
cÚ
, 
p
, 
¡¬t
, 
sû
->
¡
.
¡_size
);

724 
»t
 = -1;

728 #ifdeà
USE_MMAP


729 ià(
m­³d
) {

730 
sigbus_jmp_v®id
 = 0;

731 
	`munm­
(
¡¬t
, 
sû
->
¡
.
¡_size
);

734 
	`ä“
(
¡¬t
);

736 
	`şo£
(
ifd
);

738 ià(
»t
 != 0)  -1;

740 
	`mod_com´ess_nÙe_¿tio
(
¤v
, 
cÚ
, 
sû
->
¡
.
¡_size
,

741 (
off_t
)
	`bufãr_¡ršg_Ëngth
(
p
->
b
));

742 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

743 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
p
->
b
);

745 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

747 
cÚ
->
fe_fšished
 = 1;

748 
cÚ
->
fe_¡¬‹d
 = 1;

751 
	}
}

754 
	#PATCH
(
x
) \

755 
p
->
cÚf
.
x
 = 
s
->x;

	)

756 
	$mod_com´ess_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

757 
size_t
 
i
, 
j
;

758 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

760 
	`PATCH
(
com´ess_ÿche_dœ
);

761 
	`PATCH
(
com´ess
);

762 
	`PATCH
(
com´ess_max_fesize
);

763 
	`PATCH
(
®lowed_’codšgs
);

764 
	`PATCH
(
max_lßdavg
);

767 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

768 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

769 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

772 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

775 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

776 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

778 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("compress.cache-dir"))) {

779 
	`PATCH
(
com´ess_ÿche_dœ
);

780 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("compress.filetype"))) {

781 
	`PATCH
(
com´ess
);

782 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("compress.max-filesize"))) {

783 
	`PATCH
(
com´ess_max_fesize
);

784 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("compress.allowed-encodings"))) {

785 
	`PATCH
(
®lowed_’codšgs
);

786 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("compress.max-loadavg"))) {

787 
	`PATCH
(
max_lßdavg
);

793 
	}
}

794 #undeà
PATCH


796 
	$mod_com´ess_cÚšs_’codšg
(cÚ¡ *
h—d”v®ue
, cÚ¡ *
’codšg
, 
size_t
 
Ën
) {

797 cÚ¡ *
m
 = 
h—d”v®ue
;

799 *
m
 == ',' || *m == ' ' || *m == '\t') {

800 ++
m
;

802 ià(0 =ğ
	`¡ºÿ£cmp
(
m
, 
’codšg
, 
Ën
)) {

804 
m
 +ğ
Ën
;

805 ià(*
m
 == '\0' || *m == ',' || *m == ';' || *m == ' ' || *m == '\t')

807 } ià(*
m
 != '\0') {

808 ++
m
;

810 } (
m
 = 
	`¡rchr
(m, ',')));

812 
	}
}

814 
	$PHYSICALPATH_FUNC
(
mod_com´ess_physiÿl
) {

815 
¶ugš_d©a
 *
p
 = 
p_d
;

816 
size_t
 
m
;

817 
off_t
 
max_fsize
;

818 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

819 
bufãr
 *
mtime
 = 
NULL
;

820 
bufãr
 *
cÚ‹Á_ty³
;

822 ià(
cÚ
->
mode
 !ğ
DIRECT
 || cÚ->
h‰p_¡©us
è 
HANDLER_GO_ON
;

825 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 !ğ
HTTP_METHOD_GET
 &&

826 
cÚ
->
»que¡
.
h‰p_m‘hod
 !ğ
HTTP_METHOD_POST
) {

827  
HANDLER_GO_ON
;

830 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
physiÿl
.
·th
)) {

831  
HANDLER_GO_ON
;

834 
	`mod_com´ess_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

836 
max_fsize
 = 
p
->
cÚf
.
com´ess_max_fesize
;

838 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

839 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- handling file‡s static file");

842 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

843 
cÚ
->
h‰p_¡©us
 = 403;

845 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsb",

846 "nÙ‡„eguÏ¸fe:", 
cÚ
->
uri
.
·th
,

847 "->", 
cÚ
->
physiÿl
.
·th
);

849  
HANDLER_FINISHED
;

853 #ifdeà
HAVE_LSTAT


854 ià((
sû
->
is_symlšk
 =ğ1è&& !
cÚ
->
cÚf
.
fŞlow_symlšk
) {

855  
HANDLER_GO_ON
;

858 ià(!
	`S_ISREG
(
sû
->
¡
.
¡_mode
)) {

859  
HANDLER_GO_ON
;

863 ià(
max_fsize
 && (
sû
->
¡
.
¡_size
 >> 10è> max_fsizeè 
HANDLER_GO_ON
;

870 ià(
sû
->
¡
.
¡_size
 < 128è 
HANDLER_GO_ON
;

873 
cÚ‹Á_ty³
 = 
NULL
;

874 ià(
sû
->
cÚ‹Á_ty³
->
±r
) {

875 *
c
;

876 iàĞ(
c
 = 
	`¡rchr
(
sû
->
cÚ‹Á_ty³
->
±r
, ';')è!ğ
NULL
) {

877 
cÚ‹Á_ty³
 = 
¤v
->
tmp_buf
;

878 
	`bufãr_cİy_¡ršg_Ën
(
cÚ‹Á_ty³
, 
sû
->cÚ‹Á_ty³->
±r
, 
c
 - sce->content_type->ptr);

882 
m
 = 0; m < 
p
->
cÚf
.
com´ess
->
u£d
; m++) {

883 
d©a_¡ršg
 *
com´ess_ds
 = (d©a_¡ršg *)
p
->
cÚf
.
com´ess
->
d©a
[
m
];

885 ià(!
com´ess_ds
) {

886 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbb", "ev", 
cÚ
->
physiÿl
.
·th
, cÚ->
uri
.path);

888  
HANDLER_GO_ON
;

891 ià(
	`bufãr_is_equ®
(
com´ess_ds
->
v®ue
, 
sû
->
cÚ‹Á_ty³
)

892 || (
cÚ‹Á_ty³
 && 
	`bufãr_is_equ®
(
com´ess_ds
->
v®ue
, content_type))) {

894 
d©a_¡ršg
 *
ds
;

897 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Vary"), CONST_STR_LEN("Accept-Encoding"));

899 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Accept-Encoding"))) {

900 
acû±_’codšg
 = 0;

901 *
v®ue
 = 
ds
->v®ue->
±r
;

902 
m©ched_’codšgs
 = 0;

903 
u£_‘ag
 = 
sû
->
‘ag
 !ğ
NULL
 && sû->‘ag->
±r
 != NULL;

906 #ifdeà
USE_ZLIB


907 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("gz"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_GZIP
;

908 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("x-gz"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_X_GZIP
;

909 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("deæ©e"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_DEFLATE
;

910 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("com´ess"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_COMPRESS
;

912 #ifdeà
USE_BZ2LIB


913 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("bz2"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_BZIP2
;

914 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("x-bz2"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_X_BZIP2
;

916 ià(
	`mod_com´ess_cÚšs_’codšg
(
v®ue
, 
	`CONST_STR_LEN
("id’t™y"))è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_IDENTITY
;

919 
m©ched_’codšgs
 = 
acû±_’codšg
 & 
p
->
cÚf
.
®lowed_’codšgs
;

921 ià(
m©ched_’codšgs
) {

922 cÚ¡ 
dæt_gz
[] = "gzip";

923 cÚ¡ 
dæt_x_gz
[] = "x-gzip";

924 cÚ¡ 
dæt_deæ©e
[] = "deflate";

925 cÚ¡ 
dæt_bz2
[] = "bzip2";

926 cÚ¡ 
dæt_x_bz2
[] = "x-bzip2";

928 cÚ¡ *
com´essiÚ_Çme
 = 
NULL
;

929 
com´essiÚ_ty³
 = 0;

931 
mtime
 = 
	`¡ráime_ÿche_g‘
(
¤v
, 
sû
->
¡
.
¡_mtime
);

934 ià(
u£_‘ag
) {

935 
	`‘ag_mu‹
(
cÚ
->
physiÿl
.
‘ag
, 
sû
->etag);

936 ià(
HANDLER_FINISHED
 =ğ
	`h‰p_»¥Ú£_hªdË_ÿchabË
(
¤v
, 
cÚ
, 
mtime
)) {

937 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
sû
->
cÚ‹Á_ty³
));

938 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("La¡-Modif›d"), 
	`CONST_BUF_LEN
(
mtime
));

939 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("ETag"), 
	`CONST_BUF_LEN
(cÚ->
physiÿl
.
‘ag
));

940  
HANDLER_FINISHED
;

945 ià(
m©ched_’codšgs
 & 
HTTP_ACCEPT_ENCODING_BZIP2
) {

946 
com´essiÚ_ty³
 = 
HTTP_ACCEPT_ENCODING_BZIP2
;

947 
com´essiÚ_Çme
 = 
dæt_bz2
;

948 } ià(
m©ched_’codšgs
 & 
HTTP_ACCEPT_ENCODING_X_BZIP2
) {

949 
com´essiÚ_ty³
 = 
HTTP_ACCEPT_ENCODING_X_BZIP2
;

950 
com´essiÚ_Çme
 = 
dæt_x_bz2
;

951 } ià(
m©ched_’codšgs
 & 
HTTP_ACCEPT_ENCODING_GZIP
) {

952 
com´essiÚ_ty³
 = 
HTTP_ACCEPT_ENCODING_GZIP
;

953 
com´essiÚ_Çme
 = 
dæt_gz
;

954 } ià(
m©ched_’codšgs
 & 
HTTP_ACCEPT_ENCODING_X_GZIP
) {

955 
com´essiÚ_ty³
 = 
HTTP_ACCEPT_ENCODING_X_GZIP
;

956 
com´essiÚ_Çme
 = 
dæt_x_gz
;

958 
	`fÜû_as£¹
(
m©ched_’codšgs
 & 
HTTP_ACCEPT_ENCODING_DEFLATE
);

959 
com´essiÚ_ty³
 = 
HTTP_ACCEPT_ENCODING_DEFLATE
;

960 
com´essiÚ_Çme
 = 
dæt_deæ©e
;

963 ià(
u£_‘ag
) {

965 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
sû
->
‘ag
);

966 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("-"));

967 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
com´essiÚ_Çme
);

968 
	`‘ag_mu‹
(
cÚ
->
physiÿl
.
‘ag
, 
¤v
->
tmp_buf
);

971 ià(
HANDLER_FINISHED
 =ğ
	`h‰p_»¥Ú£_hªdË_ÿchabË
(
¤v
, 
cÚ
, 
mtime
)) {

972 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Encodšg"), 
com´essiÚ_Çme
, 
	`¡¾’
(compression_name));

973 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
sû
->
cÚ‹Á_ty³
));

974 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("La¡-Modif›d"), 
	`CONST_BUF_LEN
(
mtime
));

975 ià(
u£_‘ag
) {

976 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("ETag"), 
	`CONST_BUF_LEN
(cÚ->
physiÿl
.
‘ag
));

978  
HANDLER_FINISHED
;

982 ià(
u£_‘ag
 && !
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
com´ess_ÿche_dœ
)) {

983 ià(0 !ğ
	`deæ©e_fe_to_fe
(
¤v
, 
cÚ
, 
p
, cÚ->
physiÿl
.
·th
, 
sû
, 
com´essiÚ_ty³
))

984  
HANDLER_GO_ON
;

986 ià(0 !ğ
	`deæ©e_fe_to_bufãr
(
¤v
, 
cÚ
, 
p
, cÚ->
physiÿl
.
·th
, 
sû
, 
com´essiÚ_ty³
))

987  
HANDLER_GO_ON
;

989 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Encodšg"), 
com´essiÚ_Çme
, 
	`¡¾’
(compression_name));

990 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("La¡-Modif›d"), 
	`CONST_BUF_LEN
(
mtime
));

991 ià(
u£_‘ag
) {

992 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("ETag"), 
	`CONST_BUF_LEN
(cÚ->
physiÿl
.
‘ag
));

994 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
sû
->
cÚ‹Á_ty³
));

996  (
u£_‘ag
 && !
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
com´ess_ÿche_dœ
)è? 
HANDLER_GO_ON
 : 
HANDLER_FINISHED
;

1002  
HANDLER_GO_ON
;

1003 
	}
}

1005 
mod_com´ess_¶ugš_š™
(
¶ugš
 *
p
);

1006 
	$mod_com´ess_¶ugš_š™
(
¶ugš
 *
p
) {

1007 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1008 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("compress");

1010 
p
->
š™
 = 
mod_com´ess_š™
;

1011 
p
->
£t_deçuÉs
 = 
mod_com´ess_£tdeçuÉs
;

1012 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_com´ess_physiÿl
;

1013 
p
->
ş—nup
 = 
mod_com´ess_ä“
;

1015 
p
->
d©a
 = 
NULL
;

1018 
	}
}

	@mod_deflate.c

99 
	~"fœ¡.h
"

101 
	~<sys/ty³s.h
>

102 
	~<sys/¡©.h
>

103 
	~"sys-mm­.h
"

105 
	~<fú.h
>

106 
	~<¡dlib.h
>

107 
	~<¡ršg.h
>

108 
	~<”ºo.h
>

109 
	~<time.h
>

111 
	~"ba£.h
"

112 
	~"log.h
"

113 
	~"bufãr.h
"

114 
	~"‘ag.h
"

115 
	~"h‰p_chunk.h
"

116 
	~"»¥Ú£.h
"

118 
	~"¶ugš.h
"

120 #ià
defšed
 
HAVE_ZLIB_H
 && defšed 
HAVE_LIBZ


121 
	#USE_ZLIB


	)

122 
	~<zlib.h
>

124 #iâdeà
Z_DEFAULT_COMPRESSION


125 
	#Z_DEFAULT_COMPRESSION
 -1

	)

127 #iâdeà
MAX_WBITS


128 
	#MAX_WBITS
 15

	)

131 #ià
defšed
 
HAVE_BZLIB_H
 && defšed 
HAVE_LIBBZ2


132 
	#USE_BZ2LIB


	)

134 
	#BZ_NO_STDIO


	)

135 
	~<bzlib.h
>

138 #ià
defšed
 
HAVE_SYS_MMAN_H
 && defšed 
HAVE_MMAP
 && defšed 
ENABLE_MMAP


139 
	#USE_MMAP


	)

141 
	~"sys-mm­.h
"

142 
	~<£tjmp.h
>

143 
	~<sigÇl.h
>

145 vŞ©
	gsigbus_jmp_v®id
;

146 
sigjmp_buf
 
	gsigbus_jmp
;

148 
	$sigbus_hªdËr
(
sig
) {

149 
	`UNUSED
(
sig
);

150 ià(
sigbus_jmp_v®id
è
	`siglÚgjmp
(
sigbus_jmp
, 1);

151 
	`log_çed_as£¹
(
__FILE__
, 
__LINE__
, "SIGBUS");

152 
	}
}

156 
	#HTTP_ACCEPT_ENCODING_IDENTITY
 
	`BV
(0)

	)

157 
	#HTTP_ACCEPT_ENCODING_GZIP
 
	`BV
(1)

	)

158 
	#HTTP_ACCEPT_ENCODING_DEFLATE
 
	`BV
(2)

	)

159 
	#HTTP_ACCEPT_ENCODING_COMPRESS
 
	`BV
(3)

	)

160 
	#HTTP_ACCEPT_ENCODING_BZIP2
 
	`BV
(4)

	)

161 
	#HTTP_ACCEPT_ENCODING_X_GZIP
 
	`BV
(5)

	)

162 
	#HTTP_ACCEPT_ENCODING_X_BZIP2
 
	`BV
(6)

	)

164 
	#KBy‹
 * 1024

	)

165 
	#MBy‹
 * 1024 
KBy‹


	)

166 
	#GBy‹
 * 1024 
MBy‹


	)

169 
¬¿y
 *
	mmim‘y³s
;

170 
	m®lowed_’codšgs
;

171 
	mmax_com´ess_size
;

172 
	mmš_com´ess_size
;

173 
	mouut_bufãr_size
;

174 
	mwÜk_block_size
;

175 
	msync_æush
;

176 
	mcom´essiÚ_Ëv–
;

177 
	mmax_lßdavg
;

178 } 
	t¶ugš_cÚfig
;

181 
	mPLUGIN_DATA
;

182 
bufãr
 *
	mtmp_buf
;

183 
¬¿y
 *
	m’codšgs
;

185 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

186 
¶ugš_cÚfig
 
	mcÚf
;

187 } 
	t¶ugš_d©a
;

191 #ifdeà
USE_ZLIB


192 
z_¡»am
 
	mz
;

194 #ifdeà
USE_BZ2LIB


195 
bz_¡»am
 
	mbz
;

197 
	mdummy
;

198 } 
	mu
;

199 
off_t
 
	mby‹s_š
;

200 
off_t
 
	mby‹s_out
;

201 
chunkqueue
 *
	mš_queue
;

202 
bufãr
 *
	mouut
;

203 
¶ugš_d©a
 *
	m¶ugš_d©a
;

204 
	mcom´essiÚ_ty³
;

205 } 
	thªdËr_ùx
;

207 
hªdËr_ùx
 *
	$hªdËr_ùx_š™
() {

208 
hªdËr_ùx
 *
hùx
;

210 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

211 
hùx
->
š_queue
 = 
	`chunkqueue_š™
();

213  
hùx
;

214 
	}
}

216 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

218 ià(
hùx
->
ouut
 !ğ
p
->
tmp_buf
) {

219 
	`bufãr_ä“
(
hùx
->
ouut
);

222 
	`chunkqueue_ä“
(
hùx
->
š_queue
);

223 
	`ä“
(
hùx
);

224 
	}
}

226 
	$INIT_FUNC
(
mod_deæ©e_š™
) {

227 
¶ugš_d©a
 *
p
;

229 
p
 = 
	`ÿÎoc
(1, (*p));

231 
p
->
’codšgs
 = 
	`¬¿y_š™
();

232 
p
->
tmp_buf
 = 
	`bufãr_š™
();

233 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
tmp_buf
, 64 
KBy‹
);

235  
p
;

236 
	}
}

238 
	$FREE_FUNC
(
mod_deæ©e_ä“
) {

239 
¶ugš_d©a
 *
p
 = 
p_d
;

241 
	`UNUSED
(
¤v
);

243 ià(!
p
è 
HANDLER_GO_ON
;

245 ià(
p
->
cÚfig_¡Üage
) {

246 
size_t
 
i
;

247 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

248 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

250 ià(!
s
) ;

252 
	`¬¿y_ä“
(
s
->
mim‘y³s
);

253 
	`ä“
(
s
);

255 
	`ä“
(
p
->
cÚfig_¡Üage
);

258 
	`bufãr_ä“
(
p
->
tmp_buf
);

259 
	`¬¿y_ä“
(
p
->
’codšgs
);

261 
	`ä“
(
p
);

263  
HANDLER_GO_ON
;

264 
	}
}

266 
	$SETDEFAULTS_FUNC
(
mod_deæ©e_£tdeçuÉs
) {

267 
¶ugš_d©a
 *
p
 = 
p_d
;

268 
size_t
 
i
 = 0;

270 
cÚfig_v®ues_t
 
cv
[] = {

271 { "deæ©e.mim‘y³s", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

272 { "deæ©e.®lowed-’codšgs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

273 { "deæ©e.max-com´ess-size", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

274 { "deæ©e.mš-com´ess-size", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

275 { "deæ©e.com´essiÚ-Ëv–", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

276 { "deæ©e.ouut-bufãr-size", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

277 { "deæ©e.wÜk-block-size", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

278 { "deæ©e.max-lßdavg", 
NULL
, 
T_CONFIG_STRING
,
T_CONFIG_SCOPE_CONNECTION
 },

279 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

282 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

284 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

285 
¶ugš_cÚfig
 *
s
;

287 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

288 
s
->
mim‘y³s
 = 
	`¬¿y_š™
();

289 
s
->
®lowed_’codšgs
 = 0;

290 
s
->
max_com´ess_size
 = 128*1024;

291 
s
->
mš_com´ess_size
 = 256;

292 
s
->
ouut_bufãr_size
 = 0;

293 
s
->
wÜk_block_size
 = 2048;

294 
s
->
sync_æush
 = 0;

295 
s
->
com´essiÚ_Ëv–
 = -1;

296 
s
->
max_lßdavg
 = 0.0;

298 
	`¬¿y_»£t
(
p
->
’codšgs
);

300 
cv
[0].
de¡š©iÚ
 = 
s
->
mim‘y³s
;

301 
cv
[1].
de¡š©iÚ
 = 
p
->
’codšgs
;

302 
cv
[2].
de¡š©iÚ
 = &(
s
->
max_com´ess_size
);

303 
cv
[3].
de¡š©iÚ
 = &(
s
->
mš_com´ess_size
);

304 
cv
[4].
de¡š©iÚ
 = &(
s
->
com´essiÚ_Ëv–
);

305 
cv
[5].
de¡š©iÚ
 = &(
s
->
ouut_bufãr_size
);

306 
cv
[6].
de¡š©iÚ
 = &(
s
->
wÜk_block_size
);

307 
cv
[7].
de¡š©iÚ
 = 
p
->
tmp_buf
;

308 
	`bufãr_¡ršg_£t_Ëngth
(
p
->
tmp_buf
, 0);

310 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

312 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, ((
d©a_cÚfig
 *)¤v->
cÚfig_cÚ‹xt
->
d©a
[
i
])->
v®ue
, 
cv
, i =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

313  
HANDLER_ERROR
;

316 ià((
s
->
com´essiÚ_Ëv–
 < 1 || s->compression_level > 9) &&

317 
s
->
com´essiÚ_Ëv–
 != -1) {

318 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

319 "com´essiÚ-Ëv– mu¡ bb‘w“À1‡nd 9:", 
s
->
com´essiÚ_Ëv–
);

320  
HANDLER_ERROR
;

323 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
tmp_buf
)) {

324 
s
->
max_lßdavg
 = 
	`¡¹od
(
p
->
tmp_buf
->
±r
, 
NULL
);

327 ià(
p
->
’codšgs
->
u£d
) {

328 
size_t
 
j
 = 0;

329 
j
 = 0; j < 
p
->
’codšgs
->
u£d
; j++) {

330 #ià
	`defšed
(
USE_ZLIB
è|| defšed(
USE_BZ2LIB
)

331 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
’codšgs
->
d©a
[
j
];

333 #ifdeà
USE_ZLIB


334 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "gzip"))

335 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_GZIP
 | 
HTTP_ACCEPT_ENCODING_X_GZIP
;

336 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "x-gzip"))

337 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_X_GZIP
;

338 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "deflate"))

339 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_DEFLATE
;

345 #ifdeà
USE_BZ2LIB


346 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "bzip2"))

347 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_BZIP2
 | 
HTTP_ACCEPT_ENCODING_X_BZIP2
;

348 ià(
NULL
 !ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "x-bzip2"))

349 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_X_BZIP2
;

354 #ifdeà
USE_ZLIB


355 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_GZIP


356 | 
HTTP_ACCEPT_ENCODING_X_GZIP


357 | 
HTTP_ACCEPT_ENCODING_DEFLATE
;

359 #ifdeà
USE_BZ2LIB


360 
s
->
®lowed_’codšgs
 |ğ
HTTP_ACCEPT_ENCODING_BZIP2


361 | 
HTTP_ACCEPT_ENCODING_X_BZIP2
;

368 
size_t
 
m
 = 0; m < 
s
->
mim‘y³s
->
u£d
; ++m) {

369 
bufãr
 *
mim‘y³
 = ((
d©a_¡ršg
 *)
s
->
mim‘y³s
->
d©a
[
m
])->
v®ue
;

370 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
mim‘y³
);

371 ià(
Ën
 > 2 && 
mim‘y³
->
±r
[len-1] == '*') {

372 
	`bufãr_¡ršg_£t_Ëngth
(
mim‘y³
, 
Ën
-1);

377  
HANDLER_GO_ON
;

379 
	}
}

382 #ià
defšed
(
USE_ZLIB
è|| defšed(
USE_BZ2LIB
)

383 
	$¡»am_h‰p_chunk_­³nd_mem
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
size_t
 
Ën
) {

385  
	`h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
hùx
->
ouut
->
±r
, 
Ën
);

386 
	}
}

390 #ifdeà
USE_ZLIB


392 
	$¡»am_deæ©e_š™
(
hªdËr_ùx
 *
hùx
) {

393 
z_¡»am
 * cÚ¡ 
z
 = &
hùx
->
u
.z;

394 cÚ¡ 
¶ugš_d©a
 * cÚ¡ 
p
 = 
hùx
->plugin_data;

395 
z
->
z®loc
 = 
Z_NULL
;

396 
z
->
zä“
 = 
Z_NULL
;

397 
z
->
İaque
 = 
Z_NULL
;

398 
z
->
tÙ®_š
 = 0;

399 
z
->
tÙ®_out
 = 0;

400 
z
->
Ãxt_out
 = (*)
hùx
->
ouut
->
±r
;

401 
z
->
ava_out
 = 
hùx
->
ouut
->
size
;

403 ià(
Z_OK
 !ğ
	`deæ©eIn™2
(
z
,

404 
p
->
cÚf
.
com´essiÚ_Ëv–
 > 0

405 ? 
p
->
cÚf
.
com´essiÚ_Ëv–


406 : 
Z_DEFAULT_COMPRESSION
,

407 
Z_DEFLATED
,

408 (
hùx
->
com´essiÚ_ty³
 =ğ
HTTP_ACCEPT_ENCODING_GZIP
)

409 ? (
MAX_WBITS
 | 16)

410 : -
MAX_WBITS
,

412 
Z_DEFAULT_STRATEGY
)) {

417 
	}
}

419 
	$¡»am_deæ©e_com´ess
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, *
¡¬t
, 
off_t
 
¡_size
) {

420 
z_¡»am
 * cÚ¡ 
z
 = &(
hùx
->
u
.z);

421 
size_t
 
Ën
;

423 
z
->
Ãxt_š
 = 
¡¬t
;

424 
z
->
ava_š
 = 
¡_size
;

425 
hùx
->
by‹s_š
 +ğ
¡_size
;

429 ià(
Z_OK
 !ğ
	`deæ©e
(
z
, 
Z_NO_FLUSH
))  -1;

431 ià(
z
->
ava_out
 =ğ0 || z->
ava_š
 > 0) {

432 
Ën
 = 
hùx
->
ouut
->
size
 - 
z
->
ava_out
;

433 
hùx
->
by‹s_out
 +ğ
Ën
;

434 
	`¡»am_h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
hùx
, 
Ën
);

435 
z
->
Ãxt_out
 = (*)
hùx
->
ouut
->
±r
;

436 
z
->
ava_out
 = 
hùx
->
ouut
->
size
;

438 } 
z
->
ava_š
 > 0);

441 
	}
}

443 
	$¡»am_deæ©e_æush
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
’d
) {

444 
z_¡»am
 * cÚ¡ 
z
 = &(
hùx
->
u
.z);

445 cÚ¡ 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

446 
size_t
 
Ën
;

447 
rc
 = 0;

448 
dÚe
;

452 
dÚe
 = 1;

453 ià(
’d
) {

454 
rc
 = 
	`deæ©e
(
z
, 
Z_FINISH
);

455 ià(
rc
 =ğ
Z_OK
) {

456 
dÚe
 = 0;

457 } ià(
rc
 !ğ
Z_STREAM_END
) {

461 ià(
p
->
cÚf
.
sync_æush
) {

462 
rc
 = 
	`deæ©e
(
z
, 
Z_SYNC_FLUSH
);

463 ià(
rc
 !ğ
Z_OK
)  -1;

464 } ià(
z
->
ava_š
 > 0) {

465 
rc
 = 
	`deæ©e
(
z
, 
Z_NO_FLUSH
);

466 ià(
rc
 !ğ
Z_OK
)  -1;

470 
Ën
 = 
hùx
->
ouut
->
size
 - 
z
->
ava_out
;

471 ià(
z
->
ava_out
 =ğ0 || (
Ën
 > 0 && (
’d
 || 
p
->
cÚf
.
sync_æush
))) {

472 
hùx
->
by‹s_out
 +ğ
Ën
;

473 
	`¡»am_h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
hùx
, 
Ën
);

474 
z
->
Ãxt_out
 = (*)
hùx
->
ouut
->
±r
;

475 
z
->
ava_out
 = 
hùx
->
ouut
->
size
;

477 } 
z
->
ava_š
 !ğ0 || !
dÚe
);

480 
	}
}

482 
	$¡»am_deæ©e_’d
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

483 
z_¡»am
 * cÚ¡ 
z
 = &(
hùx
->
u
.z);

484 
rc
 = 
	`deæ©eEnd
(
z
);

485 ià(
Z_OK
 =ğ
rc
 || 
Z_DATA_ERROR
 ==„c)  0;

487 ià(
z
->
msg
 !ğ
NULL
) {

488 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdss",

489 "deæ©eEndƒ¼Ü„‘=", 
rc
, ", msg=", 
z
->
msg
);

491 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

492 "deæ©eEndƒ¼Ü„‘=", 
rc
);

495 
	}
}

500 #ifdeà
USE_BZ2LIB


502 
	$¡»am_bz2_š™
(
hªdËr_ùx
 *
hùx
) {

503 
bz_¡»am
 * cÚ¡ 
bz
 = &
hùx
->
u
.bz;

504 cÚ¡ 
¶ugš_d©a
 * cÚ¡ 
p
 = 
hùx
->plugin_data;

505 
bz
->
bz®loc
 = 
NULL
;

506 
bz
->
bzä“
 = 
NULL
;

507 
bz
->
İaque
 = 
NULL
;

508 
bz
->
tÙ®_š_lo32
 = 0;

509 
bz
->
tÙ®_š_hi32
 = 0;

510 
bz
->
tÙ®_out_lo32
 = 0;

511 
bz
->
tÙ®_out_hi32
 = 0;

512 
bz
->
Ãxt_out
 = 
hùx
->
ouut
->
±r
;

513 
bz
->
ava_out
 = 
hùx
->
ouut
->
size
;

515 ià(
BZ_OK
 !ğ
	`BZ2_bzCom´essIn™
(
bz
,

516 
p
->
cÚf
.
com´essiÚ_Ëv–
 > 0

517 ? 
p
->
cÚf
.
com´essiÚ_Ëv–


525 
	}
}

527 
	$¡»am_bz2_com´ess
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, *
¡¬t
, 
off_t
 
¡_size
) {

528 
bz_¡»am
 * cÚ¡ 
bz
 = &(
hùx
->
u
.bz);

529 
size_t
 
Ën
;

531 
bz
->
Ãxt_š
 = (*)
¡¬t
;

532 
bz
->
ava_š
 = 
¡_size
;

533 
hùx
->
by‹s_š
 +ğ
¡_size
;

537 ià(
BZ_RUN_OK
 !ğ
	`BZ2_bzCom´ess
(
bz
, 
BZ_RUN
))  -1;

539 ià(
bz
->
ava_out
 =ğ0 || bz->
ava_š
 > 0) {

540 
Ën
 = 
hùx
->
ouut
->
size
 - 
bz
->
ava_out
;

541 
hùx
->
by‹s_out
 +ğ
Ën
;

542 
	`¡»am_h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
hùx
, 
Ën
);

543 
bz
->
Ãxt_out
 = 
hùx
->
ouut
->
±r
;

544 
bz
->
ava_out
 = 
hùx
->
ouut
->
size
;

546 } 
bz
->
ava_š
 > 0);

549 
	}
}

551 
	$¡»am_bz2_æush
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
’d
) {

552 
bz_¡»am
 * cÚ¡ 
bz
 = &(
hùx
->
u
.bz);

553 cÚ¡ 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

554 
size_t
 
Ën
;

555 
rc
;

556 
dÚe
;

560 
dÚe
 = 1;

561 ià(
’d
) {

562 
rc
 = 
	`BZ2_bzCom´ess
(
bz
, 
BZ_FINISH
);

563 ià(
rc
 =ğ
BZ_FINISH_OK
) {

564 
dÚe
 = 0;

565 } ià(
rc
 !ğ
BZ_STREAM_END
) {

568 } ià(
bz
->
ava_š
 > 0) {

572 
rc
 = 
	`BZ2_bzCom´ess
(
bz
, 
BZ_RUN
);

573 ià(
rc
 !ğ
BZ_RUN_OK
) {

578 
Ën
 = 
hùx
->
ouut
->
size
 - 
bz
->
ava_out
;

579 ià(
bz
->
ava_out
 =ğ0 || (
Ën
 > 0 && (
’d
 || 
p
->
cÚf
.
sync_æush
))) {

580 
hùx
->
by‹s_out
 +ğ
Ën
;

581 
	`¡»am_h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
hùx
, 
Ën
);

582 
bz
->
Ãxt_out
 = 
hùx
->
ouut
->
±r
;

583 
bz
->
ava_out
 = 
hùx
->
ouut
->
size
;

585 } 
bz
->
ava_š
 !ğ0 || !
dÚe
);

588 
	}
}

590 
	$¡»am_bz2_’d
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

591 
bz_¡»am
 * cÚ¡ 
bz
 = &(
hùx
->
u
.bz);

592 
rc
 = 
	`BZ2_bzCom´essEnd
(
bz
);

593 ià(
BZ_OK
 =ğ
rc
 || 
BZ_DATA_ERROR
 ==„c)  0;

595 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

596 "BZ2_bzCom´essEndƒ¼Ü„‘=", 
rc
);

598 
	}
}

603 
	$mod_deæ©e_¡»am_š™
(
hªdËr_ùx
 *
hùx
) {

604 
hùx
->
com´essiÚ_ty³
) {

605 #ifdeà
USE_ZLIB


606 
HTTP_ACCEPT_ENCODING_GZIP
:

607 
HTTP_ACCEPT_ENCODING_DEFLATE
:

608  
	`¡»am_deæ©e_š™
(
hùx
);

610 #ifdeà
USE_BZ2LIB


611 
HTTP_ACCEPT_ENCODING_BZIP2
:

612  
	`¡»am_bz2_š™
(
hùx
);

617 
	}
}

619 
	$mod_deæ©e_com´ess
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, *
¡¬t
, 
off_t
 
¡_size
) {

620 ià(0 =ğ
¡_size
)  0;

621 
hùx
->
com´essiÚ_ty³
) {

622 #ifdeà
USE_ZLIB


623 
HTTP_ACCEPT_ENCODING_GZIP
:

624 
HTTP_ACCEPT_ENCODING_DEFLATE
:

625  
	`¡»am_deæ©e_com´ess
(
¤v
, 
cÚ
, 
hùx
, 
¡¬t
, 
¡_size
);

627 #ifdeà
USE_BZ2LIB


628 
HTTP_ACCEPT_ENCODING_BZIP2
:

629  
	`¡»am_bz2_com´ess
(
¤v
, 
cÚ
, 
hùx
, 
¡¬t
, 
¡_size
);

632 
	`UNUSED
(
¤v
);

633 
	`UNUSED
(
cÚ
);

634 
	`UNUSED
(
¡¬t
);

637 
	}
}

639 
	$mod_deæ©e_¡»am_æush
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
’d
) {

640 ià(0 =ğ
hùx
->
by‹s_š
)  0;

641 
hùx
->
com´essiÚ_ty³
) {

642 #ifdeà
USE_ZLIB


643 
HTTP_ACCEPT_ENCODING_GZIP
:

644 
HTTP_ACCEPT_ENCODING_DEFLATE
:

645  
	`¡»am_deæ©e_æush
(
¤v
, 
cÚ
, 
hùx
, 
’d
);

647 #ifdeà
USE_BZ2LIB


648 
HTTP_ACCEPT_ENCODING_BZIP2
:

649  
	`¡»am_bz2_æush
(
¤v
, 
cÚ
, 
hùx
, 
’d
);

652 
	`UNUSED
(
¤v
);

653 
	`UNUSED
(
cÚ
);

654 
	`UNUSED
(
’d
);

657 
	}
}

659 
	$mod_deæ©e_nÙe_¿tio
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
) {

664 
¿tio
[
LI_ITOSTRING_LENGTH
];

665 ià(0 =ğ
hùx
->
by‹s_š
) ;

666 
	`li_™o¡º
(
¿tio
, Ô©io), 
hùx
->
by‹s_out
 * 100 / hùx->
by‹s_š
);

667 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

668 
	`CONST_STR_LEN
("ratio"),

669 
¿tio
, 
	`¡¾’
(ratio));

670 
	`UNUSED
(
¤v
);

671 
	}
}

673 
	$mod_deæ©e_¡»am_’d
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

674 
hùx
->
com´essiÚ_ty³
) {

675 #ifdeà
USE_ZLIB


676 
HTTP_ACCEPT_ENCODING_GZIP
:

677 
HTTP_ACCEPT_ENCODING_DEFLATE
:

678  
	`¡»am_deæ©e_’d
(
¤v
, 
hùx
);

680 #ifdeà
USE_BZ2LIB


681 
HTTP_ACCEPT_ENCODING_BZIP2
:

682  
	`¡»am_bz2_’d
(
¤v
, 
hùx
);

685 
	`UNUSED
(
¤v
);

688 
	}
}

690 
	$deæ©e_com´ess_ş—nup
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
) {

691 cÚ¡ 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

692 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

694 ià(0 !ğ
	`mod_deæ©e_¡»am_’d
(
¤v
, 
hùx
)) {

695 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "error closing stream");

699 ià(
hùx
->
by‹s_š
 < hùx->
by‹s_out
) {

700 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsdsd",

701 "ur˜", 
cÚ
->
uri
.
·th_¿w
, " in=", 
hùx
->
by‹s_š
, " sm®Ë¸thª out=", hùx->
by‹s_out
);

705 
	`hªdËr_ùx_ä“
(
hùx
);

706 
	}
}

709 
	$mod_deæ©e_fe_chunk
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
chunk
 *
c
, 
off_t
 
¡_size
) {

710 
off_t
 
abs_off£t
;

711 
off_t
 
toS’d
 = -1;

712 *
¡¬t
;

713 #ifdeà
USE_MMAP


714 
off_t
 
we_wªt_to_mm­
 = 2 
MBy‹
;

715 
off_t
 
we_wªt_to_£nd
 = 
¡_size
;

716 vŞ©
m­³d
 = 0;

718 
¡¬t
 = 
NULL
;

721 ià(-1 =ğ
c
->
fe
.
fd
) {

722 ià(-1 =ğ(
c
->
fe
.
fd
 = 
	`fdev’t_İ’_şÛxec
(c->fe.
Çme
->
±r
, 
O_RDONLY
, 0))) {

723 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "İ’ faed fÜ:", 
c
->
fe
.
Çme
, 
	`¡»¼Ü
(
”ºo
));

729 
abs_off£t
 = 
c
->
fe
.
¡¬t
 + c->
off£t
;

731 #ifdeà
USE_MMAP


735 ià(
c
->
fe
.
mm­
.
¡¬t
 =ğ
MAP_FAILED
 ||

736 
abs_off£t
 =ğ(
off_t
)(
c
->
fe
.
mm­
.
off£t
 + c->fe.mm­.
Ëngth
)) {

760 
off_t
 
to_mm­
;

763 ià(
c
->
fe
.
mm­
.
¡¬t
 !ğ
MAP_FAILED
) {

764 
	`munm­
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
);

765 
c
->
fe
.
mm­
.
off£t
 +ğ
we_wªt_to_mm­
;

768 
c
->
fe
.
mm­
.
off£t
 = 0;

770 
c
->
fe
.
mm­
.
off£t
 + 
we_wªt_to_mm­
 < c->fe.
¡¬t
) {

771 
c
->
fe
.
mm­
.
off£t
 +ğ
we_wªt_to_mm­
;

776 
to_mm­
 = (
c
->
fe
.
¡¬t
 + c->fe.
Ëngth
è- c->fe.
mm­
.
off£t
;

777 ià(
to_mm­
 > 
we_wªt_to_mm­
)o_mmap = we_want_to_mmap;

779 ià(
we_wªt_to_£nd
 > 
to_mm­
) we_want_to_send =o_mmap;

781 ià(
MAP_FAILED
 =ğ(
c
->
fe
.
mm­
.
¡¬t
 = 
	`mm­
(0, (
size_t
)
to_mm­
, 
PROT_READ
, 
MAP_SHARED
, c->fe.
fd
, c->fe.mm­.
off£t
))) {

784 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbd", "mmap failed:",

785 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
, c->fe.
fd
);

790 
c
->
fe
.
mm­
.
Ëngth
 = 
to_mm­
;

791 #ifdeà
HAVE_MADVISE


793 ià(
c
->
fe
.
mm­
.
Ëngth
 > (64 
KBy‹
) &&

794 0 !ğ
	`madvi£
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
, 
MADV_WILLNEED
)) {

795 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbd", "madvise failed:",

796 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
, c->fe.
fd
);

804 
toS’d
 = (
c
->
fe
.
mm­
.
off£t
 + c->fe.mm­.
Ëngth
è- 
abs_off£t
;

805 ià(
toS’d
 > 
we_wªt_to_£nd
)oSend = we_want_to_send;

807 ià(
toS’d
 < 0) {

808 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "soooo",

810 
toS’d
,

811 
c
->
fe
.
mm­
.
Ëngth
,

812 
abs_off£t
,

813 
c
->
fe
.
mm­
.
off£t
);

814 
	`fÜû_as£¹
(
toS’d
 < 0);

817 
¡¬t
 = 
c
->
fe
.
mm­
.start;

818 
m­³d
 = 1;

821 ià(
MAP_FAILED
 =ğ
c
->
fe
.
mm­
.
¡¬t
) {

822 
toS’d
 = 
¡_size
;

823 ià(
toS’d
 > 2 
MBy‹
)oSend = 2 MByte;

824 ià(
NULL
 =ğ(
¡¬t
 = 
	`m®loc
((
size_t
)
toS’d
)è|| -1 =ğ
	`l£ek
(
c
->
fe
.
fd
, 
abs_off£t
, 
SEEK_SET
è||oS’d !ğ
	`»ad
(c->file.fd, start, (size_t)toSend)) {

825 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss", "»adšg", 
c
->
fe
.
Çme
, "çed:", 
	`¡»¼Ü
(
”ºo
));

827 
	`ä“
(
¡¬t
);

832 #ifdeà
USE_MMAP


833 ià(
m­³d
) {

834 
	`sigÇl
(
SIGBUS
, 
sigbus_hªdËr
);

835 
sigbus_jmp_v®id
 = 1;

836 ià(0 !ğ
	`sig£tjmp
(
sigbus_jmp
, 1)) {

837 
sigbus_jmp_v®id
 = 0;

839 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd", "SIGBUS in mmap:",

840 
c
->
fe
.
Çme
, c->fe.
fd
);

846 ià(
	`mod_deæ©e_com´ess
(
¤v
, 
cÚ
, 
hùx
,

847 (*)
¡¬t
 + (
abs_off£t
 - 
c
->
fe
.
mm­
.
off£t
), 
toS’d
) < 0) {

848 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

850 
toS’d
 = -1;

853 #ifdeà
USE_MMAP


854 ià(
m­³d
)

855 
sigbus_jmp_v®id
 = 0;

858 
	`ä“
(
¡¬t
);

860  
toS’d
;

861 
	}
}

864 
hªdËr_t
 
	$deæ©e_com´ess_»¥Ú£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
) {

865 
off_t
 
Ën
, 
max
;

866 
şo£_¡»am
;

870 
Ën
 = 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
);

871 
	`chunkqueue_»move_fšished_chunks
(
cÚ
->
wr™e_queue
);

872 
	`chunkqueue_­³nd_chunkqueue
(
hùx
->
š_queue
, 
cÚ
->
wr™e_queue
);

873 
cÚ
->
wr™e_queue
->
by‹s_š
 -ğ
Ën
;

874 
cÚ
->
wr™e_queue
->
by‹s_out
 -ğ
Ën
;

876 
max
 = 
	`chunkqueue_Ëngth
(
hùx
->
š_queue
);

879 ià(
p
->
cÚf
.
sync_æush
 && 
max
 > (
Ën
 =…->cÚf.
wÜk_block_size
 << 10)) {

880 
max
 = 
Ën
;

885 
max
) {

886 
chunk
 *
c
 = 
hùx
->
š_queue
->
fœ¡
;

888 
c
->
ty³
) {

889 
MEM_CHUNK
:

890 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

891 ià(
Ën
 > 
max
)†en = max;

892 ià(
	`mod_deæ©e_com´ess
(
¤v
, 
cÚ
, 
hùx
, (*)
c
->
mem
->
±r
+c->
off£t
, 
Ën
) < 0) {

893 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

895  
HANDLER_ERROR
;

898 
FILE_CHUNK
:

899 
Ën
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

900 ià(
Ën
 > 
max
)†en = max;

901 ià((
Ën
 = 
	`mod_deæ©e_fe_chunk
(
¤v
, 
cÚ
, 
hùx
, 
c
,†en)) < 0) {

902 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

904  
HANDLER_ERROR
;

908 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ds", 
c
, "type‚ot known");

909  
HANDLER_ERROR
;

912 
max
 -ğ
Ën
;

913 
	`chunkqueue_m¬k_wr™‹n
(
hùx
->
š_queue
, 
Ën
);

918 
şo£_¡»am
 = (
cÚ
->
fe_fšished
 && 
	`chunkqueue_is_em±y
(
hùx
->
š_queue
));

919 ià(
	`mod_deæ©e_¡»am_æush
(
¤v
, 
cÚ
, 
hùx
, 
şo£_¡»am
) < 0) {

920 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "flushƒrror");

921  
HANDLER_ERROR
;

924  
şo£_¡»am
 ? 
HANDLER_FINISHED
 : 
HANDLER_GO_ON
;

925 
	}
}

928 
	#PATCH
(
x
) \

929 
p
->
cÚf
.
x
 = 
s
->x;

	)

930 
	$mod_deæ©e_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

931 
size_t
 
i
, 
j
;

932 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

934 
	`PATCH
(
mim‘y³s
);

935 
	`PATCH
(
®lowed_’codšgs
);

936 
	`PATCH
(
max_com´ess_size
);

937 
	`PATCH
(
mš_com´ess_size
);

938 
	`PATCH
(
com´essiÚ_Ëv–
);

939 
	`PATCH
(
ouut_bufãr_size
);

940 
	`PATCH
(
wÜk_block_size
);

941 
	`PATCH
(
max_lßdavg
);

944 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

945 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

946 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

949 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

952 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

953 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

955 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.mimetypes"))) {

956 
	`PATCH
(
mim‘y³s
);

957 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.allowed-encodings"))) {

958 
	`PATCH
(
®lowed_’codšgs
);

959 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.max-compress-size"))) {

960 
	`PATCH
(
max_com´ess_size
);

961 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.min-compress-size"))) {

962 
	`PATCH
(
mš_com´ess_size
);

963 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.compression-level"))) {

964 
	`PATCH
(
com´essiÚ_Ëv–
);

965 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.output-buffer-size"))) {

966 
	`PATCH
(
ouut_bufãr_size
);

967 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.work-block-size"))) {

968 
	`PATCH
(
wÜk_block_size
);

969 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("deflate.max-loadavg"))) {

970 
	`PATCH
(
max_lßdavg
);

976 
	}
}

977 #undeà
PATCH


979 
	$mod_deæ©e_choo£_’codšg
 (cÚ¡ *
v®ue
, 
¶ugš_d©a
 *
p
, cÚ¡ **
Ïb–
) {

981 
acû±_’codšg
 = 0;

982 #ià!
	`defšed
(
USE_ZLIB
è&& !defšed(
USE_BZ2LIB
)

983 
	`UNUSED
(
v®ue
);

985 #ifdeà
USE_ZLIB


986 ià(
NULL
 !ğ
	`¡r¡r
(
v®ue
, "gz")è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_GZIP
;

987 ià(
NULL
 !ğ
	`¡r¡r
(
v®ue
, "x-gz")è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_X_GZIP
;

988 ià(
NULL
 !ğ
	`¡r¡r
(
v®ue
, "deæ©e")è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_DEFLATE
;

991 #ifdeà
USE_BZ2LIB


992 ià(
p
->
cÚf
.
®lowed_’codšgs
 & (
HTTP_ACCEPT_ENCODING_BZIP2
 | 
HTTP_ACCEPT_ENCODING_X_BZIP2
)) {

993 ià(
NULL
 !ğ
	`¡r¡r
(
v®ue
, "bz2")è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_BZIP2
;

994 ià(
NULL
 !ğ
	`¡r¡r
(
v®ue
, "x-bz2")è
acû±_’codšg
 |ğ
HTTP_ACCEPT_ENCODING_X_BZIP2
;

1000 
acû±_’codšg
 &ğ
p
->
cÚf
.
®lowed_’codšgs
;

1003 #ifdeà
USE_BZ2LIB


1004 ià(
acû±_’codšg
 & 
HTTP_ACCEPT_ENCODING_BZIP2
) {

1005 *
Ïb–
 = "bzip2";

1006  
HTTP_ACCEPT_ENCODING_BZIP2
;

1007 } ià(
acû±_’codšg
 & 
HTTP_ACCEPT_ENCODING_X_BZIP2
) {

1008 *
Ïb–
 = "x-bzip2";

1009  
HTTP_ACCEPT_ENCODING_BZIP2
;

1012 ià(
acû±_’codšg
 & 
HTTP_ACCEPT_ENCODING_GZIP
) {

1013 *
Ïb–
 = "gzip";

1014  
HTTP_ACCEPT_ENCODING_GZIP
;

1015 } ià(
acû±_’codšg
 & 
HTTP_ACCEPT_ENCODING_X_GZIP
) {

1016 *
Ïb–
 = "x-gzip";

1017  
HTTP_ACCEPT_ENCODING_GZIP
;

1018 } ià(
acû±_’codšg
 & 
HTTP_ACCEPT_ENCODING_DEFLATE
) {

1019 *
Ïb–
 = "deflate";

1020  
HTTP_ACCEPT_ENCODING_DEFLATE
;

1024 
	}
}

1026 
	$CONNECTION_FUNC
(
mod_deæ©e_hªdË_»¥Ú£_¡¬t
) {

1027 
¶ugš_d©a
 *
p
 = 
p_d
;

1028 
d©a_¡ršg
 *
ds
;

1029 
hªdËr_ùx
 *
hùx
;

1030 cÚ¡ *
Ïb–
;

1031 
off_t
 
Ën
;

1032 
size_t
 
‘agËn
 = 0;

1033 
com´essiÚ_ty³
;

1034 
hªdËr_t
 
rc
;

1037 ià(!
cÚ
->
fe_fšished
è 
HANDLER_GO_ON
;

1038 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_HEAD
è 
HANDLER_GO_ON
;

1039 ià(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
è 
HANDLER_GO_ON
;

1042 
cÚ
->
h‰p_¡©us
) {

1049  
HANDLER_GO_ON
;

1054 
	`mod_deæ©e_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1057 ià(!
p
->
cÚf
.
mim‘y³s
->
u£d
è 
HANDLER_GO_ON
;

1061 
Ën
 = 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
);

1062 ià(
Ën
 <ğ(
off_t
)
p
->
cÚf
.
mš_com´ess_size
è 
HANDLER_GO_ON
;

1063 ià(
p
->
cÚf
.
max_com´ess_size


1064 && 
Ën
 > ((
off_t
)
p
->
cÚf
.
max_com´ess_size
 << 10)) {

1065  
HANDLER_GO_ON
;

1069 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Encoding");

1070 ià(
NULL
 !ğ
ds
è 
HANDLER_GO_ON
;

1073 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Accept-Encoding");

1074 ià(
NULL
 =ğ
ds
è 
HANDLER_GO_ON
;

1077 
com´essiÚ_ty³
 = 
	`mod_deæ©e_choo£_’codšg
(
ds
->
v®ue
->
±r
, 
p
, &
Ïb–
);

1078 ià(!
com´essiÚ_ty³
è 
HANDLER_GO_ON
;

1081 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Type"))) {

1082 
found
 = 0;

1083 
size_t
 
m
;

1084 
m
 = 0; m < 
p
->
cÚf
.
mim‘y³s
->
u£d
; ++m) {

1085 
d©a_¡ršg
 *
mim‘y³
 = (d©a_¡ršg *)
p
->
cÚf
.
mim‘y³s
->
d©a
[
m
];

1086 ià(0 =ğ
	`¡ºcmp
(
mim‘y³
->
v®ue
->
±r
, 
ds
->v®ue->±r, 
	`bufãr_¡ršg_Ëngth
(mimetype->value))) {

1088 
found
 = 1;

1092 ià(!
found
è 
HANDLER_GO_ON
;

1095 ià(0 =ğ
	`¡ºÿ£cmp
(
ds
->
v®ue
->
±r
, "application/x-javascript", 24)) {

1099 
com´essiÚ_ty³
 = 
HTTP_ACCEPT_ENCODING_DEFLATE
;

1104 
d©a_¡ršg
 *
mim‘y³
 = (d©a_¡ršg *)
p
->
cÚf
.
mim‘y³s
->
d©a
[0];

1105 ià(!
	`bufãr_¡ršg_is_em±y
(
mim‘y³
->
v®ue
)è 
HANDLER_GO_ON
;

1109 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Vary"))) {

1110 ià(
NULL
 =ğ
	`¡r¡r
(
ds
->
v®ue
->
±r
, "Accept-Encoding")) {

1111 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
(",Accept-Encoding"));

1114 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Vary"),

1115 
	`CONST_STR_LEN
("Accept-Encoding"));

1120 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "ETag");

1121 ià(
NULL
 !ğ
ds
) {

1122 
‘agËn
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

1123 ià(
‘agËn


1124 && 
cÚ
->
h‰p_¡©us
 < 300

1125 && 
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch


1126 && 0 =ğ
	`¡ºcmp
(
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
, 
ds
->
v®ue
->
±r
, 
‘agËn
-1)

1127 && 
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
[
‘agËn
-1] == '-'

1128 && 0 =ğ
	`¡ºcmp
(
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
+
‘agËn
, 
Ïb–
, 
	`¡¾’
(label))) {

1130 iàĞ
HTTP_METHOD_GET
 =ğ
cÚ
->
»que¡
.
h‰p_m‘hod


1131 || 
HTTP_METHOD_HEAD
 =ğ
cÚ
->
»que¡
.
h‰p_m‘hod
) {

1133 
ds
->
v®ue
->
±r
[
‘agËn
-1] = '-';

1134 
	`bufãr_­³nd_¡ršg
(
ds
->
v®ue
, 
Ïb–
);

1135 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("\""));

1137 
cÚ
->
h‰p_¡©us
 = 304;

1139 
cÚ
->
h‰p_¡©us
 = 412;

1147 
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 &ğ~
HTTP_TRANSFER_ENCODING_CHUNKED
;

1148 
cÚ
->
·r£d_»¥Ú£
 &ğ~
HTTP_CONTENT_LENGTH
;

1149 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

1150 
cÚ
->
fe_fšished
 = 1;

1152 
cÚ
->
mode
 = 
DIRECT
;

1153  
HANDLER_GO_ON
;

1157 ià(0.0 < 
p
->
cÚf
.
max_lßdavg
 &&…->cÚf.max_lßdavg < 
¤v
->
¤vcÚf
.
lßdavg
[0]) {

1158  
HANDLER_GO_ON
;

1162 ià(
‘agËn
) {

1164 
ds
->
v®ue
->
±r
[
‘agËn
-1] = '-';

1165 
	`bufãr_­³nd_¡ršg
(
ds
->
v®ue
, 
Ïb–
);

1166 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("\""));

1171 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Encodšg"), 
Ïb–
, 
	`¡¾’
(label));

1176 ià(
HTTP_METHOD_HEAD
 =ğ
cÚ
->
»que¡
.
h‰p_m‘hod
) {

1178 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

1179 ià(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_CONTENT_LENGTH
) {

1180 
cÚ
->
·r£d_»¥Ú£
 &ğ~
HTTP_CONTENT_LENGTH
;

1181 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
*è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Length"))) {

1182 
	`bufãr_»£t
(
ds
->
v®ue
);

1185  
HANDLER_GO_ON
;

1192 
p
->
cÚf
.
sync_æush
 =

1193 (
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 && 0 =ğ
p
->cÚf.
ouut_bufãr_size
);

1194 
hùx
 = 
	`hªdËr_ùx_š™
();

1195 
hùx
->
¶ugš_d©a
 = 
p
;

1196 
hùx
->
com´essiÚ_ty³
 = compression_type;

1198 
	`bufãr_¡ršg_£t_Ëngth
(
p
->
tmp_buf
, 0);

1199 
hùx
->
ouut
 = 
p
->
tmp_buf
;

1200 ià(0 !ğ
	`mod_deæ©e_¡»am_š™
(
hùx
)) {

1202 
	`hªdËr_ùx_ä“
(
hùx
);

1203 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1204 "FaedØš™Ÿlizcom´essiÚ", 
Ïb–
);

1206 ià(
‘agËn
) {

1207 
ds
->
v®ue
->
±r
[
‘agËn
-1] = '"';

1208 
	`bufãr_¡ršg_£t_Ëngth
(
ds
->
v®ue
, 
‘agËn
);

1210 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Encoding");

1211 ià(
ds
è
	`bufãr_»£t
(ds->
v®ue
);

1212  
HANDLER_GO_ON
;

1215 
cÚ
->
·r£d_»¥Ú£
 &ğ~
HTTP_CONTENT_LENGTH
;

1216 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

1218 
rc
 = 
	`deæ©e_com´ess_»¥Ú£
(
¤v
, 
cÚ
, 
hùx
);

1219 ià(
HANDLER_GO_ON
 !ğ
rc
) {

1220 ià(
HANDLER_FINISHED
 =ğ
rc
) {

1221 
	`mod_deæ©e_nÙe_¿tio
(
¤v
, 
cÚ
, 
hùx
);

1223 
	`deæ©e_com´ess_ş—nup
(
¤v
, 
cÚ
, 
hùx
);

1224 ià(
HANDLER_ERROR
 =ğ
rc
)  HANDLER_ERROR;

1227  
HANDLER_GO_ON
;

1228 
	}
}

1230 
hªdËr_t
 
	$mod_deæ©e_ş—nup
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

1231 
¶ugš_d©a
 *
p
 = 
p_d
;

1232 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1234 ià(
NULL
 !ğ
hùx
è
	`deæ©e_com´ess_ş—nup
(
¤v
, 
cÚ
, hctx);

1236  
HANDLER_GO_ON
;

1237 
	}
}

1239 
mod_deæ©e_¶ugš_š™
(
¶ugš
 *
p
);

1240 
	$mod_deæ©e_¶ugš_š™
(
¶ugš
 *
p
) {

1241 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1242 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("deflate");

1244 
p
->
š™
 = 
mod_deæ©e_š™
;

1245 
p
->
ş—nup
 = 
mod_deæ©e_ä“
;

1246 
p
->
£t_deçuÉs
 = 
mod_deæ©e_£tdeçuÉs
;

1247 
p
->
cÚÃùiÚ_»£t
 = 
mod_deæ©e_ş—nup
;

1248 
p
->
hªdË_cÚÃùiÚ_şo£
 = 
mod_deæ©e_ş—nup
;

1249 
p
->
hªdË_»¥Ú£_¡¬t
 = 
mod_deæ©e_hªdË_»¥Ú£_¡¬t
;

1251 
p
->
d©a
 = 
NULL
;

1254 
	}
}

	@mod_dirlisting.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"»¥Ú£.h
"

10 
	~"¡©_ÿche.h
"

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<dœ’t.h
>

16 
	~<as£¹.h
>

17 
	~<”ºo.h
>

18 
	~<fú.h
>

19 
	~<¡dio.h
>

20 
	~<uni¡d.h
>

21 
	~<time.h
>

27 #ifdeà
HAVE_ATTR_ATTRIBUTES_H


28 
	~<©Œ/©Œibu‹s.h
>

31 #ifdeà
HAVE_SYS_EXTATTR_H


32 
	~<sys/ex‰r.h
>

38 #ifdeà
HAVE_PCRE_H


39 
püe
 *
	m»gex
;

41 
bufãr
 *
	m¡ršg
;

42 } 
	texşudes
;

45 
exşudes
 **
	m±r
;

47 
size_t
 
	mu£d
;

48 
size_t
 
	msize
;

49 } 
	texşudes_bufãr
;

52 
	mdœ_li¡šg
;

53 
	mhide_dÙ_fes
;

54 
	mhide_»adme_fe
;

55 
	m’code_»adme
;

56 
	mhide_h—d”_fe
;

57 
	m’code_h—d”
;

58 
	mauto_Ïyout
;

60 
exşudes_bufãr
 *
	mexşudes
;

62 
bufãr
 *
	mshow_»adme
;

63 
bufãr
 *
	mshow_h—d”
;

64 
bufãr
 *
	mex‹º®_css
;

65 
bufãr
 *
	mex‹º®_js
;

66 
bufãr
 *
	m’codšg
;

67 
bufãr
 *
	m£t_foÙ”
;

68 } 
	t¶ugš_cÚfig
;

71 
	mPLUGIN_DATA
;

73 
bufãr
 *
	mtmp_buf
;

74 
bufãr
 *
	mcÚ‹Á_ch¬£t
;

76 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

78 
¶ugš_cÚfig
 
	mcÚf
;

79 } 
	t¶ugš_d©a
;

81 
exşudes_bufãr
 *
	$exşudes_bufãr_š™
() {

82 
exşudes_bufãr
 *
exb
;

84 
exb
 = 
	`ÿÎoc
(1, (*exb));

86  
exb
;

87 
	}
}

89 
	$exşudes_bufãr_­³nd
(
exşudes_bufãr
 *
exb
, 
bufãr
 *
¡ršg
) {

90 #ifdeà
HAVE_PCRE_H


91 
size_t
 
i
;

92 cÚ¡ *
”½Œ
;

93 
”roff
;

95 ià(!
¡ršg
)  -1;

97 ià(
exb
->
size
 == 0) {

98 
exb
->
size
 = 4;

99 
exb
->
u£d
 = 0;

101 
exb
->
±r
 = 
	`m®loc
Óxb->
size
 * (*exb->ptr));

103 
i
 = 0; i < 
exb
->
size
 ; i++) {

104 
exb
->
±r
[
i
] = 
	`ÿÎoc
(1, (**exb->ptr));

106 } ià(
exb
->
u£d
 =ğexb->
size
) {

107 
exb
->
size
 += 4;

109 
exb
->
±r
 = 
	`»®loc
Óxb->±r,ƒxb->
size
 * (*exb->ptr));

111 
i
 = 
exb
->
u£d
; i <ƒxb->
size
; i++) {

112 
exb
->
±r
[
i
] = 
	`ÿÎoc
(1, (**exb->ptr));

117 ià(
NULL
 =ğ(
exb
->
±r
[exb->
u£d
]->
»gex
 = 
	`püe_compe
(
¡ršg
->ptr, 0,

118 &
”½Œ
, &
”roff
, 
NULL
))) {

122 
exb
->
±r
[exb->
u£d
]->
¡ršg
 = 
	`bufãr_š™
();

123 
	`bufãr_cİy_bufãr
(
exb
->
±r
[exb->
u£d
]->
¡ršg
, string);

125 
exb
->
u£d
++;

129 
	`UNUSED
(
exb
);

130 
	`UNUSED
(
¡ršg
);

134 
	}
}

136 
	$exşudes_bufãr_ä“
(
exşudes_bufãr
 *
exb
) {

137 #ifdeà
HAVE_PCRE_H


138 
size_t
 
i
;

140 
i
 = 0; i < 
exb
->
size
; i++) {

141 ià(
exb
->
±r
[
i
]->
»gex
è
	`püe_ä“
(exb->ptr[i]->regex);

142 ià(
exb
->
±r
[
i
]->
¡ršg
è
	`bufãr_ä“
(exb->ptr[i]->string);

143 
	`ä“
(
exb
->
±r
[
i
]);

146 ià(
exb
->
±r
è
	`ä“
(exb->ptr);

149 
	`ä“
(
exb
);

150 
	}
}

153 
	$INIT_FUNC
(
mod_dœli¡šg_š™
) {

154 
¶ugš_d©a
 *
p
;

156 
p
 = 
	`ÿÎoc
(1, (*p));

158 
p
->
tmp_buf
 = 
	`bufãr_š™
();

159 
p
->
cÚ‹Á_ch¬£t
 = 
	`bufãr_š™
();

161  
p
;

162 
	}
}

165 
	$FREE_FUNC
(
mod_dœli¡šg_ä“
) {

166 
¶ugš_d©a
 *
p
 = 
p_d
;

168 
	`UNUSED
(
¤v
);

170 ià(!
p
è 
HANDLER_GO_ON
;

172 ià(
p
->
cÚfig_¡Üage
) {

173 
size_t
 
i
;

174 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

175 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

177 ià(!
s
) ;

179 
	`exşudes_bufãr_ä“
(
s
->
exşudes
);

180 
	`bufãr_ä“
(
s
->
show_»adme
);

181 
	`bufãr_ä“
(
s
->
show_h—d”
);

182 
	`bufãr_ä“
(
s
->
ex‹º®_css
);

183 
	`bufãr_ä“
(
s
->
ex‹º®_js
);

184 
	`bufãr_ä“
(
s
->
’codšg
);

185 
	`bufãr_ä“
(
s
->
£t_foÙ”
);

187 
	`ä“
(
s
);

189 
	`ä“
(
p
->
cÚfig_¡Üage
);

192 
	`bufãr_ä“
(
p
->
tmp_buf
);

193 
	`bufãr_ä“
(
p
->
cÚ‹Á_ch¬£t
);

195 
	`ä“
(
p
);

197  
HANDLER_GO_ON
;

198 
	}
}

202 
	#CONFIG_EXCLUDE
 "dœ-li¡šg.exşude"

	)

203 
	#CONFIG_ACTIVATE
 "dœ-li¡šg.aùiv©e"

	)

204 
	#CONFIG_HIDE_DOTFILES
 "dœ-li¡šg.hide-dÙfes"

	)

205 
	#CONFIG_EXTERNAL_CSS
 "dœ-li¡šg.ex‹º®-css"

	)

206 
	#CONFIG_EXTERNAL_JS
 "dœ-li¡šg.ex‹º®-js"

	)

207 
	#CONFIG_ENCODING
 "dœ-li¡šg.’codšg"

	)

208 
	#CONFIG_SHOW_README
 "dœ-li¡šg.show-»adme"

	)

209 
	#CONFIG_HIDE_README_FILE
 "dœ-li¡šg.hide-»adme-fe"

	)

210 
	#CONFIG_SHOW_HEADER
 "dœ-li¡šg.show-h—d”"

	)

211 
	#CONFIG_HIDE_HEADER_FILE
 "dœ-li¡šg.hide-h—d”-fe"

	)

212 
	#CONFIG_DIR_LISTING
 "£rv”.dœ-li¡šg"

	)

213 
	#CONFIG_SET_FOOTER
 "dœ-li¡šg.£t-foÙ”"

	)

214 
	#CONFIG_ENCODE_README
 "dœ-li¡šg.’code-»adme"

	)

215 
	#CONFIG_ENCODE_HEADER
 "dœ-li¡šg.’code-h—d”"

	)

216 
	#CONFIG_AUTO_LAYOUT
 "dœ-li¡šg.auto-Ïyout"

	)

219 
	$SETDEFAULTS_FUNC
(
mod_dœli¡šg_£t_deçuÉs
) {

220 
¶ugš_d©a
 *
p
 = 
p_d
;

221 
size_t
 
i
 = 0;

223 
cÚfig_v®ues_t
 
cv
[] = {

224 { 
CONFIG_EXCLUDE
, 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

225 { 
CONFIG_ACTIVATE
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

226 { 
CONFIG_HIDE_DOTFILES
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

227 { 
CONFIG_EXTERNAL_CSS
, 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

228 { 
CONFIG_ENCODING
, 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

229 { 
CONFIG_SHOW_README
, 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

230 { 
CONFIG_HIDE_README_FILE
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

231 { 
CONFIG_SHOW_HEADER
, 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

232 { 
CONFIG_HIDE_HEADER_FILE
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

233 { 
CONFIG_DIR_LISTING
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

234 { 
CONFIG_SET_FOOTER
, 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

235 { 
CONFIG_ENCODE_README
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

236 { 
CONFIG_ENCODE_HEADER
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

237 { 
CONFIG_AUTO_LAYOUT
, 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

238 { 
CONFIG_EXTERNAL_JS
, 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

240 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

243 ià(!
p
è 
HANDLER_ERROR
;

245 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

247 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

248 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

249 
¶ugš_cÚfig
 *
s
;

250 
d©a_un£t
 *
du_exşudes
;

252 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

253 
s
->
exşudes
 = 
	`exşudes_bufãr_š™
();

254 
s
->
dœ_li¡šg
 = 0;

255 
s
->
show_»adme
 = 
	`bufãr_š™
();

256 
s
->
show_h—d”
 = 
	`bufãr_š™
();

257 
s
->
ex‹º®_css
 = 
	`bufãr_š™
();

258 
s
->
ex‹º®_js
 = 
	`bufãr_š™
();

259 
s
->
hide_dÙ_fes
 = 1;

260 
s
->
hide_»adme_fe
 = 0;

261 
s
->
hide_h—d”_fe
 = 0;

262 
s
->
’code_»adme
 = 1;

263 
s
->
’code_h—d”
 = 1;

264 
s
->
auto_Ïyout
 = 1;

266 
s
->
’codšg
 = 
	`bufãr_š™
();

267 
s
->
£t_foÙ”
 = 
	`bufãr_š™
();

269 
cv
[0].
de¡š©iÚ
 = 
s
->
exşudes
;

270 
cv
[1].
de¡š©iÚ
 = &(
s
->
dœ_li¡šg
);

271 
cv
[2].
de¡š©iÚ
 = &(
s
->
hide_dÙ_fes
);

272 
cv
[3].
de¡š©iÚ
 = 
s
->
ex‹º®_css
;

273 
cv
[4].
de¡š©iÚ
 = 
s
->
’codšg
;

274 
cv
[5].
de¡š©iÚ
 = 
s
->
show_»adme
;

275 
cv
[6].
de¡š©iÚ
 = &(
s
->
hide_»adme_fe
);

276 
cv
[7].
de¡š©iÚ
 = 
s
->
show_h—d”
;

277 
cv
[8].
de¡š©iÚ
 = &(
s
->
hide_h—d”_fe
);

278 
cv
[9].
de¡š©iÚ
 = &(
s
->
dœ_li¡šg
);

279 
cv
[10].
de¡š©iÚ
 = 
s
->
£t_foÙ”
;

280 
cv
[11].
de¡š©iÚ
 = &(
s
->
’code_»adme
);

281 
cv
[12].
de¡š©iÚ
 = &(
s
->
’code_h—d”
);

282 
cv
[13].
de¡š©iÚ
 = &(
s
->
auto_Ïyout
);

283 
cv
[14].
de¡š©iÚ
 = 
s
->
ex‹º®_js
;

285 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

287 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

288  
HANDLER_ERROR
;

291 ià(
NULL
 !ğ(
du_exşudes
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, 
CONFIG_EXCLUDE
))) {

292 
¬¿y
 *
exşudes_li¡
;

293 
size_t
 
j
;

295 ià(
du_exşudes
->
ty³
 !ğ
TYPE_ARRAY
) {

296 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

297 "uÃx³ùedy³ fÜ key: ", 
CONFIG_EXCLUDE
, "array of strings");

298  
HANDLER_ERROR
;

301 
exşudes_li¡
 = ((
d©a_¬¿y
*)
du_exşudes
)->
v®ue
;

303 #iâdeà
HAVE_PCRE_H


304 ià(
exşudes_li¡
->
u£d
 > 0) {

305 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

306 "püsuµÜˆi missšg fÜ: ", 
CONFIG_EXCLUDE
, ",…lease install†ibpcre‡ndhe headers");

307  
HANDLER_ERROR
;

310 
j
 = 0; j < 
exşudes_li¡
->
u£d
; j++) {

311 
d©a_un£t
 *
du_exşude
 = 
exşudes_li¡
->
d©a
[
j
];

313 ià(
du_exşude
->
ty³
 !ğ
TYPE_STRING
) {

314 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbs",

315 "uÃx³ùedy³ fÜ key: ", 
CONFIG_EXCLUDE
, "[",

316 
du_exşude
->
key
, "](string)");

317  
HANDLER_ERROR
;

320 ià(0 !ğ
	`exşudes_bufãr_­³nd
(
s
->
exşudes
, ((
d©a_¡ršg
*)(
du_exşude
))->
v®ue
)) {

321 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

322 "püe-compçed fÜ", ((
d©a_¡ršg
*)(
du_exşude
))->
v®ue
);

323  
HANDLER_ERROR
;

329 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
show_»adme
)) {

330 ià(
	`bufãr_is_equ®_¡ršg
(
s
->
show_»adme
, 
	`CONST_STR_LEN
("enable"))) {

331 
	`bufãr_cİy_¡ršg_Ën
(
s
->
show_»adme
, 
	`CONST_STR_LEN
("README.txt"));

333 ià(
	`bufãr_is_equ®_¡ršg
(
s
->
show_»adme
, 
	`CONST_STR_LEN
("disable"))) {

334 
	`bufãr_¡ršg_£t_Ëngth
(
s
->
show_»adme
, 0);

338 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
show_h—d”
)) {

339 ià(
	`bufãr_is_equ®_¡ršg
(
s
->
show_h—d”
, 
	`CONST_STR_LEN
("enable"))) {

340 
	`bufãr_cİy_¡ršg_Ën
(
s
->
show_h—d”
, 
	`CONST_STR_LEN
("HEADER.txt"));

342 ià(
	`bufãr_is_equ®_¡ršg
(
s
->
show_h—d”
, 
	`CONST_STR_LEN
("disable"))) {

343 
	`bufãr_¡ršg_£t_Ëngth
(
s
->
show_h—d”
, 0);

348  
HANDLER_GO_ON
;

349 
	}
}

351 
	#PATCH
(
x
) \

352 
p
->
cÚf
.
x
 = 
s
->x;

	)

353 
	$mod_dœli¡šg_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

354 
size_t
 
i
, 
j
;

355 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

357 
	`PATCH
(
dœ_li¡šg
);

358 
	`PATCH
(
ex‹º®_css
);

359 
	`PATCH
(
ex‹º®_js
);

360 
	`PATCH
(
hide_dÙ_fes
);

361 
	`PATCH
(
’codšg
);

362 
	`PATCH
(
show_»adme
);

363 
	`PATCH
(
hide_»adme_fe
);

364 
	`PATCH
(
show_h—d”
);

365 
	`PATCH
(
hide_h—d”_fe
);

366 
	`PATCH
(
exşudes
);

367 
	`PATCH
(
£t_foÙ”
);

368 
	`PATCH
(
’code_»adme
);

369 
	`PATCH
(
’code_h—d”
);

370 
	`PATCH
(
auto_Ïyout
);

373 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

374 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

375 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

378 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

381 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

382 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

384 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_ACTIVATE
)) ||

385 
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_DIR_LISTING
))) {

386 
	`PATCH
(
dœ_li¡šg
);

387 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_HIDE_DOTFILES
))) {

388 
	`PATCH
(
hide_dÙ_fes
);

389 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_EXTERNAL_CSS
))) {

390 
	`PATCH
(
ex‹º®_css
);

391 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_EXTERNAL_JS
))) {

392 
	`PATCH
(
ex‹º®_js
);

393 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_ENCODING
))) {

394 
	`PATCH
(
’codšg
);

395 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_SHOW_README
))) {

396 
	`PATCH
(
show_»adme
);

397 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_HIDE_README_FILE
))) {

398 
	`PATCH
(
hide_»adme_fe
);

399 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_SHOW_HEADER
))) {

400 
	`PATCH
(
show_h—d”
);

401 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_HIDE_HEADER_FILE
))) {

402 
	`PATCH
(
hide_h—d”_fe
);

403 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_SET_FOOTER
))) {

404 
	`PATCH
(
£t_foÙ”
);

405 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_EXCLUDE
))) {

406 
	`PATCH
(
exşudes
);

407 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_ENCODE_README
))) {

408 
	`PATCH
(
’code_»adme
);

409 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_ENCODE_HEADER
))) {

410 
	`PATCH
(
’code_h—d”
);

411 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
CONFIG_AUTO_LAYOUT
))) {

412 
	`PATCH
(
auto_Ïyout
);

418 
	}
}

419 #undeà
PATCH


422 
size_t
 
	mÇm–’
;

423 
time_t
 
	mmtime
;

424 
off_t
 
	msize
;

425 } 
	tdœls_’Œy_t
;

428 
dœls_’Œy_t
 **
	m’t
;

429 
size_t
 
	mu£d
;

430 
size_t
 
	msize
;

431 } 
	tdœls_li¡_t
;

433 
	#DIRLIST_ENT_NAME
(
’t
è((*)ÓÁè+ (
dœls_’Œy_t
))

	)

434 
	#DIRLIST_BLOB_SIZE
 16

	)

437 
	$h‰p_dœls_sÜt
(
dœls_’Œy_t
 **
’t
, 
num
) {

438 
g­
 = 
num
;

439 
i
, 
j
;

440 
sw­³d
;

441 
dœls_’Œy_t
 *
tmp
;

444 
g­
 = (gap * 10) / 13;

445 ià(
g­
 == 9 || gap == 10)

446 
g­
 = 11;

447 ià(
g­
 < 1)

448 
g­
 = 1;

449 
sw­³d
 = 0;

451 
i
 = 0; i < 
num
 - 
g­
; i++) {

452 
j
 = 
i
 + 
g­
;

453 ià(
	`¡rcmp
(
	`DIRLIST_ENT_NAME
(
’t
[
i
]), DIRLIST_ENT_NAMEÓÁ[
j
])) > 0) {

454 
tmp
 = 
’t
[
i
];

455 
’t
[
i
] =ƒÁ[
j
];

456 
’t
[
j
] = 
tmp
;

457 
sw­³d
 = 1;

461 } 
g­
 > 1 || 
sw­³d
);

462 
	}
}

467 
	$h‰p_li¡_dœeùÜy_sizefmt
(*
buf
, 
size_t
 
bufsz
, 
off_t
 
size
) {

468 cÚ¡ 
un™
[] = " KMGTPE";

469 cÚ¡ *
u
 = 
un™
;

470 
»maš
;

471 
size_t
 
buæ’
;

473 ià(
size
 < 100)

474 
size
 += 99;

475 ià(
size
 < 100)

476 
size
 = 0;

479 
»maš
 = (è
size
 & 1023;

480 
size
 >>= 10;

481 
u
++;

482 ià((
size
 & (~0 ^ 1023)) == 0)

486 
»maš
 /= 100;

487 ià(
»maš
 > 9)

488 
»maš
 = 9;

489 ià(
size
 > 999) {

490 
size
 = 0;

491 
»maš
 = 9;

492 
u
++;

495 
	`li_™o¡º
(
buf
, 
bufsz
, 
size
);

496 
buæ’
 = 
	`¡¾’
(
buf
);

497 ià(
buæ’
 + 3 >ğ
bufsz
)  buflen;

498 
buf
[
buæ’
+0] = '.';

499 
buf
[
buæ’
+1] = 
»maš
 + '0';

500 
buf
[
buæ’
+2] = *
u
;

501 
buf
[
buæ’
+3] = '\0';

503  
buæ’
 + 3;

504 
	}
}

507 #ià
defšed
(
O_NONBLOCK
)

508 
	#FIFO_NONBLOCK
 
O_NONBLOCK


	)

510 
	#FIFO_NONBLOCK
 0

	)

513 
	$h‰p_li¡_dœeùÜy_šşude_fe
(
bufãr
 *
out
, bufã¸*
·th
, cÚ¡ *
şas¢ame
, 
’code
) {

514 
fd
 = 
	`İ’
(
·th
->
±r
, 
O_RDONLY
 | 
FIFO_NONBLOCK
);

515 
ssize_t
 
rd
;

516 
buf
[8192];

518 ià(-1 =ğ
fd
) ;

520 ià(
’code
) {

521 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<pre class=\""));

522 
	`bufãr_­³nd_¡ršg
(
out
, 
şas¢ame
);

523 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("\">"));

526 (
rd
 = 
	`»ad
(
fd
, 
buf
, (buf))) > 0) {

527 ià(
’code
) {

528 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
buf
, (
size_t
)
rd
, 
ENCODING_MINIMAL_XML
);

530 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
buf
, (
size_t
)
rd
);

533 
	`şo£
(
fd
);

535 ià(
’code
) {

536 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</pre>"));

538 
	}
}

542 cÚ¡ 
	gjs_sim¶e_bË_»sÜt
[] = \

652 cÚ¡ 
	gjs_sim¶e_bË_š™_sÜt
[] = \

687 
	$h‰p_dœli¡_­³nd_js_bË_»sÜt
 (
bufãr
 *
b
, 
cÚÃùiÚ
 *
cÚ
) {

688 
cŞ
 = '0';

689 
asûndšg
 = '0';

690 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
)) {

691 cÚ¡ *
qs
 = 
cÚ
->
uri
.
qu”y
->
±r
;

693 ià(
qs
[0] == 'C' && qs[1] == '=') {

694 
qs
[2]) {

695 'N': 
cŞ
 = '0'; ;

696 'M': 
cŞ
 = '1'; ;

697 'S': 
cŞ
 = '2'; ;

699 'D': 
cŞ
 = '3'; ;

703 ià(
qs
[0] == 'O' && qs[1] == '=') {

704 
qs
[2]) {

705 'A': 
asûndšg
 = '1'; ;

706 'D': 
asûndšg
 = '0'; ;

710 } (
qs
 = 
	`¡rchr
(qs, '&')) && *++qs);

713 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n<scriptype=\"text/javascript\">\n// <!--\n\n"));

714 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
js_sim¶e_bË_»sÜt
, (js_simple_table_resort)-1);

715 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
js_sim¶e_bË_š™_sÜt
, (js_simple_table_init_sort)-1);

716 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\ninit_sort("));

717 
	`bufãr_­³nd_¡ršg_Ën
(
b
, &
cŞ
, 1);

718 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(", "));

719 
	`bufãr_­³nd_¡ršg_Ën
(
b
, &
asûndšg
, 1);

720 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(");\n\n// -->\n</script>\n\n"));

721 
	}
}

723 
	$h‰p_li¡_dœeùÜy_h—d”
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
out
) {

724 
	`UNUSED
(
¤v
);

726 ià(
p
->
cÚf
.
auto_Ïyout
) {

727 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

732 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
’codšg
)) {

733 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<meta charset=\""));

734 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
p
->
cÚf
.
’codšg
);

735 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("\">\n"));

737 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<title>Index of "));

738 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
), 
ENCODING_MINIMAL_XML
);

739 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</title>\n"));

741 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
ex‹º®_css
)) {

742 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<meta‚ame=\"viewport\" content=\"initial-scale=1\">"));

743 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<link„el=\"stylesheet\"ype=\"text/css\" href=\""));

744 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
p
->
cÚf
.
ex‹º®_css
);

745 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("\">\n"));

747 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

782 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</head>\n<body>\n"));

785 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
show_h—d”
)) {

788 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
, 
cÚ
->
physiÿl
.
·th
);

789 
	`bufãr_­³nd_¦ash
(
p
->
tmp_buf
);

790 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
,…->
cÚf
.
show_h—d”
);

792 
	`h‰p_li¡_dœeùÜy_šşude_fe
(
out
, 
p
->
tmp_buf
, "h—d”",…->
cÚf
.
’code_h—d”
);

795 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<h2>Index of "));

796 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
), 
ENCODING_MINIMAL_XML
);

797 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

817 
	}
}

819 
	$h‰p_li¡_dœeùÜy_foÙ”
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
out
) {

820 
	`UNUSED
(
¤v
);

822 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

828 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
show_»adme
)) {

831 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
, 
cÚ
->
physiÿl
.
·th
);

832 
	`bufãr_­³nd_¦ash
(
p
->
tmp_buf
);

833 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
,…->
cÚf
.
show_»adme
);

835 
	`h‰p_li¡_dœeùÜy_šşude_fe
(
out
, 
p
->
tmp_buf
, "»adme",…->
cÚf
.
’code_»adme
);

838 if(
p
->
cÚf
.
auto_Ïyout
) {

840 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

844 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
£t_foÙ”
)) {

845 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
p
->
cÚf
.
£t_foÙ”
);

847 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
cÚ
->
cÚf
.
£rv”_g
);

850 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

854 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
ex‹º®_js
)) {

855 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<scriptype=\"text/javascript\" src=\""));

856 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
p
->
cÚf
.
ex‹º®_js
);

857 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("\"></script>\n"));

858 } ià(
	`bufãr_is_em±y
(
p
->
cÚf
.
ex‹º®_js
)) {

859 
	`h‰p_dœli¡_­³nd_js_bË_»sÜt
(
out
, 
cÚ
);

862 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
(

867 
	}
}

869 
	$h‰p_li¡_dœeùÜy
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
dœ
) {

870 
DIR
 *
dp
;

871 
bufãr
 *
out
;

872 
dœ’t
 *
d’t
;

873 
¡©
 
¡
;

874 *
·th
, *
·th_fe
;

875 
size_t
 
i
;

876 
hide_dÙfes
 = 
p
->
cÚf
.
hide_dÙ_fes
;

877 
dœls_li¡_t
 
dœs
, 
fes
, *
li¡
;

878 
dœls_’Œy_t
 *
tmp
;

879 
sizebuf
[("999.9K")];

880 
d©ebuf
[("2005-Jan-01 22:23:24")];

881 
size_t
 
k
;

882 cÚ¡ *
cÚ‹Á_ty³
;

883 
Çme_max
;

884 #ià
	`defšed
(
HAVE_XATTR
è|| defšed(
HAVE_EXTATTR
)

885 
©Œv®
[128];

886 
©ŒËn
;

888 #ifdeà
HAVE_LOCALTIME_R


889 
tm
m;

892 ià(
	`bufãr_¡ršg_is_em±y
(
dœ
))  -1;

894 
i
 = 
	`bufãr_¡ršg_Ëngth
(
dœ
);

896 #ifdeà
HAVE_PATHCONF


897 ià(0 >ğ(
Çme_max
 = 
	`·thcÚf
(
dœ
->
±r
, 
_PC_NAME_MAX
))) {

899 #ifdeà
NAME_MAX


900 
Çme_max
 = 
NAME_MAX
;

902 
Çme_max
 = 255;

905 #–ià
defšed
 
__WIN32


906 
Çme_max
 = 
FILENAME_MAX
;

908 
Çme_max
 = 
NAME_MAX
;

911 
·th
 = 
	`m®loc
(
i
 + 
Çme_max
 + 1);

912 
	`fÜû_as£¹
(
NULL
 !ğ
·th
);

913 
	`memıy
(
·th
, 
dœ
->
±r
, 
i
+1);

914 
·th_fe
 = 
·th
 + 
i
;

916 ià(
NULL
 =ğ(
dp
 = 
	`İ’dœ
(
·th
))) {

917 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

918 "İ’dœ faed:", 
dœ
, 
	`¡»¼Ü
(
”ºo
));

920 
	`ä“
(
·th
);

924 
dœs
.
’t
 = (
dœls_’Œy_t
**è
	`m®loc
((dœls_’Œy_t*è* 
DIRLIST_BLOB_SIZE
);

925 
	`fÜû_as£¹
(
dœs
.
’t
);

926 
dœs
.
size
 = 
DIRLIST_BLOB_SIZE
;

927 
dœs
.
u£d
 = 0;

928 
fes
.
’t
 = (
dœls_’Œy_t
**è
	`m®loc
((dœls_’Œy_t*è* 
DIRLIST_BLOB_SIZE
);

929 
	`fÜû_as£¹
(
fes
.
’t
);

930 
fes
.
size
 = 
DIRLIST_BLOB_SIZE
;

931 
fes
.
u£d
 = 0;

933 (
d’t
 = 
	`»addœ
(
dp
)è!ğ
NULL
) {

934 
exşude_m©ch
 = 0;

936 ià(
d’t
->
d_Çme
[0] == '.') {

937 ià(
hide_dÙfes
)

939 ià(
d’t
->
d_Çme
[1] == '\0')

941 ià(
d’t
->
d_Çme
[1] == '.' && dent->d_name[2] == '\0')

945 ià(
p
->
cÚf
.
hide_»adme_fe
 && !
	`bufãr_¡ršg_is_em±y
Õ->cÚf.
show_»adme
)) {

946 ià(
	`¡rcmp
(
d’t
->
d_Çme
, 
p
->
cÚf
.
show_»adme
->
±r
) == 0)

949 ià(
p
->
cÚf
.
hide_h—d”_fe
 && !
	`bufãr_¡ršg_is_em±y
Õ->cÚf.
show_h—d”
)) {

950 ià(
	`¡rcmp
(
d’t
->
d_Çme
, 
p
->
cÚf
.
show_h—d”
->
±r
) == 0)

957 #ifdeà
HAVE_PCRE_H


958 
i
 = 0; i < 
p
->
cÚf
.
exşudes
->
u£d
; i++) {

959 
n
;

960 
	#N
 10

	)

961 
ovec
[
N
 * 3];

962 
püe
 *
»gex
 = 
p
->
cÚf
.
exşudes
->
±r
[
i
]->regex;

964 ià((
n
 = 
	`püe_exec
(
»gex
, 
NULL
, 
d’t
->
d_Çme
,

965 
	`¡¾’
(
d’t
->
d_Çme
), 0, 0, 
ovec
, 3 * 
N
)) < 0) {

966 ià(
n
 !ğ
PCRE_ERROR_NOMATCH
) {

967 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

968 "executiÚƒ¼Ü whm©chšg:", 
n
);

973 
exşude_m©ch
 = 1;

978 
exşude_m©ch
 = 1;

983 ià(
exşude_m©ch
) {

988 
i
 = 
	`¡¾’
(
d’t
->
d_Çme
);

993 ià(
i
 > (
size_t
)
Çme_max
) ;

995 
	`memıy
(
·th_fe
, 
d’t
->
d_Çme
, 
i
 + 1);

996 ià(
	`¡©
(
·th
, &
¡
) != 0)

999 
li¡
 = &
fes
;

1000 ià(
	`S_ISDIR
(
¡
.
¡_mode
))

1001 
li¡
 = &
dœs
;

1003 ià(
li¡
->
u£d
 =ğli¡->
size
) {

1004 
li¡
->
size
 +ğ
DIRLIST_BLOB_SIZE
;

1005 
li¡
->
’t
 = (
dœls_’Œy_t
**è
	`»®loc
Öi¡->’t, (dœls_’Œy_t*è*†i¡->
size
);

1006 
	`fÜû_as£¹
(
li¡
->
’t
);

1009 
tmp
 = (
dœls_’Œy_t
*è
	`m®loc
((dœls_’Œy_tè+ 1 + 
i
);

1010 
tmp
->
mtime
 = 
¡
.
¡_mtime
;

1011 
tmp
->
size
 = 
¡
.
¡_size
;

1012 
tmp
->
Çm–’
 = 
i
;

1013 
	`memıy
(
	`DIRLIST_ENT_NAME
(
tmp
), 
d’t
->
d_Çme
, 
i
 + 1);

1015 
li¡
->
’t
[li¡->
u£d
++] = 
tmp
;

1017 
	`şo£dœ
(
dp
);

1019 ià(
dœs
.
u£d
è
	`h‰p_dœls_sÜt
(dœs.
’t
, dirs.used);

1021 ià(
fes
.
u£d
è
	`h‰p_dœls_sÜt
(fes.
’t
, files.used);

1023 
out
 = 
	`bufãr_š™
();

1024 
	`h‰p_li¡_dœeùÜy_h—d”
(
¤v
, 
cÚ
, 
p
, 
out
);

1027 
i
 = 0; i < 
dœs
.
u£d
; i++) {

1028 
tmp
 = 
dœs
.
’t
[
i
];

1030 #ifdeà
HAVE_LOCALTIME_R


1031 
	`loÿÉime_r
(&(
tmp
->
mtime
), &
tm
);

1032 
	`¡ráime
(
d©ebuf
, (d©ebuf), "%Y-%b-%d %H:%M:%S", &
tm
);

1034 
	`¡ráime
(
d©ebuf
, (d©ebuf), "%Y-%b-%d %H:%M:%S", 
	`loÿÉime
(&(
tmp
->
mtime
)));

1037 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<tr class=\"d\"><td class=\"n\"><a href=\""));

1038 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
	`DIRLIST_ENT_NAME
(
tmp
),mp->
Çm–’
, 
ENCODING_REL_URI_PART
);

1039 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("/\">"));

1040 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
	`DIRLIST_ENT_NAME
(
tmp
),mp->
Çm–’
, 
ENCODING_MINIMAL_XML
);

1041 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</a>/</td><td class=\"m\">"));

1042 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
d©ebuf
, (datebuf) - 1);

1043 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</td><td class=\"s\">- &nbsp;</td><td class=\"t\">Directory</td></tr>\n"));

1045 
	`ä“
(
tmp
);

1049 
i
 = 0; i < 
fes
.
u£d
; i++) {

1050 
tmp
 = 
fes
.
’t
[
i
];

1052 
cÚ‹Á_ty³
 = 
NULL
;

1053 #ià
	`defšed
(
HAVE_XATTR
)

1054 ià(
cÚ
->
cÚf
.
u£_x©Œ
) {

1055 
	`memıy
(
·th_fe
, 
	`DIRLIST_ENT_NAME
(
tmp
),mp->
Çm–’
 + 1);

1056 
©ŒËn
 = (
©Œv®
) - 1;

1057 ià(
	`©Œ_g‘
(
·th
, 
¤v
->
¤vcÚf
.
x©Œ_Çme
->
±r
, 
©Œv®
, &
©ŒËn
, 0) == 0) {

1058 
©Œv®
[
©ŒËn
] = '\0';

1059 
cÚ‹Á_ty³
 = 
©Œv®
;

1062 #–ià
	`defšed
(
HAVE_EXTATTR
)

1063 ià(
cÚ
->
cÚf
.
u£_x©Œ
) {

1064 
	`memıy
(
·th_fe
, 
	`DIRLIST_ENT_NAME
(
tmp
),mp->
Çm–’
 + 1);

1065 if(-1 !ğ(
©ŒËn
 = 
	`ex‰r_g‘_fe
(
·th
, 
EXTATTR_NAMESPACE_USER
, 
¤v
->
¤vcÚf
.
x©Œ_Çme
->
±r
, 
©Œv®
, (attrval)-1))) {

1066 
©Œv®
[
©ŒËn
] = '\0';

1067 
cÚ‹Á_ty³
 = 
©Œv®
;

1072 ià(
cÚ‹Á_ty³
 =ğ
NULL
) {

1073 
cÚ‹Á_ty³
 = "application/octet-stream";

1074 
k
 = 0; k < 
cÚ
->
cÚf
.
mim‘y³s
->
u£d
; k++) {

1075 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
cÚ
->
cÚf
.
mim‘y³s
->
d©a
[
k
];

1076 
size_t
 
ù_Ën
;

1078 ià(
	`bufãr_is_em±y
(
ds
->
key
))

1081 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
key
);

1082 ià(
tmp
->
Çm–’
 < 
ù_Ën
)

1085 ià(0 =ğ
	`¡ºÿ£cmp
(
	`DIRLIST_ENT_NAME
(
tmp
è+mp->
Çm–’
 - 
ù_Ën
, 
ds
->
key
->
±r
, ct_len)) {

1086 
cÚ‹Á_ty³
 = 
ds
->
v®ue
->
±r
;

1092 #ifdeà
HAVE_LOCALTIME_R


1093 
	`loÿÉime_r
(&(
tmp
->
mtime
), &
tm
);

1094 
	`¡ráime
(
d©ebuf
, (d©ebuf), "%Y-%b-%d %H:%M:%S", &
tm
);

1096 
	`¡ráime
(
d©ebuf
, (d©ebuf), "%Y-%b-%d %H:%M:%S", 
	`loÿÉime
(&(
tmp
->
mtime
)));

1098 
	`h‰p_li¡_dœeùÜy_sizefmt
(
sizebuf
, (sizebuf), 
tmp
->
size
);

1100 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("<tr><td class=\"n\"><a href=\""));

1101 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
	`DIRLIST_ENT_NAME
(
tmp
),mp->
Çm–’
, 
ENCODING_REL_URI_PART
);

1102 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("\">"));

1103 
	`bufãr_­³nd_¡ršg_’coded
(
out
, 
	`DIRLIST_ENT_NAME
(
tmp
),mp->
Çm–’
, 
ENCODING_MINIMAL_XML
);

1104 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</a></td><td class=\"m\">"));

1105 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
d©ebuf
, (datebuf) - 1);

1106 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</td><td class=\"s\">"));

1107 
	`bufãr_­³nd_¡ršg
(
out
, 
sizebuf
);

1108 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</td><td class=\"t\">"));

1109 
	`bufãr_­³nd_¡ršg
(
out
, 
cÚ‹Á_ty³
);

1110 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
	`CONST_STR_LEN
("</td></tr>\n"));

1112 
	`ä“
(
tmp
);

1115 
	`ä“
(
fes
.
’t
);

1116 
	`ä“
(
dœs
.
’t
);

1117 
	`ä“
(
·th
);

1119 
	`h‰p_li¡_dœeùÜy_foÙ”
(
¤v
, 
cÚ
, 
p
, 
out
);

1122 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
’codšg
)) {

1123 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/html"));

1125 
	`bufãr_cİy_¡ršg_Ën
(
p
->
cÚ‹Á_ch¬£t
, 
	`CONST_STR_LEN
("text/html; charset="));

1126 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
cÚ‹Á_ch¬£t
,…->
cÚf
.
’codšg
);

1127 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
p
->
cÚ‹Á_ch¬£t
));

1130 
cÚ
->
fe_fšished
 = 1;

1131 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
out
);

1132 
	`bufãr_ä“
(
out
);

1135 
	}
}

1139 
	$URIHANDLER_FUNC
(
mod_dœli¡šg_sub»que¡
) {

1140 
¶ugš_d©a
 *
p
 = 
p_d
;

1141 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

1143 
	`UNUSED
(
¤v
);

1146 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

1147 
HTTP_METHOD_GET
:

1148 
HTTP_METHOD_HEAD
:

1151  
HANDLER_GO_ON
;

1154 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

1156 ià(
	`bufãr_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

1157 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

1158 ià(
cÚ
->
uri
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(cÚ->uri.·thè- 1] !ğ'/'è 
HANDLER_GO_ON
;

1160 
	`mod_dœli¡šg_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1162 ià(!
p
->
cÚf
.
dœ_li¡šg
è 
HANDLER_GO_ON
;

1164 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

1165 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- handlinghe„equest‡s Dir-Listing");

1166 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI :", 
cÚ
->
uri
.
·th
);

1169 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

1170 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SB", "¡©_ÿche_g‘_’Œy faed: ", 
cÚ
->
physiÿl
.
·th
);

1171 
	`SEGFAULT
();

1174 ià(!
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)è 
HANDLER_GO_ON
;

1176 ià(
	`h‰p_li¡_dœeùÜy
(
¤v
, 
cÚ
, 
p
, cÚ->
physiÿl
.
·th
)) {

1178 
cÚ
->
h‰p_¡©us
 = 403;

1181 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

1184  
HANDLER_FINISHED
;

1185 
	}
}

1189 
mod_dœli¡šg_¶ugš_š™
(
¶ugš
 *
p
);

1190 
	$mod_dœli¡šg_¶ugš_š™
(
¶ugš
 *
p
) {

1191 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1192 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("dirlisting");

1194 
p
->
š™
 = 
mod_dœli¡šg_š™
;

1195 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_dœli¡šg_sub»que¡
;

1196 
p
->
£t_deçuÉs
 = 
mod_dœli¡šg_£t_deçuÉs
;

1197 
p
->
ş—nup
 = 
mod_dœli¡šg_ä“
;

1199 
p
->
d©a
 = 
NULL
;

1202 
	}
}

	@mod_evasive.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"»¥Ú£.h
"

8 
	~"¶ugš.h
"

10 
	~"š‘_Áİ_ÿche.h
"

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

32 
	mmax_cÚns
;

33 
	ms’t
;

34 
bufãr
 *
	mloÿtiÚ
;

35 } 
	t¶ugš_cÚfig
;

38 
	mPLUGIN_DATA
;

40 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

42 
¶ugš_cÚfig
 
	mcÚf
;

43 } 
	t¶ugš_d©a
;

45 
	$INIT_FUNC
(
mod_evasive_š™
) {

46 
¶ugš_d©a
 *
p
;

48 
p
 = 
	`ÿÎoc
(1, (*p));

50  
p
;

51 
	}
}

53 
	$FREE_FUNC
(
mod_evasive_ä“
) {

54 
¶ugš_d©a
 *
p
 = 
p_d
;

56 
	`UNUSED
(
¤v
);

58 ià(!
p
è 
HANDLER_GO_ON
;

60 ià(
p
->
cÚfig_¡Üage
) {

61 
size_t
 
i
;

62 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

63 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

65 ià(
NULL
 =ğ
s
) ;

67 
	`bufãr_ä“
(
s
->
loÿtiÚ
);

69 
	`ä“
(
s
);

71 
	`ä“
(
p
->
cÚfig_¡Üage
);

74 
	`ä“
(
p
);

76  
HANDLER_GO_ON
;

77 
	}
}

79 
	$SETDEFAULTS_FUNC
(
mod_evasive_£t_deçuÉs
) {

80 
¶ugš_d©a
 *
p
 = 
p_d
;

81 
size_t
 
i
 = 0;

83 
cÚfig_v®ues_t
 
cv
[] = {

84 { "evasive.max-cÚns-³r-", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

85 { "evasive.s’t", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

86 { "evasive.loÿtiÚ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

87 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

90 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

92 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

93 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

94 
¶ugš_cÚfig
 *
s
;

96 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

97 
s
->
max_cÚns
 = 0;

98 
s
->
s’t
 = 0;

99 
s
->
loÿtiÚ
 = 
	`bufãr_š™
();

101 
cv
[0].
de¡š©iÚ
 = &(
s
->
max_cÚns
);

102 
cv
[1].
de¡š©iÚ
 = &(
s
->
s’t
);

103 
cv
[2].
de¡š©iÚ
 = 
s
->
loÿtiÚ
;

105 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

107 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

108  
HANDLER_ERROR
;

112  
HANDLER_GO_ON
;

113 
	}
}

115 
	#PATCH
(
x
) \

116 
p
->
cÚf
.
x
 = 
s
->x;

	)

117 
	$mod_evasive_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

118 
size_t
 
i
, 
j
;

119 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

121 
	`PATCH
(
max_cÚns
);

122 
	`PATCH
(
s’t
);

123 
	`PATCH
(
loÿtiÚ
);

126 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

127 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

128 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

131 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

134 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

135 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

137 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("evasive.max-conns-per-ip"))) {

138 
	`PATCH
(
max_cÚns
);

139 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("evasive.silent"))) {

140 
	`PATCH
(
s’t
);

141 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("evasive.location"))) {

142 
	`PATCH
(
loÿtiÚ
);

148 
	}
}

149 #undeà
PATCH


151 
	$URIHANDLER_FUNC
(
mod_evasive_uri_hªdËr
) {

152 
¶ugš_d©a
 *
p
 = 
p_d
;

153 
size_t
 
cÚns_by_
 = 0;

154 
size_t
 
j
;

156 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

158 
	`mod_evasive_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

161 ià(
p
->
cÚf
.
max_cÚns
 =ğ0è 
HANDLER_GO_ON
;

163 
cÚ
->
d¡_addr
.
¶aš
.
§_çmy
) {

164 
AF_INET
:

165 #ifdeà
HAVE_IPV6


166 
AF_INET6
:

170  
HANDLER_GO_ON
;

173 
j
 = 0; j < 
¤v
->
cÚns
->
u£d
; j++) {

174 
cÚÃùiÚ
 *
c
 = 
¤v
->
cÚns
->
±r
[
j
];

179 ià(
c
->
d¡_addr
.
¶aš
.
§_çmy
 !ğ
cÚ
->dst_addr.plain.sa_family) ;

180 ià(
c
->
¡©e
 <ğ
CON_STATE_REQUEST_END
) ;

182 
cÚ
->
d¡_addr
.
¶aš
.
§_çmy
) {

183 
AF_INET
:

184 ià(
c
->
d¡_addr
.
v4
.
sš_addr
.
s_addr
 !ğ
cÚ
->dst_addr.ipv4.sin_addr.s_addr) ;

186 #ifdeà
HAVE_IPV6


187 
AF_INET6
:

188 ià(0 !ğ
	`memcmp
(
c
->
d¡_addr
.
v6
.
sš6_addr
.
s6_addr
, 
cÚ
->dst_addr.ipv6.sin6_addr.s6_addr, 16)) ;

194 
cÚns_by_
++;

196 ià(
cÚns_by_
 > 
p
->
cÚf
.
max_cÚns
) {

197 ià(!
p
->
cÚf
.
s’t
) {

198 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

199 
	`š‘_Áİ_ÿche_g‘_
(
¤v
, &(
cÚ
->
d¡_addr
)),

203 ià(!
	`bufãr_is_em±y
(
p
->
cÚf
.
loÿtiÚ
)) {

204 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("LoÿtiÚ"), 
	`CONST_BUF_LEN
(
p
->
cÚf
.
loÿtiÚ
));

205 
cÚ
->
h‰p_¡©us
 = 302;

206 
cÚ
->
fe_fšished
 = 1;

208 
cÚ
->
h‰p_¡©us
 = 403;

210 
cÚ
->
mode
 = 
DIRECT
;

211  
HANDLER_FINISHED
;

215  
HANDLER_GO_ON
;

216 
	}
}

219 
mod_evasive_¶ugš_š™
(
¶ugš
 *
p
);

220 
	$mod_evasive_¶ugš_š™
(
¶ugš
 *
p
) {

221 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

222 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("evasive");

224 
p
->
š™
 = 
mod_evasive_š™
;

225 
p
->
£t_deçuÉs
 = 
mod_evasive_£t_deçuÉs
;

226 
p
->
hªdË_uri_ş—n
 = 
mod_evasive_uri_hªdËr
;

227 
p
->
ş—nup
 = 
mod_evasive_ä“
;

229 
p
->
d©a
 = 
NULL
;

232 
	}
}

	@mod_evhost.c

1 
	~"fœ¡.h
"

3 
	~"¶ugš.h
"

4 
	~"log.h
"

5 
	~"»¥Ú£.h
"

6 
	~"¡©_ÿche.h
"

8 
	~<¡ršg.h
>

9 
	~<”ºo.h
>

10 
	~<ùy³.h
>

14 
bufãr
 *
	m·th_p›ûs_¿w
;

17 
size_t
 
	mËn
;

18 
bufãr
 **
	m·th_p›ûs
;

19 } 
	t¶ugš_cÚfig
;

22 
	mPLUGIN_DATA
;

23 
bufãr
 *
	mtmp_buf
;

25 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

26 
¶ugš_cÚfig
 
	mcÚf
;

27 } 
	t¶ugš_d©a
;

29 
	$INIT_FUNC
(
mod_evho¡_š™
) {

30 
¶ugš_d©a
 *
p
;

32 
p
 = 
	`ÿÎoc
(1, (*p));

34 
p
->
tmp_buf
 = 
	`bufãr_š™
();

36  
p
;

37 
	}
}

39 
	$FREE_FUNC
(
mod_evho¡_ä“
) {

40 
¶ugš_d©a
 *
p
 = 
p_d
;

42 
	`UNUSED
(
¤v
);

44 ià(!
p
è 
HANDLER_GO_ON
;

46 ià(
p
->
cÚfig_¡Üage
) {

47 
size_t
 
i
;

48 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

49 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

51 ià(
NULL
 =ğ
s
) ;

53 if(
s
->
·th_p›ûs
) {

54 
size_t
 
j
;

55 
j
 = 0; j < 
s
->
Ën
; j++) {

56 
	`bufãr_ä“
(
s
->
·th_p›ûs
[
j
]);

59 
	`ä“
(
s
->
·th_p›ûs
);

62 
	`bufãr_ä“
(
s
->
·th_p›ûs_¿w
);

64 
	`ä“
(
s
);

66 
	`ä“
(
p
->
cÚfig_¡Üage
);

69 
	`bufãr_ä“
(
p
->
tmp_buf
);

71 
	`ä“
(
p
);

73  
HANDLER_GO_ON
;

74 
	}
}

76 
	$mod_evho¡_·r£_·‰”n
(
¶ugš_cÚfig
 *
s
) {

77 *
±r
 = 
s
->
·th_p›ûs_¿w
->±r,*
pos
;

79 
s
->
·th_p›ûs
 = 
NULL
;

81 
pos
=
±r
;*ptr;ptr++) {

82 if(*
±r
 == '%') {

83 
size_t
 
Ën
;

84 
s
->
·th_p›ûs
 = 
	`»®loc
(s->·th_p›ûs,(s->
Ën
+2) * (*s->path_pieces));

85 
s
->
·th_p›ûs
[s->
Ën
] = 
	`bufãr_š™
();

86 
s
->
·th_p›ûs
[s->
Ën
+1] = 
	`bufãr_š™
();

89 ià(
±r
[1] =ğ'%' ||…Œ[1] =ğ'_' || 
	`light_isdig™
(ptr[1])) {

90 
Ën
 = 2;

91 } ià(
±r
[1] == '{') {

92 ià(!
	`light_isdig™
(
±r
[2]))  -1;

93 ià(
±r
[3] == '.') {

94 ià(!
	`light_isdig™
(
±r
[4]))  -1;

95 ià(
±r
[5] != '}')  -1;

96 
Ën
 = 6;

97 } ià(
±r
[3] == '}') {

98 
Ën
 = 4;

106 
	`bufãr_cİy_¡ršg_Ën
(
s
->
·th_p›ûs
[s->
Ën
],
pos
,
±r
-pos);

107 
pos
 = 
±r
 + 
Ën
;

109 
	`bufãr_cİy_¡ršg_Ën
(
s
->
·th_p›ûs
[s->
Ën
+1],
±r
,len);

110 
±r
 +ğ
Ën
 - 1;

112 
s
->
Ën
 += 2;

116 if(*
pos
 != '\0') {

117 
s
->
·th_p›ûs
 = 
	`»®loc
(s->·th_p›ûs,(s->
Ën
+1) * (*s->path_pieces));

118 
s
->
·th_p›ûs
[s->
Ën
] = 
	`bufãr_š™
();

120 
	`bufãr_cİy_¡ršg_Ën
(
s
->
·th_p›ûs
[s->
Ën
],
pos
,
±r
-pos);

122 
s
->
Ën
 += 1;

126 
	}
}

128 
	$SETDEFAULTS_FUNC
(
mod_evho¡_£t_deçuÉs
) {

129 
¶ugš_d©a
 *
p
 = 
p_d
;

130 
size_t
 
i
;

148 
cÚfig_v®ues_t
 
cv
[] = {

149 { "evho¡.·th-·‰”n", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

150 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

153 ià(!
p
è 
HANDLER_ERROR
;

155 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

157 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

158 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

159 
¶ugš_cÚfig
 *
s
;

161 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

162 
s
->
·th_p›ûs_¿w
 = 
	`bufãr_š™
();

163 
s
->
·th_p›ûs
 = 
NULL
;

164 
s
->
Ën
 = 0;

166 
cv
[0].
de¡š©iÚ
 = 
s
->
·th_p›ûs_¿w
;

168 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

170 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

171  
HANDLER_ERROR
;

174 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
·th_p›ûs_¿w
)) {

175 ià(0 !ğ
	`mod_evho¡_·r£_·‰”n
(
s
)) {

176 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "šv®idƒvho¡.·th-·‰”n:", 
s
->
·th_p›ûs_¿w
);

177  
HANDLER_ERROR
;

182  
HANDLER_GO_ON
;

183 
	}
}

194 
	$mod_evho¡_·r£_ho¡
(
cÚÃùiÚ
 *
cÚ
,
¬¿y
 *
ho¡
) {

195 *
±r
 = 
cÚ
->
uri
.
authÜ™y
->±¸+ 
	`bufãr_¡ršg_Ëngth
(con->uri.authority);

196 *
cŞÚ
 = 
±r
;

197 
fœ¡
 = 1;

198 
d©a_¡ršg
 *
ds
;

199 
i
;

202 ;
±r
 > 
cÚ
->
uri
.
authÜ™y
->ptr;ptr--) {

203 if(*
±r
 == '.') {

204 if(
fœ¡
) first = 0;

206 } if(*
±r
 == ':') {

207 
cŞÚ
 = 
±r
;

208 
fœ¡
 = 1;

212 
ds
 = 
	`d©a_¡ršg_š™
();

213 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
,
	`CONST_STR_LEN
("%0"));

216 ià(*
±r
 == '.')…tr++;

217 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
±r
, 
cŞÚ
-ptr);

219 
	`¬¿y_š£¹_unique
(
ho¡
,(
d©a_un£t
 *)
ds
);

223 ià(
cŞÚ
 !ğ
cÚ
->
uri
.
authÜ™y
->
±r
) {

224 
±r
 = 
cŞÚ
 - 1, 
i
 = 1;…Œ > 
cÚ
->
uri
.
authÜ™y
->ptr;…tr--) {

225 if(*
±r
 == '.') {

226 ià(
±r
 !ğ
cŞÚ
 - 1) {

228 
ds
 = 
	`d©a_¡ršg_š™
();

229 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
,
	`CONST_STR_LEN
("%"));

230 
	`bufãr_­³nd_št
(
ds
->
key
, 
i
++);

231 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
,
±r
+1,
cŞÚ
-ptr-1);

233 
	`¬¿y_š£¹_unique
(
ho¡
,(
d©a_un£t
 *)
ds
);

235 
cŞÚ
 = 
±r
;

240 ià(
cŞÚ
 !ğ
±r
) {

241 
ds
 = 
	`d©a_¡ršg_š™
();

242 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
,
	`CONST_STR_LEN
("%"));

243 
	`bufãr_­³nd_št
(
ds
->
key
, 
i
 );

244 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
,
±r
,
cŞÚ
-ptr);

246 
	`¬¿y_š£¹_unique
(
ho¡
,(
d©a_un£t
 *)
ds
);

251 
	}
}

253 
	#PATCH
(
x
) \

254 
p
->
cÚf
.
x
 = 
s
->x;

	)

255 
	$mod_evho¡_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

256 
size_t
 
i
, 
j
;

257 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

259 
	`PATCH
(
·th_p›ûs
);

260 
	`PATCH
(
Ën
);

263 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

264 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

265 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

268 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

271 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

272 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

274 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("evhost.path-pattern"))) {

275 
	`PATCH
(
·th_p›ûs
);

276 
	`PATCH
(
Ën
);

282 
	}
}

283 #undeà
PATCH


286 
hªdËr_t
 
	$mod_evho¡_uri_hªdËr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

287 
¶ugš_d©a
 *
p
 = 
p_d
;

288 
size_t
 
i
;

289 
¬¿y
 *
·r£d_ho¡
;

290 *
±r
;

291 
nÙ_good
 = 0;

292 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

295 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
authÜ™y
)è 
HANDLER_GO_ON
;

297 
	`mod_evho¡_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

300 ià(0 =ğ
p
->
cÚf
.
Ën
) {

301  
HANDLER_GO_ON
;

304 
·r£d_ho¡
 = 
	`¬¿y_š™
();

306 
	`mod_evho¡_·r£_ho¡
(
cÚ
, 
·r£d_ho¡
);

309 
	`bufãr_»£t
(
p
->
tmp_buf
);

311 
i
 = 0; i < 
p
->
cÚf
.
Ën
; i++) {

312 
±r
 = 
p
->
cÚf
.
·th_p›ûs
[
i
]->ptr;

313 ià(*
±r
 == '%') {

314 
d©a_¡ršg
 *
ds
;

316 ià(*(
±r
+1) == '%') {

318 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
tmp_buf
,
	`CONST_STR_LEN
("%"));

319 } ià(*(
±r
+1) == '_' ) {

321 *
cŞÚ
 = 
	`¡rchr
(
cÚ
->
uri
.
authÜ™y
->
±r
, ':');

323 if(
cŞÚ
 =ğ
NULL
) {

324 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
, 
cÚ
->
uri
.
authÜ™y
);

327 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
tmp_buf
, 
cÚ
->
uri
.
authÜ™y
->
±r
, 
cŞÚ
 - con->uri.authority->ptr);

329 } ià(
±r
[1] == '{' ) {

330 
s
[3] = "% ";

331 
s
[1] = 
±r
[2];

332 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
·r£d_ho¡
, 
s
))) {

333 ià(
±r
[3] != '.' ||…tr[4] == '0') {

334 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
, 
ds
->
v®ue
);

336 ià((
size_t
)(
±r
[4]-'0'è<ğ
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
)) {

337 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
tmp_buf
, 
ds
->
v®ue
->
±r
+(ptr[4]-'0')-1, 1);

343 } ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
·r£d_ho¡
,
p
->
cÚf
.
·th_p›ûs
[
i
]->
±r
))) {

344 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
,
ds
->
v®ue
);

349 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
,p->
cÚf
.
·th_p›ûs
[
i
]);

353 
	`bufãr_­³nd_¦ash
(
p
->
tmp_buf
);

355 
	`¬¿y_ä“
(
·r£d_ho¡
);

357 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
p
->
tmp_buf
, &
sû
)) {

358 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", 
	`¡»¼Ü
(
”ºo
), 
p
->
tmp_buf
);

359 
nÙ_good
 = 1;

360 } if(!
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)) {

361 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "nÙ‡ dœeùÜy:", 
p
->
tmp_buf
);

362 
nÙ_good
 = 1;

365 ià(!
nÙ_good
) {

366 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
p
->
tmp_buf
);

369  
HANDLER_GO_ON
;

370 
	}
}

372 
mod_evho¡_¶ugš_š™
(
¶ugš
 *
p
);

373 
	$mod_evho¡_¶ugš_š™
(
¶ugš
 *
p
) {

374 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

375 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("evhost");

376 
p
->
š™
 = 
mod_evho¡_š™
;

377 
p
->
£t_deçuÉs
 = 
mod_evho¡_£t_deçuÉs
;

378 
p
->
hªdË_doüoÙ
 = 
mod_evho¡_uri_hªdËr
;

379 
p
->
ş—nup
 = 
mod_evho¡_ä“
;

381 
p
->
d©a
 = 
NULL
;

384 
	}
}

	@mod_expire.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"»¥Ú£.h
"

8 
	~"¶ugš.h
"

9 
	~"¡©_ÿche.h
"

11 
	~<ùy³.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<time.h
>

27 
¬¿y
 *
	mexpœe_u¾
;

28 
¬¿y
 *
	mexpœe_mim‘y³s
;

29 } 
	t¶ugš_cÚfig
;

32 
	mPLUGIN_DATA
;

34 
bufãr
 *
	mexpœe_t¡mp
;

36 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

38 
¶ugš_cÚfig
 
	mcÚf
;

39 } 
	t¶ugš_d©a
;

42 
	$INIT_FUNC
(
mod_expœe_š™
) {

43 
¶ugš_d©a
 *
p
;

45 
p
 = 
	`ÿÎoc
(1, (*p));

47 
p
->
expœe_t¡mp
 = 
	`bufãr_š™
();

49 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
expœe_t¡mp
, 255);

51  
p
;

52 
	}
}

55 
	$FREE_FUNC
(
mod_expœe_ä“
) {

56 
¶ugš_d©a
 *
p
 = 
p_d
;

58 
	`UNUSED
(
¤v
);

60 ià(!
p
è 
HANDLER_GO_ON
;

62 
	`bufãr_ä“
(
p
->
expœe_t¡mp
);

64 ià(
p
->
cÚfig_¡Üage
) {

65 
size_t
 
i
;

66 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

67 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

69 ià(
NULL
 =ğ
s
) ;

71 
	`¬¿y_ä“
(
s
->
expœe_u¾
);

72 
	`¬¿y_ä“
(
s
->
expœe_mim‘y³s
);

73 
	`ä“
(
s
);

75 
	`ä“
(
p
->
cÚfig_¡Üage
);

78 
	`ä“
(
p
);

80  
HANDLER_GO_ON
;

81 
	}
}

83 
	$mod_expœe_g‘_off£t
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
expœe
, 
time_t
 *
off£t
) {

84 *
ts
;

85 
ty³
 = -1;

86 
time_t
 
»‰s
 = 0;

88 
	`UNUSED
(
p
);

98 ià(
	`bufãr_¡ršg_is_em±y
(
expœe
)) {

99 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

104 
ts
 = 
expœe
->
±r
;

106 ià(0 =ğ
	`¡ºcmp
(
ts
, "access ", 7)) {

107 
ty³
 = 0;

108 
ts
 += 7;

109 } ià(0 =ğ
	`¡ºcmp
(
ts
, "now ", 4)) {

110 
ty³
 = 0;

111 
ts
 += 4;

112 } ià(0 =ğ
	`¡ºcmp
(
ts
, "modification ", 13)) {

113 
ty³
 = 1;

114 
ts
 += 13;

117 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

118 "šv®id <ba£>:", 
ts
);

122 ià(0 =ğ
	`¡ºcmp
(
ts
, "plus ", 5)) {

124 
ts
 += 5;

129 *
¥aû
, *
”r
;

130 
num
;

132 ià(
NULL
 =ğ(
¥aû
 = 
	`¡rchr
(
ts
, ' '))) {

133 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

134 "missšg s·û‡á” <num>:", 
ts
);

138 
num
 = 
	`¡¹Ş
(
ts
, &
”r
, 10);

139 ià(*
”r
 != ' ') {

140 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

141 "missšg <ty³>‡á” <num>:", 
ts
);

145 
ts
 = 
¥aû
 + 1;

147 ià(
NULL
 !ğ(
¥aû
 = 
	`¡rchr
(
ts
, ' '))) {

148 
¦’
;

151 
¦’
 = 
¥aû
 - 
ts
;

153 ià(
¦’
 == 5 &&

154 0 =ğ
	`¡ºcmp
(
ts
, "y—rs", 
¦’
)) {

155 
num
 *= 60 * 60 * 24 * 30 * 12;

156 } ià(
¦’
 == 6 &&

157 0 =ğ
	`¡ºcmp
(
ts
, "mÚths", 
¦’
)) {

158 
num
 *= 60 * 60 * 24 * 30;

159 } ià(
¦’
 == 5 &&

160 0 =ğ
	`¡ºcmp
(
ts
, "w“ks", 
¦’
)) {

161 
num
 *= 60 * 60 * 24 * 7;

162 } ià(
¦’
 == 4 &&

163 0 =ğ
	`¡ºcmp
(
ts
, "days", 
¦’
)) {

164 
num
 *= 60 * 60 * 24;

165 } ià(
¦’
 == 5 &&

166 0 =ğ
	`¡ºcmp
(
ts
, "hours", 
¦’
)) {

167 
num
 *= 60 * 60;

168 } ià(
¦’
 == 7 &&

169 0 =ğ
	`¡ºcmp
(
ts
, "mšu‹s", 
¦’
)) {

170 
num
 *= 60;

171 } ià(
¦’
 == 7 &&

172 0 =ğ
	`¡ºcmp
(
ts
, "£cÚds", 
¦’
)) {

173 
num
 *= 1;

175 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

176 "unknowÀty³:", 
ts
);

180 
»‰s
 +ğ
num
;

182 
ts
 = 
¥aû
 + 1;

184 ià(0 =ğ
	`¡rcmp
(
ts
, "years")) {

185 
num
 *= 60 * 60 * 24 * 30 * 12;

186 } ià(0 =ğ
	`¡rcmp
(
ts
, "months")) {

187 
num
 *= 60 * 60 * 24 * 30;

188 } ià(0 =ğ
	`¡rcmp
(
ts
, "weeks")) {

189 
num
 *= 60 * 60 * 24 * 7;

190 } ià(0 =ğ
	`¡rcmp
(
ts
, "days")) {

191 
num
 *= 60 * 60 * 24;

192 } ià(0 =ğ
	`¡rcmp
(
ts
, "hours")) {

193 
num
 *= 60 * 60;

194 } ià(0 =ğ
	`¡rcmp
(
ts
, "minutes")) {

195 
num
 *= 60;

196 } ià(0 =ğ
	`¡rcmp
(
ts
, "seconds")) {

197 
num
 *= 1;

199 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

200 "unknowÀty³:", 
ts
);

204 
»‰s
 +ğ
num
;

210 ià(
off£t
 !ğ
NULL
è*off£ˆğ
»‰s
;

212  
ty³
;

213 
	}
}

218 
	$SETDEFAULTS_FUNC
(
mod_expœe_£t_deçuÉs
) {

219 
¶ugš_d©a
 *
p
 = 
p_d
;

220 
size_t
 
i
 = 0, 
k
;

222 
cÚfig_v®ues_t
 
cv
[] = {

223 { "expœe.u¾", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

224 { "expœe.mim‘y³s", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

225 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

228 ià(!
p
è 
HANDLER_ERROR
;

230 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

232 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

233 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

234 
¶ugš_cÚfig
 *
s
;

236 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

237 
s
->
expœe_u¾
 = 
	`¬¿y_š™
();

238 
s
->
expœe_mim‘y³s
 = 
	`¬¿y_š™
();

240 
cv
[0].
de¡š©iÚ
 = 
s
->
expœe_u¾
;

241 
cv
[1].
de¡š©iÚ
 = 
s
->
expœe_mim‘y³s
;

243 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

245 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

246  
HANDLER_ERROR
;

249 
k
 = 0; k < 
s
->
expœe_u¾
->
u£d
; k++) {

250 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
expœe_u¾
->
d©a
[
k
];

253 ià(-1 =ğ
	`mod_expœe_g‘_off£t
(
¤v
, 
p
, 
ds
->
v®ue
, 
NULL
)) {

254 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

255 "·rsšgƒxpœe.u¾ faed:", 
ds
->
v®ue
);

256  
HANDLER_ERROR
;

260 
k
 = 0; k < 
s
->
expœe_mim‘y³s
->
u£d
; k++) {

261 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
expœe_mim‘y³s
->
d©a
[
k
];

264 ià(-1 =ğ
	`mod_expœe_g‘_off£t
(
¤v
, 
p
, 
ds
->
v®ue
, 
NULL
)) {

265 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

266 "·rsšgƒxpœe.mim‘y³ çed:", 
ds
->
v®ue
);

267  
HANDLER_ERROR
;

273  
HANDLER_GO_ON
;

274 
	}
}

276 
	#PATCH
(
x
) \

277 
p
->
cÚf
.
x
 = 
s
->x;

	)

278 
	$mod_expœe_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

279 
size_t
 
i
, 
j
;

280 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

282 
	`PATCH
(
expœe_u¾
);

283 
	`PATCH
(
expœe_mim‘y³s
);

286 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

287 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

288 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

291 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

294 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

295 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

297 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("expire.url"))) {

298 
	`PATCH
(
expœe_u¾
);

299 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("expire.mimetypes"))) {

300 
	`PATCH
(
expœe_mim‘y³s
);

306 
	}
}

307 #undeà
PATCH


309 
	$CONNECTION_FUNC
(
mod_expœe_hªdËr
) {

310 
¶ugš_d©a
 *
p
 = 
p_d
;

311 
d©a_¡ršg
 *
ds
 = 
NULL
;

312 
size_t
 
s_Ën
;

313 
size_t
 
k
;

316 ià(
cÚ
->
h‰p_¡©us
 !ğ200 && cÚ->h‰p_¡©u !ğ206è 
HANDLER_GO_ON
;

318 iàĞ
cÚ
->
»que¡
.
h‰p_m‘hod
 !ğ
HTTP_METHOD_GET


319 && 
cÚ
->
»que¡
.
h‰p_m‘hod
 !ğ
HTTP_METHOD_HEAD
è 
HANDLER_GO_ON
;

321 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Cache-Control");

322 ià(
NULL
 !ğ
ds
 && !
	`bufãr_¡ršg_is_em±y
(ds->
v®ue
)è 
HANDLER_GO_ON
;

324 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

326 
	`mod_expœe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

328 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
);

331 
k
 = 0; k < 
p
->
cÚf
.
expœe_u¾
->
u£d
; k++) {

332 
size_t
 
ù_Ën
;

333 
ds
 = (
d©a_¡ršg
 *)
p
->
cÚf
.
expœe_u¾
->
d©a
[
k
];

334 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
key
);

336 ià(
ù_Ën
 > 
s_Ën
) ;

337 ià(
	`bufãr_is_em±y
(
ds
->
key
)) ;

339 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
, 
ds
->
key
->±r, 
ù_Ën
)) {

344 ià(
k
 =ğ
p
->
cÚf
.
expœe_u¾
->
u£d
) {

345 cÚ¡ *
mim‘y³
;

346 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "Content-Type");

347 ià(
NULL
 !ğ
ds
 && !
	`bufãr_¡ršg_is_em±y
(ds->
v®ue
)) {

348 
mim‘y³
 = 
ds
->
v®ue
->
±r
;

349 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

351 
mim‘y³
 = "";

352 
s_Ën
 = 0;

354 
k
 = 0; k < 
p
->
cÚf
.
expœe_mim‘y³s
->
u£d
; k++) {

355 
size_t
 
ù_Ën
;

356 
ds
 = (
d©a_¡ršg
 *)
p
->
cÚf
.
expœe_mim‘y³s
->
d©a
[
k
];

357 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
key
);

359 ià(
ù_Ën
 > 
s_Ën
) ;

360 ià(
	`bufãr_is_em±y
(
ds
->
key
)) ;

363 ià(
ds
->
key
->
±r
[
ù_Ën
-1] == '*') --ct_len;

365 ià(0 =ğ
	`¡ºcmp
(
mim‘y³
, 
ds
->
key
->
±r
, 
ù_Ën
)) {

369 ià(
k
 =ğ
p
->
cÚf
.
expœe_mim‘y³s
->
u£d
) {

370 
ds
 = 
NULL
;

374 ià(
NULL
 !ğ
ds
) {

375 
time_t
 
ts
, 
expœes
;

376 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

379 (è
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
);

381 
	`mod_expœe_g‘_off£t
(
¤v
, 
p
, 
ds
->
v®ue
, &
ts
)) {

384 
expœes
 = (
ts
 + 
¤v
->
cur_ts
);

392 ià(
NULL
 =ğ
sû
è 
HANDLER_GO_ON
;

394 
expœes
 = (
ts
 + 
sû
->
¡
.
¡_mtime
);

398  
HANDLER_ERROR
;

402 ià(
expœes
 < 
¤v
->
cur_ts
)ƒxpires = srv->cur_ts;

404 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
expœe_t¡mp
, 255);

405 
	`bufãr_­³nd_¡ráime
(
p
->
expœe_t¡mp
, "%a, %d %b %Y %H:%M:%S GMT", 
	`gmtime
(&(
expœes
)));

408 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Expœes"), 
	`CONST_BUF_LEN
(
p
->
expœe_t¡mp
));

411 
	`bufãr_cİy_¡ršg_Ën
(
p
->
expœe_t¡mp
, 
	`CONST_STR_LEN
("max-age="));

412 
	`bufãr_­³nd_št
(
p
->
expœe_t¡mp
, 
expœes
 - 
¤v
->
cur_ts
);

414 
	`»¥Ú£_h—d”_­³nd
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Cache-CÚŒŞ"), 
	`CONST_BUF_LEN
(
p
->
expœe_t¡mp
));

416  
HANDLER_GO_ON
;

420  
HANDLER_GO_ON
;

421 
	}
}

425 
mod_expœe_¶ugš_š™
(
¶ugš
 *
p
);

426 
	$mod_expœe_¶ugš_š™
(
¶ugš
 *
p
) {

427 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

428 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("expire");

430 
p
->
š™
 = 
mod_expœe_š™
;

431 
p
->
hªdË_»¥Ú£_¡¬t
 = 
mod_expœe_hªdËr
;

432 
p
->
£t_deçuÉs
 = 
mod_expœe_£t_deçuÉs
;

433 
p
->
ş—nup
 = 
mod_expœe_ä“
;

435 
p
->
d©a
 = 
NULL
;

438 
	}
}

	@mod_extforward.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"š‘_Áİ_ÿche.h
"

10 
	~"cÚfigfe.h
"

12 
	~<as£¹.h
>

13 
	~<ùy³.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

16 
	~<¡dio.h
>

17 
	~<Ãtš‘/š.h
>

18 
	~<”ºo.h
>

82 
¬¿y
 *
	mfÜw¬d”
;

83 
¬¿y
 *
	mh—d”s
;

84 } 
	t¶ugš_cÚfig
;

87 
	mPLUGIN_DATA
;

89 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

91 
¶ugš_cÚfig
 
	mcÚf
;

92 } 
	t¶ugš_d©a
;

98 
sock_addr
 
	m§ved_»mÙe_addr
;

99 
bufãr
 *
	m§ved_»mÙe_addr_buf
;

100 } 
	thªdËr_ùx
;

103 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
(
sock_addr
 
Şdaddr
, 
bufãr
 *
Şdaddr_buf
) {

104 
hªdËr_ùx
 * 
hùx
;

105 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

106 
hùx
->
§ved_»mÙe_addr
 = 
Şdaddr
;

107 
hùx
->
§ved_»mÙe_addr_buf
 = 
Şdaddr_buf
;

108  
hùx
;

109 
	}
}

111 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

112 
	`ä“
(
hùx
);

113 
	}
}

116 
	$INIT_FUNC
(
mod_extfÜw¬d_š™
) {

117 
¶ugš_d©a
 *
p
;

118 
p
 = 
	`ÿÎoc
(1, (*p));

119  
p
;

120 
	}
}

123 
	$FREE_FUNC
(
mod_extfÜw¬d_ä“
) {

124 
¶ugš_d©a
 *
p
 = 
p_d
;

126 
	`UNUSED
(
¤v
);

128 ià(!
p
è 
HANDLER_GO_ON
;

130 ià(
p
->
cÚfig_¡Üage
) {

131 
size_t
 
i
;

133 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

134 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

136 ià(
NULL
 =ğ
s
) ;

138 
	`¬¿y_ä“
(
s
->
fÜw¬d”
);

139 
	`¬¿y_ä“
(
s
->
h—d”s
);

141 
	`ä“
(
s
);

143 
	`ä“
(
p
->
cÚfig_¡Üage
);

147 
	`ä“
(
p
);

149  
HANDLER_GO_ON
;

150 
	}
}

154 
	$SETDEFAULTS_FUNC
(
mod_extfÜw¬d_£t_deçuÉs
) {

155 
¶ugš_d©a
 *
p
 = 
p_d
;

156 
size_t
 
i
 = 0;

158 
cÚfig_v®ues_t
 
cv
[] = {

159 { "extfÜw¬d.fÜw¬d”", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

160 { "extfÜw¬d.h—d”s", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

161 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

164 ià(!
p
è 
HANDLER_ERROR
;

166 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

168 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

169 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

170 
¶ugš_cÚfig
 *
s
;

172 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

173 
s
->
fÜw¬d”
 = 
	`¬¿y_š™
();

174 
s
->
h—d”s
 = 
	`¬¿y_š™
();

176 
cv
[0].
de¡š©iÚ
 = 
s
->
fÜw¬d”
;

177 
cv
[1].
de¡š©iÚ
 = 
s
->
h—d”s
;

179 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

181 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

182  
HANDLER_ERROR
;

186  
HANDLER_GO_ON
;

187 
	}
}

189 
	#PATCH
(
x
) \

190 
p
->
cÚf
.
x
 = 
s
->x;

	)

191 
	$mod_extfÜw¬d_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

192 
size_t
 
i
, 
j
;

193 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

195 
	`PATCH
(
fÜw¬d”
);

196 
	`PATCH
(
h—d”s
);

199 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

200 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

201 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

204 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

207 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

208 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

210 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("extforward.forwarder"))) {

211 
	`PATCH
(
fÜw¬d”
);

212 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("extforward.headers"))) {

213 
	`PATCH
(
h—d”s
);

219 
	}
}

220 #undeà
PATCH


223 
	$put_¡ršg_što_¬¿y_Ën
(
¬¿y
 *
¬y
, cÚ¡ *
¡r
, 
Ën
)

225 
d©a_¡ršg
 *
‹mpd©a
;

226 ià(
Ën
 == 0)

228 
‹mpd©a
 = 
	`d©a_¡ršg_š™
();

229 
	`bufãr_cİy_¡ršg_Ën
(
‹mpd©a
->
v®ue
,
¡r
,
Ën
);

230 
	`¬¿y_š£¹_unique
(
¬y
,(
d©a_un£t
 *)
‹mpd©a
);

231 
	}
}

235 
¬¿y
 *
	$exŒaù_fÜw¬d_¬¿y
(
bufãr
 *
pbufãr
)

237 
¬¿y
 *
»suÉ
 = 
	`¬¿y_š™
();

238 ià(!
	`bufãr_¡ršg_is_em±y
(
pbufãr
)) {

239 *
ba£
, *
cu¼
;

241 
š_¡r
 = 0;

242 
ba£
 = 
pbufãr
->
±r
, 
cu¼
 =…buffer->ptr; *curr; curr++) {

243 ià(
š_¡r
) {

244 ià((*
cu¼
 > '9' || *curr < '0') && *curr != '.' && *curr != ':' && (*curr < 'a' || *curr > 'f') && (*curr < 'A' || *curr > 'F')) {

246 
	`put_¡ršg_što_¬¿y_Ën
(
»suÉ
, 
ba£
, 
cu¼
 - base);

248 
š_¡r
 = 0;

251 ià((*
cu¼
 >= '0' && *curr <= '9') || *curr == ':' || (*curr >= 'a' && *curr <= 'f') || (*curr >= 'A' && *curr <= 'F')) {

253 
ba£
 = 
cu¼
;

254 
š_¡r
 = 1;

259 ià(
š_¡r
) {

260 
	`put_¡ršg_što_¬¿y_Ën
(
»suÉ
, 
ba£
, 
cu¼
 - base);

263  
»suÉ
;

264 
	}
}

266 
	#IP_TRUSTED
 1

	)

267 
	#IP_UNTRUSTED
 0

	)

271 
	$is_´oxy_Œu¡ed
(cÚ¡ *
¡r
, 
¶ugš_d©a
 *
p
)

273 
d©a_¡ršg
* 
®lds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
p
->
cÚf
.
fÜw¬d”
, "all");

275 ià(
®lds
) {

276 ià(
	`¡rÿ£cmp
(
®lds
->
v®ue
->
±r
, "trust") == 0) {

277  
IP_TRUSTED
;

279  
IP_UNTRUSTED
;

283  (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
p
->
cÚf
.
fÜw¬d”
, 
¡r
è? 
IP_TRUSTED
 : 
IP_UNTRUSTED
;

284 
	}
}

290 cÚ¡ *
	$Ï¡_nÙ_š_¬¿y
(
¬¿y
 *
a
, 
¶ugš_d©a
 *
p
)

292 
¬¿y
 *
fÜw¬d”
 = 
p
->
cÚf
.forwarder;

293 
i
;

295 
i
 = 
a
->
u£d
 - 1; i >= 0; i--) {

296 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
a
->
d©a
[
i
];

297 cÚ¡ *

 = 
ds
->
v®ue
->
±r
;

299 ià(!
	`¬¿y_g‘_–em’t
(
fÜw¬d”
, 

)) {

300  

;

303  
NULL
;

304 
	}
}

306 #ifdeà
HAVE_IPV6


307 
	$¡r_to_sockaddr
(
£rv”
 *
¤v
, cÚ¡ *
ho¡
, 
sock_addr
 *
sock
) {

308 
addršfo
 
hšts
, *
add¾i¡
 = 
NULL
;

309 
»suÉ
;

311 
	`mem£t
(&
hšts
, 0, (hints));

312 
sock
->
¶aš
.
§_çmy
 = 
AF_UNSPEC
;

314 #iâdeà
AI_NUMERICSERV


322 
	#AI_NUMERICSERV
 0

	)

324 
hšts
.
ai_æags
 = 
AI_NUMERICHOST
 | 
AI_NUMERICSERV
;

326 
”ºo
 = 0;

327 
»suÉ
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
add¾i¡
);

329 ià(
»suÉ
 != 0) {

330 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSSs(S)",

331 "could‚Ù…¬£ i°add»s ", 
ho¡
, " beÿu£ ", 
	`gai_¡»¼Ü
(
»suÉ
), 
	`¡»¼Ü
(
”ºo
));

332 } ià(
add¾i¡
 =ğ
NULL
) {

333 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

334 "ProbËm iÀ·rsšg i°add»s ", 
ho¡
, ": succeeded, but‚o information„eturned");

335 } 
add¾i¡
->
ai_çmy
) {

336 
AF_INET
:

337 
	`memıy
(&
sock
->
v4
, 
add¾i¡
->
ai_addr
, (sock->ipv4));

338 
	`fÜû_as£¹
(
AF_INET
 =ğ
sock
->
¶aš
.
§_çmy
);

340 
AF_INET6
:

341 
	`memıy
(&
sock
->
v6
, 
add¾i¡
->
ai_addr
, (sock->ipv6));

342 
	`fÜû_as£¹
(
AF_INET6
 =ğ
sock
->
¶aš
.
§_çmy
);

345 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSS",

346 "ProbËm iÀ·rsšg i°add»s ", 
ho¡
, ": succeeded, but unknown family");

349 
	`ä“addršfo
(
add¾i¡
);

350 
	}
}

353 
	$ş—n_cÚd_ÿche
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

354 
	`cÚfig_cÚd_ÿche_»£t_™em
(
¤v
, 
cÚ
, 
COMP_HTTP_REMOTE_IP
);

355 
	`cÚfig_cÚd_ÿche_»£t_™em
(
¤v
, 
cÚ
, 
COMP_HTTP_SCHEME
);

356 
	}
}

358 
	$URIHANDLER_FUNC
(
mod_extfÜw¬d_uri_hªdËr
) {

359 
¶ugš_d©a
 *
p
 = 
p_d
;

360 
d©a_¡ršg
 *
fÜw¬ded
 = 
NULL
;

361 #ifdeà
HAVE_IPV6


362 
b2
[
INET6_ADDRSTRLEN
 + 1];

364 cÚ¡ *
d¡_addr_¡r
 = 
NULL
;

365 
¬¿y
 *
fÜw¬d_¬¿y
 = 
NULL
;

366 cÚ¡ *
»®_»mÙe_addr
 = 
NULL
;

367 #ifdeà
HAVE_IPV6


370 ià(!
cÚ
->
»que¡
.
h—d”s
è 
HANDLER_GO_ON
;

372 
	`mod_extfÜw¬d_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

374 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

375 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

379 ià(
p
->
cÚf
.
h—d”s
->
u£d
) {

380 
d©a_¡ršg
 *
ds
;

381 
size_t
 
k
;

383 
k
 = 0; k < 
p
->
cÚf
.
h—d”s
->
u£d
; k++) {

384 
ds
 = (
d©a_¡ršg
 *è
p
->
cÚf
.
h—d”s
->
d©a
[
k
];

385 ià(
NULL
 !ğ(
fÜw¬ded
 = (
d©a_¡ršg
*è
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
ds
->
v®ue
->
±r
))) ;

388 
fÜw¬ded
 = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
,"X-Forwarded-For");

389 ià(
NULL
 =ğ
fÜw¬ded
èfÜw¬ded = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Forwarded-For");

392 ià(
NULL
 =ğ
fÜw¬ded
) {

393 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

394 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "no forward header found, skipping");

397  
HANDLER_GO_ON
;

400 #ifdeà
HAVE_IPV6


401 
d¡_addr_¡r
 = 
	`š‘_Áİ
(
cÚ
->
d¡_addr
.
¶aš
.
§_çmy
,

402 
cÚ
->
d¡_addr
.
¶aš
.
§_çmy
 =ğ
AF_INET6
 ?

403 (
sockaddr
 *)&(
cÚ
->
d¡_addr
.
v6
.
sš6_addr
) :

404 (
sockaddr
 *)&(
cÚ
->
d¡_addr
.
v4
.
sš_addr
),

405 
b2
, ( b2) - 1);

407 
d¡_addr_¡r
 = 
	`š‘_Áß
(
cÚ
->
d¡_addr
.
v4
.
sš_addr
);

411 ià(
IP_UNTRUSTED
 =ğ
	`is_´oxy_Œu¡ed
(
d¡_addr_¡r
, 
p
)) {

412 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

413 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

414 "»mÙadd»ss", 
d¡_addr_¡r
, "is NOT‡rusted…roxy, skipping");

417  
HANDLER_GO_ON
;

421 
fÜw¬d_¬¿y
 = 
	`exŒaù_fÜw¬d_¬¿y
(
fÜw¬ded
->
v®ue
);

422 
»®_»mÙe_addr
 = 
	`Ï¡_nÙ_š_¬¿y
(
fÜw¬d_¬¿y
, 
p
);

424 ià(
»®_»mÙe_addr
 !ğ
NULL
) {

425 
sock_addr
 
sock
;

426 
d©a_¡ršg
 *
fÜw¬ded_´Ùo
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "X-Forwarded-Proto");

427 
sock
.
¶aš
.
§_çmy
 = 
AF_UNSPEC
;

429 ià(
NULL
 !ğ
fÜw¬ded_´Ùo
) {

430 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
fÜw¬ded_´Ùo
->
v®ue
, 
	`CONST_STR_LEN
("https"))) {

431 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
uri
.
scheme
, 
	`CONST_STR_LEN
("https"));

432 } ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
fÜw¬ded_´Ùo
->
v®ue
, 
	`CONST_STR_LEN
("http"))) {

433 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
uri
.
scheme
, 
	`CONST_STR_LEN
("http"));

437 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

438 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "usšg‡dd»ss:", 
»®_»mÙe_addr
);

440 #ifdeà
HAVE_IPV6


441 
	`¡r_to_sockaddr
(
¤v
, 
»®_»mÙe_addr
, &
sock
);

443 
sock
.
v4
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
»®_»mÙe_addr
);

444 
sock
.
¶aš
.
§_çmy
 = (sock.
v4
.
sš_addr
.
s_addr
 =ğ0xFFFFFFFFè? 
AF_UNSPEC
 : 
AF_INET
;

446 ià(
sock
.
¶aš
.
§_çmy
 !ğ
AF_UNSPEC
) {

448 ià(
cÚ
->
¶ugš_ùx
[
p
->
id
]) {

449 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

450 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

453 
	`hªdËr_ùx_ä“
(
cÚ
->
¶ugš_ùx
[
p
->
id
]);

454 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

457 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
	`hªdËr_ùx_š™
(cÚ->
d¡_addr
, cÚ->
d¡_addr_buf
);

459 
cÚ
->
d¡_addr
 = 
sock
;

460 
cÚ
->
d¡_addr_buf
 = 
	`bufãr_š™
();

461 
	`bufãr_cİy_¡ršg
(
cÚ
->
d¡_addr_buf
, 
»®_»mÙe_addr
);

463 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

464 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

465 "·tchšg cÚ->d¡_addr_buàfÜhacûs¦og:", 
»®_»mÙe_addr
);

468 
	`ş—n_cÚd_ÿche
(
¤v
, 
cÚ
);

471 
	`¬¿y_ä“
(
fÜw¬d_¬¿y
);

474  
HANDLER_GO_ON
;

475 
	}
}

477 
	$CONNECTION_FUNC
(
mod_extfÜw¬d_»¡Üe
) {

478 
¶ugš_d©a
 *
p
 = 
p_d
;

479 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

481 ià(!
hùx
è 
HANDLER_GO_ON
;

483 
cÚ
->
d¡_addr
 = 
hùx
->
§ved_»mÙe_addr
;

484 
	`bufãr_ä“
(
cÚ
->
d¡_addr_buf
);

486 
cÚ
->
d¡_addr_buf
 = 
hùx
->
§ved_»mÙe_addr_buf
;

488 
	`hªdËr_ùx_ä“
(
hùx
);

490 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

493 
	`ş—n_cÚd_ÿche
(
¤v
, 
cÚ
);

495  
HANDLER_GO_ON
;

496 
	}
}

501 
mod_extfÜw¬d_¶ugš_š™
(
¶ugš
 *
p
);

502 
	$mod_extfÜw¬d_¶ugš_š™
(
¶ugš
 *
p
) {

503 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

504 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("extforward");

506 
p
->
š™
 = 
mod_extfÜw¬d_š™
;

507 
p
->
hªdË_uri_¿w
 = 
mod_extfÜw¬d_uri_hªdËr
;

508 
p
->
hªdË_»que¡_dÚe
 = 
mod_extfÜw¬d_»¡Üe
;

509 
p
->
cÚÃùiÚ_»£t
 = 
mod_extfÜw¬d_»¡Üe
;

510 
p
->
£t_deçuÉs
 = 
mod_extfÜw¬d_£t_deçuÉs
;

511 
p
->
ş—nup
 = 
mod_extfÜw¬d_ä“
;

513 
p
->
d©a
 = 
NULL
;

516 
	}
}

	@mod_fastcgi.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"£rv”.h
"

5 
	~"keyv®ue.h
"

6 
	~"log.h
"

8 
	~"h‰p_chunk.h
"

9 
	~"fdev’t.h
"

10 
	~"cÚÃùiÚs.h
"

11 
	~"»¥Ú£.h
"

12 
	~"jobli¡.h
"

14 
	~"¶ugš.h
"

16 
	~"š‘_Áİ_ÿche.h
"

17 
	~"¡©_ÿche.h
"

18 
	~"¡©us_couÁ”.h
"

20 
	~<sys/ty³s.h
>

21 
	~<uni¡d.h
>

22 
	~<”ºo.h
>

23 
	~<fú.h
>

24 
	~<¡ršg.h
>

25 
	~<¡dlib.h
>

26 
	~<ùy³.h
>

27 
	~<as£¹.h
>

28 
	~<sigÇl.h
>

30 #ifdeà
HAVE_FASTCGI_FASTCGI_H


31 
	~<ç¡cgi/ç¡cgi.h
>

33 #ifdeà
HAVE_FASTCGI_H


34 
	~<ç¡cgi.h
>

36 
	~"ç¡cgi.h
"

40 
	~<¡dio.h
>

42 
	~"sys-sock‘.h
"

44 #ifdeà
HAVE_SYS_UIO_H


45 
	~<sys/uio.h
>

47 #ifdeà
HAVE_SYS_WAIT_H


48 
	~<sys/wa™.h
>

60 
	sfcgi_´oc
 {

61 
size_t
 
	mid
;

62 
bufãr
 *
	munixsock‘
;

63 
	mpÜt
;

65 
bufãr
 *
	mcÚÃùiÚ_Çme
;

67 
pid_t
 
	mpid
;

70 
size_t
 
	mlßd
;

72 
size_t
 
	m»que¡s
;

73 
fcgi_´oc
 *
	m´ev
, *
	mÃxt
;

75 
time_t
 
	mdi§bËd_uÁ
;

77 
	mis_loÿl
;

80 
	mPROC_STATE_UNSET
,

81 
	mPROC_STATE_RUNNING
,

82 
	mPROC_STATE_OVERLOADED
,

84 
	mPROC_STATE_DIED_WAIT_FOR_PID
,

85 
	mPROC_STATE_DIED
,

86 
	mPROC_STATE_KILLED


87 } 
	m¡©e
;

88 } 
	tfcgi_´oc
;

92 
bufãr
 *
	mid
;

101 
fcgi_´oc
 *
	mfœ¡
;

102 
fcgi_´oc
 *
	munu£d_´ocs
;

114 
	mmax_´ocs
;

115 
size_t
 
	mnum_´ocs
;

116 
size_t
 
	maùive_´ocs
;

124 
	mdi§bË_time
;

132 
size_t
 
	mmax_»que¡s_³r_´oc
;

147 
bufãr
 *
	mho¡
;

148 
	mpÜt
;

149 
§_çmy_t
 
	mçmy
;

159 
bufãr
 *
	munixsock‘
;

169 
bufãr
 *
	mbš_·th
;

176 
¬¿y
 *
	mbš_’v
;

178 
¬¿y
 *
	mbš_’v_cİy
;

189 
bufãr
 *
	mdoüoÙ
;

198 
	mcheck_loÿl
;

207 
	mb»ak_sütf’ame_fÜ_php
;

217 
	mfix_roÙ_·th_Çme
;

224 
	mx£ndfe_®low
;

225 
¬¿y
 *
	mx£ndfe_doüoÙ
;

227 
ssize_t
 
	mlßd
;

229 
size_t
 
	mmax_id
;

235 
bufãr
 *
	m¡r_»que¡_uri
;

237 
	mkl_sigÇl
;

242 
	mli¡’_backlog
;

243 
	m»fcouÁ
;

244 } 
	tfcgi_ex‹nsiÚ_ho¡
;

266 
bufãr
 *
	mkey
;

268 
	mnÙe_is_£Á
;

269 
	mÏ¡_u£d_ndx
;

271 
fcgi_ex‹nsiÚ_ho¡
 **
	mho¡s
;

273 
size_t
 
	mu£d
;

274 
size_t
 
	msize
;

275 } 
	tfcgi_ex‹nsiÚ
;

278 
fcgi_ex‹nsiÚ
 **
	mexts
;

280 
size_t
 
	mu£d
;

281 
size_t
 
	msize
;

282 } 
	tfcgi_exts
;

286 
fcgi_exts
 *
	mexts
;

287 
fcgi_exts
 *
	mexts_auth
;

288 
fcgi_exts
 *
	mexts_»¥
;

290 
¬¿y
 *
	mext_m­pšg
;

292 
	mdebug
;

293 } 
	t¶ugš_cÚfig
;

296 **
	m±r
;

298 
size_t
 
	msize
;

299 
size_t
 
	mu£d
;

300 } 
	tch¬_¬¿y
;

304 
	mPLUGIN_DATA
;

306 
bufãr
 *
	mfcgi_’v
;

308 
bufãr
 *
	m¡©uskey
;

310 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

312 
¶ugš_cÚfig
 
	mcÚf
;

313 } 
	t¶ugš_d©a
;

317 
	mFCGI_STATE_INIT
,

318 
	mFCGI_STATE_CONNECT_DELAYED
,

319 
	mFCGI_STATE_PREPARE_WRITE
,

320 
	mFCGI_STATE_WRITE
,

321 
	mFCGI_STATE_READ


322 } 
	tfcgi_cÚÃùiÚ_¡©e_t
;

325 
fcgi_´oc
 *
	m´oc
;

326 
fcgi_ex‹nsiÚ_ho¡
 *
	mho¡
;

327 
fcgi_ex‹nsiÚ
 *
	mext
;

328 
fcgi_ex‹nsiÚ
 *
	mext_auth
;

329 
	mfcgi_mode
;

331 
fcgi_cÚÃùiÚ_¡©e_t
 
	m¡©e
;

332 
time_t
 
	m¡©e_time¡amp
;

334 
chunkqueue
 *
	mrb
;

335 
chunkqueue
 *
	mwb
;

336 
off_t
 
	mwb_»qËn
;

338 
bufãr
 *
	m»¥Ú£_h—d”
;

340 
	mfd
;

341 
	mfde_ndx
;

343 
pid_t
 
	mpid
;

344 
	mgÙ_´oc
;

345 
	m»cÚÃùs
;

347 
	m»que¡_id
;

348 
	m£nd_cÚ‹Á_body
;

350 
¶ugš_cÚfig
 
	mcÚf
;

352 
cÚÃùiÚ
 *
	m»mÙe_cÚn
;

353 
¶ugš_d©a
 *
	m¶ugš_d©a
;

354 } 
	thªdËr_ùx
;

358 
hªdËr_t
 
fcgi_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
);

360 
	$»£t_sigÇls
() {

361 #ifdeà
SIGTTOU


362 
	`sigÇl
(
SIGTTOU
, 
SIG_DFL
);

364 #ifdeà
SIGTTIN


365 
	`sigÇl
(
SIGTTIN
, 
SIG_DFL
);

367 #ifdeà
SIGTSTP


368 
	`sigÇl
(
SIGTSTP
, 
SIG_DFL
);

370 
	`sigÇl
(
SIGHUP
, 
SIG_DFL
);

371 
	`sigÇl
(
SIGPIPE
, 
SIG_DFL
);

372 
	`sigÇl
(
SIGUSR1
, 
SIG_DFL
);

373 
	}
}

375 
	$ç¡cgi_¡©us_cİy_´oúame
(
bufãr
 *
b
, 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
, 
fcgi_´oc
 *
´oc
) {

376 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("fastcgi.backend."));

377 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ho¡
->
id
);

378 ià(
´oc
) {

379 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("."));

380 
	`bufãr_­³nd_št
(
b
, 
´oc
->
id
);

382 
	}
}

384 
	$fcgi_´oc_lßd_šc
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

385 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

386 
hùx
->
´oc
->
lßd
++;

388 
	`¡©us_couÁ”_šc
(
¤v
, 
	`CONST_STR_LEN
("fastcgi.active-requests"));

390 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, hùx->
´oc
);

391 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".load"));

393 
	`¡©us_couÁ”_£t
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
), 
hùx
->
´oc
->
lßd
);

394 
	}
}

396 
	$fcgi_´oc_lßd_dec
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

397 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

398 
hùx
->
´oc
->
lßd
--;

400 
	`¡©us_couÁ”_dec
(
¤v
, 
	`CONST_STR_LEN
("fastcgi.active-requests"));

402 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, hùx->
´oc
);

403 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".load"));

405 
	`¡©us_couÁ”_£t
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
), 
hùx
->
´oc
->
lßd
);

406 
	}
}

408 
	$fcgi_ho¡_assign
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
) {

409 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

410 
hùx
->
ho¡
 = host;

411 
hùx
->
ho¡
->
lßd
++;

413 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, 
NULL
);

414 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".load"));

416 
	`¡©us_couÁ”_£t
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
), 
hùx
->
ho¡
->
lßd
);

417 
	}
}

419 
	$fcgi_ho¡_»£t
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

420 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

421 
hùx
->
ho¡
->
lßd
--;

423 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, 
NULL
);

424 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".load"));

426 
	`¡©us_couÁ”_£t
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
), 
hùx
->
ho¡
->
lßd
);

428 
hùx
->
ho¡
 = 
NULL
;

429 
	}
}

431 
	$fcgi_ho¡_di§bË
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

432 ià(
hùx
->
ho¡
->
di§bË_time
 || hùx->
´oc
->
is_loÿl
) {

433 ià(
hùx
->
´oc
->
¡©e
 =ğ
PROC_STATE_RUNNING
èhùx->
ho¡
->
aùive_´ocs
--;

434 
hùx
->
´oc
->
di§bËd_uÁ
 = 
¤v
->
cur_ts
 + hùx->
ho¡
->
di§bË_time
;

435 
hùx
->
´oc
->
¡©e
 = hùx->´oc->
is_loÿl
 ? 
PROC_STATE_DIED_WAIT_FOR_PID
 : 
PROC_STATE_DIED
;

437 ià(
hùx
->
cÚf
.
debug
) {

438 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

439 "back’d di§bËd fÜ", 
hùx
->
ho¡
->
di§bË_time
, "seconds");

442 
	}
}

444 
	$ç¡cgi_¡©us_š™
(
£rv”
 *
¤v
, 
bufãr
 *
b
, 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
, 
fcgi_´oc
 *
´oc
) {

445 
	#CLEAN
(
x
) \

446 
	`ç¡cgi_¡©us_cİy_´oúame
(
b
, 
ho¡
, 
´oc
); \

447 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(
x
)); \

448 
	`¡©us_couÁ”_£t
(
¤v
, 
	`CONST_BUF_LEN
(
b
), 0);

	)

450 
	`CLEAN
(".disabled");

451 
	`CLEAN
(".died");

452 
	`CLEAN
(".overloaded");

453 
	`CLEAN
(".connected");

454 
	`CLEAN
(".load");

456 #undeà
CLEAN


458 
	#CLEAN
(
x
) \

459 
	`ç¡cgi_¡©us_cİy_´oúame
(
b
, 
ho¡
, 
NULL
); \

460 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(
x
)); \

461 
	`¡©us_couÁ”_£t
(
¤v
, 
	`CONST_BUF_LEN
(
b
), 0);

	)

463 
	`CLEAN
(".load");

465 #undeà
CLEAN


468 
	}
}

470 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
() {

471 
hªdËr_ùx
 * 
hùx
;

473 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

474 
	`fÜû_as£¹
(
hùx
);

476 
hùx
->
fde_ndx
 = -1;

478 
hùx
->
»¥Ú£_h—d”
 = 
	`bufãr_š™
();

480 
hùx
->
»que¡_id
 = 0;

481 
hùx
->
fcgi_mode
 = 
FCGI_RESPONDER
;

482 
hùx
->
¡©e
 = 
FCGI_STATE_INIT
;

483 
hùx
->
´oc
 = 
NULL
;

485 
hùx
->
fd
 = -1;

487 
hùx
->
»cÚÃùs
 = 0;

488 
hùx
->
£nd_cÚ‹Á_body
 = 1;

490 
hùx
->
rb
 = 
	`chunkqueue_š™
();

491 
hùx
->
wb
 = 
	`chunkqueue_š™
();

492 
hùx
->
wb_»qËn
 = 0;

494  
hùx
;

495 
	}
}

497 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

499 
	`bufãr_ä“
(
hùx
->
»¥Ú£_h—d”
);

501 
	`chunkqueue_ä“
(
hùx
->
rb
);

502 
	`chunkqueue_ä“
(
hùx
->
wb
);

504 
	`ä“
(
hùx
);

505 
	}
}

507 
	$hªdËr_ùx_ş—r
(
hªdËr_ùx
 *
hùx
) {

510 
hùx
->
´oc
 = 
NULL
;

511 
hùx
->
ho¡
 = 
NULL
;

512 
hùx
->
ext
 = 
NULL
;

515 
hùx
->
fcgi_mode
 = 
FCGI_RESPONDER
;

516 
hùx
->
¡©e
 = 
FCGI_STATE_INIT
;

519 
	`chunkqueue_»£t
(
hùx
->
rb
);

520 
	`chunkqueue_»£t
(
hùx
->
wb
);

521 
hùx
->
wb_»qËn
 = 0;

523 
	`bufãr_»£t
(
hùx
->
»¥Ú£_h—d”
);

525 
hùx
->
fd
 = -1;

526 
hùx
->
fde_ndx
 = -1;

528 
hùx
->
gÙ_´oc
 = 0;

529 
hùx
->
»cÚÃùs
 = 0;

530 
hùx
->
»que¡_id
 = 0;

531 
hùx
->
£nd_cÚ‹Á_body
 = 1;

537 
	}
}

539 
fcgi_´oc
 *
	$ç¡cgi_´oûss_š™
() {

540 
fcgi_´oc
 *
f
;

542 
f
 = 
	`ÿÎoc
(1, (*f));

543 
f
->
unixsock‘
 = 
	`bufãr_š™
();

544 
f
->
cÚÃùiÚ_Çme
 = 
	`bufãr_š™
();

546 
f
->
´ev
 = 
NULL
;

547 
f
->
Ãxt
 = 
NULL
;

549  
f
;

550 
	}
}

552 
	$ç¡cgi_´oûss_ä“
(
fcgi_´oc
 *
f
) {

553 ià(!
f
) ;

555 
	`ç¡cgi_´oûss_ä“
(
f
->
Ãxt
);

557 
	`bufãr_ä“
(
f
->
unixsock‘
);

558 
	`bufãr_ä“
(
f
->
cÚÃùiÚ_Çme
);

560 
	`ä“
(
f
);

561 
	}
}

563 
fcgi_ex‹nsiÚ_ho¡
 *
	$ç¡cgi_ho¡_š™
() {

564 
fcgi_ex‹nsiÚ_ho¡
 *
f
;

566 
f
 = 
	`ÿÎoc
(1, (*f));

568 
f
->
id
 = 
	`bufãr_š™
();

569 
f
->
ho¡
 = 
	`bufãr_š™
();

570 
f
->
unixsock‘
 = 
	`bufãr_š™
();

571 
f
->
doüoÙ
 = 
	`bufãr_š™
();

572 
f
->
bš_·th
 = 
	`bufãr_š™
();

573 
f
->
bš_’v
 = 
	`¬¿y_š™
();

574 
f
->
bš_’v_cİy
 = 
	`¬¿y_š™
();

575 
f
->
¡r_»que¡_uri
 = 
	`bufãr_š™
();

576 
f
->
x£ndfe_doüoÙ
 = 
	`¬¿y_š™
();

578  
f
;

579 
	}
}

581 
	$ç¡cgi_ho¡_ä“
(
fcgi_ex‹nsiÚ_ho¡
 *
h
) {

582 ià(!
h
) ;

583 ià(
h
->
»fcouÁ
) {

584 --
h
->
»fcouÁ
;

588 
	`bufãr_ä“
(
h
->
id
);

589 
	`bufãr_ä“
(
h
->
ho¡
);

590 
	`bufãr_ä“
(
h
->
unixsock‘
);

591 
	`bufãr_ä“
(
h
->
doüoÙ
);

592 
	`bufãr_ä“
(
h
->
bš_·th
);

593 
	`bufãr_ä“
(
h
->
¡r_»que¡_uri
);

594 
	`¬¿y_ä“
(
h
->
bš_’v
);

595 
	`¬¿y_ä“
(
h
->
bš_’v_cİy
);

596 
	`¬¿y_ä“
(
h
->
x£ndfe_doüoÙ
);

598 
	`ç¡cgi_´oûss_ä“
(
h
->
fœ¡
);

599 
	`ç¡cgi_´oûss_ä“
(
h
->
unu£d_´ocs
);

601 
	`ä“
(
h
);

603 
	}
}

605 
fcgi_exts
 *
	$ç¡cgi_ex‹nsiÚs_š™
() {

606 
fcgi_exts
 *
f
;

608 
f
 = 
	`ÿÎoc
(1, (*f));

610  
f
;

611 
	}
}

613 
	$ç¡cgi_ex‹nsiÚs_ä“
(
fcgi_exts
 *
f
) {

614 
size_t
 
i
;

616 ià(!
f
) ;

618 
i
 = 0; i < 
f
->
u£d
; i++) {

619 
fcgi_ex‹nsiÚ
 *
ã
;

620 
size_t
 
j
;

622 
ã
 = 
f
->
exts
[
i
];

624 
j
 = 0; j < 
ã
->
u£d
; j++) {

625 
fcgi_ex‹nsiÚ_ho¡
 *
h
;

627 
h
 = 
ã
->
ho¡s
[
j
];

629 
	`ç¡cgi_ho¡_ä“
(
h
);

632 
	`bufãr_ä“
(
ã
->
key
);

633 
	`ä“
(
ã
->
ho¡s
);

635 
	`ä“
(
ã
);

638 
	`ä“
(
f
->
exts
);

640 
	`ä“
(
f
);

641 
	}
}

643 
	$ç¡cgi_ex‹nsiÚ_š£¹
(
fcgi_exts
 *
ext
, 
bufãr
 *
key
, 
fcgi_ex‹nsiÚ_ho¡
 *
fh
) {

644 
fcgi_ex‹nsiÚ
 *
ã
;

645 
size_t
 
i
;

649 
i
 = 0; i < 
ext
->
u£d
; i++) {

650 ià(
	`bufãr_is_equ®
(
key
, 
ext
->
exts
[
i
]->key)) {

655 ià(
i
 =ğ
ext
->
u£d
) {

657 
ã
 = 
	`ÿÎoc
(1, (*fe));

658 
	`fÜû_as£¹
(
ã
);

659 
ã
->
key
 = 
	`bufãr_š™
();

660 
ã
->
Ï¡_u£d_ndx
 = -1;

661 
	`bufãr_cİy_bufãr
(
ã
->
key
, key);

665 ià(
ext
->
size
 == 0) {

666 
ext
->
size
 = 8;

667 
ext
->
exts
 = 
	`m®loc
Óxt->
size
 * (*(ext->exts)));

668 
	`fÜû_as£¹
(
ext
->
exts
);

669 } ià(
ext
->
u£d
 =ğext->
size
) {

670 
ext
->
size
 += 8;

671 
ext
->
exts
 = 
	`»®loc
Óxt->exts,ƒxt->
size
 * (*(ext->exts)));

672 
	`fÜû_as£¹
(
ext
->
exts
);

674 
ext
->
exts
[ext->
u£d
++] = 
ã
;

676 
ã
 = 
ext
->
exts
[
i
];

679 ià(
ã
->
size
 == 0) {

680 
ã
->
size
 = 4;

681 
ã
->
ho¡s
 = 
	`m®loc
(ã->
size
 * (*(fe->hosts)));

682 
	`fÜû_as£¹
(
ã
->
ho¡s
);

683 } ià(
ã
->
size
 =ğã->
u£d
) {

684 
ã
->
size
 += 4;

685 
ã
->
ho¡s
 = 
	`»®loc
(ã->ho¡s, fe->
size
 * (*(fe->hosts)));

686 
	`fÜû_as£¹
(
ã
->
ho¡s
);

689 
ã
->
ho¡s
[ã->
u£d
++] = 
fh
;

693 
	}
}

695 
	$INIT_FUNC
(
mod_ç¡cgi_š™
) {

696 
¶ugš_d©a
 *
p
;

698 
p
 = 
	`ÿÎoc
(1, (*p));

700 
p
->
fcgi_’v
 = 
	`bufãr_š™
();

702 
p
->
¡©uskey
 = 
	`bufãr_š™
();

704  
p
;

705 
	}
}

708 
	$FREE_FUNC
(
mod_ç¡cgi_ä“
) {

709 
¶ugš_d©a
 *
p
 = 
p_d
;

711 
	`UNUSED
(
¤v
);

713 
	`bufãr_ä“
(
p
->
fcgi_’v
);

714 
	`bufãr_ä“
(
p
->
¡©uskey
);

716 ià(
p
->
cÚfig_¡Üage
) {

717 
size_t
 
i
, 
j
, 
n
;

718 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

719 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

720 
fcgi_exts
 *
exts
;

722 ià(
NULL
 =ğ
s
) ;

724 
exts
 = 
s
->exts;

726 ià(
exts
) {

727 
j
 = 0; j < 
exts
->
u£d
; j++) {

728 
fcgi_ex‹nsiÚ
 *
ex
;

730 
ex
 = 
exts
->exts[
j
];

732 
n
 = 0;‚ < 
ex
->
u£d
;‚++) {

733 
fcgi_´oc
 *
´oc
;

734 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
;

736 
ho¡
 = 
ex
->
ho¡s
[
n
];

738 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

739 ià(
´oc
->
pid
 != 0) {

740 
	`kl
(
´oc
->
pid
, 
ho¡
->
kl_sigÇl
);

743 ià(
´oc
->
is_loÿl
 &&

744 !
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

745 
	`uÆšk
(
´oc
->
unixsock‘
->
±r
);

749 
´oc
 = 
ho¡
->
unu£d_´ocs
;…roc;…roøğ´oc->
Ãxt
) {

750 ià(
´oc
->
pid
 != 0) {

751 
	`kl
(
´oc
->
pid
, 
ho¡
->
kl_sigÇl
);

753 ià(
´oc
->
is_loÿl
 &&

754 !
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

755 
	`uÆšk
(
´oc
->
unixsock‘
->
±r
);

761 
	`ç¡cgi_ex‹nsiÚs_ä“
(
s
->
exts
);

762 
	`ç¡cgi_ex‹nsiÚs_ä“
(
s
->
exts_auth
);

763 
	`ç¡cgi_ex‹nsiÚs_ä“
(
s
->
exts_»¥
);

765 
	`¬¿y_ä“
(
s
->
ext_m­pšg
);

767 
	`ä“
(
s
);

769 
	`ä“
(
p
->
cÚfig_¡Üage
);

772 
	`ä“
(
p
);

774  
HANDLER_GO_ON
;

775 
	}
}

777 
	$’v_add
(
ch¬_¬¿y
 *
’v
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

778 *
d¡
;

779 
size_t
 
i
;

781 ià(!
key
 || !
v®
)  -1;

783 
d¡
 = 
	`m®loc
(
key_Ën
 + 
v®_Ën
 + 3);

784 
	`memıy
(
d¡
, 
key
, 
key_Ën
);

785 
d¡
[
key_Ën
] = '=';

786 
	`memıy
(
d¡
 + 
key_Ën
 + 1, 
v®
, 
v®_Ën
);

787 
d¡
[
key_Ën
 + 1 + 
v®_Ën
] = '\0';

789 
i
 = 0; i < 
’v
->
u£d
; i++) {

790 ià(0 =ğ
	`¡ºcmp
(
d¡
, 
’v
->
±r
[
i
], 
key_Ën
 + 1)) {

793 
’v
->
±r
[
i
] = 
d¡
;

798 ià(
’v
->
size
 == 0) {

799 
’v
->
size
 = 16;

800 
’v
->
±r
 = 
	`m®loc
Ónv->
size
 * (*env->ptr));

801 } ià(
’v
->
size
 =ğ’v->
u£d
 + 1) {

802 
’v
->
size
 += 16;

803 
’v
->
±r
 = 
	`»®loc
Ónv->±r,ƒnv->
size
 * (*env->ptr));

806 
’v
->
±r
[’v->
u£d
++] = 
d¡
;

809 
	}
}

811 
	$·r£_bš·th
(
ch¬_¬¿y
 *
’v
, 
bufãr
 *
b
) {

812 *
¡¬t
;

813 
size_t
 
i
;

816 
¡¬t
 = 
b
->
±r
;

817 
i
 = 0; i < 
	`bufãr_¡ršg_Ëngth
(
b
); i++) {

818 
b
->
±r
[
i
]) {

823 ià(
’v
->
size
 == 0) {

824 
’v
->
size
 = 16;

825 
’v
->
±r
 = 
	`m®loc
Ónv->
size
 * (*env->ptr));

826 } ià(
’v
->
size
 =ğ’v->
u£d
) {

827 
’v
->
size
 += 16;

828 
’v
->
±r
 = 
	`»®loc
Ónv->±r,ƒnv->
size
 * (*env->ptr));

831 
b
->
±r
[
i
] = '\0';

833 
’v
->
±r
[’v->
u£d
++] = 
¡¬t
;

835 
¡¬t
 = 
b
->
±r
 + 
i
 + 1;

842 ià(
’v
->
size
 == 0) {

843 
’v
->
size
 = 16;

844 
’v
->
±r
 = 
	`m®loc
Ónv->
size
 * (*env->ptr));

845 } ià(
’v
->
size
 =ğ’v->
u£d
) {

846 
’v
->
size
 += 16;

847 
’v
->
±r
 = 
	`»®loc
Ónv->±r,ƒnv->
size
 * (*env->ptr));

851 
’v
->
±r
[’v->
u£d
++] = 
¡¬t
;

853 ià(
’v
->
size
 == 0) {

854 
’v
->
size
 = 16;

855 
’v
->
±r
 = 
	`m®loc
Ónv->
size
 * (*env->ptr));

856 } ià(
’v
->
size
 =ğ’v->
u£d
) {

857 
’v
->
size
 += 16;

858 
’v
->
±r
 = 
	`»®loc
Ónv->±r,ƒnv->
size
 * (*env->ptr));

862 
’v
->
±r
[’v->
u£d
++] = 
NULL
;

865 
	}
}

867 #ià!
defšed
(
HAVE_FORK
)

868 
	$fcgi_¥awn_cÚÃùiÚ
(
£rv”
 *
¤v
,

869 
¶ugš_d©a
 *
p
,

870 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
,

871 
fcgi_´oc
 *
´oc
) {

872 
	`UNUSED
(
¤v
);

873 
	`UNUSED
(
p
);

874 
	`UNUSED
(
ho¡
);

875 
	`UNUSED
(
´oc
);

877 
	}
}

881 
	$fcgi_¥awn_cÚÃùiÚ
(
£rv”
 *
¤v
,

882 
¶ugš_d©a
 *
p
,

883 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
,

884 
fcgi_´oc
 *
´oc
) {

885 
fcgi_fd
;

886 
¡©us
;

887 
timev®
 
tv
 = { 0, 100 * 1000 };

888 #ifdeà
HAVE_SYS_UN_H


889 
sockaddr_un
 
fcgi_addr_un
;

891 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

892 
sockaddr_š6
 
fcgi_addr_š6
;

894 
sockaddr_š
 
fcgi_addr_š
;

895 
sockaddr
 *
fcgi_addr
;

897 
sockËn_t
 
£rvËn
;

899 ià(
p
->
cÚf
.
debug
) {

900 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

901 "Ãw…roc, sock‘:", 
´oc
->
pÜt
,…roc->
unixsock‘
);

904 ià(!
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

905 #ifdeà
HAVE_SYS_UN_H


906 
	`mem£t
(&
fcgi_addr_un
, 0, (fcgi_addr_un));

907 
fcgi_addr_un
.
sun_çmy
 = 
AF_UNIX
;

908 ià(
	`bufãr_¡ršg_Ëngth
(
´oc
->
unixsock‘
è+ 1 > (
fcgi_addr_un
.
sun_·th
)) {

909 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sB",

911 
´oc
->
unixsock‘
);

914 
	`memıy
(
fcgi_addr_un
.
sun_·th
, 
´oc
->
unixsock‘
->
±r
, 
	`bufãr_¡ršg_Ëngth
(proc->unixsocket) + 1);

916 #ifdeà
SUN_LEN


917 
£rvËn
 = 
	`SUN_LEN
(&
fcgi_addr_un
);

920 
£rvËn
 = 
	`bufãr_¡ršg_Ëngth
(
´oc
->
unixsock‘
è+ 1 + (
fcgi_addr_un
.
sun_çmy
);

922 
fcgi_addr
 = (
sockaddr
 *è&
fcgi_addr_un
;

924 
	`bufãr_cİy_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
("unix:"));

925 
	`bufãr_­³nd_¡ršg_bufãr
(
´oc
->
cÚÃùiÚ_Çme
,…roc->
unixsock‘
);

928 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

932 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

933 } ià(
ho¡
->
çmy
 =ğ
AF_INET6
 && !
	`bufãr_¡ršg_is_em±y
(host->host)) {

934 
	`mem£t
(&
fcgi_addr_š6
, 0, (fcgi_addr_in6));

935 
fcgi_addr_š6
.
sš6_çmy
 = 
AF_INET6
;

936 
	`š‘_±Ú
(
AF_INET6
, 
ho¡
->ho¡->
±r
, (*è&
fcgi_addr_š6
.
sš6_addr
);

937 
fcgi_addr_š6
.
sš6_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

938 
£rvËn
 = (
fcgi_addr_š6
);

939 
fcgi_addr
 = (
sockaddr
 *è&
fcgi_addr_š6
;

942 
	`mem£t
(&
fcgi_addr_š
, 0, (fcgi_addr_in));

943 
fcgi_addr_š
.
sš_çmy
 = 
AF_INET
;

945 ià(
	`bufãr_¡ršg_is_em±y
(
ho¡
->host)) {

946 
fcgi_addr_š
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

948 
ho¡’t
 *
he
;

951 
fcgi_addr_š
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

954 ià(
NULL
 =ğ(
he
 = 
	`g‘ho¡byÇme
(
ho¡
->ho¡->
±r
))) {

955 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

957 
h_”ºo
, 
ho¡
->host);

961 ià(
he
->
h_add¹y³
 !ğ
AF_INET
) {

962 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "addr-ty³ !ğAF_INET: ", 
he
->
h_add¹y³
);

966 ià(
he
->
h_Ëngth
 !ğ(
š_addr
)) {

967 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "addr-Ëngth !ğsizeof(š_addr): ", 
he
->
h_Ëngth
);

971 
	`memıy
(&(
fcgi_addr_š
.
sš_addr
.
s_addr
), 
he
->
h_addr_li¡
[0], he->
h_Ëngth
);

974 
fcgi_addr_š
.
sš_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

975 
£rvËn
 = (
fcgi_addr_š
);

977 
fcgi_addr
 = (
sockaddr
 *è&
fcgi_addr_š
;

980 ià(
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

981 
	`bufãr_cİy_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
("tcp:"));

982 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->host)) {

983 
	`bufãr_­³nd_¡ršg_bufãr
(
´oc
->
cÚÃùiÚ_Çme
, 
ho¡
->host);

985 
	`bufãr_­³nd_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
("localhost"));

987 
	`bufãr_­³nd_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
(":"));

988 
	`bufãr_­³nd_št
(
´oc
->
cÚÃùiÚ_Çme
,…roc->
pÜt
);

991 ià(-1 =ğ(
fcgi_fd
 = 
	`fdev’t_sock‘_şÛxec
(
fcgi_addr
->
§_çmy
, 
SOCK_STREAM
, 0))) {

992 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

993 "çed:", 
	`¡»¼Ü
(
”ºo
));

997 ià(-1 =ğ
	`cÚÃù
(
fcgi_fd
, 
fcgi_addr
, 
£rvËn
)) {

999 
pid_t
 
chd
;

1000 
v®
;

1002 ià(
”ºo
 !ğ
ENOENT
 &&

1003 !
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

1004 
	`uÆšk
(
´oc
->
unixsock‘
->
±r
);

1007 
	`şo£
(
fcgi_fd
);

1010 ià(-1 =ğ(
fcgi_fd
 = 
	`fdev’t_sock‘_şÛxec
(
fcgi_addr
->
§_çmy
, 
SOCK_STREAM
, 0))) {

1011 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1012 "sock‘ faed:", 
	`¡»¼Ü
(
”ºo
));

1016 
v®
 = 1;

1017 ià(
	`£tsockİt
(
fcgi_fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
v®
, (val)) < 0) {

1018 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1019 "sock‘sockİˆçed:", 
	`¡»¼Ü
(
”ºo
));

1020 
	`şo£
(
fcgi_fd
);

1025 ià(-1 =ğ
	`bšd
(
fcgi_fd
, 
fcgi_addr
, 
£rvËn
)) {

1026 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1028 
´oc
->
cÚÃùiÚ_Çme
,

1029 
	`¡»¼Ü
(
”ºo
));

1030 
	`şo£
(
fcgi_fd
);

1034 ià(-1 =ğ
	`li¡’
(
fcgi_fd
, 
ho¡
->
li¡’_backlog
)) {

1035 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1036 "li¡’ faed:", 
	`¡»¼Ü
(
”ºo
));

1037 
	`şo£
(
fcgi_fd
);

1041 (
chd
 = 
	`fÜk
())) {

1043 
size_t
 
i
 = 0;

1044 *
c
;

1045 
ch¬_¬¿y
 
’v
;

1046 
ch¬_¬¿y
 
¬g
;

1049 
’v
.
±r
 = 
NULL
;

1050 
’v
.
size
 = 0;

1051 
’v
.
u£d
 = 0;

1053 
¬g
.
±r
 = 
NULL
;

1054 
¬g
.
size
 = 0;

1055 
¬g
.
u£d
 = 0;

1057 if(
fcgi_fd
 !ğ
FCGI_LISTENSOCK_FILENO
) {

1058 
	`dup2
(
fcgi_fd
, 
FCGI_LISTENSOCK_FILENO
);

1059 
	`şo£
(
fcgi_fd
);

1061 #ifdeà
SOCK_CLOEXEC


1063 ()
	`fú
(
fcgi_fd
, 
F_SETFD
, 0);

1067 
i
 = 3; i < 256; i++) {

1068 
	`şo£
(
i
);

1072 ià(
ho¡
->
bš_’v_cİy
->
u£d
) {

1073 
i
 = 0; i < 
ho¡
->
bš_’v_cİy
->
u£d
; i++) {

1074 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
ho¡
->
bš_’v_cİy
->
d©a
[
i
];

1075 *
ge
;

1077 ià(
NULL
 !ğ(
ge
 = 
	`g‘’v
(
ds
->
v®ue
->
±r
))) {

1078 
	`’v_add
(&
’v
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
), 
ge
, 
	`¡¾’
(ge));

1082 ** cÚ¡ 
e
 = 
’vœÚ
;

1083 
i
 = 0; 
e
[i]; ++i) {

1084 *
eq
;

1086 ià(
NULL
 !ğ(
eq
 = 
	`¡rchr
(
e
[
i
], '='))) {

1087 
	`’v_add
(&
’v
, 
e
[
i
], 
eq
 -ƒ[i],ƒq+1, 
	`¡¾’
(eq+1));

1093 
i
 = 0; i < 
ho¡
->
bš_’v
->
u£d
; i++) {

1094 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
ho¡
->
bš_’v
->
d©a
[
i
];

1096 
	`’v_add
(&
’v
, 
	`CONST_BUF_LEN
(
ds
->
key
), CONST_BUF_LEN(ds->
v®ue
));

1099 
i
 = 0; i < 
’v
.
u£d
; i++) {

1101 ià(0 =ğ
	`¡ºcmp
(
’v
.
±r
[
i
], "PHP_FCGI_CHILDREN=", ("PHP_FCGI_CHILDREN=") - 1)) ;

1105 ià(
i
 =ğ
’v
.
u£d
) {

1106 
	`’v_add
(&
’v
, 
	`CONST_STR_LEN
("PHP_FCGI_CHILDREN"), CONST_STR_LEN("1"));

1109 
’v
.
±r
[’v.
u£d
] = 
NULL
;

1111 
	`·r£_bš·th
(&
¬g
, 
ho¡
->
bš_·th
);

1115 ià(
NULL
 !ğ(
c
 = 
	`¡¼chr
(
¬g
.
±r
[0], '/'))) {

1116 *
c
 = '\0';

1119 ià(-1 =ğ
	`chdœ
(
¬g
.
±r
[0])) {

1120 *
c
 = '/';

1121 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss", "chdœ faed:", 
	`¡»¼Ü
(
”ºo
), 
¬g
.
±r
[0]);

1123 *
c
 = '/';

1126 
	`»£t_sigÇls
();

1129 
	`execve
(
¬g
.
±r
[0],‡rg.±r, 
’v
.ptr);

1134 
	`_ex™
(
”ºo
);

1140 
	`şo£
(
fcgi_fd
);

1144 
	`şo£
(
fcgi_fd
);

1147 
	`£Ëù
(0, 
NULL
, NULL, NULL, &
tv
);

1149 
	`wa™pid
(
chd
, &
¡©us
, 
WNOHANG
)) {

1155 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1156 "pid‚Ù found:", 
	`¡»¼Ü
(
”ºo
));

1159 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1160 "thç¡cgi-back’d", 
ho¡
->
bš_·th
, "failedo start:");

1162 ià(
	`WIFEXITED
(
¡©us
)) {

1163 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

1165 
	`WEXITSTATUS
(
¡©us
), 
ho¡
->
bš_·th
);

1166 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1169 } ià(
	`WIFSIGNALED
(
¡©us
)) {

1170 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1172 
	`WTERMSIG
(
¡©us
));

1174 ià(
	`WTERMSIG
(
¡©us
) == 11) {

1175 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1177 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1181 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1183 
¡©us
);

1189 
´oc
->
pid
 = 
chd
;

1190 
´oc
->
is_loÿl
 = 1;

1195 
	`şo£
(
fcgi_fd
);

1196 
´oc
->
is_loÿl
 = 0;

1197 
´oc
->
pid
 = 0;

1199 ià(
p
->
cÚf
.
debug
) {

1200 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1202 
´oc
->
cÚÃùiÚ_Çme
);

1206 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

1207 
ho¡
->
aùive_´ocs
++;

1210 
	}
}

1214 
fcgi_ex‹nsiÚ_ho¡
 * 
	$unixsock‘_is_dup
(
¶ugš_d©a
 *
p
, 
size_t
 
u£d
, 
bufãr
 *
unixsock‘
) {

1215 
size_t
 
i
, 
j
, 
n
;

1216 
i
 = 0; i < 
u£d
; ++i) {

1217 
fcgi_exts
 *
exts
 = 
p
->
cÚfig_¡Üage
[
i
]->exts;

1218 ià(
NULL
 =ğ
exts
) ;

1219 
j
 = 0; j < 
exts
->
u£d
; ++j) {

1220 
fcgi_ex‹nsiÚ
 *
ex
 = 
exts
->exts[
j
];

1221 
n
 = 0;‚ < 
ex
->
u£d
; ++n) {

1222 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
ex
->
ho¡s
[
n
];

1223 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)

1224 && 
	`bufãr_is_equ®
(
ho¡
->
unixsock‘
, unixsocket)

1225 && !
	`bufãr_¡ršg_is_em±y
(
ho¡
->
bš_·th
))

1226  
ho¡
;

1231  
NULL
;

1232 
	}
}

1234 
	$SETDEFAULTS_FUNC
(
mod_ç¡cgi_£t_deçuÉs
) {

1235 
¶ugš_d©a
 *
p
 = 
p_d
;

1236 
d©a_un£t
 *
du
;

1237 
size_t
 
i
 = 0;

1238 
bufãr
 *
fcgi_mode
 = 
	`bufãr_š™
();

1239 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
NULL
;

1241 
cÚfig_v®ues_t
 
cv
[] = {

1242 { "ç¡cgi.£rv”", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

1243 { "ç¡cgi.debug", 
NULL
, 
T_CONFIG_INT
 , 
T_CONFIG_SCOPE_CONNECTION
 },

1244 { "ç¡cgi.m­-ex‹nsiÚs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1245 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

1248 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

1250 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1251 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

1252 
¶ugš_cÚfig
 *
s
;

1254 
s
 = 
	`m®loc
((
¶ugš_cÚfig
));

1255 
s
->
exts
 = 
NULL
;

1256 
s
->
exts_auth
 = 
NULL
;

1257 
s
->
exts_»¥
 = 
NULL
;

1258 
s
->
debug
 = 0;

1259 
s
->
ext_m­pšg
 = 
	`¬¿y_š™
();

1261 
cv
[0].
de¡š©iÚ
 = 
s
->
exts
;

1262 
cv
[1].
de¡š©iÚ
 = &(
s
->
debug
);

1263 
cv
[2].
de¡š©iÚ
 = 
s
->
ext_m­pšg
;

1265 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

1267 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

1268 
”rÜ
;

1275 ià(
NULL
 !ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "fastcgi.server"))) {

1276 
size_t
 
j
;

1277 
d©a_¬¿y
 *
da
 = (d©a_¬¿y *)
du
;

1279 ià(
du
->
ty³
 !ğ
TYPE_ARRAY
) {

1280 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

1283 
”rÜ
;

1286 
s
->
exts
 = 
	`ç¡cgi_ex‹nsiÚs_š™
();

1287 
s
->
exts_auth
 = 
	`ç¡cgi_ex‹nsiÚs_š™
();

1288 
s
->
exts_»¥
 = 
	`ç¡cgi_ex‹nsiÚs_š™
();

1295 
j
 = 0; j < 
da
->
v®ue
->
u£d
; j++) {

1296 
size_t
 
n
;

1297 
d©a_¬¿y
 *
da_ext
 = (d©a_¬¿y *)
da
->
v®ue
->
d©a
[
j
];

1299 ià(
da
->
v®ue
->
d©a
[
j
]->
ty³
 !ğ
TYPE_ARRAY
) {

1300 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbs",

1302 "[", 
da
->
v®ue
->
d©a
[
j
]->
key
, "](string);ƒxpected ( \"ext\" => ( \"backend-label\" => ( \"key\" => \"value\" )))");

1304 
”rÜ
;

1319 
n
 = 0;‚ < 
da_ext
->
v®ue
->
u£d
;‚++) {

1320 
d©a_¬¿y
 *
da_ho¡
 = (d©a_¬¿y *)
da_ext
->
v®ue
->
d©a
[
n
];

1322 
cÚfig_v®ues_t
 
fcv
[] = {

1323 { "ho¡", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1324 { "doüoÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1325 { "mode", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1326 { "sock‘", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1327 { "bš-·th", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1329 { "check-loÿl", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1330 { "pÜt", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1331 { "max-´ocs", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1332 { "di§bË-time", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1334 { "bš-’vœÚm’t", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1335 { "bš-cİy-’vœÚm’t", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1337 { "brok’-sütf’ame", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1338 { "®low-x-£nd-fe", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1339 { "¡r-»que¡-uri", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1340 { "kl-sigÇl", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1341 { "fix-roÙ-süŠame", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1342 { "li¡’-backlog", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1343 { "x-£ndfe", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1344 { "x-£ndfe-doüoÙ",
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1346 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

1348 
ho¡_mode
 = 
FCGI_RESPONDER
;

1350 ià(
da_ho¡
->
ty³
 !ğ
TYPE_ARRAY
) {

1351 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssSBS",

1354 "[", 
da_ho¡
->
key
, "](string);ƒxpected ( \"ext\" => ( \"backend-label\" => ( \"key\" => \"value\" )))");

1356 
”rÜ
;

1359 
ho¡
 = 
	`ç¡cgi_ho¡_š™
();

1360 
	`bufãr_»£t
(
fcgi_mode
);

1362 
	`bufãr_cİy_bufãr
(
ho¡
->
id
, 
da_ho¡
->
key
);

1364 
ho¡
->
check_loÿl
 = 1;

1365 
ho¡
->
max_´ocs
 = 4;

1366 
ho¡
->
di§bË_time
 = 1;

1367 
ho¡
->
b»ak_sütf’ame_fÜ_php
 = 0;

1368 
ho¡
->
x£ndfe_®low
 = 0;

1369 
ho¡
->
kl_sigÇl
 = 
SIGTERM
;

1370 
ho¡
->
fix_roÙ_·th_Çme
 = 0;

1371 
ho¡
->
li¡’_backlog
 = 1024;

1372 
ho¡
->
»fcouÁ
 = 0;

1374 
fcv
[0].
de¡š©iÚ
 = 
ho¡
->host;

1375 
fcv
[1].
de¡š©iÚ
 = 
ho¡
->
doüoÙ
;

1376 
fcv
[2].
de¡š©iÚ
 = 
fcgi_mode
;

1377 
fcv
[3].
de¡š©iÚ
 = 
ho¡
->
unixsock‘
;

1378 
fcv
[4].
de¡š©iÚ
 = 
ho¡
->
bš_·th
;

1380 
fcv
[5].
de¡š©iÚ
 = &(
ho¡
->
check_loÿl
);

1381 
fcv
[6].
de¡š©iÚ
 = &(
ho¡
->
pÜt
);

1382 
fcv
[7].
de¡š©iÚ
 = &(
ho¡
->
max_´ocs
);

1383 
fcv
[8].
de¡š©iÚ
 = &(
ho¡
->
di§bË_time
);

1385 
fcv
[9].
de¡š©iÚ
 = 
ho¡
->
bš_’v
;

1386 
fcv
[10].
de¡š©iÚ
 = 
ho¡
->
bš_’v_cİy
;

1387 
fcv
[11].
de¡š©iÚ
 = &(
ho¡
->
b»ak_sütf’ame_fÜ_php
);

1388 
fcv
[12].
de¡š©iÚ
 = &(
ho¡
->
x£ndfe_®low
);

1389 
fcv
[13].
de¡š©iÚ
 = 
ho¡
->
¡r_»que¡_uri
;

1390 
fcv
[14].
de¡š©iÚ
 = &(
ho¡
->
kl_sigÇl
);

1391 
fcv
[15].
de¡š©iÚ
 = &(
ho¡
->
fix_roÙ_·th_Çme
);

1392 
fcv
[16].
de¡š©iÚ
 = &(
ho¡
->
li¡’_backlog
);

1393 
fcv
[17].
de¡š©iÚ
 = &(
ho¡
->
x£ndfe_®low
);

1394 
fcv
[18].
de¡š©iÚ
 = 
ho¡
->
x£ndfe_doüoÙ
;

1396 ià(0 !ğ
	`cÚfig_š£¹_v®ues_š‹º®
(
¤v
, 
da_ho¡
->
v®ue
, 
fcv
, 
T_CONFIG_SCOPE_CONNECTION
)) {

1397 
”rÜ
;

1400 ià((!
	`bufãr_¡ršg_is_em±y
(
ho¡
->ho¡è|| ho¡->
pÜt
) &&

1401 !
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)) {

1402 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbsbs",

1404 
da
->
key
, "= (",

1405 
da_ext
->
key
, " => (",

1406 
da_ho¡
->
key
, " ( ...");

1408 
”rÜ
;

1411 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)) {

1413 
sockaddr_un
 
un
;

1415 ià(
	`bufãr_¡ršg_Ëngth
(
ho¡
->
unixsock‘
è+ 1 > (
un
.
sun_·th
) - 2) {

1416 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbsbs",

1418 
da
->
key
, "= (",

1419 
da_ext
->
key
, " => (",

1420 
da_ho¡
->
key
, " ( ...");

1422 
”rÜ
;

1425 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
bš_·th
)) {

1426 
fcgi_ex‹nsiÚ_ho¡
 *
du¶iÿ‹
 = 
	`unixsock‘_is_dup
(
p
, 
i
+1, 
ho¡
->
unixsock‘
);

1427 ià(
NULL
 !ğ
du¶iÿ‹
) {

1428 ià(!
	`bufãr_is_equ®
(
ho¡
->
bš_·th
, 
du¶iÿ‹
->bin_path)) {

1429 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1431 
ho¡
->
unixsock‘
);

1432 
”rÜ
;

1434 
	`ç¡cgi_ho¡_ä“
(
ho¡
);

1435 
ho¡
 = 
du¶iÿ‹
;

1436 ++
ho¡
->
»fcouÁ
;

1440 
ho¡
->
çmy
 = 
AF_UNIX
;

1444 ià(
	`bufãr_¡ršg_is_em±y
(
ho¡
->host) &&

1445 
	`bufãr_¡ršg_is_em±y
(
ho¡
->
bš_·th
)) {

1446 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbsbs",

1448 
da
->
key
, "= (",

1449 
da_ext
->
key
, " => (",

1450 
da_ho¡
->
key
, " ( ...");

1452 
”rÜ
;

1453 } ià(
ho¡
->
pÜt
 == 0) {

1454 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbsbs",

1456 
da
->
key
, "= (",

1457 
da_ext
->
key
, " => (",

1458 
da_ho¡
->
key
, " ( ...");

1460 
”rÜ
;

1463 
ho¡
->
çmy
 = (!
	`bufãr_¡ršg_is_em±y
(ho¡->ho¡è&& 
NULL
 !ğ
	`¡rchr
(ho¡->ho¡->
±r
, ':')è? 
AF_INET6
 : 
AF_INET
;

1466 ià(
ho¡
->
»fcouÁ
) {

1468 } ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
bš_·th
)) {

1470 
size_t
 
²o
;

1472 
¡©
 
¡
;

1473 
size_t
 
nch¬s
 = 
	`¡rc¥n
(
ho¡
->
bš_·th
->
±r
, " \t");

1474 
c
 = 
ho¡
->
bš_·th
->
±r
[
nch¬s
];

1475 
ho¡
->
bš_·th
->
±r
[
nch¬s
] = '\0';

1476 ià(0 =ğ
nch¬s
 || 0 !ğ
	`¡©
(
ho¡
->
bš_·th
->
±r
, &
¡
è|| !
	`S_ISREG
(¡.
¡_mode
è|| !(¡.¡_mod& (
S_IXUSR
 | 
S_IXGRP
 | 
S_IXOTH
))) {

1477 
ho¡
->
bš_·th
->
±r
[
nch¬s
] = 
c
;

1478 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSs",

1479 "šv®id \"bš-·th\" => \"", 
ho¡
->
bš_·th
->
±r
,

1482 
ho¡
->
bš_·th
->
±r
[
nch¬s
] = 
c
;

1484 ià(
s
->
debug
) {

1485 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsdsbsd",

1487 "\n\roc:", 
ho¡
->
bš_·th
,

1488 "\n\Üt:", 
ho¡
->
pÜt
,

1489 "\n\tsock‘", 
ho¡
->
unixsock‘
,

1490 "\n\tmax-´ocs:", 
ho¡
->
max_´ocs
);

1493 
²o
 = 0;…nØ< 
ho¡
->
max_´ocs
;…no++) {

1494 
fcgi_´oc
 *
´oc
;

1496 
´oc
 = 
	`ç¡cgi_´oûss_š™
();

1497 
´oc
->
id
 = 
ho¡
->
num_´ocs
++;

1498 
ho¡
->
max_id
++;

1500 ià(
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)) {

1501 
´oc
->
pÜt
 = 
ho¡
->pÜˆ+ 
²o
;

1503 
	`bufãr_cİy_bufãr
(
´oc
->
unixsock‘
, 
ho¡
->unixsocket);

1504 
	`bufãr_­³nd_¡ršg_Ën
(
´oc
->
unixsock‘
, 
	`CONST_STR_LEN
("-"));

1505 
	`bufãr_­³nd_št
(
´oc
->
unixsock‘
, 
²o
);

1508 ià(
s
->
debug
) {

1509 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsbsdsd",

1511 "\n\Üt:", 
ho¡
->
pÜt
,

1512 "\n\tsock‘", 
ho¡
->
unixsock‘
,

1513 "\n\tcu¼’t:", 
²o
, "/", 
ho¡
->
max_´ocs
);

1516 ià(!
¤v
->
¤vcÚf
.
´eæight_check


1517 && 
	`fcgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
ho¡
, 
´oc
)) {

1518 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1520 
	`ç¡cgi_´oûss_ä“
(
´oc
);

1521 
”rÜ
;

1524 
	`ç¡cgi_¡©us_š™
(
¤v
, 
p
->
¡©uskey
, 
ho¡
, 
´oc
);

1526 
´oc
->
Ãxt
 = 
ho¡
->
fœ¡
;

1527 ià(
ho¡
->
fœ¡
èho¡->fœ¡->
´ev
 = 
´oc
;

1529 
ho¡
->
fœ¡
 = 
´oc
;

1532 
fcgi_´oc
 *
´oc
;

1534 
´oc
 = 
	`ç¡cgi_´oûss_š™
();

1535 
´oc
->
id
 = 
ho¡
->
num_´ocs
++;

1536 
ho¡
->
max_id
++;

1537 
ho¡
->
aùive_´ocs
++;

1538 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

1540 ià(
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)) {

1541 
´oc
->
pÜt
 = 
ho¡
->port;

1543 
	`bufãr_cİy_bufãr
(
´oc
->
unixsock‘
, 
ho¡
->unixsocket);

1546 
	`ç¡cgi_¡©us_š™
(
¤v
, 
p
->
¡©uskey
, 
ho¡
, 
´oc
);

1548 
ho¡
->
fœ¡
 = 
´oc
;

1550 
ho¡
->
max_´ocs
 = 1;

1553 ià(!
	`bufãr_¡ršg_is_em±y
(
fcgi_mode
)) {

1554 ià(
	`¡rcmp
(
fcgi_mode
->
±r
, "responder") == 0) {

1555 
ho¡_mode
 = 
FCGI_RESPONDER
;

1556 } ià(
	`¡rcmp
(
fcgi_mode
->
±r
, "authorizer") == 0) {

1557 
ho¡_mode
 = 
FCGI_AUTHORIZER
;

1559 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1561 
fcgi_mode
, "(ignored, mode seto„esponder)");

1565 ià(
ho¡
->
x£ndfe_doüoÙ
->
u£d
) {

1566 
size_t
 
k
;

1567 
k
 = 0; k < 
ho¡
->
x£ndfe_doüoÙ
->
u£d
; ++k) {

1568 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
ho¡
->
x£ndfe_doüoÙ
->
d©a
[
k
];

1569 ià(
ds
->
ty³
 !ğ
TYPE_STRING
) {

1570 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1572 
”rÜ
;

1574 ià(
ds
->
v®ue
->
±r
[0] != '/') {

1575 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBs",

1576 "x-£ndfe-doüoÙ…©h mu¡ begš w™h '/'; inv®id: \"", 
ds
->
v®ue
, "\"");

1577 
”rÜ
;

1579 
	`bufãr_·th_sim¶ify
(
ds
->
v®ue
, ds->value);

1580 
	`bufãr_­³nd_¦ash
(
ds
->
v®ue
);

1594 
	`ç¡cgi_ex‹nsiÚ_š£¹
(
s
->
exts
, 
da_ext
->
key
, 
ho¡
);

1596 ià(
ho¡_mode
 =ğ
FCGI_AUTHORIZER
) {

1597 ++
ho¡
->
»fcouÁ
;

1598 
	`ç¡cgi_ex‹nsiÚ_š£¹
(
s
->
exts_auth
, 
da_ext
->
key
, 
ho¡
);

1599 } ià(
ho¡_mode
 =ğ
FCGI_RESPONDER
) {

1600 ++
ho¡
->
»fcouÁ
;

1601 
	`ç¡cgi_ex‹nsiÚ_š£¹
(
s
->
exts_»¥
, 
da_ext
->
key
, 
ho¡
);

1604 
ho¡
 = 
NULL
;

1610 
	`bufãr_ä“
(
fcgi_mode
);

1611  
HANDLER_GO_ON
;

1613 
”rÜ
:

1614 ià(
NULL
 !ğ
ho¡
è
	`ç¡cgi_ho¡_ä“
(host);

1615 
	`bufãr_ä“
(
fcgi_mode
);

1616  
HANDLER_ERROR
;

1617 
	}
}

1619 
	$fcgi_£t_¡©e
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
fcgi_cÚÃùiÚ_¡©e_t
 
¡©e
) {

1620 
hùx
->
¡©e
 = state;

1621 
hùx
->
¡©e_time¡amp
 = 
¤v
->
cur_ts
;

1624 
	}
}

1627 
	$fcgi_back’d_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1628 ià(
hùx
->
fd
 != -1) {

1629 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
);

1630 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
hùx
->
fd
);

1631 
	`fdev’t_sched_şo£
(
¤v
->
ev
, 
hùx
->
fd
, 1);

1632 
hùx
->
fd
 = -1;

1633 
hùx
->
fde_ndx
 = -1;

1636 ià(
hùx
->
ho¡
) {

1637 ià(
hùx
->
´oc
 && hùx->
gÙ_´oc
) {

1639 
	`fcgi_´oc_lßd_dec
(
¤v
, 
hùx
);

1641 ià(
hùx
->
cÚf
.
debug
) {

1642 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsbsd",

1644 "pid:", 
hùx
->
´oc
->
pid
,

1645 "sock‘:", 
hùx
->
´oc
->
cÚÃùiÚ_Çme
,

1646 "lßd:", 
hùx
->
´oc
->
lßd
);

1650 
	`fcgi_ho¡_»£t
(
¤v
, 
hùx
);

1652 
	}
}

1654 
fcgi_ex‹nsiÚ_ho¡
 * 
	$fcgi_ex‹nsiÚ_ho¡_g‘
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
fcgi_ex‹nsiÚ
 *
ex‹nsiÚ
) {

1655 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
;

1656 
ndx
 = 
ex‹nsiÚ
->
Ï¡_u£d_ndx
 + 1;

1657 ià(
ndx
 >ğ(è
ex‹nsiÚ
->
u£d
 ||‚dx < 0)‚dx = 0;

1658 
	`UNUSED
(
p
);

1661 
ho¡
 = 
ex‹nsiÚ
->
ho¡s
[
ndx
];

1662 ià(
ho¡
->
lßd
 > 0 || ho¡->
aùive_´ocs
 == 0) {

1664 
size_t
 
k
;

1665 
u£d
 = -1;

1666 
k
 = 0, 
ndx
 = -1; k < 
ex‹nsiÚ
->
u£d
; k++) {

1667 
ho¡
 = 
ex‹nsiÚ
->
ho¡s
[
k
];

1670 ià(
ho¡
->
aùive_´ocs
 == 0) ;

1672 ià(
u£d
 =ğ-1 || 
ho¡
->
lßd
 < used) {

1673 
u£d
 = 
ho¡
->
lßd
;

1674 
ndx
 = 
k
;

1679 ià(
ndx
 == -1) {

1682 
cÚ
->
h‰p_¡©us
 = 503;

1683 
cÚ
->
mode
 = 
DIRECT
;

1686 ià(!
ex‹nsiÚ
->
nÙe_is_£Á
) {

1687 
ex‹nsiÚ
->
nÙe_is_£Á
 = 1;

1689 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sBSbsbs",

1690 "®ÈhªdËr fÜ", 
cÚ
->
uri
.
·th
, "?", cÚ->uri.
qu”y
,

1691 "Ú", 
ex‹nsiÚ
->
key
,

1695  
NULL
;

1699 
ex‹nsiÚ
->
Ï¡_u£d_ndx
 = 
ndx
;

1700  
ex‹nsiÚ
->
ho¡s
[
ndx
];

1701 
	}
}

1703 
	$fcgi_cÚÃùiÚ_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1704 
¶ugš_d©a
 *
p
;

1705 
cÚÃùiÚ
 *
cÚ
;

1707 
p
 = 
hùx
->
¶ugš_d©a
;

1708 
cÚ
 = 
hùx
->
»mÙe_cÚn
;

1710 
	`fcgi_back’d_şo£
(
¤v
, 
hùx
);

1711 
	`hªdËr_ùx_ä“
(
hùx
);

1712 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

1715 ià(
cÚ
->
mode
 =ğ
p
->
id
) {

1716 
	`h‰p_»¥Ú£_back’d_dÚe
(
¤v
, 
cÚ
);

1718 
	}
}

1720 
hªdËr_t
 
	$fcgi_»cÚÃù
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1721 
	`fcgi_back’d_şo£
(
¤v
, 
hùx
);

1723 
hùx
->
ho¡
 = 
	`fcgi_ex‹nsiÚ_ho¡_g‘
(
¤v
, hùx->
»mÙe_cÚn
, hùx->
¶ugš_d©a
, hùx->
ext
);

1724 ià(
NULL
 =ğ
hùx
->
ho¡
è 
HANDLER_FINISHED
;

1726 
	`fcgi_ho¡_assign
(
¤v
, 
hùx
, hùx->
ho¡
);

1727 
hùx
->
»que¡_id
 = 0;

1728 
	`fcgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_INIT
);

1729  
HANDLER_COMEBACK
;

1730 
	}
}

1733 
hªdËr_t
 
	$fcgi_cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

1734 
¶ugš_d©a
 *
p
 = 
p_d
;

1735 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1736 ià(
hùx
è
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, hctx);

1738  
HANDLER_GO_ON
;

1739 
	}
}

1742 
	$fcgi_’v_add
(*
v’v
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

1743 
bufãr
 *
’v
 = 
v’v
;

1744 
size_t
 
Ën
;

1745 
Ën_’c
[8];

1746 
size_t
 
Ën_’c_Ën
 = 0;

1748 ià(!
key
 || !
v®
)  -1;

1750 
Ën
 = 
key_Ën
 + 
v®_Ën
;

1752 
Ën
 +ğ
key_Ën
 > 127 ? 4 : 1;

1753 
Ën
 +ğ
v®_Ën
 > 127 ? 4 : 1;

1755 ià(
	`bufãr_¡ršg_Ëngth
(
’v
è+ 
Ën
 >ğ
FCGI_MAX_LENGTH
) {

1767 
	`fÜû_as£¹
(
key_Ën
 < 0x7fffffffu);

1768 
	`fÜû_as£¹
(
v®_Ën
 < 0x7fffffffu);

1770 
	`bufãr_¡ršg_´•¬e_­³nd
(
’v
, 
Ën
);

1772 ià(
key_Ën
 > 127) {

1773 
Ën_’c
[
Ën_’c_Ën
++] = ((
key_Ën
 >> 24) & 0xff) | 0x80;

1774 
Ën_’c
[
Ën_’c_Ën
++] = (
key_Ën
 >> 16) & 0xff;

1775 
Ën_’c
[
Ën_’c_Ën
++] = (
key_Ën
 >> 8) & 0xff;

1776 
Ën_’c
[
Ën_’c_Ën
++] = (
key_Ën
 >> 0) & 0xff;

1778 
Ën_’c
[
Ën_’c_Ën
++] = (
key_Ën
 >> 0) & 0xff;

1781 ià(
v®_Ën
 > 127) {

1782 
Ën_’c
[
Ën_’c_Ën
++] = ((
v®_Ën
 >> 24) & 0xff) | 0x80;

1783 
Ën_’c
[
Ën_’c_Ën
++] = (
v®_Ën
 >> 16) & 0xff;

1784 
Ën_’c
[
Ën_’c_Ën
++] = (
v®_Ën
 >> 8) & 0xff;

1785 
Ën_’c
[
Ën_’c_Ën
++] = (
v®_Ën
 >> 0) & 0xff;

1787 
Ën_’c
[
Ën_’c_Ën
++] = (
v®_Ën
 >> 0) & 0xff;

1790 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
Ën_’c
, 
Ën_’c_Ën
);

1791 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
key
, 
key_Ën
);

1792 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
v®
, 
v®_Ën
);

1795 
	}
}

1797 
	$fcgi_h—d”
(
FCGI_H—d”
 * 
h—d”
, 
ty³
, 
»que¡_id
, 
cÚ‹ÁL’gth
, 
·ddšgL’gth
) {

1798 
	`fÜû_as£¹
(
cÚ‹ÁL’gth
 <ğ
FCGI_MAX_LENGTH
);

1800 
h—d”
->
v”siÚ
 = 
FCGI_VERSION_1
;

1801 
h—d”
->
ty³
 =ype;

1802 
h—d”
->
»que¡IdB0
 = 
»que¡_id
 & 0xff;

1803 
h—d”
->
»que¡IdB1
 = (
»que¡_id
 >> 8) & 0xff;

1804 
h—d”
->
cÚ‹ÁL’gthB0
 = 
cÚ‹ÁL’gth
 & 0xff;

1805 
h—d”
->
cÚ‹ÁL’gthB1
 = (
cÚ‹ÁL’gth
 >> 8) & 0xff;

1806 
h—d”
->
·ddšgL’gth
 =…addingLength;

1807 
h—d”
->
»£rved
 = 0;

1810 
	}
}

1813 
	mCONNECTION_OK
,

1814 
	mCONNECTION_DELAYED
,

1815 
	mCONNECTION_OVERLOADED
,

1816 
	mCONNECTION_DEAD


1817 } 
	tcÚÃùiÚ_»suÉ_t
;

1819 
cÚÃùiÚ_»suÉ_t
 
	$fcgi_e¡ablish_cÚÃùiÚ
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1820 
sockaddr
 *
fcgi_addr
;

1821 
sockaddr_š
 
fcgi_addr_š
;

1822 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

1823 
sockaddr_š6
 
fcgi_addr_š6
;

1825 #ifdeà
HAVE_SYS_UN_H


1826 
sockaddr_un
 
fcgi_addr_un
;

1828 
sockËn_t
 
£rvËn
;

1830 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
hùx
->host;

1831 
fcgi_´oc
 *
´oc
 = 
hùx
->proc;

1832 
fcgi_fd
 = 
hùx
->
fd
;

1834 ià(!
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

1835 #ifdeà
HAVE_SYS_UN_H


1837 
	`mem£t
(&
fcgi_addr_un
, 0, (fcgi_addr_un));

1838 
fcgi_addr_un
.
sun_çmy
 = 
AF_UNIX
;

1839 ià(
	`bufãr_¡ršg_Ëngth
(
´oc
->
unixsock‘
è+ 1 > (
fcgi_addr_un
.
sun_·th
)) {

1840 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sB",

1842 
´oc
->
unixsock‘
);

1845 
	`memıy
(
fcgi_addr_un
.
sun_·th
, 
´oc
->
unixsock‘
->
±r
, 
	`bufãr_¡ršg_Ëngth
(proc->unixsocket) + 1);

1847 #ifdeà
SUN_LEN


1848 
£rvËn
 = 
	`SUN_LEN
(&
fcgi_addr_un
);

1851 
£rvËn
 = 
	`bufãr_¡ršg_Ëngth
(
´oc
->
unixsock‘
è+ 1 + (
fcgi_addr_un
.
sun_çmy
);

1853 
fcgi_addr
 = (
sockaddr
 *è&
fcgi_addr_un
;

1855 ià(
	`bufãr_¡ršg_is_em±y
(
´oc
->
cÚÃùiÚ_Çme
)) {

1857 
	`bufãr_cİy_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
("unix:"));

1858 
	`bufãr_­³nd_¡ršg_bufãr
(
´oc
->
cÚÃùiÚ_Çme
,…roc->
unixsock‘
);

1861  
CONNECTION_DEAD
;

1863 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

1864 } ià(
ho¡
->
çmy
 =ğ
AF_INET6
 && !
	`bufãr_¡ršg_is_em±y
(host->host)) {

1865 
	`mem£t
(&
fcgi_addr_š6
, 0, (fcgi_addr_in6));

1866 
fcgi_addr_š6
.
sš6_çmy
 = 
AF_INET6
;

1867 
	`š‘_±Ú
(
AF_INET6
, 
ho¡
->ho¡->
±r
, (*è&
fcgi_addr_š6
.
sš6_addr
);

1868 
fcgi_addr_š6
.
sš6_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

1869 
£rvËn
 = (
fcgi_addr_š6
);

1870 
fcgi_addr
 = (
sockaddr
 *è&
fcgi_addr_š6
;

1873 
	`mem£t
(&
fcgi_addr_š
, 0, (fcgi_addr_in));

1874 
fcgi_addr_š
.
sš_çmy
 = 
AF_INET
;

1875 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->host)) {

1876 ià(0 =ğ
	`š‘_©Ú
(
ho¡
->ho¡->
±r
, &(
fcgi_addr_š
.
sš_addr
))) {

1877 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1878 "cÚv”tšg IP‡dd»s çed fÜ", 
ho¡
->host,

1881  
CONNECTION_DEAD
;

1884 
fcgi_addr_š
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_LOOPBACK
);

1886 
fcgi_addr_š
.
sš_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

1887 
£rvËn
 = (
fcgi_addr_š
);

1889 
fcgi_addr
 = (
sockaddr
 *è&
fcgi_addr_š
;

1892 ià(
	`bufãr_¡ršg_is_em±y
(
´oc
->
unixsock‘
)) {

1893 ià(
	`bufãr_¡ršg_is_em±y
(
´oc
->
cÚÃùiÚ_Çme
)) {

1895 
	`bufãr_cİy_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
("tcp:"));

1896 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->host)) {

1897 
	`bufãr_­³nd_¡ršg_bufãr
(
´oc
->
cÚÃùiÚ_Çme
, 
ho¡
->host);

1899 
	`bufãr_­³nd_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
("localhost"));

1901 
	`bufãr_­³nd_¡ršg_Ën
(
´oc
->
cÚÃùiÚ_Çme
, 
	`CONST_STR_LEN
(":"));

1902 
	`bufãr_­³nd_št
(
´oc
->
cÚÃùiÚ_Çme
,…roc->
pÜt
);

1906 ià(-1 =ğ
	`cÚÃù
(
fcgi_fd
, 
fcgi_addr
, 
£rvËn
)) {

1907 ià(
”ºo
 =ğ
EINPROGRESS
 ||

1908 
”ºo
 =ğ
EALREADY
 ||

1909 
”ºo
 =ğ
EINTR
) {

1910 ià(
hùx
->
cÚf
.
debug
 > 2) {

1911 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1912 "cÚÃù d–ayed; wÈcÚtšuÏ‹r:", 
´oc
->
cÚÃùiÚ_Çme
);

1915  
CONNECTION_DELAYED
;

1916 } ià(
”ºo
 =ğ
EAGAIN
) {

1917 ià(
hùx
->
cÚf
.
debug
) {

1918 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsd",

1921 "Thlßd fÜhi Fa¡CGI back’d", 
´oc
->
cÚÃùiÚ_Çme
, "is",…roc->
lßd
);

1924  
CONNECTION_OVERLOADED
;

1926 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssb",

1928 
	`¡»¼Ü
(
”ºo
), "on",

1929 
´oc
->
cÚÃùiÚ_Çme
);

1931  
CONNECTION_DEAD
;

1935 
hùx
->
»cÚÃùs
 = 0;

1936 ià(
hùx
->
cÚf
.
debug
 > 1) {

1937 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1938 "cÚÃù sucûeded: ", 
fcgi_fd
);

1941  
CONNECTION_OK
;

1942 
	}
}

1944 
	$fcgi_¡dš_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
»que¡_id
) {

1945 
FCGI_H—d”
 
h—d”
;

1946 
chunkqueue
 *
»q_cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

1947 
off_t
 
off£t
, 
weWªt
;

1948 cÚ¡ 
off_t
 
»q_cqËn
 = 
»q_cq
->
by‹s_š
 -„eq_cq->
by‹s_out
;

1951 
off£t
 = 0; off£ˆ!ğ
»q_cqËn
; off£ˆ+ğ
weWªt
) {

1952 
weWªt
 = 
»q_cqËn
 - 
off£t
 > 
FCGI_MAX_LENGTH
 ? FCGI_MAX_LENGTH :„eq_cqlen - offset;

1958 
	`fcgi_h—d”
(&(
h—d”
), 
FCGI_STDIN
, 
»que¡_id
, 
weWªt
, 0);

1959 
	`chunkqueue_­³nd_mem
(
hùx
->
wb
, (cÚ¡ *)&
h—d”
, (header));

1960 
hùx
->
wb_»qËn
 +ğ(
h—d”
);

1962 ià(
hùx
->
cÚf
.
debug
 > 10) {

1963 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "soso", "to£nd:", 
off£t
, "/", 
»q_cqËn
);

1966 
	`chunkqueue_¡—l
(
hùx
->
wb
, 
»q_cq
, 
weWªt
);

1970 ià(
hùx
->
wb
->
by‹s_š
 =ğhùx->
wb_»qËn
) {

1972 
	`fcgi_h—d”
(&(
h—d”
), 
FCGI_STDIN
, 
»que¡_id
, 0, 0);

1973 
	`chunkqueue_­³nd_mem
(
hùx
->
wb
, (cÚ¡ *)&
h—d”
, (header));

1974 
hùx
->
wb_»qËn
 +ğ()(
h—d”
);

1976 
	}
}

1978 
	$fcgi_ü—‹_’v
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
»que¡_id
) {

1979 
FCGI_BegšReque¡RecÜd
 
begšRecÜd
;

1980 
FCGI_H—d”
 
h—d”
;

1982 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

1983 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

1985 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

1987 
h‰p_cgi_İts
 
İts
 = {

1988 (
hùx
->
fcgi_mode
 =ğ
FCGI_AUTHORIZER
),

1989 
ho¡
->
b»ak_sütf’ame_fÜ_php
,

1990 
ho¡
->
doüoÙ
,

1991 
ho¡
->
¡r_»que¡_uri


1996 
	`fcgi_h—d”
(&(
begšRecÜd
.
h—d”
), 
FCGI_BEGIN_REQUEST
, 
»que¡_id
, (begšRecÜd.
body
), 0);

1997 
begšRecÜd
.
body
.
rŞeB0
 = 
hùx
->
fcgi_mode
;

1998 
begšRecÜd
.
body
.
rŞeB1
 = 0;

1999 
begšRecÜd
.
body
.
æags
 = 0;

2000 
	`mem£t
(
begšRecÜd
.
body
.
»£rved
, 0, (beginRecord.body.reserved));

2003 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
fcgi_’v
, 1023);

2005 ià(0 !ğ
	`h‰p_cgi_h—d”s
(
¤v
, 
cÚ
, &
İts
, 
fcgi_’v_add
, 
p
->
fcgi_’v
)) {

2006 
cÚ
->
h‰p_¡©us
 = 400;

2009 
bufãr
 *
b
 = 
	`bufãr_š™
();

2011 
	`bufãr_cİy_¡ršg_Ën
(
b
, (cÚ¡ *)&
begšRecÜd
, (beginRecord));

2013 
	`fcgi_h—d”
(&(
h—d”
), 
FCGI_PARAMS
, 
»que¡_id
, 
	`bufãr_¡ršg_Ëngth
(
p
->
fcgi_’v
), 0);

2014 
	`bufãr_­³nd_¡ršg_Ën
(
b
, (cÚ¡ *)&
h—d”
, (header));

2015 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
p
->
fcgi_’v
);

2017 
	`fcgi_h—d”
(&(
h—d”
), 
FCGI_PARAMS
, 
»que¡_id
, 0, 0);

2018 
	`bufãr_­³nd_¡ršg_Ën
(
b
, (cÚ¡ *)&
h—d”
, (header));

2020 
hùx
->
wb_»qËn
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

2021 
	`chunkqueue_­³nd_bufãr
(
hùx
->
wb
, 
b
);

2022 
	`bufãr_ä“
(
b
);

2025 
hùx
->
wb_»qËn
 +ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
;

2026 
	`fcgi_¡dš_­³nd
(
¤v
, 
cÚ
, 
hùx
, 
»que¡_id
);

2029 
	}
}

2031 
	$fcgi_»¥Ú£_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
š
) {

2032 *
s
, *
ns
;

2034 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

2035 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

2036 
have_£ndfe2
 = 0;

2037 
off_t
 
£ndfe2_cÚ‹Á_Ëngth
 = 0;

2039 
	`UNUSED
(
¤v
);

2042 
s
 = 
š
->
±r
; 
NULL
 !ğ(
ns
 = 
	`¡rchr
(s, '\n')); s =‚s + 1) {

2043 *
key
, *
v®ue
;

2044 
key_Ën
;

2048 ià(
ns
 > 
š
->
±r
 &&

2049 *(
ns
-1) == '\r') {

2050 *(
ns
-1) = '\0';

2053 
ns
[0] = '\0';

2055 
key
 = 
s
;

2056 ià(
NULL
 =ğ(
v®ue
 = 
	`¡rchr
(
s
, ':'))) {

2061 
key_Ën
 = 
v®ue
 - 
key
;

2063 
v®ue
++;

2065 *
v®ue
 == ' ' || *value == '\t') value++;

2067 ià(
hùx
->
fcgi_mode
 !ğ
FCGI_AUTHORIZER
 ||

2068 !(
cÚ
->
h‰p_¡©us
 == 0 ||

2069 
cÚ
->
h‰p_¡©us
 == 200)) {

2073 ià(0 !ğ
	`¡ºÿ£cmp
(
key
, "Stus", 
key_Ën
)) {

2074 
d©a_¡ršg
 *
ds
;

2075 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

2076 
ds
 = 
	`d©a_»¥Ú£_š™
();

2078 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
key_Ën
);

2079 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, value);

2081 
	`¬¿y_š£¹_unique
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
ds
);

2085 ià(
hùx
->
fcgi_mode
 =ğ
FCGI_AUTHORIZER
 &&

2086 
key_Ën
 > 9 &&

2087 0 =ğ
	`¡ºÿ£cmp
(
key
, 
	`CONST_STR_LEN
("Variable-"))) {

2088 
d©a_¡ršg
 *
ds
;

2089 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

2090 
ds
 = 
	`d©a_»¥Ú£_š™
();

2092 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key + 9, 
key_Ën
 - 9);

2093 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, value);

2095 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

2098 
key_Ën
) {

2100 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "D©e", 
key_Ën
)) {

2101 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_DATE
;

2105 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "Stus", 
key_Ën
)) {

2106 
¡©us
 = 
	`¡¹Ş
(
v®ue
, 
NULL
, 10);

2107 ià(
¡©us
 >= 100 && status < 1000) {

2108 
cÚ
->
h‰p_¡©us
 = 
¡©us
;

2109 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_STATUS
;

2111 
cÚ
->
h‰p_¡©us
 = 502;

2116 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "LoÿtiÚ", 
key_Ën
)) {

2117 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_LOCATION
;

2121 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚÃùiÚ", 
key_Ën
)) {

2122 
cÚ
->
»¥Ú£
.
k“p_®ive
 = (0 =ğ
	`¡rÿ£cmp
(
v®ue
, "Keep-Alive")) ? 1 : 0;

2123 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONNECTION
;

2127 ià(
ho¡
->
x£ndfe_®low
 && 0 =ğ
	`¡ºÿ£cmp
(
key
, "X-S’dfe2", 
key_Ën
è&& 
hùx
->
£nd_cÚ‹Á_body
) {

2128 *
pos
 = 
v®ue
;

2129 
have_£ndfe2
 = 1;

2131 *
pos
) {

2132 *
f’ame
, *
¿nge
;

2133 
¡©_ÿche_’Œy
 *
sû
;

2134 
off_t
 
begš_¿nge
, 
’d_¿nge
, 
¿nge_Ën
;

2136 ' ' =ğ*
pos
)…os++;

2137 ià(!*
pos
) ;

2139 
f’ame
 = 
pos
;

2140 ià(
NULL
 =ğ(
¿nge
 = 
	`¡rchr
(
pos
, ' '))) {

2142 ià(
hùx
->
cÚf
.
debug
) {

2143 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "Couldn'ˆfšd„ªgaá” f’ame:", 
f’ame
);

2147 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
f’ame
, 
¿nge
 - filename);

2150 
pos
 = ++
¿nge
; *pos && *pos != ' ' && *pos != ',';…os++) ;

2152 
	`bufãr_u¾decode_·th
(
¤v
->
tmp_buf
);

2153 
	`bufãr_·th_sim¶ify
(
¤v
->
tmp_buf
, srv->tmp_buf);

2154 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

2155 
	`bufãr_to_low”
(
¤v
->
tmp_buf
);

2157 ià(
ho¡
->
x£ndfe_doüoÙ
->
u£d
) {

2158 
size_t
 
i
, 
xËn
 = 
	`bufãr_¡ršg_Ëngth
(
¤v
->
tmp_buf
);

2159 
i
 = 0; i < 
ho¡
->
x£ndfe_doüoÙ
->
u£d
; ++i) {

2160 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
ho¡
->
x£ndfe_doüoÙ
->
d©a
[
i
];

2161 
size_t
 
dËn
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

2162 ià(
dËn
 <ğ
xËn


2163 && (!
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames


2164 ? 0 =ğ
	`memcmp
(
¤v
->
tmp_buf
->
±r
, 
ds
->
v®ue
->±r, 
dËn
)

2165 : 0 =ğ
	`¡ºÿ£cmp
(
¤v
->
tmp_buf
->
±r
, 
ds
->
v®ue
->±r, 
dËn
))) {

2169 ià(
i
 =ğ
ho¡
->
x£ndfe_doüoÙ
->
u£d
) {

2170 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBs",

2171 "X-S’dfe2 (", 
¤v
->
tmp_buf
,

2177 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, srv->
tmp_buf
, &
sû
)) {

2178 ià(
hùx
->
cÚf
.
debug
) {

2179 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

2181 
¤v
->
tmp_buf
);

2184 } ià(!
	`S_ISREG
(
sû
->
¡
.
¡_mode
)) {

2185 ià(
hùx
->
cÚf
.
debug
) {

2186 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

2188 
¤v
->
tmp_buf
);

2195 
’d_¿nge
 = 
sû
->
¡
.
¡_size
 - 1;

2197 *
½os
 = 
NULL
;

2198 
”ºo
 = 0;

2199 
begš_¿nge
 = 
	`¡¹Şl
(
¿nge
, &
½os
, 10);

2200 ià(
”ºo
 !ğ0 || 
begš_¿nge
 < 0 || 
½os
 =ğ
¿nge
è
¿nge_çed
;

2201 ià('-' !ğ*
½os
++è
¿nge_çed
;

2202 ià(
½os
 !ğ
pos
) {

2203 
¿nge
 = 
½os
;

2204 
’d_¿nge
 = 
	`¡¹Şl
(
¿nge
, &
½os
, 10);

2205 ià(
”ºo
 !ğ0 || 
’d_¿nge
 < 0 || 
½os
 =ğ
¿nge
è
¿nge_çed
;

2207 ià(
½os
 !ğ
pos
è
¿nge_çed
;

2209 
¿nge_sucûss
;

2211 
¿nge_çed
:

2212 ià(
hùx
->
cÚf
.
debug
) {

2213 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "Couldn'ˆdecod¿ngaá” f’ame:", 
f’ame
);

2217 
¿nge_sucûss
: ;

2222 *
pos
 == ' ')…os++;

2223 ià(*
pos
 != '\0' && *pos != ',')  502;

2225 
¿nge_Ën
 = 
’d_¿nge
 - 
begš_¿nge
 + 1;

2226 ià(
¿nge_Ën
 < 0)  502;

2227 ià(
¿nge_Ën
 != 0) {

2228 ià(0 !ğ
	`h‰p_chunk_­³nd_fe_¿nge
(
¤v
, 
cÚ
, srv->
tmp_buf
, 
begš_¿nge
, 
¿nge_Ën
)) {

2232 
£ndfe2_cÚ‹Á_Ëngth
 +ğ
¿nge_Ën
;

2234 ià(*
pos
 == ',')…os++;

2239 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚ‹Á-L’gth", 
key_Ën
)) {

2240 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
	`¡¹oul
(
v®ue
, 
NULL
, 10);

2241 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONTENT_LENGTH
;

2243 ià(
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 < 0) con->response.content_length = 0;

2251 ià(
have_£ndfe2
) {

2252 
d©a_¡ršg
 *
dşs
;

2255 ià(
NULL
 =ğ(
dşs
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

2256 
dşs
 = 
	`d©a_»¥Ú£_š™
();

2259 
	`bufãr_cİy_¡ršg_Ën
(
dşs
->
key
, "Content-Length", ("Content-Length")-1);

2260 
	`bufãr_cİy_št
(
dşs
->
v®ue
, 
£ndfe2_cÚ‹Á_Ëngth
);

2261 
	`¬¿y_»¶aû
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
dşs
);

2263 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONTENT_LENGTH
;

2264 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
£ndfe2_cÚ‹Á_Ëngth
;

2269 ià((
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_LOCATION
) &&

2270 !(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_STATUS
)) {

2271 
cÚ
->
h‰p_¡©us
 = 302;

2275 
	}
}

2278 
bufãr
 *
	mb
;

2279 
	mËn
;

2280 
	mty³
;

2281 
	m·ddšg
;

2282 
	m»que¡_id
;

2283 } 
	tç¡cgi_»¥Ú£_·ck‘
;

2285 
	$ç¡cgi_g‘_·ck‘
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
ç¡cgi_»¥Ú£_·ck‘
 *
·ck‘
) {

2286 
chunk
 *
c
;

2287 
size_t
 
off£t
;

2288 
size_t
 
tÜ—d
;

2289 
FCGI_H—d”
 *
h—d”
;

2291 ià(!
hùx
->
rb
->
fœ¡
)  -1;

2293 
·ck‘
->
b
 = 
	`bufãr_š™
();

2294 
·ck‘
->
Ën
 = 0;

2295 
·ck‘
->
ty³
 = 0;

2296 
·ck‘
->
·ddšg
 = 0;

2297 
·ck‘
->
»que¡_id
 = 0;

2299 
off£t
 = 0; 
tÜ—d
 = 8;

2301 
c
 = 
hùx
->
rb
->
fœ¡
; c; c = c->
Ãxt
) {

2302 
size_t
 
weHave
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

2304 ià(
weHave
 > 
tÜ—d
) weHave =oread;

2306 
	`bufãr_­³nd_¡ršg_Ën
(
·ck‘
->
b
, 
c
->
mem
->
±r
 + c->
off£t
, 
weHave
);

2307 
tÜ—d
 -ğ
weHave
;

2308 
off£t
 = 
weHave
;

2310 ià(0 =ğ
tÜ—d
) ;

2313 ià(
	`bufãr_¡ršg_Ëngth
(
·ck‘
->
b
è< (
FCGI_H—d”
)) {

2315 ià(
hùx
->
cÚf
.
debug
) {

2316 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsds", "Fa¡CGI: h—d”oØsm®l:", 
	`bufãr_¡ršg_Ëngth
(
·ck‘
->
b
), "by‹ <", (
FCGI_H—d”
), "bytes, waiting for more data");

2319 
	`bufãr_ä“
(
·ck‘
->
b
);

2325 
h—d”
 = (
FCGI_H—d”
 *)(
·ck‘
->
b
->
±r
);

2327 
·ck‘
->
Ën
 = (
h—d”
->
cÚ‹ÁL’gthB0
 | (h—d”->
cÚ‹ÁL’gthB1
 << 8)è+ h—d”->
·ddšgL’gth
;

2328 
·ck‘
->
»que¡_id
 = (
h—d”
->
»que¡IdB0
 | (h—d”->
»que¡IdB1
 << 8));

2329 
·ck‘
->
ty³
 = 
h—d”
->type;

2330 
·ck‘
->
·ddšg
 = 
h—d”
->
·ddšgL’gth
;

2333 
	`bufãr_¡ršg_£t_Ëngth
(
·ck‘
->
b
, 0);

2335 ià(
·ck‘
->
Ën
) {

2337 ; 
c
 && (
	`bufãr_¡ršg_Ëngth
(
·ck‘
->
b
è<…ack‘->
Ën
); c = c->
Ãxt
) {

2338 
size_t
 
weWªt
 = 
·ck‘
->
Ën
 - 
	`bufãr_¡ršg_Ëngth
Õack‘->
b
);

2339 
size_t
 
weHave
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
 - offset;

2341 ià(
weHave
 > 
weWªt
) weHave = weWant;

2343 
	`bufãr_­³nd_¡ršg_Ën
(
·ck‘
->
b
, 
c
->
mem
->
±r
 + c->
off£t
 + off£t, 
weHave
);

2346 
off£t
 = 0;

2349 ià(
	`bufãr_¡ršg_Ëngth
(
·ck‘
->
b
è<…ack‘->
Ën
) {

2352 
	`bufãr_ä“
(
·ck‘
->
b
);

2356 
	`bufãr_¡ršg_£t_Ëngth
(
·ck‘
->
b
, 
	`bufãr_¡ršg_Ëngth
Õack‘->bè-…ack‘->
·ddšg
);

2359 
	`chunkqueue_m¬k_wr™‹n
(
hùx
->
rb
, 
·ck‘
->
Ën
 + (
FCGI_H—d”
));

2362 
	}
}

2364 
	$fcgi_demux_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

2365 
fš
 = 0;

2366 
tÜ—d
, 
»t
;

2367 
ssize_t
 
r
 = 0;

2369 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

2370 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2371 
fcgi_fd
 = 
hùx
->
fd
;

2372 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

2373 
fcgi_´oc
 *
´oc
 = 
hùx
->proc;

2378 #ià!
	`defšed
(
_WIN32
è&& !defšed(
__CYGWIN__
)

2379 ià(
	`ioùl
(
hùx
->
fd
, 
FIONREAD
, &
tÜ—d
)) {

2380 ià(
”ºo
 =ğ
EAGAIN
) {

2381 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

2384 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2386 
fcgi_fd
);

2390 
tÜ—d
 = 4096;

2393 ià(
tÜ—d
 > 0) {

2394 *
mem
;

2395 
size_t
 
mem_Ën
;

2397 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)) {

2398 
off_t
 
cqËn
 = 
	`chunkqueue_Ëngth
(
hùx
->
rb
);

2399 ià(
cqËn
 + 
tÜ—d
 > 65536 + ()(
FCGI_H—d”
)) {

2400 ià(
cqËn
 < 65536 + ()(
FCGI_H—d”
)) {

2401 
tÜ—d
 = 65536 + ()(
FCGI_H—d”
è- 
cqËn
;

2403 
tÜ—d
 =oread < 1024 ?oread : 1024;

2408 
	`chunkqueue_g‘_memÜy
(
hùx
->
rb
, &
mem
, &
mem_Ën
, 0, 
tÜ—d
);

2409 
r
 = 
	`»ad
(
hùx
->
fd
, 
mem
, 
mem_Ën
);

2410 
	`chunkqueue_u£_memÜy
(
hùx
->
rb
, 
r
 > 0 ?„ : 0);

2412 ià(-1 =ğ
r
) {

2413 ià(
”ºo
 =ğ
EAGAIN
) {

2414 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

2417 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

2419 
fcgi_fd
, 
	`¡»¼Ü
(
”ºo
));

2423 ià(0 =ğ
r
) {

2424 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsb",

2426 "pid:", 
´oc
->
pid
,

2427 "sock‘:", 
´oc
->
cÚÃùiÚ_Çme
);

2436 
fš
 == 0) {

2437 
ç¡cgi_»¥Ú£_·ck‘
 
·ck‘
;

2440 ià(0 !ğ
	`ç¡cgi_g‘_·ck‘
(
¤v
, 
hùx
, &
·ck‘
)) {

2445 
·ck‘
.
ty³
) {

2446 
FCGI_STDOUT
:

2447 ià(
·ck‘
.
Ën
 == 0) ;

2450 ià(0 =ğ
cÚ
->
fe_¡¬‹d
) {

2451 *
c
;

2452 
d©a_¡ršg
 *
ds
;

2462 
	`bufãr_­³nd_¡ršg_bufãr
(
hùx
->
»¥Ú£_h—d”
, 
·ck‘
.
b
);

2464 ià(
NULL
 !ğ(
c
 = 
	`bufãr_£¬ch_¡ršg_Ën
(
hùx
->
»¥Ú£_h—d”
, 
	`CONST_STR_LEN
("\r\n\r\n")))) {

2465 *
h’d
 = 
c
 + 4;

2466 
size_t
 
hËn
 = 
h’d
 - 
hùx
->
»¥Ú£_h—d”
->
±r
;

2467 
	`bufãr_cİy_¡ršg_Ën
(
·ck‘
.
b
, 
h’d
, 
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£_h—d”
è- 
hËn
);

2468 
	`bufãr_¡ršg_£t_Ëngth
(
hùx
->
»¥Ú£_h—d”
, 
hËn
);

2469 } ià(
NULL
 !ğ(
c
 = 
	`bufãr_£¬ch_¡ršg_Ën
(
hùx
->
»¥Ú£_h—d”
, 
	`CONST_STR_LEN
("\n\n")))) {

2470 *
h’d
 = 
c
 + 2;

2471 
size_t
 
hËn
 = 
h’d
 - 
hùx
->
»¥Ú£_h—d”
->
±r
;

2472 
	`bufãr_cİy_¡ršg_Ën
(
·ck‘
.
b
, 
h’d
, 
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£_h—d”
è- 
hËn
);

2473 
	`bufãr_¡ršg_£t_Ëngth
(
hùx
->
»¥Ú£_h—d”
, 
hËn
);

2477 ià(
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£_h—d”
è> 
MAX_HTTP_REQUEST_HEADER
) {

2478 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "»¥Ú£ h—d” toØÏrgfÜ", 
cÚ
->
uri
.
·th
);

2479 
cÚ
->
h‰p_¡©us
 = 502;

2480 
cÚ
->
mode
 = 
DIRECT
;

2481 
fš
 = 1;

2487 ià((
»t
 = 
	`fcgi_»¥Ú£_·r£
(
¤v
, 
cÚ
, 
p
, 
hùx
->
»¥Ú£_h—d”
))) {

2488 ià(200 !ğ
»t
) {

2489 
cÚ
->
h‰p_¡©us
 = 
»t
;

2490 
cÚ
->
mode
 = 
DIRECT
;

2492 
cÚ
->
fe_¡¬‹d
 = 1;

2493 
hùx
->
£nd_cÚ‹Á_body
 = 0;

2494 
fš
 = 1;

2498 
cÚ
->
fe_¡¬‹d
 = 1;

2500 ià(
hùx
->
fcgi_mode
 =ğ
FCGI_AUTHORIZER
 &&

2501 (
cÚ
->
h‰p_¡©us
 == 0 ||

2502 
cÚ
->
h‰p_¡©us
 == 200)) {

2504 
hùx
->
£nd_cÚ‹Á_body
 = 0;

2507 ià(
ho¡
->
x£ndfe_®low
 && 
hùx
->
£nd_cÚ‹Á_body
 &&

2508 (
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "X-LIGHTTPD-send-file"))

2509 || 
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "X-Sendfile")))) {

2510 
	`h‰p_»¥Ú£_x£ndfe
(
¤v
, 
cÚ
, 
ds
->
v®ue
, 
ho¡
->
x£ndfe_doüoÙ
);

2511 ià(
cÚ
->
mode
 =ğ
DIRECT
) {

2512 
fš
 = 1;

2515 
hùx
->
£nd_cÚ‹Á_body
 = 0;

2520 ià(
hùx
->
£nd_cÚ‹Á_body
 && !
	`bufãr_¡ršg_is_em±y
(
·ck‘
.
b
)) {

2521 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
·ck‘
.
b
)) {

2524 
fš
 = 1;

2527 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

2528 && 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

2529 ià(!
cÚ
->
is_wr™abË
) {

2535 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

2540 
FCGI_STDERR
:

2541 ià(
·ck‘
.
Ën
 == 0) ;

2543 
	`log_”rÜ_wr™e_muÉše_bufãr
(
¤v
, 
__FILE__
, 
__LINE__
, 
·ck‘
.
b
, "s",

2547 
FCGI_END_REQUEST
:

2548 
fš
 = 1;

2551 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2552 "Fa¡CGI: h—d”.ty³‚Ù hªdËd: ", 
·ck‘
.
ty³
);

2555 
	`bufãr_ä“
(
·ck‘
.
b
);

2558  
fš
;

2559 
	}
}

2561 
	$fcgi_»¡¬t_d—d_´ocs
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
) {

2562 
fcgi_´oc
 *
´oc
;

2564 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

2565 
¡©us
;

2567 ià(
p
->
cÚf
.
debug
 > 2) {

2568 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdddd",

2570 
´oc
->
cÚÃùiÚ_Çme
,

2571 
´oc
->
¡©e
,

2572 
´oc
->
is_loÿl
,

2573 
´oc
->
lßd
,

2574 
´oc
->
pid
);

2581 
´oc
->
¡©e
) {

2582 
PROC_STATE_KILLED
:

2583 
PROC_STATE_UNSET
:

2585 
	`fÜû_as£¹
(0);

2588 
PROC_STATE_RUNNING
:

2590 
PROC_STATE_OVERLOADED
:

2591 ià(
¤v
->
cur_ts
 <ğ
´oc
->
di§bËd_uÁ
) ;

2593 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

2594 
ho¡
->
aùive_´ocs
++;

2596 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdb",

2598 
ho¡
->ho¡, ho¡->
pÜt
,

2599 
ho¡
->
unixsock‘
);

2601 
PROC_STATE_DIED_WAIT_FOR_PID
:

2603 ià(!
´oc
->
is_loÿl
) {

2604 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

2609 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

2612 ià(
¤v
->
cur_ts
 <ğ
´oc
->
di§bËd_uÁ
) ;

2614 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

2615 
ho¡
->
aùive_´ocs
++;

2617 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdb",

2619 
ho¡
->ho¡, ho¡->
pÜt
,

2620 
ho¡
->
unixsock‘
);

2623 ià(
”ºo
 =ğ
EINTR
) ;

2625 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2627 
”ºo
);

2628 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

2631 ià(
	`WIFEXITED
(
¡©us
)) {

2633 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

2634 "chdƒx™ed,…id:", 
´oc
->
pid
,

2635 "¡©us:", 
	`WEXITSTATUS
(
¡©us
));

2637 } ià(
	`WIFSIGNALED
(
¡©us
)) {

2638 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2640 
	`WTERMSIG
(
¡©us
));

2642 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2644 
¡©us
);

2647 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

2655 ià(
´oc
->
¡©e
 !ğ
PROC_STATE_DIED
) ;

2657 
PROC_STATE_DIED
:

2661 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
bš_·th
)) {

2664 ià(
´oc
->
lßd
 != 0) ;

2668 ià(
p
->
cÚf
.
debug
) {

2669 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsdsd",

2671 "\n\tsock‘", 
´oc
->
cÚÃùiÚ_Çme
,

2672 "\n\tcu¼’t:", 1, "/", 
ho¡
->
max_´ocs
);

2675 ià(
	`fcgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
ho¡
, 
´oc
)) {

2676 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

2678  
HANDLER_ERROR
;

2681 ià(
¤v
->
cur_ts
 <ğ
´oc
->
di§bËd_uÁ
) ;

2683 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

2684 
ho¡
->
aùive_´ocs
++;

2686 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

2688 
´oc
->
cÚÃùiÚ_Çme
);

2695 
	}
}

2697 
hªdËr_t
 
	$fcgi_wr™e_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

2698 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

2699 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

2700 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2701 
fcgi_´oc
 *
´oc
;

2703 
»t
;

2706 ià(
hùx
->
¡©e
 =ğ
FCGI_STATE_CONNECT_DELAYED
) {

2707 
sock‘_”rÜ
;

2708 
sockËn_t
 
sock‘_”rÜ_Ën
 = (
sock‘_”rÜ
);

2711 ià(0 !ğ
	`g‘sockİt
(
hùx
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock‘_”rÜ
, &
sock‘_”rÜ_Ën
)) {

2712 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2713 "g‘sockİˆçed:", 
	`¡»¼Ü
(
”ºo
));

2715 
	`fcgi_ho¡_di§bË
(
¤v
, 
hùx
);

2717  
HANDLER_ERROR
;

2719 ià(
sock‘_”rÜ
 != 0) {

2720 ià(!
hùx
->
´oc
->
is_loÿl
 || hùx->
cÚf
.
debug
) {

2723 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssb",

2724 "e¡ablishšg cÚÃùiÚ faed:", 
	`¡»¼Ü
(
sock‘_”rÜ
),

2725 "sock‘:", 
hùx
->
´oc
->
cÚÃùiÚ_Çme
);

2728 
	`fcgi_ho¡_di§bË
(
¤v
, 
hùx
);

2729 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdssdsd",

2730 "back’d i ov”lßded; we'Î di§bË iˆfÜ", 
hùx
->
ho¡
->
di§bË_time
, "seconds‡nd sendhe„equesto‡nother backend instead:",

2731 "»cÚÃùs:", 
hùx
->
»cÚÃùs
,

2732 "lßd:", 
ho¡
->
lßd
);

2734 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, hùx->
´oc
);

2735 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".died"));

2737 
	`¡©us_couÁ”_šc
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
));

2739  
HANDLER_ERROR
;

2742 
hùx
->
¡©e
 = 
FCGI_STATE_PREPARE_WRITE
;

2746 
hùx
->
¡©e
) {

2747 
FCGI_STATE_CONNECT_DELAYED
:

2749  
HANDLER_WAIT_FOR_EVENT
;

2750 
FCGI_STATE_INIT
:

2752 
hùx
->
´oc
 = 
NULL
;

2754 
´oc
 = 
hùx
->
ho¡
->
fœ¡
;

2755 
´oc
 &&…roc->
¡©e
 !ğ
PROC_STATE_RUNNING
;

2756 
´oc
 =…roc->
Ãxt
);

2759 ià(
´oc
 =ğ
NULL
) {

2760 
hùx
->
fde_ndx
 = -1;

2762  
HANDLER_ERROR
;

2765 
hùx
->
´oc
 =…roc;

2768 
´oc
 =…roc->
Ãxt
;…roc;…roc =…roc->next) {

2769 ià(
´oc
->
¡©e
 !ğ
PROC_STATE_RUNNING
) ;

2770 ià(
´oc
->
lßd
 < 
hùx
->proc->load) hctx->proc =…roc;

2773 ià(-1 =ğ(
hùx
->
fd
 = 
	`fdev’t_sock‘_nb_şÛxec
(
ho¡
->
çmy
, 
SOCK_STREAM
, 0))) {

2774 ià(
”ºo
 =ğ
EMFILE
 ||

2775 
”ºo
 =ğ
EINTR
) {

2776 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2777 "wa™ fÜ fd‡ˆcÚÃùiÚ:", 
cÚ
->
fd
);

2779  
HANDLER_WAIT_FOR_FD
;

2782 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdd",

2783 "sock‘ faed:", 
	`¡»¼Ü
(
”ºo
), 
¤v
->
cur_fds
, srv->
max_fds
);

2784  
HANDLER_ERROR
;

2786 
hùx
->
fde_ndx
 = -1;

2788 
¤v
->
cur_fds
++;

2790 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
hùx
->
fd
, 
fcgi_hªdË_fdev’t
, hctx);

2792 ià(-1 =ğ
	`fdev’t_fú_£t
(
¤v
->
ev
, 
hùx
->
fd
)) {

2793 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2794 "fú faed:", 
	`¡»¼Ü
(
”ºo
));

2796  
HANDLER_ERROR
;

2799 ià(
hùx
->
´oc
->
is_loÿl
) {

2800 
hùx
->
pid
 = hùx->
´oc
->pid;

2803 
	`fcgi_e¡ablish_cÚÃùiÚ
(
¤v
, 
hùx
)) {

2804 
CONNECTION_DELAYED
:

2807 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2809 
	`fcgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_CONNECT_DELAYED
);

2810  
HANDLER_WAIT_FOR_EVENT
;

2811 
CONNECTION_OVERLOADED
:

2815 ià(
hùx
->
ho¡
->
di§bË_time
) {

2816 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdssdsd",

2817 "back’d i ov”lßded; we'Î di§bË iˆfÜ", 
hùx
->
ho¡
->
di§bË_time
, "seconds‡nd sendhe„equesto‡nother backend instead:",

2818 "»cÚÃùs:", 
hùx
->
»cÚÃùs
,

2819 "lßd:", 
ho¡
->
lßd
);

2821 
hùx
->
´oc
->
di§bËd_uÁ
 = 
¤v
->
cur_ts
 + hùx->
ho¡
->
di§bË_time
;

2822 ià(
hùx
->
´oc
->
¡©e
 =ğ
PROC_STATE_RUNNING
èhùx->
ho¡
->
aùive_´ocs
--;

2823 
hùx
->
´oc
->
¡©e
 = 
PROC_STATE_OVERLOADED
;

2826 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, hùx->
´oc
);

2827 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".overloaded"));

2829 
	`¡©us_couÁ”_šc
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
));

2831  
HANDLER_ERROR
;

2832 
CONNECTION_DEAD
:

2840 
	`fcgi_ho¡_di§bË
(
¤v
, 
hùx
);

2842 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdssdsd",

2843 "back’d d›d; we'Î di§bË iˆfÜ", 
hùx
->
ho¡
->
di§bË_time
, "seconds‡nd sendhe„equesto‡nother backend instead:",

2844 "»cÚÃùs:", 
hùx
->
»cÚÃùs
,

2845 "lßd:", 
ho¡
->
lßd
);

2847 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, hùx->
´oc
);

2848 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".died"));

2850 
	`¡©us_couÁ”_šc
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
));

2852  
HANDLER_ERROR
;

2853 
CONNECTION_OK
:

2856 
	`fcgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_PREPARE_WRITE
);

2861 
FCGI_STATE_PREPARE_WRITE
:

2864 
	`fcgi_´oc_lßd_šc
(
¤v
, 
hùx
);

2865 
hùx
->
gÙ_´oc
 = 1;

2867 
	`¡©us_couÁ”_šc
(
¤v
, 
	`CONST_STR_LEN
("fastcgi.requests"));

2869 
	`ç¡cgi_¡©us_cİy_´oúame
(
p
->
¡©uskey
, 
hùx
->
ho¡
, hùx->
´oc
);

2870 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©uskey
, 
	`CONST_STR_LEN
(".connected"));

2872 
	`¡©us_couÁ”_šc
(
¤v
, 
	`CONST_BUF_LEN
(
p
->
¡©uskey
));

2874 ià(
hùx
->
cÚf
.
debug
) {

2875 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsbsd",

2877 "pid:", 
hùx
->
´oc
->
pid
,

2878 "sock‘:", 
hùx
->
´oc
->
cÚÃùiÚ_Çme
,

2879 "lßd:", 
hùx
->
´oc
->
lßd
);

2883 ià(
hùx
->
»que¡_id
 == 0) {

2884 
hùx
->
»que¡_id
 = 1;

2886 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2887 "fcgi-»que¡ i ®»ady iÀu£:", 
hùx
->
»que¡_id
);

2890 ià(-1 =ğ
	`fcgi_ü—‹_’v
(
¤v
, 
hùx
, hùx->
»que¡_id
)è 
HANDLER_ERROR
;

2892 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

2893 
	`fcgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_WRITE
);

2895 
FCGI_STATE_WRITE
:

2896 
»t
 = 
¤v
->
	`ÃtwÜk_back’d_wr™e
(¤v, 
cÚ
, 
hùx
->
fd
, hùx->
wb
, 
MAX_WRITE_LIMIT
);

2898 
	`chunkqueue_»move_fšished_chunks
(
hùx
->
wb
);

2900 ià(
»t
 < 0) {

2901 
”ºo
) {

2902 
EPIPE
:

2903 
ENOTCONN
:

2904 
ECONNRESET
:

2909 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssosb",

2911 "wr™e-off£t:", 
hùx
->
wb
->
by‹s_out
,

2912 "sock‘:", 
hùx
->
´oc
->
cÚÃùiÚ_Çme
);

2914  
HANDLER_ERROR
;

2916 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

2917 "wr™çed:", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

2919  
HANDLER_ERROR
;

2923 ià(
hùx
->
wb
->
by‹s_out
 =ğhùx->
wb_»qËn
) {

2924 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2925 
	`fcgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_READ
);

2927 
off_t
 
wbËn
 = 
hùx
->
wb
->
by‹s_š
 - hùx->wb->
by‹s_out
;

2928 ià(
hùx
->
wb
->
by‹s_š
 < hùx->
wb_»qËn
 && 
wbËn
 < 65536 - 16384) {

2930 ià(!(
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_POLLIN
)) {

2931 
cÚ
->
cÚf
.
¡»am_»que¡_body
 |ğ
FDEVENT_STREAM_REQUEST_POLLIN
;

2932 
cÚ
->
is_»adabË
 = 1;

2935 ià(0 =ğ
wbËn
) {

2936 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2938 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2942  
HANDLER_WAIT_FOR_EVENT
;

2943 
FCGI_STATE_READ
:

2945  
HANDLER_WAIT_FOR_EVENT
;

2947 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "(debug) unknown state");

2948  
HANDLER_ERROR
;

2950 
	}
}

2955 
hªdËr_t
 
	$fcgi_£nd_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

2957 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
hùx
->host;

2958 
hªdËr_t
 
rc
 = 
	`fcgi_wr™e_»que¡
(
¤v
, 
hùx
);

2959 ià(
HANDLER_ERROR
 !ğ
rc
) {

2960  
rc
;

2962 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

2963 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2965 ià(
hùx
->
¡©e
 =ğ
FCGI_STATE_INIT
 ||

2966 
hùx
->
¡©e
 =ğ
FCGI_STATE_CONNECT_DELAYED
) {

2967 
	`fcgi_»¡¬t_d—d_´ocs
(
¤v
, 
p
, 
ho¡
);

2970 ià(
hùx
->
»cÚÃùs
++ < 5) {

2971  
	`fcgi_»cÚÃù
(
¤v
, 
hùx
);

2973 
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2974 
cÚ
->
h‰p_¡©us
 = 503;

2976  
HANDLER_FINISHED
;

2979 
¡©us
 = 
cÚ
->
h‰p_¡©us
;

2980 
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2981 
cÚ
->
h‰p_¡©us
 = (
¡©us
 == 400) ? 400 : 503;

2983  
HANDLER_FINISHED
;

2986 
	}
}

2989 
hªdËr_t
 
fcgi_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
);

2992 
	$SUBREQUEST_FUNC
(
mod_ç¡cgi_hªdË_sub»que¡
) {

2993 
¶ugš_d©a
 *
p
 = 
p_d
;

2995 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

2997 ià(
NULL
 =ğ
hùx
è 
HANDLER_GO_ON
;

3000 ià(
cÚ
->
mode
 !ğ
p
->
id
è 
HANDLER_GO_ON
;

3002 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

3003 && 
cÚ
->
fe_¡¬‹d
) {

3004 ià(
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

3005 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

3006 } ià(!(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_IN
)) {

3008 
hªdËr_t
 
rc
 = 
	`fcgi_»cv_»¥Ú£
(
¤v
, 
hùx
);

3009 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

3017 ià(
hùx
->
fcgi_mode
 !ğ
FCGI_AUTHORIZER


3018 && (0 =ğ
hùx
->
wb
->
by‹s_š


3019 ? 
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST


3020 : 
hùx
->
wb
->
by‹s_š
 < hùx->
wb_»qËn
)) {

3023 ià(
hùx
->
wb
->
by‹s_š
 - hùx->wb->
by‹s_out
 > 65536 - 4096

3024 && (
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_BUFMIN
)){

3025 
cÚ
->
cÚf
.
¡»am_»que¡_body
 &ğ~
FDEVENT_STREAM_REQUEST_POLLIN
;

3026 ià(0 !ğ
hùx
->
wb
->
by‹s_š
è 
HANDLER_WAIT_FOR_EVENT
;

3028 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

3029 
chunkqueue
 *
»q_cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

3030 ià(0 !ğ
hùx
->
wb
->
by‹s_š
 && !
	`chunkqueue_is_em±y
(
»q_cq
)) {

3031 
	`fcgi_¡dš_­³nd
(
¤v
, 
cÚ
, 
hùx
, hùx->
»que¡_id
);

3032 ià(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_OUT
) {

3033  (
r
 =ğ
HANDLER_GO_ON
è? 
HANDLER_WAIT_FOR_EVENT
 :„;

3036 ià(
r
 !ğ
HANDLER_GO_ON
) „;

3042 ià(-1 =ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

3043  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 411);

3048  ((0 =ğ
hùx
->
wb
->
by‹s_š
 || !
	`chunkqueue_is_em±y
(hctx->wb))

3049 && 
hùx
->
¡©e
 !ğ
FCGI_STATE_CONNECT_DELAYED
)

3050 ? 
	`fcgi_£nd_»que¡
(
¤v
, 
hùx
)

3051 : 
HANDLER_WAIT_FOR_EVENT
;

3052 
	}
}

3055 
hªdËr_t
 
	$fcgi_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

3056 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

3057 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

3059 
fcgi_´oc
 *
´oc
 = 
hùx
->proc;

3060 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

3062 
	`fcgi_demux_»¥Ú£
(
¤v
, 
hùx
)) {

3067 ià(
hùx
->
fcgi_mode
 =ğ
FCGI_AUTHORIZER
 &&

3068 (
cÚ
->
h‰p_¡©us
 == 200 ||

3069 
cÚ
->
h‰p_¡©us
 == 0)) {

3075 
bufãr
 *
phy¥©h
 = 
NULL
;

3077 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
doüoÙ
)) {

3078 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
ho¡
->
doüoÙ
);

3079 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
ba£dœ
, 
ho¡
->
doüoÙ
);

3081 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
ho¡
->
doüoÙ
);

3082 
	`bufãr_­³nd_¡ršg_bufãr
(
cÚ
->
physiÿl
.
·th
, cÚ->
uri
.path);

3083 
phy¥©h
 = 
cÚ
->
physiÿl
.
·th
;

3086 
	`fcgi_back’d_şo£
(
¤v
, 
hùx
);

3087 
	`hªdËr_ùx_ş—r
(
hùx
);

3090 ià(++
cÚ
->
loİs_³r_»que¡
 > 5) {

3091 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "toØmªy†oİ wh´oûssšg„eque¡:", 
cÚ
->
»que¡
.
Üig_uri
);

3092 
cÚ
->
h‰p_¡©us
 = 500;

3093 
cÚ
->
mode
 = 
DIRECT
;

3094  
HANDLER_FINISHED
;

3099 ià(
phy¥©h
è
cÚ
->
physiÿl
.
·th
 = 
NULL
;

3100 
	`cÚÃùiÚ_»¥Ú£_»£t
(
¤v
, 
cÚ
);

3101 ià(
phy¥©h
è
cÚ
->
physiÿl
.
·th
 =…hyspath;

3106 
cÚ
->
mode
 = 
DIRECT
;

3107  
HANDLER_COMEBACK
;

3110 
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

3113  
HANDLER_FINISHED
;

3115 ià(
´oc
->
pid
 &&…roc->
¡©e
 !ğ
PROC_STATE_DIED
) {

3116 
¡©us
;

3120 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

3128 ià(
	`WIFEXITED
(
¡©us
)) {

3129 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

3130 "chdƒx™ed,…id:", 
´oc
->
pid
,

3131 "¡©us:", 
	`WEXITSTATUS
(
¡©us
));

3132 } ià(
	`WIFSIGNALED
(
¡©us
)) {

3133 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3135 
	`WTERMSIG
(
¡©us
));

3137 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3139 
¡©us
);

3142 ià(
hùx
->
cÚf
.
debug
) {

3143 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsdsd",

3145 "\n\tsock‘", 
´oc
->
cÚÃùiÚ_Çme
,

3146 "\n\tcu¼’t:", 1, "/", 
ho¡
->
max_´ocs
);

3149 ià(
	`fcgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
ho¡
, 
´oc
)) {

3151 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

3153 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

3161 ià(
cÚ
->
fe_¡¬‹d
 == 0) {

3164 ià(
hùx
->
wb
->
by‹s_out
 == 0 &&

3165 
hùx
->
»cÚÃùs
++ < 5) {

3167 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsBSBs",

3169 "Ú sock‘:", 
´oc
->
cÚÃùiÚ_Çme
,

3170 "fÜ", 
cÚ
->
uri
.
·th
, "?", cÚ->uri.
qu”y
, ",„econnecting");

3172  
	`fcgi_»cÚÃù
(
¤v
, 
hùx
);

3175 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sosbsBSBs",

3176 "»¥Ú£‚Ù„eûived,„eque¡ s’t:", 
hùx
->
wb
->
by‹s_out
,

3177 "Ú sock‘:", 
´oc
->
cÚÃùiÚ_Çme
,

3178 "fÜ", 
cÚ
->
uri
.
·th
, "?", cÚ->uri.
qu”y
, ", closing connection");

3180 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsBSBs",

3182 "Ú sock‘:", 
´oc
->
cÚÃùiÚ_Çme
,

3183 "fÜ", 
cÚ
->
uri
.
·th
, "?", cÚ->uri.
qu”y
, ",erminating connection");

3186 
	`h‰p_»¥Ú£_back’d_”rÜ
(
¤v
, 
cÚ
);

3187 
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

3188  
HANDLER_FINISHED
;

3191  
HANDLER_GO_ON
;

3192 
	}
}

3195 
hªdËr_t
 
	$fcgi_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
) {

3196 
hªdËr_ùx
 *
hùx
 = 
ùx
;

3197 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

3199 
	`jobli¡_­³nd
(
¤v
, 
cÚ
);

3201 ià(
»v’ts
 & 
FDEVENT_IN
) {

3202 
hªdËr_t
 
rc
 = 
	`fcgi_»cv_»¥Ú£
(
¤v
, 
hùx
);

3203 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

3206 ià(
»v’ts
 & 
FDEVENT_OUT
) {

3207  
	`fcgi_£nd_»que¡
(
¤v
, 
hùx
);

3211 ià(
»v’ts
 & 
FDEVENT_HUP
) {

3212 ià(
hùx
->
¡©e
 =ğ
FCGI_STATE_CONNECT_DELAYED
) {

3222 
	`fcgi_£nd_»que¡
(
¤v
, 
hùx
);

3223 } ià(
cÚ
->
fe_¡¬‹d
) {

3229 
hªdËr_t
 
rc
;

3231 
rc
 = 
	`fcgi_»cv_»¥Ú£
(
¤v
,
hùx
);

3232 } 
rc
 =ğ
HANDLER_GO_ON
);

3233  
rc
;

3235 
fcgi_´oc
 *
´oc
 = 
hùx
->proc;

3236 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sBSbsbsd",

3238 
cÚ
->
uri
.
·th
, "?", cÚ->uri.
qu”y
,

3239 "ÒØç¡cg˜´oûs Ú sock‘:", 
´oc
->
cÚÃùiÚ_Çme
, "?)",

3240 
hùx
->
¡©e
);

3242 
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

3244 } ià(
»v’ts
 & 
FDEVENT_ERR
) {

3245 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

3248 
	`h‰p_»¥Ú£_back’d_”rÜ
(
¤v
, 
cÚ
);

3249 
	`fcgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

3252  
HANDLER_FINISHED
;

3253 
	}
}

3255 
	#PATCH
(
x
) \

3256 
p
->
cÚf
.
x
 = 
s
->x;

	)

3257 
	$fcgi_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

3258 
size_t
 
i
, 
j
;

3259 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

3261 
	`PATCH
(
exts
);

3262 
	`PATCH
(
exts_auth
);

3263 
	`PATCH
(
exts_»¥
);

3264 
	`PATCH
(
debug
);

3265 
	`PATCH
(
ext_m­pšg
);

3268 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

3269 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

3270 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

3273 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

3276 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

3277 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

3279 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("fastcgi.server"))) {

3280 
	`PATCH
(
exts
);

3281 
	`PATCH
(
exts_auth
);

3282 
	`PATCH
(
exts_»¥
);

3283 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("fastcgi.debug"))) {

3284 
	`PATCH
(
debug
);

3285 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("fastcgi.map-extensions"))) {

3286 
	`PATCH
(
ext_m­pšg
);

3292 
	}
}

3293 #undeà
PATCH


3296 
hªdËr_t
 
	$fcgi_check_ex‹nsiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, 
uri_·th_hªdËr
) {

3297 
¶ugš_d©a
 *
p
 = 
p_d
;

3298 
size_t
 
s_Ën
;

3299 
size_t
 
k
;

3300 
bufãr
 *
â
;

3301 
fcgi_ex‹nsiÚ
 *
ex‹nsiÚ
 = 
NULL
;

3302 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
NULL
;

3303 
hªdËr_ùx
 *
hùx
;

3304 
fcgi_mode
;

3306 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

3308 
â
 = 
uri_·th_hªdËr
 ? 
cÚ
->
uri
.
·th
 : cÚ->
physiÿl
.path;

3310 ià(
	`bufãr_¡ršg_is_em±y
(
â
)è 
HANDLER_GO_ON
;

3312 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
â
);

3314 
	`fcgi_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

3315 ià(
NULL
 =ğ
p
->
cÚf
.
exts
è 
HANDLER_GO_ON
;

3319 
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

3320 
fcgi_mode
 = (
NULL
 =ğ
hùx
 || NULL =ğhùx->
ext_auth
)

3322 : 
FCGI_AUTHORIZER
;

3326 
fcgi_exts
 *
exts
;

3327 ià(0 =ğ
fcgi_mode
) {

3328 
fcgi_mode
 = 
FCGI_AUTHORIZER
;

3329 
exts
 = 
p
->
cÚf
.
exts_auth
;

3331 
fcgi_mode
 = 
FCGI_RESPONDER
;

3332 
exts
 = 
p
->
cÚf
.
exts_»¥
;

3335 ià(0 =ğ
exts
->
u£d
) ;

3346 
k
 = 0; k < 
p
->
cÚf
.
ext_m­pšg
->
u£d
; k++) {

3347 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
ext_m­pšg
->
d©a
[
k
];

3348 
size_t
 
ù_Ën
;

3350 ià(
	`bufãr_is_em±y
(
ds
->
key
)) ;

3352 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
key
);

3354 ià(
s_Ën
 < 
ù_Ën
) ;

3357 ià(0 =ğ
	`¡ºcmp
(
â
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
key
->ptr, ct_len)) {

3361 
k
 = 0; k < 
exts
->
u£d
; k++) {

3362 
ex‹nsiÚ
 = 
exts
->exts[
k
];

3364 ià(
	`bufãr_is_equ®
(
ds
->
v®ue
, 
ex‹nsiÚ
->
key
)) {

3369 ià(
k
 =ğ
exts
->
u£d
) {

3371 
ex‹nsiÚ
 = 
NULL
;

3377 ià(
ex‹nsiÚ
 =ğ
NULL
) {

3378 
size_t
 
uri_·th_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
);

3381 
k
 = 0; k < 
exts
->
u£d
; k++) {

3382 
size_t
 
ù_Ën
;

3383 
fcgi_ex‹nsiÚ
 *
ext
 = 
exts
->exts[
k
];

3385 ià(
	`bufãr_is_em±y
(
ext
->
key
)) ;

3387 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ext
->
key
);

3390 ià(
ext
->
key
->
±r
[0] == '/') {

3391 ià((
ù_Ën
 <ğ
uri_·th_Ën
) &&

3392 (
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
, 
ext
->
key
->±r, 
ù_Ën
) == 0)) {

3393 
ex‹nsiÚ
 = 
ext
;

3396 } ià((
ù_Ën
 <ğ
s_Ën
è&& (0 =ğ
	`¡ºcmp
(
â
->
±r
 + s_ËÀ- ct_Ën, 
ext
->
key
->ptr, ct_len))) {

3398 
ex‹nsiÚ
 = 
ext
;

3404 } 
NULL
 =ğ
ex‹nsiÚ
 && 
fcgi_mode
 !ğ
FCGI_RESPONDER
);

3407 ià(
NULL
 =ğ
ex‹nsiÚ
) {

3408  
HANDLER_GO_ON
;

3412 
ho¡
 = 
	`fcgi_ex‹nsiÚ_ho¡_g‘
(
¤v
, 
cÚ
, 
p
, 
ex‹nsiÚ
);

3413 ià(
NULL
 =ğ
ho¡
) {

3414  
HANDLER_FINISHED
;

3418 
ex‹nsiÚ
->
nÙe_is_£Á
 = 0;

3426 ià(
uri_·th_hªdËr
) {

3427 ià(
ho¡
->
check_loÿl
 != 0) {

3428  
HANDLER_GO_ON
;

3431 ià(
fcgi_mode
 !ğ
FCGI_AUTHORIZER
) {

3458 *
·thšfo
;

3461 ià(
ho¡
->
fix_roÙ_·th_Çme
 && 
ex‹nsiÚ
->
key
->
±r
[0] == '/' &&ƒxtension->key->ptr[1] == '\0') {

3462 
	`bufãr_cİy_¡ršg
(
cÚ
->
»que¡
.
·thšfo
, cÚ->
uri
.
·th
->
±r
);

3463 
	`bufãr_¡ršg_£t_Ëngth
(
cÚ
->
uri
.
·th
, 0);

3464 } ià(
ex‹nsiÚ
->
key
->
±r
[0] == '/' &&

3465 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
è> bufãr_¡ršg_Ëngth(
ex‹nsiÚ
->
key
) &&

3466 
NULL
 !ğ(
·thšfo
 = 
	`¡rchr
(
cÚ
->
uri
.
·th
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(
ex‹nsiÚ
->
key
), '/'))) {

3469 
	`bufãr_cİy_¡ršg
(
cÚ
->
»que¡
.
·thšfo
,…athinfo);

3470 
	`bufãr_¡ršg_£t_Ëngth
(
cÚ
->
uri
.
·th
, 
	`bufãr_¡ršg_Ëngth
(cÚ->uri.·thè- bufãr_¡ršg_Ëngth(cÚ->
»que¡
.
·thšfo
));

3476 ià(!
hùx
èhùx = 
	`hªdËr_ùx_š™
();

3478 
hùx
->
»mÙe_cÚn
 = 
cÚ
;

3479 
hùx
->
¶ugš_d©a
 = 
p
;

3480 
hùx
->
´oc
 = 
NULL
;

3481 
hùx
->
ext
 = 
ex‹nsiÚ
;

3482 
	`fcgi_ho¡_assign
(
¤v
, 
hùx
, 
ho¡
);

3484 
hùx
->
fcgi_mode
 = fcgi_mode;

3485 ià(
fcgi_mode
 =ğ
FCGI_AUTHORIZER
) {

3486 
hùx
->
ext_auth
 = hùx->
ext
;

3493 
hùx
->
cÚf
.
debug
 = 
p
->conf.debug;

3495 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

3497 
cÚ
->
mode
 = 
p
->
id
;

3499 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

3500 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "handling it in mod_fastcgi");

3503  
HANDLER_GO_ON
;

3504 
	}
}

3507 
hªdËr_t
 
	$fcgi_check_ex‹nsiÚ_1
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

3508  
	`fcgi_check_ex‹nsiÚ
(
¤v
, 
cÚ
, 
p_d
, 1);

3509 
	}
}

3512 
hªdËr_t
 
	$fcgi_check_ex‹nsiÚ_2
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

3513  
	`fcgi_check_ex‹nsiÚ
(
¤v
, 
cÚ
, 
p_d
, 0);

3514 
	}
}

3517 
	$TRIGGER_FUNC
(
mod_ç¡cgi_hªdË_Œigg”
) {

3518 
¶ugš_d©a
 *
p
 = 
p_d
;

3519 
size_t
 
i
, 
j
, 
n
;

3532 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

3533 
¶ugš_cÚfig
 *
cÚf
;

3534 
fcgi_exts
 *
exts
;

3536 
cÚf
 = 
p
->
cÚfig_¡Üage
[
i
];

3538 
exts
 = 
cÚf
->exts;

3539 ià(
NULL
 =ğ
exts
) ;

3541 
j
 = 0; j < 
exts
->
u£d
; j++) {

3542 
fcgi_ex‹nsiÚ
 *
ex
;

3544 
ex
 = 
exts
->exts[
j
];

3546 
n
 = 0;‚ < 
ex
->
u£d
;‚++) {

3548 
fcgi_´oc
 *
´oc
;

3549 
fcgi_ex‹nsiÚ_ho¡
 *
ho¡
;

3551 
ho¡
 = 
ex
->
ho¡s
[
n
];

3553 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

3554 
¡©us
;

3556 ià(
´oc
->
pid
 == 0) ;

3558 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

3563 ià(
”ºo
 !ğ
EINTR
) {

3565 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddss",

3566 "pid ", 
´oc
->
pid
,…roc->
¡©e
,

3567 "nÙ found:", 
	`¡»¼Ü
(
”ºo
));

3572 ià(
	`WIFEXITED
(
¡©us
)) {

3573 ià(
´oc
->
¡©e
 !ğ
PROC_STATE_KILLED
) {

3574 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

3576 
	`WEXITSTATUS
(
¡©us
), 
´oc
->
cÚÃùiÚ_Çme
);

3578 } ià(
	`WIFSIGNALED
(
¡©us
)) {

3579 ià(
	`WTERMSIG
(
¡©us
è!ğ
SIGTERM
) {

3580 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3582 
	`WTERMSIG
(
¡©us
));

3585 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3587 
¡©us
);

3589 
´oc
->
pid
 = 0;

3590 ià(
´oc
->
¡©e
 =ğ
PROC_STATE_RUNNING
è
ho¡
->
aùive_´ocs
--;

3591 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

3592 
ho¡
->
max_id
--;

3596 
	`fcgi_»¡¬t_d—d_´ocs
(
¤v
, 
p
, 
ho¡
);

3598 
´oc
 = 
ho¡
->
unu£d_´ocs
;…roc;…roøğ´oc->
Ãxt
) {

3599 
¡©us
;

3601 ià(
´oc
->
pid
 == 0) ;

3603 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

3608 ià(
”ºo
 !ğ
EINTR
) {

3610 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddss",

3611 "pid ", 
´oc
->
pid
,…roc->
¡©e
,

3612 "nÙ found:", 
	`¡»¼Ü
(
”ºo
));

3615 ià(
”ºo
 =ğ
ECHILD
) {

3617 
´oc
->
pid
 = 0;

3618 
´oc
->
¡©e
 = 
PROC_STATE_UNSET
;

3625 ià(
	`WIFEXITED
(
¡©us
)) {

3626 ià(
´oc
->
¡©e
 !ğ
PROC_STATE_KILLED
) {

3627 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

3629 
	`WEXITSTATUS
(
¡©us
), 
´oc
->
cÚÃùiÚ_Çme
);

3631 } ià(
	`WIFSIGNALED
(
¡©us
)) {

3632 ià(
	`WTERMSIG
(
¡©us
è!ğ
SIGTERM
) {

3633 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3635 
	`WTERMSIG
(
¡©us
));

3638 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3640 
¡©us
);

3642 
´oc
->
pid
 = 0;

3643 ià(
´oc
->
¡©e
 =ğ
PROC_STATE_RUNNING
è
ho¡
->
aùive_´ocs
--;

3644 
´oc
->
¡©e
 = 
PROC_STATE_UNSET
;

3645 
ho¡
->
max_id
--;

3652  
HANDLER_GO_ON
;

3653 
	}
}

3656 
mod_ç¡cgi_¶ugš_š™
(
¶ugš
 *
p
);

3657 
	$mod_ç¡cgi_¶ugš_š™
(
¶ugš
 *
p
) {

3658 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

3659 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("fastcgi");

3661 
p
->
š™
 = 
mod_ç¡cgi_š™
;

3662 
p
->
ş—nup
 = 
mod_ç¡cgi_ä“
;

3663 
p
->
£t_deçuÉs
 = 
mod_ç¡cgi_£t_deçuÉs
;

3664 
p
->
cÚÃùiÚ_»£t
 = 
fcgi_cÚÃùiÚ_»£t
;

3665 
p
->
hªdË_cÚÃùiÚ_şo£
 = 
fcgi_cÚÃùiÚ_»£t
;

3666 
p
->
hªdË_uri_ş—n
 = 
fcgi_check_ex‹nsiÚ_1
;

3667 
p
->
hªdË_sub»que¡_¡¬t
 = 
fcgi_check_ex‹nsiÚ_2
;

3668 
p
->
hªdË_sub»que¡
 = 
mod_ç¡cgi_hªdË_sub»que¡
;

3669 
p
->
hªdË_Œigg”
 = 
mod_ç¡cgi_hªdË_Œigg”
;

3671 
p
->
d©a
 = 
NULL
;

3674 
	}
}

	@mod_flv_streaming.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"»¥Ú£.h
"

7 
	~"h‰p_chunk.h
"

8 
	~"¡©_ÿche.h
"

10 
	~"¶ugš.h
"

12 
	~<ùy³.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

19 
¬¿y
 *
	mex‹nsiÚs
;

20 } 
	t¶ugš_cÚfig
;

23 
	mPLUGIN_DATA
;

25 
bufãr
 *
	mqu”y_¡r
;

26 
¬¿y
 *
	mg‘_·¿ms
;

28 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

30 
¶ugš_cÚfig
 
	mcÚf
;

31 } 
	t¶ugš_d©a
;

34 
	$INIT_FUNC
(
mod_æv_¡»amšg_š™
) {

35 
¶ugš_d©a
 *
p
;

37 
p
 = 
	`ÿÎoc
(1, (*p));

39 
p
->
qu”y_¡r
 = 
	`bufãr_š™
();

40 
p
->
g‘_·¿ms
 = 
	`¬¿y_š™
();

42  
p
;

43 
	}
}

46 
	$FREE_FUNC
(
mod_æv_¡»amšg_ä“
) {

47 
¶ugš_d©a
 *
p
 = 
p_d
;

49 
	`UNUSED
(
¤v
);

51 ià(!
p
è 
HANDLER_GO_ON
;

53 ià(
p
->
cÚfig_¡Üage
) {

54 
size_t
 
i
;

56 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

57 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

59 ià(
NULL
 =ğ
s
) ;

61 
	`¬¿y_ä“
(
s
->
ex‹nsiÚs
);

63 
	`ä“
(
s
);

65 
	`ä“
(
p
->
cÚfig_¡Üage
);

68 
	`bufãr_ä“
(
p
->
qu”y_¡r
);

69 
	`¬¿y_ä“
(
p
->
g‘_·¿ms
);

71 
	`ä“
(
p
);

73  
HANDLER_GO_ON
;

74 
	}
}

78 
	$SETDEFAULTS_FUNC
(
mod_æv_¡»amšg_£t_deçuÉs
) {

79 
¶ugš_d©a
 *
p
 = 
p_d
;

80 
size_t
 
i
 = 0;

82 
cÚfig_v®ues_t
 
cv
[] = {

83 { "æv-¡»amšg.ex‹nsiÚs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

84 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

87 ià(!
p
è 
HANDLER_ERROR
;

89 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

91 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

92 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

93 
¶ugš_cÚfig
 *
s
;

95 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

96 
s
->
ex‹nsiÚs
 = 
	`¬¿y_š™
();

98 
cv
[0].
de¡š©iÚ
 = 
s
->
ex‹nsiÚs
;

100 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

102 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

103  
HANDLER_ERROR
;

107  
HANDLER_GO_ON
;

108 
	}
}

110 
	#PATCH
(
x
) \

111 
p
->
cÚf
.
x
 = 
s
->x;

	)

112 
	$mod_æv_¡»amšg_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

113 
size_t
 
i
, 
j
;

114 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

116 
	`PATCH
(
ex‹nsiÚs
);

119 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

120 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

121 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

124 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

127 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

128 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

130 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("flv-streaming.extensions"))) {

131 
	`PATCH
(
ex‹nsiÚs
);

137 
	}
}

138 #undeà
PATCH


140 
	$¥l™_g‘_·¿ms
(
¬¿y
 *
g‘_·¿ms
, 
bufãr
 *
qry¡r
) {

141 
size_t
 
is_key
 = 1;

142 
size_t
 
i
, 
Ën
;

143 *
key
 = 
NULL
, *
v®
 = NULL;

145 
key
 = 
qry¡r
->
±r
;

148 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
qry¡r
);

149 
i
 = 0; i <ğ
Ën
; i++) {

150 
qry¡r
->
±r
[
i
]) {

152 ià(
is_key
) {

153 
v®
 = 
qry¡r
->
±r
 + 
i
 + 1;

155 
qry¡r
->
±r
[
i
] = '\0';

157 
is_key
 = 0;

163 ià(!
is_key
) {

164 
d©a_¡ršg
 *
ds
;

168 
qry¡r
->
±r
[
i
] = '\0';

170 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
g‘_·¿ms
, 
TYPE_STRING
))) {

171 
ds
 = 
	`d©a_¡ršg_š™
();

173 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
	`¡¾’
(key));

174 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
v®
, 
	`¡¾’
(val));

176 
	`¬¿y_š£¹_unique
(
g‘_·¿ms
, (
d©a_un£t
 *)
ds
);

179 
key
 = 
qry¡r
->
±r
 + 
i
 + 1;

180 
v®
 = 
NULL
;

181 
is_key
 = 1;

187 
	}
}

189 
	$URIHANDLER_FUNC
(
mod_æv_¡»amšg_·th_hªdËr
) {

190 
¶ugš_d©a
 *
p
 = 
p_d
;

191 
s_Ën
;

192 
size_t
 
k
;

194 
	`UNUSED
(
¤v
);

196 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

198 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

200 
	`mod_æv_¡»amšg_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

202 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
physiÿl
.
·th
);

204 
k
 = 0; k < 
p
->
cÚf
.
ex‹nsiÚs
->
u£d
; k++) {

205 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
ex‹nsiÚs
->
d©a
[
k
];

206 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

208 ià(
ù_Ën
 > 
s_Ën
) ;

209 ià(
	`bufãr_is_em±y
(
ds
->
v®ue
)) ;

211 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
physiÿl
.
·th
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
v®ue
->ptr, ct_len)) {

212 
d©a_¡ršg
 *
g‘_·¿m
;

213 
¡¬t
;

214 *
”r
 = 
NULL
;

218 
	`¬¿y_»£t
(
p
->
g‘_·¿ms
);

219 
	`bufãr_cİy_bufãr
(
p
->
qu”y_¡r
, 
cÚ
->
uri
.
qu”y
);

220 
	`¥l™_g‘_·¿ms
(
p
->
g‘_·¿ms
,…->
qu”y_¡r
);

222 ià(
NULL
 =ğ(
g‘_·¿m
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
p
->
g‘_·¿ms
, "start"))) {

223  
HANDLER_GO_ON
;

227 ià(
	`bufãr_¡ršg_is_em±y
(
g‘_·¿m
->
v®ue
)è 
HANDLER_GO_ON
;

230 
¡¬t
 = 
	`¡¹Ş
(
g‘_·¿m
->
v®ue
->
±r
, &
”r
, 10);

231 ià(*
”r
 != '\0') {

232  
HANDLER_GO_ON
;

235 ià(
¡¬t
 <ğ0è 
HANDLER_GO_ON
;

238 
	`h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("FLV\x1\x1\0\0\0\x9\0\0\0\x9"));

239 ià(0 !ğ
	`h‰p_chunk_­³nd_fe_¿nge
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, 
¡¬t
, -1)) {

240 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

241  
HANDLER_GO_ON
;

244 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("video/x-flv"));

246 
cÚ
->
fe_fšished
 = 1;

248  
HANDLER_FINISHED
;

253  
HANDLER_GO_ON
;

254 
	}
}

258 
mod_æv_¡»amšg_¶ugš_š™
(
¶ugš
 *
p
);

259 
	$mod_æv_¡»amšg_¶ugš_š™
(
¶ugš
 *
p
) {

260 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

261 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("flv_streaming");

263 
p
->
š™
 = 
mod_æv_¡»amšg_š™
;

264 
p
->
hªdË_physiÿl
 = 
mod_æv_¡»amšg_·th_hªdËr
;

265 
p
->
£t_deçuÉs
 = 
mod_æv_¡»amšg_£t_deçuÉs
;

266 
p
->
ş—nup
 = 
mod_æv_¡»amšg_ä“
;

268 
p
->
d©a
 = 
NULL
;

271 
	}
}

	@mod_geoip.c

1 
	~"fœ¡.h
"

3 
	~<GeoIP.h
>

4 
	~<GeoIPC™y.h
>

6 
	~"ba£.h
"

7 
	~"log.h
"

8 
	~"bufãr.h
"

9 
	~"¶ugš.h
"

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

60 
	mmem_ÿche
;

61 
bufãr
 *
	mdb_Çme
;

62 
GeoIP
 *
	mgi
;

63 } 
	t¶ugš_cÚfig
;

66 
	mPLUGIN_DATA
;

68 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

70 
¶ugš_cÚfig
 
	mcÚf
;

71 } 
	t¶ugš_d©a
;

74 
	$INIT_FUNC
(
mod_geo_š™
) {

75 
¶ugš_d©a
 *
p
;

77 
p
 = 
	`ÿÎoc
(1, (*p));

79  
p
;

80 
	}
}

83 
	$FREE_FUNC
(
mod_geo_ä“
) {

84 
¶ugš_d©a
 *
p
 = 
p_d
;

86 
	`UNUSED
(
¤v
);

88 ià(!
p
è 
HANDLER_GO_ON
;

90 ià(
p
->
cÚfig_¡Üage
) {

91 
size_t
 
i
;

93 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

94 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

96 ià(!
s
) ;

98 
	`bufãr_ä“
(
s
->
db_Çme
);

101 ià(
s
->
gi
è
	`GeoIP_d–‘e
(s->gi);

103 
	`ä“
(
s
);

105 
	`ä“
(
p
->
cÚfig_¡Üage
);

108 
	`ä“
(
p
);

110  
HANDLER_GO_ON
;

111 
	}
}

115 
	$SETDEFAULTS_FUNC
(
mod_geo_£t_deçuÉs
) {

116 
¶ugš_d©a
 *
p
 = 
p_d
;

117 
size_t
 
i
 = 0;

119 
cÚfig_v®ues_t
 
cv
[] = {

120 { "geo.db-f’ame", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

121 { "geo.memÜy-ÿche", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

122 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

125 ià(!
p
è 
HANDLER_ERROR
;

127 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

129 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

130 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

131 
¶ugš_cÚfig
 *
s
;

132 
mode
;

134 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

136 
s
->
db_Çme
 = 
	`bufãr_š™
();

137 
s
->
mem_ÿche
 = 0;

138 
s
->
gi
 = 
NULL
;

140 
cv
[0].
de¡š©iÚ
 = 
s
->
db_Çme
;

141 
cv
[1].
de¡š©iÚ
 = &(
s
->
mem_ÿche
);

143 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

145 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

146  
HANDLER_ERROR
;

149 
mode
 = 
GEOIP_STANDARD
 | 
GEOIP_CHECK_CACHE
;

152 ià(!
	`bufãr_is_em±y
(
s
->
db_Çme
)) {

155 ià(
s
->
mem_ÿche
 != 0)

156 
mode
 = 
GEOIP_MEMORY_CACHE
 | 
GEOIP_CHECK_CACHE
;

158 ià(
NULL
 =ğ(
s
->
gi
 = 
	`GeoIP_İ’
(s->
db_Çme
->
±r
, 
mode
))) {

159 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

162  
HANDLER_ERROR
;

166 ià(
s
->
gi
->
d©aba£Ty³
 !ğ
GEOIP_COUNTRY_EDITION
 &&

167 
s
->
gi
->
d©aba£Ty³
 !ğ
GEOIP_CITY_EDITION_REV0
 &&

168 
s
->
gi
->
d©aba£Ty³
 !ğ
GEOIP_CITY_EDITION_REV1
) {

169 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

175  
HANDLER_GO_ON
;

176 
	}
}

178 
	#PATCH
(
x
) \

179 
p
->
cÚf
.
x
 = 
s
->x;

	)

180 
	$mod_geo_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

181 
size_t
 
i
, 
j
;

182 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

184 
	`PATCH
(
db_Çme
);

185 
	`PATCH
(
mem_ÿche
);

186 
	`PATCH
(
gi
);

189 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

190 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

191 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

194 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

197 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

198 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

200 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("geoip.db-filename"))) {

201 
	`PATCH
(
db_Çme
);

204 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("geoip.memory-cache"))) {

205 
	`PATCH
(
mem_ÿche
);

211 
	}
}

212 #undeà
PATCH


214 
	$URIHANDLER_FUNC
(
mod_geo_sub»que¡
) {

215 
¶ugš_d©a
 *
p
 = 
p_d
;

217 
	`mod_geo_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

219 ià(!
	`bufãr_is_em±y
(
p
->
cÚf
.
db_Çme
)) {

220 cÚ¡ *
»mÙe_
;

221 
d©a_¡ršg
 *
ds
;

222 
GeoIPRecÜd
 *
gœ
;

223 cÚ¡ *
»tuºedCouÁry
;

225 
»mÙe_
 = 
cÚ
->
d¡_addr_buf
->
±r
;

227 ià(
p
->
cÚf
.
gi
->
d©aba£Ty³
 =ğ
GEOIP_COUNTRY_EDITION
) {

229 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_COUNTRY_CODE"))) {

230 ià(
NULL
 !ğ(
»tuºedCouÁry
 = 
	`GeoIP_couÁry_code_by_addr
(
p
->
cÚf
.
gi
, 
»mÙe_
))) {

231 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

232 
ds
 = 
	`d©a_¡ršg_š™
();

235 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_COUNTRY_CODE");

236 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
»tuºedCouÁry
);

237 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

242 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_COUNTRY_CODE3"))) {

243 ià(
NULL
 !ğ(
»tuºedCouÁry
 = 
	`GeoIP_couÁry_code3_by_addr
(
p
->
cÚf
.
gi
, 
»mÙe_
))) {

244 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

245 
ds
 = 
	`d©a_¡ršg_š™
();

248 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_COUNTRY_CODE3");

249 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
»tuºedCouÁry
);

250 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

255 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_COUNTRY_NAME"))) {

256 ià(
NULL
 !ğ(
»tuºedCouÁry
 = 
	`GeoIP_couÁry_Çme_by_addr
(
p
->
cÚf
.
gi
, 
»mÙe_
))) {

257 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

258 
ds
 = 
	`d©a_¡ršg_š™
();

261 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_COUNTRY_NAME");

262 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
»tuºedCouÁry
);

263 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

268  
HANDLER_GO_ON
;

273 ià(
NULL
 !ğ(
gœ
 = 
	`GeoIP_»cÜd_by_addr
(
p
->
cÚf
.
gi
, 
»mÙe_
))) {

275 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_COUNTRY_CODE"))) {

276 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

277 
ds
 = 
	`d©a_¡ršg_š™
();

280 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_COUNTRY_CODE");

281 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
gœ
->
couÁry_code
);

282 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

286 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_COUNTRY_CODE3"))) {

287 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

288 
ds
 = 
	`d©a_¡ršg_š™
();

291 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_COUNTRY_CODE3");

292 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
gœ
->
couÁry_code3
);

293 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

297 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_COUNTRY_NAME"))) {

298 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

299 
ds
 = 
	`d©a_¡ršg_š™
();

302 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_COUNTRY_NAME");

303 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
gœ
->
couÁry_Çme
);

304 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

308 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_REGION"))) {

309 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

310 
ds
 = 
	`d©a_¡ršg_š™
();

313 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_REGION");

314 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
gœ
->
»giÚ
);

315 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

319 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_NAME"))) {

320 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

321 
ds
 = 
	`d©a_¡ršg_š™
();

324 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_NAME");

325 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
gœ
->
c™y
);

326 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

330 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_POSTAL_CODE"))) {

331 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

332 
ds
 = 
	`d©a_¡ršg_š™
();

335 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_POSTAL_CODE");

336 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
gœ
->
po¡®_code
);

337 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

341 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_LATITUDE"))) {

342 
Ït™ude
[32];

343 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

344 
ds
 = 
	`d©a_¡ršg_š™
();

347 
	`¢´štf
(
Ït™ude
, Ö©™ude), "%f", 
gœ
->latitude);

348 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_LATITUDE");

349 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
Ït™ude
);

350 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

354 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_LONG_LATITUDE"))) {

355 
lÚg_Ït™ude
[32];

356 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

357 
ds
 = 
	`d©a_¡ršg_š™
();

360 
	`¢´štf
(
lÚg_Ït™ude
, ÖÚg_Ït™ude), "%f", 
gœ
->
lÚg™ude
);

361 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_LONG_LATITUDE");

362 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
lÚg_Ït™ude
);

363 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

367 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_DMA_CODE"))) {

368 
dc
[5];

369 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

370 
ds
 = 
	`d©a_¡ršg_š™
();

373 
	`¢´štf
(
dc
, (dc), "%i", 
gœ
->
dma_code
);

374 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_DMA_CODE");

375 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
dc
);

376 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

380 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "GEOIP_CITY_AREA_CODE"))) {

381 
ac
[5];

382 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

383 
ds
 = 
	`d©a_¡ršg_š™
();

386 
	`¢´štf
(
ac
, ×c), "%i", 
gœ
->
¬—_code
);

387 
	`bufãr_cİy_¡ršg
(
ds
->
key
, "GEOIP_CITY_AREA_CODE");

388 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
ac
);

389 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

392 
	`GeoIPRecÜd_d–‘e
(
gœ
);

397  
HANDLER_GO_ON
;

398 
	}
}

402 
mod_geo_¶ugš_š™
(
¶ugš
 *
p
);

403 
	$mod_geo_¶ugš_š™
(
¶ugš
 *
p
) {

404 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

405 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("geoip");

407 
p
->
š™
 = 
mod_geo_š™
;

408 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_geo_sub»que¡
;

409 
p
->
£t_deçuÉs
 = 
mod_geo_£t_deçuÉs
;

410 
p
->
ş—nup
 = 
mod_geo_ä“
;

412 
p
->
d©a
 = 
NULL
;

415 
	}
}

	@mod_indexfile.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"¡©_ÿche.h
"

11 
	~<ùy³.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<”ºo.h
>

19 
¬¿y
 *
	mšdexfes
;

20 } 
	t¶ugš_cÚfig
;

23 
	mPLUGIN_DATA
;

25 
bufãr
 *
	mtmp_buf
;

27 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

29 
¶ugš_cÚfig
 
	mcÚf
;

30 } 
	t¶ugš_d©a
;

33 
	$INIT_FUNC
(
mod_šdexfe_š™
) {

34 
¶ugš_d©a
 *
p
;

36 
p
 = 
	`ÿÎoc
(1, (*p));

38 
p
->
tmp_buf
 = 
	`bufãr_š™
();

40  
p
;

41 
	}
}

44 
	$FREE_FUNC
(
mod_šdexfe_ä“
) {

45 
¶ugš_d©a
 *
p
 = 
p_d
;

47 
	`UNUSED
(
¤v
);

49 ià(!
p
è 
HANDLER_GO_ON
;

51 ià(
p
->
cÚfig_¡Üage
) {

52 
size_t
 
i
;

53 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

54 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

56 ià(
NULL
 =ğ
s
) ;

58 
	`¬¿y_ä“
(
s
->
šdexfes
);

60 
	`ä“
(
s
);

62 
	`ä“
(
p
->
cÚfig_¡Üage
);

65 
	`bufãr_ä“
(
p
->
tmp_buf
);

67 
	`ä“
(
p
);

69  
HANDLER_GO_ON
;

70 
	}
}

74 
	$SETDEFAULTS_FUNC
(
mod_šdexfe_£t_deçuÉs
) {

75 
¶ugš_d©a
 *
p
 = 
p_d
;

76 
size_t
 
i
 = 0;

78 
cÚfig_v®ues_t
 
cv
[] = {

79 { "šdex-fe.Çmes", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

80 { "£rv”.šdexfes", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

81 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

84 ià(!
p
è 
HANDLER_ERROR
;

86 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

88 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

89 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

90 
¶ugš_cÚfig
 *
s
;

92 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

93 
s
->
šdexfes
 = 
	`¬¿y_š™
();

95 
cv
[0].
de¡š©iÚ
 = 
s
->
šdexfes
;

96 
cv
[1].
de¡š©iÚ
 = 
s
->
šdexfes
;

98 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

100 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

101  
HANDLER_ERROR
;

105  
HANDLER_GO_ON
;

106 
	}
}

108 
	#PATCH
(
x
) \

109 
p
->
cÚf
.
x
 = 
s
->x;

	)

110 
	$mod_šdexfe_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

111 
size_t
 
i
, 
j
;

112 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

114 
	`PATCH
(
šdexfes
);

117 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

118 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

119 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

122 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

125 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

126 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

128 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("server.indexfiles"))) {

129 
	`PATCH
(
šdexfes
);

130 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("index-file.names"))) {

131 
	`PATCH
(
šdexfes
);

137 
	}
}

138 #undeà
PATCH


140 
	$URIHANDLER_FUNC
(
mod_šdexfe_sub»que¡
) {

141 
¶ugš_d©a
 *
p
 = 
p_d
;

142 
size_t
 
k
;

143 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

145 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

147 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

148 ià(
cÚ
->
uri
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(cÚ->uri.·thè- 1] !ğ'/'è 
HANDLER_GO_ON
;

150 
	`mod_šdexfe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

152 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

153 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- handlinghe„equest‡s Indexfile");

154 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI :", 
cÚ
->
uri
.
·th
);

158 
k
 = 0; k < 
p
->
cÚf
.
šdexfes
->
u£d
; k++) {

159 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
šdexfes
->
d©a
[
k
];

161 ià(
ds
->
v®ue
 && ds->v®ue->
±r
[0] == '/') {

164 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
, 
cÚ
->
physiÿl
.
doc_roÙ
);

166 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
, 
cÚ
->
physiÿl
.
·th
);

168 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
tmp_buf
, 
ds
->
v®ue
);

170 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
p
->
tmp_buf
, &
sû
)) {

171 ià(
”ºo
 =ğ
EACCES
) {

172 
cÚ
->
h‰p_¡©us
 = 403;

173 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

175  
HANDLER_FINISHED
;

178 ià(
”ºo
 !ğ
ENOENT
 &&

179 
”ºo
 !ğ
ENOTDIR
) {

182 
cÚ
->
h‰p_¡©us
 = 500;

184 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsb",

185 "fnÙ found ... o¸so: ", 
	`¡»¼Ü
(
”ºo
),

186 
cÚ
->
uri
.
·th
,

187 "->", 
cÚ
->
physiÿl
.
·th
);

189 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

191  
HANDLER_FINISHED
;

196 ià(
ds
->
v®ue
 && ds->v®ue->
±r
[0] == '/') {

198 
	`bufãr_cİy_bufãr
(
cÚ
->
uri
.
·th
, 
ds
->
v®ue
);

200 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

201 
ds
 = 
	`d©a_¡ršg_š™
();

203 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("PATH_TRANSLATED_DIRINDEX"));

204 
	`bufãr_cİy_bufãr
(
ds
->
v®ue
, 
cÚ
->
physiÿl
.
·th
);

205 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds
);

208 
	`bufãr_­³nd_¡ršg_bufãr
(
cÚ
->
uri
.
·th
, 
ds
->
v®ue
);

211 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
p
->
tmp_buf
);

213  
HANDLER_GO_ON
;

217  
HANDLER_GO_ON
;

218 
	}
}

222 
mod_šdexfe_¶ugš_š™
(
¶ugš
 *
p
);

223 
	$mod_šdexfe_¶ugš_š™
(
¶ugš
 *
p
) {

224 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

225 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("indexfile");

227 
p
->
š™
 = 
mod_šdexfe_š™
;

228 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_šdexfe_sub»que¡
;

229 
p
->
£t_deçuÉs
 = 
mod_šdexfe_£t_deçuÉs
;

230 
p
->
ş—nup
 = 
mod_šdexfe_ä“
;

232 
p
->
d©a
 = 
NULL
;

235 
	}
}

	@mod_magnet.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"h‰p_chunk.h
"

8 
	~"¶ugš.h
"

10 
	~"mod_magÃt_ÿche.h
"

11 
	~"»¥Ú£.h
"

12 
	~"¡©_ÿche.h
"

13 
	~"¡©us_couÁ”.h
"

14 
	~"‘ag.h
"

16 
	~<ùy³.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

19 
	~<as£¹.h
>

20 
	~<£tjmp.h
>

22 
	~<lua.h
>

23 
	~<Ïuxlib.h
>

25 
	#LUA_RIDX_LIGHTTPD_SERVER
 "lighty.¤v"

	)

26 
	#LUA_RIDX_LIGHTTPD_CONNECTION
 "lighty.cÚ"

	)

28 
	#MAGNET_CONFIG_RAW_URL
 "magÃt.©Œaù-¿w-u¾-to"

	)

29 
	#MAGNET_CONFIG_PHYSICAL_PATH
 "magÃt.©Œaù-physiÿl-·th-to"

	)

30 
	#MAGNET_RESTART_REQUEST
 99

	)

34 
jmp_buf
 
	gexû±iÚjmp
;

37 
¬¿y
 *
	mu¾_¿w
;

38 
¬¿y
 *
	mphysiÿl_·th
;

39 } 
	t¶ugš_cÚfig
;

42 
	mPLUGIN_DATA
;

44 
süt_ÿche
 *
	mÿche
;

46 
bufãr
 *
	m’code_buf
;

48 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

50 
¶ugš_cÚfig
 
	mcÚf
;

51 } 
	t¶ugš_d©a
;

54 
	$INIT_FUNC
(
mod_magÃt_š™
) {

55 
¶ugš_d©a
 *
p
;

57 
p
 = 
	`ÿÎoc
(1, (*p));

59 
p
->
ÿche
 = 
	`süt_ÿche_š™
();

60 
p
->
’code_buf
 = 
	`bufãr_š™
();

62  
p
;

63 
	}
}

66 
	$FREE_FUNC
(
mod_magÃt_ä“
) {

67 
¶ugš_d©a
 *
p
 = 
p_d
;

69 
	`UNUSED
(
¤v
);

71 ià(!
p
è 
HANDLER_GO_ON
;

73 ià(
p
->
cÚfig_¡Üage
) {

74 
size_t
 
i
;

76 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

77 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

79 ià(
NULL
 =ğ
s
) ;

81 
	`¬¿y_ä“
(
s
->
u¾_¿w
);

82 
	`¬¿y_ä“
(
s
->
physiÿl_·th
);

84 
	`ä“
(
s
);

86 
	`ä“
(
p
->
cÚfig_¡Üage
);

89 
	`süt_ÿche_ä“
(
p
->
ÿche
);

90 
	`bufãr_ä“
(
p
->
’code_buf
);

92 
	`ä“
(
p
);

94  
HANDLER_GO_ON
;

95 
	}
}

99 
	$SETDEFAULTS_FUNC
(
mod_magÃt_£t_deçuÉs
) {

100 
¶ugš_d©a
 *
p
 = 
p_d
;

101 
size_t
 
i
 = 0;

103 
cÚfig_v®ues_t
 
cv
[] = {

104 { 
MAGNET_CONFIG_RAW_URL
, 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

105 { 
MAGNET_CONFIG_PHYSICAL_PATH
, 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

106 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

109 ià(!
p
è 
HANDLER_ERROR
;

111 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

113 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

114 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

115 
¶ugš_cÚfig
 *
s
;

117 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

118 
s
->
u¾_¿w
 = 
	`¬¿y_š™
();

119 
s
->
physiÿl_·th
 = 
	`¬¿y_š™
();

121 
cv
[0].
de¡š©iÚ
 = 
s
->
u¾_¿w
;

122 
cv
[1].
de¡š©iÚ
 = 
s
->
physiÿl_·th
;

124 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

126 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

127  
HANDLER_ERROR
;

131  
HANDLER_GO_ON
;

132 
	}
}

134 
	#PATCH
(
x
) \

135 
p
->
cÚf
.
x
 = 
s
->x;

	)

136 
	$mod_magÃt_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

137 
size_t
 
i
, 
j
;

138 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

140 
	`PATCH
(
u¾_¿w
);

141 
	`PATCH
(
physiÿl_·th
);

144 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

145 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

146 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

149 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

152 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

153 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

155 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
MAGNET_CONFIG_RAW_URL
))) {

156 
	`PATCH
(
u¾_¿w
);

157 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
(
MAGNET_CONFIG_PHYSICAL_PATH
))) {

158 
	`PATCH
(
physiÿl_·th
);

164 
	}
}

165 #undeà
PATCH


167 #ià!
defšed
(
LUA_VERSION_NUM
) || LUA_VERSION_NUM < 502

169 
	$lua_pushglob®bË
(
lua_S‹
 *
L
) {

170 
	`lua_pushv®ue
(
L
, 
LUA_GLOBALSINDEX
);

171 
	}
}

174 
	$magÃt_£tãnv_mašâ
(
lua_S‹
 *
L
, 
funcIndex
) {

175 #ià
	`defšed
(
LUA_VERSION_NUM
) && LUA_VERSION_NUM >= 502

180 cÚ¡ * 
fœ¡_upv®ue_Çme
 = 
	`lua_g‘upv®ue
(
L
, 
funcIndex
, 1);

181 ià(
NULL
 =ğ
fœ¡_upv®ue_Çme
) ;

182 
	`lua_pİ
(
L
, 1);

184 ià(0 !ğ
	`¡rcmp
(
fœ¡_upv®ue_Çme
, "_ENV")) ;

186 ià(
NULL
 =ğ
	`lua_£tupv®ue
(
L
, 
funcIndex
, 1)) {

188 
	`lua_pİ
(
L
, 1);

191 
	`lua_£tãnv
(
L
, 
funcIndex
);

193 
	}
}

195 #ià!
defšed
(
LUA_VERSION_NUM
) || LUA_VERSION_NUM < 502

201 
	$magÃt_·œs
(
lua_S‹
 *
L
) {

202 
	`luaL_checkªy
(
L
, 1);

204 ià(
	`luaL_g‘m‘af›ld
(
L
, 1, "__pairs")) {

206 
	`lua_pushv®ue
(
L
, 1);

207 
	`lua_ÿÎ
(
L
, 1, 3);

210 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

211 
	`lua_pushv®ue
(
L
, 1);

212 
	`lua_ÿÎ
(
L
, 1, 3);

215 
	}
}

219 
	$magÃt_¬¿y_Ãxt
(
lua_S‹
 *
L
) {

220 
d©a_un£t
 *
du
;

221 
d©a_¡ršg
 *
ds
;

222 
d©a_š‹g”
 *
di
;

224 
size_t
 
pos
 = 
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(1));

225 
¬¿y
 *
a
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(2));

227 
	`lua_£‰İ
(
L
, 0);

229 ià(
pos
 >ğ
a
->
u£d
)  0;

230 ià(
NULL
 !ğ(
du
 = 
a
->
d©a
[
pos
])) {

231 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
du
->
key
));

232 
du
->
ty³
) {

233 
TYPE_STRING
:

234 
ds
 = (
d©a_¡ršg
 *)
du
;

235 ià(!
	`bufãr_is_em±y
(
ds
->
v®ue
)) {

236 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
));

238 
	`lua_pushn
(
L
);

241 
TYPE_INTEGER
:

242 
di
 = (
d©a_š‹g”
 *)
du
;

243 
	`lua_pushš‹g”
(
L
, 
di
->
v®ue
);

246 
	`lua_pushn
(
L
);

251 
pos
++;

252 
	`lua_pushš‹g”
(
L
, 
pos
);

253 
	`lua_»¶aû
(
L
, 
	`lua_upv®uešdex
(1));

259 
	}
}

262 
	$magÃt_¬¿y_·œs
(
lua_S‹
 *
L
, 
¬¿y
 *
a
) {

263 
	`lua_pushš‹g”
(
L
, 0);

264 
	`lua_pushlightu£rd©a
(
L
, 
a
);

265 
	`lua_pushcşosu»
(
L
, 
magÃt_¬¿y_Ãxt
, 2);

267 
	}
}

269 
£rv”
* 
	$magÃt_g‘_£rv”
(
lua_S‹
 *
L
) {

270 
£rv”
 *
¤v
;

272 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_LIGHTTPD_SERVER
);

273 
¤v
 = 
	`lua_tou£rd©a
(
L
, -1);

274 
	`lua_pİ
(
L
, 1);

276  
¤v
;

277 
	}
}

279 
cÚÃùiÚ
* 
	$magÃt_g‘_cÚÃùiÚ
(
lua_S‹
 *
L
) {

280 
cÚÃùiÚ
 *
cÚ
;

282 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_LIGHTTPD_CONNECTION
);

283 
cÚ
 = 
	`lua_tou£rd©a
(
L
, -1);

284 
	`lua_pİ
(
L
, 1);

286  
cÚ
;

287 
	}
}

290 cÚ¡ *
	m±r
;

291 
size_t
 
	mËn
;

292 } 
	tcÚ¡_bufãr
;

294 
cÚ¡_bufãr
 
	$magÃt_checkcÚ¡bufãr
(
lua_S‹
 *
L
, 
šdex
) {

295 
cÚ¡_bufãr
 
cb
;

296 
cb
.
±r
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, &cb.
Ën
);

297  
cb
;

298 
	}
}

300 
bufãr
* 
	$magÃt_checkbufãr
(
lua_S‹
 *
L
, 
šdex
) {

301 
cÚ¡_bufãr
 
cb
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, 
šdex
);

302 
bufãr
 *
b
 = 
	`bufãr_š™
();

303 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
cb
.
±r
, cb.
Ën
);

304  
b
;

305 
	}
}

307 
	$magÃt_´št
(
lua_S‹
 *
L
) {

308 
bufãr
 *
b
 = 
	`magÃt_checkbufãr
(
L
, 1);

310 
	`log_”rÜ_wr™e
(
	`magÃt_g‘_£rv”
(
L
), 
__FILE__
, 
__LINE__
, "sB",

312 
b
);

314 
	`bufãr_ä“
(
b
);

317 
	}
}

319 
	$magÃt_¡©
(
lua_S‹
 *
L
) {

320 
bufãr
 *
sb
 = 
	`magÃt_checkbufãr
(
L
, 1);

321 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

322 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

323 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

324 
hªdËr_t
 
»s
;

326 
»s
 = 
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
sb
, &
sû
);

327 
	`bufãr_ä“
(
sb
);

329 ià(
HANDLER_GO_ON
 !ğ
»s
) {

330 
	`lua_pushn
(
L
);

334 
	`lua_ÃwbË
(
L
);

336 
	`lua_pushboŞ—n
(
L
, 
	`S_ISREG
(
sû
->
¡
.
¡_mode
));

337 
	`lua_£tf›ld
(
L
, -2, "is_file");

339 
	`lua_pushboŞ—n
(
L
, 
	`S_ISDIR
(
sû
->
¡
.
¡_mode
));

340 
	`lua_£tf›ld
(
L
, -2, "is_dir");

342 
	`lua_pushboŞ—n
(
L
, 
	`S_ISCHR
(
sû
->
¡
.
¡_mode
));

343 
	`lua_£tf›ld
(
L
, -2, "is_char");

345 
	`lua_pushboŞ—n
(
L
, 
	`S_ISBLK
(
sû
->
¡
.
¡_mode
));

346 
	`lua_£tf›ld
(
L
, -2, "is_block");

348 
	`lua_pushboŞ—n
(
L
, 
	`S_ISSOCK
(
sû
->
¡
.
¡_mode
));

349 
	`lua_£tf›ld
(
L
, -2, "is_socket");

351 
	`lua_pushboŞ—n
(
L
, 
	`S_ISLNK
(
sû
->
¡
.
¡_mode
));

352 
	`lua_£tf›ld
(
L
, -2, "is_link");

354 
	`lua_pushboŞ—n
(
L
, 
	`S_ISFIFO
(
sû
->
¡
.
¡_mode
));

355 
	`lua_£tf›ld
(
L
, -2, "is_fifo");

357 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_mtime
);

358 
	`lua_£tf›ld
(
L
, -2, "st_mtime");

360 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_ùime
);

361 
	`lua_£tf›ld
(
L
, -2, "st_ctime");

363 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_©ime
);

364 
	`lua_£tf›ld
(
L
, -2, "st_atime");

366 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_uid
);

367 
	`lua_£tf›ld
(
L
, -2, "st_uid");

369 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_gid
);

370 
	`lua_£tf›ld
(
L
, -2, "st_gid");

372 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_size
);

373 
	`lua_£tf›ld
(
L
, -2, "st_size");

375 
	`lua_pushš‹g”
(
L
, 
sû
->
¡
.
¡_šo
);

376 
	`lua_£tf›ld
(
L
, -2, "st_ino");

378 ià(!
	`bufãr_¡ršg_is_em±y
(
sû
->
‘ag
)) {

380 
bufãr
 *
b
 = 
	`bufãr_š™
();

381 
	`‘ag_mu‹
(
b
, 
sû
->
‘ag
);

383 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
b
));

384 
	`bufãr_ä“
(
b
);

386 
	`lua_pushn
(
L
);

388 
	`lua_£tf›ld
(
L
, -2, "etag");

390 ià(!
	`bufãr_¡ršg_is_em±y
(
sû
->
cÚ‹Á_ty³
)) {

391 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
sû
->
cÚ‹Á_ty³
));

393 
	`lua_pushn
(
L
);

395 
	`lua_£tf›ld
(
L
, -2, "content-type");

398 
	}
}

401 
	$magÃt_©·nic
(
lua_S‹
 *
L
) {

402 
bufãr
 *
b
 = 
	`magÃt_checkbufãr
(
L
, 1);

404 
	`log_”rÜ_wr™e
(
	`magÃt_g‘_£rv”
(
L
), 
__FILE__
, 
__LINE__
, "sB",

406 
b
);

408 
	`bufãr_ä“
(
b
);

410 
	`lÚgjmp
(
exû±iÚjmp
, 1);

411 
	}
}

413 
	$magÃt_»qhdr_g‘
(
lua_S‹
 *
L
) {

414 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

415 
d©a_¡ršg
 *
ds
;

418 cÚ¡ *
key
 = 
	`luaL_check¡ršg
(
L
, 2);

420 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
key
))) {

421 ià(!
	`bufãr_is_em±y
(
ds
->
v®ue
)) {

422 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
));

424 
	`lua_pushn
(
L
);

427 
	`lua_pushn
(
L
);

430 
	}
}

432 
	$magÃt_»qhdr_·œs
(
lua_S‹
 *
L
) {

433 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

435  
	`magÃt_¬¿y_·œs
(
L
, 
cÚ
->
»que¡
.
h—d”s
);

436 
	}
}

438 
	$magÃt_¡©us_g‘
(
lua_S‹
 *
L
) {

439 
d©a_š‹g”
 *
di
;

440 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

443 
cÚ¡_bufãr
 
key
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, 2);

445 
di
 = 
	`¡©us_couÁ”_g‘_couÁ”
(
¤v
, 
key
.
±r
, key.
Ën
);

447 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
di
->
v®ue
);

450 
	}
}

452 
	$magÃt_¡©us_£t
(
lua_S‹
 *
L
) {

453 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

456 
cÚ¡_bufãr
 
key
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, 2);

457 
couÁ”
 = (è
	`luaL_checkš‹g”
(
L
, 3);

459 
	`¡©us_couÁ”_£t
(
¤v
, 
key
.
±r
, key.
Ën
, 
couÁ”
);

462 
	}
}

464 
	$magÃt_¡©us_·œs
(
lua_S‹
 *
L
) {

465 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

467  
	`magÃt_¬¿y_·œs
(
L
, 
¤v
->
¡©us
);

468 
	}
}

471 cÚ¡ *
	mÇme
;

473 
	mMAGNET_ENV_UNSET
,

475 
	mMAGNET_ENV_PHYICAL_PATH
,

476 
	mMAGNET_ENV_PHYICAL_REL_PATH
,

477 
	mMAGNET_ENV_PHYICAL_DOC_ROOT
,

478 
	mMAGNET_ENV_PHYICAL_BASEDIR
,

480 
	mMAGNET_ENV_URI_PATH
,

481 
	mMAGNET_ENV_URI_PATH_RAW
,

482 
	mMAGNET_ENV_URI_SCHEME
,

483 
	mMAGNET_ENV_URI_AUTHORITY
,

484 
	mMAGNET_ENV_URI_QUERY
,

486 
	mMAGNET_ENV_REQUEST_METHOD
,

487 
	mMAGNET_ENV_REQUEST_URI
,

488 
	mMAGNET_ENV_REQUEST_ORIG_URI
,

489 
	mMAGNET_ENV_REQUEST_PATH_INFO
,

490 
	mMAGNET_ENV_REQUEST_REMOTE_IP
,

491 
	mMAGNET_ENV_REQUEST_PROTOCOL


492 } 
	mty³
;

493 } 
	tmagÃt_’v_t
;

495 cÚ¡ 
magÃt_’v_t
 
	gmagÃt_’v
[] = {

496 { "physiÿl.·th", 
MAGNET_ENV_PHYICAL_PATH
 },

497 { "physiÿl.»l-·th", 
MAGNET_ENV_PHYICAL_REL_PATH
 },

498 { "physiÿl.doc-roÙ", 
MAGNET_ENV_PHYICAL_DOC_ROOT
 },

499 { "physiÿl.ba£dœ", 
MAGNET_ENV_PHYICAL_BASEDIR
 },

501 { "uri.·th", 
MAGNET_ENV_URI_PATH
 },

502 { "uri.·th-¿w", 
MAGNET_ENV_URI_PATH_RAW
 },

503 { "uri.scheme", 
MAGNET_ENV_URI_SCHEME
 },

504 { "uri.authÜ™y", 
MAGNET_ENV_URI_AUTHORITY
 },

505 { "uri.qu”y", 
MAGNET_ENV_URI_QUERY
 },

507 { "»que¡.m‘hod", 
MAGNET_ENV_REQUEST_METHOD
 },

508 { "»que¡.uri", 
MAGNET_ENV_REQUEST_URI
 },

509 { "»que¡.Üig-uri", 
MAGNET_ENV_REQUEST_ORIG_URI
 },

510 { "»que¡.·th-šfo", 
MAGNET_ENV_REQUEST_PATH_INFO
 },

511 { "»que¡.»mÙe-", 
MAGNET_ENV_REQUEST_REMOTE_IP
 },

512 { "»que¡.´ÙocŞ", 
MAGNET_ENV_REQUEST_PROTOCOL
 },

514 { 
NULL
, 
MAGNET_ENV_UNSET
 }

517 
bufãr
 *
	$magÃt_’v_g‘_bufãr_by_id
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
id
) {

518 
bufãr
 *
de¡
 = 
NULL
;

520 
	`UNUSED
(
¤v
);

527 
id
) {

528 
MAGNET_ENV_PHYICAL_PATH
: 
de¡
 = 
cÚ
->
physiÿl
.
·th
; ;

529 
MAGNET_ENV_PHYICAL_REL_PATH
: 
de¡
 = 
cÚ
->
physiÿl
.
»l_·th
; ;

530 
MAGNET_ENV_PHYICAL_DOC_ROOT
: 
de¡
 = 
cÚ
->
physiÿl
.
doc_roÙ
; ;

531 
MAGNET_ENV_PHYICAL_BASEDIR
: 
de¡
 = 
cÚ
->
physiÿl
.
ba£dœ
; ;

533 
MAGNET_ENV_URI_PATH
: 
de¡
 = 
cÚ
->
uri
.
·th
; ;

534 
MAGNET_ENV_URI_PATH_RAW
: 
de¡
 = 
cÚ
->
uri
.
·th_¿w
; ;

535 
MAGNET_ENV_URI_SCHEME
: 
de¡
 = 
cÚ
->
uri
.
scheme
; ;

536 
MAGNET_ENV_URI_AUTHORITY
: 
de¡
 = 
cÚ
->
uri
.
authÜ™y
; ;

537 
MAGNET_ENV_URI_QUERY
: 
de¡
 = 
cÚ
->
uri
.
qu”y
; ;

539 
MAGNET_ENV_REQUEST_METHOD
:

540 
	`bufãr_cİy_¡ršg
(
¤v
->
tmp_buf
, 
	`g‘_h‰p_m‘hod_Çme
(
cÚ
->
»que¡
.
h‰p_m‘hod
));

541 
de¡
 = 
¤v
->
tmp_buf
;

543 
MAGNET_ENV_REQUEST_URI
: 
de¡
 = 
cÚ
->
»que¡
.
uri
; ;

544 
MAGNET_ENV_REQUEST_ORIG_URI
: 
de¡
 = 
cÚ
->
»que¡
.
Üig_uri
; ;

545 
MAGNET_ENV_REQUEST_PATH_INFO
: 
de¡
 = 
cÚ
->
»que¡
.
·thšfo
; ;

546 
MAGNET_ENV_REQUEST_REMOTE_IP
: 
de¡
 = 
cÚ
->
d¡_addr_buf
; ;

547 
MAGNET_ENV_REQUEST_PROTOCOL
:

548 
	`bufãr_cİy_¡ršg
(
¤v
->
tmp_buf
, 
	`g‘_h‰p_v”siÚ_Çme
(
cÚ
->
»que¡
.
h‰p_v”siÚ
));

549 
de¡
 = 
¤v
->
tmp_buf
;

552 
MAGNET_ENV_UNSET
: ;

555  
de¡
;

556 
	}
}

558 
bufãr
 *
	$magÃt_’v_g‘_bufãr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
) {

559 
size_t
 
i
;

561 
i
 = 0; 
magÃt_’v
[i].
Çme
; i++) {

562 ià(0 =ğ
	`¡rcmp
(
key
, 
magÃt_’v
[
i
].
Çme
)) ;

565  
	`magÃt_’v_g‘_bufãr_by_id
(
¤v
, 
cÚ
, 
magÃt_’v
[
i
].
ty³
);

566 
	}
}

568 
	$magÃt_’v_g‘
(
lua_S‹
 *
L
) {

569 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

570 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

573 cÚ¡ *
key
 = 
	`luaL_check¡ršg
(
L
, 2);

574 
bufãr
 *
de¡
 = 
NULL
;

576 
de¡
 = 
	`magÃt_’v_g‘_bufãr
(
¤v
, 
cÚ
, 
key
);

578 ià(!
	`bufãr_is_em±y
(
de¡
)) {

579 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
de¡
));

581 
	`lua_pushn
(
L
);

585 
	}
}

587 
	$magÃt_’v_£t
(
lua_S‹
 *
L
) {

588 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

589 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

592 cÚ¡ *
key
 = 
	`luaL_check¡ršg
(
L
, 2);

593 
bufãr
 *
de¡
 = 
NULL
;

595 
	`luaL_checkªy
(
L
, 3);

597 ià(
NULL
 !ğ(
de¡
 = 
	`magÃt_’v_g‘_bufãr
(
¤v
, 
cÚ
, 
key
))) {

598 ià(
	`lua_i¢
(
L
, 3)) {

599 
	`bufãr_»£t
(
de¡
);

601 
cÚ¡_bufãr
 
v®
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, 3);

602 
	`bufãr_cİy_¡ršg_Ën
(
de¡
, 
v®
.
±r
, v®.
Ën
);

607  
	`luaL_”rÜ
(
L
, "couldn'ˆ¡Ü'%s' iÀlighty.’v[]", 
key
);

611 
	}
}

613 
	$magÃt_’v_Ãxt
(
lua_S‹
 *
L
) {

614 
£rv”
 *
¤v
 = 
	`magÃt_g‘_£rv”
(
L
);

615 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

616 cÚ¡ 
pos
 = 
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(1));

618 
bufãr
 *
de¡
;

621 
	`lua_£‰İ
(
L
, 0);

623 ià(
NULL
 =ğ
magÃt_’v
[
pos
].
Çme
)  0;

625 
	`lua_pushš‹g”
(
L
, 
pos
 + 1);

626 
	`lua_»¶aû
(
L
, 
	`lua_upv®uešdex
(1));

629 
	`lua_push¡ršg
(
L
, 
magÃt_’v
[
pos
].
Çme
);

632 
de¡
 = 
	`magÃt_’v_g‘_bufãr_by_id
(
¤v
, 
cÚ
, 
magÃt_’v
[
pos
].
ty³
);

633 ià(!
	`bufãr_is_em±y
(
de¡
)) {

634 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
de¡
));

636 
	`lua_pushn
(
L
);

641 
	}
}

643 
	$magÃt_’v_·œs
(
lua_S‹
 *
L
) {

644 
	`lua_pushš‹g”
(
L
, 0);

645 
	`lua_pushcşosu»
(
L
, 
magÃt_’v_Ãxt
, 1);

647 
	}
}

649 
	$magÃt_cgi_g‘
(
lua_S‹
 *
L
) {

650 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

651 
d©a_¡ršg
 *
ds
;

654 cÚ¡ *
key
 = 
	`luaL_check¡ršg
(
L
, 2);

656 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, 
key
);

657 ià(
NULL
 !ğ
ds
 && !
	`bufãr_is_em±y
(ds->
v®ue
))

658 
	`lua_pushl¡ršg
(
L
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
));

660 
	`lua_pushn
(
L
);

663 
	}
}

665 
	$magÃt_cgi_£t
(
lua_S‹
 *
L
) {

666 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

669 
cÚ¡_bufãr
 
key
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, 2);

670 
cÚ¡_bufãr
 
v®
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, 3);

672 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
, 
key
.
±r
, key.
Ën
, 
v®
.ptr, val.len);

675 
	}
}

677 
	$magÃt_cgi_·œs
(
lua_S‹
 *
L
) {

678 
cÚÃùiÚ
 *
cÚ
 = 
	`magÃt_g‘_cÚÃùiÚ
(
L
);

680  
	`magÃt_¬¿y_·œs
(
L
, 
cÚ
->
’vœÚm’t
);

681 
	}
}

684 
	$magÃt_cİy_»¥Ú£_h—d”
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
lua_S‹
 *
L
, 
lighty_bË_ndx
) {

685 
	`fÜû_as£¹
(
	`lua_i¡abË
(
L
, 
lighty_bË_ndx
));

687 
	`lua_g‘f›ld
(
L
, 
lighty_bË_ndx
, "header");

688 ià(
	`lua_i¡abË
(
L
, -1)) {

691 
	`lua_pushn
(
L
);

692 
	`lua_Ãxt
(
L
, -2) != 0) {

693 ià(
	`lua_is¡ršg
(
L
, -1) &&†ua_isstring(L, -2)) {

694 
cÚ¡_bufãr
 
key
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, -2);

695 
cÚ¡_bufãr
 
v®
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, -1);

697 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
key
.
±r
, key.
Ën
, 
v®
.ptr, val.len);

700 
	`lua_pİ
(
L
, 1);

703 
	`lua_pİ
(
L
, 1);

706 
	}
}

717 
	$magÃt_©ch_cÚ‹Á
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
lua_S‹
 *
L
, 
lighty_bË_ndx
) {

718 
	`fÜû_as£¹
(
	`lua_i¡abË
(
L
, 
lighty_bË_ndx
));

720 
	`lua_g‘f›ld
(
L
, 
lighty_bË_ndx
, "content");

721 ià(
	`lua_i¡abË
(
L
, -1)) {

722 
i
;

725 
i
 = 1; ; i++) {

726 
	`lua_¿wg‘i
(
L
, -1, 
i
);

729 ià(
	`lua_is¡ršg
(
L
, -1)) {

730 
cÚ¡_bufãr
 
d©a
 = 
	`magÃt_checkcÚ¡bufãr
(
L
, -1);

732 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
d©a
.
±r
, d©a.
Ën
);

733 } ià(
	`lua_i¡abË
(
L
, -1)) {

734 
	`lua_g‘f›ld
(
L
, -1, "filename");

735 
	`lua_g‘f›ld
(
L
, -2, "length");

736 
	`lua_g‘f›ld
(
L
, -3, "offset");

738 ià(
	`lua_is¡ršg
(
L
, -3)) {

739 
bufãr
 *
â
 = 
	`magÃt_checkbufãr
(
L
, -3);

740 
off_t
 
off
 = (off_tè
	`luaL_İtš‹g”
(
L
, -1, 0);

741 
off_t
 
Ën
 = (off_tè
	`luaL_İtš‹g”
(
L
, -2, -1);

742 ià(
off
 < 0) {

743 
	`bufãr_ä“
(
â
);

744  
	`luaL_”rÜ
(
L
, "off£ˆfÜ '%s' i Ãg©ive", 
	`lua_to¡ršg
(L, -3));

747 ià(
Ën
 >ğ
off
) {

748 
Ën
 -ğ
off
;

749 } ià(-1 !ğ
Ën
) {

750 
	`bufãr_ä“
(
â
);

751  
	`luaL_”rÜ
(
L
, "off£ˆ>†’gth fÜ '%s'", 
	`lua_to¡ršg
(L, -3));

754 ià(0 !ğ
Ën
 && 0 !ğ
	`h‰p_chunk_­³nd_fe_¿nge
(
¤v
, 
cÚ
, 
â
, 
off
,†en)) {

755 
	`bufãr_ä“
(
â
);

756  
	`luaL_”rÜ
(
L
, "”rÜ o³nšg fcÚ‹Á '%s'‡ˆoff£ˆ%Îd", 
	`lua_to¡ršg
(L, -3), ()
off
);

759 
	`bufãr_ä“
(
â
);

761  
	`luaL_”rÜ
(
L
, "cÚ‹Á[%d] i ¨bË‡nd„equœe thf›ld \"f’ame\"", 
i
);

764 
	`lua_pİ
(
L
, 3);

765 } ià(
	`lua_i¢
(
L
, -1)) {

768 
	`lua_pİ
(
L
, 1);

772  
	`luaL_”rÜ
(
L
, "cÚ‹Á[%d] i Ã™h”‡ sŒšg‚Ü‡abË: ", 
i
);

775 
	`lua_pİ
(
L
, 1);

778  
	`luaL_”rÜ
(
L
, "lighty.content haso be‡able");

780 
	`lua_pİ
(
L
, 1);

783 
	}
}

785 
	$Œaûback
(
lua_S‹
 *
L
) {

786 ià(!
	`lua_is¡ršg
(
L
, 1))

788 
	`lua_g‘glob®
(
L
, "debug");

789 ià(!
	`lua_i¡abË
(
L
, -1)) {

790 
	`lua_pİ
(
L
, 1);

793 
	`lua_g‘f›ld
(
L
, -1, "traceback");

794 ià(!
	`lua_isfunùiÚ
(
L
, -1)) {

795 
	`lua_pİ
(
L
, 2);

798 
	`lua_pushv®ue
(
L
, 1);

799 
	`lua_pushš‹g”
(
L
, 2);

800 
	`lua_ÿÎ
(
L
, 2, 1);

802 
	}
}

808 
	$push_Œaûback
(
lua_S‹
 *
L
, 
Çrg
) {

809 
ba£
 = 
	`lua_g‘tİ
(
L
è- 
Çrg
;

810 
	`lua_pushcfunùiÚ
(
L
, 
Œaûback
);

811 
	`lua_š£¹
(
L
, 
ba£
);

812  
ba£
;

813 
	}
}

815 
hªdËr_t
 
	$magÃt_©Œaù
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
Çme
) {

816 
lua_S‹
 *
L
;

817 
lua_»tuº_v®ue
;

818 cÚ¡ 
func_ndx
 = 1;

819 cÚ¡ 
lighty_bË_ndx
 = 2;

822 
L
 = 
	`süt_ÿche_g‘_süt
(
¤v
, 
cÚ
, 
p
->
ÿche
, 
Çme
);

824 ià(
	`lua_is¡ršg
(
L
, -1)) {

825 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

828 
Çme
,

830 
	`lua_to¡ršg
(
L
, -1));

832 
	`lua_pİ
(
L
, 1);

834 
	`fÜû_as£¹
(
	`lua_g‘tİ
(
L
) == 0);

836 
cÚ
->
h‰p_¡©us
 = 500;

837 
cÚ
->
mode
 = 
DIRECT
;

839  
HANDLER_FINISHED
;

842 
	`fÜû_as£¹
(
	`lua_g‘tİ
(
L
) == 1);

843 
	`fÜû_as£¹
(
	`lua_isfunùiÚ
(
L
, 
func_ndx
));

845 
	`lua_pushlightu£rd©a
(
L
, 
¤v
);

846 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_LIGHTTPD_SERVER
);

848 
	`lua_pushlightu£rd©a
(
L
, 
cÚ
);

849 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_LIGHTTPD_CONNECTION
);

851 
	`lua_©·nic
(
L
, 
magÃt_©·nic
);

864 
	`lua_ÃwbË
(
L
);

867 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_´št
);

868 
	`lua_£tf›ld
(
L
, -2, "print");

880 
	`lua_ÃwbË
(
L
);

882 
	`lua_ÃwbË
(
L
);

883 
	`lua_ÃwbË
(
L
);

884 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_»qhdr_g‘
);

885 
	`lua_£tf›ld
(
L
, -2, "__index");

886 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_»qhdr_·œs
);

887 
	`lua_£tf›ld
(
L
, -2, "__pairs");

888 
	`lua_£tm‘©abË
(
L
, -2);

889 
	`lua_£tf›ld
(
L
, -2, "request");

891 
	`lua_ÃwbË
(
L
);

892 
	`lua_ÃwbË
(
L
);

893 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_’v_g‘
);

894 
	`lua_£tf›ld
(
L
, -2, "__index");

895 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_’v_£t
);

896 
	`lua_£tf›ld
(
L
, -2, "__newindex");

897 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_’v_·œs
);

898 
	`lua_£tf›ld
(
L
, -2, "__pairs");

899 
	`lua_£tm‘©abË
(
L
, -2);

900 
	`lua_£tf›ld
(
L
, -2, "env");

902 
	`lua_ÃwbË
(
L
);

903 
	`lua_ÃwbË
(
L
);

904 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_cgi_g‘
);

905 
	`lua_£tf›ld
(
L
, -2, "__index");

906 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_cgi_£t
);

907 
	`lua_£tf›ld
(
L
, -2, "__newindex");

908 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_cgi_·œs
);

909 
	`lua_£tf›ld
(
L
, -2, "__pairs");

910 
	`lua_£tm‘©abË
(
L
, -2);

911 
	`lua_£tf›ld
(
L
, -2, "req_env");

913 
	`lua_ÃwbË
(
L
);

914 
	`lua_ÃwbË
(
L
);

915 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_¡©us_g‘
);

916 
	`lua_£tf›ld
(
L
, -2, "__index");

917 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_¡©us_£t
);

918 
	`lua_£tf›ld
(
L
, -2, "__newindex");

919 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_¡©us_·œs
);

920 
	`lua_£tf›ld
(
L
, -2, "__pairs");

921 
	`lua_£tm‘©abË
(
L
, -2);

922 
	`lua_£tf›ld
(
L
, -2, "status");

925 
	`lua_ÃwbË
(
L
);

926 
	`lua_£tf›ld
(
L
, -2, "content");

928 
	`lua_ÃwbË
(
L
);

929 
	`lua_£tf›ld
(
L
, -2, "header");

931 
	`lua_pushš‹g”
(
L
, 
MAGNET_RESTART_REQUEST
);

932 
	`lua_£tf›ld
(
L
, -2, "RESTART_REQUEST");

934 
	`lua_pushcfunùiÚ
(
L
, 
magÃt_¡©
);

935 
	`lua_£tf›ld
(
L
, -2, "stat");

938 
	`lua_pushv®ue
(
L
, -1);

939 
	`lua_š£¹
(
L
, 
lighty_bË_ndx
);

941 
	`lua_£tf›ld
(
L
, -2, "lighty");

943 #ià!
	`defšed
(
LUA_VERSION_NUM
) || LUA_VERSION_NUM < 502

947 
	`lua_g‘glob®
(
L
, "pairs");

948 
	`lua_pushcşosu»
(
L
, 
magÃt_·œs
, 1);

949 
	`lua_£tf›ld
(
L
, -2, "pairs");

952 
	`lua_ÃwbË
(
L
);

953 
	`lua_pushglob®bË
(
L
);

954 
	`lua_£tf›ld
(
L
, -2, "__index");

955 
	`lua_£tm‘©abË
(
L
, -2);

957 
	`magÃt_£tãnv_mašâ
(
L
, 1);

960 
	`lua_pushv®ue
(
L
, 
func_ndx
);

962 
”rfunc
 = 
	`push_Œaûback
(
L
, 0);

963 
»t
 = 
	`lua_pÿÎ
(
L
, 0, 1, 
”rfunc
);

964 
	`lua_»move
(
L
, 
”rfunc
);

967 
	`lua_pushglob®bË
(
L
);

968 
	`magÃt_£tãnv_mašâ
(
L
, 1);

970 ià(0 !ğ
»t
) {

971 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

974 
	`lua_to¡ršg
(
L
, -1));

975 
	`lua_pİ
(
L
, 2);

977 
	`fÜû_as£¹
(
	`lua_g‘tİ
(
L
) == 1);

979 
cÚ
->
h‰p_¡©us
 = 500;

980 
cÚ
->
mode
 = 
DIRECT
;

982  
HANDLER_FINISHED
;

987 
	`fÜû_as£¹
(
	`lua_g‘tİ
(
L
) == 3);

989 
lua_»tuº_v®ue
 = (è
	`luaL_İtš‹g”
(
L
, -1, -1);

990 
	`lua_pİ
(
L
, 1);

992 
	`magÃt_cİy_»¥Ú£_h—d”
(
¤v
, 
cÚ
, 
L
, 
lighty_bË_ndx
);

995 
hªdËr_t
 
»suÉ
 = 
HANDLER_GO_ON
;

997 ià(
lua_»tuº_v®ue
 > 99) {

998 
cÚ
->
h‰p_¡©us
 = 
lua_»tuº_v®ue
;

999 
cÚ
->
fe_fšished
 = 1;

1002 ià(0 =ğ
	`£tjmp
(
exû±iÚjmp
)) {

1003 
	`magÃt_©ch_cÚ‹Á
(
¤v
, 
cÚ
, 
L
, 
lighty_bË_ndx
);

1004 ià(!
	`chunkqueue_is_em±y
(
cÚ
->
wr™e_queue
)) {

1005 
cÚ
->
mode
 = 
p
->
id
;

1008 
	`lua_£‰İ
(
L
, 2);

1010 
cÚ
->
h‰p_¡©us
 = 500;

1011 
cÚ
->
mode
 = 
DIRECT
;

1014 
»suÉ
 = 
HANDLER_FINISHED
;

1015 } ià(
MAGNET_RESTART_REQUEST
 =ğ
lua_»tuº_v®ue
) {

1016 
»suÉ
 = 
HANDLER_COMEBACK
;

1019 
	`lua_pİ
(
L
, 1);

1020 
	`fÜû_as£¹
(
	`lua_g‘tİ
(
L
) == 1);

1022  
»suÉ
;

1024 
	}
}

1026 
hªdËr_t
 
	$magÃt_©Œaù_¬¿y
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
¬¿y
 *
fes
) {

1027 
size_t
 
i
;

1028 
hªdËr_t
 
»t
 = 
HANDLER_GO_ON
;

1031 ià(
fes
->
u£d
 =ğ0è 
HANDLER_GO_ON
;

1033 #ifdeà
USE_OPENSSL


1034 ià(
cÚ
->
s¦
è
	`h‰p_cgi_s¦_’v
(
¤v
, con);

1040 
i
 = 0; i < 
fes
->
u£d
 && 
»t
 =ğ
HANDLER_GO_ON
; i++) {

1041 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
fes
->
d©a
[
i
];

1043 ià(
	`bufãr_¡ršg_is_em±y
(
ds
->
v®ue
)) ;

1045 
»t
 = 
	`magÃt_©Œaù
(
¤v
, 
cÚ
, 
p
, 
ds
->
v®ue
);

1048 ià(
cÚ
->
”rÜ_hªdËr_§ved_¡©us
) {

1050 
x
;

1051 
d©a_¡ršg
 * cÚ¡ 
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, "REDIRECT_STATUS");

1052 ià(
ds
 && (
x
 = 
	`¡¹oul
(ds->
v®ue
->
±r
, 
NULL
, 10)) < 1000)

1054 
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 =

1055 
cÚ
->
”rÜ_hªdËr_§ved_¡©us
 > 0 ? ()
x
 : -()x;

1058  
»t
;

1059 
	}
}

1061 
	$URIHANDLER_FUNC
(
mod_magÃt_uri_hªdËr
) {

1062 
¶ugš_d©a
 *
p
 = 
p_d
;

1064 
	`mod_magÃt_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1066  
	`magÃt_©Œaù_¬¿y
(
¤v
, 
cÚ
, 
p
,…->
cÚf
.
u¾_¿w
);

1067 
	}
}

1069 
	$URIHANDLER_FUNC
(
mod_magÃt_physiÿl
) {

1070 
¶ugš_d©a
 *
p
 = 
p_d
;

1072 
	`mod_magÃt_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1074  
	`magÃt_©Œaù_¬¿y
(
¤v
, 
cÚ
, 
p
,…->
cÚf
.
physiÿl_·th
);

1075 
	}
}

1080 
mod_magÃt_¶ugš_š™
(
¶ugš
 *
p
);

1081 
	$mod_magÃt_¶ugš_š™
(
¶ugš
 *
p
) {

1082 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1083 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("magnet");

1085 
p
->
š™
 = 
mod_magÃt_š™
;

1086 
p
->
hªdË_uri_ş—n
 = 
mod_magÃt_uri_hªdËr
;

1087 
p
->
hªdË_physiÿl
 = 
mod_magÃt_physiÿl
;

1088 
p
->
£t_deçuÉs
 = 
mod_magÃt_£t_deçuÉs
;

1089 
p
->
ş—nup
 = 
mod_magÃt_ä“
;

1091 
p
->
d©a
 = 
NULL
;

1094 
	}
}

	@mod_magnet_cache.c

1 
	~"fœ¡.h
"

3 
	~"mod_magÃt_ÿche.h
"

4 
	~"¡©_ÿche.h
"

6 
	~<¡dlib.h
>

7 
	~<time.h
>

8 
	~<as£¹.h
>

10 
	~<lu®ib.h
>

11 
	~<Ïuxlib.h
>

13 
süt
 *
	$süt_š™
() {

14 
süt
 *
sc
;

16 
sc
 = 
	`ÿÎoc
(1, (*sc));

17 
sc
->
Çme
 = 
	`bufãr_š™
();

18 
sc
->
‘ag
 = 
	`bufãr_š™
();

20  
sc
;

21 
	}
}

23 
	$süt_ä“
(
süt
 *
sc
) {

24 ià(!
sc
) ;

26 
	`lua_pİ
(
sc
->
L
, 1);

28 
	`bufãr_ä“
(
sc
->
Çme
);

29 
	`bufãr_ä“
(
sc
->
‘ag
);

31 
	`lua_şo£
(
sc
->
L
);

33 
	`ä“
(
sc
);

34 
	}
}

36 
süt_ÿche
 *
	$süt_ÿche_š™
() {

37 
süt_ÿche
 *
p
;

39 
p
 = 
	`ÿÎoc
(1, (*p));

41  
p
;

42 
	}
}

44 
	$süt_ÿche_ä“
(
süt_ÿche
 *
p
) {

45 
size_t
 
i
;

47 ià(!
p
) ;

49 
i
 = 0; i < 
p
->
u£d
; i++) {

50 
	`süt_ä“
(
p
->
±r
[
i
]);

53 
	`ä“
(
p
->
±r
);

55 
	`ä“
(
p
);

56 
	}
}

58 
lua_S‹
 *
	$süt_ÿche_g‘_süt
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
süt_ÿche
 *
ÿche
, 
bufãr
 *
Çme
) {

59 
size_t
 
i
;

60 
süt
 *
sc
 = 
NULL
;

61 
¡©_ÿche_’Œy
 *
sû
;

63 
i
 = 0; i < 
ÿche
->
u£d
; i++) {

64 
sc
 = 
ÿche
->
±r
[
i
];

66 ià(
	`bufãr_is_equ®
(
Çme
, 
sc
->name)) {

67 
sc
->
Ï¡_u£d
 = 
	`time
(
NULL
);

71 ià(
	`lua_g‘tİ
(
sc
->
L
) == 0) ;

72 
	`fÜû_as£¹
(
	`lua_g‘tİ
(
sc
->
L
) == 1);

74 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
sc
->
Çme
, &
sû
)) {

75 
	`lua_pİ
(
sc
->
L
, 1);

79 ià(!
	`bufãr_is_equ®
(
sû
->
‘ag
, 
sc
->etag)) {

81 
	`lua_pİ
(
sc
->
L
, 1);

85 
	`fÜû_as£¹
(
	`lua_isfunùiÚ
(
sc
->
L
, -1));

87  
sc
->
L
;

90 
sc
 = 
NULL
;

95 ià(
sc
 =ğ
NULL
) {

96 
sc
 = 
	`süt_š™
();

98 ià(
ÿche
->
size
 == 0) {

99 
ÿche
->
size
 = 16;

100 
ÿche
->
±r
 = 
	`m®loc
(ÿche->
size
 * (*(cache->ptr)));

101 } ià(
ÿche
->
u£d
 =ğÿche->
size
) {

102 
ÿche
->
size
 += 16;

103 
ÿche
->
±r
 = 
	`»®loc
(ÿche->±r, cache->
size
 * (*(cache->ptr)));

106 
ÿche
->
±r
[ÿche->
u£d
++] = 
sc
;

108 
	`bufãr_cİy_bufãr
(
sc
->
Çme
,‚ame);

110 
sc
->
L
 = 
	`luaL_Ãw¡©e
();

111 
	`luaL_İ’libs
(
sc
->
L
);

114 
sc
->
Ï¡_u£d
 = 
	`time
(
NULL
);

116 ià(0 !ğ
	`luaL_lßdfe
(
sc
->
L
, 
Çme
->
±r
)) {

118  
sc
->
L
;

121 ià(
HANDLER_GO_ON
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
sc
->
Çme
, &
sû
)) {

122 
	`bufãr_cİy_bufãr
(
sc
->
‘ag
, 
sû
->etag);

125 
	`fÜû_as£¹
(
	`lua_isfunùiÚ
(
sc
->
L
, -1));

127  
sc
->
L
;

128 
	}
}

	@mod_magnet_cache.h

1 #iâdeà
_MOD_MAGNET_CACHE_H_


2 
	#_MOD_MAGNET_CACHE_H_


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

6 
	~"ba£.h
"

8 
	~<lua.h
>

11 
bufãr
 *
	mÇme
;

12 
bufãr
 *
	m‘ag
;

14 
lua_S‹
 *
	mL
;

16 
time_t
 
	mÏ¡_u£d
;

17 } 
	tsüt
;

20 
süt
 **
	m±r
;

22 
size_t
 
	mu£d
;

23 
size_t
 
	msize
;

24 } 
	tsüt_ÿche
;

26 
süt_ÿche
 *
süt_ÿche_š™
();

27 
süt_ÿche_ä“
(
süt_ÿche
 *
ÿche
);

29 
lua_S‹
 *
süt_ÿche_g‘_süt
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
,

30 
süt_ÿche
 *
ÿche
, 
bufãr
 *
Çme
);

	@mod_mysql_vhost.c

1 
	~"fœ¡.h
"

3 
	~<uni¡d.h
>

4 
	~<¡dio.h
>

5 
	~<”ºo.h
>

6 
	~<fú.h
>

7 
	~<¡ršg.h
>

9 
	~<mysql.h
>

11 
	~"¶ugš.h
"

12 
	~"log.h
"

14 
	~"¡©_ÿche.h
"

15 #ifdeà
DEBUG_MOD_MYSQL_VHOST


16 
	#DEBUG


	)

28 
MYSQL
 *
	mmysql
;

29 
bufãr
 *
	mmysql_qu”y
;

31 
bufãr
 *
	mmydb
;

32 
bufãr
 *
	mmyu£r
;

33 
bufãr
 *
	mmy·ss
;

34 
bufãr
 *
	mmysock
;

36 
bufãr
 *
	mho¡Çme
;

37 
	mpÜt
;

38 } 
	t¶ugš_cÚfig
;

42 
	mPLUGIN_DATA
;

44 
bufãr
 *
	mtmp_buf
;

46 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

48 
¶ugš_cÚfig
 
	mcÚf
;

49 } 
	t¶ugš_d©a
;

53 
bufãr
 *
	m£rv”_Çme
;

54 
bufãr
 *
	mdocum’t_roÙ
;

55 } 
	t¶ugš_cÚÃùiÚ_d©a
;

58 
	$INIT_FUNC
(
mod_mysql_vho¡_š™
) {

59 
¶ugš_d©a
 *
p
;

61 
p
 = 
	`ÿÎoc
(1, (*p));

63 
p
->
tmp_buf
 = 
	`bufãr_š™
();

65  
p
;

66 
	}
}

69 
	$SERVER_FUNC
(
mod_mysql_vho¡_ş—nup
) {

70 
¶ugš_d©a
 *
p
 = 
p_d
;

72 
	`UNUSED
(
¤v
);

74 #ifdeà
DEBUG


75 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

76 "mod_mysql_vho¡_ş—nup", 
p
 ? "yes" : "NO");

78 ià(!
p
è 
HANDLER_GO_ON
;

80 ià(
p
->
cÚfig_¡Üage
) {

81 
size_t
 
i
;

82 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

83 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

85 ià(!
s
) ;

87 
	`mysql_şo£
(
s
->
mysql
);

89 
	`bufãr_ä“
(
s
->
mysql_qu”y
);

90 
	`bufãr_ä“
(
s
->
mydb
);

91 
	`bufãr_ä“
(
s
->
myu£r
);

92 
	`bufãr_ä“
(
s
->
my·ss
);

93 
	`bufãr_ä“
(
s
->
mysock
);

94 
	`bufãr_ä“
(
s
->
ho¡Çme
);

96 
	`ä“
(
s
);

98 
	`ä“
(
p
->
cÚfig_¡Üage
);

100 
	`bufãr_ä“
(
p
->
tmp_buf
);

102 
	`ä“
(
p
);

104  
HANDLER_GO_ON
;

105 
	}
}

108 * 
	$mod_mysql_vho¡_cÚÃùiÚ_d©a
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
)

110 
¶ugš_d©a
 *
p
 = 
p_d
;

111 
¶ugš_cÚÃùiÚ_d©a
 *
c
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

113 
	`UNUSED
(
¤v
);

115 #ifdeà
DEBUG


116 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

117 "mod_mysql_cÚÃùiÚ_d©a", 
c
 ? "old" : "NEW");

120 ià(
c
)  c;

121 
c
 = 
	`ÿÎoc
(1, (*c));

123 
c
->
£rv”_Çme
 = 
	`bufãr_š™
();

124 
c
->
docum’t_roÙ
 = 
	`bufãr_š™
();

126  
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
c
;

127 
	}
}

130 
	$CONNECTION_FUNC
(
mod_mysql_vho¡_hªdË_cÚÃùiÚ_şo£
) {

131 
¶ugš_d©a
 *
p
 = 
p_d
;

132 
¶ugš_cÚÃùiÚ_d©a
 *
c
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

134 
	`UNUSED
(
¤v
);

136 #ifdeà
DEBUG


137 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

138 "mod_mysql_vho¡_hªdË_cÚÃùiÚ_şo£", 
c
 ? "yes" : "NO");

141 ià(!
c
è 
HANDLER_GO_ON
;

143 
	`bufãr_ä“
(
c
->
£rv”_Çme
);

144 
	`bufãr_ä“
(
c
->
docum’t_roÙ
);

146 
	`ä“
(
c
);

148 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

149  
HANDLER_GO_ON
;

150 
	}
}

153 
	$SERVER_FUNC
(
mod_mysql_vho¡_£t_deçuÉs
) {

154 
¶ugš_d©a
 *
p
 = 
p_d
;

155 
size_t
 
i
 = 0;

157 
cÚfig_v®ues_t
 
cv
[] = {

158 { "mysql-vho¡.db", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

159 { "mysql-vho¡.u£r", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

160 { "mysql-vho¡.·ss", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

161 { "mysql-vho¡.sock", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

162 { "mysql-vho¡.sql", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

163 { "mysql-vho¡.ho¡Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

164 { "mysql-vho¡.pÜt", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

165 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

168 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

170 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

171 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

172 
¶ugš_cÚfig
 *
s
;

174 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

175 
s
->
mysql_qu”y
 = 
	`bufãr_š™
();

176 
s
->
mydb
 = 
	`bufãr_š™
();

177 
s
->
myu£r
 = 
	`bufãr_š™
();

178 
s
->
my·ss
 = 
	`bufãr_š™
();

179 
s
->
mysock
 = 
	`bufãr_š™
();

180 
s
->
ho¡Çme
 = 
	`bufãr_š™
();

181 
s
->
pÜt
 = 0;

182 
s
->
mysql
 = 
NULL
;

184 
cv
[0].
de¡š©iÚ
 = 
s
->
mydb
;

185 
cv
[1].
de¡š©iÚ
 = 
s
->
myu£r
;

186 
cv
[2].
de¡š©iÚ
 = 
s
->
my·ss
;

187 
cv
[3].
de¡š©iÚ
 = 
s
->
mysock
;

188 
cv
[4].
de¡š©iÚ
 = 
s
->
mysql_qu”y
;

189 
cv
[5].
de¡š©iÚ
 = 
s
->
ho¡Çme
;

190 
cv
[6].
de¡š©iÚ
 = &(
s
->
pÜt
);

192 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

194 ià(
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

195  
HANDLER_ERROR
;

210 ià(!(
	`bufãr_¡ršg_is_em±y
(
s
->
myu£r
) ||

211 
	`bufãr_¡ršg_is_em±y
(
s
->
mydb
))) {

212 
my_boŞ
 
»cÚÃù
 = 1;

214 ià(
NULL
 =ğ(
s
->
mysql
 = 
	`mysql_š™
(NULL))) {

215 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "mysql_init() failed,ƒxiting...");

216  
HANDLER_ERROR
;

219 #ià
MYSQL_VERSION_ID
 >= 50013

221 
	`mysql_İtiÚs
(
s
->
mysql
, 
MYSQL_OPT_RECONNECT
, &
»cÚÃù
);

224 
	#FOO
(
x
è(
	`bufãr_¡ršg_is_em±y
(
s
->xè? 
NULL
 : s->x->
±r
)

	)

226 #ià
MYSQL_VERSION_ID
 >= 40100

228 ià(!
	`mysql_»®_cÚÃù
(
s
->
mysql
, 
	`FOO
(
ho¡Çme
), FOO(
myu£r
), FOO(
my·ss
),

229 
	`FOO
(
mydb
), 
s
->
pÜt
, FOO(
mysock
), 
CLIENT_MULTI_STATEMENTS
)) {

231 ià(!
	`mysql_»®_cÚÃù
(
s
->
mysql
, 
	`FOO
(
ho¡Çme
), FOO(
myu£r
), FOO(
my·ss
),

232 
	`FOO
(
mydb
), 
s
->
pÜt
, FOO(
mysock
), 0)) {

234 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", 
	`mysql_”rÜ
(
s
->
mysql
));

235  
HANDLER_ERROR
;

237 #undeà
FOO


239 
	`fd_şo£_Ú_exec
(
s
->
mysql
->
Ãt
.
fd
);

243  
HANDLER_GO_ON
;

244 
	}
}

246 
	#PATCH
(
x
) \

247 
p
->
cÚf
.
x
 = 
s
->x;

	)

248 
	$mod_mysql_vho¡_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

249 
size_t
 
i
, 
j
;

250 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

252 
	`PATCH
(
mysql_qu”y
);

253 
	`PATCH
(
mysql
);

256 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

257 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

258 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

261 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

264 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

265 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

267 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("mysql-vhost.sql"))) {

268 
	`PATCH
(
mysql_qu”y
);

272 ià(
s
->
mysql
) {

273 
	`PATCH
(
mysql
);

278 
	}
}

279 #undeà
PATCH


283 
	$CONNECTION_FUNC
(
mod_mysql_vho¡_hªdË_doüoÙ
) {

284 
¶ugš_d©a
 *
p
 = 
p_d
;

285 
¶ugš_cÚÃùiÚ_d©a
 *
c
;

286 
¡©_ÿche_’Œy
 *
sû
;

288 
cŞs
;

289 
MYSQL_ROW
 
row
;

290 
MYSQL_RES
 *
»suÉ
 = 
NULL
;

293 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
authÜ™y
)è 
HANDLER_GO_ON
;

295 
	`mod_mysql_vho¡_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

297 ià(!
p
->
cÚf
.
mysql
è 
HANDLER_GO_ON
;

298 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
mysql_qu”y
)è 
HANDLER_GO_ON
;

301 
c
 = 
	`mod_mysql_vho¡_cÚÃùiÚ_d©a
(
¤v
, 
cÚ
, 
p_d
);

304 ià(
	`bufãr_is_equ®
(
c
->
£rv”_Çme
, 
cÚ
->
uri
.
authÜ™y
)è
GO_ON
;

307 
	`bufãr_¡ršg_£t_Ëngth
(
p
->
tmp_buf
, 0);

308 *
b
 = 
p
->
cÚf
.
mysql_qu”y
->
±r
, *
d
; *b; b = d+1) {

309 ià(
NULL
 !ğ(
d
 = 
	`¡rchr
(
b
, '?'))) {

311 
to_Ën
;

312 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
tmp_buf
, 
b
, (
size_t
)(
d
 - b));

313 
	`bufãr_¡ršg_´•¬e_­³nd
(
p
->
tmp_buf
, 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
authÜ™y
) * 2);

314 
to_Ën
 = 
	`mysql_»®_esÿ³_¡ršg
(
p
->
cÚf
.
mysql
,

315 
p
->
tmp_buf
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(p->tmp_buf),

316 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
authÜ™y
));

317 ià(()~0 =ğ
to_Ën
è
ERR500
;

318 
	`bufãr_comm™
(
p
->
tmp_buf
, 
to_Ën
);

320 
d
 = 
p
->
cÚf
.
mysql_qu”y
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(p->conf.mysql_query);

321 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
tmp_buf
, 
b
, (
size_t
)(
d
 - b));

325 ià(
	`mysql_»®_qu”y
(
p
->
cÚf
.
mysql
, 
	`CONST_BUF_LEN
Õ->
tmp_buf
))) {

326 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", 
	`mysql_”rÜ
(
p
->
cÚf
.
mysql
));

327 
ERR500
;

329 
»suÉ
 = 
	`mysql_¡Üe_»suÉ
(
p
->
cÚf
.
mysql
);

330 
cŞs
 = 
	`mysql_num_f›lds
(
»suÉ
);

331 
row
 = 
	`mysql_ãtch_row
(
»suÉ
);

332 ià(!
row
 || 
cŞs
 < 1) {

334 
	`mysql_ä“_»suÉ
(
»suÉ
);

335 #ià
MYSQL_VERSION_ID
 >= 40100

336 
	`mysql_Ãxt_»suÉ
(
p
->
cÚf
.
mysql
) == 0);

338  
HANDLER_GO_ON
;

342 
	`bufãr_cİy_¡ršg
(
p
->
tmp_buf
, 
row
[0]);

343 
	`bufãr_­³nd_¦ash
(
p
->
tmp_buf
);

345 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
p
->
tmp_buf
, &
sû
)) {

346 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", 
	`¡»¼Ü
(
”ºo
), 
p
->
tmp_buf
);

347 
ERR500
;

349 ià(!
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)) {

350 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "NÙ‡ dœeùÜy", 
p
->
tmp_buf
);

351 
ERR500
;

355 
	`bufãr_cİy_bufãr
(
c
->
£rv”_Çme
, 
cÚ
->
uri
.
authÜ™y
);

356 
	`bufãr_cİy_bufãr
(
c
->
docum’t_roÙ
, 
p
->
tmp_buf
);

358 
	`mysql_ä“_»suÉ
(
»suÉ
);

359 #ià
MYSQL_VERSION_ID
 >= 40100

360 
	`mysql_Ãxt_»suÉ
(
p
->
cÚf
.
mysql
) == 0);

364 
GO_ON
:

365 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, 
c
->server_name);

366 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
c
->
docum’t_roÙ
);

368 #ifdeà
DEBUG


369 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbb",

370 
»suÉ
 ? "NOT CACHED" : "cached",

371 
cÚ
->
£rv”_Çme
, cÚ->
physiÿl
.
doc_roÙ
);

373  
HANDLER_GO_ON
;

375 
ERR500
:

376 ià(
»suÉ
è
	`mysql_ä“_»suÉ
(result);

377 #ià
MYSQL_VERSION_ID
 >= 40100

378 
	`mysql_Ãxt_»suÉ
(
p
->
cÚf
.
mysql
) == 0);

380 
cÚ
->
h‰p_¡©us
 = 500;

381 
cÚ
->
mode
 = 
DIRECT
;

382  
HANDLER_FINISHED
;

383 
	}
}

386 
mod_mysql_vho¡_¶ugš_š™
(
¶ugš
 *
p
);

387 
	$mod_mysql_vho¡_¶ugš_š™
(
¶ugš
 *
p
) {

388 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

389 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("mysql_vhost");

391 
p
->
š™
 = 
mod_mysql_vho¡_š™
;

392 
p
->
ş—nup
 = 
mod_mysql_vho¡_ş—nup
;

393 
p
->
cÚÃùiÚ_»£t
 = 
mod_mysql_vho¡_hªdË_cÚÃùiÚ_şo£
;

395 
p
->
£t_deçuÉs
 = 
mod_mysql_vho¡_£t_deçuÉs
;

396 
p
->
hªdË_doüoÙ
 = 
mod_mysql_vho¡_hªdË_doüoÙ
;

399 
	}
}

	@mod_proxy.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"£rv”.h
"

5 
	~"keyv®ue.h
"

6 
	~"log.h
"

8 
	~"h‰p_chunk.h
"

9 
	~"fdev’t.h
"

10 
	~"cÚÃùiÚs.h
"

11 
	~"»¥Ú£.h
"

12 
	~"jobli¡.h
"

14 
	~"¶ugš.h
"

16 
	~"š‘_Áİ_ÿche.h
"

17 
	~"üc32.h
"

19 
	~<sys/ty³s.h
>

21 
	~<uni¡d.h
>

22 
	~<”ºo.h
>

23 
	~<fú.h
>

24 
	~<¡ršg.h
>

25 
	~<¡dlib.h
>

26 
	~<ùy³.h
>

27 
	~<as£¹.h
>

29 
	~<¡dio.h
>

31 
	~"sys-sock‘.h
"

33 
	#d©a_´oxy
 
d©a_ç¡cgi


	)

34 
	#d©a_´oxy_š™
 
d©a_ç¡cgi_š™


	)

36 
	#PROXY_RETRY_TIMEOUT
 60

	)

56 
	mPROXY_BALANCE_UNSET
,

57 
	mPROXY_BALANCE_FAIR
,

58 
	mPROXY_BALANCE_HASH
,

59 
	mPROXY_BALANCE_RR
,

60 
	mPROXY_BALANCE_STICKY


61 } 
	t´oxy_b®ªû_t
;

64 
¬¿y
 *
	mex‹nsiÚs
;

65 
	mdebug
;

66 
	m»¶aû_h‰p_ho¡
;

68 
´oxy_b®ªû_t
 
	mb®ªû
;

69 } 
	t¶ugš_cÚfig
;

72 
	mPLUGIN_DATA
;

74 
bufãr
 *
	m·r£_»¥Ú£
;

75 
bufãr
 *
	mb®ªû_buf
;

77 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

79 
¶ugš_cÚfig
 
	mcÚf
;

80 } 
	t¶ugš_d©a
;

83 
	mPROXY_STATE_INIT
,

84 
	mPROXY_STATE_CONNECT
,

85 
	mPROXY_STATE_PREPARE_WRITE
,

86 
	mPROXY_STATE_WRITE
,

87 
	mPROXY_STATE_READ


88 } 
	t´oxy_cÚÃùiÚ_¡©e_t
;

90 ’um { 
	mPROXY_STDOUT
, 
	mPROXY_END_REQUEST
 };

93 
´oxy_cÚÃùiÚ_¡©e_t
 
	m¡©e
;

94 
time_t
 
	m¡©e_time¡amp
;

96 
d©a_´oxy
 *
	mho¡
;

98 
bufãr
 *
	m»¥Ú£
;

99 
bufãr
 *
	m»¥Ú£_h—d”
;

101 
chunkqueue
 *
	mwb
;

102 
off_t
 
	mwb_»qËn
;

104 
	mfd
;

105 
	mfde_ndx
;

107 
¶ugš_cÚfig
 
	mcÚf
;

109 
cÚÃùiÚ
 *
	m»mÙe_cÚn
;

110 
¶ugš_d©a
 *
	m¶ugš_d©a
;

111 
d©a_¬¿y
 *
	mext
;

112 } 
	thªdËr_ùx
;

116 
hªdËr_t
 
´oxy_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
);

118 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
() {

119 
hªdËr_ùx
 * 
hùx
;

122 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

124 
hùx
->
¡©e
 = 
PROXY_STATE_INIT
;

125 
hùx
->
ho¡
 = 
NULL
;

127 
hùx
->
»¥Ú£
 = 
	`bufãr_š™
();

128 
hùx
->
»¥Ú£_h—d”
 = 
	`bufãr_š™
();

130 
hùx
->
wb
 = 
	`chunkqueue_š™
();

131 
hùx
->
wb_»qËn
 = 0;

133 
hùx
->
fd
 = -1;

134 
hùx
->
fde_ndx
 = -1;

136  
hùx
;

137 
	}
}

139 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

140 
	`bufãr_ä“
(
hùx
->
»¥Ú£
);

141 
	`bufãr_ä“
(
hùx
->
»¥Ú£_h—d”
);

142 
	`chunkqueue_ä“
(
hùx
->
wb
);

144 
	`ä“
(
hùx
);

145 
	}
}

147 
	$INIT_FUNC
(
mod_´oxy_š™
) {

148 
¶ugš_d©a
 *
p
;

150 
p
 = 
	`ÿÎoc
(1, (*p));

152 
p
->
·r£_»¥Ú£
 = 
	`bufãr_š™
();

153 
p
->
b®ªû_buf
 = 
	`bufãr_š™
();

155  
p
;

156 
	}
}

159 
	$FREE_FUNC
(
mod_´oxy_ä“
) {

160 
¶ugš_d©a
 *
p
 = 
p_d
;

162 
	`UNUSED
(
¤v
);

164 
	`bufãr_ä“
(
p
->
·r£_»¥Ú£
);

165 
	`bufãr_ä“
(
p
->
b®ªû_buf
);

167 ià(
p
->
cÚfig_¡Üage
) {

168 
size_t
 
i
;

169 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

170 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

172 ià(
NULL
 =ğ
s
) ;

174 
	`¬¿y_ä“
(
s
->
ex‹nsiÚs
);

176 
	`ä“
(
s
);

178 
	`ä“
(
p
->
cÚfig_¡Üage
);

181 
	`ä“
(
p
);

183  
HANDLER_GO_ON
;

184 
	}
}

186 
	$SETDEFAULTS_FUNC
(
mod_´oxy_£t_deçuÉs
) {

187 
¶ugš_d©a
 *
p
 = 
p_d
;

188 
d©a_un£t
 *
du
;

189 
size_t
 
i
 = 0;

191 
cÚfig_v®ues_t
 
cv
[] = {

192 { "´oxy.£rv”", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

193 { "´oxy.debug", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

194 { "´oxy.b®ªû", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

195 { "´oxy.»¶aû-h‰p-ho¡", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

196 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

199 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

201 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

202 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

203 
¶ugš_cÚfig
 *
s
;

205 
s
 = 
	`m®loc
((
¶ugš_cÚfig
));

206 
s
->
ex‹nsiÚs
 = 
	`¬¿y_š™
();

207 
s
->
debug
 = 0;

208 
s
->
»¶aû_h‰p_ho¡
 = 0;

210 
cv
[0].
de¡š©iÚ
 = 
s
->
ex‹nsiÚs
;

211 
cv
[1].
de¡š©iÚ
 = &(
s
->
debug
);

212 
cv
[2].
de¡š©iÚ
 = 
p
->
b®ªû_buf
;

213 
cv
[3].
de¡š©iÚ
 = &(
s
->
»¶aû_h‰p_ho¡
);

215 
	`bufãr_»£t
(
p
->
b®ªû_buf
);

217 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

219 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

220  
HANDLER_ERROR
;

223 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
b®ªû_buf
)) {

224 
s
->
b®ªû
 = 
PROXY_BALANCE_FAIR
;

225 } ià(
	`bufãr_is_equ®_¡ršg
(
p
->
b®ªû_buf
, 
	`CONST_STR_LEN
("fair"))) {

226 
s
->
b®ªû
 = 
PROXY_BALANCE_FAIR
;

227 } ià(
	`bufãr_is_equ®_¡ršg
(
p
->
b®ªû_buf
, 
	`CONST_STR_LEN
("round-robin"))) {

228 
s
->
b®ªû
 = 
PROXY_BALANCE_RR
;

229 } ià(
	`bufãr_is_equ®_¡ršg
(
p
->
b®ªû_buf
, 
	`CONST_STR_LEN
("hash"))) {

230 
s
->
b®ªû
 = 
PROXY_BALANCE_HASH
;

231 } ià(
	`bufãr_is_equ®_¡ršg
(
p
->
b®ªû_buf
, 
	`CONST_STR_LEN
("sticky"))) {

232 
s
->
b®ªû
 = 
PROXY_BALANCE_STICKY
;

234 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

235 "´oxy.b®ªû ha tØbÚof: faœ,„ound-robš, hash, sticky, buˆnÙ:", 
p
->
b®ªû_buf
);

236  
HANDLER_ERROR
;

239 ià(
NULL
 !ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "proxy.server"))) {

240 
size_t
 
j
;

241 
d©a_¬¿y
 *
da
 = (d©a_¬¿y *)
du
;

243 ià(
du
->
ty³
 !ğ
TYPE_ARRAY
) {

244 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

247  
HANDLER_ERROR
;

255 
j
 = 0; j < 
da
->
v®ue
->
u£d
; j++) {

256 
d©a_¬¿y
 *
da_ext
 = (d©a_¬¿y *)
da
->
v®ue
->
d©a
[
j
];

257 
size_t
 
n
;

259 ià(
da_ext
->
ty³
 !ğ
TYPE_ARRAY
) {

260 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbs",

262 "[", 
da
->
v®ue
->
d©a
[
j
]->
key
, "](string);ƒxpected ( \"ext\" => ( \"backend-label\" => ( \"key\" => \"value\" )))");

264  
HANDLER_ERROR
;

275 
n
 = 0;‚ < 
da_ext
->
v®ue
->
u£d
;‚++) {

276 
d©a_¬¿y
 *
da_ho¡
 = (d©a_¬¿y *)
da_ext
->
v®ue
->
d©a
[
n
];

278 
d©a_´oxy
 *
df
;

279 
d©a_¬¿y
 *
dç
;

281 
cÚfig_v®ues_t
 
pcv
[] = {

282 { "ho¡", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

283 { "pÜt", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

284 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

287 ià(
da_ho¡
->
ty³
 !ğ
TYPE_ARRAY
) {

288 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssSBS",

291 "[", 
da_ext
->
v®ue
->
d©a
[
n
]->
key
, "](string);ƒxpected ( \"ext\" => ( \"backend-label\" => ( \"key\" => \"value\" )))");

293  
HANDLER_ERROR
;

296 
df
 = 
	`d©a_´oxy_š™
();

298 
df
->
pÜt
 = 80;

300 
	`bufãr_cİy_bufãr
(
df
->
key
, 
da_ho¡
->key);

302 
pcv
[0].
de¡š©iÚ
 = 
df
->
ho¡
;

303 
pcv
[1].
de¡š©iÚ
 = &(
df
->
pÜt
);

305 ià(0 !ğ
	`cÚfig_š£¹_v®ues_š‹º®
(
¤v
, 
da_ho¡
->
v®ue
, 
pcv
, 
T_CONFIG_SCOPE_CONNECTION
)) {

306 
df
->
	`ä“
((
d©a_un£t
*) df);

307  
HANDLER_ERROR
;

310 ià(
	`bufãr_¡ršg_is_em±y
(
df
->
ho¡
)) {

311 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbbbs",

313 
da
->
key
,

314 
da_ext
->
key
,

315 
da_ho¡
->
key
,

318 
df
->
	`ä“
((
d©a_un£t
*) df);

319  
HANDLER_ERROR
;

324 ià(
NULL
 =ğ(
dç
 = (
d©a_¬¿y
 *)
	`¬¿y_g‘_–em’t
(
s
->
ex‹nsiÚs
, 
da_ext
->
key
->
±r
))) {

325 
dç
 = 
	`d©a_¬¿y_š™
();

327 
	`bufãr_cİy_bufãr
(
dç
->
key
, 
da_ext
->key);

329 
	`¬¿y_š£¹_unique
(
dç
->
v®ue
, (
d©a_un£t
 *)
df
);

330 
	`¬¿y_š£¹_unique
(
s
->
ex‹nsiÚs
, (
d©a_un£t
 *)
dç
);

332 
	`¬¿y_š£¹_unique
(
dç
->
v®ue
, (
d©a_un£t
 *)
df
);

339  
HANDLER_GO_ON
;

340 
	}
}

343 
	$´oxy_back’d_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

344 ià(
hùx
->
fd
 != -1) {

345 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
);

346 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
hùx
->
fd
);

347 
	`fdev’t_sched_şo£
(
¤v
->
ev
, 
hùx
->
fd
, 1);

348 
hùx
->
fd
 = -1;

349 
hùx
->
fde_ndx
 = -1;

352 ià(
hùx
->
ho¡
) {

353 
hùx
->
ho¡
->
u§ge
--;

354 
hùx
->
ho¡
 = 
NULL
;

356 
	}
}

358 
d©a_´oxy
 * 
	$mod_´oxy_ex‹nsiÚ_ho¡_g‘
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_¬¿y
 *
ex‹nsiÚ
, 
´oxy_b®ªû_t
 
b®ªû
, 
debug
) {

359 
Ï¡_max
 = 
ULONG_MAX
;

360 
max_u§ge
 = 
INT_MAX
;

361 
ndx
 = -1;

362 
size_t
 
k
;

364 ià(
ex‹nsiÚ
->
v®ue
->
u£d
 == 1) {

365 iàĞ((
d©a_´oxy
 *)
ex‹nsiÚ
->
v®ue
->
d©a
[0])->
is_di§bËd
 ) {

366 
ndx
 = -1;

368 
ndx
 = 0;

370 } ià(
ex‹nsiÚ
->
v®ue
->
u£d
 !ğ0è
b®ªû
) {

371 
PROXY_BALANCE_HASH
:

374 ià(
debug
) {

375 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

376 "´oxy - u£d hash b®ªcšg, ho¡s:", 
ex‹nsiÚ
->
v®ue
->
u£d
);

379 
k
 = 0, 
ndx
 = -1, 
Ï¡_max
 = 
ULONG_MAX
; k < 
ex‹nsiÚ
->
v®ue
->
u£d
; k++) {

380 
d©a_´oxy
 *
ho¡
 = (d©a_´oxy *)
ex‹nsiÚ
->
v®ue
->
d©a
[
k
];

381 
cur_max
;

383 ià(
ho¡
->
is_di§bËd
) ;

385 
cur_max
 = 
	`g’”©e_üc32c
(
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
)) +

386 
	`g’”©e_üc32c
(
	`CONST_BUF_LEN
(
ho¡
->host)) +

387 
	`g’”©e_üc32c
(
	`CONST_BUF_LEN
(
cÚ
->
uri
.
authÜ™y
));

389 ià(
debug
) {

390 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbbbd",

392 
cÚ
->
uri
.
·th
,

393 
ho¡
->host,

394 
cÚ
->
uri
.
authÜ™y
,

395 
cur_max
);

398 ià((
Ï¡_max
 =ğ
ULONG_MAX
) ||

399 (
cur_max
 > 
Ï¡_max
)) {

400 
Ï¡_max
 = 
cur_max
;

402 
ndx
 = 
k
;

407 
PROXY_BALANCE_FAIR
:

409 ià(
debug
) {

410 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

414 
k
 = 0, 
ndx
 = -1, 
max_u§ge
 = 
INT_MAX
; k < 
ex‹nsiÚ
->
v®ue
->
u£d
; k++) {

415 
d©a_´oxy
 *
ho¡
 = (d©a_´oxy *)
ex‹nsiÚ
->
v®ue
->
d©a
[
k
];

417 ià(
ho¡
->
is_di§bËd
) ;

419 ià(
ho¡
->
u§ge
 < 
max_u§ge
) {

420 
max_u§ge
 = 
ho¡
->
u§ge
;

422 
ndx
 = 
k
;

427 
PROXY_BALANCE_RR
: {

428 
d©a_´oxy
 *
ho¡
;

431 ià(
debug
) {

432 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

437 
	`fÜû_as£¹
(
ex‹nsiÚ
->
v®ue
->
u£d
 < 
INT_MAX
);

439 
ho¡
 = (
d©a_´oxy
 *)
ex‹nsiÚ
->
v®ue
->
d©a
[0];

442 
k
 = 
ho¡
->
Ï¡_u£d_ndx
;

443 
ndx
 = 
k
 + 1;

444 ià(
ndx
 < 0)‚dx = 0;

447  
ndx
 < (è
ex‹nsiÚ
->
v®ue
->
u£d


448 && (
ho¡
 = (
d©a_´oxy
 *)
ex‹nsiÚ
->
v®ue
->
d©a
[
ndx
])->
is_di§bËd
 )‚dx++;

450 ià(
ndx
 >ğ(è
ex‹nsiÚ
->
v®ue
->
u£d
) {

452 
ndx
 = 0;‚dx <ğ(è
k
;‚dx++) {

453 
ho¡
 = (
d©a_´oxy
 *)
ex‹nsiÚ
->
v®ue
->
d©a
[
ndx
];

454 ià(!
ho¡
->
is_di§bËd
) ;

458 ià(
ho¡
->
is_di§bËd
è
ndx
 = -1;

462 ((
d©a_´oxy
 *)
ex‹nsiÚ
->
v®ue
->
d©a
[0])->
Ï¡_u£d_ndx
 = 
ndx
;

466 
PROXY_BALANCE_STICKY
:

469 ià(
debug
) {

470 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

471 "´oxy - u£d sticky b®ªcšg, ho¡s:", 
ex‹nsiÚ
->
v®ue
->
u£d
);

474 
k
 = 0, 
ndx
 = -1, 
Ï¡_max
 = 
ULONG_MAX
; k < 
ex‹nsiÚ
->
v®ue
->
u£d
; k++) {

475 
d©a_´oxy
 *
ho¡
 = (d©a_´oxy *)
ex‹nsiÚ
->
v®ue
->
d©a
[
k
];

476 
cur_max
;

478 ià(
ho¡
->
is_di§bËd
) ;

480 
cur_max
 = 
	`g’”©e_üc32c
(
	`CONST_BUF_LEN
(
cÚ
->
d¡_addr_buf
)) +

481 
	`g’”©e_üc32c
(
	`CONST_BUF_LEN
(
ho¡
->host)) +

482 
ho¡
->
pÜt
;

484 ià(
debug
) {

485 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbbdd",

487 
cÚ
->
d¡_addr_buf
,

488 
ho¡
->host,

489 
ho¡
->
pÜt
,

490 
cur_max
);

493 ià((
Ï¡_max
 =ğ
ULONG_MAX
) ||

494 (
cur_max
 > 
Ï¡_max
)) {

495 
Ï¡_max
 = 
cur_max
;

497 
ndx
 = 
k
;

507 ià(
ndx
 != -1) {

508 
d©a_´oxy
 *
ho¡
 = (d©a_´oxy *)
ex‹nsiÚ
->
v®ue
->
d©a
[
ndx
];

510 ià(
debug
) {

511 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd",

513 
ho¡
->ho¡, ho¡->
pÜt
);

516 
ho¡
->
u§ge
++;

517  
ho¡
;

520 
cÚ
->
h‰p_¡©us
 = 503;

521 
cÚ
->
mode
 = 
DIRECT
;

523 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

525 
cÚ
->
uri
.
·th
);

527  
NULL
;

529 
	}
}

531 
	$´oxy_cÚÃùiÚ_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

532 
¶ugš_d©a
 *
p
;

533 
cÚÃùiÚ
 *
cÚ
;

535 
p
 = 
hùx
->
¶ugš_d©a
;

536 
cÚ
 = 
hùx
->
»mÙe_cÚn
;

538 
	`´oxy_back’d_şo£
(
¤v
, 
hùx
);

539 
	`hªdËr_ùx_ä“
(
hùx
);

540 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

543 ià(
cÚ
->
mode
 =ğ
p
->
id
) {

544 
	`h‰p_»¥Ú£_back’d_dÚe
(
¤v
, 
cÚ
);

546 
	}
}

548 
hªdËr_t
 
	$´oxy_»cÚÃù
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

549 
	`´oxy_back’d_şo£
(
¤v
, 
hùx
);

551 
hùx
->
ho¡
 = 
	`mod_´oxy_ex‹nsiÚ_ho¡_g‘
(
¤v
, hùx->
»mÙe_cÚn
, hùx->
ext
, hùx->
cÚf
.
b®ªû
, ()hùx->cÚf.
debug
);

552 ià(
NULL
 =ğ
hùx
->
ho¡
è 
HANDLER_FINISHED
;

554 
hùx
->
¡©e
 = 
PROXY_STATE_INIT
;

555  
HANDLER_COMEBACK
;

556 
	}
}

558 
	$´oxy_e¡ablish_cÚÃùiÚ
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

559 
sockaddr
 *
´oxy_addr
;

560 
sockaddr_š
 
´oxy_addr_š
;

561 #ià
	`defšed
(
HAVE_SYS_UN_H
)

562 
sockaddr_un
 
´oxy_addr_un
;

564 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

565 
sockaddr_š6
 
´oxy_addr_š6
;

567 
sockËn_t
 
£rvËn
;

569 
d©a_´oxy
 *
ho¡
ğ
hùx
->host;

570 
´oxy_fd
 = 
hùx
->
fd
;

573 #ià
	`defšed
(
HAVE_SYS_UN_H
)

574 ià(
	`¡r¡r
(
ho¡
->ho¡->
±r
, "/")) {

575 ià(
	`bufãr_¡ršg_Ëngth
(
ho¡
->ho¡è+ 1 > (
´oxy_addr_un
.
sun_·th
)) {

576 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sB",

578 
ho¡
->host);

582 
	`mem£t
(&
´oxy_addr_un
, 0, (proxy_addr_un));

583 
´oxy_addr_un
.
sun_çmy
 = 
AF_UNIX
;

584 
	`memıy
(
´oxy_addr_un
.
sun_·th
, 
ho¡
->ho¡->
±r
, 
	`bufãr_¡ršg_Ëngth
(host->host) + 1);

585 
£rvËn
 = (
´oxy_addr_un
);

586 
´oxy_addr
 = (
sockaddr
 *è&
´oxy_addr_un
;

589 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

590 ià(
	`¡r¡r
(
ho¡
->ho¡->
±r
, ":")) {

591 
	`mem£t
(&
´oxy_addr_š6
, 0, (proxy_addr_in6));

592 
´oxy_addr_š6
.
sš6_çmy
 = 
AF_INET6
;

593 
	`š‘_±Ú
(
AF_INET6
, 
ho¡
->ho¡->
±r
, (*è&
´oxy_addr_š6
.
sš6_addr
);

594 
´oxy_addr_š6
.
sš6_pÜt
 = 
	`htÚs
(
ho¡
->
pÜt
);

595 
£rvËn
 = (
´oxy_addr_š6
);

596 
´oxy_addr
 = (
sockaddr
 *è&
´oxy_addr_š6
;

600 
	`mem£t
(&
´oxy_addr_š
, 0, (proxy_addr_in));

601 
´oxy_addr_š
.
sš_çmy
 = 
AF_INET
;

602 
´oxy_addr_š
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
ho¡
->ho¡->
±r
);

603 
´oxy_addr_š
.
sš_pÜt
 = 
	`htÚs
(
ho¡
->
pÜt
);

604 
£rvËn
 = (
´oxy_addr_š
);

605 
´oxy_addr
 = (
sockaddr
 *è&
´oxy_addr_š
;

609 ià(-1 =ğ
	`cÚÃù
(
´oxy_fd
, 
´oxy_addr
, 
£rvËn
)) {

610 ià(
”ºo
 =ğ
EINPROGRESS
 ||ƒ¼nØ=ğ
EALREADY
) {

611 ià(
hùx
->
cÚf
.
debug
) {

612 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

613 "cÚÃù d–ayed:", 
´oxy_fd
);

619 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

620 "cÚÃù faed:", 
´oxy_fd
, 
	`¡»¼Ü
(
”ºo
),ƒrrno);

625 ià(
hùx
->
cÚf
.
debug
) {

626 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

627 "cÚÃù sucûeded: ", 
´oxy_fd
);

631 
	}
}

633 
	$´oxy_£t_h—d”
(
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, cÚ¡ *
v®ue
) {

634 
d©a_¡ršg
 *
ds_d¡
;

636 ià(
NULL
 =ğ(
ds_d¡
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
TYPE_STRING
))) {

637 
ds_d¡
 = 
	`d©a_¡ršg_š™
();

640 
	`bufãr_cİy_¡ršg
(
ds_d¡
->
key
, key);

641 
	`bufãr_cİy_¡ršg
(
ds_d¡
->
v®ue
, value);

642 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds_d¡
);

643 
	}
}

645 
	$´oxy_­³nd_h—d”
(
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, cÚ¡ *
v®ue
) {

646 
d©a_¡ršg
 *
ds_d¡
;

648 ià(
NULL
 =ğ(
ds_d¡
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
TYPE_STRING
))) {

649 
ds_d¡
 = 
	`d©a_¡ršg_š™
();

652 
	`bufãr_cİy_¡ršg
(
ds_d¡
->
key
, key);

653 
	`bufãr_­³nd_¡ršg
(
ds_d¡
->
v®ue
, value);

654 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds_d¡
);

655 
	}
}

658 
	$´oxy_ü—‹_’v
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

659 
size_t
 
i
;

661 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

662 
bufãr
 *
b
;

663 
»¶aû_h‰p_ho¡
 = 0;

667 
b
 = 
	`bufãr_š™
();

670 
	`bufãr_cİy_¡ršg
(
b
, 
	`g‘_h‰p_m‘hod_Çme
(
cÚ
->
»que¡
.
h‰p_m‘hod
));

671 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

673 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
»que¡
.
uri
);

674 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" HTTP/1.0\r\n"));

675 ià(
hùx
->
cÚf
.
»¶aû_h‰p_ho¡
 && !
	`bufãr_¡ršg_is_em±y
(hùx->
ho¡
->
key
)) {

676 
»¶aû_h‰p_ho¡
 = 1;

677 ià(
hùx
->
cÚf
.
debug
 > 1) {

678 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBS",

679 "´oxy - usšg \"", 
hùx
->
ho¡
->
key
, "\"‡s HTTP Host");

681 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Host: "));

682 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
hùx
->
ho¡
->
key
);

683 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n"));

686 
	`´oxy_­³nd_h—d”
(
cÚ
, "X-FÜw¬ded-FÜ", (*)
	`š‘_Áİ_ÿche_g‘_
(
¤v
, &(cÚ->
d¡_addr
)));

689 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
h‰p_ho¡
)) {

690 
	`´oxy_£t_h—d”
(
cÚ
, "X-Ho¡", cÚ->
»que¡
.
h‰p_ho¡
->
±r
);

692 
	`´oxy_£t_h—d”
(
cÚ
, "X-FÜw¬ded-PrÙo", cÚ->
uri
.
scheme
->
±r
);

695 
i
 = 0; i < 
cÚ
->
»que¡
.
h—d”s
->
u£d
; i++) {

696 
d©a_¡ršg
 *
ds
;

698 
ds
 = (
d©a_¡ršg
 *)
cÚ
->
»que¡
.
h—d”s
->
d©a
[
i
];

700 ià(!
	`bufãr_is_em±y
(
ds
->
v®ue
è&& !bufãr_is_em±y(ds->
key
)) {

701 ià(
»¶aû_h‰p_ho¡
 &&

702 
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("Host"))) ;

703 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("Connection"))) ;

704 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("Proxy-Connection"))) ;

708 ià(
	`bufãr_is_equ®_ÿ£Ëss_¡ršg
(
ds
->
key
, 
	`CONST_STR_LEN
("Proxy"))) ;

710 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
key
);

711 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(": "));

712 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
v®ue
);

713 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n"));

717 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Connection: close\r\n\r\n"));

719 
hùx
->
wb_»qËn
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

720 
	`chunkqueue_­³nd_bufãr
(
hùx
->
wb
, 
b
);

721 
	`bufãr_ä“
(
b
);

725 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

726 
	`chunkqueue_­³nd_chunkqueue
(
hùx
->
wb
, 
cÚ
->
»que¡_cÚ‹Á_queue
);

727 
hùx
->
wb_»qËn
 +ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
;

731 
	}
}

733 
	$´oxy_£t_¡©e
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
´oxy_cÚÃùiÚ_¡©e_t
 
¡©e
) {

734 
hùx
->
¡©e
 = state;

735 
hùx
->
¡©e_time¡amp
 = 
¤v
->
cur_ts
;

738 
	}
}

741 
	$´oxy_»¥Ú£_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
š
) {

742 *
s
, *
ns
;

743 
h‰p_»¥Ú£_¡©us
 = -1;

745 
	`UNUSED
(
¤v
);

749 
	`bufãr_cİy_bufãr
(
p
->
·r£_»¥Ú£
, 
š
);

751 
s
 = 
p
->
·r£_»¥Ú£
->
±r
; 
NULL
 !ğ(
ns
 = 
	`¡rchr
(s, '\n')); s =‚s + 1) {

752 *
key
, *
v®ue
;

753 
key_Ën
;

754 
d©a_¡ršg
 *
ds
;

755 
cİy_h—d”
;

757 
ns
[0] = '\0';

758 ià(
s
 !ğ
ns
 &&‚s[-1] == '\r')‚s[-1] = '\0';

760 ià(-1 =ğ
h‰p_»¥Ú£_¡©us
) {

763 
key
=
s
; *key && *key != ' '; key++);

765 ià(*
key
) {

766 
h‰p_»¥Ú£_¡©us
 = (è
	`¡¹Ş
(
key
, 
NULL
, 10);

767 ià(
h‰p_»¥Ú£_¡©us
 < 100 || http_response_status >= 1000) http_response_status = 502;

769 
h‰p_»¥Ú£_¡©us
 = 502;

772 
cÚ
->
h‰p_¡©us
 = 
h‰p_»¥Ú£_¡©us
;

773 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_STATUS
;

777 ià(
NULL
 =ğ(
v®ue
 = 
	`¡rchr
(
s
, ':'))) {

783 
key
 = 
s
;

784 
key_Ën
 = 
v®ue
 - 
key
;

786 
v®ue
++;

788 *
v®ue
 == ' ' || *value == '\t') value++;

790 
cİy_h—d”
 = 1;

792 
key_Ën
) {

794 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "D©e", 
key_Ën
)) {

795 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_DATE
;

799 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "LoÿtiÚ", 
key_Ën
)) {

800 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_LOCATION
;

804 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚÃùiÚ", 
key_Ën
)) {

805 
cİy_h—d”
 = 0;

809 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚ‹Á-L’gth", 
key_Ën
)) {

810 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
	`¡¹oul
(
v®ue
, 
NULL
, 10);

811 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONTENT_LENGTH
;

818 ià(
cİy_h—d”
) {

819 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

820 
ds
 = 
	`d©a_»¥Ú£_š™
();

822 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
key_Ën
);

823 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, value);

825 
	`¬¿y_š£¹_unique
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
ds
);

830 
	}
}

833 
	$´oxy_demux_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

834 
fš
 = 0;

835 
b
;

836 
ssize_t
 
r
;

838 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

839 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

840 
´oxy_fd
 = 
hùx
->
fd
;

843 #ià!
	`defšed
(
_WIN32
è&& !defšed(
__CYGWIN__
)

844 ià(
	`ioùl
(
hùx
->
fd
, 
FIONREAD
, &
b
)) {

845 ià(
”ºo
 =ğ
EAGAIN
) {

846 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

849 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

851 
´oxy_fd
);

855 
b
 = 4096;

859 ià(
hùx
->
cÚf
.
debug
) {

860 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

861 "´oxy - havtØ»ad:", 
b
);

864 ià(
b
 > 0) {

865 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)) {

866 
off_t
 
cqËn
 = 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
);

867 ià(
cqËn
 + 
b
 > 65536 - 4096) {

868 ià(!
cÚ
->
is_wr™abË
) {

874 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

876 ià(
cqËn
 >= 65536-1)  0;

877 
b
 = 65536 - 1 - ()
cqËn
;

881 
	`bufãr_¡ršg_´•¬e_­³nd
(
hùx
->
»¥Ú£
, 
b
);

883 ià(-1 =ğ(
r
 = 
	`»ad
(
hùx
->
fd
, hùx->
»¥Ú£
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(hùx->»¥Ú£), 
	`bufãr_¡ršg_¥aû
(hctx->response)))) {

884 ià(
”ºo
 =ğ
EAGAIN
) {

885 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

888 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

890 
´oxy_fd
, 
	`¡»¼Ü
(
”ºo
));

894 #ià
	`defšed
(
_WIN32
è|| defšed(
__CYGWIN__
)

895 ià(0 =ğ
r
)  1;

899 
	`fÜû_as£¹
(
r
);

901 
	`bufãr_comm™
(
hùx
->
»¥Ú£
, 
r
);

904 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsbs",

905 "demux: Re¥Ú£ bufã¸Ën", 
hùx
->
»¥Ú£
->
u£d
, ":", hctx->response, ":");

908 ià(0 =ğ
cÚ
->
gÙ_»¥Ú£
) {

909 
cÚ
->
gÙ_»¥Ú£
 = 1;

910 
	`bufãr_¡ršg_´•¬e_cİy
(
hùx
->
»¥Ú£_h—d”
, 1023);

913 ià(0 =ğ
cÚ
->
fe_¡¬‹d
) {

914 *
c
;

917 ià(
NULL
 !ğ(
c
 = 
	`bufãr_£¬ch_¡ršg_Ën
(
hùx
->
»¥Ú£
, 
	`CONST_STR_LEN
("\r\n\r\n")))) {

918 
size_t
 
hËn
 = 
c
 - 
hùx
->
»¥Ú£
->
±r
 + 4;

919 
size_t
 
bËn
 = 
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£
è- 
hËn
;

922 
	`bufãr_­³nd_¡ršg_Ën
(
hùx
->
»¥Ú£_h—d”
, hùx->
»¥Ú£
->
±r
, 
hËn
);

924 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "H—d”:", 
hùx
->
»¥Ú£_h—d”
);

927 
	`´oxy_»¥Ú£_·r£
(
¤v
, 
cÚ
, 
p
, 
hùx
->
»¥Ú£_h—d”
);

929 
cÚ
->
fe_¡¬‹d
 = 1;

930 ià(
bËn
 > 0) {

931 ià(0 !ğ
	`h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
c
 + 4, 
bËn
)) {

934 
fš
 = 1;

935 
cÚ
->
fe_¡¬‹d
 = 0;

938 
	`bufãr_»£t
(
hùx
->
»¥Ú£
);

942 ià(
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£
è> 
MAX_HTTP_REQUEST_HEADER
) {

943 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "»¥Ú£ h—d” toØÏrgfÜ", 
cÚ
->
uri
.
·th
);

944 
cÚ
->
h‰p_¡©us
 = 502;

945 
cÚ
->
mode
 = 
DIRECT
;

946 
fš
 = 1;

950 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£
)) {

953 
fš
 = 1;

955 
	`bufãr_»£t
(
hùx
->
»¥Ú£
);

959 
fš
 = 1;

962  
fš
;

963 
	}
}

966 
hªdËr_t
 
	$´oxy_wr™e_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

967 
d©a_´oxy
 *
ho¡
ğ
hùx
->host;

968 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

970 
»t
;

972 
hùx
->
¡©e
) {

973 
PROXY_STATE_INIT
:

974 #ià
	`defšed
(
HAVE_SYS_UN_H
)

975 ià(
	`¡r¡r
(
ho¡
->ho¡->
±r
,"/")) {

976 ià(-1 =ğ(
hùx
->
fd
 = 
	`fdev’t_sock‘_nb_şÛxec
(
AF_UNIX
, 
SOCK_STREAM
, 0))) {

977 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘ faed: ", 
	`¡»¼Ü
(
”ºo
));

978  
HANDLER_ERROR
;

982 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

983 ià(
	`¡r¡r
(
ho¡
->ho¡->
±r
,":")) {

984 ià(-1 =ğ(
hùx
->
fd
 = 
	`fdev’t_sock‘_nb_şÛxec
(
AF_INET6
, 
SOCK_STREAM
, 0))) {

985 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘ faed: ", 
	`¡»¼Ü
(
”ºo
));

986  
HANDLER_ERROR
;

991 ià(-1 =ğ(
hùx
->
fd
 = 
	`fdev’t_sock‘_nb_şÛxec
(
AF_INET
, 
SOCK_STREAM
, 0))) {

992 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘ faed: ", 
	`¡»¼Ü
(
”ºo
));

993  
HANDLER_ERROR
;

996 
hùx
->
fde_ndx
 = -1;

998 
¤v
->
cur_fds
++;

1000 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
hùx
->
fd
, 
´oxy_hªdË_fdev’t
, hctx);

1002 ià(-1 =ğ
	`fdev’t_fú_£t
(
¤v
->
ev
, 
hùx
->
fd
)) {

1003 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fú faed: ", 
	`¡»¼Ü
(
”ºo
));

1005  
HANDLER_ERROR
;

1009 
PROXY_STATE_CONNECT
:

1010 ià(
hùx
->
¡©e
 =ğ
PROXY_STATE_INIT
) {

1011 
	`´oxy_e¡ablish_cÚÃùiÚ
(
¤v
, 
hùx
)) {

1013 
	`´oxy_£t_¡©e
(
¤v
, 
hùx
, 
PROXY_STATE_CONNECT
);

1017 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

1019  
HANDLER_WAIT_FOR_EVENT
;

1022 
hùx
->
fde_ndx
 = -1;

1024  
HANDLER_ERROR
;

1030 
sock‘_”rÜ
;

1031 
sockËn_t
 
sock‘_”rÜ_Ën
 = (
sock‘_”rÜ
);

1034 ià(0 !ğ
	`g‘sockİt
(
hùx
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock‘_”rÜ
, &
sock‘_”rÜ_Ën
)) {

1035 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1036 "g‘sockİˆçed:", 
	`¡»¼Ü
(
”ºo
));

1038  
HANDLER_ERROR
;

1040 ià(
sock‘_”rÜ
 != 0) {

1041 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1042 "e¡ablishšg cÚÃùiÚ faed:", 
	`¡»¼Ü
(
sock‘_”rÜ
),

1043 "pÜt:", 
hùx
->
ho¡
->
pÜt
);

1045  
HANDLER_ERROR
;

1047 ià(
hùx
->
cÚf
.
debug
) {

1048 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "proxy - connect - delayed success");

1054 
	`´oxy_£t_¡©e
(
¤v
, 
hùx
, 
PROXY_STATE_PREPARE_WRITE
);

1056 
PROXY_STATE_PREPARE_WRITE
:

1057 
	`´oxy_ü—‹_’v
(
¤v
, 
hùx
);

1059 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

1060 
	`´oxy_£t_¡©e
(
¤v
, 
hùx
, 
PROXY_STATE_WRITE
);

1063 
PROXY_STATE_WRITE
:;

1064 
»t
 = 
¤v
->
	`ÃtwÜk_back’d_wr™e
(¤v, 
cÚ
, 
hùx
->
fd
, hùx->
wb
, 
MAX_WRITE_LIMIT
);

1066 
	`chunkqueue_»move_fšished_chunks
(
hùx
->
wb
);

1068 ià(-1 =ğ
»t
) {

1069 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "wr™çed:", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

1071  
HANDLER_ERROR
;

1072 } ià(-2 =ğ
»t
) {

1073 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "wr™çed,„emÙcÚÃùiÚ clo£:", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

1075  
HANDLER_ERROR
;

1078 ià(
hùx
->
wb
->
by‹s_out
 =ğhùx->
wb_»qËn
) {

1079 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

1080 
	`´oxy_£t_¡©e
(
¤v
, 
hùx
, 
PROXY_STATE_READ
);

1082 
off_t
 
wbËn
 = 
hùx
->
wb
->
by‹s_š
 - hùx->wb->
by‹s_out
;

1083 ià(
hùx
->
wb
->
by‹s_š
 < hùx->
wb_»qËn
 && 
wbËn
 < 65536 - 16384) {

1085 ià(!(
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_POLLIN
)) {

1086 
cÚ
->
cÚf
.
¡»am_»que¡_body
 |ğ
FDEVENT_STREAM_REQUEST_POLLIN
;

1087 
cÚ
->
is_»adabË
 = 1;

1090 ià(0 =ğ
wbËn
) {

1091 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

1093 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

1097  
HANDLER_WAIT_FOR_EVENT
;

1098 
PROXY_STATE_READ
:

1100  
HANDLER_WAIT_FOR_EVENT
;

1102 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "(debug) unknown state");

1103  
HANDLER_ERROR
;

1105 
	}
}

1107 
	#PATCH
(
x
) \

1108 
p
->
cÚf
.
x
 = 
s
->x;

	)

1109 
	$mod_´oxy_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

1110 
size_t
 
i
, 
j
;

1111 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

1113 
	`PATCH
(
ex‹nsiÚs
);

1114 
	`PATCH
(
debug
);

1115 
	`PATCH
(
b®ªû
);

1116 
	`PATCH
(
»¶aû_h‰p_ho¡
);

1119 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1120 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

1121 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

1124 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

1127 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

1128 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

1130 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("proxy.server"))) {

1131 
	`PATCH
(
ex‹nsiÚs
);

1132 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("proxy.debug"))) {

1133 
	`PATCH
(
debug
);

1134 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("proxy.balance"))) {

1135 
	`PATCH
(
b®ªû
);

1136 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("proxy.replace-http-host"))) {

1137 
	`PATCH
(
»¶aû_h‰p_ho¡
);

1143 
	}
}

1144 #undeà
PATCH


1146 
hªdËr_t
 
	$´oxy_£nd_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1148 
hªdËr_t
 
rc
 = 
	`´oxy_wr™e_»que¡
(
¤v
, 
hùx
);

1149 ià(
HANDLER_ERROR
 !ğ
rc
) {

1150  
rc
;

1152 
d©a_´oxy
 *
ho¡
 = 
hùx
->host;

1153 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdd", "proxy-server disabled:",

1154 
ho¡
->host,

1155 
ho¡
->
pÜt
,

1156 
hùx
->
fd
);

1159 
ho¡
->
is_di§bËd
 = 1;

1160 
ho¡
->
di§bË_ts
 = 
¤v
->
cur_ts
;

1163  
	`´oxy_»cÚÃù
(
¤v
, 
hùx
);

1165 
	}
}

1168 
hªdËr_t
 
´oxy_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
);

1171 
	$SUBREQUEST_FUNC
(
mod_´oxy_hªdË_sub»que¡
) {

1172 
¶ugš_d©a
 *
p
 = 
p_d
;

1174 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1176 ià(
NULL
 =ğ
hùx
è 
HANDLER_GO_ON
;

1179 ià(
cÚ
->
mode
 !ğ
p
->
id
è 
HANDLER_GO_ON
;

1181 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

1182 && 
cÚ
->
fe_¡¬‹d
) {

1183 ià(
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

1184 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

1185 } ià(!(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_IN
)) {

1187 
hªdËr_t
 
rc
 = 
	`´oxy_»cv_»¥Ú£
(
¤v
, 
hùx
);

1188 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

1192 ià(0 =ğ
hùx
->
wb
->
by‹s_š


1193 ? 
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST


1194 : 
hùx
->
wb
->
by‹s_š
 < hùx->
wb_»qËn
) {

1197 ià(
hùx
->
wb
->
by‹s_š
 - hùx->wb->
by‹s_out
 > 65536 - 4096

1198 && (
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_BUFMIN
)){

1199 
cÚ
->
cÚf
.
¡»am_»que¡_body
 &ğ~
FDEVENT_STREAM_REQUEST_POLLIN
;

1200 ià(0 !ğ
hùx
->
wb
->
by‹s_š
è 
HANDLER_WAIT_FOR_EVENT
;

1202 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

1203 
chunkqueue
 *
»q_cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

1204 ià(0 !ğ
hùx
->
wb
->
by‹s_š
 && !
	`chunkqueue_is_em±y
(
»q_cq
)) {

1205 
	`chunkqueue_­³nd_chunkqueue
(
hùx
->
wb
, 
»q_cq
);

1206 ià(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_OUT
) {

1207  (
r
 =ğ
HANDLER_GO_ON
è? 
HANDLER_WAIT_FOR_EVENT
 :„;

1210 ià(
r
 !ğ
HANDLER_GO_ON
) „;

1217 ià(-1 =ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1218  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 411);

1223  ((0 =ğ
hùx
->
wb
->
by‹s_š
 || !
	`chunkqueue_is_em±y
(hctx->wb))

1224 && 
hùx
->
¡©e
 !ğ
PROXY_STATE_CONNECT
)

1225 ? 
	`´oxy_£nd_»que¡
(
¤v
, 
hùx
)

1226 : 
HANDLER_WAIT_FOR_EVENT
;

1227 
	}
}

1230 
hªdËr_t
 
	$´oxy_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1232 
	`´oxy_demux_»¥Ú£
(
¤v
, 
hùx
)) {

1236 
	`h‰p_»¥Ú£_back’d_”rÜ
(
¤v
, 
hùx
->
»mÙe_cÚn
);

1240 
	`´oxy_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1242  
HANDLER_FINISHED
;

1245  
HANDLER_GO_ON
;

1246 
	}
}

1249 
hªdËr_t
 
	$´oxy_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
) {

1250 
hªdËr_ùx
 *
hùx
 = 
ùx
;

1251 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

1253 
	`jobli¡_­³nd
(
¤v
, 
cÚ
);

1255 ià(
»v’ts
 & 
FDEVENT_IN
) {

1256 
hªdËr_t
 
rc
 = 
	`´oxy_»cv_»¥Ú£
(
¤v
,
hùx
);

1257 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

1260 ià(
»v’ts
 & 
FDEVENT_OUT
) {

1261  
	`´oxy_£nd_»que¡
(
¤v
, 
hùx
);

1265 ià(
»v’ts
 & 
FDEVENT_HUP
) {

1266 ià(
hùx
->
¡©e
 =ğ
PROXY_STATE_CONNECT
) {

1268 
	`´oxy_£nd_»que¡
(
¤v
, 
hùx
);

1269 } ià(
cÚ
->
fe_¡¬‹d
) {

1275 
hªdËr_t
 
rc
;

1277 
rc
 = 
	`´oxy_»cv_»¥Ú£
(
¤v
,
hùx
);

1278 } 
rc
 =ğ
HANDLER_GO_ON
);

1279  
rc
;

1281 
	`´oxy_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1283 } ià(
»v’ts
 & 
FDEVENT_ERR
) {

1284 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "´oxy-FDEVENT_ERR, buˆnØHUP", 
»v’ts
);

1286 
	`h‰p_»¥Ú£_back’d_”rÜ
(
¤v
, 
cÚ
);

1287 
	`´oxy_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

1290  
HANDLER_FINISHED
;

1291 
	}
}

1293 
hªdËr_t
 
	$mod_´oxy_check_ex‹nsiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

1294 
¶ugš_d©a
 *
p
 = 
p_d
;

1295 
size_t
 
s_Ën
;

1296 
size_t
 
k
;

1297 
bufãr
 *
â
;

1298 
d©a_¬¿y
 *
ex‹nsiÚ
 = 
NULL
;

1299 
d©a_´oxy
 *
ho¡
;

1301 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

1304 ià(
cÚ
->
fe_¡¬‹d
 =ğ1è 
HANDLER_GO_ON
;

1306 
	`mod_´oxy_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1308 
â
 = 
cÚ
->
uri
.
·th
;

1309 ià(
	`bufãr_¡ršg_is_em±y
(
â
)è 
HANDLER_ERROR
;

1310 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
â
);

1313 
k
 = 0; k < 
p
->
cÚf
.
ex‹nsiÚs
->
u£d
; k++) {

1314 
d©a_¬¿y
 *
ext
 = 
NULL
;

1315 
size_t
 
ù_Ën
;

1317 
ext
 = (
d©a_¬¿y
 *)
p
->
cÚf
.
ex‹nsiÚs
->
d©a
[
k
];

1319 ià(
	`bufãr_is_em±y
(
ext
->
key
)) ;

1321 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ext
->
key
);

1323 ià(
s_Ën
 < 
ù_Ën
) ;

1326 ià(*(
ext
->
key
->
±r
) == '/') {

1327 ià(
	`¡ºcmp
(
â
->
±r
, 
ext
->
key
->±r, 
ù_Ën
) == 0) {

1328 
ex‹nsiÚ
 = 
ext
;

1331 } ià(0 =ğ
	`¡ºcmp
(
â
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ext
->
key
->ptr, ct_len)) {

1333 
ex‹nsiÚ
 = 
ext
;

1338 ià(
NULL
 =ğ
ex‹nsiÚ
) {

1339  
HANDLER_GO_ON
;

1342 
ho¡
 = 
	`mod_´oxy_ex‹nsiÚ_ho¡_g‘
(
¤v
, 
cÚ
, 
ex‹nsiÚ
, 
p
->
cÚf
.
b®ªû
, (í->cÚf.
debug
);

1343 ià(
NULL
 =ğ
ho¡
) {

1344  
HANDLER_FINISHED
;

1356 
hªdËr_ùx
 *
hùx
;

1357 
hùx
 = 
	`hªdËr_ùx_š™
();

1359 
hùx
->
»mÙe_cÚn
 = 
cÚ
;

1360 
hùx
->
¶ugš_d©a
 = 
p
;

1361 
hùx
->
ho¡
 = host;

1362 
hùx
->
ext
 = 
ex‹nsiÚ
;

1364 
hùx
->
cÚf
.
b®ªû
 = 
p
->conf.balance;

1365 
hùx
->
cÚf
.
debug
 = 
p
->conf.debug;

1366 
hùx
->
cÚf
.
»¶aû_h‰p_ho¡
 = 
p
->conf.replace_http_host;

1368 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

1369 
cÚ
->
mode
 = 
p
->
id
;

1371 ià(
p
->
cÚf
.
debug
) {

1372 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd",

1374 
ho¡
->ho¡, ho¡->
pÜt
);

1377  
HANDLER_GO_ON
;

1379 
	}
}

1381 
hªdËr_t
 
	$mod_´oxy_cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

1382 
¶ugš_d©a
 *
p
 = 
p_d
;

1383 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1384 ià(
hùx
è
	`´oxy_cÚÃùiÚ_şo£
(
¤v
, hctx);

1386  
HANDLER_GO_ON
;

1387 
	}
}

1395 
	$TRIGGER_FUNC
(
mod_´oxy_Œigg”
) {

1396 
¶ugš_d©a
 *
p
 = 
p_d
;

1398 ià(
p
->
cÚfig_¡Üage
) {

1399 
size_t
 
i
, 
n
, 
k
;

1400 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1401 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

1403 ià(!
s
) ;

1407 
k
 = 0; k < 
s
->
ex‹nsiÚs
->
u£d
; k++) {

1408 
d©a_¬¿y
 *
ex‹nsiÚ
 = (d©a_¬¿y *)
s
->
ex‹nsiÚs
->
d©a
[
k
];

1411 
n
 = 0;‚ < 
ex‹nsiÚ
->
v®ue
->
u£d
;‚++) {

1412 
d©a_´oxy
 *
ho¡
 = (d©a_´oxy *)
ex‹nsiÚ
->
v®ue
->
d©a
[
n
];

1414 ià(!
ho¡
->
is_di§bËd
 ||

1415 
¤v
->
cur_ts
 - 
ho¡
->
di§bË_ts
 < 5) ;

1417 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd",

1419 
ho¡
->ho¡, ho¡->
pÜt
);

1421 
ho¡
->
is_di§bËd
 = 0;

1427  
HANDLER_GO_ON
;

1428 
	}
}

1431 
mod_´oxy_¶ugš_š™
(
¶ugš
 *
p
);

1432 
	$mod_´oxy_¶ugš_š™
(
¶ugš
 *
p
) {

1433 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1434 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("proxy");

1436 
p
->
š™
 = 
mod_´oxy_š™
;

1437 
p
->
ş—nup
 = 
mod_´oxy_ä“
;

1438 
p
->
£t_deçuÉs
 = 
mod_´oxy_£t_deçuÉs
;

1439 
p
->
cÚÃùiÚ_»£t
 = 
mod_´oxy_cÚÃùiÚ_»£t
;

1440 
p
->
hªdË_cÚÃùiÚ_şo£
 = 
mod_´oxy_cÚÃùiÚ_»£t
;

1441 
p
->
hªdË_uri_ş—n
 = 
mod_´oxy_check_ex‹nsiÚ
;

1442 
p
->
hªdË_sub»que¡
 = 
mod_´oxy_hªdË_sub»que¡
;

1443 
p
->
hªdË_Œigg”
 = 
mod_´oxy_Œigg”
;

1445 
p
->
d©a
 = 
NULL
;

1448 
	}
}

	@mod_redirect.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

8 
	~"»¥Ú£.h
"

10 
	~<ùy³.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

15 
püe_keyv®ue_bufãr
 *
	m»dœeù
;

16 
d©a_cÚfig
 *
	mcÚ‹xt
;

18 
	m»dœeù_code
;

19 } 
	t¶ugš_cÚfig
;

22 
	mPLUGIN_DATA
;

23 
bufãr
 *
	mm©ch_buf
;

24 
bufãr
 *
	mloÿtiÚ
;

26 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

28 
¶ugš_cÚfig
 
	mcÚf
;

29 } 
	t¶ugš_d©a
;

31 
	$INIT_FUNC
(
mod_»dœeù_š™
) {

32 
¶ugš_d©a
 *
p
;

34 
p
 = 
	`ÿÎoc
(1, (*p));

36 
p
->
m©ch_buf
 = 
	`bufãr_š™
();

37 
p
->
loÿtiÚ
 = 
	`bufãr_š™
();

39  
p
;

40 
	}
}

42 
	$FREE_FUNC
(
mod_»dœeù_ä“
) {

43 
¶ugš_d©a
 *
p
 = 
p_d
;

45 ià(!
p
è 
HANDLER_GO_ON
;

47 ià(
p
->
cÚfig_¡Üage
) {

48 
size_t
 
i
;

49 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

50 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

52 ià(
NULL
 =ğ
s
) ;

54 
	`püe_keyv®ue_bufãr_ä“
(
s
->
»dœeù
);

56 
	`ä“
(
s
);

58 
	`ä“
(
p
->
cÚfig_¡Üage
);

62 
	`bufãr_ä“
(
p
->
m©ch_buf
);

63 
	`bufãr_ä“
(
p
->
loÿtiÚ
);

65 
	`ä“
(
p
);

67  
HANDLER_GO_ON
;

68 
	}
}

70 
	$SETDEFAULTS_FUNC
(
mod_»dœeù_£t_deçuÉs
) {

71 
¶ugš_d©a
 *
p
 = 
p_d
;

72 
size_t
 
i
 = 0;

74 
cÚfig_v®ues_t
 
cv
[] = {

75 { "u¾.»dœeù", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

76 { "u¾.»dœeù-code", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

77 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

80 ià(!
p
è 
HANDLER_ERROR
;

83 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

85 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

86 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

87 
¶ugš_cÚfig
 *
s
;

88 
size_t
 
j
;

89 
d©a_un£t
 *
du
;

90 
d©a_¬¿y
 *
da
;

92 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

93 
s
->
»dœeù
 = 
	`püe_keyv®ue_bufãr_š™
();

94 
s
->
»dœeù_code
 = 301;

96 
cv
[0].
de¡š©iÚ
 = 
s
->
»dœeù
;

97 
cv
[1].
de¡š©iÚ
 = &(
s
->
»dœeù_code
);

99 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

101 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

102  
HANDLER_ERROR
;

105 ià(
NULL
 =ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "url.redirect"))) {

110 ià(
du
->
ty³
 !ğ
TYPE_ARRAY
) {

111 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

114  
HANDLER_ERROR
;

117 
da
 = (
d©a_¬¿y
 *)
du
;

119 
j
 = 0; j < 
da
->
v®ue
->
u£d
; j++) {

120 ià(
da
->
v®ue
->
d©a
[
j
]->
ty³
 !ğ
TYPE_STRING
) {

121 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbs",

124 "[", 
da
->
v®ue
->
d©a
[
j
]->
key
, "](string)");

126  
HANDLER_ERROR
;

129 ià(0 !ğ
	`püe_keyv®ue_bufãr_­³nd
(
¤v
, 
s
->
»dœeù
,

130 ((
d©a_¡ršg
 *)(
da
->
v®ue
->
d©a
[
j
]))->
key
->
±r
,

131 ((
d©a_¡ršg
 *)(
da
->
v®ue
->
d©a
[
j
]))->v®ue->
±r
)) {

133 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

134 "püe-compçed fÜ", 
da
->
v®ue
->
d©a
[
j
]->
key
);

135  
HANDLER_ERROR
;

140  
HANDLER_GO_ON
;

141 
	}
}

142 #ifdeà
HAVE_PCRE_H


143 
	$mod_»dœeù_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

144 
size_t
 
i
, 
j
;

145 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

147 
p
->
cÚf
.
»dœeù
 = 
s
->redirect;

148 
p
->
cÚf
.
»dœeù_code
 = 
s
->redirect_code;

149 
p
->
cÚf
.
cÚ‹xt
 = 
NULL
;

152 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

153 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

154 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

157 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

160 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

161 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

163 ià(0 =ğ
	`¡rcmp
(
du
->
key
->
±r
, "url.redirect")) {

164 
p
->
cÚf
.
»dœeù
 = 
s
->redirect;

165 
p
->
cÚf
.
cÚ‹xt
 = 
dc
;

166 } ià(0 =ğ
	`¡rcmp
(
du
->
key
->
±r
, "url.redirect-code")) {

167 
p
->
cÚf
.
»dœeù_code
 = 
s
->redirect_code;

173 
	}
}

175 
hªdËr_t
 
	$mod_»dœeù_uri_hªdËr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d©a
) {

176 #ifdeà
HAVE_PCRE_H


177 
¶ugš_d©a
 *
p
 = 
p_d©a
;

178 
size_t
 
i
;

187 
	`mod_»dœeù_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

189 
	`bufãr_cİy_bufãr
(
p
->
m©ch_buf
, 
cÚ
->
»que¡
.
uri
);

191 
i
 = 0; i < 
p
->
cÚf
.
»dœeù
->
u£d
; i++) {

192 
püe
 *
m©ch
;

193 
püe_exŒa
 *
exŒa
;

194 cÚ¡ *
·‰”n
;

195 
size_t
 
·‰”n_Ën
;

196 
n
;

197 
püe_keyv®ue
 *
kv
 = 
p
->
cÚf
.
»dœeù
->kv[
i
];

198 
	#N
 10

	)

199 
ovec
[
N
 * 3];

201 
m©ch
 = 
kv
->
key
;

202 
exŒa
 = 
kv
->
key_exŒa
;

203 
·‰”n
 = 
kv
->
v®ue
->
±r
;

204 
·‰”n_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
kv
->
v®ue
);

206 ià((
n
 = 
	`püe_exec
(
m©ch
, 
exŒa
, 
	`CONST_BUF_LEN
(
p
->
m©ch_buf
), 0, 0, 
ovec
, 3 * 
N
)) < 0) {

207 ià(
n
 !ğ
PCRE_ERROR_NOMATCH
) {

208 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

209 "executiÚƒ¼Ü whm©chšg: ", 
n
);

210  
HANDLER_ERROR
;

212 } ià(0 =ğ
·‰”n_Ën
) {

215  
HANDLER_GO_ON
;

217 cÚ¡ **
li¡
;

218 
size_t
 
¡¬t
;

219 
size_t
 
k
;

222 
	`püe_g‘_sub¡ršg_li¡
(
p
->
m©ch_buf
->
±r
, 
ovec
, 
n
, &
li¡
);

226 
	`bufãr_»£t
(
p
->
loÿtiÚ
);

228 
¡¬t
 = 0;

229 
k
 = 0; k + 1 < 
·‰”n_Ën
; k++) {

230 ià(
·‰”n
[
k
] == '$' ||…attern[k] == '%') {

233 
size_t
 
num
 = 
·‰”n
[
k
 + 1] - '0';

235 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
loÿtiÚ
, 
·‰”n
 + 
¡¬t
, 
k
 - start);

237 ià(!
	`isdig™
(()
·‰”n
[
k
 + 1])) {

239 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
loÿtiÚ
, 
·‰”n
+
k
,…attern[k] ==…attern[k+1] ? 1 : 2);

240 } ià(
·‰”n
[
k
] == '$') {

242 ià(
num
 < (
size_t
)
n
) {

243 
	`bufãr_­³nd_¡ršg
(
p
->
loÿtiÚ
, 
li¡
[
num
]);

245 } ià(
p
->
cÚf
.
cÚ‹xt
 =ğ
NULL
) {

247 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

249 
kv
->
v®ue
);

251 
	`cÚfig_­³nd_cÚd_m©ch_bufãr
(
cÚ
, 
p
->
cÚf
.
cÚ‹xt
,…->
loÿtiÚ
, 
num
);

254 
k
++;

255 
¡¬t
 = 
k
 + 1;

259 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
loÿtiÚ
, 
·‰”n
 + 
¡¬t
, 
·‰”n_Ën
 - start);

261 
	`püe_ä“
(
li¡
);

263 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("LoÿtiÚ"), 
	`CONST_BUF_LEN
(
p
->
loÿtiÚ
));

265 
cÚ
->
h‰p_¡©us
 = 
p
->
cÚf
.
»dœeù_code
 > 99 &&…->conf.redirect_code < 1000 ?…->conf.redirect_code : 301;

266 
cÚ
->
mode
 = 
DIRECT
;

267 
cÚ
->
fe_fšished
 = 1;

269  
HANDLER_FINISHED
;

272 #undeà
N


275 
	`UNUSED
(
¤v
);

276 
	`UNUSED
(
cÚ
);

277 
	`UNUSED
(
p_d©a
);

280  
HANDLER_GO_ON
;

281 
	}
}

284 
mod_»dœeù_¶ugš_š™
(
¶ugš
 *
p
);

285 
	$mod_»dœeù_¶ugš_š™
(
¶ugš
 *
p
) {

286 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

287 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("redirect");

289 
p
->
š™
 = 
mod_»dœeù_š™
;

290 
p
->
hªdË_uri_ş—n
 = 
mod_»dœeù_uri_hªdËr
;

291 
p
->
£t_deçuÉs
 = 
mod_»dœeù_£t_deçuÉs
;

292 
p
->
ş—nup
 = 
mod_»dœeù_ä“
;

294 
p
->
d©a
 = 
NULL
;

297 
	}
}

	@mod_rewrite.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

8 
	~"¡©_ÿche.h
"

10 
	~<ùy³.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

14 #ifdeà
HAVE_PCRE_H


16 
püe
 *
	mkey
;

18 
bufãr
 *
	mv®ue
;

20 
	mÚû
;

21 } 
	t»wr™e_ruË
;

24 
»wr™e_ruË
 **
	m±r
;

26 
size_t
 
	mu£d
;

27 
size_t
 
	msize
;

28 } 
	t»wr™e_ruË_bufãr
;

31 
»wr™e_ruË_bufãr
 *
	m»wr™e
;

32 
»wr™e_ruË_bufãr
 *
	m»wr™e_NF
;

33 
d©a_cÚfig
 *
	mcÚ‹xt
, *
	mcÚ‹xt_NF
;

34 } 
	t¶ugš_cÚfig
;

37 ’um { 
	mREWRITE_STATE_UNSET
, 
	mREWRITE_STATE_FINISHED
} 
	m¡©e
;

38 
	mloİs
;

39 } 
	thªdËr_ùx
;

42 
	mPLUGIN_DATA
;

43 
bufãr
 *
	mm©ch_buf
;

45 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

47 
¶ugš_cÚfig
 
	mcÚf
;

48 } 
	t¶ugš_d©a
;

50 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
() {

51 
hªdËr_ùx
 * 
hùx
;

53 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

55 
hùx
->
¡©e
 = 
REWRITE_STATE_UNSET
;

56 
hùx
->
loİs
 = 0;

58  
hùx
;

59 
	}
}

61 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

62 
	`ä“
(
hùx
);

63 
	}
}

65 
»wr™e_ruË_bufãr
 *
	$»wr™e_ruË_bufãr_š™
() {

66 
»wr™e_ruË_bufãr
 *
kvb
;

68 
kvb
 = 
	`ÿÎoc
(1, (*kvb));

70  
kvb
;

71 
	}
}

73 
	$»wr™e_ruË_bufãr_­³nd
(
»wr™e_ruË_bufãr
 *
kvb
, 
bufãr
 *
key
, bufã¸*
v®ue
, 
Úû
) {

74 
size_t
 
i
;

75 cÚ¡ *
”½Œ
;

76 
”roff
;

78 ià(!
key
)  -1;

80 ià(
kvb
->
size
 == 0) {

81 
kvb
->
size
 = 4;

82 
kvb
->
u£d
 = 0;

84 
kvb
->
±r
 = 
	`m®loc
(kvb->
size
 * (*kvb->ptr));

86 
i
 = 0; i < 
kvb
->
size
; i++) {

87 
kvb
->
±r
[
i
] = 
	`ÿÎoc
(1, (**kvb->ptr));

89 } ià(
kvb
->
u£d
 =ğkvb->
size
) {

90 
kvb
->
size
 += 4;

92 
kvb
->
±r
 = 
	`»®loc
(kvb->±r, kvb->
size
 * (*kvb->ptr));

94 
i
 = 
kvb
->
u£d
; i < kvb->
size
; i++) {

95 
kvb
->
±r
[
i
] = 
	`ÿÎoc
(1, (**kvb->ptr));

99 ià(
NULL
 =ğ(
kvb
->
±r
[kvb->
u£d
]->
key
 = 
	`püe_compe
(key->ptr,

100 0, &
”½Œ
, &
”roff
, 
NULL
))) {

105 
kvb
->
±r
[kvb->
u£d
]->
v®ue
 = 
	`bufãr_š™
();

106 
	`bufãr_cİy_bufãr
(
kvb
->
±r
[kvb->
u£d
]->
v®ue
, value);

107 
kvb
->
±r
[kvb->
u£d
]->
Úû
 = once;

109 
kvb
->
u£d
++;

112 
	}
}

114 
	$»wr™e_ruË_bufãr_ä“
(
»wr™e_ruË_bufãr
 *
kvb
) {

115 
size_t
 
i
;

117 
i
 = 0; i < 
kvb
->
size
; i++) {

118 ià(
kvb
->
±r
[
i
]->
key
è
	`püe_ä“
(kvb->ptr[i]->key);

119 ià(
kvb
->
±r
[
i
]->
v®ue
è
	`bufãr_ä“
(kvb->ptr[i]->value);

120 
	`ä“
(
kvb
->
±r
[
i
]);

123 ià(
kvb
->
±r
è
	`ä“
(kvb->ptr);

125 
	`ä“
(
kvb
);

126 
	}
}

129 
	$INIT_FUNC
(
mod_»wr™e_š™
) {

130 
¶ugš_d©a
 *
p
;

132 
p
 = 
	`ÿÎoc
(1, (*p));

134 
p
->
m©ch_buf
 = 
	`bufãr_š™
();

136  
p
;

137 
	}
}

139 
	$FREE_FUNC
(
mod_»wr™e_ä“
) {

140 
¶ugš_d©a
 *
p
 = 
p_d
;

142 
	`UNUSED
(
¤v
);

144 ià(!
p
è 
HANDLER_GO_ON
;

146 
	`bufãr_ä“
(
p
->
m©ch_buf
);

147 ià(
p
->
cÚfig_¡Üage
) {

148 
size_t
 
i
;

149 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

150 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

152 ià(
NULL
 =ğ
s
) ;

154 
	`»wr™e_ruË_bufãr_ä“
(
s
->
»wr™e
);

155 
	`»wr™e_ruË_bufãr_ä“
(
s
->
»wr™e_NF
);

157 
	`ä“
(
s
);

159 
	`ä“
(
p
->
cÚfig_¡Üage
);

162 
	`ä“
(
p
);

164  
HANDLER_GO_ON
;

165 
	}
}

167 
	$·r£_cÚfig_’Œy
(
£rv”
 *
¤v
, 
¬¿y
 *
ÿ
, 
»wr™e_ruË_bufãr
 *
kvb
, cÚ¡ *
İtiÚ
, 
Úû
) {

168 
d©a_un£t
 *
du
;

170 ià(
NULL
 !ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
ÿ
, 
İtiÚ
))) {

171 
d©a_¬¿y
 *
da
;

172 
size_t
 
j
;

174 ià(
du
->
ty³
 !ğ
TYPE_ARRAY
) {

175 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

176 "uÃx³ùedy³ fÜ key: ", 
İtiÚ
, "array of strings");

178  
HANDLER_ERROR
;

181 
da
 = (
d©a_¬¿y
 *)
du
;

183 
j
 = 0; j < 
da
->
v®ue
->
u£d
; j++) {

184 ià(
da
->
v®ue
->
d©a
[
j
]->
ty³
 !ğ
TYPE_STRING
) {

185 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbs",

187 
İtiÚ
,

188 "[", 
da
->
v®ue
->
d©a
[
j
]->
key
, "](string)");

190  
HANDLER_ERROR
;

193 ià(0 !ğ
	`»wr™e_ruË_bufãr_­³nd
(
kvb
,

194 ((
d©a_¡ršg
 *)(
da
->
v®ue
->
d©a
[
j
]))->
key
,

195 ((
d©a_¡ršg
 *)(
da
->
v®ue
->
d©a
[
j
]))->value,

196 
Úû
)) {

197 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

198 "püe-compçed fÜ", 
da
->
v®ue
->
d©a
[
j
]->
key
);

199  
HANDLER_ERROR
;

205 
	}
}

207 
	$·r£_cÚfig_’Œy
(
£rv”
 *
¤v
, 
¬¿y
 *
ÿ
, cÚ¡ *
İtiÚ
) {

208 
logged_mes§ge
 = 0;

209 ià(
logged_mes§ge
)  0;

210 ià(
NULL
 !ğ
	`¬¿y_g‘_–em’t
(
ÿ
, 
İtiÚ
)) {

211 
logged_mes§ge
 = 1;

212 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

216 
	}
}

219 
	$SETDEFAULTS_FUNC
(
mod_»wr™e_£t_deçuÉs
) {

220 
size_t
 
i
 = 0;

221 
cÚfig_v®ues_t
 
cv
[] = {

222 { "u¾.»wr™e-»³©", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

223 { "u¾.»wr™e-Úû", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

231 { "u¾.»wr™e-»³©-if-nÙ-fe", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

232 { "u¾.»wr™e-if-nÙ-fe", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

240 { "u¾.»wr™e", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

241 { "u¾.»wr™e-fš®", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

242 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

245 #ifdeà
HAVE_PCRE_H


246 
¶ugš_d©a
 *
p
 = 
p_d
;

248 ià(!
p
è 
HANDLER_ERROR
;

251 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

253 
	`UNUSED
(
p_d
);

256 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

257 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

258 #ifdeà
HAVE_PCRE_H


259 
¶ugš_cÚfig
 *
s
;

261 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

262 
s
->
»wr™e
 = 
	`»wr™e_ruË_bufãr_š™
();

263 
s
->
»wr™e_NF
 = 
	`»wr™e_ruË_bufãr_š™
();

264 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

267 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

268  
HANDLER_ERROR
;

271 #iâdeà
HAVE_PCRE_H


272 
	#·r£_cÚfig_’Œy
(
¤v
, 
ÿ
, 
x
, 
İtiÚ
, 
y
è
	`·r£_cÚfig_’Œy
(¤v, ca, o±iÚ)

	)

274 
	`·r£_cÚfig_’Œy
(
¤v
, 
cÚfig
->
v®ue
, 
s
->
»wr™e
, "url.rewrite-once", 1);

275 
	`·r£_cÚfig_’Œy
(
¤v
, 
cÚfig
->
v®ue
, 
s
->
»wr™e
, "url.rewrite-final", 1);

276 
	`·r£_cÚfig_’Œy
(
¤v
, 
cÚfig
->
v®ue
, 
s
->
»wr™e_NF
, "url.rewrite-if-not-file", 1);

277 
	`·r£_cÚfig_’Œy
(
¤v
, 
cÚfig
->
v®ue
, 
s
->
»wr™e_NF
, "url.rewrite-repeat-if-not-file", 0);

278 
	`·r£_cÚfig_’Œy
(
¤v
, 
cÚfig
->
v®ue
, 
s
->
»wr™e
, "url.rewrite", 1);

279 
	`·r£_cÚfig_’Œy
(
¤v
, 
cÚfig
->
v®ue
, 
s
->
»wr™e
, "url.rewrite-repeat", 0);

282  
HANDLER_GO_ON
;

283 
	}
}

285 #ifdeà
HAVE_PCRE_H


287 
	#PATCH
(
x
) \

288 
p
->
cÚf
.
x
 = 
s
->x;

	)

289 
	$mod_»wr™e_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

290 
size_t
 
i
, 
j
;

291 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

293 
	`PATCH
(
»wr™e
);

294 
	`PATCH
(
»wr™e_NF
);

295 
p
->
cÚf
.
cÚ‹xt
 = 
NULL
;

296 
p
->
cÚf
.
cÚ‹xt_NF
 = 
NULL
;

299 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

300 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

301 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

304 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

307 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

308 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

310 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.rewrite"))) {

311 
	`PATCH
(
»wr™e
);

312 
p
->
cÚf
.
cÚ‹xt
 = 
dc
;

313 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.rewrite-once"))) {

314 
	`PATCH
(
»wr™e
);

315 
p
->
cÚf
.
cÚ‹xt
 = 
dc
;

316 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.rewrite-repeat"))) {

317 
	`PATCH
(
»wr™e
);

318 
p
->
cÚf
.
cÚ‹xt
 = 
dc
;

319 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.rewrite-if-not-file"))) {

320 
	`PATCH
(
»wr™e_NF
);

321 
p
->
cÚf
.
cÚ‹xt_NF
 = 
dc
;

322 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.rewrite-repeat-if-not-file"))) {

323 
	`PATCH
(
»wr™e_NF
);

324 
p
->
cÚf
.
cÚ‹xt_NF
 = 
dc
;

325 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("url.rewrite-final"))) {

326 
	`PATCH
(
»wr™e
);

327 
p
->
cÚf
.
cÚ‹xt
 = 
dc
;

333 
	}
}

335 
	$URIHANDLER_FUNC
(
mod_»wr™e_cÚ_»£t
) {

336 
¶ugš_d©a
 *
p
 = 
p_d
;

338 
	`UNUSED
(
¤v
);

340 ià(
cÚ
->
¶ugš_ùx
[
p
->
id
]) {

341 
	`hªdËr_ùx_ä“
(
cÚ
->
¶ugš_ùx
[
p
->
id
]);

342 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

345  
HANDLER_GO_ON
;

346 
	}
}

348 
hªdËr_t
 
	$´oûss_»wr™e_ruËs
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
»wr™e_ruË_bufãr
 *
kvb
) {

349 
size_t
 
i
;

350 
hªdËr_ùx
 *
hùx
;

352 ià(
cÚ
->
¶ugš_ùx
[
p
->
id
]) {

353 
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

355 ià(
hùx
->
loİs
++ > 100) {

356 
d©a_cÚfig
 *
dc
 = 
p
->
cÚf
.
cÚ‹xt
;

357 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SbbSBS",

358 "ENDLESS LOOP IN„ewr™e-ruË DETECTED ...‡bÜtšg„eque¡,…”h­ you wªˆtØu£ u¾.»wr™e-Úû in¡—d oàu¾.»wr™e-»³© ($", 
dc
->
comp_key
, dc->
İ
, "\"", dc->
¡ršg
, "\")");

360  
HANDLER_ERROR
;

363 ià(
hùx
->
¡©e
 =ğ
REWRITE_STATE_FINISHED
è 
HANDLER_GO_ON
;

366 
	`bufãr_cİy_bufãr
(
p
->
m©ch_buf
, 
cÚ
->
»que¡
.
uri
);

368 
i
 = 0; i < 
kvb
->
u£d
; i++) {

369 
püe
 *
m©ch
;

370 cÚ¡ *
·‰”n
;

371 
size_t
 
·‰”n_Ën
;

372 
n
;

373 
»wr™e_ruË
 *
ruË
 = 
kvb
->
±r
[
i
];

374 
	#N
 10

	)

375 
ovec
[
N
 * 3];

377 
m©ch
 = 
ruË
->
key
;

378 
·‰”n
 = 
ruË
->
v®ue
->
±r
;

379 
·‰”n_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ruË
->
v®ue
);

381 ià((
n
 = 
	`püe_exec
(
m©ch
, 
NULL
, 
	`CONST_BUF_LEN
(
p
->
m©ch_buf
), 0, 0, 
ovec
, 3 * 
N
)) < 0) {

382 ià(
n
 !ğ
PCRE_ERROR_NOMATCH
) {

383 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

384 "executiÚƒ¼Ü whm©chšg: ", 
n
);

385  
HANDLER_ERROR
;

387 } ià(0 =ğ
·‰”n_Ën
) {

390  
HANDLER_GO_ON
;

392 cÚ¡ **
li¡
;

393 
size_t
 
¡¬t
;

394 
size_t
 
k
;

397 
	`püe_g‘_sub¡ršg_li¡
(
p
->
m©ch_buf
->
±r
, 
ovec
, 
n
, &
li¡
);

401 
	`bufãr_»£t
(
cÚ
->
»que¡
.
uri
);

403 
¡¬t
 = 0;

404 
k
 = 0; k+1 < 
·‰”n_Ën
; k++) {

405 ià(
·‰”n
[
k
] == '$' ||…attern[k] == '%') {

408 
size_t
 
num
 = 
·‰”n
[
k
 + 1] - '0';

410 
	`bufãr_­³nd_¡ršg_Ën
(
cÚ
->
»que¡
.
uri
, 
·‰”n
 + 
¡¬t
, 
k
 - start);

412 ià(!
	`isdig™
(()
·‰”n
[
k
 + 1])) {

414 
	`bufãr_­³nd_¡ršg_Ën
(
cÚ
->
»que¡
.
uri
, 
·‰”n
+
k
,…attern[k] ==…attern[k+1] ? 1 : 2);

415 } ià(
·‰”n
[
k
] == '$') {

417 ià(
num
 < (
size_t
)
n
) {

418 
	`bufãr_­³nd_¡ršg
(
cÚ
->
»que¡
.
uri
, 
li¡
[
num
]);

420 } ià(
p
->
cÚf
.
cÚ‹xt
 =ğ
NULL
) {

422 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

424 
ruË
->
v®ue
);

427 
	`cÚfig_­³nd_cÚd_m©ch_bufãr
(
cÚ
, 
p
->
cÚf
.
cÚ‹xt
, cÚ->
»que¡
.
uri
, 
num
);

430 
k
++;

431 
¡¬t
 = 
k
 + 1;

435 
	`bufãr_­³nd_¡ršg_Ën
(
cÚ
->
»que¡
.
uri
, 
·‰”n
 + 
¡¬t
, 
·‰”n_Ën
 - start);

437 
	`püe_ä“
(
li¡
);

439 ià(
cÚ
->
¶ugš_ùx
[
p
->
id
] =ğ
NULL
) {

440 
hùx
 = 
	`hªdËr_ùx_š™
();

441 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

443 
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

446 ià(
ruË
->
Úû
è
hùx
->
¡©e
 = 
REWRITE_STATE_FINISHED
;

448  
HANDLER_COMEBACK
;

450 #undeà
N


453  
HANDLER_GO_ON
;

454 
	}
}

456 
	$URIHANDLER_FUNC
(
mod_»wr™e_physiÿl
) {

457 
¶ugš_d©a
 *
p
 = 
p_d
;

458 
hªdËr_t
 
r
;

459 
¡©_ÿche_’Œy
 *
sû
;

461 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

463 
	`mod_»wr™e_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

464 
p
->
cÚf
.
cÚ‹xt
 =…->cÚf.
cÚ‹xt_NF
;

466 ià(!
p
->
cÚf
.
»wr™e_NF
è 
HANDLER_GO_ON
;

469 
sû
 = 
NULL
;

470 ià(
HANDLER_ERROR
 !ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

471 ià(
	`S_ISREG
(
sû
->
¡
.
¡_mode
)è 
HANDLER_GO_ON
;

474 
r
 = 
	`´oûss_»wr™e_ruËs
(
¤v
, 
cÚ
, 
p
,…->
cÚf
.
»wr™e_NF
)) {

475 
HANDLER_COMEBACK
:

476 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

478  
r
;

481  
HANDLER_GO_ON
;

482 
	}
}

484 
	$URIHANDLER_FUNC
(
mod_»wr™e_uri_hªdËr
) {

485 
¶ugš_d©a
 *
p
 = 
p_d
;

487 
	`mod_»wr™e_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

489 ià(!
p
->
cÚf
.
»wr™e
è 
HANDLER_GO_ON
;

491  
	`´oûss_»wr™e_ruËs
(
¤v
, 
cÚ
, 
p
,…->
cÚf
.
»wr™e
);

492 
	}
}

495 
mod_»wr™e_¶ugš_š™
(
¶ugš
 *
p
);

496 
	$mod_»wr™e_¶ugš_š™
(
¶ugš
 *
p
) {

497 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

498 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("rewrite");

500 #ifdeà
HAVE_PCRE_H


501 
p
->
š™
 = 
mod_»wr™e_š™
;

505 
p
->
hªdË_uri_¿w
 = 
mod_»wr™e_uri_hªdËr
;

506 
p
->
hªdË_physiÿl
 = 
mod_»wr™e_physiÿl
;

507 
p
->
ş—nup
 = 
mod_»wr™e_ä“
;

508 
p
->
cÚÃùiÚ_»£t
 = 
mod_»wr™e_cÚ_»£t
;

510 
p
->
£t_deçuÉs
 = 
mod_»wr™e_£t_deçuÉs
;

512 
p
->
d©a
 = 
NULL
;

515 
	}
}

	@mod_rrdtool.c

1 
	~"fœ¡.h
"

3 
	~"£rv”.h
"

4 
	~"cÚÃùiÚs.h
"

5 
	~"»¥Ú£.h
"

6 
	~"cÚÃùiÚs.h
"

7 
	~"log.h
"

9 
	~"¶ugš.h
"

10 
	~<sys/ty³s.h
>

12 
	~<as£¹.h
>

13 
	~<fú.h
>

14 
	~<¡dlib.h
>

15 
	~<¡dio.h
>

16 
	~<¡ršg.h
>

17 
	~<uni¡d.h
>

18 
	~<”ºo.h
>

19 
	~<time.h
>

21 #ifdeà
HAVE_FORK


23 
	~<sys/wa™.h
>

26 
bufãr
 *
	m·th_¼dtoŞ_bš
;

27 
bufãr
 *
	m·th_¼d
;

29 
	m»que¡s
, *
	m»que¡s_±r
;

30 
	mby‹s_wr™‹n
, *
	mby‹s_wr™‹n_±r
;

31 
	mby‹s_»ad
, *
	mby‹s_»ad_±r
;

32 } 
	t¶ugš_cÚfig
;

35 
	mPLUGIN_DATA
;

37 
bufãr
 *
	mcmd
;

38 
bufãr
 *
	m»¥
;

40 
	m»ad_fd
, 
	mwr™e_fd
;

41 
pid_t
 
	m¼dtoŞ_pid
;

43 
	m¼dtoŞ_ruÂšg
;

45 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

46 
¶ugš_cÚfig
 
	mcÚf
;

47 } 
	t¶ugš_d©a
;

49 
	$INIT_FUNC
(
mod_¼d_š™
) {

50 
¶ugš_d©a
 *
p
;

52 
p
 = 
	`ÿÎoc
(1, (*p));

54 
p
->
»¥
 = 
	`bufãr_š™
();

55 
p
->
cmd
 = 
	`bufãr_š™
();

57  
p
;

58 
	}
}

60 
	$FREE_FUNC
(
mod_¼d_ä“
) {

61 
¶ugš_d©a
 *
p
 = 
p_d
;

62 
size_t
 
i
;

64 ià(!
p
è 
HANDLER_GO_ON
;

66 ià(
p
->
cÚfig_¡Üage
) {

67 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

68 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

70 ià(
NULL
 =ğ
s
) ;

72 
	`bufãr_ä“
(
s
->
·th_¼dtoŞ_bš
);

73 
	`bufãr_ä“
(
s
->
·th_¼d
);

75 
	`ä“
(
s
);

78 
	`bufãr_ä“
(
p
->
cmd
);

79 
	`bufãr_ä“
(
p
->
»¥
);

81 
	`ä“
(
p
->
cÚfig_¡Üage
);

83 ià(
p
->
¼dtoŞ_pid
) {

84 
¡©us
;

85 
	`şo£
(
p
->
»ad_fd
);

86 
	`şo£
(
p
->
wr™e_fd
);

87 #ifdeà
HAVE_FORK


89 
	`wa™pid
(
p
->
¼dtoŞ_pid
, &
¡©us
, 0);

93 
	`ä“
(
p
);

95  
HANDLER_GO_ON
;

96 
	}
}

98 
	$mod_¼d_ü—‹_pe
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
) {

99 #ifdeà
HAVE_FORK


100 
pid_t
 
pid
;

102 
to_¼dtoŞ_fds
[2];

103 
äom_¼dtoŞ_fds
[2];

104 ià(
	`pe
(
to_¼dtoŞ_fds
)) {

105 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

106 "pçed: ", 
	`¡»¼Ü
(
”ºo
));

110 ià(
	`pe
(
äom_¼dtoŞ_fds
)) {

111 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

112 "pçed: ", 
	`¡»¼Ü
(
”ºo
));

117 
pid
 = 
	`fÜk
()) {

120 **
¬gs
;

121 
¬gc
;

122 
i
 = 0;

123 *
dash
 = "-";

126 
	`şo£
(
STDOUT_FILENO
);

127 
	`dup2
(
äom_¼dtoŞ_fds
[1], 
STDOUT_FILENO
);

128 
	`şo£
(
äom_¼dtoŞ_fds
[1]);

130 
	`şo£
(
äom_¼dtoŞ_fds
[0]);

133 
	`şo£
(
STDIN_FILENO
);

134 
	`dup2
(
to_¼dtoŞ_fds
[0], 
STDIN_FILENO
);

135 
	`şo£
(
to_¼dtoŞ_fds
[0]);

137 
	`şo£
(
to_¼dtoŞ_fds
[1]);

140 
¬gc
 = 3;

141 
¬gs
 = 
	`m®loc
((*¬gsè* 
¬gc
);

142 
i
 = 0;

144 
¬gs
[
i
++] = 
p
->
cÚf
.
·th_¼dtoŞ_bš
->
±r
;

145 
¬gs
[
i
++] = 
dash
;

146 
¬gs
[
i
 ] = 
NULL
;

149 
i
 = 3; i < 256; i++) {

150 
	`şo£
(
i
);

154 
	`execv
(
¬gs
[0],‡rgs);

159 
	`SEGFAULT
();

164 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fÜk faed: ", 
	`¡»¼Ü
(
”ºo
));

169 
	`şo£
(
äom_¼dtoŞ_fds
[1]);

170 
	`şo£
(
to_¼dtoŞ_fds
[0]);

173 
p
->
wr™e_fd
 = 
to_¼dtoŞ_fds
[1];

174 
p
->
»ad_fd
 = 
äom_¼dtoŞ_fds
[0];

175 
p
->
¼dtoŞ_pid
 = 
pid
;

177 
	`fd_şo£_Ú_exec
(
p
->
wr™e_fd
);

178 
	`fd_şo£_Ú_exec
(
p
->
»ad_fd
);

188 
	}
}

193 
ssize_t
 
	$§ã_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

194 
ssize_t
 
»s
, 
sum
 = 0;

197 
»s
 = 
	`wr™e
(
fd
, 
buf
, 
couÁ
);

198 ià(
»s
 >= 0) {

199 
sum
 +ğ
»s
;

201 ià(
»s
 =ğ0 || (
size_t
è» =ğ
couÁ
è 
sum
;

202 
couÁ
 -ğ
»s
;

203 
buf
 = (cÚ¡ *èbuà+ 
»s
;

206 
”ºo
) {

207 
EINTR
:

213 
	}
}

216 
ssize_t
 
	$§ã_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

217 
ssize_t
 
»s
;

220 
»s
 = 
	`»ad
(
fd
, 
buf
, 
couÁ
);

221 ià(
»s
 >= 0) „es;

222 
”ºo
) {

223 
EINTR
:

229 
	}
}

231 
	$mod_¼dtoŞ_ü—‹_¼d
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, 
¶ugš_cÚfig
 *
s
) {

232 
¡©
 
¡
;

233 
r
;

236 ià(0 =ğ
	`¡©
(
s
->
·th_¼d
->
±r
, &
¡
)) {

238 ià(!
	`S_ISREG
(
¡
.
¡_mode
)) {

239 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

240 "nÙ‡„eguÏ¸fe:", 
s
->
·th_¼d
);

241  
HANDLER_ERROR
;

245 ià(
¡
.
¡_size
 > 0) {

246  
HANDLER_GO_ON
;

251 
	`bufãr_cİy_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
("create "));

252 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
cmd
, 
s
->
·th_¼d
);

253 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
(

271 ià(-1 =ğ(
	`§ã_wr™e
(
p
->
wr™e_fd
, 
	`CONST_BUF_LEN
Õ->
cmd
)))) {

272 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

273 "¼dtoŞ-wr™e: faed", 
	`¡»¼Ü
(
”ºo
));

275  
HANDLER_ERROR
;

278 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
»¥
, 4095);

279 ià(-1 =ğ(
r
 = 
	`§ã_»ad
(
p
->
»ad_fd
,…->
»¥
->
±r
,…->»¥->
size
 - 1))) {

280 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

281 "¼dtoŞ-»ad: faed", 
	`¡»¼Ü
(
”ºo
));

283  
HANDLER_ERROR
;

286 
	`bufãr_comm™
(
p
->
»¥
, 
r
);

288 ià(
p
->
»¥
->
±r
[0] != 'O' ||

289 
p
->
»¥
->
±r
[1] != 'K') {

290 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbb",

291 "¼dtoŞ-»¥Ú£:", 
p
->
cmd
,…->
»¥
);

293  
HANDLER_ERROR
;

296  
HANDLER_GO_ON
;

297 
	}
}

299 
	#PATCH
(
x
) \

300 
p
->
cÚf
.
x
 = 
s
->x;

	)

301 
	$mod_¼d_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

302 
size_t
 
i
, 
j
;

303 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

305 
	`PATCH
(
·th_¼dtoŞ_bš
);

306 
	`PATCH
(
·th_¼d
);

308 
p
->
cÚf
.
by‹s_wr™‹n_±r
 = &(
s
->
by‹s_wr™‹n
);

309 
p
->
cÚf
.
by‹s_»ad_±r
 = &(
s
->
by‹s_»ad
);

310 
p
->
cÚf
.
»que¡s_±r
 = &(
s
->
»que¡s
);

313 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

314 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

315 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

318 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

321 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

322 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

324 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("rrdtool.db-name"))) {

325 
	`PATCH
(
·th_¼d
);

328 
p
->
cÚf
.
by‹s_wr™‹n_±r
 = &(
s
->
by‹s_wr™‹n
);

329 
p
->
cÚf
.
by‹s_»ad_±r
 = &(
s
->
by‹s_»ad
);

330 
p
->
cÚf
.
»que¡s_±r
 = &(
s
->
»que¡s
);

336 
	}
}

337 #undeà
PATCH


339 
	$SETDEFAULTS_FUNC
(
mod_¼d_£t_deçuÉs
) {

340 
¶ugš_d©a
 *
p
 = 
p_d
;

341 
size_t
 
i
;

343 
cÚfig_v®ues_t
 
cv
[] = {

344 { "¼dtoŞ.bš¬y", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

345 { "¼dtoŞ.db-Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

346 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

349 ià(!
p
è 
HANDLER_ERROR
;

351 
	`fÜû_as£¹
(
¤v
->
cÚfig_cÚ‹xt
->
u£d
 > 0);

352 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

354 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

355 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

356 
¶ugš_cÚfig
 *
s
;

358 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

359 
s
->
·th_¼dtoŞ_bš
 = 
	`bufãr_š™
();

360 
s
->
·th_¼d
 = 
	`bufãr_š™
();

361 
s
->
»que¡s
 = 0;

362 
s
->
by‹s_wr™‹n
 = 0;

363 
s
->
by‹s_»ad
 = 0;

365 
cv
[0].
de¡š©iÚ
 = 
s
->
·th_¼dtoŞ_bš
;

366 
cv
[1].
de¡š©iÚ
 = 
s
->
·th_¼d
;

368 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

370 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

371  
HANDLER_ERROR
;

374 ià(
i
 > 0 && !
	`bufãr_¡ršg_is_em±y
(
s
->
·th_¼dtoŞ_bš
)) {

377 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

380  
HANDLER_ERROR
;

385 
p
->
cÚf
.
·th_¼dtoŞ_bš
 =…->
cÚfig_¡Üage
[0]->path_rrdtool_bin;

386 
p
->
¼dtoŞ_ruÂšg
 = 0;

390 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
·th_¼dtoŞ_bš
)) {

391 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

393  
HANDLER_ERROR
;

397 ià(
	`mod_¼d_ü—‹_pe
(
¤v
, 
p
)) {

398  
HANDLER_ERROR
;

401 
p
->
¼dtoŞ_ruÂšg
 = 1;

403  
HANDLER_GO_ON
;

404 
	}
}

406 
	$TRIGGER_FUNC
(
mod_¼d_Œigg”
) {

407 
¶ugš_d©a
 *
p
 = 
p_d
;

408 
size_t
 
i
;

410 ià(!
p
->
¼dtoŞ_ruÂšg
è 
HANDLER_GO_ON
;

411 ià((
¤v
->
cur_ts
 % 60è!ğ0è 
HANDLER_GO_ON
;

413 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

414 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

415 
r
;

417 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
·th_¼d
)) ;

421 ià(
HANDLER_GO_ON
 !ğ
	`mod_¼dtoŞ_ü—‹_¼d
(
¤v
, 
p
, 
s
)è 
HANDLER_ERROR
;

423 
	`bufãr_cİy_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
("update "));

424 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
cmd
, 
s
->
·th_¼d
);

425 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
(" N:"));

426 
	`bufãr_­³nd_št
(
p
->
cmd
, 
s
->
by‹s_»ad
);

427 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
(":"));

428 
	`bufãr_­³nd_št
(
p
->
cmd
, 
s
->
by‹s_wr™‹n
);

429 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
(":"));

430 
	`bufãr_­³nd_št
(
p
->
cmd
, 
s
->
»que¡s
);

431 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
cmd
, 
	`CONST_STR_LEN
("\n"));

433 ià(-1 =ğ(
r
 = 
	`§ã_wr™e
(
p
->
wr™e_fd
, 
	`CONST_BUF_LEN
Õ->
cmd
)))) {

434 
p
->
¼dtoŞ_ruÂšg
 = 0;

436 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

437 "¼dtoŞ-wr™e: faed", 
	`¡»¼Ü
(
”ºo
));

439  
HANDLER_ERROR
;

442 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
»¥
, 4095);

443 ià(-1 =ğ(
r
 = 
	`§ã_»ad
(
p
->
»ad_fd
,…->
»¥
->
±r
,…->»¥->
size
 - 1))) {

444 
p
->
¼dtoŞ_ruÂšg
 = 0;

446 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

447 "¼dtoŞ-»ad: faed", 
	`¡»¼Ü
(
”ºo
));

449  
HANDLER_ERROR
;

452 
	`bufãr_comm™
(
p
->
»¥
, 
r
);

454 ià(
p
->
»¥
->
±r
[0] != 'O' ||

455 
p
->
»¥
->
±r
[1] != 'K') {

457 ià(!(
	`¡r¡r
(
p
->
»¥
->
±r
, "(mšimum oÃ secÚd s‹p)"è&& (
¤v
->
cur_ts
 - srv->
¡¬tup_ts
 < 3))) {

458 
p
->
¼dtoŞ_ruÂšg
 = 0;

460 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbb",

461 "¼dtoŞ-»¥Ú£:", 
p
->
cmd
,…->
»¥
);

463  
HANDLER_ERROR
;

466 
s
->
»que¡s
 = 0;

467 
s
->
by‹s_wr™‹n
 = 0;

468 
s
->
by‹s_»ad
 = 0;

471  
HANDLER_GO_ON
;

472 
	}
}

474 
	$REQUESTDONE_FUNC
(
mod_¼d_accouÁ
) {

475 
¶ugš_d©a
 *
p
 = 
p_d
;

477 
	`mod_¼d_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

479 *(
p
->
cÚf
.
»que¡s_±r
) += 1;

480 *(
p
->
cÚf
.
by‹s_wr™‹n_±r
è+ğ
cÚ
->
by‹s_wr™‹n
;

481 *(
p
->
cÚf
.
by‹s_»ad_±r
è+ğ
cÚ
->
by‹s_»ad
;

483  
HANDLER_GO_ON
;

484 
	}
}

486 
mod_¼dtoŞ_¶ugš_š™
(
¶ugš
 *
p
);

487 
	$mod_¼dtoŞ_¶ugš_š™
(
¶ugš
 *
p
) {

488 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

489 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("rrd");

491 
p
->
š™
 = 
mod_¼d_š™
;

492 
p
->
ş—nup
 = 
mod_¼d_ä“
;

493 
p
->
£t_deçuÉs
ğ
mod_¼d_£t_deçuÉs
;

495 
p
->
hªdË_Œigg”
 = 
mod_¼d_Œigg”
;

496 
p
->
hªdË_»que¡_dÚe
 = 
mod_¼d_accouÁ
;

498 
p
->
d©a
 = 
NULL
;

501 
	}
}

	@mod_scgi.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"£rv”.h
"

5 
	~"keyv®ue.h
"

6 
	~"log.h
"

8 
	~"h‰p_chunk.h
"

9 
	~"fdev’t.h
"

10 
	~"cÚÃùiÚs.h
"

11 
	~"»¥Ú£.h
"

12 
	~"jobli¡.h
"

14 
	~"¶ugš.h
"

16 
	~"š‘_Áİ_ÿche.h
"

18 
	~<sys/ty³s.h
>

19 
	~<uni¡d.h
>

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dlib.h
>

24 
	~<ùy³.h
>

25 
	~<as£¹.h
>

26 
	~<sigÇl.h
>

28 
	~<¡dio.h
>

30 
	~"sys-sock‘.h
"

31 
	~"sys-’dŸn.h
"

33 #ifdeà
HAVE_SYS_UIO_H


34 
	~<sys/uio.h
>

37 #ifdeà
HAVE_SYS_WAIT_H


38 
	~<sys/wa™.h
>

41 ’um {
	mEOL_UNSET
, 
	mEOL_N
, 
	mEOL_RN
};

52 
	sscgi_´oc
 {

53 
size_t
 
	mid
;

54 
bufãr
 *
	msock‘
;

55 
	mpÜt
;

57 
pid_t
 
	mpid
;

60 
size_t
 
	mlßd
;

62 
time_t
 
	mÏ¡_u£d
;

63 
size_t
 
	m»que¡s
;

64 
scgi_´oc
 *
	m´ev
, *
	mÃxt
;

66 
time_t
 
	mdi§bË_ts
;

68 
	mis_loÿl
;

70 ’um { 
	mPROC_STATE_UNSET
,

71 
	mPROC_STATE_RUNNING
,

72 
	mPROC_STATE_DIED_WAIT_FOR_PID
,

73 
	mPROC_STATE_KILLED
,

74 
	mPROC_STATE_DIED
,

75 
	mPROC_STATE_DISABLED


76 } 
	m¡©e
;

77 } 
	tscgi_´oc
;

87 
scgi_´oc
 *
	mfœ¡
;

88 
scgi_´oc
 *
	munu£d_´ocs
;

100 
	mmš_´ocs
;

101 
	mmax_´ocs
;

102 
size_t
 
	mnum_´ocs
;

103 
size_t
 
	maùive_´ocs
;

105 
	mmax_lßd_³r_´oc
;

115 
	midË_timeout
;

123 
	mdi§bË_time
;

131 
size_t
 
	mmax_»que¡s_³r_´oc
;

146 
bufãr
 *
	mho¡
;

147 
	mpÜt
;

148 
§_çmy_t
 
	mçmy
;

158 
bufãr
 *
	munixsock‘
;

168 
bufãr
 *
	mbš_·th
;

175 
¬¿y
 *
	mbš_’v
;

177 
¬¿y
 *
	mbš_’v_cİy
;

188 
bufãr
 *
	mdoüoÙ
;

197 
	mcheck_loÿl
;

214 
	mfix_roÙ_·th_Çme
;

221 
	mx£ndfe_®low
;

222 
¬¿y
 *
	mx£ndfe_doüoÙ
;

224 
ssize_t
 
	mlßd
;

226 
size_t
 
	mmax_id
;

232 
	mli¡’_backlog
;

233 
	m»fcouÁ
;

234 } 
	tscgi_ex‹nsiÚ_ho¡
;

256 
bufãr
 *
	mkey
;

258 
	mnÙe_is_£Á
;

259 
scgi_ex‹nsiÚ_ho¡
 **
	mho¡s
;

261 
size_t
 
	mu£d
;

262 
size_t
 
	msize
;

263 } 
	tscgi_ex‹nsiÚ
;

266 
scgi_ex‹nsiÚ
 **
	mexts
;

268 
size_t
 
	mu£d
;

269 
size_t
 
	msize
;

270 } 
	tscgi_exts
;

272 ’um { 
	mLI_PROTOCOL_SCGI
, 
	mLI_PROTOCOL_UWSGI
 };

275 
scgi_exts
 *
	mexts
;

277 
	m´Ùo
;

278 
	mdebug
;

279 } 
	t¶ugš_cÚfig
;

282 **
	m±r
;

284 
size_t
 
	msize
;

285 
size_t
 
	mu£d
;

286 } 
	tch¬_¬¿y
;

290 
	mPLUGIN_DATA
;

292 
bufãr
 *
	mscgi_’v
;

294 
bufãr
 *
	m·r£_»¥Ú£
;

296 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

298 
¶ugš_cÚfig
 
	mcÚf
;

299 } 
	t¶ugš_d©a
;

302 ’um { 
	mFCGI_STATE_INIT
, 
	mFCGI_STATE_CONNECT
, 
	mFCGI_STATE_PREPARE_WRITE
,

303 
	mFCGI_STATE_WRITE
, 
	mFCGI_STATE_READ


304 } 
	tscgi_cÚÃùiÚ_¡©e_t
;

307 
bufãr
 *
	m»¥Ú£
;

309 
scgi_´oc
 *
	m´oc
;

310 
scgi_ex‹nsiÚ_ho¡
 *
	mho¡
;

312 
scgi_cÚÃùiÚ_¡©e_t
 
	m¡©e
;

313 
time_t
 
	m¡©e_time¡amp
;

315 
chunkqueue
 *
	mwb
;

316 
off_t
 
	mwb_»qËn
;

318 
bufãr
 *
	m»¥Ú£_h—d”
;

320 
	mfd
;

321 
	mfde_ndx
;

323 
pid_t
 
	mpid
;

324 
	mgÙ_´oc
;

325 
	m»cÚÃùs
;

327 
¶ugš_cÚfig
 
	mcÚf
;

329 
cÚÃùiÚ
 *
	m»mÙe_cÚn
;

330 
¶ugš_d©a
 *
	m¶ugš_d©a
;

331 
scgi_ex‹nsiÚ
 *
	mext
;

332 } 
	thªdËr_ùx
;

336 
hªdËr_t
 
scgi_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
);

338 
scgi_´oşi¡_sÜt_down
(
£rv”
 *
¤v
, 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
, 
scgi_´oc
 *
´oc
);

340 
	$»£t_sigÇls
() {

341 #ifdeà
SIGTTOU


342 
	`sigÇl
(
SIGTTOU
, 
SIG_DFL
);

344 #ifdeà
SIGTTIN


345 
	`sigÇl
(
SIGTTIN
, 
SIG_DFL
);

347 #ifdeà
SIGTSTP


348 
	`sigÇl
(
SIGTSTP
, 
SIG_DFL
);

350 
	`sigÇl
(
SIGHUP
, 
SIG_DFL
);

351 
	`sigÇl
(
SIGPIPE
, 
SIG_DFL
);

352 
	`sigÇl
(
SIGUSR1
, 
SIG_DFL
);

353 
	}
}

355 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
() {

356 
hªdËr_ùx
 * 
hùx
;

358 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

359 
	`fÜû_as£¹
(
hùx
);

361 
hùx
->
fde_ndx
 = -1;

363 
hùx
->
»¥Ú£
 = 
	`bufãr_š™
();

364 
hùx
->
»¥Ú£_h—d”
 = 
	`bufãr_š™
();

366 
hùx
->
¡©e
 = 
FCGI_STATE_INIT
;

367 
hùx
->
´oc
 = 
NULL
;

369 
hùx
->
fd
 = -1;

371 
hùx
->
»cÚÃùs
 = 0;

373 
hùx
->
wb
 = 
	`chunkqueue_š™
();

374 
hùx
->
wb_»qËn
 = 0;

376  
hùx
;

377 
	}
}

379 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

380 
	`bufãr_ä“
(
hùx
->
»¥Ú£
);

381 
	`bufãr_ä“
(
hùx
->
»¥Ú£_h—d”
);

383 
	`chunkqueue_ä“
(
hùx
->
wb
);

385 
	`ä“
(
hùx
);

386 
	}
}

388 
scgi_´oc
 *
	$scgi_´oûss_š™
() {

389 
scgi_´oc
 *
f
;

391 
f
 = 
	`ÿÎoc
(1, (*f));

392 
	`fÜû_as£¹
(
f
);

393 
f
->
sock‘
 = 
	`bufãr_š™
();

395 
f
->
´ev
 = 
NULL
;

396 
f
->
Ãxt
 = 
NULL
;

398  
f
;

399 
	}
}

401 
	$scgi_´oûss_ä“
(
scgi_´oc
 *
f
) {

402 ià(!
f
) ;

404 
	`scgi_´oûss_ä“
(
f
->
Ãxt
);

406 
	`bufãr_ä“
(
f
->
sock‘
);

408 
	`ä“
(
f
);

409 
	}
}

411 
scgi_ex‹nsiÚ_ho¡
 *
	$scgi_ho¡_š™
() {

412 
scgi_ex‹nsiÚ_ho¡
 *
f
;

414 
f
 = 
	`ÿÎoc
(1, (*f));

416 
f
->
ho¡
 = 
	`bufãr_š™
();

417 
f
->
unixsock‘
 = 
	`bufãr_š™
();

418 
f
->
doüoÙ
 = 
	`bufãr_š™
();

419 
f
->
bš_·th
 = 
	`bufãr_š™
();

420 
f
->
bš_’v
 = 
	`¬¿y_š™
();

421 
f
->
bš_’v_cİy
 = 
	`¬¿y_š™
();

422 
f
->
x£ndfe_doüoÙ
 = 
	`¬¿y_š™
();

424  
f
;

425 
	}
}

427 
	$scgi_ho¡_ä“
(
scgi_ex‹nsiÚ_ho¡
 *
h
) {

428 ià(!
h
) ;

429 ià(
h
->
»fcouÁ
) {

430 --
h
->
»fcouÁ
;

434 
	`bufãr_ä“
(
h
->
ho¡
);

435 
	`bufãr_ä“
(
h
->
unixsock‘
);

436 
	`bufãr_ä“
(
h
->
doüoÙ
);

437 
	`bufãr_ä“
(
h
->
bš_·th
);

438 
	`¬¿y_ä“
(
h
->
bš_’v
);

439 
	`¬¿y_ä“
(
h
->
bš_’v_cİy
);

440 
	`¬¿y_ä“
(
h
->
x£ndfe_doüoÙ
);

442 
	`scgi_´oûss_ä“
(
h
->
fœ¡
);

443 
	`scgi_´oûss_ä“
(
h
->
unu£d_´ocs
);

445 
	`ä“
(
h
);

447 
	}
}

449 
scgi_exts
 *
	$scgi_ex‹nsiÚs_š™
() {

450 
scgi_exts
 *
f
;

452 
f
 = 
	`ÿÎoc
(1, (*f));

453 
	`fÜû_as£¹
(
f
);

455  
f
;

456 
	}
}

458 
	$scgi_ex‹nsiÚs_ä“
(
scgi_exts
 *
f
) {

459 
size_t
 
i
;

461 ià(!
f
) ;

463 
i
 = 0; i < 
f
->
u£d
; i++) {

464 
scgi_ex‹nsiÚ
 *
ã
;

465 
size_t
 
j
;

467 
ã
 = 
f
->
exts
[
i
];

469 
j
 = 0; j < 
ã
->
u£d
; j++) {

470 
scgi_ex‹nsiÚ_ho¡
 *
h
;

472 
h
 = 
ã
->
ho¡s
[
j
];

474 
	`scgi_ho¡_ä“
(
h
);

477 
	`bufãr_ä“
(
ã
->
key
);

478 
	`ä“
(
ã
->
ho¡s
);

480 
	`ä“
(
ã
);

483 
	`ä“
(
f
->
exts
);

485 
	`ä“
(
f
);

486 
	}
}

488 
	$scgi_ex‹nsiÚ_š£¹
(
scgi_exts
 *
ext
, 
bufãr
 *
key
, 
scgi_ex‹nsiÚ_ho¡
 *
fh
) {

489 
scgi_ex‹nsiÚ
 *
ã
;

490 
size_t
 
i
;

494 
i
 = 0; i < 
ext
->
u£d
; i++) {

495 ià(
	`bufãr_is_equ®
(
key
, 
ext
->
exts
[
i
]->key)) {

500 ià(
i
 =ğ
ext
->
u£d
) {

502 
ã
 = 
	`ÿÎoc
(1, (*fe));

503 
	`fÜû_as£¹
(
ã
);

504 
ã
->
key
 = 
	`bufãr_š™
();

505 
	`bufãr_cİy_bufãr
(
ã
->
key
, key);

509 ià(
ext
->
size
 == 0) {

510 
ext
->
size
 = 8;

511 
ext
->
exts
 = 
	`m®loc
Óxt->
size
 * (*(ext->exts)));

512 
	`fÜû_as£¹
(
ext
->
exts
);

513 } ià(
ext
->
u£d
 =ğext->
size
) {

514 
ext
->
size
 += 8;

515 
ext
->
exts
 = 
	`»®loc
Óxt->exts,ƒxt->
size
 * (*(ext->exts)));

516 
	`fÜû_as£¹
(
ext
->
exts
);

518 
ext
->
exts
[ext->
u£d
++] = 
ã
;

520 
ã
 = 
ext
->
exts
[
i
];

523 ià(
ã
->
size
 == 0) {

524 
ã
->
size
 = 4;

525 
ã
->
ho¡s
 = 
	`m®loc
(ã->
size
 * (*(fe->hosts)));

526 
	`fÜû_as£¹
(
ã
->
ho¡s
);

527 } ià(
ã
->
size
 =ğã->
u£d
) {

528 
ã
->
size
 += 4;

529 
ã
->
ho¡s
 = 
	`»®loc
(ã->ho¡s, fe->
size
 * (*(fe->hosts)));

530 
	`fÜû_as£¹
(
ã
->
ho¡s
);

533 
ã
->
ho¡s
[ã->
u£d
++] = 
fh
;

537 
	}
}

539 
	$INIT_FUNC
(
mod_scgi_š™
) {

540 
¶ugš_d©a
 *
p
;

542 
p
 = 
	`ÿÎoc
(1, (*p));

543 
	`fÜû_as£¹
(
p
);

545 
p
->
scgi_’v
 = 
	`bufãr_š™
();

547 
p
->
·r£_»¥Ú£
 = 
	`bufãr_š™
();

549  
p
;

550 
	}
}

553 
	$FREE_FUNC
(
mod_scgi_ä“
) {

554 
¶ugš_d©a
 *
p
 = 
p_d
;

556 
	`UNUSED
(
¤v
);

558 
	`bufãr_ä“
(
p
->
scgi_’v
);

559 
	`bufãr_ä“
(
p
->
·r£_»¥Ú£
);

561 ià(
p
->
cÚfig_¡Üage
) {

562 
size_t
 
i
, 
j
, 
n
;

563 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

564 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

565 
scgi_exts
 *
exts
;

567 ià(
NULL
 =ğ
s
) ;

569 
exts
 = 
s
->exts;

571 
j
 = 0; j < 
exts
->
u£d
; j++) {

572 
scgi_ex‹nsiÚ
 *
ex
;

574 
ex
 = 
exts
->exts[
j
];

576 
n
 = 0;‚ < 
ex
->
u£d
;‚++) {

577 
scgi_´oc
 *
´oc
;

578 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
;

580 
ho¡
 = 
ex
->
ho¡s
[
n
];

582 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

583 ià(
´oc
->
pid
 !ğ0è
	`kl
Õroc->pid, 
SIGTERM
);

585 ià(
´oc
->
is_loÿl
 &&

586 !
	`bufãr_¡ršg_is_em±y
(
´oc
->
sock‘
)) {

587 
	`uÆšk
(
´oc
->
sock‘
->
±r
);

591 
´oc
 = 
ho¡
->
unu£d_´ocs
;…roc;…roøğ´oc->
Ãxt
) {

592 ià(
´oc
->
pid
 !ğ0è
	`kl
Õroc->pid, 
SIGTERM
);

594 ià(
´oc
->
is_loÿl
 &&

595 !
	`bufãr_¡ršg_is_em±y
(
´oc
->
sock‘
)) {

596 
	`uÆšk
(
´oc
->
sock‘
->
±r
);

602 
	`scgi_ex‹nsiÚs_ä“
(
s
->
exts
);

604 
	`ä“
(
s
);

606 
	`ä“
(
p
->
cÚfig_¡Üage
);

609 
	`ä“
(
p
);

611  
HANDLER_GO_ON
;

612 
	}
}

614 
	$’v_add
(
ch¬_¬¿y
 *
’v
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

615 *
d¡
;

616 
size_t
 
i
;

618 ià(!
key
 || !
v®
)  -1;

620 
d¡
 = 
	`m®loc
(
key_Ën
 + 
v®_Ën
 + 3);

621 
	`fÜû_as£¹
(
d¡
);

622 
	`memıy
(
d¡
, 
key
, 
key_Ën
);

623 
d¡
[
key_Ën
] = '=';

625 
	`memıy
(
d¡
 + 
key_Ën
 + 1, 
v®
, 
v®_Ën
 + 1);

627 
i
 = 0; i < 
’v
->
u£d
; i++) {

628 ià(0 =ğ
	`¡ºcmp
(
d¡
, 
’v
->
±r
[
i
], 
key_Ën
 + 1)) {

631 
’v
->
±r
[
i
] = 
d¡
;

636 ià(
’v
->
size
 == 0) {

637 
’v
->
size
 = 16;

638 
’v
->
±r
 = 
	`m®loc
Ónv->
size
 * (*env->ptr));

639 
	`fÜû_as£¹
(
’v
->
±r
);

640 } ià(
’v
->
size
 =ğ’v->
u£d
) {

641 
’v
->
size
 += 16;

642 
’v
->
±r
 = 
	`»®loc
Ónv->±r,ƒnv->
size
 * (*env->ptr));

643 
	`fÜû_as£¹
(
’v
->
±r
);

646 
’v
->
±r
[’v->
u£d
++] = 
d¡
;

649 
	}
}

651 #ià!
defšed
(
HAVE_FORK
)

652 
	$scgi_¥awn_cÚÃùiÚ
(
£rv”
 *
¤v
,

653 
¶ugš_d©a
 *
p
,

654 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
,

655 
scgi_´oc
 *
´oc
) {

656 
	`UNUSED
(
¤v
);

657 
	`UNUSED
(
p
);

658 
	`UNUSED
(
ho¡
);

659 
	`UNUSED
(
´oc
);

661 
	}
}

665 
	$scgi_¥awn_cÚÃùiÚ
(
£rv”
 *
¤v
,

666 
¶ugš_d©a
 *
p
,

667 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
,

668 
scgi_´oc
 *
´oc
) {

669 
scgi_fd
;

670 
¡©us
;

671 
timev®
 
tv
 = { 0, 100 * 1000 };

672 #ifdeà
HAVE_SYS_UN_H


673 
sockaddr_un
 
scgi_addr_un
;

675 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

676 
sockaddr_š6
 
scgi_addr_š6
;

678 
sockaddr_š
 
scgi_addr_š
;

679 
sockaddr
 *
scgi_addr
;

681 
sockËn_t
 
£rvËn
;

683 ià(
p
->
cÚf
.
debug
) {

684 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

685 "Ãw…roc, sock‘:", 
´oc
->
pÜt
,…roc->
sock‘
);

689 ià(!
	`bufãr_¡ršg_is_em±y
(
´oc
->
sock‘
)) {

690 #ifdeà
HAVE_SYS_UN_H


691 
	`mem£t
(&
scgi_addr_un
, 0, (scgi_addr_un));

692 
scgi_addr_un
.
sun_çmy
 = 
AF_UNIX
;

693 ià(
	`bufãr_¡ršg_Ëngth
(
´oc
->
sock‘
è+ 1 > (
scgi_addr_un
.
sun_·th
)) {

694 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sB",

696 
´oc
->
sock‘
);

699 
	`memıy
(
scgi_addr_un
.
sun_·th
, 
´oc
->
sock‘
->
±r
, 
	`bufãr_¡ršg_Ëngth
(proc->socket) + 1);

701 #ifdeà
SUN_LEN


702 
£rvËn
 = 
	`SUN_LEN
(&
scgi_addr_un
);

705 
£rvËn
 = 
	`bufãr_¡ršg_Ëngth
(
´oc
->
sock‘
è+ 1 + (
scgi_addr_un
.
sun_çmy
);

707 
scgi_addr
 = (
sockaddr
 *è&
scgi_addr_un
;

709 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

713 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

714 } ià(
ho¡
->
çmy
 =ğ
AF_INET6
 && !
	`bufãr_¡ršg_is_em±y
(host->host)) {

715 
	`mem£t
(&
scgi_addr_š6
, 0, (scgi_addr_in6));

716 
scgi_addr_š6
.
sš6_çmy
 = 
AF_INET6
;

717 
	`š‘_±Ú
(
AF_INET6
, 
ho¡
->ho¡->
±r
, (*è&
scgi_addr_š6
.
sš6_addr
);

718 
scgi_addr_š6
.
sš6_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

719 
£rvËn
 = (
scgi_addr_š6
);

720 
scgi_addr
 = (
sockaddr
 *è&
scgi_addr_š6
;

723 
	`mem£t
(&
scgi_addr_š
, 0, (scgi_addr_in));

724 
scgi_addr_š
.
sš_çmy
 = 
AF_INET
;

726 ià(
	`bufãr_¡ršg_is_em±y
(
ho¡
->host)) {

727 
scgi_addr_š
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

729 
ho¡’t
 *
he
;

732 
scgi_addr_š
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

735 ià(
NULL
 =ğ(
he
 = 
	`g‘ho¡byÇme
(
ho¡
->ho¡->
±r
))) {

736 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

738 
h_”ºo
, 
ho¡
->host);

742 ià(
he
->
h_add¹y³
 !ğ
AF_INET
) {

743 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "addr-ty³ !ğAF_INET: ", 
he
->
h_add¹y³
);

747 ià(
he
->
h_Ëngth
 !ğ(
š_addr
)) {

748 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "addr-Ëngth !ğsizeof(š_addr): ", 
he
->
h_Ëngth
);

752 
	`memıy
(&(
scgi_addr_š
.
sš_addr
.
s_addr
), 
he
->
h_addr_li¡
[0], he->
h_Ëngth
);

755 
scgi_addr_š
.
sš_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

756 
£rvËn
 = (
scgi_addr_š
);

758 
scgi_addr
 = (
sockaddr
 *è&
scgi_addr_š
;

761 ià(-1 =ğ(
scgi_fd
 = 
	`fdev’t_sock‘_şÛxec
(
scgi_addr
->
§_çmy
, 
SOCK_STREAM
, 0))) {

762 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

763 "çed:", 
	`¡»¼Ü
(
”ºo
));

767 ià(-1 =ğ
	`cÚÃù
(
scgi_fd
, 
scgi_addr
, 
£rvËn
)) {

769 
pid_t
 
chd
;

770 
v®
;

772 ià(!
	`bufãr_¡ršg_is_em±y
(
´oc
->
sock‘
)) {

773 
	`uÆšk
(
´oc
->
sock‘
->
±r
);

776 
	`şo£
(
scgi_fd
);

779 ià(-1 =ğ(
scgi_fd
 = 
	`fdev’t_sock‘_şÛxec
(
scgi_addr
->
§_çmy
, 
SOCK_STREAM
, 0))) {

780 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

781 "sock‘ faed:", 
	`¡»¼Ü
(
”ºo
));

785 
v®
 = 1;

786 ià(
	`£tsockİt
(
scgi_fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
v®
, (val)) < 0) {

787 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

788 "sock‘sockİˆçed:", 
	`¡»¼Ü
(
”ºo
));

789 
	`şo£
(
scgi_fd
);

794 ià(-1 =ğ
	`bšd
(
scgi_fd
, 
scgi_addr
, 
£rvËn
)) {

795 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbds",

797 
´oc
->
sock‘
,

798 
´oc
->
pÜt
,

799 
	`¡»¼Ü
(
”ºo
));

800 
	`şo£
(
scgi_fd
);

804 ià(-1 =ğ
	`li¡’
(
scgi_fd
, 
ho¡
->
li¡’_backlog
)) {

805 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

806 "li¡’ faed:", 
	`¡»¼Ü
(
”ºo
));

807 
	`şo£
(
scgi_fd
);

811 (
chd
 = 
	`fÜk
())) {

813 
bufãr
 *
b
;

814 
size_t
 
i
 = 0;

815 
fd
 = 0;

816 
ch¬_¬¿y
 
’v
;

820 
’v
.
±r
 = 
NULL
;

821 
’v
.
size
 = 0;

822 
’v
.
u£d
 = 0;

824 ià(
scgi_fd
 != 0) {

825 
	`dup2
(
scgi_fd
, 0);

826 
	`şo£
(
scgi_fd
);

828 #ifdeà
SOCK_CLOEXEC


830 ()
	`fú
(
scgi_fd
, 
F_SETFD
, 0);

834 
fd
 = 3; fd < 256; fd++) {

835 
	`şo£
(
fd
);

839 ià(
ho¡
->
bš_’v_cİy
->
u£d
) {

840 
i
 = 0; i < 
ho¡
->
bš_’v_cİy
->
u£d
; i++) {

841 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
ho¡
->
bš_’v_cİy
->
d©a
[
i
];

842 *
ge
;

844 ià(
NULL
 !ğ(
ge
 = 
	`g‘’v
(
ds
->
v®ue
->
±r
))) {

845 
	`’v_add
(&
’v
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
), 
ge
, 
	`¡¾’
(ge));

849 ** cÚ¡ 
e
 = 
’vœÚ
;

850 
i
 = 0; 
e
[i]; ++i) {

851 *
eq
;

853 ià(
NULL
 !ğ(
eq
 = 
	`¡rchr
(
e
[
i
], '='))) {

854 
	`’v_add
(&
’v
, 
e
[
i
], 
eq
 -ƒ[i],ƒq+1, 
	`¡¾’
(eq+1));

860 
i
 = 0; i < 
ho¡
->
bš_’v
->
u£d
; i++) {

861 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
ho¡
->
bš_’v
->
d©a
[
i
];

863 
	`’v_add
(&
’v
, 
	`CONST_BUF_LEN
(
ds
->
key
), CONST_BUF_LEN(ds->
v®ue
));

866 
i
 = 0; i < 
’v
.
u£d
; i++) {

868 ià(0 =ğ
	`¡ºcmp
(
’v
.
±r
[
i
], "PHP_FCGI_CHILDREN=", ("PHP_FCGI_CHILDREN=") - 1)) ;

872 ià(
i
 =ğ
’v
.
u£d
) {

873 
	`’v_add
(&
’v
, 
	`CONST_STR_LEN
("PHP_FCGI_CHILDREN"), CONST_STR_LEN("1"));

876 
’v
.
±r
[’v.
u£d
] = 
NULL
;

878 
b
 = 
	`bufãr_š™
();

879 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("exec "));

880 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ho¡
->
bš_·th
);

882 
	`»£t_sigÇls
();

885 
	`exeşe
("/bš/sh", "sh", "-c", 
b
->
±r
, (*)
NULL
, 
’v
.ptr);

887 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

888 "exeş faed fÜ:", 
ho¡
->
bš_·th
, 
	`¡»¼Ü
(
”ºo
));

890 
	`_ex™
(
”ºo
);

896 
	`şo£
(
scgi_fd
);

900 
	`şo£
(
scgi_fd
);

903 
	`£Ëù
(0, 
NULL
, NULL, NULL, &
tv
);

905 
	`wa™pid
(
chd
, &
¡©us
, 
WNOHANG
)) {

911 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

912 "pid‚Ù found:", 
	`¡»¼Ü
(
”ºo
));

916 ià(
	`WIFEXITED
(
¡©us
)) {

917 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

919 
	`WEXITSTATUS
(
¡©us
));

920 } ià(
	`WIFSIGNALED
(
¡©us
)) {

921 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

923 
	`WTERMSIG
(
¡©us
));

925 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

927 
¡©us
);

933 
´oc
->
pid
 = 
chd
;

934 
´oc
->
Ï¡_u£d
 = 
¤v
->
cur_ts
;

935 
´oc
->
is_loÿl
 = 1;

940 
	`şo£
(
scgi_fd
);

942 
´oc
->
is_loÿl
 = 0;

943 
´oc
->
pid
 = 0;

945 ià(
p
->
cÚf
.
debug
) {

946 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

948 
´oc
->
sock‘
);

952 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

953 
ho¡
->
aùive_´ocs
++;

956 
	}
}

960 
scgi_ex‹nsiÚ_ho¡
 * 
	$unixsock‘_is_dup
(
¶ugš_d©a
 *
p
, 
size_t
 
u£d
, 
bufãr
 *
unixsock‘
) {

961 
size_t
 
i
, 
j
, 
n
;

962 
i
 = 0; i < 
u£d
; ++i) {

963 
scgi_exts
 *
exts
 = 
p
->
cÚfig_¡Üage
[
i
]->exts;

964 
j
 = 0; j < 
exts
->
u£d
; ++j) {

965 
scgi_ex‹nsiÚ
 *
ex
 = 
exts
->exts[
j
];

966 
n
 = 0;‚ < 
ex
->
u£d
; ++n) {

967 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
ex
->
ho¡s
[
n
];

968 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)

969 && 
	`bufãr_is_equ®
(
ho¡
->
unixsock‘
, unixsocket)

970 && !
	`bufãr_¡ršg_is_em±y
(
ho¡
->
bš_·th
))

971  
ho¡
;

976  
NULL
;

977 
	}
}

979 
	$SETDEFAULTS_FUNC
(
mod_scgi_£t_deçuÉs
) {

980 
¶ugš_d©a
 *
p
 = 
p_d
;

981 
d©a_un£t
 *
du
;

982 
size_t
 
i
 = 0;

983 
scgi_ex‹nsiÚ_ho¡
 *
df
 = 
NULL
;

985 
cÚfig_v®ues_t
 
cv
[] = {

986 { "scgi.£rv”", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

987 { "scgi.debug", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

988 { "scgi.´ÙocŞ", 
NULL
, 
T_CONFIG_LOCAL
, 
T_CONFIG_SCOPE_CONNECTION
 },

989 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

992 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

993 
	`fÜû_as£¹
(
p
->
cÚfig_¡Üage
);

995 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

996 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

997 
¶ugš_cÚfig
 *
s
;

999 
s
 = 
	`m®loc
((
¶ugš_cÚfig
));

1000 
	`fÜû_as£¹
(
s
);

1001 
s
->
exts
 = 
	`scgi_ex‹nsiÚs_š™
();

1002 
s
->
debug
 = 0;

1003 
s
->
´Ùo
 = 
LI_PROTOCOL_SCGI
;

1005 
cv
[0].
de¡š©iÚ
 = 
s
->
exts
;

1006 
cv
[1].
de¡š©iÚ
 = &(
s
->
debug
);

1007 
cv
[2].
de¡š©iÚ
 = 
NULL
;

1009 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

1011 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

1012 
”rÜ
;

1019 ià(
NULL
 !ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "scgi.protocol"))) {

1020 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
du
;

1021 ià(
du
->
ty³
 =ğ
TYPE_STRING


1022 && 
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("scgi"))) {

1023 
s
->
´Ùo
 = 
LI_PROTOCOL_SCGI
;

1024 } ià(
du
->
ty³
 =ğ
TYPE_STRING


1025 && 
	`bufãr_is_equ®_¡ršg
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("uwsgi"))) {

1026 
s
->
´Ùo
 = 
LI_PROTOCOL_UWSGI
;

1028 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

1031 
”rÜ
;

1035 ià(
NULL
 !ğ(
du
 = 
	`¬¿y_g‘_–em’t
(
cÚfig
->
v®ue
, "scgi.server"))) {

1036 
size_t
 
j
;

1037 
d©a_¬¿y
 *
da
 = (d©a_¬¿y *)
du
;

1039 ià(
du
->
ty³
 !ğ
TYPE_ARRAY
) {

1040 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

1043 
”rÜ
;

1052 
j
 = 0; j < 
da
->
v®ue
->
u£d
; j++) {

1053 
size_t
 
n
;

1054 
d©a_¬¿y
 *
da_ext
 = (d©a_¬¿y *)
da
->
v®ue
->
d©a
[
j
];

1056 ià(
da
->
v®ue
->
d©a
[
j
]->
ty³
 !ğ
TYPE_ARRAY
) {

1057 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssbs",

1059 "[", 
da
->
v®ue
->
d©a
[
j
]->
key
, "](string);ƒxpected ( \"ext\" => ( \"backend-label\" => ( \"key\" => \"value\" )))");

1061 
”rÜ
;

1076 
n
 = 0;‚ < 
da_ext
->
v®ue
->
u£d
;‚++) {

1077 
d©a_¬¿y
 *
da_ho¡
 = (d©a_¬¿y *)
da_ext
->
v®ue
->
d©a
[
n
];

1079 
cÚfig_v®ues_t
 
fcv
[] = {

1080 { "ho¡", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1081 { "doüoÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1082 { "sock‘", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1083 { "bš-·th", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

1085 { "check-loÿl", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1086 { "pÜt", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1087 { "mš-´ocs-nÙ-wÜkšg", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1088 { "max-´ocs", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1089 { "max-lßd-³r-´oc", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1090 { "idË-timeout", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1091 { "di§bË-time", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1093 { "bš-’vœÚm’t", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1094 { "bš-cİy-’vœÚm’t", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1095 { "fix-roÙ-süŠame", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1096 { "li¡’-backlog", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

1097 { "x-£ndfe", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

1098 { "x-£ndfe-doüoÙ",
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

1101 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

1104 ià(
da_ho¡
->
ty³
 !ğ
TYPE_ARRAY
) {

1105 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssSBS",

1108 "[", 
da_ho¡
->
key
, "](string);ƒxpected ( \"ext\" => ( \"backend-label\" => ( \"key\" => \"value\" )))");

1110 
”rÜ
;

1113 
df
 = 
	`scgi_ho¡_š™
();

1115 
df
->
check_loÿl
 = 1;

1116 
df
->
mš_´ocs
 = 4;

1117 
df
->
max_´ocs
 = 4;

1118 
df
->
max_lßd_³r_´oc
 = 1;

1119 
df
->
idË_timeout
 = 60;

1120 
df
->
di§bË_time
 = 60;

1121 
df
->
fix_roÙ_·th_Çme
 = 0;

1122 
df
->
li¡’_backlog
 = 1024;

1123 
df
->
x£ndfe_®low
 = 0;

1124 
df
->
»fcouÁ
 = 0;

1126 
fcv
[0].
de¡š©iÚ
 = 
df
->
ho¡
;

1127 
fcv
[1].
de¡š©iÚ
 = 
df
->
doüoÙ
;

1128 
fcv
[2].
de¡š©iÚ
 = 
df
->
unixsock‘
;

1129 
fcv
[3].
de¡š©iÚ
 = 
df
->
bš_·th
;

1131 
fcv
[4].
de¡š©iÚ
 = &(
df
->
check_loÿl
);

1132 
fcv
[5].
de¡š©iÚ
 = &(
df
->
pÜt
);

1133 
fcv
[6].
de¡š©iÚ
 = &(
df
->
mš_´ocs
);

1134 
fcv
[7].
de¡š©iÚ
 = &(
df
->
max_´ocs
);

1135 
fcv
[8].
de¡š©iÚ
 = &(
df
->
max_lßd_³r_´oc
);

1136 
fcv
[9].
de¡š©iÚ
 = &(
df
->
idË_timeout
);

1137 
fcv
[10].
de¡š©iÚ
 = &(
df
->
di§bË_time
);

1139 
fcv
[11].
de¡š©iÚ
 = 
df
->
bš_’v
;

1140 
fcv
[12].
de¡š©iÚ
 = 
df
->
bš_’v_cİy
;

1141 
fcv
[13].
de¡š©iÚ
 = &(
df
->
fix_roÙ_·th_Çme
);

1142 
fcv
[14].
de¡š©iÚ
 = &(
df
->
li¡’_backlog
);

1143 
fcv
[15].
de¡š©iÚ
 = &(
df
->
x£ndfe_®low
);

1144 
fcv
[16].
de¡š©iÚ
 = 
df
->
x£ndfe_doüoÙ
;

1147 ià(0 !ğ
	`cÚfig_š£¹_v®ues_š‹º®
(
¤v
, 
da_ho¡
->
v®ue
, 
fcv
, 
T_CONFIG_SCOPE_CONNECTION
)) {

1148 
”rÜ
;

1151 ià((!
	`bufãr_¡ršg_is_em±y
(
df
->
ho¡
è|| df->
pÜt
) &&

1152 !
	`bufãr_¡ršg_is_em±y
(
df
->
unixsock‘
)) {

1153 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1156 
”rÜ
;

1159 ià(!
	`bufãr_¡ršg_is_em±y
(
df
->
unixsock‘
)) {

1161 
sockaddr_un
 
un
;

1163 ià(
	`bufãr_¡ršg_Ëngth
(
df
->
unixsock‘
è+ 1 > (
un
.
sun_·th
) - 2) {

1164 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1166 
”rÜ
;

1169 ià(!
	`bufãr_¡ršg_is_em±y
(
df
->
bš_·th
)) {

1170 
scgi_ex‹nsiÚ_ho¡
 *
du¶iÿ‹
 = 
	`unixsock‘_is_dup
(
p
, 
i
+1, 
df
->
unixsock‘
);

1171 ià(
NULL
 !ğ
du¶iÿ‹
) {

1172 ià(!
	`bufãr_is_equ®
(
df
->
bš_·th
, 
du¶iÿ‹
->bin_path)) {

1173 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1175 
df
->
unixsock‘
);

1176 
”rÜ
;

1178 
	`scgi_ho¡_ä“
(
df
);

1179 
df
 = 
du¶iÿ‹
;

1180 ++
df
->
»fcouÁ
;

1184 
df
->
çmy
 = 
AF_UNIX
;

1188 ià(
	`bufãr_¡ršg_is_em±y
(
df
->
ho¡
) &&

1189 
	`bufãr_¡ršg_is_em±y
(
df
->
bš_·th
)) {

1190 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbbbs",

1192 
da
->
key
,

1193 
da_ext
->
key
,

1194 
da_ho¡
->
key
,

1197 
”rÜ
;

1198 } ià(
df
->
pÜt
 == 0) {

1199 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbbbs",

1201 
da
->
key
,

1202 
da_ext
->
key
,

1203 
da_ho¡
->
key
,

1205 
”rÜ
;

1208 
df
->
çmy
 = (!
	`bufãr_¡ršg_is_em±y
(df->
ho¡
è&& 
NULL
 !ğ
	`¡rchr
(df->ho¡->
±r
, ':')è? 
AF_INET6
 : 
AF_INET
;

1211 ià(
df
->
»fcouÁ
) {

1213 } ià(!
	`bufãr_¡ršg_is_em±y
(
df
->
bš_·th
)) {

1215 
size_t
 
²o
;

1217 
¡©
 
¡
;

1218 
size_t
 
nch¬s
 = 
	`¡rc¥n
(
df
->
bš_·th
->
±r
, " \t");

1219 
c
 = 
df
->
bš_·th
->
±r
[
nch¬s
];

1220 
df
->
bš_·th
->
±r
[
nch¬s
] = '\0';

1221 ià(0 =ğ
nch¬s
 || 0 !ğ
	`¡©
(
df
->
bš_·th
->
±r
, &
¡
è|| !
	`S_ISREG
(¡.
¡_mode
è|| !(¡.¡_mod& (
S_IXUSR
 | 
S_IXGRP
 | 
S_IXOTH
))) {

1222 
df
->
bš_·th
->
±r
[
nch¬s
] = 
c
;

1223 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSs",

1224 "šv®id \"bš-·th\" => \"", 
df
->
bš_·th
->
±r
,

1227 
df
->
bš_·th
->
±r
[
nch¬s
] = 
c
;

1230 
df
->
mš_´ocs
 = df->
max_´ocs
;

1232 ià(
df
->
mš_´ocs
 > df->
max_´ocs
) df->max_procs = df->min_procs;

1233 ià(
df
->
max_lßd_³r_´oc
 < 1) df->max_load_per_proc = 0;

1235 ià(
s
->
debug
) {

1236 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsdsbsdsd",

1238 "\n\roc:", 
df
->
bš_·th
,

1239 "\n\Üt:", 
df
->
pÜt
,

1240 "\n\tsock‘", 
df
->
unixsock‘
,

1241 "\n\tmš-´ocs:", 
df
->
mš_´ocs
,

1242 "\n\tmax-´ocs:", 
df
->
max_´ocs
);

1245 
²o
 = 0;…nØ< 
df
->
mš_´ocs
;…no++) {

1246 
scgi_´oc
 *
´oc
;

1248 
´oc
 = 
	`scgi_´oûss_š™
();

1249 
´oc
->
id
 = 
df
->
num_´ocs
++;

1250 
df
->
max_id
++;

1252 ià(
	`bufãr_¡ršg_is_em±y
(
df
->
unixsock‘
)) {

1253 
´oc
->
pÜt
 = 
df
->pÜˆ+ 
²o
;

1255 
	`bufãr_cİy_bufãr
(
´oc
->
sock‘
, 
df
->
unixsock‘
);

1256 
	`bufãr_­³nd_¡ršg_Ën
(
´oc
->
sock‘
, 
	`CONST_STR_LEN
("-"));

1257 
	`bufãr_­³nd_št
(
´oc
->
sock‘
, 
²o
);

1260 ià(
s
->
debug
) {

1261 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsbsdsd",

1263 "\n\Üt:", 
df
->
pÜt
,

1264 "\n\tsock‘", 
df
->
unixsock‘
,

1265 "\n\tcu¼’t:", 
²o
, "/", 
df
->
mš_´ocs
);

1268 ià(!
¤v
->
¤vcÚf
.
´eæight_check


1269 && 
	`scgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
df
, 
´oc
)) {

1270 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1272 
	`scgi_´oûss_ä“
(
´oc
);

1273 
”rÜ
;

1276 
´oc
->
Ãxt
 = 
df
->
fœ¡
;

1277 ià(
df
->
fœ¡
èdf->fœ¡->
´ev
 = 
´oc
;

1279 
df
->
fœ¡
 = 
´oc
;

1282 
scgi_´oc
 *
å
;

1284 
å
 = 
	`scgi_´oûss_š™
();

1285 
å
->
id
 = 
df
->
num_´ocs
++;

1286 
df
->
max_id
++;

1287 
df
->
aùive_´ocs
++;

1288 
å
->
¡©e
 = 
PROC_STATE_RUNNING
;

1290 ià(
	`bufãr_¡ršg_is_em±y
(
df
->
unixsock‘
)) {

1291 
å
->
pÜt
 = 
df
->port;

1293 
	`bufãr_cİy_bufãr
(
å
->
sock‘
, 
df
->
unixsock‘
);

1296 
df
->
fœ¡
 = 
å
;

1298 
df
->
mš_´ocs
 = 1;

1299 
df
->
max_´ocs
 = 1;

1302 ià(
df
->
x£ndfe_doüoÙ
->
u£d
) {

1303 
size_t
 
k
;

1304 
k
 = 0; k < 
df
->
x£ndfe_doüoÙ
->
u£d
; ++k) {

1305 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
df
->
x£ndfe_doüoÙ
->
d©a
[
k
];

1306 ià(
ds
->
ty³
 !ğ
TYPE_STRING
) {

1307 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1309 
”rÜ
;

1311 ià(
ds
->
v®ue
->
±r
[0] != '/') {

1312 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBs",

1313 "x-£ndfe-doüoÙ…©h mu¡ begš w™h '/'; inv®id: \"", 
ds
->
v®ue
, "\"");

1314 
”rÜ
;

1316 
	`bufãr_·th_sim¶ify
(
ds
->
v®ue
, ds->value);

1317 
	`bufãr_­³nd_¦ash
(
ds
->
v®ue
);

1322 
	`scgi_ex‹nsiÚ_š£¹
(
s
->
exts
, 
da_ext
->
key
, 
df
);

1323 
df
 = 
NULL
;

1329  
HANDLER_GO_ON
;

1331 
”rÜ
:

1332 ià(
NULL
 !ğ
df
è
	`scgi_ho¡_ä“
(df);

1333  
HANDLER_ERROR
;

1334 
	}
}

1336 
	$scgi_£t_¡©e
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
, 
scgi_cÚÃùiÚ_¡©e_t
 
¡©e
) {

1337 
hùx
->
¡©e
 = state;

1338 
hùx
->
¡©e_time¡amp
 = 
¤v
->
cur_ts
;

1341 
	}
}

1344 
	$scgi_back’d_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1345 ià(
hùx
->
fd
 != -1) {

1346 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
);

1347 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
hùx
->
fd
);

1348 
	`fdev’t_sched_şo£
(
¤v
->
ev
, 
hùx
->
fd
, 1);

1349 
hùx
->
fd
 = -1;

1350 
hùx
->
fde_ndx
 = -1;

1353 ià(
hùx
->
ho¡
) {

1354 ià(
hùx
->
´oc
) {

1356 ià(
hùx
->
gÙ_´oc
èhùx->
´oc
->
lßd
--;

1357 
	`scgi_´oşi¡_sÜt_down
(
¤v
, 
hùx
->
ho¡
, hùx->
´oc
);

1359 ià(
hùx
->
cÚf
.
debug
) {

1360 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddb",

1362 
hùx
->
fd
,

1363 
hùx
->
´oc
->
pid
, hùx->´oc->
sock‘
);

1367 
hùx
->
ho¡
->
lßd
--;

1368 
hùx
->
ho¡
 = 
NULL
;

1370 
	}
}

1372 
scgi_ex‹nsiÚ_ho¡
 * 
	$scgi_ex‹nsiÚ_ho¡_g‘
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
scgi_ex‹nsiÚ
 *
ex‹nsiÚ
) {

1373 
u£d
 = -1;

1374 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
NULL
;

1375 
	`UNUSED
(
p
);

1378 
size_t
 
k
 = 0; k < 
ex‹nsiÚ
->
u£d
; ++k) {

1379 
scgi_ex‹nsiÚ_ho¡
 *
h
 = 
ex‹nsiÚ
->
ho¡s
[
k
];

1382 ià(
h
->
aùive_´ocs
 == 0) {

1386 ià(
u£d
 =ğ-1 || 
h
->
lßd
 < used) {

1387 
u£d
 = 
h
->
lßd
;

1389 
ho¡
 = 
h
;

1393 ià(!
ho¡
) {

1395 
cÚ
->
h‰p_¡©us
 = 503;

1396 
cÚ
->
mode
 = 
DIRECT
;

1399 ià(!
ex‹nsiÚ
->
nÙe_is_£Á
) {

1400 
ex‹nsiÚ
->
nÙe_is_£Á
 = 1;

1402 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbs",

1403 "®ÈhªdËr fÜ ", 
cÚ
->
uri
.
·th
,

1404 "Ú", 
ex‹nsiÚ
->
key
,

1409  
ho¡
;

1410 
	}
}

1412 
	$scgi_cÚÃùiÚ_şo£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1413 
¶ugš_d©a
 *
p
;

1414 
cÚÃùiÚ
 *
cÚ
;

1416 
p
 = 
hùx
->
¶ugš_d©a
;

1417 
cÚ
 = 
hùx
->
»mÙe_cÚn
;

1419 
	`scgi_back’d_şo£
(
¤v
, 
hùx
);

1420 
	`hªdËr_ùx_ä“
(
hùx
);

1421 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

1424 ià(
cÚ
->
mode
 =ğ
p
->
id
) {

1425 
	`h‰p_»¥Ú£_back’d_dÚe
(
¤v
, 
cÚ
);

1427 
	}
}

1429 
hªdËr_t
 
	$scgi_»cÚÃù
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1430 
	`scgi_back’d_şo£
(
¤v
, 
hùx
);

1432 
hùx
->
ho¡
 = 
	`scgi_ex‹nsiÚ_ho¡_g‘
(
¤v
, hùx->
»mÙe_cÚn
, hùx->
¶ugš_d©a
, hùx->
ext
);

1433 ià(
NULL
 =ğ
hùx
->
ho¡
è 
HANDLER_FINISHED
;

1435 
hùx
->
ho¡
->
lßd
++;

1436 
	`scgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_INIT
);

1437  
HANDLER_COMEBACK
;

1438 
	}
}

1441 
hªdËr_t
 
	$scgi_cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

1442 
¶ugš_d©a
 *
p
 = 
p_d
;

1443 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1444 ià(
hùx
è
	`scgi_cÚÃùiÚ_şo£
(
¤v
, hctx);

1446  
HANDLER_GO_ON
;

1447 
	}
}

1450 
	$scgi_’v_add_scgi
(*
v’v
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

1451 
bufãr
 *
’v
 = 
v’v
;

1452 
size_t
 
Ën
;

1454 ià(!
key
 || !
v®
)  -1;

1456 
Ën
 = 
key_Ën
 + 
v®_Ën
 + 2;

1458 
	`bufãr_¡ršg_´•¬e_­³nd
(
’v
, 
Ën
);

1460 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
key
, 
key_Ën
);

1461 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, "", 1);

1462 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
v®
, 
v®_Ën
);

1463 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, "", 1);

1466 
	}
}

1469 #ifdeà
__LITTLE_ENDIAN__


1470 
	#uwsgi_htŞe16
(
x
è(x)

	)

1472 
	#uwsgi_htŞe16
(
x
è((
ušt16_t
è(((xè& 0xffè<< 8 | ((xè& 0xff00è>> 8))

	)

1476 
	$scgi_’v_add_uwsgi
(*
v’v
, cÚ¡ *
key
, 
size_t
 
key_Ën
, cÚ¡ *
v®
, size_ˆ
v®_Ën
) {

1477 
bufãr
 *
’v
 = 
v’v
;

1478 
size_t
 
Ën
;

1479 
ušt16_t
 
uwËn
;

1481 ià(!
key
 || !
v®
)  -1;

1482 ià(
key_Ën
 > 
USHRT_MAX
 || 
v®_Ën
 > USHRT_MAX)  -1;

1484 
Ën
 = 2 + 
key_Ën
 + 2 + 
v®_Ën
;

1486 
	`bufãr_¡ršg_´•¬e_­³nd
(
’v
, 
Ën
);

1488 
uwËn
 = 
	`uwsgi_htŞe16
((
ušt16_t
)
key_Ën
);

1489 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, (*)&
uwËn
, 2);

1490 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
key
, 
key_Ën
);

1491 
uwËn
 = 
	`uwsgi_htŞe16
((
ušt16_t
)
v®_Ën
);

1492 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, (*)&
uwËn
, 2);

1493 
	`bufãr_­³nd_¡ršg_Ën
(
’v
, 
v®
, 
v®_Ën
);

1496 
	}
}

1507 
	$scgi_e¡ablish_cÚÃùiÚ
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1508 
sockaddr
 *
scgi_addr
;

1509 
sockaddr_š
 
scgi_addr_š
;

1510 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

1511 
sockaddr_š6
 
scgi_addr_š6
;

1513 #ifdeà
HAVE_SYS_UN_H


1514 
sockaddr_un
 
scgi_addr_un
;

1516 
sockËn_t
 
£rvËn
;

1518 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
hùx
->host;

1519 
scgi_´oc
 *
´oc
 = 
hùx
->proc;

1520 
scgi_fd
 = 
hùx
->
fd
;

1522 ià(!
	`bufãr_¡ršg_is_em±y
(
´oc
->
sock‘
)) {

1523 #ifdeà
HAVE_SYS_UN_H


1525 
	`mem£t
(&
scgi_addr_un
, 0, (scgi_addr_un));

1526 
scgi_addr_un
.
sun_çmy
 = 
AF_UNIX
;

1527 ià(
	`bufãr_¡ršg_Ëngth
(
´oc
->
sock‘
è+ 1 > (
scgi_addr_un
.
sun_·th
)) {

1528 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sB",

1530 
´oc
->
sock‘
);

1533 
	`memıy
(
scgi_addr_un
.
sun_·th
, 
´oc
->
sock‘
->
±r
, 
	`bufãr_¡ršg_Ëngth
(proc->socket) + 1);

1535 #ifdeà
SUN_LEN


1536 
£rvËn
 = 
	`SUN_LEN
(&
scgi_addr_un
);

1539 
£rvËn
 = 
	`bufãr_¡ršg_Ëngth
(
´oc
->
sock‘
è+ 1 + (
scgi_addr_un
.
sun_çmy
);

1541 
scgi_addr
 = (
sockaddr
 *è&
scgi_addr_un
;

1545 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

1546 } ià(
ho¡
->
çmy
 =ğ
AF_INET6
 && !
	`bufãr_¡ršg_is_em±y
(host->host)) {

1547 
	`mem£t
(&
scgi_addr_š6
, 0, (scgi_addr_in6));

1548 
scgi_addr_š6
.
sš6_çmy
 = 
AF_INET6
;

1549 
	`š‘_±Ú
(
AF_INET6
, 
ho¡
->ho¡->
±r
, (*è&
scgi_addr_š6
.
sš6_addr
);

1550 
scgi_addr_š6
.
sš6_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

1551 
£rvËn
 = (
scgi_addr_š6
);

1552 
scgi_addr
 = (
sockaddr
 *è&
scgi_addr_š6
;

1555 
	`mem£t
(&
scgi_addr_š
, 0, (scgi_addr_in));

1556 
scgi_addr_š
.
sš_çmy
 = 
AF_INET
;

1557 ià(0 =ğ
	`š‘_©Ú
(
ho¡
->ho¡->
±r
, &(
scgi_addr_š
.
sš_addr
))) {

1558 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1559 "cÚv”tšg IP-ad»s çed fÜ", 
ho¡
->host,

1564 
scgi_addr_š
.
sš_pÜt
 = 
	`htÚs
(
´oc
->
pÜt
);

1565 
£rvËn
 = (
scgi_addr_š
);

1567 
scgi_addr
 = (
sockaddr
 *è&
scgi_addr_š
;

1570 ià(-1 =ğ
	`cÚÃù
(
scgi_fd
, 
scgi_addr
, 
£rvËn
)) {

1571 ià(
”ºo
 =ğ
EINPROGRESS
 ||

1572 
”ºo
 =ğ
EALREADY
 ||

1573 
”ºo
 =ğ
EINTR
) {

1574 ià(
hùx
->
cÚf
.
debug
) {

1575 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1576 "cÚÃù d–ayed, wÈcÚtšuÏ‹r:", 
scgi_fd
);

1581 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsddb",

1582 "cÚÃù faed:", 
scgi_fd
,

1583 
	`¡»¼Ü
(
”ºo
),ƒrrno,

1584 
´oc
->
pÜt
,…roc->
sock‘
);

1586 ià(
”ºo
 =ğ
EAGAIN
) {

1589 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1597 ià(
hùx
->
cÚf
.
debug
 > 1) {

1598 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1599 "cÚÃù sucûeded: ", 
scgi_fd
);

1605 
	}
}

1608 
	$scgi_ü—‹_’v
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1609 
bufãr
 *
b
;

1611 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

1612 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

1614 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

1616 
h‰p_cgi_İts
 
İts
 = { 0, 0, 
ho¡
->
doüoÙ
, 
NULL
 };

1618 
h‰p_cgi_h—d”_­³nd_cb
 
scgi_’v_add
 = 
hùx
->
cÚf
.
´Ùo
 =ğ
LI_PROTOCOL_SCGI


1619 ? 
scgi_’v_add_scgi


1620 : 
scgi_’v_add_uwsgi
;

1622 
	`bufãr_¡ršg_´•¬e_cİy
(
p
->
scgi_’v
, 1023);

1624 ià(0 !ğ
	`h‰p_cgi_h—d”s
(
¤v
, 
cÚ
, &
İts
, 
scgi_’v_add
, 
p
->
scgi_’v
)) {

1625 
cÚ
->
h‰p_¡©us
 = 400;

1629 ià(
hùx
->
cÚf
.
´Ùo
 =ğ
LI_PROTOCOL_SCGI
) {

1630 
	`scgi_’v_add
(
p
->
scgi_’v
, 
	`CONST_STR_LEN
("SCGI"), CONST_STR_LEN("1"));

1631 
b
 = 
	`bufãr_š™
();

1632 
	`bufãr_­³nd_št
(
b
, 
	`bufãr_¡ršg_Ëngth
(
p
->
scgi_’v
));

1633 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(":"));

1634 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
p
->
scgi_’v
);

1635 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(","));

1638 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
p
->
scgi_’v
);

1639 
ušt32_t
 
uwsgi_h—d”
;

1640 ià(
Ën
 > 
USHRT_MAX
) {

1641 
cÚ
->
h‰p_¡©us
 = 431;

1642 
cÚ
->
mode
 = 
DIRECT
;

1645 
b
 = 
	`bufãr_š™
();

1646 
	`bufãr_¡ršg_´•¬e_cİy
(
b
, 4 + 
Ën
);

1647 
uwsgi_h—d”
 = ((
ušt32_t
)
	`uwsgi_htŞe16
((
ušt16_t
)
Ën
)) << 8;

1648 
	`memıy
(
b
->
±r
, (*)&
uwsgi_h—d”
, 4);

1649 
	`bufãr_comm™
(
b
, 4);

1650 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
p
->
scgi_’v
);

1653 
hùx
->
wb_»qËn
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

1654 
	`chunkqueue_­³nd_bufãr
(
hùx
->
wb
, 
b
);

1655 
	`bufãr_ä“
(
b
);

1657 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1658 
	`chunkqueue_­³nd_chunkqueue
(
hùx
->
wb
, 
cÚ
->
»que¡_cÚ‹Á_queue
);

1659 
hùx
->
wb_»qËn
 +ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
;

1663 
	}
}

1665 
	$scgi_»¥Ú£_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
š
, 
eŞ
) {

1666 *
ns
;

1667 cÚ¡ *
s
;

1668 
lše
 = 0;

1670 
	`UNUSED
(
¤v
);

1672 
	`bufãr_cİy_bufãr
(
p
->
·r£_»¥Ú£
, 
š
);

1674 
s
 = 
p
->
·r£_»¥Ú£
->
±r
;

1675 
NULL
 !ğ(
ns
 = (
eŞ
 =ğ
EOL_RN
 ? 
	`¡r¡r
(
s
, "\r\n"è: 
	`¡rchr
(s, '\n')));

1676 
s
 = 
ns
 + (
eŞ
 =ğ
EOL_RN
 ? 2 : 1), 
lše
++) {

1677 cÚ¡ *
key
, *
v®ue
;

1678 
key_Ën
;

1679 
d©a_¡ršg
 *
ds
;

1681 
ns
[0] = '\0';

1683 ià(
lše
 == 0 &&

1684 0 =ğ
	`¡ºcmp
(
s
, "HTTP/1.", 7)) {

1687 ià((
s
[7] == '1' ||

1688 
s
[7] == '0') &&

1689 
s
[8] == ' ') {

1690 
¡©us
;

1693 
¡©us
 = 
	`¡¹Ş
(
s
+9, 
NULL
, 10);

1695 ià(
¡©us
 >= 100 && status < 1000) {

1697 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_STATUS
;

1698 
cÚ
->
h‰p_¡©us
 = 
¡©us
;

1703 
key
 = 
s
;

1704 ià(
NULL
 =ğ(
v®ue
 = 
	`¡rchr
(
s
, ':'))) {

1709 
key_Ën
 = 
v®ue
 - 
key
;

1710 
v®ue
 += 1;

1713 *
v®ue
 == ' ' || *value == '\t') value++;

1715 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

1716 
ds
 = 
	`d©a_»¥Ú£_š™
();

1718 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
key_Ën
);

1719 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, value);

1721 
	`¬¿y_š£¹_unique
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1723 
key_Ën
) {

1725 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "D©e", 
key_Ën
)) {

1726 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_DATE
;

1730 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "Stus", 
key_Ën
)) {

1731 
¡©us
 = 
	`¡¹Ş
(
v®ue
, 
NULL
, 10);

1732 ià(
¡©us
 >= 100 && status < 1000) {

1733 
cÚ
->
h‰p_¡©us
 = 
¡©us
;

1734 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_STATUS
;

1736 
cÚ
->
h‰p_¡©us
 = 502;

1741 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "LoÿtiÚ", 
key_Ën
)) {

1742 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_LOCATION
;

1746 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚÃùiÚ", 
key_Ën
)) {

1747 
cÚ
->
»¥Ú£
.
k“p_®ive
 = (0 =ğ
	`¡rÿ£cmp
(
v®ue
, "Keep-Alive")) ? 1 : 0;

1748 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONNECTION
;

1752 ià(0 =ğ
	`¡ºÿ£cmp
(
key
, "CÚ‹Á-L’gth", 
key_Ën
)) {

1753 
cÚ
->
»¥Ú£
.
cÚ‹Á_Ëngth
 = 
	`¡¹oul
(
v®ue
, 
NULL
, 10);

1754 
cÚ
->
·r£d_»¥Ú£
 |ğ
HTTP_CONTENT_LENGTH
;

1764 ià((
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_LOCATION
) &&

1765 !(
cÚ
->
·r£d_»¥Ú£
 & 
HTTP_STATUS
)) {

1766 
cÚ
->
h‰p_¡©us
 = 302;

1770 
	}
}

1773 
	$scgi_demux_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

1774 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

1775 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

1778 
n
;

1780 
	`bufãr_¡ršg_´•¬e_cİy
(
hùx
->
»¥Ú£
, 1023);

1781 ià(-1 =ğ(
n
 = 
	`»ad
(
hùx
->
fd
, hùx->
»¥Ú£
->
±r
, hùx->»¥Ú£->
size
 - 1))) {

1782 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
) {

1784 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

1788 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd", 
	`¡»¼Ü
(
”ºo
), 
cÚ
->
fd
, 
hùx
->fd);

1792 ià(
n
 == 0) {

1797 
	`bufãr_comm™
(
hùx
->
»¥Ú£
, 
n
);

1801 ià(
cÚ
->
fe_¡¬‹d
 == 0) {

1802 *
c
;

1803 
š_h—d”
 = 0;

1804 
h—d”_’d
 = 0;

1805 
ı
, 
eŞ
 = 
EOL_UNSET
;

1806 
size_t
 
u£d
 = 0;

1807 
size_t
 
hËn
 = 0;

1809 
	`bufãr_­³nd_¡ršg_bufãr
(
hùx
->
»¥Ú£_h—d”
, hùx->
»¥Ú£
);

1812 ià(0 =ğ
	`¡ºcmp
(
hùx
->
»¥Ú£_h—d”
->
±r
, "HTTP/1.", 7)è
š_h—d”
 = 1;

1815 
c
 = 
hùx
->
»¥Ú£_h—d”
->
±r
, 
ı
 = 0, 
u£d
 = 
	`bufãr_¡ršg_Ëngth
(hctx->response_header); used; c++, cp++, used--) {

1816 ià(*
c
 =ğ':'è
š_h—d”
 = 1;

1817 ià(*
c
 == '\n') {

1818 ià(
š_h—d”
 == 0) {

1821 
c
 = 
NULL
;

1822 
h—d”_’d
 = 1;

1826 ià(
eŞ
 =ğ
EOL_UNSET
èeŞ = 
EOL_N
;

1828 ià(*(
c
+1) == '\n') {

1829 
h—d”_’d
 = 1;

1830 
hËn
 = 
ı
 + 2;

1834 } ià(
u£d
 > 1 && *
c
 == '\r' && *(c+1) == '\n') {

1835 ià(
š_h—d”
 == 0) {

1838 
c
 = 
NULL
;

1839 
h—d”_’d
 = 1;

1843 ià(
eŞ
 =ğ
EOL_UNSET
èeŞ = 
EOL_RN
;

1845 ià(
u£d
 > 3 &&

1846 *(
c
+2) == '\r' &&

1847 *(
c
+3) == '\n') {

1848 
h—d”_’d
 = 1;

1849 
hËn
 = 
ı
 + 4;

1854 
c
++;

1855 
ı
++;

1856 
u£d
--;

1860 ià(
h—d”_’d
) {

1861 ià(
c
 =ğ
NULL
) {

1863 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£_h—d”
)) {

1869 
size_t
 
bËn
 = 
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£_h—d”
è- 
hËn
;

1872 
	`bufãr_¡ršg_£t_Ëngth
(
hùx
->
»¥Ú£_h—d”
, 
hËn
 - 1);

1875 
	`scgi_»¥Ú£_·r£
(
¤v
, 
cÚ
, 
p
, 
hùx
->
»¥Ú£_h—d”
, 
eŞ
);

1877 ià(
hùx
->
ho¡
->
x£ndfe_®low
) {

1878 
d©a_¡ršg
 *
ds
;

1879 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *è
	`¬¿y_g‘_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, "X-Sendfile"))) {

1880 
	`h‰p_»¥Ú£_x£ndfe
(
¤v
, 
cÚ
, 
ds
->
v®ue
, 
hùx
->
ho¡
->
x£ndfe_doüoÙ
);

1885 ià(
bËn
 > 0) {

1886 ià(0 !ğ
	`h‰p_chunk_­³nd_mem
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£_h—d”
->
±r
 + 
hËn
, 
bËn
)) {

1894 
cÚ
->
fe_¡¬‹d
 = 1;

1897 ià(
	`bufãr_¡ršg_Ëngth
(
hùx
->
»¥Ú£_h—d”
è> 
MAX_HTTP_REQUEST_HEADER
) {

1898 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "»¥Ú£ h—d” toØÏrgfÜ", 
cÚ
->
uri
.
·th
);

1899 
cÚ
->
h‰p_¡©us
 = 502;

1900 
cÚ
->
mode
 = 
DIRECT
;

1905 ià(0 !ğ
	`h‰p_chunk_­³nd_bufãr
(
¤v
, 
cÚ
, 
hùx
->
»¥Ú£
)) {

1910 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

1911 && 
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

1912 ià(!
cÚ
->
is_wr™abË
) {

1918 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

1925 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ddss", 
cÚ
->
fd
, 
hùx
->fd, 
	`cÚÃùiÚ_g‘_¡©e
(cÚ->
¡©e
), 
b
->
±r
);

1930 
	}
}

1933 
	$scgi_´oşi¡_sÜt_up
(
£rv”
 *
¤v
, 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
, 
scgi_´oc
 *
´oc
) {

1934 
scgi_´oc
 *
p
;

1936 
	`UNUSED
(
¤v
);

1950 ià(
ho¡
->
fœ¡
 =ğ
´oc
 &&…roc->
Ãxt
 =ğ
NULL
)  0;

1952 
p
 = 
´oc
;…->
Ãxt
 &&…->Ãxt->
lßd
 <…roc->load;… =…->next);

1962 ià(
p
 =ğ
´oc
)  0;

1964 ià(
ho¡
->
fœ¡
 =ğ
´oc
) {

1967 
ho¡
->
fœ¡
 = 
´oc
->
Ãxt
;

1968 
ho¡
->
fœ¡
->
´ev
 = 
NULL
;

1973 ià(
´oc
->
´ev
è´oc->´ev->
Ãxt
 =…roc->next;

1974 ià(
´oc
->
Ãxt
è´oc->Ãxt->
´ev
 =…roc->prev;

1978 
´oc
->
Ãxt
 = 
p
->next;

1979 
´oc
->
´ev
 = 
p
;

1980 ià(
p
->
Ãxt
èp->Ãxt->
´ev
 = 
´oc
;

1981 
p
->
Ãxt
 = 
´oc
;

1983 
p
 = 
ho¡
->
fœ¡
;…;… =…->
Ãxt
) {

1984 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "dd",

1985 
p
->
pid
,…->
lßd
);

1988 
	`UNUSED
(
¤v
);

1992 
	}
}

1994 
	$scgi_´oşi¡_sÜt_down
(
£rv”
 *
¤v
, 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
, 
scgi_´oc
 *
´oc
) {

1995 
scgi_´oc
 *
p
;

1997 
	`UNUSED
(
¤v
);

2024 ià(
ho¡
->
fœ¡
 =ğ
´oc
 &&…roc->
Ãxt
 =ğ
NULL
)  0;

2026 
p
 = 
ho¡
->
fœ¡
;… !ğ
´oc
 &&…->
lßd
 <…roc->lßd;… =…->
Ãxt
);

2037 ià(
p
 =ğ
´oc
)  0;

2041 ià(
ho¡
->
fœ¡
 =ğ
´oc
)  0;

2044 ià(
´oc
->
´ev
è´oc->´ev->
Ãxt
 =…roc->next;

2045 ià(
´oc
->
Ãxt
è´oc->Ãxt->
´ev
 =…roc->prev;

2048 
´oc
->
Ãxt
 = 
p
;

2049 
´oc
->
´ev
 = 
p
->prev;

2050 ià(
p
->
´ev
èp->´ev->
Ãxt
 = 
´oc
;

2051 
p
->
´ev
 = 
´oc
;

2053 ià(
´oc
->
´ev
 =ğ
NULL
è
ho¡
->
fœ¡
 =…roc;

2055 
p
 = 
ho¡
->
fœ¡
;…;… =…->
Ãxt
) {

2056 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "dd",

2057 
p
->
pid
,…->
lßd
);

2060 
	`UNUSED
(
¤v
);

2064 
	}
}

2066 
	$scgi_»¡¬t_d—d_´ocs
(
£rv”
 *
¤v
, 
¶ugš_d©a
 *
p
, 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
) {

2067 
scgi_´oc
 *
´oc
;

2069 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

2070 ià(
p
->
cÚf
.
debug
) {

2071 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdbdddd",

2073 
ho¡
->ho¡, 
´oc
->
pÜt
,

2074 
´oc
->
sock‘
,

2075 
´oc
->
¡©e
,

2076 
´oc
->
is_loÿl
,

2077 
´oc
->
lßd
,

2078 
´oc
->
pid
);

2081 ià(0 =ğ
´oc
->
is_loÿl
) {

2088 ià((
´oc
->
¡©e
 =ğ
PROC_STATE_DISABLED
) &&

2089 (
¤v
->
cur_ts
 - 
´oc
->
di§bË_ts
 > 
ho¡
->
di§bË_time
)) {

2090 
´oc
->
¡©e
 = 
PROC_STATE_RUNNING
;

2091 
ho¡
->
aùive_´ocs
++;

2093 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdb",

2095 
ho¡
->ho¡, ho¡->
pÜt
,

2096 
ho¡
->
unixsock‘
);

2100 
¡©us
;

2102 ià(
´oc
->
¡©e
 =ğ
PROC_STATE_DIED_WAIT_FOR_PID
) {

2103 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

2110 ià(
	`WIFEXITED
(
¡©us
)) {

2112 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

2113 "chdƒx™ed,…id:", 
´oc
->
pid
,

2114 "¡©us:", 
	`WEXITSTATUS
(
¡©us
));

2116 } ià(
	`WIFSIGNALED
(
¡©us
)) {

2117 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2119 
	`WTERMSIG
(
¡©us
));

2121 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2123 
¡©us
);

2126 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

2135 ià(
´oc
->
¡©e
 =ğ
PROC_STATE_DIED
 &&

2136 
´oc
->
lßd
 == 0) {

2139 ià(
p
->
cÚf
.
debug
) {

2140 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsbsdsd",

2142 "\n\Üt:", 
ho¡
->
pÜt
,

2143 "\n\tsock‘", 
ho¡
->
unixsock‘
,

2144 "\n\tcu¼’t:", 1, "/", 
ho¡
->
mš_´ocs
);

2147 ià(
	`scgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
ho¡
, 
´oc
)) {

2148 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

2150  
HANDLER_ERROR
;

2153 
	`scgi_´oşi¡_sÜt_down
(
¤v
, 
ho¡
, 
´oc
);

2159 
	}
}

2162 
hªdËr_t
 
	$scgi_wr™e_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

2163 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

2164 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2166 
»t
;

2168 
hùx
->
¡©e
) {

2169 
FCGI_STATE_INIT
:

2170 ià(-1 =ğ(
hùx
->
fd
 = 
	`fdev’t_sock‘_nb_şÛxec
(
ho¡
->
çmy
, 
SOCK_STREAM
, 0))) {

2171 ià(
”ºo
 =ğ
EMFILE
 ||

2172 
”ºo
 =ğ
EINTR
) {

2173 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2174 "wa™ fÜ fd‡ˆcÚÃùiÚ:", 
cÚ
->
fd
);

2176  
HANDLER_WAIT_FOR_FD
;

2179 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdd",

2180 "sock‘ faed:", 
	`¡»¼Ü
(
”ºo
), 
¤v
->
cur_fds
, srv->
max_fds
);

2181  
HANDLER_ERROR
;

2183 
hùx
->
fde_ndx
 = -1;

2185 
¤v
->
cur_fds
++;

2187 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
hùx
->
fd
, 
scgi_hªdË_fdev’t
, hctx);

2189 ià(-1 =ğ
	`fdev’t_fú_£t
(
¤v
->
ev
, 
hùx
->
fd
)) {

2190 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2191 "fú faed: ", 
	`¡»¼Ü
(
”ºo
));

2192  
HANDLER_ERROR
;

2196 
FCGI_STATE_CONNECT
:

2197 ià(
hùx
->
¡©e
 =ğ
FCGI_STATE_INIT
) {

2198 
hùx
->
´oc
 = hùx->
ho¡
->
fœ¡
;

2199 
hùx
->
´oc
 && hùx->´oc->
¡©e
 !ğ
PROC_STATE_RUNNING
;

2200 
hùx
->
´oc
 = hùx->´oc->
Ãxt
);

2203 ià(
hùx
->
´oc
 =ğ
NULL
) {

2204 
hùx
->
fde_ndx
 = -1;

2206  
HANDLER_ERROR
;

2209 ià(
hùx
->
´oc
->
is_loÿl
) {

2210 
hùx
->
pid
 = hùx->
´oc
->pid;

2213 
	`scgi_e¡ablish_cÚÃùiÚ
(
¤v
, 
hùx
)) {

2215 
	`scgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_CONNECT
);

2219 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2221  
HANDLER_WAIT_FOR_EVENT
;

2224 
hùx
->
fde_ndx
 = -1;

2226  
HANDLER_ERROR
;

2234 
sock‘_”rÜ
;

2235 
sockËn_t
 
sock‘_”rÜ_Ën
 = (
sock‘_”rÜ
);

2238 ià(0 !ğ
	`g‘sockİt
(
hùx
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
sock‘_”rÜ
, &
sock‘_”rÜ_Ën
)) {

2239 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2240 "g‘sockİˆçed:", 
	`¡»¼Ü
(
”ºo
));

2242  
HANDLER_ERROR
;

2244 ià(
sock‘_”rÜ
 != 0) {

2245 ià(!
hùx
->
´oc
->
is_loÿl
 || hùx->
cÚf
.
debug
) {

2248 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2249 "e¡ablishšg cÚÃùiÚ faed:", 
	`¡»¼Ü
(
sock‘_”rÜ
),

2250 "pÜt:", 
hùx
->
´oc
->
pÜt
);

2253  
HANDLER_ERROR
;

2259 
hùx
->
´oc
->
lßd
++;

2260 
hùx
->
´oc
->
Ï¡_u£d
 = 
¤v
->
cur_ts
;

2261 
hùx
->
gÙ_´oc
 = 1;

2263 ià(
hùx
->
cÚf
.
debug
) {

2264 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddbdd",

2266 
hùx
->
fd
,

2267 
hùx
->
´oc
->
pid
,

2268 
hùx
->
´oc
->
sock‘
,

2269 
hùx
->
´oc
->
pÜt
,

2270 
hùx
->
´oc
->
lßd
);

2274 
	`scgi_´oşi¡_sÜt_up
(
¤v
, 
hùx
->
ho¡
, hùx->
´oc
);

2276 
	`scgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_PREPARE_WRITE
);

2278 
FCGI_STATE_PREPARE_WRITE
:

2279 ià(0 !ğ
	`scgi_ü—‹_’v
(
¤v
, 
hùx
)) {

2280  
HANDLER_FINISHED
;

2283 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

2284 
	`scgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_WRITE
);

2287 
FCGI_STATE_WRITE
:

2288 
»t
 = 
¤v
->
	`ÃtwÜk_back’d_wr™e
(¤v, 
cÚ
, 
hùx
->
fd
, hùx->
wb
, 
MAX_WRITE_LIMIT
);

2290 
	`chunkqueue_»move_fšished_chunks
(
hùx
->
wb
);

2292 ià(
»t
 < 0) {

2293 ià(
”ºo
 =ğ
ENOTCONN
 || 
»t
 == -2) {

2300 ià(
hùx
->
wb
->
by‹s_out
 == 0 &&

2301 
hùx
->
»cÚÃùs
++ < 5) {

2302 
	`u¦“p
(10000);

2306  
	`scgi_»cÚÃù
(
¤v
, 
hùx
);

2315 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssosd",

2317 "wr™e-off£t:", 
hùx
->
wb
->
by‹s_out
,

2318 "»cÚÃù‡‰em±s:", 
hùx
->
»cÚÃùs
);

2320  
HANDLER_ERROR
;

2323 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

2324 "wr™çed:", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

2326  
HANDLER_ERROR
;

2330 ià(
hùx
->
wb
->
by‹s_out
 =ğhùx->
wb_»qËn
) {

2331 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2332 
	`scgi_£t_¡©e
(
¤v
, 
hùx
, 
FCGI_STATE_READ
);

2334 
off_t
 
wbËn
 = 
hùx
->
wb
->
by‹s_š
 - hùx->wb->
by‹s_out
;

2335 ià(
hùx
->
wb
->
by‹s_š
 < hùx->
wb_»qËn
 && 
wbËn
 < 65536 - 16384) {

2337 ià(!(
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_POLLIN
)) {

2338 
cÚ
->
cÚf
.
¡»am_»que¡_body
 |ğ
FDEVENT_STREAM_REQUEST_POLLIN
;

2339 
cÚ
->
is_»adabË
 = 1;

2342 ià(0 =ğ
wbËn
) {

2343 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2345 
	`fdev’t_ev’t_add
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_OUT
);

2349  
HANDLER_WAIT_FOR_EVENT
;

2350 
FCGI_STATE_READ
:

2352  
HANDLER_WAIT_FOR_EVENT
;

2354 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "(debug) unknown state");

2355  
HANDLER_ERROR
;

2357 
	}
}

2359 
hªdËr_t
 
	$scgi_£nd_»que¡
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

2361 
hªdËr_t
 
rc
 = 
	`scgi_wr™e_»que¡
(
¤v
, 
hùx
);

2362 ià(
HANDLER_ERROR
 !ğ
rc
) {

2363  
rc
;

2365 
scgi_´oc
 *
´oc
 = 
hùx
->proc;

2366 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
hùx
->host;

2367 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

2368 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2370 ià(
´oc
 &&

2371 0 =ğ
´oc
->
is_loÿl
 &&

2372 
´oc
->
¡©e
 !ğ
PROC_STATE_DISABLED
) {

2375 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdb", "fcgi-server disabled:",

2376 
ho¡
->host,

2377 
´oc
->
pÜt
,

2378 
´oc
->
sock‘
);

2381 
´oc
->
di§bË_ts
 = 
¤v
->
cur_ts
;

2382 
´oc
->
¡©e
 = 
PROC_STATE_DISABLED
;

2383 
ho¡
->
aùive_´ocs
--;

2386 ià(
hùx
->
¡©e
 =ğ
FCGI_STATE_INIT
 ||

2387 
hùx
->
¡©e
 =ğ
FCGI_STATE_CONNECT
) {

2391 ià(
´oc
 &&…roc->
is_loÿl
) {

2393 ià(
hùx
->
cÚf
.
debug
) {

2394 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbdb", "connect()o scgi failed,„estartinghe„equest-handling:",

2395 
ho¡
->host,

2396 
´oc
->
pÜt
,

2397 
´oc
->
sock‘
);

2410 ià(
´oc
->
¡©e
 =ğ
PROC_STATE_RUNNING
 &&

2411 
hùx
->
pid
 =ğ
´oc
->pid) {

2412 
´oc
->
¡©e
 = 
PROC_STATE_DIED_WAIT_FOR_PID
;

2415 
	`scgi_»¡¬t_d—d_´ocs
(
¤v
, 
p
, 
ho¡
);

2417  
	`scgi_»cÚÃù
(
¤v
, 
hùx
);

2419 
	`scgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2420 
cÚ
->
h‰p_¡©us
 = 503;

2422  
HANDLER_FINISHED
;

2425 
	}
}

2428 
hªdËr_t
 
scgi_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
);

2431 
	$SUBREQUEST_FUNC
(
mod_scgi_hªdË_sub»que¡
) {

2432 
¶ugš_d©a
 *
p
 = 
p_d
;

2434 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

2436 ià(
NULL
 =ğ
hùx
è 
HANDLER_GO_ON
;

2439 ià(
cÚ
->
mode
 !ğ
p
->
id
è 
HANDLER_GO_ON
;

2441 ià((
cÚ
->
cÚf
.
¡»am_»¥Ú£_body
 & 
FDEVENT_STREAM_RESPONSE_BUFMIN
)

2442 && 
cÚ
->
fe_¡¬‹d
) {

2443 ià(
	`chunkqueue_Ëngth
(
cÚ
->
wr™e_queue
) > 65536 - 4096) {

2444 
	`fdev’t_ev’t_şr
(
¤v
->
ev
, &(
hùx
->
fde_ndx
), hùx->
fd
, 
FDEVENT_IN
);

2445 } ià(!(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_IN
)) {

2447 
hªdËr_t
 
rc
 = 
	`scgi_»cv_»¥Ú£
(
¤v
, 
hùx
);

2448 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

2452 ià(0 =ğ
hùx
->
wb
->
by‹s_š


2453 ? 
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST


2454 : 
hùx
->
wb
->
by‹s_š
 < hùx->
wb_»qËn
) {

2457 ià(
hùx
->
wb
->
by‹s_š
 - hùx->wb->
by‹s_out
 > 65536 - 4096

2458 && (
cÚ
->
cÚf
.
¡»am_»que¡_body
 & 
FDEVENT_STREAM_REQUEST_BUFMIN
)){

2459 
cÚ
->
cÚf
.
¡»am_»que¡_body
 &ğ~
FDEVENT_STREAM_REQUEST_POLLIN
;

2460 ià(0 !ğ
hùx
->
wb
->
by‹s_š
è 
HANDLER_WAIT_FOR_EVENT
;

2462 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

2463 
chunkqueue
 *
»q_cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

2464 ià(0 !ğ
hùx
->
wb
->
by‹s_š
 && !
	`chunkqueue_is_em±y
(
»q_cq
)) {

2465 
	`chunkqueue_­³nd_chunkqueue
(
hùx
->
wb
, 
»q_cq
);

2466 ià(
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
hùx
->
fd
è& 
FDEVENT_OUT
) {

2467  (
r
 =ğ
HANDLER_GO_ON
è? 
HANDLER_WAIT_FOR_EVENT
 :„;

2470 ià(
r
 !ğ
HANDLER_GO_ON
) „;

2476 ià(-1 =ğ
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

2477  
	`cÚÃùiÚ_hªdË_»ad_po¡_”rÜ
(
¤v
, 
cÚ
, 411);

2482  ((0 =ğ
hùx
->
wb
->
by‹s_š
 || !
	`chunkqueue_is_em±y
(hctx->wb))

2483 && 
hùx
->
¡©e
 !ğ
FCGI_STATE_CONNECT
)

2484 ? 
	`scgi_£nd_»que¡
(
¤v
, 
hùx
)

2485 : 
HANDLER_WAIT_FOR_EVENT
;

2486 
	}
}

2489 
hªdËr_t
 
	$scgi_»cv_»¥Ú£
(
£rv”
 *
¤v
, 
hªdËr_ùx
 *
hùx
) {

2491 
	`scgi_demux_»¥Ú£
(
¤v
, 
hùx
)) {

2496 
	`scgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2498  
HANDLER_FINISHED
;

2500 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2501 
¶ugš_d©a
 *
p
 = 
hùx
->plugin_data;

2503 
scgi_´oc
 *
´oc
 = 
hùx
->proc;

2504 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

2506 ià(
´oc
->
pid
 &&…roc->
¡©e
 !ğ
PROC_STATE_DIED
) {

2507 
¡©us
;

2511 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

2519 ià(
	`WIFEXITED
(
¡©us
)) {

2520 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

2521 "chdƒx™ed,…id:", 
´oc
->
pid
,

2522 "¡©us:", 
	`WEXITSTATUS
(
¡©us
));

2523 } ià(
	`WIFSIGNALED
(
¡©us
)) {

2524 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2526 
	`WTERMSIG
(
¡©us
));

2528 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2530 
¡©us
);

2533 ià(
hùx
->
cÚf
.
debug
) {

2534 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsbsdsd",

2536 "\n\Üt:", 
ho¡
->
pÜt
,

2537 "\n\tsock‘", 
ho¡
->
unixsock‘
,

2538 "\n\tcu¼’t:", 1, "/", 
ho¡
->
mš_´ocs
);

2541 ià(
	`scgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
ho¡
, 
´oc
)) {

2543 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

2545 
	`scgi_´oşi¡_sÜt_down
(
¤v
, 
ho¡
, 
´oc
);

2552 ià(
cÚ
->
fe_¡¬‹d
 == 0) {

2555 ià(
hùx
->
wb
->
by‹s_out
 == 0 &&

2556 
hùx
->
»cÚÃùs
++ < 5) {

2558 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsd",

2560 "cÚÃùiÚ-fd:", 
cÚ
->
fd
,

2561 "fcgi-fd:", 
hùx
->
fd
);

2563  
	`scgi_»cÚÃù
(
¤v
, 
hùx
);

2566 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sosdsd",

2567 "»¥Ú£‚Ù s’t,„eque¡ s’t:", 
hùx
->
wb
->
by‹s_out
,

2568 "cÚÃùiÚ-fd:", 
cÚ
->
fd
,

2569 "fcgi-fd:", 
hùx
->
fd
);

2571 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssdsd",

2573 "cÚÃùiÚ-fd:", 
cÚ
->
fd
,

2574 "fcgi-fd:", 
hùx
->
fd
);

2577 
	`h‰p_»¥Ú£_back’d_”rÜ
(
¤v
, 
cÚ
);

2578 
	`scgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2579  
HANDLER_FINISHED
;

2583  
HANDLER_GO_ON
;

2584 
	}
}

2587 
hªdËr_t
 
	$scgi_hªdË_fdev’t
(
£rv”
 *
¤v
, *
ùx
, 
»v’ts
) {

2588 
hªdËr_ùx
 *
hùx
 = 
ùx
;

2589 
cÚÃùiÚ
 *
cÚ
 = 
hùx
->
»mÙe_cÚn
;

2591 
	`jobli¡_­³nd
(
¤v
, 
cÚ
);

2593 ià(
»v’ts
 & 
FDEVENT_IN
) {

2594 
hªdËr_t
 
rc
 = 
	`scgi_»cv_»¥Ú£
(
¤v
, 
hùx
);

2595 ià(
rc
 !ğ
HANDLER_GO_ON
) „c;

2598 ià(
»v’ts
 & 
FDEVENT_OUT
) {

2599  
	`scgi_£nd_»que¡
(
¤v
, 
hùx
);

2603 ià(
»v’ts
 & 
FDEVENT_HUP
) {

2604 ià(
hùx
->
¡©e
 =ğ
FCGI_STATE_CONNECT
) {

2614 
	`scgi_£nd_»que¡
(
¤v
, 
hùx
);

2615 } ià(
cÚ
->
fe_¡¬‹d
) {

2621 
hªdËr_t
 
rc
;

2623 
rc
 = 
	`scgi_»cv_»¥Ú£
(
¤v
,
hùx
);

2624 } 
rc
 =ğ
HANDLER_GO_ON
);

2625  
rc
;

2627 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
ğ
hùx
->host;

2628 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbSBSDSd",

2630 
cÚ
->
uri
.
·th
,

2632 
ho¡
->host,

2634 
ho¡
->
pÜt
,

2636 
hùx
->
¡©e
);

2638 
	`scgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2640 } ià(
»v’ts
 & 
FDEVENT_ERR
) {

2641 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

2644 
	`h‰p_»¥Ú£_back’d_”rÜ
(
¤v
, 
cÚ
);

2645 
	`scgi_cÚÃùiÚ_şo£
(
¤v
, 
hùx
);

2648  
HANDLER_FINISHED
;

2649 
	}
}

2650 
	#PATCH
(
x
) \

2651 
p
->
cÚf
.
x
 = 
s
->x;

	)

2652 
	$scgi_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

2653 
size_t
 
i
, 
j
;

2654 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

2656 
	`PATCH
(
exts
);

2657 
	`PATCH
(
´Ùo
);

2658 
	`PATCH
(
debug
);

2661 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

2662 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

2663 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

2666 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

2669 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

2670 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

2672 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("scgi.server"))) {

2673 
	`PATCH
(
exts
);

2674 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("scgi.protocol"))) {

2675 
	`PATCH
(
´Ùo
);

2676 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("scgi.debug"))) {

2677 
	`PATCH
(
debug
);

2683 
	}
}

2684 #undeà
PATCH


2687 
hªdËr_t
 
	$scgi_check_ex‹nsiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
, 
uri_·th_hªdËr
) {

2688 
¶ugš_d©a
 *
p
 = 
p_d
;

2689 
size_t
 
s_Ën
, 
uri_·th_Ën
;

2690 
size_t
 
k
;

2691 
bufãr
 *
â
;

2692 
scgi_ex‹nsiÚ
 *
ex‹nsiÚ
 = 
NULL
;

2693 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
 = 
NULL
;

2695 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

2698 ià(
cÚ
->
fe_¡¬‹d
 =ğ1è 
HANDLER_GO_ON
;

2700 
â
 = 
uri_·th_hªdËr
 ? 
cÚ
->
uri
.
·th
 : cÚ->
physiÿl
.path;

2702 ià(
	`bufãr_¡ršg_is_em±y
(
â
)è 
HANDLER_GO_ON
;

2704 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
â
);

2705 
uri_·th_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
);

2707 
	`scgi_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

2710 
k
 = 0; k < 
p
->
cÚf
.
exts
->
u£d
; k++) {

2711 
size_t
 
ù_Ën
;

2712 
scgi_ex‹nsiÚ
 *
ext
 = 
p
->
cÚf
.
exts
->exts[
k
];

2714 ià(
	`bufãr_is_em±y
(
ext
->
key
)) ;

2716 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ext
->
key
);

2719 ià(
ext
->
key
->
±r
[0] == '/') {

2720 ià(
ù_Ën
 <ğ
uri_·th_Ën


2721 && 0 =ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
, 
ext
->
key
->±r, 
ù_Ën
)) {

2722 
ex‹nsiÚ
 = 
ext
;

2725 } ià(
ù_Ën
 <ğ
s_Ën


2726 && 0 =ğ
	`¡ºcmp
(
â
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ext
->
key
->ptr, ct_len)) {

2728 
ex‹nsiÚ
 = 
ext
;

2734 ià(
NULL
 =ğ
ex‹nsiÚ
) {

2735  
HANDLER_GO_ON
;

2739 
ho¡
 = 
	`scgi_ex‹nsiÚ_ho¡_g‘
(
¤v
, 
cÚ
, 
p
, 
ex‹nsiÚ
);

2740 ià(
NULL
 =ğ
ho¡
) {

2741  
HANDLER_FINISHED
;

2745 
ex‹nsiÚ
->
nÙe_is_£Á
 = 0;

2753 ià(
uri_·th_hªdËr
) {

2754 ià(
ho¡
->
check_loÿl
 == 0) {

2755 
hªdËr_ùx
 *
hùx
;

2756 *
·thšfo
;

2758 
hùx
 = 
	`hªdËr_ùx_š™
();

2760 
hùx
->
»mÙe_cÚn
 = 
cÚ
;

2761 
hùx
->
¶ugš_d©a
 = 
p
;

2762 
hùx
->
ho¡
 = host;

2763 
hùx
->
´oc
 = 
NULL
;

2764 
hùx
->
ext
 = 
ex‹nsiÚ
;

2767 
hùx
->
cÚf
.
´Ùo
 = 
p
->conf.proto;

2768 
hùx
->
cÚf
.
debug
 = 
p
->conf.debug;

2770 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

2772 
ho¡
->
lßd
++;

2774 
cÚ
->
mode
 = 
p
->
id
;

2776 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

2777 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

2802 ià(
ho¡
->
fix_roÙ_·th_Çme
 && 
ex‹nsiÚ
->
key
->
±r
[0] == '/' &&ƒxtension->key->ptr[1] == '\0') {

2803 
	`bufãr_cİy_¡ršg
(
cÚ
->
»que¡
.
·thšfo
, cÚ->
uri
.
·th
->
±r
);

2804 
	`bufãr_¡ršg_£t_Ëngth
(
cÚ
->
uri
.
·th
, 0);

2805 } ià(
ex‹nsiÚ
->
key
->
±r
[0] == '/' &&

2806 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
è> bufãr_¡ršg_Ëngth(
ex‹nsiÚ
->
key
) &&

2807 
NULL
 !ğ(
·thšfo
 = 
	`¡rchr
(
cÚ
->
uri
.
·th
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(
ex‹nsiÚ
->
key
), '/'))) {

2810 
	`bufãr_cİy_¡ršg
(
cÚ
->
»que¡
.
·thšfo
,…athinfo);

2811 
	`bufãr_¡ršg_£t_Ëngth
(
cÚ
->
uri
.
·th
, 
	`bufãr_¡ršg_Ëngth
(cÚ->uri.·thè- bufãr_¡ršg_Ëngth(cÚ->
»que¡
.
·thšfo
));

2815 
hªdËr_ùx
 *
hùx
;

2816 
hùx
 = 
	`hªdËr_ùx_š™
();

2818 
hùx
->
»mÙe_cÚn
 = 
cÚ
;

2819 
hùx
->
¶ugš_d©a
 = 
p
;

2820 
hùx
->
ho¡
 = host;

2821 
hùx
->
´oc
 = 
NULL
;

2822 
hùx
->
ext
 = 
ex‹nsiÚ
;

2825 
hùx
->
cÚf
.
´Ùo
 = 
p
->conf.proto;

2826 
hùx
->
cÚf
.
debug
 = 
p
->conf.debug;

2828 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

2830 
ho¡
->
lßd
++;

2832 
cÚ
->
mode
 = 
p
->
id
;

2834 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

2835 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "handling it in mod_scgi");

2839  
HANDLER_GO_ON
;

2840 
	}
}

2843 
hªdËr_t
 
	$scgi_check_ex‹nsiÚ_1
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

2844  
	`scgi_check_ex‹nsiÚ
(
¤v
, 
cÚ
, 
p_d
, 1);

2845 
	}
}

2848 
hªdËr_t
 
	$scgi_check_ex‹nsiÚ_2
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

2849  
	`scgi_check_ex‹nsiÚ
(
¤v
, 
cÚ
, 
p_d
, 0);

2850 
	}
}

2853 
	$TRIGGER_FUNC
(
mod_scgi_hªdË_Œigg”
) {

2854 
¶ugš_d©a
 *
p
 = 
p_d
;

2855 
size_t
 
i
, 
j
, 
n
;

2868 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

2869 
¶ugš_cÚfig
 *
cÚf
;

2870 
scgi_exts
 *
exts
;

2872 
cÚf
 = 
p
->
cÚfig_¡Üage
[
i
];

2874 
exts
 = 
cÚf
->exts;

2876 
j
 = 0; j < 
exts
->
u£d
; j++) {

2877 
scgi_ex‹nsiÚ
 *
ex
;

2879 
ex
 = 
exts
->exts[
j
];

2881 
n
 = 0;‚ < 
ex
->
u£d
;‚++) {

2883 
scgi_´oc
 *
´oc
;

2884 
sum_lßd
 = 0;

2885 
scgi_ex‹nsiÚ_ho¡
 *
ho¡
;

2887 
ho¡
 = 
ex
->
ho¡s
[
n
];

2889 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

2890 
¡©us
;

2892 ià(
´oc
->
pid
 == 0) ;

2894 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

2899 ià(
”ºo
 !ğ
EINTR
) {

2901 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddss",

2902 "pid ", 
´oc
->
pid
,…roc->
¡©e
,

2903 "nÙ found:", 
	`¡»¼Ü
(
”ºo
));

2908 ià(
	`WIFEXITED
(
¡©us
)) {

2909 ià(
´oc
->
¡©e
 !ğ
PROC_STATE_KILLED
) {

2910 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

2912 
	`WEXITSTATUS
(
¡©us
), 
´oc
->
sock‘
);

2914 } ià(
	`WIFSIGNALED
(
¡©us
)) {

2915 ià(
	`WTERMSIG
(
¡©us
è!ğ
SIGTERM
) {

2916 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2918 
	`WTERMSIG
(
¡©us
));

2921 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

2923 
¡©us
);

2925 
´oc
->
pid
 = 0;

2926 ià(
´oc
->
¡©e
 =ğ
PROC_STATE_RUNNING
è
ho¡
->
aùive_´ocs
--;

2927 
´oc
->
¡©e
 = 
PROC_STATE_DIED
;

2928 
ho¡
->
max_id
--;

2932 
	`scgi_»¡¬t_d—d_´ocs
(
¤v
, 
p
, 
ho¡
);

2934 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

2935 
sum_lßd
 +ğ
´oc
->
lßd
;

2938 ià(
ho¡
->
num_´ocs
 &&

2939 
ho¡
->
num_´ocs
 < ho¡->
max_´ocs
 &&

2940 (
sum_lßd
 / 
ho¡
->
num_´ocs
è> ho¡->
max_lßd_³r_´oc
) {

2942 
scgi_´oc
 *
å
 = 
NULL
;

2944 ià(
p
->
cÚf
.
debug
) {

2945 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

2949 
å
 = 
ho¡
->
unu£d_´ocs
; f°&& fp->
pid
 !ğ0; f°ğå->
Ãxt
);

2951 ià(
å
) {

2952 ià(
å
 =ğ
ho¡
->
unu£d_´ocs
èho¡->unu£d_´oc ğå->
Ãxt
;

2954 ià(
å
->
Ãxt
èå->Ãxt->
´ev
 = 
NULL
;

2956 
ho¡
->
max_id
++;

2958 
å
 = 
	`scgi_´oûss_š™
();

2959 
å
->
id
 = 
ho¡
->
max_id
++;

2962 
ho¡
->
num_´ocs
++;

2964 ià(
	`bufãr_¡ršg_is_em±y
(
ho¡
->
unixsock‘
)) {

2965 
å
->
pÜt
 = 
ho¡
->pÜˆ+ fp->
id
;

2967 
	`bufãr_cİy_bufãr
(
å
->
sock‘
, 
ho¡
->
unixsock‘
);

2968 
	`bufãr_­³nd_¡ršg_Ën
(
å
->
sock‘
, 
	`CONST_STR_LEN
("-"));

2969 
	`bufãr_­³nd_št
(
å
->
sock‘
, fp->
id
);

2972 ià(
	`scgi_¥awn_cÚÃùiÚ
(
¤v
, 
p
, 
ho¡
, 
å
)) {

2973 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

2975 
	`scgi_´oûss_ä“
(
å
);

2976  
HANDLER_ERROR
;

2979 
å
->
´ev
 = 
NULL
;

2980 
å
->
Ãxt
 = 
ho¡
->
fœ¡
;

2981 ià(
ho¡
->
fœ¡
) {

2982 
ho¡
->
fœ¡
->
´ev
 = 
å
;

2984 
ho¡
->
fœ¡
 = 
å
;

2987 
´oc
 = 
ho¡
->
fœ¡
;…roc;…roøğ´oc->
Ãxt
) {

2988 ià(
´oc
->
lßd
 != 0) ;

2989 ià(
ho¡
->
num_´ocs
 <ğho¡->
mš_´ocs
) ;

2990 ià(
´oc
->
pid
 == 0) ;

2992 ià(
¤v
->
cur_ts
 - 
´oc
->
Ï¡_u£d
 > 
ho¡
->
idË_timeout
) {

2996 ià(
p
->
cÚf
.
debug
) {

2997 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsd",

2999 "sock‘:", 
´oc
->
sock‘
,

3000 "pid", 
´oc
->
pid
);

3004 ià(
´oc
->
Ãxt
è´oc->Ãxt->
´ev
 =…roc->prev;

3005 ià(
´oc
->
´ev
è´oc->´ev->
Ãxt
 =…roc->next;

3007 ià(
´oc
->
´ev
 =ğ
NULL
è
ho¡
->
fœ¡
 =…roc->
Ãxt
;

3009 
´oc
->
´ev
 = 
NULL
;

3010 
´oc
->
Ãxt
 = 
ho¡
->
unu£d_´ocs
;

3012 ià(
ho¡
->
unu£d_´ocs
èho¡->unu£d_´ocs->
´ev
 = 
´oc
;

3013 
ho¡
->
unu£d_´ocs
 = 
´oc
;

3015 
	`kl
(
´oc
->
pid
, 
SIGTERM
);

3017 
´oc
->
¡©e
 = 
PROC_STATE_KILLED
;

3019 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsd",

3021 "sock‘:", 
´oc
->
sock‘
,

3022 "pid", 
´oc
->
pid
);

3024 
ho¡
->
num_´ocs
--;

3031 
´oc
 = 
ho¡
->
unu£d_´ocs
;…roc;…roøğ´oc->
Ãxt
) {

3032 
¡©us
;

3034 ià(
´oc
->
pid
 == 0) ;

3036 
	`wa™pid
(
´oc
->
pid
, &
¡©us
, 
WNOHANG
)) {

3041 ià(
”ºo
 !ğ
EINTR
) {

3043 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddss",

3044 "pid ", 
´oc
->
pid
,…roc->
¡©e
,

3045 "nÙ found:", 
	`¡»¼Ü
(
”ºo
));

3048 ià(
”ºo
 =ğ
ECHILD
) {

3050 
´oc
->
pid
 = 0;

3051 
´oc
->
¡©e
 = 
PROC_STATE_UNSET
;

3058 ià(
	`WIFEXITED
(
¡©us
)) {

3059 ià(
´oc
->
¡©e
 !ğ
PROC_STATE_KILLED
) {

3060 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdb",

3062 
	`WEXITSTATUS
(
¡©us
), 
´oc
->
sock‘
);

3064 } ià(
	`WIFSIGNALED
(
¡©us
)) {

3065 ià(
	`WTERMSIG
(
¡©us
è!ğ
SIGTERM
) {

3066 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3068 
	`WTERMSIG
(
¡©us
));

3071 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

3073 
¡©us
);

3075 
´oc
->
pid
 = 0;

3076 
´oc
->
¡©e
 = 
PROC_STATE_UNSET
;

3077 
ho¡
->
max_id
--;

3084  
HANDLER_GO_ON
;

3085 
	}
}

3088 
mod_scgi_¶ugš_š™
(
¶ugš
 *
p
);

3089 
	$mod_scgi_¶ugš_š™
(
¶ugš
 *
p
) {

3090 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

3091 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("scgi");

3093 
p
->
š™
 = 
mod_scgi_š™
;

3094 
p
->
ş—nup
 = 
mod_scgi_ä“
;

3095 
p
->
£t_deçuÉs
 = 
mod_scgi_£t_deçuÉs
;

3096 
p
->
cÚÃùiÚ_»£t
 = 
scgi_cÚÃùiÚ_»£t
;

3097 
p
->
hªdË_cÚÃùiÚ_şo£
 = 
scgi_cÚÃùiÚ_»£t
;

3098 
p
->
hªdË_uri_ş—n
 = 
scgi_check_ex‹nsiÚ_1
;

3099 
p
->
hªdË_sub»que¡_¡¬t
 = 
scgi_check_ex‹nsiÚ_2
;

3100 
p
->
hªdË_sub»que¡
 = 
mod_scgi_hªdË_sub»que¡
;

3101 
p
->
hªdË_Œigg”
 = 
mod_scgi_hªdË_Œigg”
;

3103 
p
->
d©a
 = 
NULL
;

3106 
	}
}

	@mod_secdownload.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"ba£64.h
"

8 
	~"¶ugš.h
"

10 
	~<ùy³.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

14 #ià
defšed
(
USE_OPENSSL
)

15 
	~<İ’s¦/evp.h
>

16 
	~<İ’s¦/hmac.h
>

19 
	~"md5.h
"

21 
	#HASHLEN
 16

	)

22 
	tHASH
[
HASHLEN
];

23 
	#HASHHEXLEN
 32

	)

24 
	tHASHHEX
[
HASHHEXLEN
+1];

82 
	mSECDL_INVALID
 = 0,

83 
	mSECDL_MD5
 = 1,

84 
	mSECDL_HMAC_SHA1
 = 2,

85 
	mSECDL_HMAC_SHA256
 = 3,

86 } 
	t£cdl_®gÜ™hm
;

89 
bufãr
 *
	mdoc_roÙ
;

90 
bufãr
 *
	m£ü‘
;

91 
bufãr
 *
	muri_´efix
;

92 
£cdl_®gÜ™hm
 
	m®gÜ™hm
;

94 
	mtimeout
;

95 } 
	t¶ugš_cÚfig
;

98 
	mPLUGIN_DATA
;

100 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

102 
¶ugš_cÚfig
 
	mcÚf
;

103 } 
	t¶ugš_d©a
;

105 
	$cÚ¡_time_memeq
(cÚ¡ *
a
, cÚ¡ *
b
, 
size_t
 
Ën
) {

107 
diff
 = 0;

108 
size_t
 
i
;

109 
i
 = 0; i < 
Ën
; ++i) {

110 
diff
 |ğ(
a
[
i
] ^ 
b
[i]);

112  0 =ğ
diff
;

113 
	}
}

115 cÚ¡ * 
	g£cdl_®gÜ™hm_Çmes
[] = {

122 
£cdl_®gÜ™hm
 
	$®gÜ™hm_äom_¡ršg
(
bufãr
 *
Çme
) {

123 
size_t
 
ndx
;

125 ià(
	`bufãr_¡ršg_is_em±y
(
Çme
)è 
SECDL_INVALID
;

127 
ndx
 = 1;‚dx < (
£cdl_®gÜ™hm_Çmes
)/(secdl_algorithm_names[0]); ++ndx) {

128 ià(0 =ğ
	`¡rcmp
(
£cdl_®gÜ™hm_Çmes
[
ndx
], 
Çme
->
±r
)è (
£cdl_®gÜ™hm
)ndx;

131  
SECDL_INVALID
;

132 
	}
}

134 
size_t
 
	$£cdl_®gÜ™hm_mac_Ëngth
(
£cdl_®gÜ™hm
 
®g
) {

135 
®g
) {

136 
SECDL_INVALID
:

138 
SECDL_MD5
:

140 
SECDL_HMAC_SHA1
:

142 
SECDL_HMAC_SHA256
:

146 
	}
}

148 
	$£cdl_v”ify_mac
(
£rv”
 *
¤v
, 
¶ugš_cÚfig
 *
cÚfig
, cÚ¡ * 
´Ùeùed_·th
, cÚ¡ * 
mac
, 
size_t
 
maş’
) {

149 
	`UNUSED
(
¤v
);

150 ià(0 =ğ
maş’
 || 
	`£cdl_®gÜ™hm_mac_Ëngth
(
cÚfig
->
®gÜ™hm
) != maclen)  0;

152 
cÚfig
->
®gÜ™hm
) {

153 
SECDL_INVALID
:

155 
SECDL_MD5
:

157 
li_MD5_CTX
 
Md5Ctx
;

158 
HASH
 
HA1
;

159 
hexmd5
[33];

160 cÚ¡ *
ts_¡r
;

161 cÚ¡ *
»l_uri
;

170 
ts_¡r
 = 
´Ùeùed_·th
 + 1;

171 
»l_uri
 = 
ts_¡r
 + 8;

173 
	`li_MD5_In™
(&
Md5Ctx
);

174 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_BUF_LEN
(
cÚfig
->
£ü‘
));

175 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
»l_uri
, 
	`¡¾’
(rel_uri));

176 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
ts_¡r
, 8);

177 
	`li_MD5_Fš®
(
HA1
, &
Md5Ctx
);

179 
	`li_tohex
(
hexmd5
, (hexmd5), (cÚ¡ *)
HA1
, 16);

181  (32 =ğ
maş’
è&& 
	`cÚ¡_time_memeq
(
mac
, 
hexmd5
, 32);

183 
SECDL_HMAC_SHA1
:

184 #ià
	`defšed
(
USE_OPENSSL
)

186 
dige¡
[20];

187 
ba£64_dige¡
[27];

189 ià(
NULL
 =ğ
	`HMAC
(

190 
	`EVP_sha1
(),

191 (cÚ¡*è
	`CONST_BUF_LEN
(
cÚfig
->
£ü‘
),

192 (cÚ¡*è
´Ùeùed_·th
, 
	`¡¾’
(protected_path),

193 
dige¡
, 
NULL
)) {

194 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

199 
	`li_to_ba£64_no_·ddšg
(
ba£64_dige¡
, 27, 
dige¡
, 20, 
BASE64_URL
);

201  (27 =ğ
maş’
è&& 
	`cÚ¡_time_memeq
(
mac
, 
ba£64_dige¡
, 27);

205 
SECDL_HMAC_SHA256
:

206 #ià
	`defšed
(
USE_OPENSSL
)

208 
dige¡
[32];

209 
ba£64_dige¡
[43];

211 ià(
NULL
 =ğ
	`HMAC
(

212 
	`EVP_sha256
(),

213 (cÚ¡*è
	`CONST_BUF_LEN
(
cÚfig
->
£ü‘
),

214 (cÚ¡*è
´Ùeùed_·th
, 
	`¡¾’
(protected_path),

215 
dige¡
, 
NULL
)) {

216 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

221 
	`li_to_ba£64_no_·ddšg
(
ba£64_dige¡
, 43, 
dige¡
, 32, 
BASE64_URL
);

223  (43 =ğ
maş’
è&& 
	`cÚ¡_time_memeq
(
mac
, 
ba£64_dige¡
, 43);

230 
	}
}

233 
	$INIT_FUNC
(
mod_£cdowÆßd_š™
) {

234 
¶ugš_d©a
 *
p
;

236 
p
 = 
	`ÿÎoc
(1, (*p));

238  
p
;

239 
	}
}

242 
	$FREE_FUNC
(
mod_£cdowÆßd_ä“
) {

243 
¶ugš_d©a
 *
p
 = 
p_d
;

244 
	`UNUSED
(
¤v
);

246 ià(!
p
è 
HANDLER_GO_ON
;

248 ià(
p
->
cÚfig_¡Üage
) {

249 
size_t
 
i
;

250 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

251 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

253 ià(
NULL
 =ğ
s
) ;

255 
	`bufãr_ä“
(
s
->
£ü‘
);

256 
	`bufãr_ä“
(
s
->
doc_roÙ
);

257 
	`bufãr_ä“
(
s
->
uri_´efix
);

259 
	`ä“
(
s
);

261 
	`ä“
(
p
->
cÚfig_¡Üage
);

264 
	`ä“
(
p
);

266  
HANDLER_GO_ON
;

267 
	}
}

271 
	$SETDEFAULTS_FUNC
(
mod_£cdowÆßd_£t_deçuÉs
) {

272 
¶ugš_d©a
 *
p
 = 
p_d
;

273 
size_t
 
i
 = 0;

275 
cÚfig_v®ues_t
 
cv
[] = {

276 { "£cdowÆßd.£ü‘", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

277 { "£cdowÆßd.docum’t-roÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

278 { "£cdowÆßd.uri-´efix", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

279 { "£cdowÆßd.timeout", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

280 { "£cdowÆßd.®gÜ™hm", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

281 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

284 ià(!
p
è 
HANDLER_ERROR
;

286 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

288 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

289 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

290 
¶ugš_cÚfig
 *
s
;

291 
bufãr
 *
®gÜ™hm
 = 
	`bufãr_š™
();

293 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

294 
s
->
£ü‘
 = 
	`bufãr_š™
();

295 
s
->
doc_roÙ
 = 
	`bufãr_š™
();

296 
s
->
uri_´efix
 = 
	`bufãr_š™
();

297 
s
->
timeout
 = 60;

299 
cv
[0].
de¡š©iÚ
 = 
s
->
£ü‘
;

300 
cv
[1].
de¡š©iÚ
 = 
s
->
doc_roÙ
;

301 
cv
[2].
de¡š©iÚ
 = 
s
->
uri_´efix
;

302 
cv
[3].
de¡š©iÚ
 = &(
s
->
timeout
);

303 
cv
[4].
de¡š©iÚ
 = 
®gÜ™hm
;

305 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

307 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

308 
	`bufãr_ä“
(
®gÜ™hm
);

309  
HANDLER_ERROR
;

312 ià(!
	`bufãr_is_em±y
(
®gÜ™hm
)) {

313 
s
->
®gÜ™hm
 = 
	`®gÜ™hm_äom_¡ršg
(algorithm);

314 
s
->
®gÜ™hm
) {

315 
SECDL_INVALID
:

316 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

318 
®gÜ™hm
);

319 
	`bufãr_ä“
(
®gÜ™hm
);

320  
HANDLER_ERROR
;

321 #ià!
	`defšed
(
USE_OPENSSL
)

322 
SECDL_HMAC_SHA1
:

323 
SECDL_HMAC_SHA256
:

324 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

326 
®gÜ™hm
);

333 
	`bufãr_ä“
(
®gÜ™hm
);

336  
HANDLER_GO_ON
;

337 
	}
}

346 
	$is_hex_Ën
(cÚ¡ *
¡r
, 
size_t
 
Ën
) {

347 
size_t
 
i
;

349 ià(
NULL
 =ğ
¡r
)  0;

351 
i
 = 0; i < 
Ën
 && *
¡r
; i++, str++) {

353 ià(!((*
¡r
 >= '0' && *str <= '9') ||

354 (*
¡r
 >= 'a' && *str <= 'f') ||

355 (*
¡r
 >= 'A' && *str <= 'F'))

361  
i
 =ğ
Ën
;

362 
	}
}

371 
	$is_ba£64_Ën
(cÚ¡ *
¡r
, 
size_t
 
Ën
) {

372 
size_t
 
i
;

374 ià(
NULL
 =ğ
¡r
)  0;

376 
i
 = 0; i < 
Ën
 && *
¡r
; i++, str++) {

378 ià(!((*
¡r
 >= '0' && *str <= '9') ||

379 (*
¡r
 >= 'a' && *str <= 'z') ||

380 (*
¡r
 >= 'A' && *str <= 'Z') ||

381 (*
¡r
 == '-') || (*str == '_'))

387  
i
 =ğ
Ën
;

388 
	}
}

390 
	#PATCH
(
x
) \

391 
p
->
cÚf
.
x
 = 
s
->x;

	)

392 
	$mod_£cdowÆßd_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

393 
size_t
 
i
, 
j
;

394 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

396 
	`PATCH
(
£ü‘
);

397 
	`PATCH
(
doc_roÙ
);

398 
	`PATCH
(
uri_´efix
);

399 
	`PATCH
(
timeout
);

400 
	`PATCH
(
®gÜ™hm
);

403 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

404 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

405 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

408 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

411 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

412 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

414 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("secdownload.secret"))) {

415 
	`PATCH
(
£ü‘
);

416 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("secdownload.document-root"))) {

417 
	`PATCH
(
doc_roÙ
);

418 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("secdownload.uri-prefix"))) {

419 
	`PATCH
(
uri_´efix
);

420 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("secdownload.timeout"))) {

421 
	`PATCH
(
timeout
);

422 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("secdownload.algorithm"))) {

423 
	`PATCH
(
®gÜ™hm
);

429 
	}
}

430 #undeà
PATCH


433 
	$URIHANDLER_FUNC
(
mod_£cdowÆßd_uri_hªdËr
) {

434 
¶ugš_d©a
 *
p
 = 
p_d
;

435 cÚ¡ *
»l_uri
, *
ts_¡r
, *
mac_¡r
, *
´Ùeùed_·th
;

436 
time_t
 
ts
 = 0;

437 
size_t
 
i
, 
mac_Ën
;

439 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

441 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

443 
	`mod_£cdowÆßd_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

445 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
uri_´efix
)è 
HANDLER_GO_ON
;

447 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
£ü‘
)) {

448 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

450 
cÚ
->
h‰p_¡©us
 = 500;

451  
HANDLER_FINISHED
;

454 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
doc_roÙ
)) {

455 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

457 
cÚ
->
h‰p_¡©us
 = 500;

458  
HANDLER_FINISHED
;

461 ià(
SECDL_INVALID
 =ğ
p
->
cÚf
.
®gÜ™hm
) {

462 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

464 
cÚ
->
h‰p_¡©us
 = 500;

465  
HANDLER_FINISHED
;

468 
mac_Ën
 = 
	`£cdl_®gÜ™hm_mac_Ëngth
(
p
->
cÚf
.
®gÜ™hm
);

470 ià(0 !ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
, 
p
->
cÚf
.
uri_´efix
->±r, 
	`bufãr_¡ršg_Ëngth
Õ->cÚf.uri_´efix))è 
HANDLER_GO_ON
;

472 
mac_¡r
 = 
cÚ
->
uri
.
·th
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(
p
->
cÚf
.
uri_´efix
);

474 ià(!
	`is_ba£64_Ën
(
mac_¡r
, 
mac_Ën
)è 
HANDLER_GO_ON
;

476 
´Ùeùed_·th
 = 
mac_¡r
 + 
mac_Ën
;

477 ià(*
´Ùeùed_·th
 !ğ'/'è 
HANDLER_GO_ON
;

479 
ts_¡r
 = 
´Ùeùed_·th
 + 1;

480 ià(!
	`is_hex_Ën
(
ts_¡r
, 8)è 
HANDLER_GO_ON
;

481 ià(*(
ts_¡r
 + 8è!ğ'/'è 
HANDLER_GO_ON
;

483 
i
 = 0; i < 8; i++) {

484 
ts
 = (t << 4è+ 
	`hex2št
(
ts_¡r
[
i
]);

488 iàĞ(
¤v
->
cur_ts
 > 
ts
 && (è(¤v->cur_t -sè> 
p
->
cÚf
.
timeout
) ||

489 (
¤v
->
cur_ts
 < 
ts
 && (èÑ - srv->cur_tsè> 
p
->
cÚf
.
timeout
) ) {

491 
cÚ
->
h‰p_¡©us
 = 410;

493  
HANDLER_FINISHED
;

496 
»l_uri
 = 
ts_¡r
 + 8;

498 ià(!
	`£cdl_v”ify_mac
(
¤v
, &
p
->
cÚf
, 
´Ùeùed_·th
, 
mac_¡r
, 
mac_Ën
)) {

499 
cÚ
->
h‰p_¡©us
 = 403;

501 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

502 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

504 
cÚ
->
uri
.
·th
);

507  
HANDLER_FINISHED
;

513 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
p
->
cÚf
.doc_root);

514 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
ba£dœ
, 
p
->
cÚf
.
doc_roÙ
);

515 
	`bufãr_cİy_¡ršg
(
cÚ
->
physiÿl
.
»l_·th
, 
»l_uri
);

516 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
doc_roÙ
);

517 
	`bufãr_­³nd_¡ršg_bufãr
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
»l_·th
);

519  
HANDLER_GO_ON
;

520 
	}
}

524 
mod_£cdowÆßd_¶ugš_š™
(
¶ugš
 *
p
);

525 
	$mod_£cdowÆßd_¶ugš_š™
(
¶ugš
 *
p
) {

526 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

527 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("secdownload");

529 
p
->
š™
 = 
mod_£cdowÆßd_š™
;

530 
p
->
hªdË_physiÿl
 = 
mod_£cdowÆßd_uri_hªdËr
;

531 
p
->
£t_deçuÉs
 = 
mod_£cdowÆßd_£t_deçuÉs
;

532 
p
->
ş—nup
 = 
mod_£cdowÆßd_ä“
;

534 
p
->
d©a
 = 
NULL
;

537 
	}
}

	@mod_setenv.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"»¥Ú£.h
"

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

17 
	mhªdËd
;

18 } 
	thªdËr_ùx
;

21 
¬¿y
 *
	m»que¡_h—d”
;

22 
¬¿y
 *
	m»¥Ú£_h—d”
;

24 
¬¿y
 *
	m’vœÚm’t
;

25 } 
	t¶ugš_cÚfig
;

28 
	mPLUGIN_DATA
;

30 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

32 
¶ugš_cÚfig
 
	mcÚf
;

33 } 
	t¶ugš_d©a
;

35 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
() {

36 
hªdËr_ùx
 * 
hùx
;

38 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

40 
hùx
->
hªdËd
 = 0;

42  
hùx
;

43 
	}
}

45 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

46 
	`ä“
(
hùx
);

47 
	}
}

51 
	$INIT_FUNC
(
mod_£‹nv_š™
) {

52 
¶ugš_d©a
 *
p
;

54 
p
 = 
	`ÿÎoc
(1, (*p));

56  
p
;

57 
	}
}

60 
	$FREE_FUNC
(
mod_£‹nv_ä“
) {

61 
¶ugš_d©a
 *
p
 = 
p_d
;

63 
	`UNUSED
(
¤v
);

65 ià(!
p
è 
HANDLER_GO_ON
;

67 ià(
p
->
cÚfig_¡Üage
) {

68 
size_t
 
i
;

69 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

70 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

72 ià(
NULL
 =ğ
s
) ;

74 
	`¬¿y_ä“
(
s
->
»que¡_h—d”
);

75 
	`¬¿y_ä“
(
s
->
»¥Ú£_h—d”
);

76 
	`¬¿y_ä“
(
s
->
’vœÚm’t
);

78 
	`ä“
(
s
);

80 
	`ä“
(
p
->
cÚfig_¡Üage
);

83 
	`ä“
(
p
);

85  
HANDLER_GO_ON
;

86 
	}
}

90 
	$SETDEFAULTS_FUNC
(
mod_£‹nv_£t_deçuÉs
) {

91 
¶ugš_d©a
 *
p
 = 
p_d
;

92 
size_t
 
i
 = 0;

94 
cÚfig_v®ues_t
 
cv
[] = {

95 { "£‹nv.add-»que¡-h—d”", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

96 { "£‹nv.add-»¥Ú£-h—d”", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

97 { "£‹nv.add-’vœÚm’t", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

98 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

101 ià(!
p
è 
HANDLER_ERROR
;

103 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

105 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

106 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

107 
¶ugš_cÚfig
 *
s
;

109 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

110 
s
->
»que¡_h—d”
 = 
	`¬¿y_š™
();

111 
s
->
»¥Ú£_h—d”
 = 
	`¬¿y_š™
();

112 
s
->
’vœÚm’t
 = 
	`¬¿y_š™
();

114 
cv
[0].
de¡š©iÚ
 = 
s
->
»que¡_h—d”
;

115 
cv
[1].
de¡š©iÚ
 = 
s
->
»¥Ú£_h—d”
;

116 
cv
[2].
de¡š©iÚ
 = 
s
->
’vœÚm’t
;

118 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

120 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

121  
HANDLER_ERROR
;

125  
HANDLER_GO_ON
;

126 
	}
}

128 
	#PATCH
(
x
) \

129 
p
->
cÚf
.
x
 = 
s
->x;

	)

130 
	$mod_£‹nv_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

131 
size_t
 
i
, 
j
;

132 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

134 
	`PATCH
(
»que¡_h—d”
);

135 
	`PATCH
(
»¥Ú£_h—d”
);

136 
	`PATCH
(
’vœÚm’t
);

139 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

140 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

141 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

144 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

147 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

148 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

150 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("setenv.add-request-header"))) {

151 
	`PATCH
(
»que¡_h—d”
);

152 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("setenv.add-response-header"))) {

153 
	`PATCH
(
»¥Ú£_h—d”
);

154 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("setenv.add-environment"))) {

155 
	`PATCH
(
’vœÚm’t
);

161 
	}
}

162 #undeà
PATCH


164 
	$URIHANDLER_FUNC
(
mod_£‹nv_uri_hªdËr
) {

165 
¶ugš_d©a
 *
p
 = 
p_d
;

166 
size_t
 
k
;

167 
hªdËr_ùx
 *
hùx
;

169 ià(
cÚ
->
¶ugš_ùx
[
p
->
id
]) {

170 
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

172 
hùx
 = 
	`hªdËr_ùx_š™
();

174 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

177 ià(
hùx
->
hªdËd
) {

178  
HANDLER_GO_ON
;

181 
hùx
->
hªdËd
 = 1;

183 
	`mod_£‹nv_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

185 
k
 = 0; k < 
p
->
cÚf
.
»que¡_h—d”
->
u£d
; k++) {

186 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
»que¡_h—d”
->
d©a
[
k
];

187 
d©a_¡ršg
 *
ds_d¡
;

189 ià(
NULL
 =ğ(
ds_d¡
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
TYPE_STRING
))) {

190 
ds_d¡
 = 
	`d©a_¡ršg_š™
();

193 
	`bufãr_cİy_bufãr
(
ds_d¡
->
key
, 
ds
->key);

194 
	`bufãr_cİy_bufãr
(
ds_d¡
->
v®ue
, 
ds
->value);

196 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds_d¡
);

199 
k
 = 0; k < 
p
->
cÚf
.
’vœÚm’t
->
u£d
; k++) {

200 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
’vœÚm’t
->
d©a
[
k
];

201 
d©a_¡ršg
 *
ds_d¡
;

203 ià(
NULL
 =ğ(
ds_d¡
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

204 
ds_d¡
 = 
	`d©a_¡ršg_š™
();

207 
	`bufãr_cİy_bufãr
(
ds_d¡
->
key
, 
ds
->key);

208 
	`bufãr_cİy_bufãr
(
ds_d¡
->
v®ue
, 
ds
->value);

210 
	`¬¿y_š£¹_unique
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
ds_d¡
);

213 
k
 = 0; k < 
p
->
cÚf
.
»¥Ú£_h—d”
->
u£d
; k++) {

214 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
»¥Ú£_h—d”
->
d©a
[
k
];

216 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_BUF_LEN
(
ds
->
key
), CONST_BUF_LEN(ds->
v®ue
));

220  
HANDLER_GO_ON
;

221 
	}
}

223 
	$CONNECTION_FUNC
(
mod_£‹nv_»£t
) {

224 
¶ugš_d©a
 *
p
 = 
p_d
;

226 
	`UNUSED
(
¤v
);

228 ià(
cÚ
->
¶ugš_ùx
[
p
->
id
]) {

229 
	`hªdËr_ùx_ä“
(
cÚ
->
¶ugš_ùx
[
p
->
id
]);

230 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

233  
HANDLER_GO_ON
;

234 
	}
}

238 
mod_£‹nv_¶ugš_š™
(
¶ugš
 *
p
);

239 
	$mod_£‹nv_¶ugš_š™
(
¶ugš
 *
p
) {

240 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

241 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("setenv");

243 
p
->
š™
 = 
mod_£‹nv_š™
;

244 
p
->
hªdË_uri_ş—n
 = 
mod_£‹nv_uri_hªdËr
;

245 
p
->
£t_deçuÉs
 = 
mod_£‹nv_£t_deçuÉs
;

246 
p
->
ş—nup
 = 
mod_£‹nv_ä“
;

248 
p
->
cÚÃùiÚ_»£t
 = 
mod_£‹nv_»£t
;

250 
p
->
d©a
 = 
NULL
;

253 
	}
}

	@mod_simple_vhost.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"¡©_ÿche.h
"

8 
	~"¶ugš.h
"

10 
	~<as£¹.h
>

11 
	~<ùy³.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<”ºo.h
>

17 
bufãr
 *
	m£rv”_roÙ
;

18 
bufãr
 *
	mdeçuÉ_ho¡
;

19 
bufãr
 *
	mdocum’t_roÙ
;

21 
bufãr
 *
	mdoüoÙ_ÿche_key
;

22 
bufãr
 *
	mdoüoÙ_ÿche_v®ue
;

23 
bufãr
 *
	mdoüoÙ_ÿche_£rv”Çme
;

25 
	mdebug
;

26 } 
	t¶ugš_cÚfig
;

29 
	mPLUGIN_DATA
;

31 
bufãr
 *
	mdoc_roÙ
;

33 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

34 
¶ugš_cÚfig
 
	mcÚf
;

35 } 
	t¶ugš_d©a
;

37 
	$INIT_FUNC
(
mod_sim¶e_vho¡_š™
) {

38 
¶ugš_d©a
 *
p
;

40 
p
 = 
	`ÿÎoc
(1, (*p));

42 
p
->
doc_roÙ
 = 
	`bufãr_š™
();

44  
p
;

45 
	}
}

47 
	$FREE_FUNC
(
mod_sim¶e_vho¡_ä“
) {

48 
¶ugš_d©a
 *
p
 = 
p_d
;

50 
	`UNUSED
(
¤v
);

52 ià(!
p
è 
HANDLER_GO_ON
;

54 ià(
p
->
cÚfig_¡Üage
) {

55 
size_t
 
i
;

56 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

57 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

59 
	`bufãr_ä“
(
s
->
docum’t_roÙ
);

60 
	`bufãr_ä“
(
s
->
deçuÉ_ho¡
);

61 
	`bufãr_ä“
(
s
->
£rv”_roÙ
);

63 
	`bufãr_ä“
(
s
->
doüoÙ_ÿche_key
);

64 
	`bufãr_ä“
(
s
->
doüoÙ_ÿche_v®ue
);

65 
	`bufãr_ä“
(
s
->
doüoÙ_ÿche_£rv”Çme
);

67 
	`ä“
(
s
);

70 
	`ä“
(
p
->
cÚfig_¡Üage
);

73 
	`bufãr_ä“
(
p
->
doc_roÙ
);

75 
	`ä“
(
p
);

77  
HANDLER_GO_ON
;

78 
	}
}

80 
	$SETDEFAULTS_FUNC
(
mod_sim¶e_vho¡_£t_deçuÉs
) {

81 
¶ugš_d©a
 *
p
 = 
p_d
;

82 
size_t
 
i
;

84 
cÚfig_v®ues_t
 
cv
[] = {

85 { "sim¶e-vho¡.£rv”-roÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

86 { "sim¶e-vho¡.deçuÉ-ho¡", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

87 { "sim¶e-vho¡.docum’t-roÙ", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

88 { "sim¶e-vho¡.debug", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

89 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

92 ià(!
p
è 
HANDLER_ERROR
;

94 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

96 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

97 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

98 
¶ugš_cÚfig
 *
s
;

100 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

102 
s
->
£rv”_roÙ
 = 
	`bufãr_š™
();

103 
s
->
deçuÉ_ho¡
 = 
	`bufãr_š™
();

104 
s
->
docum’t_roÙ
 = 
	`bufãr_š™
();

106 
s
->
doüoÙ_ÿche_key
 = 
	`bufãr_š™
();

107 
s
->
doüoÙ_ÿche_v®ue
 = 
	`bufãr_š™
();

108 
s
->
doüoÙ_ÿche_£rv”Çme
 = 
	`bufãr_š™
();

110 
s
->
debug
 = 0;

112 
cv
[0].
de¡š©iÚ
 = 
s
->
£rv”_roÙ
;

113 
cv
[1].
de¡š©iÚ
 = 
s
->
deçuÉ_ho¡
;

114 
cv
[2].
de¡š©iÚ
 = 
s
->
docum’t_roÙ
;

115 
cv
[3].
de¡š©iÚ
 = &(
s
->
debug
);

118 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

120 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

121  
HANDLER_ERROR
;

125  
HANDLER_GO_ON
;

126 
	}
}

128 
	$bud_doc_roÙ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
, 
bufãr
 *
out
, bufã¸*
ho¡
) {

129 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

130 
	`fÜû_as£¹
(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
£rv”_roÙ
));

132 
	`bufãr_¡ršg_´•¬e_cİy
(
out
, 127);

133 
	`bufãr_cİy_bufãr
(
out
, 
p
->
cÚf
.
£rv”_roÙ
);

135 ià(!
	`bufãr_¡ršg_is_em±y
(
ho¡
)) {

139 *
dp
;

141 
	`bufãr_­³nd_¦ash
(
out
);

143 ià(
NULL
 =ğ(
dp
 = 
	`¡rchr
(
ho¡
->
±r
, ':'))) {

144 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
ho¡
);

146 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
ho¡
->
±r
, 
dp
 - host->ptr);

149 
	`bufãr_­³nd_¦ash
(
out
);

151 ià(
	`bufãr_¡ršg_Ëngth
(
p
->
cÚf
.
docum’t_roÙ
è> 1 &&…->cÚf.docum’t_roÙ->
±r
[0] == '/') {

152 
	`bufãr_­³nd_¡ršg_Ën
(
out
, 
p
->
cÚf
.
docum’t_roÙ
->
±r
 + 1, 
	`bufãr_¡ršg_Ëngth
(p->conf.document_root) - 1);

154 
	`bufãr_­³nd_¡ršg_bufãr
(
out
, 
p
->
cÚf
.
docum’t_roÙ
);

155 
	`bufãr_­³nd_¦ash
(
out
);

158 ià(
HANDLER_ERROR
 =ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
out
, &
sû
)) {

159 ià(
p
->
cÚf
.
debug
) {

160 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

161 
	`¡»¼Ü
(
”ºo
), 
out
);

164 } ià(!
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)) {

169 
	}
}

172 
	#PATCH
(
x
) \

173 
p
->
cÚf
.
x
 = 
s
->x;

	)

174 
	$mod_sim¶e_vho¡_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

175 
size_t
 
i
, 
j
;

176 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

178 
	`PATCH
(
£rv”_roÙ
);

179 
	`PATCH
(
deçuÉ_ho¡
);

180 
	`PATCH
(
docum’t_roÙ
);

182 
	`PATCH
(
doüoÙ_ÿche_key
);

183 
	`PATCH
(
doüoÙ_ÿche_v®ue
);

184 
	`PATCH
(
doüoÙ_ÿche_£rv”Çme
);

186 
	`PATCH
(
debug
);

189 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

190 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

191 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

194 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

197 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

198 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

200 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("simple-vhost.server-root"))) {

201 
	`PATCH
(
£rv”_roÙ
);

202 
	`PATCH
(
doüoÙ_ÿche_key
);

203 
	`PATCH
(
doüoÙ_ÿche_v®ue
);

204 
	`PATCH
(
doüoÙ_ÿche_£rv”Çme
);

205 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("simple-vhost.default-host"))) {

206 
	`PATCH
(
deçuÉ_ho¡
);

207 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("simple-vhost.document-root"))) {

208 
	`PATCH
(
docum’t_roÙ
);

209 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("simple-vhost.debug"))) {

210 
	`PATCH
(
debug
);

216 
	}
}

217 #undeà
PATCH


219 
hªdËr_t
 
	$mod_sim¶e_vho¡_doüoÙ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d©a
) {

220 
¶ugš_d©a
 *
p
 = 
p_d©a
;

228 
	`mod_sim¶e_vho¡_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

233 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
£rv”_roÙ
)è 
HANDLER_GO_ON
;

235 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
doüoÙ_ÿche_key
) &&

236 !
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
authÜ™y
) &&

237 
	`bufãr_is_equ®
(
p
->
cÚf
.
doüoÙ_ÿche_key
, 
cÚ
->
uri
.
authÜ™y
)) {

239 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, 
p
->
cÚf
.
doüoÙ_ÿche_£rv”Çme
);

240 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
p
->
cÚf
.
doüoÙ_ÿche_v®ue
);

243 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
authÜ™y
) ||

244 
	`bud_doc_roÙ
(
¤v
, 
cÚ
, 
p
,…->
doc_roÙ
, cÚ->
uri
.
authÜ™y
)) {

246 ià(0 =ğ
	`bud_doc_roÙ
(
¤v
, 
cÚ
, 
p
,

247 
p
->
doc_roÙ
,

248 
p
->
cÚf
.
deçuÉ_ho¡
)) {

250 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, 
p
->
cÚf
.
deçuÉ_ho¡
);

251 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
p
->doc_root);

254  
HANDLER_GO_ON
;

258 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, cÚ->
uri
.
authÜ™y
);

259 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, 
p
->doc_root);

262 
	`bufãr_cİy_bufãr
(
p
->
cÚf
.
doüoÙ_ÿche_key
, 
cÚ
->
uri
.
authÜ™y
);

263 
	`bufãr_cİy_bufãr
(
p
->
cÚf
.
doüoÙ_ÿche_v®ue
,…->
doc_roÙ
);

264 
	`bufãr_cİy_bufãr
(
p
->
cÚf
.
doüoÙ_ÿche_£rv”Çme
, 
cÚ
->
£rv”_Çme
);

267  
HANDLER_GO_ON
;

268 
	}
}

271 
mod_sim¶e_vho¡_¶ugš_š™
(
¶ugš
 *
p
);

272 
	$mod_sim¶e_vho¡_¶ugš_š™
(
¶ugš
 *
p
) {

273 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

274 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("simple_vhost");

276 
p
->
š™
 = 
mod_sim¶e_vho¡_š™
;

277 
p
->
£t_deçuÉs
 = 
mod_sim¶e_vho¡_£t_deçuÉs
;

278 
p
->
hªdË_doüoÙ
 = 
mod_sim¶e_vho¡_doüoÙ
;

279 
p
->
ş—nup
 = 
mod_sim¶e_vho¡_ä“
;

281 
p
->
d©a
 = 
NULL
;

284 
	}
}

	@mod_skeleton.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~<ùy³.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

29 
¬¿y
 *
	mm©ch
;

30 } 
	t¶ugš_cÚfig
;

33 
	mPLUGIN_DATA
;

35 
bufãr
 *
	mm©ch_buf
;

37 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

39 
¶ugš_cÚfig
 
	mcÚf
;

40 } 
	t¶ugš_d©a
;

43 
size_t
 
	mfoo
;

44 } 
	thªdËr_ùx
;

46 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
() {

47 
hªdËr_ùx
 * 
hùx
;

49 
hùx
 = 
	`ÿÎoc
(1, (*hctx));

51  
hùx
;

52 
	}
}

54 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

56 
	`ä“
(
hùx
);

57 
	}
}

60 
	$INIT_FUNC
(
mod_sk–‘Ú_š™
) {

61 
¶ugš_d©a
 *
p
;

63 
p
 = 
	`ÿÎoc
(1, (*p));

65 
p
->
m©ch_buf
 = 
	`bufãr_š™
();

67  
p
;

68 
	}
}

71 
	$FREE_FUNC
(
mod_sk–‘Ú_ä“
) {

72 
¶ugš_d©a
 *
p
 = 
p_d
;

74 
	`UNUSED
(
¤v
);

76 ià(!
p
è 
HANDLER_GO_ON
;

78 ià(
p
->
cÚfig_¡Üage
) {

79 
size_t
 
i
;

81 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

82 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

84 ià(
NULL
 =ğ
s
) ;

86 
	`¬¿y_ä“
(
s
->
m©ch
);

88 
	`ä“
(
s
);

90 
	`ä“
(
p
->
cÚfig_¡Üage
);

93 
	`bufãr_ä“
(
p
->
m©ch_buf
);

95 
	`ä“
(
p
);

97  
HANDLER_GO_ON
;

98 
	}
}

102 
	$SETDEFAULTS_FUNC
(
mod_sk–‘Ú_£t_deçuÉs
) {

103 
¶ugš_d©a
 *
p
 = 
p_d
;

104 
size_t
 
i
 = 0;

106 
cÚfig_v®ues_t
 
cv
[] = {

107 { "sk–‘Ú.¬¿y", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

108 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

111 ià(!
p
è 
HANDLER_ERROR
;

113 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

115 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

116 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

117 
¶ugš_cÚfig
 *
s
;

119 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

120 
s
->
m©ch
 = 
	`¬¿y_š™
();

122 
cv
[0].
de¡š©iÚ
 = 
s
->
m©ch
;

124 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

126 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

127  
HANDLER_ERROR
;

131  
HANDLER_GO_ON
;

132 
	}
}

134 
	#PATCH
(
x
) \

135 
p
->
cÚf
.
x
 = 
s
->x;

	)

136 
	$mod_sk–‘Ú_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

137 
size_t
 
i
, 
j
;

138 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

140 
	`PATCH
(
m©ch
);

143 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

144 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

145 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

148 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

151 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

152 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

154 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("skeleton.array"))) {

155 
	`PATCH
(
m©ch
);

161 
	}
}

162 #undeà
PATCH


164 
	$URIHANDLER_FUNC
(
mod_sk–‘Ú_uri_hªdËr
) {

165 
¶ugš_d©a
 *
p
 = 
p_d
;

166 
size_t
 
s_Ën
;

167 
size_t
 
k
;

169 
	`UNUSED
(
¤v
);

171 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

173 
s_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
);

174 ià(0 =ğ
s_Ën
è 
HANDLER_GO_ON
;

176 
	`mod_sk–‘Ú_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

178 
k
 = 0; k < 
p
->
cÚf
.
m©ch
->
u£d
; k++) {

179 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
m©ch
->
d©a
[
k
];

180 
size_t
 
ù_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

182 ià(
ù_Ën
 > 
s_Ën
) ;

183 ià(
ù_Ën
 == 0) ;

185 ià(0 =ğ
	`¡ºcmp
(
cÚ
->
uri
.
·th
->
±r
 + 
s_Ën
 - 
ù_Ën
, 
ds
->
v®ue
->ptr, ct_len)) {

186 
cÚ
->
h‰p_¡©us
 = 403;

188  
HANDLER_FINISHED
;

193  
HANDLER_GO_ON
;

194 
	}
}

198 
	$mod_sk–‘Ú_¶ugš_š™
(
¶ugš
 *
p
) {

199 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

200 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("skeleton");

202 
p
->
š™
 = 
mod_sk–‘Ú_š™
;

203 
p
->
hªdË_uri_ş—n
 = 
mod_sk–‘Ú_uri_hªdËr
;

204 
p
->
£t_deçuÉs
 = 
mod_sk–‘Ú_£t_deçuÉs
;

205 
p
->
ş—nup
 = 
mod_sk–‘Ú_ä“
;

207 
p
->
d©a
 = 
NULL
;

210 
	}
}

	@mod_ssi.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"»¥Ú£.h
"

11 
	~"mod_ssi.h
"

13 
	~"š‘_Áİ_ÿche.h
"

15 
	~"sys-sock‘.h
"

17 
	~<sys/ty³s.h
>

19 
	~<ùy³.h
>

20 
	~<¡dlib.h
>

21 
	~<¡dio.h
>

22 
	~<¡ršg.h
>

23 
	~<¡ršgs.h
>

24 
	~<”ºo.h
>

25 
	~<fú.h
>

26 
	~<time.h
>

27 
	~<uni¡d.h
>

29 #ifdeà
HAVE_PWD_H


30 
	~<pwd.h
>

33 #ifdeà
HAVE_FORK


34 
	~<sys/wa™.h
>

37 #ifdeà
HAVE_SYS_FILIO_H


38 
	~<sys/fio.h
>

41 
	~"‘ag.h
"

43 
hªdËr_ùx
 * 
	$hªdËr_ùx_š™
(
¶ugš_d©a
 *
p
) {

44 
hªdËr_ùx
 *
hùx
 = 
	`ÿÎoc
(1, (*hctx));

45 
	`fÜû_as£¹
(
hùx
);

46 
hùx
->
timefmt
 = 
p
->timefmt;

47 
hùx
->
¡©_â
 = 
p
->stat_fn;

48 
hùx
->
ssi_v¬s
 = 
p
->ssi_vars;

49 
hùx
->
ssi_cgi_’v
 = 
p
->ssi_cgi_env;

50 
	`memıy
(&
hùx
->
cÚf
, &
p
->cÚf, (
¶ugš_cÚfig
));

51  
hùx
;

52 
	}
}

54 
	$hªdËr_ùx_ä“
(
hªdËr_ùx
 *
hùx
) {

55 
	`ä“
(
hùx
);

56 
	}
}

59 vŞ©
time_t
 
	gšşude_fe_Ï¡_mtime
 = 0;

62 
	$INIT_FUNC
(
mod_ssi_š™
) {

63 
¶ugš_d©a
 *
p
;

65 
p
 = 
	`ÿÎoc
(1, (*p));

67 
p
->
timefmt
 = 
	`bufãr_š™
();

68 
p
->
¡©_â
 = 
	`bufãr_š™
();

70 
p
->
ssi_v¬s
 = 
	`¬¿y_š™
();

71 
p
->
ssi_cgi_’v
 = 
	`¬¿y_š™
();

73  
p
;

74 
	}
}

77 
	$FREE_FUNC
(
mod_ssi_ä“
) {

78 
¶ugš_d©a
 *
p
 = 
p_d
;

79 
	`UNUSED
(
¤v
);

81 ià(!
p
è 
HANDLER_GO_ON
;

83 ià(
p
->
cÚfig_¡Üage
) {

84 
size_t
 
i
;

85 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

86 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

88 ià(
NULL
 =ğ
s
) ;

90 
	`¬¿y_ä“
(
s
->
ssi_ex‹nsiÚ
);

91 
	`bufãr_ä“
(
s
->
cÚ‹Á_ty³
);

93 
	`ä“
(
s
);

95 
	`ä“
(
p
->
cÚfig_¡Üage
);

98 
	`¬¿y_ä“
(
p
->
ssi_v¬s
);

99 
	`¬¿y_ä“
(
p
->
ssi_cgi_’v
);

100 
	`bufãr_ä“
(
p
->
timefmt
);

101 
	`bufãr_ä“
(
p
->
¡©_â
);

103 
	`ä“
(
p
);

105  
HANDLER_GO_ON
;

106 
	}
}

110 
	$SETDEFAULTS_FUNC
(
mod_ssi_£t_deçuÉs
) {

111 
¶ugš_d©a
 *
p
 = 
p_d
;

112 
size_t
 
i
 = 0;

114 
cÚfig_v®ues_t
 
cv
[] = {

115 { "ssi.ex‹nsiÚ", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

116 { "ssi.cÚ‹Á-ty³", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

117 { "ssi.cÚd™iÚ®-»que¡s", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

118 { "ssi.exec", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

119 { "ssi.»cursiÚ-max", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

120 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

123 ià(!
p
è 
HANDLER_ERROR
;

125 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

127 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

128 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

129 
¶ugš_cÚfig
 *
s
;

131 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

132 
s
->
ssi_ex‹nsiÚ
 = 
	`¬¿y_š™
();

133 
s
->
cÚ‹Á_ty³
 = 
	`bufãr_š™
();

134 
s
->
cÚd™iÚ®_»que¡s
 = 0;

135 
s
->
ssi_exec
 = 1;

136 
s
->
ssi_»cursiÚ_max
 = 0;

138 
cv
[0].
de¡š©iÚ
 = 
s
->
ssi_ex‹nsiÚ
;

139 
cv
[1].
de¡š©iÚ
 = 
s
->
cÚ‹Á_ty³
;

140 
cv
[2].
de¡š©iÚ
 = &(
s
->
cÚd™iÚ®_»que¡s
);

141 
cv
[3].
de¡š©iÚ
 = &(
s
->
ssi_exec
);

142 
cv
[4].
de¡š©iÚ
 = &(
s
->
ssi_»cursiÚ_max
);

144 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

146 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

147  
HANDLER_ERROR
;

151  
HANDLER_GO_ON
;

152 
	}
}

155 
	$ssi_’v_add
(*
v’v
, cÚ¡ *
key
, 
size_t
 
kËn
, cÚ¡ *
v®
, size_ˆ
vËn
) {

156 
¬¿y
 *
’v
 = 
v’v
;

157 
d©a_¡ršg
 *
ds
;

160 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
’v
, 
TYPE_STRING
))) {

161 
ds
 = 
	`d©a_¡ršg_š™
();

163 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
kËn
);

164 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
v®
, 
vËn
);

166 
	`¬¿y_š£¹_unique
(
’v
, (
d©a_un£t
 *)
ds
);

169 
	}
}

171 
	$bud_ssi_cgi_v¬s
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
) {

172 
h‰p_cgi_İts
 
İts
 = { 0, 0, 
NULL
, NULL };

175 
d©a_¡ršg
 *
ds_auth
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Authorization");

176 
bufãr
 *
b_auth
 = 
NULL
;

177 ià(
ds_auth
) {

178 
b_auth
 = 
ds_auth
->
v®ue
;

179 
ds_auth
->
v®ue
 = 
NULL
;

182 
	`¬¿y_»£t
(
p
->
ssi_cgi_’v
);

184 ià(0 !ğ
	`h‰p_cgi_h—d”s
(
¤v
, 
cÚ
, &
İts
, 
ssi_’v_add
, 
p
->
ssi_cgi_’v
)) {

185 
cÚ
->
h‰p_¡©us
 = 400;

189 ià(
ds_auth
) {

190 
ds_auth
->
v®ue
 = 
b_auth
;

194 
	}
}

196 
mod_ssi_´oûss_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, 
¡©
 *
¡
);

198 
	$´oûss_ssi_¡mt
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, cÚ¡ **
l
, 
size_t
 
n
, 
¡©
 *
¡
) {

259 
size_t
 
i
, 
ssicmd
 = 0;

260 
buf
[255];

261 
bufãr
 *
b
 = 
NULL
;

264 cÚ¡ *
v¬
;

265 ’um { 
SSI_UNSET
, 
SSI_ECHO
, 
SSI_FSIZE
, 
SSI_INCLUDE
, 
SSI_FLASTMOD
,

266 
SSI_CONFIG
, 
SSI_PRINTENV
, 
SSI_SET
, 
SSI_IF
, 
SSI_ELIF
,

267 
SSI_ELSE
, 
SSI_ENDIF
, 
SSI_EXEC
, 
SSI_COMMENT
 } 
ty³
;

268 } 
ssicmds
[] = {

269 { "echo", 
SSI_ECHO
 },

270 { "šşude", 
SSI_INCLUDE
 },

271 { "æa¡mod", 
SSI_FLASTMOD
 },

272 { "fsize", 
SSI_FSIZE
 },

273 { "cÚfig", 
SSI_CONFIG
 },

274 { "´š‹nv", 
SSI_PRINTENV
 },

275 { "£t", 
SSI_SET
 },

276 { "if", 
SSI_IF
 },

277 { "–if", 
SSI_ELIF
 },

278 { "’dif", 
SSI_ENDIF
 },

279 { "–£", 
SSI_ELSE
 },

280 { "exec", 
SSI_EXEC
 },

281 { "comm’t", 
SSI_COMMENT
 },

283 { 
NULL
, 
SSI_UNSET
 }

286 
i
 = 0; 
ssicmds
[i].
v¬
; i++) {

287 ià(0 =ğ
	`¡rcmp
(
l
[1], 
ssicmds
[
i
].
v¬
)) {

288 
ssicmd
 = 
ssicmds
[
i
].
ty³
;

293 
ssicmd
) {

294 
SSI_ECHO
: {

296 
v¬
 = 0;

298 cÚ¡ *
v¬_v®
 = 
NULL
;

301 cÚ¡ *
v¬
;

303 
SSI_ECHO_UNSET
,

304 
SSI_ECHO_DATE_GMT
,

305 
SSI_ECHO_DATE_LOCAL
,

306 
SSI_ECHO_DOCUMENT_NAME
,

307 
SSI_ECHO_DOCUMENT_URI
,

308 
SSI_ECHO_LAST_MODIFIED
,

309 
SSI_ECHO_USER_NAME
,

310 
SSI_ECHO_SCRIPT_URI
,

311 
SSI_ECHO_SCRIPT_URL
,

312 } 
ty³
;

313 } 
echov¬s
[] = {

314 { "DATE_GMT", 
SSI_ECHO_DATE_GMT
 },

315 { "DATE_LOCAL", 
SSI_ECHO_DATE_LOCAL
 },

316 { "DOCUMENT_NAME", 
SSI_ECHO_DOCUMENT_NAME
 },

317 { "DOCUMENT_URI", 
SSI_ECHO_DOCUMENT_URI
 },

318 { "LAST_MODIFIED", 
SSI_ECHO_LAST_MODIFIED
 },

319 { "USER_NAME", 
SSI_ECHO_USER_NAME
 },

320 { "SCRIPT_URI", 
SSI_ECHO_SCRIPT_URI
 },

321 { "SCRIPT_URL", 
SSI_ECHO_SCRIPT_URL
 },

323 { 
NULL
, 
SSI_ECHO_UNSET
 }

339 
i
 = 2; i < 
n
; i += 2) {

340 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "var")) {

341 
j
;

343 
v¬_v®
 = 
l
[
i
+1];

345 
j
 = 0; 
echov¬s
[j].
v¬
; j++) {

346 ià(0 =ğ
	`¡rcmp
(
l
[
i
+1], 
echov¬s
[
j
].
v¬
)) {

347 
v¬
 = 
echov¬s
[
j
].
ty³
;

351 } ià(0 =ğ
	`¡rcmp
(
l
[
i
], "encoding")) {

363 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

365 
l
[1],†[
i
]);

369 ià(
p
->
if_is_çl£
) ;

371 ià(!
v¬_v®
) {

372 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

374 
l
[1], "var is missing");

378 
v¬
) {

379 
SSI_ECHO_USER_NAME
: {

380 
·sswd
 *
pw
;

382 
b
 = 
	`bufãr_š™
();

383 #ifdeà
HAVE_PWD_H


384 ià(
NULL
 =ğ(
pw
 = 
	`g‘pwuid
(
¡
->
¡_uid
))) {

385 
	`bufãr_cİy_št
(
b
, 
¡
->
¡_uid
);

387 
	`bufãr_cİy_¡ršg
(
b
, 
pw
->
pw_Çme
);

390 
	`bufãr_cİy_št
(
b
, 
¡
->
¡_uid
);

392 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

393 
	`bufãr_ä“
(
b
);

396 
SSI_ECHO_LAST_MODIFIED
: {

397 
time_t
 
t
 = 
¡
->
¡_mtime
;

399 ià(0 =ğ
	`¡ráime
(
buf
, (buf), 
p
->
timefmt
->
±r
, 
	`loÿÉime
(&
t
))) {

400 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(none)"));

402 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
, 
	`¡¾’
(buf));

406 
SSI_ECHO_DATE_LOCAL
: {

407 
time_t
 
t
 = 
	`time
(
NULL
);

409 ià(0 =ğ
	`¡ráime
(
buf
, (buf), 
p
->
timefmt
->
±r
, 
	`loÿÉime
(&
t
))) {

410 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(none)"));

412 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
, 
	`¡¾’
(buf));

416 
SSI_ECHO_DATE_GMT
: {

417 
time_t
 
t
 = 
	`time
(
NULL
);

419 ià(0 =ğ
	`¡ráime
(
buf
, (buf), 
p
->
timefmt
->
±r
, 
	`gmtime
(&
t
))) {

420 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(none)"));

422 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
, 
	`¡¾’
(buf));

426 
SSI_ECHO_DOCUMENT_NAME
: {

427 *
¦
;

429 ià(
NULL
 =ğ(
¦
 = 
	`¡¼chr
(
cÚ
->
physiÿl
.
·th
->
±r
, '/'))) {

430 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
physiÿl
.
·th
));

432 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
¦
 + 1, 
	`¡¾’
(sl + 1));

436 
SSI_ECHO_DOCUMENT_URI
: {

437 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
uri
.
·th
));

440 
SSI_ECHO_SCRIPT_URI
: {

441 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
scheme
è&& !bufãr_¡ršg_is_em±y(cÚ->uri.
authÜ™y
)) {

442 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
uri
.
scheme
));

443 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("://"));

444 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
uri
.
authÜ™y
));

445 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
»que¡
.
uri
));

446 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
)) {

447 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("?"));

448 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
uri
.
qu”y
));

453 
SSI_ECHO_SCRIPT_URL
: {

454 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
»que¡
.
uri
));

455 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
)) {

456 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("?"));

457 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(cÚ->
uri
.
qu”y
));

462 
d©a_¡ršg
 *
ds
;

465 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
p
->
ssi_cgi_’v
, 
v¬_v®
)) ||

466 
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
p
->
ssi_v¬s
, 
v¬_v®
))) {

467 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
));

469 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(none)"));

477 
SSI_INCLUDE
:

478 
SSI_FLASTMOD
:

479 
SSI_FSIZE
: {

480 cÚ¡ * 
fe_·th
 = 
NULL
, *
vœt_·th
 = NULL;

481 
¡©
 
¡b
;

482 *
¦
;

484 
i
 = 2; i < 
n
; i += 2) {

485 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "file")) {

486 
fe_·th
 = 
l
[
i
+1];

487 } ià(0 =ğ
	`¡rcmp
(
l
[
i
], "virtual")) {

488 
vœt_·th
 = 
l
[
i
+1];

490 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

492 
l
[1],†[
i
]);

496 ià(!
fe_·th
 && !
vœt_·th
) {

497 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

499 
l
[1], "file or virtual‡re missing");

503 ià(
fe_·th
 && 
vœt_·th
) {

504 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

506 
l
[1], "only one of file‡nd virtual is‡llowed here");

511 ià(
p
->
if_is_çl£
) ;

513 ià(
fe_·th
) {

515 ià(
NULL
 =ğ(
¦
 = 
	`¡¼chr
(
cÚ
->
physiÿl
.
·th
->
±r
, '/'))) {

516 
	`bufãr_cİy_¡ršg_Ën
(
p
->
¡©_â
, 
	`CONST_STR_LEN
("/"));

518 
	`bufãr_cİy_¡ršg_Ën
(
p
->
¡©_â
, 
cÚ
->
physiÿl
.
·th
->
±r
, 
¦
 - con->physical.path->ptr + 1);

521 
	`bufãr_cİy_¡ršg
(
¤v
->
tmp_buf
, 
fe_·th
);

522 
	`bufãr_u¾decode_·th
(
¤v
->
tmp_buf
);

523 
	`bufãr_·th_sim¶ify
(
¤v
->
tmp_buf
, srv->tmp_buf);

524 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
¡©_â
, 
¤v
->
tmp_buf
);

527 
size_t
 
»maš
;

529 ià(
vœt_·th
[0] == '/') {

530 
	`bufãr_cİy_¡ršg
(
p
->
¡©_â
, 
vœt_·th
);

533 
¦
 = 
	`¡¼chr
(
cÚ
->
uri
.
·th
->
±r
, '/');

535 
	`bufãr_cİy_¡ršg_Ën
(
p
->
¡©_â
, 
cÚ
->
uri
.
·th
->
±r
, 
¦
 - con->uri.path->ptr + 1);

536 
	`bufãr_­³nd_¡ršg
(
p
->
¡©_â
, 
vœt_·th
);

539 
	`bufãr_u¾decode_·th
(
p
->
¡©_â
);

540 
	`bufãr_·th_sim¶ify
(
¤v
->
tmp_buf
, 
p
->
¡©_â
);

562 cÚ¡ *
£p
, *
£p2
;

563 
£p
 = 
cÚ
->
uri
.
·th
->
±r
;

564 
£p2
 = 
¤v
->
tmp_buf
->
±r
;

565 
i
 = 0; 
£p
[i] && s•[i] =ğ
£p2
[i]; ++i) ;

566 
i
 !ğ0 && 
£p
[--i] != '/') ;

568 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

569 
	`bufãr_to_low”
(
¤v
->
tmp_buf
);

571 
»maš
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
è- 
i
;

572 ià(!
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames


573 ? 
	`bufãr_is_equ®_right_Ën
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
»l_·th
, 
»maš
)

574 :(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
physiÿl
.
·th
è>ğ
»maš


575 && 0 =ğ
	`¡ºÿ£cmp
(
cÚ
->
physiÿl
.
·th
->
±r
+
	`bufãr_¡ršg_Ëngth
(cÚ->physiÿl.·th)-
»maš
, cÚ->physiÿl.
»l_·th
->±r+
i
,„emain))) {

576 
	`bufãr_cİy_¡ršg_Ën
(
p
->
¡©_â
, 
cÚ
->
physiÿl
.
·th
->
±r
, 
	`bufãr_¡ršg_Ëngth
(cÚ->physiÿl.·th)-
»maš
);

577 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
¡©_â
, 
¤v
->
tmp_buf
->
±r
+
i
, 
	`bufãr_¡ršg_Ëngth
(srv->tmp_buf)-i);

581 
	`bufãr_cİy_bufãr
(
p
->
¡©_â
, 
cÚ
->
physiÿl
.
doc_roÙ
);

582 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
¡©_â
, 
¤v
->
tmp_buf
);

586 ià(0 =ğ
	`¡©
(
p
->
¡©_â
->
±r
, &
¡b
)) {

587 
time_t
 
t
 = 
¡b
.
¡_mtime
;

589 
ssicmd
) {

590 
SSI_FSIZE
:

591 
b
 = 
	`bufãr_š™
();

592 ià(
p
->
sizefmt
) {

593 
j
 = 0;

594 cÚ¡ *
abr
[] = { " B", " kB", " MB", " GB", " TB", 
NULL
 };

596 
off_t
 
s
 = 
¡b
.
¡_size
;

598 
j
 = 0; 
s
 > 1024 && 
abr
[j+1]; s /= 1024, j++);

600 
	`bufãr_cİy_št
(
b
, 
s
);

601 
	`bufãr_­³nd_¡ršg
(
b
, 
abr
[
j
]);

603 
	`bufãr_cİy_št
(
b
, 
¡b
.
¡_size
);

605 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

606 
	`bufãr_ä“
(
b
);

608 
SSI_FLASTMOD
:

609 ià(0 =ğ
	`¡ráime
(
buf
, (buf), 
p
->
timefmt
->
±r
, 
	`loÿÉime
(&
t
))) {

610 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(none)"));

612 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
, 
	`¡¾’
(buf));

615 
SSI_INCLUDE
:

617 ià(
¡b
.
¡_mtime
 > 
šşude_fe_Ï¡_mtime
)

618 
šşude_fe_Ï¡_mtime
 = 
¡b
.
¡_mtime
;

620 ià(
fe_·th
 || 0 =ğ
p
->
cÚf
.
ssi_»cursiÚ_max
) {

622 
	`chunkqueue_­³nd_fe
(
cÚ
->
wr™e_queue
, 
p
->
¡©_â
, 0, 
¡b
.
¡_size
);

624 
bufãr
 *
up§ve
, *
µ§ve
, *
´p§ve
;

627 ià(
p
->
ssi_»cursiÚ_d•th
 >ğp->
cÚf
.
ssi_»cursiÚ_max
) {

628 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(error: include directives„ecurse deeperhan…re-defined ssi.recursion-max)"));

633 ià(
	`bufãr_is_equ®
(
cÚ
->
physiÿl
.
·th
, 
p
->
¡©_â
)) {

634 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("(error: include directives create‡n infinite†oop)"));

643 
up§ve
 = 
cÚ
->
uri
.
·th
;

644 
µ§ve
 = 
cÚ
->
physiÿl
.
·th
;

645 
´p§ve
 = 
cÚ
->
physiÿl
.
»l_·th
;

647 
cÚ
->
physiÿl
.
·th
 = 
p
->
¡©_â
;

648 
p
->
¡©_â
 = 
	`bufãr_š™
();

650 
cÚ
->
uri
.
·th
 = cÚ->
physiÿl
.
»l_·th
 = 
	`bufãr_š™_bufãr
(
¤v
->
tmp_buf
);

653 ++
p
->
ssi_»cursiÚ_d•th
;

654 
	`mod_ssi_´oûss_fe
(
¤v
, 
cÚ
, 
p
, &
¡b
);

655 --
p
->
ssi_»cursiÚ_d•th
;

657 
	`bufãr_ä“
(
cÚ
->
uri
.
·th
);

658 
cÚ
->
uri
.
·th
 = 
up§ve
;

659 
cÚ
->
physiÿl
.
»l_·th
 = 
´p§ve
;

661 
	`bufãr_ä“
(
p
->
¡©_â
);

662 
p
->
¡©_â
 = 
cÚ
->
physiÿl
.
·th
;

663 
cÚ
->
physiÿl
.
·th
 = 
µ§ve
;

669 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

671 
p
->
¡©_â
, 
	`¡»¼Ü
(
”ºo
));

675 
SSI_SET
: {

676 cÚ¡ *
key
 = 
NULL
, *
v®
 = NULL;

677 
i
 = 2; i < 
n
; i += 2) {

678 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "var")) {

679 
key
 = 
l
[
i
+1];

680 } ià(0 =ğ
	`¡rcmp
(
l
[
i
], "value")) {

681 
v®
 = 
l
[
i
+1];

683 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

685 
l
[1],†[
i
]);

689 ià(
p
->
if_is_çl£
) ;

691 ià(
key
 && 
v®
) {

692 
d©a_¡ršg
 *
ds
;

694 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
p
->
ssi_v¬s
, 
TYPE_STRING
))) {

695 
ds
 = 
	`d©a_¡ršg_š™
();

697 
	`bufãr_cİy_¡ršg
(
ds
->
key
, key);

698 
	`bufãr_cİy_¡ršg
(
ds
->
v®ue
, 
v®
);

700 
	`¬¿y_š£¹_unique
(
p
->
ssi_v¬s
, (
d©a_un£t
 *)
ds
);

701 } ià(
key
 || 
v®
) {

702 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sSSss",

703 "ssi: v¬‡nd v®uhavtØb£ˆš <!--#£t", 
l
[1], "=",†[2], "-->");

705 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

710 
SSI_CONFIG
:

711 ià(
p
->
if_is_çl£
) ;

713 
i
 = 2; i < 
n
; i += 2) {

714 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "timefmt")) {

715 
	`bufãr_cİy_¡ršg
(
p
->
timefmt
, 
l
[
i
+1]);

716 } ià(0 =ğ
	`¡rcmp
(
l
[
i
], "sizefmt")) {

717 ià(0 =ğ
	`¡rcmp
(
l
[
i
+1], "abbrev")) {

718 
p
->
sizefmt
 = 1;

719 } ià(0 =ğ
	`¡rcmp
(
l
[
i
+1], "bytes")) {

720 
p
->
sizefmt
 = 0;

722 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssss",

724 
l
[
i
],

726 
l
[1],†[
i
+1]);

729 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

731 
l
[1],†[
i
]);

735 
SSI_PRINTENV
:

736 ià(
p
->
if_is_çl£
) ;

738 
b
 = 
	`bufãr_š™
();

739 
i
 = 0; i < 
p
->
ssi_v¬s
->
u£d
; i++) {

740 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
ssi_v¬s
->
d©a
[p->ssi_v¬s->
sÜ‹d
[
i
]];

742 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
key
);

743 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("="));

744 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
), 
ENCODING_MINIMAL_XML
);

745 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

747 
i
 = 0; i < 
p
->
ssi_cgi_’v
->
u£d
; i++) {

748 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
ssi_cgi_’v
->
d©a
[p->ssi_cgi_’v->
sÜ‹d
[
i
]];

750 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
key
);

751 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("="));

752 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
), 
ENCODING_MINIMAL_XML
);

753 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

755 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

756 
	`bufãr_ä“
(
b
);

759 
SSI_EXEC
: {

760 cÚ¡ *
cmd
 = 
NULL
;

761 
pid_t
 
pid
;

762 
äom_exec_fds
[2];

764 ià(!
p
->
cÚf
.
ssi_exec
) {

768 
i
 = 2; i < 
n
; i += 2) {

769 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "cmd")) {

770 
cmd
 = 
l
[
i
+1];

772 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

774 
l
[1],†[
i
]);

778 ià(
p
->
if_is_çl£
) ;

785 ià(!
cmd
) ;

786 #ifdeà
HAVE_FORK


787 ià(
	`pe
(
äom_exec_fds
)) {

788 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

789 "pçed: ", 
	`¡»¼Ü
(
”ºo
));

794 
pid
 = 
	`fÜk
()) {

797 
	`şo£
(
STDOUT_FILENO
);

798 
	`dup2
(
äom_exec_fds
[1], 
STDOUT_FILENO
);

799 
	`şo£
(
äom_exec_fds
[1]);

801 
	`şo£
(
äom_exec_fds
[0]);

804 
	`şo£
(
STDIN_FILENO
);

806 
	`exeş
("/bš/sh", "sh", "-c", 
cmd
, (*)
NULL
);

808 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss", "¥awšgƒxeøçed:", 
	`¡»¼Ü
(
”ºo
), 
cmd
);

811 
	`SEGFAULT
();

816 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fÜk faed:", 
	`¡»¼Ü
(
”ºo
));

820 
¡©us
;

821 
ssize_t
 
r
;

822 
was_š‹¼u±ed
 = 0;

824 
	`şo£
(
äom_exec_fds
[1]);

832 ià(-1 =ğ
	`wa™pid
(
pid
, &
¡©us
, 0)) {

833 ià(
”ºo
 =ğ
EINTR
) {

834 
was_š‹¼u±ed
++;

836 
was_š‹¼u±ed
 = 0;

837 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "wa™pid faed:", 
	`¡»¼Ü
(
”ºo
));

839 } ià(
	`WIFEXITED
(
¡©us
)) {

840 
tÜ—d
;

842 
was_š‹¼u±ed
 = 0;

845 ià(
	`ioùl
(
äom_exec_fds
[0], 
FIONREAD
, &
tÜ—d
)) {

846 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

851 ià(
tÜ—d
 > 0) {

852 *
mem
;

853 
size_t
 
mem_Ën
;

855 
	`chunkqueue_g‘_memÜy
(
cÚ
->
wr™e_queue
, &
mem
, &
mem_Ën
, 0, 
tÜ—d
);

856 
r
 = 
	`»ad
(
äom_exec_fds
[0], 
mem
, 
mem_Ën
);

857 
	`chunkqueue_u£_memÜy
(
cÚ
->
wr™e_queue
, 
r
 > 0 ?„ : 0);

859 ià(
r
 < 0) ;

865 
was_š‹¼u±ed
 = 0;

866 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "processƒxited‡bnormally");

868 } 
was_š‹¼u±ed
 > 0 && was_interrupted < 4);

870 
	`şo£
(
äom_exec_fds
[0]);

882 
SSI_IF
: {

883 cÚ¡ *
ex´
 = 
NULL
;

885 
i
 = 2; i < 
n
; i += 2) {

886 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "expr")) {

887 
ex´
 = 
l
[
i
+1];

889 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

891 
l
[1],†[
i
]);

895 ià(!
ex´
) {

896 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

898 
l
[1], "expr missing");

902 ià((!
p
->
if_is_çl£
) &&

903 ((
p
->
if_is_çl£_Ëv–
 == 0) ||

904 (
p
->
if_Ëv–
 <…->
if_is_çl£_Ëv–
))) {

905 
	`ssi_ev®_ex´
(
¤v
, 
cÚ
, 
p
, 
ex´
)) {

908 
p
->
if_is_çl£
 = 1;

909 
p
->
if_is_çl£_Ëv–
 =…->
if_Ëv–
;

912 
p
->
if_is_çl£
 = 0;

917 
p
->
if_Ëv–
++;

921 
SSI_ELSE
:

922 
p
->
if_Ëv–
--;

924 ià(
p
->
if_is_çl£
) {

925 ià((
p
->
if_Ëv–
 =ğp->
if_is_çl£_Ëv–
) &&

926 (
p
->
if_is_çl£_’dif
 == 0)) {

927 
p
->
if_is_çl£
 = 0;

930 
p
->
if_is_çl£
 = 1;

932 
p
->
if_is_çl£_Ëv–
 =…->
if_Ëv–
;

934 
p
->
if_Ëv–
++;

937 
SSI_ELIF
: {

938 cÚ¡ *
ex´
 = 
NULL
;

939 
i
 = 2; i < 
n
; i += 2) {

940 ià(0 =ğ
	`¡rcmp
(
l
[
i
], "expr")) {

941 
ex´
 = 
l
[
i
+1];

943 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

945 
l
[1],†[
i
]);

949 ià(!
ex´
) {

950 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sss",

952 
l
[1], "expr missing");

956 
p
->
if_Ëv–
--;

958 ià(
p
->
if_Ëv–
 =ğp->
if_is_çl£_Ëv–
) {

959 ià((
p
->
if_is_çl£
) &&

960 (
p
->
if_is_çl£_’dif
 == 0)) {

961 
	`ssi_ev®_ex´
(
¤v
, 
cÚ
, 
p
, 
ex´
)) {

964 
p
->
if_is_çl£
 = 1;

965 
p
->
if_is_çl£_Ëv–
 =…->
if_Ëv–
;

968 
p
->
if_is_çl£
 = 0;

972 
p
->
if_is_çl£
 = 1;

973 
p
->
if_is_çl£_Ëv–
 =…->
if_Ëv–
;

974 
p
->
if_is_çl£_’dif
 = 1;

978 
p
->
if_Ëv–
++;

982 
SSI_ENDIF
:

983 
p
->
if_Ëv–
--;

985 ià(
p
->
if_Ëv–
 =ğp->
if_is_çl£_Ëv–
) {

986 
p
->
if_is_çl£
 = 0;

987 
p
->
if_is_çl£_’dif
 = 0;

991 
SSI_COMMENT
:

994 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

996 
l
[1]);

1002 
	}
}

1004 
	$mod_ssi_·r£_ssi_¡mt_v®ue
(cÚ¡ * cÚ¡ 
s
, cÚ¡ 
Ën
) {

1005 
n
;

1006 cÚ¡ 
c
 = (
s
[0] == '"' ? '"' : s[0] == '\'' ? '\'' : 0);

1007 ià(0 !ğ
c
) {

1008 
n
 = 1;‚ < 
Ën
; ++n) {

1009 ià(
s
[
n
] =ğ
c
) ‚+1;

1010 ià(
s
[
n
] == '\\') {

1011 ià(
n
+1 =ğ
Ën
)  0;

1012 ++
n
;

1017 
n
 = 0;‚ < 
Ën
; ++n) {

1018 ià(
	`is¥aû
(
s
[
n
])) ‚;

1019 ià(
s
[
n
] == '\\') {

1020 ià(
n
+1 =ğ
Ën
)  0;

1021 ++
n
;

1024  
n
;

1026 
	}
}

1028 
	$mod_ssi_·r£_ssi_¡mt_ofæ’
(
o
[10], cÚ¡ * cÚ¡ 
s
, cÚ¡ 
Ën
) {

1035 
n
 = 5;

1036 
o
[0] = 
n
;

1037 ; 
	`light_i§Íha
(
s
[
n
]); ++n) ;

1038 
o
[1] = 
n
 - o[0];

1039 ià(0 =ğ
o
[1])  -1;

1041 ià(
n
+3 =ğ
Ën
)  2;

1042 ià(!
	`is¥aû
(
s
[
n
]))  -1;

1043 dØ{ ++
n
; } 
	`is¥aû
(
s
[n]));

1044 ià(
n
+3 =ğ
Ën
)  2;

1046 
o
[2] = 
n
;

1047 ; 
	`light_i§Íha
(
s
[
n
]); ++n) ;

1048 
o
[3] = 
n
 - o[2];

1049 ià(0 =ğ
o
[3] || 
s
[
n
++] != '=')  -1;

1051 
o
[4] = 
n
;

1052 
o
[5] = 
	`mod_ssi_·r£_ssi_¡mt_v®ue
(
s
+
n
, 
Ën
-n-3);

1053 ià(0 =ğ
o
[5])  -1;

1054 
n
 +ğ
o
[5];

1056 ià(
n
+3 =ğ
Ën
)  6;

1057 ià(!
	`is¥aû
(
s
[
n
]))  -1;

1058 dØ{ ++
n
; } 
	`is¥aû
(
s
[n]));

1059 ià(
n
+3 =ğ
Ën
)  6;

1061 
o
[6] = 
n
;

1062 ; 
	`light_i§Íha
(
s
[
n
]); ++n) ;

1063 
o
[7] = 
n
 - o[6];

1064 ià(0 =ğ
o
[7] || 
s
[
n
++] != '=')  -1;

1066 
o
[8] = 
n
;

1067 
o
[9] = 
	`mod_ssi_·r£_ssi_¡mt_v®ue
(
s
+
n
, 
Ën
-n-3);

1068 ià(0 =ğ
o
[9])  -1;

1069 
n
 +ğ
o
[9];

1071 ià(
n
+3 =ğ
Ën
)  10;

1072 ià(!
	`is¥aû
(
s
[
n
]))  -1;

1073 dØ{ ++
n
; } 
	`is¥aû
(
s
[n]));

1074 ià(
n
+3 =ğ
Ën
)  10;

1076 
	}
}

1078 
	$mod_ssi_·r£_ssi_¡mt
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, *
s
, 
Ën
, 
¡©
 *
¡
) {

1084 
o
[10];

1085 
m
;

1086 cÚ¡ 
n
 = 
	`mod_ssi_·r£_ssi_¡mt_ofæ’
(
o
, 
s
, 
Ën
);

1087 *
l
[6] = { 
s
, 
NULL
, NULL, NULL, NULL, NULL };

1088 ià(-1 =ğ
n
) {

1090 ià(
Ën
 >= 16

1091 && 0 =ğ
	`memcmp
(
s
+5, "comment", ("comment")-1)

1092 && (
s
[12] == ' ' || s[12] == '\t'))

1095 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
s
, 
Ën
);

1102 
l
[0] = 
	`m®loc
((
size_t
)(
Ën
+1));

1103 
	`memıy
(
l
[0], 
s
, (
size_t
)
Ën
);

1104 (
l
[0])[
Ën
] = '\0';

1108 
m
 = 0; m < 
n
; m += 2) {

1109 *
±r
 = 
s
+
o
[
m
];

1110 *
±r
) {

1112 '\'': (++
±r
)[
o
[
m
+1]-2] = '\0'; ;

1113 : 
±r
[
o
[
m
+1]] = '\0'; ;

1115 
l
[1+(
m
>>1)] = 
±r
;

1116 ià(
m
 == 4 || m == 8) {

1123 
	`´oûss_ssi_¡mt
(
¤v
, 
cÚ
, 
p
, (cÚ¡ **)
l
, 1+(
n
>>1), 
¡
);

1126 
	`ä“
(
l
[0]);

1128 
	}
}

1130 
	$mod_ssi_¡mt_Ën
(cÚ¡ *
s
, cÚ¡ 
Ën
) {

1132 
n
, 
sq
 = 0, 
dq
 = 0, 
bs
 = 0;

1133 
n
 = 5;‚ < 
Ën
; ++n) {

1134 
s
[
n
]) {

1138 ià(!
sq
 && !
dq
 && 
n
+2 < 
Ën
 && 
s
[n+1] == '-' && s[n+2] == '>') ‚+3;

1141 ià(!
sq
 && (!
dq
 || !
bs
)) dq = !dq;

1144 ià(!
dq
 && (!
sq
 || !
bs
)) sq = !sq;

1147 ià(
sq
 || 
dq
è
bs
 = !bs;

1152 
	}
}

1154 
	$mod_ssi_»ad_fd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, 
¡©
 *
¡
, 
fd
) {

1155 
ssize_t
 
rd
;

1156 
size_t
 
off£t
, 
´‘ag
;

1157 
size_t
 
bufsz
 = 8192;

1158 *
buf
 = 
	`m®loc
(
bufsz
);

1159 
	`fÜû_as£¹
(
buf
);

1161 
off£t
 = 0;

1162 
´‘ag
 = 0;

1163 0 < (
rd
 = 
	`»ad
(
fd
, 
buf
+
off£t
, 
bufsz
-offset))) {

1164 *
s
;

1165 
size_t
 
´–’
 = 0, 
Ën
;

1166 
off£t
 +ğ(
size_t
)
rd
;

1167 ; (
s
 = 
	`memchr
(
buf
+
´–’
, '<', 
off£t
-prelen)); ++prelen) {

1168 
´–’
 = 
s
 - 
buf
;

1169 ià(
´–’
 + 5 <ğ
off£t
) {

1170 ià(0 !ğ
	`memcmp
(
s
+1, 
	`CONST_STR_LEN
("!--#"))) ;

1172 ià(
´–’
 - 
´‘ag
 && !
p
->
if_is_çl£
) {

1173 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
+
´‘ag
, 
´–’
-pretag);

1176 
Ën
 = 
	`mod_ssi_¡mt_Ën
(
buf
+
´–’
, 
off£t
-prelen);

1177 ià(
Ën
) {

1178 
	`mod_ssi_·r£_ssi_¡mt
(
¤v
, 
cÚ
, 
p
, 
buf
+
´–’
, 
Ën
, 
¡
);

1179 
´–’
 +ğ(
Ën
 - 1);

1180 
´‘ag
 = 
´–’
 + 1;

1181 ià(
´‘ag
 =ğ
off£t
) {

1182 
off£t
 = 
´‘ag
 = 0;

1185 } ià(0 =ğ
´–’
 && 
off£t
 =ğ
bufsz
) {

1188 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("<!-- [anƒrror occurred: directiveoo†ong] "));

1191 ià(
buf
[
off£t
-2] == '-' && buf[offset-1] == '-') {

1192 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("--"));

1193 } ià(
buf
[
off£t
-1] == '-') {

1194 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("-"));

1196 
off£t
 = 
´‘ag
 = 0;

1199 
	`memmove
(
buf
, buf+
´–’
, (
off£t
 -=…relen));

1200 
´‘ag
 = 0;

1203 } ià(
´–’
 + 1 =ğ
off£t
 || 0 =ğ
	`memcmp
(
s
+1, "!--", offset -…relen - 1)) {

1204 ià(
´–’
 - 
´‘ag
 && !
p
->
if_is_çl£
) {

1205 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
+
´‘ag
, 
´–’
-pretag);

1207 
	`memıy
(
buf
, buf+
´–’
, (
off£t
 -=…relen));

1208 
´‘ag
 = 0;

1213 ià(
off£t
 =ğ
bufsz
) {

1214 ià(!
p
->
if_is_çl£
) {

1215 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
+
´‘ag
, 
off£t
-pretag);

1217 
off£t
 = 
´‘ag
 = 0;

1221 ià(0 !ğ
rd
) {

1222 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SsB", "»ad(): ", 
	`¡»¼Ü
(
”ºo
), 
cÚ
->
physiÿl
.
·th
);

1225 ià(
off£t
 - 
´‘ag
) {

1227 ià(!
p
->
if_is_çl£
) {

1228 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
buf
+
´‘ag
, 
off£t
-pretag);

1232 
	`ä“
(
buf
);

1233 
	}
}

1237 #ià
defšed
(
O_NONBLOCK
)

1238 
	#FIFO_NONBLOCK
 
O_NONBLOCK


	)

1240 
	#FIFO_NONBLOCK
 0

	)

1243 
	$mod_ssi_´oûss_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, 
¡©
 *
¡
) {

1244 
fd
 = 
	`İ’
(
cÚ
->
physiÿl
.
·th
->
±r
, 
O_RDONLY
 | 
FIFO_NONBLOCK
);

1245 ià(-1 =ğ
fd
) {

1246 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SsB", "open(): ",

1247 
	`¡»¼Ü
(
”ºo
), 
cÚ
->
physiÿl
.
·th
);

1251 ià(0 !ğ
	`f¡©
(
fd
, 
¡
)) {

1252 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SsB", "fstat(): ",

1253 
	`¡»¼Ü
(
”ºo
), 
cÚ
->
physiÿl
.
·th
);

1254 
	`şo£
(
fd
);

1258 
	`mod_ssi_»ad_fd
(
¤v
, 
cÚ
, 
p
, 
¡
, 
fd
);

1260 
	`şo£
(
fd
);

1262 
	}
}

1265 
	$mod_ssi_hªdË_»que¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
) {

1266 
¡©
 
¡
;

1270 
	`¬¿y_»£t
(
p
->
ssi_v¬s
);

1271 
	`¬¿y_»£t
(
p
->
ssi_cgi_’v
);

1272 
	`bufãr_cİy_¡ršg_Ën
(
p
->
timefmt
, 
	`CONST_STR_LEN
("%a, %d %b %Y %H:%M:%S %Z"));

1273 
	`bud_ssi_cgi_v¬s
(
¤v
, 
cÚ
, 
p
);

1276 
šşude_fe_Ï¡_mtime
 = 0;

1278 
	`mod_ssi_´oûss_fe
(
¤v
, 
cÚ
, 
p
, &
¡
);

1280 
cÚ
->
fe_¡¬‹d
 = 1;

1281 
cÚ
->
fe_fšished
 = 1;

1283 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
cÚ‹Á_ty³
)) {

1284 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/html"));

1286 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("CÚ‹Á-Ty³"), 
	`CONST_BUF_LEN
(
p
->
cÚf
.
cÚ‹Á_ty³
));

1289 ià(
p
->
cÚf
.
cÚd™iÚ®_»que¡s
) {

1291 
bufãr
 *
mtime
 = 
NULL
;

1294 ià(
¡
.
¡_mtime
 < 
šşude_fe_Ï¡_mtime
)

1295 
¡
.
¡_mtime
 = 
šşude_fe_Ï¡_mtime
;

1297 
	`‘ag_ü—‹
(
cÚ
->
physiÿl
.
‘ag
, &
¡
, cÚ->
‘ag_æags
);

1298 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("ETag"), 
	`CONST_BUF_LEN
(cÚ->
physiÿl
.
‘ag
));

1300 
mtime
 = 
	`¡ráime_ÿche_g‘
(
¤v
, 
¡
.
¡_mtime
);

1301 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("La¡-Modif›d"), 
	`CONST_BUF_LEN
(
mtime
));

1303 ià(
HANDLER_FINISHED
 =ğ
	`h‰p_»¥Ú£_hªdË_ÿchabË
(
¤v
, 
cÚ
, 
mtime
)) {

1307 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

1312 
šşude_fe_Ï¡_mtime
 = 0;

1315 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

1318 
	}
}

1320 
	#PATCH
(
x
) \

1321 
p
->
cÚf
.
x
 = 
s
->x;

	)

1322 
	$mod_ssi_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

1323 
size_t
 
i
, 
j
;

1324 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

1326 
	`PATCH
(
ssi_ex‹nsiÚ
);

1327 
	`PATCH
(
cÚ‹Á_ty³
);

1328 
	`PATCH
(
cÚd™iÚ®_»que¡s
);

1329 
	`PATCH
(
ssi_exec
);

1330 
	`PATCH
(
ssi_»cursiÚ_max
);

1333 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1334 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

1335 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

1338 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

1341 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

1342 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

1344 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssi.extension"))) {

1345 
	`PATCH
(
ssi_ex‹nsiÚ
);

1346 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssi.content-type"))) {

1347 
	`PATCH
(
cÚ‹Á_ty³
);

1348 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssi.conditional-requests"))) {

1349 
	`PATCH
(
cÚd™iÚ®_»que¡s
);

1350 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssi.exec"))) {

1351 
	`PATCH
(
ssi_exec
);

1352 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("ssi.recursion-max"))) {

1353 
	`PATCH
(
ssi_»cursiÚ_max
);

1359 
	}
}

1360 #undeà
PATCH


1362 
	$URIHANDLER_FUNC
(
mod_ssi_physiÿl_·th
) {

1363 
¶ugš_d©a
 *
p
 = 
p_d
;

1364 
size_t
 
k
;

1366 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

1368 ià(
	`bufãr_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

1370 
	`mod_ssi_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

1372 
k
 = 0; k < 
p
->
cÚf
.
ssi_ex‹nsiÚ
->
u£d
; k++) {

1373 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
ssi_ex‹nsiÚ
->
d©a
[
k
];

1375 ià(
	`bufãr_is_em±y
(
ds
->
v®ue
)) ;

1377 ià(
	`bufãr_is_equ®_right_Ën
(
cÚ
->
physiÿl
.
·th
, 
ds
->
v®ue
, 
	`bufãr_¡ršg_Ëngth
(ds->value))) {

1378 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
	`hªdËr_ùx_š™
(p);

1379 
cÚ
->
mode
 = 
p
->
id
;

1384  
HANDLER_GO_ON
;

1385 
	}
}

1387 
	$SUBREQUEST_FUNC
(
mod_ssi_hªdË_sub»que¡
) {

1388 
¶ugš_d©a
 *
p
 = 
p_d
;

1389 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1390 ià(
NULL
 =ğ
hùx
è 
HANDLER_GO_ON
;

1391 ià(
cÚ
->
mode
 !ğ
p
->
id
è 
HANDLER_GO_ON
;

1400 ià(
	`mod_ssi_hªdË_»que¡
(
¤v
, 
cÚ
, 
hùx
)) {

1402 
cÚ
->
h‰p_¡©us
 = 500;

1403 
cÚ
->
mode
 = 
DIRECT
;

1406  
HANDLER_FINISHED
;

1407 
	}
}

1409 
hªdËr_t
 
	$mod_ssi_cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

1410 
¶ugš_d©a
 *
p
 = 
p_d
;

1411 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1412 ià(
hùx
) {

1413 
	`hªdËr_ùx_ä“
(
hùx
);

1414 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

1417 
	`UNUSED
(
¤v
);

1418  
HANDLER_GO_ON
;

1419 
	}
}

1423 
mod_ssi_¶ugš_š™
(
¶ugš
 *
p
);

1424 
	$mod_ssi_¶ugš_š™
(
¶ugš
 *
p
) {

1425 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1426 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("ssi");

1428 
p
->
š™
 = 
mod_ssi_š™
;

1429 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_ssi_physiÿl_·th
;

1430 
p
->
hªdË_sub»que¡
 = 
mod_ssi_hªdË_sub»que¡
;

1431 
p
->
cÚÃùiÚ_»£t
 = 
mod_ssi_cÚÃùiÚ_»£t
;

1432 
p
->
£t_deçuÉs
 = 
mod_ssi_£t_deçuÉs
;

1433 
p
->
ş—nup
 = 
mod_ssi_ä“
;

1435 
p
->
d©a
 = 
NULL
;

1438 
	}
}

	@mod_ssi.h

1 #iâdeà
_MOD_SSI_H_


2 
	#_MOD_SSI_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

6 
	~"bufãr.h
"

7 
	~"¬¿y.h
"

9 
	~"¶ugš.h
"

14 
¬¿y
 *
	mssi_ex‹nsiÚ
;

15 
bufãr
 *
	mcÚ‹Á_ty³
;

16 
	mcÚd™iÚ®_»que¡s
;

17 
	mssi_exec
;

18 
	mssi_»cursiÚ_max
;

19 } 
	t¶ugš_cÚfig
;

22 
	mPLUGIN_DATA
;

24 
bufãr
 *
	mtimefmt
;

26 
bufãr
 *
	m¡©_â
;

28 
¬¿y
 *
	mssi_v¬s
;

29 
¬¿y
 *
	mssi_cgi_’v
;

31 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

33 
¶ugš_cÚfig
 
	mcÚf
;

34 } 
	t¶ugš_d©a
;

37 
bufãr
 *
	mtimefmt
;

38 
	msizefmt
;

40 
bufãr
 *
	m¡©_â
;

42 
¬¿y
 *
	mssi_v¬s
;

43 
¬¿y
 *
	mssi_cgi_’v
;

45 
	mif_Ëv–
, 
	mif_is_çl£_Ëv–
, 
	mif_is_çl£
, 
	mif_is_çl£_’dif
;

46 
	mssi_»cursiÚ_d•th
;

48 
¶ugš_cÚfig
 
	mcÚf
;

49 } 
	thªdËr_ùx
;

51 
ssi_ev®_ex´
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, cÚ¡ *
ex´
);

	@mod_ssi_expr.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

4 
	~"log.h
"

5 
	~"mod_ssi.h
"

6 
	~"mod_ssi_ex´.h
"

7 
	~"mod_ssi_ex´·r£r.h
"

9 
	~<ùy³.h
>

10 
	~<¡ršg.h
>

13 cÚ¡ *
	mšput
;

14 
size_t
 
	moff£t
;

15 
size_t
 
	msize
;

17 
	mlše_pos
;

19 
	mš_key
;

20 
	mš_b¿û
;

21 
	mš_cÚd
;

22 } 
	tssi_tok’iz”_t
;

24 
ssi_v®_t
 *
	$ssi_v®_š™
() {

25 
ssi_v®_t
 *
s
;

27 
s
 = 
	`ÿÎoc
(1, (*s));

29  
s
;

30 
	}
}

32 
	$ssi_v®_ä“
(
ssi_v®_t
 *
s
) {

33 ià(
s
->
¡r
è
	`bufãr_ä“
(s->str);

35 
	`ä“
(
s
);

36 
	}
}

38 
	$ssi_v®_toboŞ
(
ssi_v®_t
 *
B
) {

39 ià(
B
->
ty³
 =ğ
SSI_TYPE_STRING
) {

40  !
	`bufãr_¡ršg_is_em±y
(
B
->
¡r
);

42  
B
->
bo
;

44 
	}
}

46 
	$ssi_ex´_tok’iz”
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
,

47 
ssi_tok’iz”_t
 *
t
, *
tok’_id
, 
bufãr
 *
tok’
) {

48 
tid
 = 0;

49 
size_t
 
i
;

51 
	`UNUSED
(
cÚ
);

53 
tid
 = 0;id =ğ0 && 
t
->
off£t
 <->
size
 &&->
šput
[t->offset] ; ) {

54 
c
 = 
t
->
šput
[t->
off£t
];

55 
d©a_¡ršg
 *
ds
;

57 
c
) {

59 
tid
 = 
TK_EQ
;

61 
t
->
off£t
++;

62 
t
->
lše_pos
++;

64 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(=)"));

68 ià(
t
->
šput
[t->
off£t
 + 1] == '=') {

69 
t
->
off£t
 += 2;

70 
t
->
lše_pos
 += 2;

72 
tid
 = 
TK_GE
;

74 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(>=)"));

76 
t
->
off£t
 += 1;

77 
t
->
lše_pos
 += 1;

79 
tid
 = 
TK_GT
;

81 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(>)"));

86 ià(
t
->
šput
[t->
off£t
 + 1] == '=') {

87 
t
->
off£t
 += 2;

88 
t
->
lše_pos
 += 2;

90 
tid
 = 
TK_LE
;

92 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(<=)"));

94 
t
->
off£t
 += 1;

95 
t
->
lše_pos
 += 1;

97 
tid
 = 
TK_LT
;

99 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(<)"));

105 ià(
t
->
šput
[t->
off£t
 + 1] == '=') {

106 
t
->
off£t
 += 2;

107 
t
->
lše_pos
 += 2;

109 
tid
 = 
TK_NE
;

111 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(!=)"));

113 
t
->
off£t
 += 1;

114 
t
->
lše_pos
 += 1;

116 
tid
 = 
TK_NOT
;

118 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(!)"));

123 ià(
t
->
šput
[t->
off£t
 + 1] == '&') {

124 
t
->
off£t
 += 2;

125 
t
->
lše_pos
 += 2;

127 
tid
 = 
TK_AND
;

129 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(&&)"));

131 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

132 "pos:", 
t
->
lše_pos
,

139 ià(
t
->
šput
[t->
off£t
 + 1] == '|') {

140 
t
->
off£t
 += 2;

141 
t
->
lše_pos
 += 2;

143 
tid
 = 
TK_OR
;

145 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("(||)"));

147 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

148 "pos:", 
t
->
lše_pos
,

156 
t
->
off£t
++;

157 
t
->
lše_pos
++;

162 
i
 = 1; 
t
->
šput
[t->
off£t
 + i] &&->input[t->offset + i] != '\''; i++);

164 ià(
t
->
šput
[t->
off£t
 + 
i
]) {

165 
tid
 = 
TK_VALUE
;

167 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
 + 1, 
i
-1);

169 
t
->
off£t
 +ğ
i
 + 1;

170 
t
->
lše_pos
 +ğ
i
 + 1;

174 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

175 "pos:", 
t
->
lše_pos
,

183 
t
->
off£t
++;

184 
t
->
š_b¿û
++;

186 
tid
 = 
TK_LPARAN
;

188 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
("("));

191 
t
->
off£t
++;

192 
t
->
š_b¿û
--;

194 
tid
 = 
TK_RPARAN
;

196 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
(")"));

199 ià(
t
->
šput
[t->
off£t
 + 1] == '{') {

200 
i
 = 2; 
t
->
šput
[t->
off£t
 + i] &&->input[t->offset + i] != '}'; i++);

202 ià(
t
->
šput
[t->
off£t
 + 
i
] != '}') {

203 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

204 "pos:", 
t
->
lše_pos
,

210 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
 + 2, 
i
-3);

212 
i
 = 1; 
	`i§Íha
(
t
->
šput
[t->
off£t
 + i]) ||

213 
t
->
šput
[t->
off£t
 + 
i
] == '_' ||

214 ((
i
 > 1è&& 
	`isdig™
(
t
->
šput
[t->
off£t
 + i])); i++);

216 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
 + 1, 
i
-1);

219 
tid
 = 
TK_VALUE
;

221 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
p
->
ssi_cgi_’v
, 
tok’
->
±r
))) {

222 
	`bufãr_cİy_bufãr
(
tok’
, 
ds
->
v®ue
);

223 } ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
p
->
ssi_v¬s
, 
tok’
->
±r
))) {

224 
	`bufãr_cİy_bufãr
(
tok’
, 
ds
->
v®ue
);

226 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
	`CONST_STR_LEN
(""));

229 
t
->
off£t
 +ğ
i
;

230 
t
->
lše_pos
 +ğ
i
;

234 
i
 = 0; 
	`isg¿ph
(
t
->
šput
[t->
off£t
 + i]); i++) {

235 
d
 = 
t
->
šput
[t->
off£t
 + 
i
];

236 
d
) {

252 
tid
 = 
TK_VALUE
;

254 
	`bufãr_cİy_¡ršg_Ën
(
tok’
, 
t
->
šput
 +->
off£t
, 
i
);

256 
t
->
off£t
 +ğ
i
;

257 
t
->
lše_pos
 +ğ
i
;

263 ià(
tid
) {

264 *
tok’_id
 = 
tid
;

267 } ià(
t
->
off£t
 <->
size
) {

268 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

269 "pos:", 
t
->
lše_pos
,

273 
	}
}

275 
	$ssi_ev®_ex´
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
p
, cÚ¡ *
ex´
) {

276 
ssi_tok’iz”_t
 
t
;

277 *
pP¬£r
;

278 
tok’_id
;

279 
bufãr
 *
tok’
;

280 
ssi_ùx_t
 
cÚ‹xt
;

281 
»t
;

283 
t
.
šput
 = 
ex´
;

284 
t
.
off£t
 = 0;

285 
t
.
size
 = 
	`¡¾’
(
ex´
);

286 
t
.
lše_pos
 = 1;

288 
t
.
š_key
 = 1;

289 
t
.
š_b¿û
 = 0;

290 
t
.
š_cÚd
 = 0;

292 
cÚ‹xt
.
ok
 = 1;

293 
cÚ‹xt
.
¤v
 = srv;

297 
pP¬£r
 = 
	`ss›x´·r£rAÎoc
Ğ
m®loc
 );

298 
	`fÜû_as£¹
(
pP¬£r
);

299 
tok’
 = 
	`bufãr_š™
();

300 (1 =ğ(
»t
 = 
	`ssi_ex´_tok’iz”
(
¤v
, 
cÚ
, 
p
, &
t
, &
tok’_id
, 
tok’
))è&& 
cÚ‹xt
.
ok
) {

301 
	`ss›x´·r£r
(
pP¬£r
, 
tok’_id
, 
tok’
, &
cÚ‹xt
);

303 
tok’
 = 
	`bufãr_š™
();

305 
	`ss›x´·r£r
(
pP¬£r
, 0, 
tok’
, &
cÚ‹xt
);

306 
	`ss›x´·r£rF»e
(
pP¬£r
, 
ä“
 );

308 
	`bufãr_ä“
(
tok’
);

310 ià(
»t
 == -1) {

311 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

316 ià(
cÚ‹xt
.
ok
 == 0) {

317 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

318 "pos:", 
t
.
lše_pos
,

323 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

325 
ex´
,

326 
cÚ‹xt
.
v®
.
bo
);

328  
cÚ‹xt
.
v®
.
bo
;

329 
	}
}

	@mod_ssi_expr.h

1 #iâdeà
_MOD_SSI_EXPR_H_


2 
	#_MOD_SSI_EXPR_H_


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

8 ’um { 
	mSSI_TYPE_UNSET
, 
	mSSI_TYPE_BOOL
, 
	mSSI_TYPE_STRING
 } 
	mty³
;

10 
bufãr
 *
	m¡r
;

11 
	mbo
;

12 } 
	tssi_v®_t
;

15 
	mok
;

17 
ssi_v®_t
 
	mv®
;

19 *
	m¤v
;

20 } 
	tssi_ùx_t
;

22 ’um { 
	mSSI_COND_UNSET
, 
	mSSI_COND_LE
, 
	mSSI_COND_GE
, 
	mSSI_COND_EQ
, 
	mSSI_COND_NE
, 
	mSSI_COND_LT
, 
	mSSI_COND_GT
 } 
	tssi_ex´_cÚd
;

24 *
ss›x´·r£rAÎoc
(*(*
m®locProc
)(
size_t
));

25 
ss›x´·r£rF»e
(*
p
, (*
ä“Proc
)(*));

26 
	`ss›x´·r£r
(*
yyp
, 
yymajÜ
, 
bufãr
 *
yymšÜ
, 
ssi_ùx_t
 *
ùx
);

28 
	`ssi_v®_toboŞ
(
ssi_v®_t
 *
B
);

29 
ssi_v®_t
 *
	`ssi_v®_š™
();

30 
	`ssi_v®_ä“
(
ssi_v®_t
 *
s
);

	@mod_ssi_exprparser.c

6 
	~"fœ¡.h
"

7 
	~<¡dio.h
>

10 
	~"fœ¡.h
"

11 
	~"mod_ssi_ex´.h
"

12 
	~"bufãr.h
"

14 
	~<as£¹.h
>

15 
	~<¡ršg.h
>

30 #iâdeà
INTERFACE


31 
	#INTERFACE
 1

	)

67 
	#YYCODETYPE
 

	)

68 
	#YYNOCODE
 20

	)

69 
	#YYACTIONTYPE
 

	)

70 
	#ss›x´·r£rTOKENTYPE
 
bufãr
 *

	)

72 
ss›x´·r£rTOKENTYPE
 
	myy0
;

73 
	myy8
;

74 
bufãr
 * 
	myy19
;

75 
ssi_v®_t
 * 
	myy29
;

76 
	myy39
;

77 } 
	tYYMINORTYPE
;

78 
	#YYSTACKDEPTH
 100

	)

79 
	#ss›x´·r£rARG_SDECL
 
ssi_ùx_t
 *
ùx
;

	)

80 
	#ss›x´·r£rARG_PDECL
 ,
ssi_ùx_t
 *
ùx


	)

81 
	#ss›x´·r£rARG_FETCH
 
ssi_ùx_t
 *
ùx
 = 
yypP¬£r
->
	)
ctx

82 
	#ss›x´·r£rARG_STORE
 
yypP¬£r
->
ùx
 = 
	)
ctx

83 
	#YYNSTATE
 23

	)

84 
	#YYNRULE
 16

	)

85 
	#YYERRORSYMBOL
 13

	)

86 
	#YYERRSYMDT
 
yy39


	)

87 
	#YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

	)

88 
	#YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

	)

89 
	#YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

	)

138 
YYACTIONTYPE
 
	gyy_aùiÚ
[] = {

144 
YYCODETYPE
 
	gyy_lookah—d
[] = {

150 
	#YY_SHIFT_USE_DFLT
 (-2)

	)

151 sigÃd 
	gyy_shiá_of¡
[] = {

156 
	#YY_REDUCE_USE_DFLT
 (-7)

	)

157 sigÃd 
	gyy_»duû_of¡
[] = {

162 
YYACTIONTYPE
 
	gyy_deçuÉ
[] = {

167 
	#YY_SZ_ACTTAB
 ((
yy_aùiÚ
)/(yy_aùiÚ[0]))

	)

179 #ifdeà
YYFALLBACK


180 cÚ¡ 
YYCODETYPE
 
	gyyF®lback
[] = {

196 
	syySckEÁry
 {

197 
	m¡©’o
;

198 
	mmajÜ
;

200 
YYMINORTYPE
 
	mmšÜ
;

203 
yySckEÁry
 
	tyySckEÁry
;

207 
	syyP¬£r
 {

208 
	myyidx
;

209 
	myy”rút
;

210 
ss›x´·r£rARG_SDECL


211 
yySckEÁry
 
	myy¡ack
[
YYSTACKDEPTH
];

213 
yyP¬£r
 
	tyyP¬£r
;

215 #iâdeà
NDEBUG


216 
	~<¡dio.h
>

217 
FILE
 *
	gyyT¿ûFILE
 = 
NULL
;

218 *
	gyyT¿ûProm±
 = 
NULL
;

221 #iâdeà
NDEBUG


240 
	$ss›x´·r£rT¿û
(
FILE
 *
T¿ûFILE
, *
zT¿ûProm±
){

241 
yyT¿ûFILE
 = 
T¿ûFILE
;

242 
yyT¿ûProm±
 = 
zT¿ûProm±
;

243 ifĞ
yyT¿ûFILE
==0 ) 
yyT¿ûProm±
 = 0;

244 ifĞ
yyT¿ûProm±
==0 ) 
yyT¿ûFILE
 = 0;

245 
	}
}

249 #iâdeà
NDEBUG


252 cÚ¡ *
	gyyTok’Name
[] = {

261 #iâdeà
NDEBUG


264 cÚ¡ *
	gyyRuËName
[] = {

289 cÚ¡ *
	$ss›x´·r£rTok’Name
(
tok’Ty³
){

290 #iâdeà
NDEBUG


291 ifĞ
tok’Ty³
>0 && (
size_t
éok’Ty³<((
yyTok’Name
)/(yyTokenName[0])) ){

292  
yyTok’Name
[
tok’Ty³
];

299 
	}
}

314 *
	$ss›x´·r£rAÎoc
(*(*
m®locProc
)(
size_t
)){

315 
yyP¬£r
 *
pP¬£r
;

316 
pP¬£r
 = (
yyP¬£r
*)(*
m®locProc
)Ğ(
size_t
)(yyParser) );

317 ifĞ
pP¬£r
 ){

318 
pP¬£r
->
yyidx
 = -1;

320  
pP¬£r
;

321 
	}
}

328 
	$yy_de¡ruùÜ
(
YYCODETYPE
 
yymajÜ
, 
YYMINORTYPE
 *
yypmšÜ
){

329  
yymajÜ
 ){

353 { 
	`bufãr_ä“
((
yypmšÜ
->
yy0
)); }

358 
	}
}

368 
	$yy_pİ_·r£r_¡ack
(
yyP¬£r
 *
pP¬£r
){

369 
YYCODETYPE
 
yymajÜ
;

370 
yySckEÁry
 *
yytos
;

372 ifĞ
pP¬£r
->
yyidx
<0 )  0;

373 
yytos
 = &
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
];

374 #iâdeà
NDEBUG


375 ifĞ
yyT¿ûFILE
 && 
pP¬£r
->
yyidx
>=0 ){

376 
	`årštf
(
yyT¿ûFILE
,"%sPopping %s\n",

377 
yyT¿ûProm±
,

378 
yyTok’Name
[
yytos
->
majÜ
]);

381 
yymajÜ
 = 
yytos
->
majÜ
;

382 
	`yy_de¡ruùÜ
Ğ
yymajÜ
, &
yytos
->
mšÜ
);

383 
pP¬£r
->
yyidx
--;

384  
yymajÜ
;

385 
	}
}

399 
	$ss›x´·r£rF»e
(

400 *
p
,

401 (*
ä“Proc
)(*)

403 
yyP¬£r
 *
pP¬£r
 = (yyP¬£r*)
p
;

404 ifĞ
pP¬£r
==
NULL
 ) ;

405  
pP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(pParser);

406 (*
ä“Proc
)((*)
pP¬£r
);

407 
	}
}

417 
	$yy_fšd_shiá_aùiÚ
(

418 
yyP¬£r
 *
pP¬£r
,

419 
iLookAh—d


421 
i
;

422 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

425 
i
 = 
yy_shiá_of¡
[
¡©’o
];

426 ifĞ
i
==
YY_SHIFT_USE_DFLT
 ){

427  
yy_deçuÉ
[
¡©’o
];

429 ifĞ
iLookAh—d
==
YYNOCODE
 ){

430  
YY_NO_ACTION
;

432 
i
 +ğ
iLookAh—d
;

433 ifĞ
i
<0 || (
size_t
)i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

434 #ifdeà
YYFALLBACK


435 
iF®lback
;

436 ifĞ
iLookAh—d
<(
yyF®lback
)/(yyFallback[0])

437 && (
iF®lback
 = 
yyF®lback
[
iLookAh—d
])!=0 ){

438 #iâdeà
NDEBUG


439 ifĞ
yyT¿ûFILE
 ){

440 
	`årštf
(
yyT¿ûFILE
, "%sFALLBACK %s => %s\n",

441 
yyT¿ûProm±
, 
yyTok’Name
[
iLookAh—d
], yyTok’Name[
iF®lback
]);

444  
	`yy_fšd_shiá_aùiÚ
(
pP¬£r
, 
iF®lback
);

447  
yy_deçuÉ
[
¡©’o
];

449  
yy_aùiÚ
[
i
];

451 
	}
}

461 
	$yy_fšd_»duû_aùiÚ
(

462 
yyP¬£r
 *
pP¬£r
,

463 
iLookAh—d


465 
i
;

466 
¡©’o
 = 
pP¬£r
->
yy¡ack
[pP¬£r->
yyidx
].stateno;

468 
i
 = 
yy_»duû_of¡
[
¡©’o
];

469 ifĞ
i
==
YY_REDUCE_USE_DFLT
 ){

470  
yy_deçuÉ
[
¡©’o
];

472 ifĞ
iLookAh—d
==
YYNOCODE
 ){

473  
YY_NO_ACTION
;

475 
i
 +ğ
iLookAh—d
;

476 ifĞ
i
<0 || (
size_t
)i>=
YY_SZ_ACTTAB
 || 
yy_lookah—d
[i]!=
iLookAh—d
 ){

477  
yy_deçuÉ
[
¡©’o
];

479  
yy_aùiÚ
[
i
];

481 
	}
}

486 
	$yy_shiá
(

487 
yyP¬£r
 *
yypP¬£r
,

488 
yyNewS‹
,

489 
yyMajÜ
,

490 
YYMINORTYPE
 *
yypMšÜ


492 
yySckEÁry
 *
yytos
;

493 
yypP¬£r
->
yyidx
++;

494 ifĞ
yypP¬£r
->
yyidx
>=
YYSTACKDEPTH
 ){

495 
ss›x´·r£rARG_FETCH
;

496 
yypP¬£r
->
yyidx
--;

497 #iâdeà
NDEBUG


498 ifĞ
yyT¿ûFILE
 ){

499 
	`årštf
(
yyT¿ûFILE
,"%sSck Ov”æow!\n",
yyT¿ûProm±
);

502  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

505 
ss›x´·r£rARG_STORE
;

508 
yytos
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

509 
yytos
->
¡©’o
 = 
yyNewS‹
;

510 
yytos
->
majÜ
 = 
yyMajÜ
;

511 
yytos
->
mšÜ
 = *
yypMšÜ
;

512 #iâdeà
NDEBUG


513 ifĞ
yyT¿ûFILE
 && 
yypP¬£r
->
yyidx
>0 ){

514 
i
;

515 
	`årštf
(
yyT¿ûFILE
,"%sShiá %d\n",
yyT¿ûProm±
,
yyNewS‹
);

516 
	`årštf
(
yyT¿ûFILE
,"%sSck:",
yyT¿ûProm±
);

517 
i
=1; i<=
yypP¬£r
->
yyidx
; i++)

518 
	`årštf
(
yyT¿ûFILE
," %s",
yyTok’Name
[
yypP¬£r
->
yy¡ack
[
i
].
majÜ
]);

519 
	`årštf
(
yyT¿ûFILE
,"\n");

522 
	}
}

528 
YYCODETYPE
 
	mlhs
;

529 
	mÄhs
;

530 } 
	gyyRuËInfo
[] = {

549 
yy_acû±
(
yyP¬£r
*);

555 
	$yy_»duû
(

556 
yyP¬£r
 *
yypP¬£r
,

557 
yyruËno


559 
yygÙo
;

560 
yyaù
;

561 
YYMINORTYPE
 
yygÙomšÜ
;

562 
yySckEÁry
 *
yym¥
;

563 
yysize
;

564 
ss›x´·r£rARG_FETCH
;

565 
yym¥
 = &
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
];

566 #iâdeà
NDEBUG


567 ifĞ
yyT¿ûFILE
 ) {

568 ià(
yyruËno
>=0

569 && (
size_t
)
yyruËno
<(
yyRuËName
)/(yyRuleName[0]) ){

570 
	`årštf
(
yyT¿ûFILE
, "%sReduû [%s].\n", 
yyT¿ûProm±
,

571 
yyRuËName
[
yyruËno
]);

578  
yyruËno
 ){

590 
ùx
->
v®
.
bo
 = 
	`ssi_v®_toboŞ
(
yym¥
[0].
mšÜ
.
yy29
);

591 
ùx
->
v®
.
ty³
 = 
SSI_TYPE_BOOL
;

593 
	`ssi_v®_ä“
(
yym¥
[0].
mšÜ
.
yy29
);

600 
cmp
;

602 ià(
yym¥
[-2].
mšÜ
.
yy29
->
ty³
 =ğ
SSI_TYPE_STRING
 &&

603 
yym¥
[0].
mšÜ
.
yy29
->
ty³
 =ğ
SSI_TYPE_STRING
) {

604 
cmp
 = 
	`¡rcmp
(
yym¥
[-2].
mšÜ
.
yy29
->
¡r
->
±r
, yymsp[0].minor.yy29->str->ptr);

606 
cmp
 = 
	`ssi_v®_toboŞ
(
yym¥
[-2].
mšÜ
.
yy29
) - ssi_val_tobool(yymsp[0].minor.yy29);

609 
yygÙomšÜ
.
yy29
 = 
yym¥
[-2].
mšÜ
.yy29;

611 
yym¥
[-1].
mšÜ
.
yy8
) {

612 
SSI_COND_EQ
: 
yygÙomšÜ
.
yy29
->
bo
 = (
cmp
 == 0) ? 1 : 0; ;

613 
SSI_COND_NE
: 
yygÙomšÜ
.
yy29
->
bo
 = (
cmp
 != 0) ? 1 : 0; ;

614 
SSI_COND_GE
: 
yygÙomšÜ
.
yy29
->
bo
 = (
cmp
 >= 0) ? 1 : 0; ;

615 
SSI_COND_GT
: 
yygÙomšÜ
.
yy29
->
bo
 = (
cmp
 > 0) ? 1 : 0; ;

616 
SSI_COND_LE
: 
yygÙomšÜ
.
yy29
->
bo
 = (
cmp
 <= 0) ? 1 : 0; ;

617 
SSI_COND_LT
: 
yygÙomšÜ
.
yy29
->
bo
 = (
cmp
 < 0) ? 1 : 0; ;

620 
yygÙomšÜ
.
yy29
->
ty³
 = 
SSI_TYPE_BOOL
;

622 
	`ssi_v®_ä“
(
yym¥
[0].
mšÜ
.
yy29
);

629 
yygÙomšÜ
.
yy29
 = 
yym¥
[0].
mšÜ
.yy29;

636 
e
;

638 
e
 = 
	`ssi_v®_toboŞ
(
yym¥
[-2].
mšÜ
.
yy29
) && ssi_val_tobool(yymsp[0].minor.yy29);

640 
yygÙomšÜ
.
yy29
 = 
yym¥
[-2].
mšÜ
.yy29;

641 
yygÙomšÜ
.
yy29
->
bo
 = 
e
;

642 
yygÙomšÜ
.
yy29
->
ty³
 = 
SSI_TYPE_BOOL
;

643 
	`ssi_v®_ä“
(
yym¥
[0].
mšÜ
.
yy29
);

646 
	`yy_de¡ruùÜ
(1,&
yym¥
[-1].
mšÜ
);

651 
e
;

653 
e
 = 
	`ssi_v®_toboŞ
(
yym¥
[-2].
mšÜ
.
yy29
) || ssi_val_tobool(yymsp[0].minor.yy29);

655 
yygÙomšÜ
.
yy29
 = 
yym¥
[-2].
mšÜ
.yy29;

656 
yygÙomšÜ
.
yy29
->
bo
 = 
e
;

657 
yygÙomšÜ
.
yy29
->
ty³
 = 
SSI_TYPE_BOOL
;

658 
	`ssi_v®_ä“
(
yym¥
[0].
mšÜ
.
yy29
);

661 
	`yy_de¡ruùÜ
(2,&
yym¥
[-1].
mšÜ
);

666 
e
;

668 
e
 = !
	`ssi_v®_toboŞ
(
yym¥
[0].
mšÜ
.
yy29
);

670 
yygÙomšÜ
.
yy29
 = 
yym¥
[0].
mšÜ
.yy29;

671 
yygÙomšÜ
.
yy29
->
bo
 = 
e
;

672 
yygÙomšÜ
.
yy29
->
ty³
 = 
SSI_TYPE_BOOL
;

675 
	`yy_de¡ruùÜ
(9,&
yym¥
[-1].
mšÜ
);

680 
yygÙomšÜ
.
yy29
 = 
yym¥
[-1].
mšÜ
.yy29;

683 
	`yy_de¡ruùÜ
(10,&
yym¥
[-2].
mšÜ
);

684 
	`yy_de¡ruùÜ
(11,&
yym¥
[0].
mšÜ
);

689 
yygÙomšÜ
.
yy29
 = 
	`ssi_v®_š™
();

690 
yygÙomšÜ
.
yy29
->
¡r
 = 
yym¥
[0].
mšÜ
.
yy19
;

691 
yygÙomšÜ
.
yy29
->
ty³
 = 
SSI_TYPE_STRING
;

698 
yygÙomšÜ
.
yy19
 = 
yym¥
[0].
mšÜ
.
yy0
;

705 
yygÙomšÜ
.
yy19
 = 
yym¥
[-1].
mšÜ
.yy19;

706 
	`bufãr_­³nd_¡ršg_bufãr
(
yygÙomšÜ
.
yy19
, 
yym¥
[0].
mšÜ
.
yy0
);

707 
	`bufãr_ä“
(
yym¥
[0].
mšÜ
.
yy0
);

713 { 
yygÙomšÜ
.
yy8
 = 
SSI_COND_EQ
; }

715 
	`yy_de¡ruùÜ
(3,&
yym¥
[0].
mšÜ
);

719 { 
yygÙomšÜ
.
yy8
 = 
SSI_COND_NE
; }

721 
	`yy_de¡ruùÜ
(4,&
yym¥
[0].
mšÜ
);

725 { 
yygÙomšÜ
.
yy8
 = 
SSI_COND_LE
; }

727 
	`yy_de¡ruùÜ
(8,&
yym¥
[0].
mšÜ
);

731 { 
yygÙomšÜ
.
yy8
 = 
SSI_COND_GE
; }

733 
	`yy_de¡ruùÜ
(6,&
yym¥
[0].
mšÜ
);

737 { 
yygÙomšÜ
.
yy8
 = 
SSI_COND_LT
; }

739 
	`yy_de¡ruùÜ
(7,&
yym¥
[0].
mšÜ
);

743 { 
yygÙomšÜ
.
yy8
 = 
SSI_COND_GT
; }

745 
	`yy_de¡ruùÜ
(5,&
yym¥
[0].
mšÜ
);

748 
yygÙo
 = 
yyRuËInfo
[
yyruËno
].
lhs
;

749 
yysize
 = 
yyRuËInfo
[
yyruËno
].
Ähs
;

750 
yypP¬£r
->
yyidx
 -ğ
yysize
;

751 
yyaù
 = 
	`yy_fšd_»duû_aùiÚ
(
yypP¬£r
,
yygÙo
);

752 ifĞ
yyaù
 < 
YYNSTATE
 ){

753 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yygÙo
,&
yygÙomšÜ
);

754 }ifĞ
yyaù
 =ğ
YYNSTATE
 + 
YYNRULE
 + 1 ){

755 
	`yy_acû±
(
yypP¬£r
);

757 
	}
}

762 
	$yy_·r£_çed
(

763 
yyP¬£r
 *
yypP¬£r


765 
ss›x´·r£rARG_FETCH
;

766 #iâdeà
NDEBUG


767 ifĞ
yyT¿ûFILE
 ){

768 
	`årštf
(
yyT¿ûFILE
,"%sFa!\n",
yyT¿ûProm±
);

771  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

776 
ùx
->
ok
 = 0;

779 
ss›x´·r£rARG_STORE
;

780 
	}
}

785 
	$yy_syÁax_”rÜ
(

786 
yyP¬£r
 *
yypP¬£r
,

787 
yymajÜ
,

788 
YYMINORTYPE
 
yymšÜ


790 
ss›x´·r£rARG_FETCH
;

791 
	`UNUSED
(
yymajÜ
);

792 
	`UNUSED
(
yymšÜ
);

793 
	#TOKEN
 (
yymšÜ
.
yy0
)

	)

794 
ss›x´·r£rARG_STORE
;

795 
	}
}

800 
	$yy_acû±
(

801 
yyP¬£r
 *
yypP¬£r


803 
ss›x´·r£rARG_FETCH
;

804 #iâdeà
NDEBUG


805 ifĞ
yyT¿ûFILE
 ){

806 
	`årštf
(
yyT¿ûFILE
,"%sAcû±!\n",
yyT¿ûProm±
);

809  
yypP¬£r
->
yyidx
>=0 ) 
	`yy_pİ_·r£r_¡ack
(yypParser);

812 
ss›x´·r£rARG_STORE
;

813 
	}
}

834 
	$ss›x´·r£r
(

835 *
yyp
,

836 
yymajÜ
,

837 
ss›x´·r£rTOKENTYPE
 
yymšÜ


838 
ss›x´·r£rARG_PDECL


840 
YYMINORTYPE
 
yymšÜuniÚ
;

841 
yyaù
;

842 
yy’dofšput
;

843 
yy”rÜh™
 = 0;

844 
yyP¬£r
 *
yypP¬£r
;

847 
yypP¬£r
 = (
yyP¬£r
*)
yyp
;

848 ifĞ
yypP¬£r
->
yyidx
<0 ){

849 ifĞ
yymajÜ
==0 ) ;

850 
yypP¬£r
->
yyidx
 = 0;

851 
yypP¬£r
->
yy”rút
 = -1;

852 
yypP¬£r
->
yy¡ack
[0].
¡©’o
 = 0;

853 
yypP¬£r
->
yy¡ack
[0].
majÜ
 = 0;

855 
yymšÜuniÚ
.
yy0
 = 
yymšÜ
;

856 
yy’dofšput
 = (
yymajÜ
==0);

857 
ss›x´·r£rARG_STORE
;

859 #iâdeà
NDEBUG


860 ifĞ
yyT¿ûFILE
 ){

861 
	`årštf
(
yyT¿ûFILE
,"%sIÅuˆ%s\n",
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

866 
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,
yymajÜ
);

867 ifĞ
yyaù
<
YYNSTATE
 ){

868 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
yymajÜ
,&
yymšÜuniÚ
);

869 
yypP¬£r
->
yy”rút
--;

870 ifĞ
yy’dofšput
 && 
yypP¬£r
->
yyidx
>=0 ){

871 
yymajÜ
 = 0;

873 
yymajÜ
 = 
YYNOCODE
;

875 }ifĞ
yyaù
 < 
YYNSTATE
 + 
YYNRULE
 ){

876 
	`yy_»duû
(
yypP¬£r
,
yyaù
-
YYNSTATE
);

877 }ifĞ
yyaù
 =ğ
YY_ERROR_ACTION
 ){

878 
yymx
;

879 #iâdeà
NDEBUG


880 ifĞ
yyT¿ûFILE
 ){

881 
	`årštf
(
yyT¿ûFILE
,"%sSyÁax E¼Ü!\n",
yyT¿ûProm±
);

884 #ifdeà
YYERRORSYMBOL


904 ifĞ
yypP¬£r
->
yy”rút
<0 ){

905 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

907 
yymx
 = 
yypP¬£r
->
yy¡ack
[yypP¬£r->
yyidx
].
majÜ
;

908 ifĞ
yymx
==
YYERRORSYMBOL
 || 
yy”rÜh™
 ){

909 #iâdeà
NDEBUG


910 ifĞ
yyT¿ûFILE
 ){

911 
	`årštf
(
yyT¿ûFILE
,"%sDiscard inputoken %s\n",

912 
yyT¿ûProm±
,
yyTok’Name
[
yymajÜ
]);

915 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

916 
yymajÜ
 = 
YYNOCODE
;

919 
yypP¬£r
->
yyidx
 >= 0 &&

920 
yymx
 !ğ
YYERRORSYMBOL
 &&

921 (
yyaù
 = 
	`yy_fšd_shiá_aùiÚ
(
yypP¬£r
,
YYERRORSYMBOL
)è>ğ
YYNSTATE


923 
	`yy_pİ_·r£r_¡ack
(
yypP¬£r
);

925 ifĞ
yypP¬£r
->
yyidx
 < 0 || 
yymajÜ
==0 ){

926 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

927 
	`yy_·r£_çed
(
yypP¬£r
);

928 
yymajÜ
 = 
YYNOCODE
;

929 }ifĞ
yymx
!=
YYERRORSYMBOL
 ){

930 
YYMINORTYPE
 
u2
;

931 
u2
.
YYERRSYMDT
 = 0;

932 
	`yy_shiá
(
yypP¬£r
,
yyaù
,
YYERRORSYMBOL
,&
u2
);

935 
yypP¬£r
->
yy”rút
 = 3;

936 
yy”rÜh™
 = 1;

947 ifĞ
yypP¬£r
->
yy”rút
<=0 ){

948 
	`yy_syÁax_”rÜ
(
yypP¬£r
,
yymajÜ
,
yymšÜuniÚ
);

950 
yypP¬£r
->
yy”rút
 = 3;

951 
	`yy_de¡ruùÜ
(
yymajÜ
,&
yymšÜuniÚ
);

952 ifĞ
yy’dofšput
 ){

953 
	`yy_·r£_çed
(
yypP¬£r
);

955 
yymajÜ
 = 
YYNOCODE
;

958 
	`yy_acû±
(
yypP¬£r
);

959 
yymajÜ
 = 
YYNOCODE
;

961 } 
yymajÜ
!=
YYNOCODE
 && 
yypP¬£r
->
yyidx
>=0 );

963 
	}
}

	@mod_ssi_exprparser.h

1 
	#TK_AND
 1

	)

2 
	#TK_OR
 2

	)

3 
	#TK_EQ
 3

	)

4 
	#TK_NE
 4

	)

5 
	#TK_GT
 5

	)

6 
	#TK_GE
 6

	)

7 
	#TK_LT
 7

	)

8 
	#TK_LE
 8

	)

9 
	#TK_NOT
 9

	)

10 
	#TK_LPARAN
 10

	)

11 
	#TK_RPARAN
 11

	)

12 
	#TK_VALUE
 12

	)

	@mod_staticfile.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"¡©_ÿche.h
"

10 
	~"‘ag.h
"

11 
	~"h‰p_chunk.h
"

12 
	~"»¥Ú£.h
"

14 
	~<ùy³.h
>

15 
	~<¡dlib.h
>

16 
	~<¡dio.h
>

17 
	~<¡ršg.h
>

29 
¬¿y
 *
	mexşude_ext
;

30 
	m‘ags_u£d
;

31 
	mdi§bË_·thšfo
;

32 } 
	t¶ugš_cÚfig
;

35 
	mPLUGIN_DATA
;

37 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

39 
¶ugš_cÚfig
 
	mcÚf
;

40 } 
	t¶ugš_d©a
;

43 
	$INIT_FUNC
(
mod_¡©icfe_š™
) {

44 
¶ugš_d©a
 *
p
;

46 
p
 = 
	`ÿÎoc
(1, (*p));

48  
p
;

49 
	}
}

52 
	$FREE_FUNC
(
mod_¡©icfe_ä“
) {

53 
¶ugš_d©a
 *
p
 = 
p_d
;

55 
	`UNUSED
(
¤v
);

57 ià(!
p
è 
HANDLER_GO_ON
;

59 ià(
p
->
cÚfig_¡Üage
) {

60 
size_t
 
i
;

61 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

62 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

64 ià(
NULL
 =ğ
s
) ;

66 
	`¬¿y_ä“
(
s
->
exşude_ext
);

68 
	`ä“
(
s
);

70 
	`ä“
(
p
->
cÚfig_¡Üage
);

73 
	`ä“
(
p
);

75  
HANDLER_GO_ON
;

76 
	}
}

80 
	$SETDEFAULTS_FUNC
(
mod_¡©icfe_£t_deçuÉs
) {

81 
¶ugš_d©a
 *
p
 = 
p_d
;

82 
size_t
 
i
 = 0;

84 
cÚfig_v®ues_t
 
cv
[] = {

85 { "¡©ic-fe.exşude-ex‹nsiÚs", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

86 { "¡©ic-fe.‘ags", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

87 { "¡©ic-fe.di§bË-·thšfo", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

88 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

91 ià(!
p
è 
HANDLER_ERROR
;

93 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

95 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

96 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

97 
¶ugš_cÚfig
 *
s
;

99 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

100 
s
->
exşude_ext
 = 
	`¬¿y_š™
();

101 
s
->
‘ags_u£d
 = 1;

102 
s
->
di§bË_·thšfo
 = 0;

104 
cv
[0].
de¡š©iÚ
 = 
s
->
exşude_ext
;

105 
cv
[1].
de¡š©iÚ
 = &(
s
->
‘ags_u£d
);

106 
cv
[2].
de¡š©iÚ
 = &(
s
->
di§bË_·thšfo
);

108 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

110 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

111  
HANDLER_ERROR
;

115  
HANDLER_GO_ON
;

116 
	}
}

118 
	#PATCH
(
x
) \

119 
p
->
cÚf
.
x
 = 
s
->x;

	)

120 
	$mod_¡©icfe_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

121 
size_t
 
i
, 
j
;

122 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

124 
	`PATCH
(
exşude_ext
);

125 
	`PATCH
(
‘ags_u£d
);

126 
	`PATCH
(
di§bË_·thšfo
);

129 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

130 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

131 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

134 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

137 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

138 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

140 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("static-file.exclude-extensions"))) {

141 
	`PATCH
(
exşude_ext
);

142 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("static-file.etags"))) {

143 
	`PATCH
(
‘ags_u£d
);

144 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("static-file.disable-pathinfo"))) {

145 
	`PATCH
(
di§bË_·thšfo
);

151 
	}
}

152 #undeà
PATCH


154 
	$URIHANDLER_FUNC
(
mod_¡©icfe_sub»que¡
) {

155 
¶ugš_d©a
 *
p
 = 
p_d
;

156 
size_t
 
k
;

157 
d©a_¡ršg
 *
ds
;

160 ià(
cÚ
->
h‰p_¡©us
 !ğ0è 
HANDLER_GO_ON
;

161 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

162 ià(
	`bufãr_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

165 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

168 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

169 
HTTP_METHOD_GET
:

170 
HTTP_METHOD_POST
:

171 
HTTP_METHOD_HEAD
:

174  
HANDLER_GO_ON
;

177 
	`mod_¡©icfe_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

179 ià(
p
->
cÚf
.
di§bË_·thšfo
 && !
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
·thšfo
)) {

180 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

181 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- NOT handling file‡s static file,…athinfo forbidden");

183  
HANDLER_GO_ON
;

187 
k
 = 0; k < 
p
->
cÚf
.
exşude_ext
->
u£d
; k++) {

188 
ds
 = (
d©a_¡ršg
 *)
p
->
cÚf
.
exşude_ext
->
d©a
[
k
];

190 ià(
	`bufãr_is_em±y
(
ds
->
v®ue
)) ;

192 ià(
	`bufãr_is_equ®_right_Ën
(
cÚ
->
physiÿl
.
·th
, 
ds
->
v®ue
, 
	`bufãr_¡ršg_Ëngth
(ds->value))) {

193 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

194 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- NOT handling file‡s static file,ƒxtension forbidden");

196  
HANDLER_GO_ON
;

201 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

202 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- handling file‡s static file");

205 ià(!
p
->
cÚf
.
‘ags_u£d
è
cÚ
->
‘ag_æags
 = 0;

206 
	`h‰p_»¥Ú£_£nd_fe
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
);

208  
HANDLER_FINISHED
;

209 
	}
}

213 
mod_¡©icfe_¶ugš_š™
(
¶ugš
 *
p
);

214 
	$mod_¡©icfe_¶ugš_š™
(
¶ugš
 *
p
) {

215 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

216 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("staticfile");

218 
p
->
š™
 = 
mod_¡©icfe_š™
;

219 
p
->
hªdË_sub»que¡_¡¬t
 = 
mod_¡©icfe_sub»que¡
;

220 
p
->
£t_deçuÉs
 = 
mod_¡©icfe_£t_deçuÉs
;

221 
p
->
ş—nup
 = 
mod_¡©icfe_ä“
;

223 
p
->
d©a
 = 
NULL
;

226 
	}
}

	@mod_status.c

1 
	~"fœ¡.h
"

3 
	~"£rv”.h
"

4 
	~"cÚÃùiÚs.h
"

5 
	~"»¥Ú£.h
"

6 
	~"cÚÃùiÚs.h
"

7 
	~"log.h
"

9 
	~"¶ugš.h
"

11 
	~"š‘_Áİ_ÿche.h
"

13 
	~<sys/ty³s.h
>

15 
	~<fú.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

18 
	~<uni¡d.h
>

19 
	~<”ºo.h
>

20 
	~<time.h
>

21 
	~<¡dio.h
>

24 
bufãr
 *
	mcÚfig_u¾
;

25 
bufãr
 *
	m¡©us_u¾
;

26 
bufãr
 *
	m¡©i¡ics_u¾
;

28 
	msÜt
;

29 } 
	t¶ugš_cÚfig
;

32 
	mPLUGIN_DATA
;

34 
	mŒaffic_out
;

35 
	m»que¡s
;

37 
	mmod_5s_Œaffic_out
[5];

38 
	mmod_5s_»que¡s
[5];

39 
size_t
 
	mmod_5s_ndx
;

41 
	m»l_Œaffic_out
;

42 
	m»l_»que¡s
;

44 
	mabs_Œaffic_out
;

45 
	mabs_»que¡s
;

47 
	mby‹s_wr™‹n
;

49 
bufãr
 *
	mmoduË_li¡
;

51 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

53 
¶ugš_cÚfig
 
	mcÚf
;

54 } 
	t¶ugš_d©a
;

56 
	$INIT_FUNC
(
mod_¡©us_š™
) {

57 
¶ugš_d©a
 *
p
;

58 
size_t
 
i
;

60 
p
 = 
	`ÿÎoc
(1, (*p));

62 
p
->
Œaffic_out
 =…->
»que¡s
 = 0;

63 
p
->
»l_Œaffic_out
 =…->
»l_»que¡s
 = 0;

64 
p
->
abs_Œaffic_out
 =…->
abs_»que¡s
 = 0;

65 
p
->
by‹s_wr™‹n
 = 0;

66 
p
->
moduË_li¡
 = 
	`bufãr_š™
();

68 
i
 = 0; i < 5; i++) {

69 
p
->
mod_5s_Œaffic_out
[
i
] =…->
mod_5s_»que¡s
[i] = 0;

72  
p
;

73 
	}
}

75 
	$FREE_FUNC
(
mod_¡©us_ä“
) {

76 
¶ugš_d©a
 *
p
 = 
p_d
;

78 
	`UNUSED
(
¤v
);

80 ià(!
p
è 
HANDLER_GO_ON
;

82 
	`bufãr_ä“
(
p
->
moduË_li¡
);

84 ià(
p
->
cÚfig_¡Üage
) {

85 
size_t
 
i
;

86 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

87 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

89 
	`bufãr_ä“
(
s
->
¡©us_u¾
);

90 
	`bufãr_ä“
(
s
->
¡©i¡ics_u¾
);

91 
	`bufãr_ä“
(
s
->
cÚfig_u¾
);

93 
	`ä“
(
s
);

95 
	`ä“
(
p
->
cÚfig_¡Üage
);

99 
	`ä“
(
p
);

101  
HANDLER_GO_ON
;

102 
	}
}

104 
	$SETDEFAULTS_FUNC
(
mod_¡©us_£t_deçuÉs
) {

105 
¶ugš_d©a
 *
p
 = 
p_d
;

106 
size_t
 
i
;

108 
cÚfig_v®ues_t
 
cv
[] = {

109 { "¡©us.¡©us-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

110 { "¡©us.cÚfig-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

111 { "¡©us.’abË-sÜt", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

112 { "¡©us.¡©i¡ics-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

113 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

116 ià(!
p
è 
HANDLER_ERROR
;

118 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

120 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

121 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

122 
¶ugš_cÚfig
 *
s
;

124 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

125 
s
->
cÚfig_u¾
 = 
	`bufãr_š™
();

126 
s
->
¡©us_u¾
 = 
	`bufãr_š™
();

127 
s
->
sÜt
 = 1;

128 
s
->
¡©i¡ics_u¾
 = 
	`bufãr_š™
();

130 
cv
[0].
de¡š©iÚ
 = 
s
->
¡©us_u¾
;

131 
cv
[1].
de¡š©iÚ
 = 
s
->
cÚfig_u¾
;

132 
cv
[2].
de¡š©iÚ
 = &(
s
->
sÜt
);

133 
cv
[3].
de¡š©iÚ
 = 
s
->
¡©i¡ics_u¾
;

135 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

137 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

138  
HANDLER_ERROR
;

142  
HANDLER_GO_ON
;

143 
	}
}

147 
	$mod_¡©us_row_­³nd
(
bufãr
 *
b
, cÚ¡ *
key
, cÚ¡ *
v®ue
) {

148 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" <tr>\n"));

149 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" <td><b>"));

150 
	`bufãr_­³nd_¡ršg
(
b
, 
key
);

151 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</b></td>\n"));

152 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" <td>"));

153 
	`bufãr_­³nd_¡ršg
(
b
, 
v®ue
);

154 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td>\n"));

155 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" </tr>\n"));

158 
	}
}

160 
	$mod_¡©us_h—d”_­³nd
(
bufãr
 *
b
, cÚ¡ *
key
) {

161 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" <tr>\n"));

162 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" <th colspan=\"2\">"));

163 
	`bufãr_­³nd_¡ršg
(
b
, 
key
);

164 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</th>\n"));

165 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" </tr>\n"));

168 
	}
}

170 
	$mod_¡©us_h—d”_­³nd_sÜt
(
bufãr
 *
b
, *
p_d
, cÚ¡ * 
key
) {

171 
¶ugš_d©a
 *
p
 = 
p_d
;

173 ià(
p
->
cÚf
.
sÜt
) {

174 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<th class=\"status\"><a href=\"#\" class=\"sortheader\" onclick=\"resort(this);return false;\">"));

175 
	`bufãr_­³nd_¡ršg
(
b
, 
key
);

176 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<span class=\"sortarrow\">:</span></a></th>\n"));

178 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<th class=\"status\">"));

179 
	`bufãr_­³nd_¡ršg
(
b
, 
key
);

180 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</th>\n"));

184 
	}
}

186 
	$mod_¡©us_g‘_muÉl›r
(*
avg
, *
muÉl›r
, 
size
) {

187 *
muÉl›r
 = ' ';

189 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'k'; }

190 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'M'; }

191 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'G'; }

192 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'T'; }

193 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'P'; }

194 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'E'; }

195 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'Z'; }

196 ià(*
avg
 > 
size
è{ *avg /ğsize; *
muÉl›r
 = 'Y'; }

199 
	}
}

201 
hªdËr_t
 
	$mod_¡©us_hªdË_£rv”_¡©us_html
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

202 
¶ugš_d©a
 *
p
 = 
p_d
;

203 
bufãr
 *
b
 = 
	`bufãr_š™
();

204 
size_t
 
j
;

205 
avg
;

206 
muÉl›r
 = '\0';

207 
buf
[32];

208 
time_t
 
ts
;

210 
days
, 
hours
, 
mšs
, 
£cÚds
;

213 
c¡©es
[
CON_STATE_CLOSE
+3];

214 
	`mem£t
(
c¡©es
, 0, (cstates));

216 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

234 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
è&& 0 =ğ
	`memcmp
(cÚ->uri.qu”y->
±r
, 
	`CONST_STR_LEN
("refresh="))) {

241 cÚ¡ 
»äesh
 = 
	`¡¹Ş
(
cÚ
->
uri
.
qu”y
->
±r
+("»äesh=")-1, 
NULL
, 10);

242 ià(
»äesh
 > 0) {

243 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<meta http-equiv=\"refresh\" content=\""));

244 
	`bufãr_­³nd_št
(
b
, 
»äesh
 < 604800 ?„efresh : 604800);

245 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\">\n"));

249 ià(
p
->
cÚf
.
sÜt
) {

250 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

313 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

320 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<h1>Server-Status ("));

321 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
cÚf
.
£rv”_g
);

322 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(")</h1>"));

324 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<table summary=\"status\" class=\"status\">"));

325 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Hostname</td><td class=\"string\">"));

326 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
uri
.
authÜ™y
);

327 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" ("));

328 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
£rv”_Çme
);

329 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(")</td></tr>\n"));

330 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Uptime</td><td class=\"string\">"));

332 
ts
 = 
¤v
->
cur_ts
 - srv->
¡¬tup_ts
;

334 
days
 = 
ts
 / (60 * 60 * 24);

335 
ts
 %= (60 * 60 * 24);

337 
hours
 = 
ts
 / (60 * 60);

338 
ts
 %= (60 * 60);

340 
mšs
 = 
ts
 / (60);

341 
ts
 %= (60);

343 
£cÚds
 = 
ts
;

345 ià(
days
) {

346 
	`bufãr_­³nd_št
(
b
, 
days
);

347 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" days "));

350 ià(
hours
) {

351 
	`bufãr_­³nd_št
(
b
, 
hours
);

352 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" hours "));

355 ià(
mšs
) {

356 
	`bufãr_­³nd_št
(
b
, 
mšs
);

357 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" min "));

360 
	`bufãr_­³nd_št
(
b
, 
£cÚds
);

361 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" s"));

363 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td></tr>\n"));

364 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Started‡t</td><td class=\"string\">"));

366 
ts
 = 
¤v
->
¡¬tup_ts
;

368 
	`¡ráime
(
buf
, (bufè- 1, "%Y-%m-%d %H:%M:%S", 
	`loÿÉime
(&
ts
));

369 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

370 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td></tr>\n"));

373 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><th colspan=\"2\">absolute (since start)</th></tr>\n"));

375 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Requests</td><td class=\"string\">"));

376 
avg
 = 
p
->
abs_»que¡s
;

378 
	`mod_¡©us_g‘_muÉl›r
(&
avg
, &
muÉl›r
, 1000);

380 
	`bufãr_­³nd_št
(
b
, 
avg
);

381 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

382 ià(
muÉl›r
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, &multiplier, 1);

383 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("req</td></tr>\n"));

385 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Traffic</td><td class=\"string\">"));

386 
avg
 = 
p
->
abs_Œaffic_out
;

388 
	`mod_¡©us_g‘_muÉl›r
(&
avg
, &
muÉl›r
, 1024);

390 
	`¢´štf
(
buf
, (buf), "%.2f", 
avg
);

391 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

392 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

393 ià(
muÉl›r
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, &multiplier, 1);

394 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("byte</td></tr>\n"));

398 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><th colspan=\"2\">average (since start)</th></tr>\n"));

400 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Requests</td><td class=\"string\">"));

401 
avg
 = 
p
->
abs_»que¡s
 / (
¤v
->
cur_ts
 - srv->
¡¬tup_ts
);

403 
	`mod_¡©us_g‘_muÉl›r
(&
avg
, &
muÉl›r
, 1000);

405 
	`bufãr_­³nd_št
(
b
, 
avg
);

406 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

407 ià(
muÉl›r
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, &multiplier, 1);

408 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("req/s</td></tr>\n"));

410 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Traffic</td><td class=\"string\">"));

411 
avg
 = 
p
->
abs_Œaffic_out
 / (
¤v
->
cur_ts
 - srv->
¡¬tup_ts
);

413 
	`mod_¡©us_g‘_muÉl›r
(&
avg
, &
muÉl›r
, 1024);

415 
	`¢´štf
(
buf
, (buf), "%.2f", 
avg
);

416 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

417 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

418 ià(
muÉl›r
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, &multiplier, 1);

419 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("byte/s</td></tr>\n"));

423 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><th colspan=\"2\">average (5s sliding‡verage)</th></tr>\n"));

424 
j
 = 0, 
avg
 = 0; j < 5; j++) {

425 
avg
 +ğ
p
->
mod_5s_»que¡s
[
j
];

428 
avg
 /= 5;

430 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Requests</td><td class=\"string\">"));

432 
	`mod_¡©us_g‘_muÉl›r
(&
avg
, &
muÉl›r
, 1000);

434 
	`bufãr_­³nd_št
(
b
, 
avg
);

435 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

436 ià(
muÉl›r
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, &multiplier, 1);

438 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("req/s</td></tr>\n"));

440 
j
 = 0, 
avg
 = 0; j < 5; j++) {

441 
avg
 +ğ
p
->
mod_5s_Œaffic_out
[
j
];

444 
avg
 /= 5;

446 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td>Traffic</td><td class=\"string\">"));

448 
	`mod_¡©us_g‘_muÉl›r
(&
avg
, &
muÉl›r
, 1024);

450 
	`¢´štf
(
buf
, (buf), "%.2f", 
avg
);

451 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

452 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

453 ià(
muÉl›r
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, &multiplier, 1);

454 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("byte/s</td></tr>\n"));

456 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</table>\n"));

458 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<hr />\n<pre>\n"));

460 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<b>"));

461 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cÚns
->
u£d
);

462 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" connections</b>\n"));

464 
j
 = 0; j < 
¤v
->
cÚns
->
u£d
; j++) {

465 
cÚÃùiÚ
 *
c
 = 
¤v
->
cÚns
->
±r
[
j
];

466 cÚ¡ *
¡©e
;

468 ià(
CON_STATE_READ
 =ğ
c
->
¡©e
 && !
	`bufãr_¡ršg_is_em±y
(c->
»que¡
.
Üig_uri
)) {

469 
¡©e
 = "k";

470 ++
c¡©es
[
CON_STATE_CLOSE
+2];

472 
¡©e
 = 
	`cÚÃùiÚ_g‘_shÜt_¡©e
(
c
->state);

473 ++
c¡©es
[(
c
->
¡©e
 <ğ
CON_STATE_CLOSE
 ? c->state : CON_STATE_CLOSE+1)];

476 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
¡©e
, 1);

478 ià(((
j
 + 1) % 50) == 0) {

479 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

482 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n\n<table>\n"));

483 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td style=\"text-align:right\">"));

484 
	`bufãr_­³nd_št
(
b
, 
c¡©es
[
CON_STATE_CLOSE
+2]);

485 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<td>&nbsp;&nbsp;k = keep-alive</td></tr>\n"));

486 
j
 = 0; j < 
CON_STATE_CLOSE
+2; ++j) {

488 ià(0 =ğ
c¡©es
[
j
] && j =ğ
CON_STATE_CLOSE
+1) ;

489 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td style=\"text-align:right\">"));

490 
	`bufãr_­³nd_št
(
b
, 
c¡©es
[
j
]);

491 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td>&nbsp;&nbsp;"));

492 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`cÚÃùiÚ_g‘_shÜt_¡©e
(
j
), 1);

493 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" = "));

494 
	`bufãr_­³nd_¡ršg
(
b
, 
	`cÚÃùiÚ_g‘_¡©e
(
j
));

495 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td></tr>\n"));

497 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</table>"));

499 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n</pre><hr />\n<h2>Connections</h2>\n"));

501 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<table summary=\"status\" class=\"status\">\n"));

502 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr>"));

503 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "Client IP");

504 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "Read");

505 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "Written");

506 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "State");

507 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "Time");

508 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "Host");

509 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "URI");

510 
	`mod_¡©us_h—d”_­³nd_sÜt
(
b
, 
p_d
, "File");

511 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</tr>\n"));

513 
j
 = 0; j < 
¤v
->
cÚns
->
u£d
; j++) {

514 
cÚÃùiÚ
 *
c
 = 
¤v
->
cÚns
->
±r
[
j
];

516 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<tr><td class=\"string\">"));

518 
	`bufãr_­³nd_¡ršg
(
b
, 
	`š‘_Áİ_ÿche_g‘_
(
¤v
, &(
c
->
d¡_addr
)));

520 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"int\">"));

522 ià(
c
->
»que¡
.
cÚ‹Á_Ëngth
) {

523 
	`bufãr_­³nd_št
(
b
, 
c
->
»que¡_cÚ‹Á_queue
->
by‹s_š
);

524 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("/"));

525 
	`bufãr_­³nd_št
(
b
, 
c
->
»que¡
.
cÚ‹Á_Ëngth
);

527 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("0/0"));

530 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"int\">"));

532 
	`bufãr_­³nd_št
(
b
, 
c
->
wr™e_queue
->
by‹s_out
);

533 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("/"));

534 
	`bufãr_­³nd_št
(
b
, 
c
->
wr™e_queue
->
by‹s_out
 + 
	`chunkqueue_Ëngth
(c->write_queue));

536 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"string\">"));

538 ià(
CON_STATE_READ
 =ğ
c
->
¡©e
 && !
	`bufãr_¡ršg_is_em±y
(c->
»que¡
.
Üig_uri
)) {

539 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("keep-alive"));

541 
	`bufãr_­³nd_¡ršg
(
b
, 
	`cÚÃùiÚ_g‘_¡©e
(
c
->
¡©e
));

544 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"int\">"));

546 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cur_ts
 - 
c
->
»que¡_¡¬t
);

548 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"string\">"));

550 ià(
	`bufãr_¡ršg_is_em±y
(
c
->
£rv”_Çme
)) {

551 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
c
->
uri
.
authÜ™y
);

554 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
c
->
£rv”_Çme
);

557 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"string\">"));

559 ià(!
	`bufãr_¡ršg_is_em±y
(
c
->
uri
.
·th
)) {

560 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
c
->
uri
.
·th
), 
ENCODING_HTML
);

563 ià(!
	`bufãr_¡ršg_is_em±y
(
c
->
uri
.
qu”y
)) {

564 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("?"));

565 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
c
->
uri
.
qu”y
), 
ENCODING_HTML
);

568 ià(!
	`bufãr_¡ršg_is_em±y
(
c
->
»que¡
.
Üig_uri
)) {

569 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" ("));

570 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
c
->
»que¡
.
Üig_uri
), 
ENCODING_HTML
);

571 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(")"));

573 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td><td class=\"string\">"));

575 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
c
->
physiÿl
.
·th
);

577 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</td></tr>\n"));

581 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

585 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

590 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

591 
	`bufãr_ä“
(
b
);

593 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/html"));

596 
	}
}

599 
hªdËr_t
 
	$mod_¡©us_hªdË_£rv”_¡©us_‹xt
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

600 
¶ugš_d©a
 *
p
 = 
p_d
;

601 
bufãr
 *
b
 = 
	`bufãr_š™
();

602 
avg
;

603 
time_t
 
ts
;

604 
buf
[32];

605 
k
;

606 
l
;

609 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Total Accesses: "));

610 
avg
 = 
p
->
abs_»que¡s
;

611 
	`¢´štf
(
buf
, (bufè- 1, "%.0f", 
avg
);

612 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

613 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

616 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Total kBytes: "));

617 
avg
 = 
p
->
abs_Œaffic_out
 / 1024;

618 
	`¢´štf
(
buf
, (bufè- 1, "%.0f", 
avg
);

619 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

620 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

623 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Uptime: "));

624 
ts
 = 
¤v
->
cur_ts
 - srv->
¡¬tup_ts
;

625 
	`bufãr_­³nd_št
(
b
, 
ts
);

626 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

629 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("BusyServers: "));

630 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cÚns
->
u£d
);

631 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

633 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("IdleServers: "));

634 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cÚns
->
size
 - srv->cÚns->
u£d
);

635 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

638 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Scoreboard: "));

639 
k
 = 0; k < 
¤v
->
cÚns
->
u£d
; k++) {

640 
cÚÃùiÚ
 *
c
 = 
¤v
->
cÚns
->
±r
[
k
];

641 cÚ¡ *
¡©e
 =

642 (
CON_STATE_READ
 =ğ
c
->
¡©e
 && !
	`bufãr_¡ršg_is_em±y
(c->
»que¡
.
Üig_uri
))

644 : 
	`cÚÃùiÚ_g‘_shÜt_¡©e
(
c
->
¡©e
);

645 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
¡©e
, 1);

647 
l
 = 0;† < 
¤v
->
cÚns
->
size
 - srv->cÚns->
u£d
;†++) {

648 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("_"));

650 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

652 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

653 
	`bufãr_ä“
(
b
);

656 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/plain"));

659 
	}
}

662 
hªdËr_t
 
	$mod_¡©us_hªdË_£rv”_¡©us_jsÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

663 
¶ugš_d©a
 *
p
 = 
p_d
;

664 
bufãr
 *
b
 = 
	`bufãr_š™
();

665 
avg
;

666 
time_t
 
ts
;

667 
buf
[32];

668 
size_t
 
j
;

669 
jsÚp
 = 0;

671 ià(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
qu”y
) >= ("jsonp=")-1

672 && 0 =ğ
	`memcmp
(
cÚ
->
uri
.
qu”y
->
±r
, 
	`CONST_STR_LEN
("jsonp="))) {

676 cÚ¡ *
f
 = 
cÚ
->
uri
.
qu”y
->
±r
 + ("jsonp=")-1;

677 
Ën
 = 0;

678 
	`light_i§Êum
(
f
[
Ën
]) || f[len] == '_') ++len;

679 ià(0 !ğ
Ën
 && 
	`light_i§Íha
(
f
[0]) && f[len] == '\0') {

680 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
f
, 
Ën
);

681 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("("));

682 
jsÚp
 = 1;

687 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("{\n\t\"RequestsTotal\": "));

688 
avg
 = 
p
->
abs_»que¡s
;

689 
	`¢´štf
(
buf
, (bufè- 1, "%.0f", 
avg
);

690 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

691 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(",\n"));

694 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\t\"TrafficTotal\": "));

695 
avg
 = 
p
->
abs_Œaffic_out
 / 1024;

696 
	`¢´štf
(
buf
, (bufè- 1, "%.0f", 
avg
);

697 
	`bufãr_­³nd_¡ršg
(
b
, 
buf
);

698 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(",\n"));

701 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\t\"Uptime\": "));

702 
ts
 = 
¤v
->
cur_ts
 - srv->
¡¬tup_ts
;

703 
	`bufãr_­³nd_št
(
b
, 
ts
);

704 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(",\n"));

707 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\t\"BusyServers\": "));

708 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cÚns
->
u£d
);

709 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(",\n"));

711 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\t\"IdleServers\": "));

712 
	`bufãr_­³nd_št
(
b
, 
¤v
->
cÚns
->
size
 - srv->cÚns->
u£d
);

713 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(",\n"));

715 
j
 = 0, 
avg
 = 0; j < 5; j++) {

716 
avg
 +ğ
p
->
mod_5s_»que¡s
[
j
];

719 
avg
 /= 5;

721 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\t\"RequestAverage5s\":"));

722 
	`bufãr_­³nd_št
(
b
, 
avg
);

723 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(",\n"));

725 
j
 = 0, 
avg
 = 0; j < 5; j++) {

726 
avg
 +ğ
p
->
mod_5s_Œaffic_out
[
j
];

729 
avg
 /= 5;

731 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\t\"TrafficAverage5s\":"));

732 
	`bufãr_­³nd_št
(
b
, 
avg
 / 1024);

733 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n}"));

735 ià(
jsÚp
è
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(");"));

737 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

738 
	`bufãr_ä“
(
b
);

741 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("application/javascript"));

744 
	}
}

747 
hªdËr_t
 
	$mod_¡©us_hªdË_£rv”_¡©i¡ics
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

748 
bufãr
 *
b
;

749 
size_t
 
i
;

750 
¬¿y
 *
¡
 = 
¤v
->
¡©us
;

751 
	`UNUSED
(
p_d
);

753 ià(0 =ğ
¡
->
u£d
) {

755 
cÚ
->
h‰p_¡©us
 = 204;

756 
cÚ
->
fe_fšished
 = 1;

758  
HANDLER_FINISHED
;

761 
b
 = 
	`bufãr_š™
();

762 
i
 = 0; i < 
¡
->
u£d
; i++) {

763 
size_t
 
ndx
 = 
¡
->
sÜ‹d
[
i
];

765 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
¡
->
d©a
[
ndx
]->
key
);

766 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(": "));

767 
	`bufãr_­³nd_št
(
b
, ((
d©a_š‹g”
 *)(
¡
->
d©a
[
ndx
]))->
v®ue
);

768 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\n"));

771 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

772 
	`bufãr_ä“
(
b
);

774 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/plain"));

776 
cÚ
->
h‰p_¡©us
 = 200;

777 
cÚ
->
fe_fšished
 = 1;

779  
HANDLER_FINISHED
;

780 
	}
}

783 
hªdËr_t
 
	$mod_¡©us_hªdË_£rv”_¡©us
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

785 ià(
	`bufãr_is_equ®_¡ršg
(
cÚ
->
uri
.
qu”y
, 
	`CONST_STR_LEN
("auto"))) {

786 
	`mod_¡©us_hªdË_£rv”_¡©us_‹xt
(
¤v
, 
cÚ
, 
p_d
);

787 } ià(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
qu”y
) >= ("json")-1

788 && 0 =ğ
	`memcmp
(
cÚ
->
uri
.
qu”y
->
±r
, 
	`CONST_STR_LEN
("json"))) {

789 
	`mod_¡©us_hªdË_£rv”_¡©us_jsÚ
(
¤v
, 
cÚ
, 
p_d
);

791 
	`mod_¡©us_hªdË_£rv”_¡©us_html
(
¤v
, 
cÚ
, 
p_d
);

794 
cÚ
->
h‰p_¡©us
 = 200;

795 
cÚ
->
fe_fšished
 = 1;

797  
HANDLER_FINISHED
;

798 
	}
}

801 
hªdËr_t
 
	$mod_¡©us_hªdË_£rv”_cÚfig
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

802 
¶ugš_d©a
 *
p
 = 
p_d
;

803 
bufãr
 *
b
 = 
	`bufãr_š™
();

804 
bufãr
 *
m
 = 
p
->
moduË_li¡
;

805 
size_t
 
i
;

807 
	sev_m­
 { 
fdev’t_hªdËr_t
 
‘
; cÚ¡ *
Çme
; } 
ev’t_hªdËrs
[] =

812 #ifdeà
USE_LINUX_EPOLL


813 { 
FDEVENT_HANDLER_LINUX_SYSEPOLL
, "linux-sysepoll" },

815 #ifdeà
USE_POLL


816 { 
FDEVENT_HANDLER_POLL
, "poll" },

818 #ifdeà
USE_SELECT


819 { 
FDEVENT_HANDLER_SELECT
, "select" },

821 #ifdeà
USE_LIBEV


822 { 
FDEVENT_HANDLER_LIBEV
, "libev" },

824 #ifdeà
USE_SOLARIS_DEVPOLL


825 { 
FDEVENT_HANDLER_SOLARIS_DEVPOLL
,"solaris-devpoll" },

827 #ifdeà
USE_SOLARIS_PORT


828 { 
FDEVENT_HANDLER_SOLARIS_PORT
, "solaris-eventports" },

830 #ifdeà
USE_FREEBSD_KQUEUE


831 { 
FDEVENT_HANDLER_FREEBSD_KQUEUE
, "freebsd-kqueue" },

833 { 
FDEVENT_HANDLER_UNSET
, 
NULL
 }

836 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

846 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
cÚf
.
£rv”_g
);

847 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

851 
	`mod_¡©us_h—d”_­³nd
(
b
, "Server-Features");

852 #ifdeà
HAVE_PCRE_H


853 
	`mod_¡©us_row_­³nd
(
b
, "RegEx Conditionals", "enabled");

855 
	`mod_¡©us_row_­³nd
(
b
, "RegEx Conditionals", "disabled -…cre missing");

857 
	`mod_¡©us_h—d”_­³nd
(
b
, "Network Engine");

859 
i
 = 0; 
ev’t_hªdËrs
[i].
Çme
; i++) {

860 ià(
ev’t_hªdËrs
[
i
].
‘
 =ğ
¤v
->
ev’t_hªdËr
) {

861 
	`mod_¡©us_row_­³nd
(
b
, "fd-Ev’t-HªdËr", 
ev’t_hªdËrs
[
i
].
Çme
);

866 
	`mod_¡©us_h—d”_­³nd
(
b
, "Config-File-Settings");

868 
i
 = 0; i < 
¤v
->
¶ugšs
.
u£d
; i++) {

869 
¶ugš
 **
ps
 = 
¤v
->
¶ugšs
.
±r
;

871 
¶ugš
 *
¶
 = 
ps
[
i
];

873 ià(
i
 == 0) {

874 
	`bufãr_cİy_bufãr
(
m
, 
¶
->
Çme
);

876 
	`bufãr_­³nd_¡ršg_Ën
(
m
, 
	`CONST_STR_LEN
("<br />"));

877 
	`bufãr_­³nd_¡ršg_bufãr
(
m
, 
¶
->
Çme
);

881 
	`mod_¡©us_row_­³nd
(
b
, "Lßded ModuËs", 
m
->
±r
);

883 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" </table>\n"));

885 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

890 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

891 
	`bufãr_ä“
(
b
);

893 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/html"));

895 
cÚ
->
h‰p_¡©us
 = 200;

896 
cÚ
->
fe_fšished
 = 1;

898  
HANDLER_FINISHED
;

899 
	}
}

901 
	#PATCH
(
x
) \

902 
p
->
cÚf
.
x
 = 
s
->x;

	)

903 
	$mod_¡©us_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

904 
size_t
 
i
, 
j
;

905 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

907 
	`PATCH
(
¡©us_u¾
);

908 
	`PATCH
(
cÚfig_u¾
);

909 
	`PATCH
(
sÜt
);

910 
	`PATCH
(
¡©i¡ics_u¾
);

913 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

914 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

915 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

918 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

921 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

922 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

924 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("status.status-url"))) {

925 
	`PATCH
(
¡©us_u¾
);

926 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("status.config-url"))) {

927 
	`PATCH
(
cÚfig_u¾
);

928 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("status.enable-sort"))) {

929 
	`PATCH
(
sÜt
);

930 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("status.statistics-url"))) {

931 
	`PATCH
(
¡©i¡ics_u¾
);

937 
	}
}

939 
hªdËr_t
 
	$mod_¡©us_hªdËr
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

940 
¶ugš_d©a
 *
p
 = 
p_d
;

942 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

944 
	`mod_¡©us_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

946 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
¡©us_u¾
) &&

947 
	`bufãr_is_equ®
(
p
->
cÚf
.
¡©us_u¾
, 
cÚ
->
uri
.
·th
)) {

948  
	`mod_¡©us_hªdË_£rv”_¡©us
(
¤v
, 
cÚ
, 
p_d
);

949 } ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
cÚfig_u¾
) &&

950 
	`bufãr_is_equ®
(
p
->
cÚf
.
cÚfig_u¾
, 
cÚ
->
uri
.
·th
)) {

951  
	`mod_¡©us_hªdË_£rv”_cÚfig
(
¤v
, 
cÚ
, 
p_d
);

952 } ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
¡©i¡ics_u¾
) &&

953 
	`bufãr_is_equ®
(
p
->
cÚf
.
¡©i¡ics_u¾
, 
cÚ
->
uri
.
·th
)) {

954  
	`mod_¡©us_hªdË_£rv”_¡©i¡ics
(
¤v
, 
cÚ
, 
p_d
);

957  
HANDLER_GO_ON
;

958 
	}
}

960 
	$TRIGGER_FUNC
(
mod_¡©us_Œigg”
) {

961 
¶ugš_d©a
 *
p
 = 
p_d
;

962 
size_t
 
i
;

965 
i
 = 0; i < 
¤v
->
cÚns
->
u£d
; i++) {

966 
cÚÃùiÚ
 *
c
 = 
¤v
->
cÚns
->
±r
[
i
];

968 
p
->
by‹s_wr™‹n
 +ğ
c
->
by‹s_wr™‹n_cur_£cÚd
;

972 
p
->
mod_5s_Œaffic_out
[p->
mod_5s_ndx
] =…->
by‹s_wr™‹n
;

973 
p
->
mod_5s_»que¡s
 [p->
mod_5s_ndx
] =…->
»que¡s
;

975 
p
->
mod_5s_ndx
 = (p->mod_5s_ndx+1) % 5;

977 
p
->
abs_Œaffic_out
 +ğp->
by‹s_wr™‹n
;

978 
p
->
»l_Œaffic_out
 +ğp->
by‹s_wr™‹n
;

980 
p
->
by‹s_wr™‹n
 = 0;

983 
p
->
Œaffic_out
 = 0;

984 
p
->
»que¡s
 = 0;

986  
HANDLER_GO_ON
;

987 
	}
}

989 
	$REQUESTDONE_FUNC
(
mod_¡©us_accouÁ
) {

990 
¶ugš_d©a
 *
p
 = 
p_d
;

992 
	`UNUSED
(
¤v
);

994 
p
->
»que¡s
++;

995 
p
->
»l_»que¡s
++;

996 
p
->
abs_»que¡s
++;

998 
p
->
by‹s_wr™‹n
 +ğ
cÚ
->
by‹s_wr™‹n_cur_£cÚd
;

1000  
HANDLER_GO_ON
;

1001 
	}
}

1003 
mod_¡©us_¶ugš_š™
(
¶ugš
 *
p
);

1004 
	$mod_¡©us_¶ugš_š™
(
¶ugš
 *
p
) {

1005 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

1006 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("status");

1008 
p
->
š™
 = 
mod_¡©us_š™
;

1009 
p
->
ş—nup
 = 
mod_¡©us_ä“
;

1010 
p
->
£t_deçuÉs
ğ
mod_¡©us_£t_deçuÉs
;

1012 
p
->
hªdË_uri_ş—n
 = 
mod_¡©us_hªdËr
;

1013 
p
->
hªdË_Œigg”
 = 
mod_¡©us_Œigg”
;

1014 
p
->
hªdË_»que¡_dÚe
 = 
mod_¡©us_accouÁ
;

1016 
p
->
d©a
 = 
NULL
;

1019 
	}
}

	@mod_trigger_b4_dl.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

8 
	~"»¥Ú£.h
"

9 
	~"š‘_Áİ_ÿche.h
"

11 
	~<ùy³.h
>

12 
	~<¡dlib.h
>

13 
	~<fú.h
>

14 
	~<¡ršg.h
>

16 #ià
defšed
(
HAVE_GDBM_H
)

17 
	~<gdbm.h
>

20 #ià
defšed
(
HAVE_PCRE_H
)

21 
	~<püe.h
>

24 #ià
defšed
(
USE_MEMCACHED
)

25 
	~<libmemÿched/memÿched.h
>

36 
bufãr
 *
	mdb_f’ame
;

38 
bufãr
 *
	mŒigg”_u¾
;

39 
bufãr
 *
	mdowÆßd_u¾
;

40 
bufãr
 *
	md’y_u¾
;

42 
¬¿y
 *
	mmc_ho¡s
;

43 
bufãr
 *
	mmc_Çme¥aû
;

44 #ià
defšed
(
HAVE_PCRE_H
)

45 
püe
 *
	mŒigg”_»gex
;

46 
püe
 *
	mdowÆßd_»gex
;

48 #ià
defšed
(
HAVE_GDBM_H
)

49 
GDBM_FILE
 
	mdb
;

52 #ià
defšed
(
USE_MEMCACHED
)

53 
memÿched_¡
 *
	mmemc
;

56 
	mŒigg”_timeout
;

57 
	mdebug
;

58 } 
	t¶ugš_cÚfig
;

61 
	mPLUGIN_DATA
;

63 
bufãr
 *
	mtmp_buf
;

65 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

67 
¶ugš_cÚfig
 
	mcÚf
;

68 } 
	t¶ugš_d©a
;

71 
	$INIT_FUNC
(
mod_Œigg”_b4_dl_š™
) {

72 
¶ugš_d©a
 *
p
;

74 
p
 = 
	`ÿÎoc
(1, (*p));

76 
p
->
tmp_buf
 = 
	`bufãr_š™
();

78  
p
;

79 
	}
}

82 
	$FREE_FUNC
(
mod_Œigg”_b4_dl_ä“
) {

83 
¶ugš_d©a
 *
p
 = 
p_d
;

85 
	`UNUSED
(
¤v
);

87 ià(!
p
è 
HANDLER_GO_ON
;

89 ià(
p
->
cÚfig_¡Üage
) {

90 
size_t
 
i
;

91 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

92 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

94 ià(
NULL
 =ğ
s
) ;

96 
	`bufãr_ä“
(
s
->
db_f’ame
);

97 
	`bufãr_ä“
(
s
->
dowÆßd_u¾
);

98 
	`bufãr_ä“
(
s
->
Œigg”_u¾
);

99 
	`bufãr_ä“
(
s
->
d’y_u¾
);

101 
	`bufãr_ä“
(
s
->
mc_Çme¥aû
);

102 
	`¬¿y_ä“
(
s
->
mc_ho¡s
);

104 #ià
	`defšed
(
HAVE_PCRE_H
)

105 ià(
s
->
Œigg”_»gex
è
	`püe_ä“
(s->trigger_regex);

106 ià(
s
->
dowÆßd_»gex
è
	`püe_ä“
(s->download_regex);

108 #ià
	`defšed
(
HAVE_GDBM_H
)

109 ià(
s
->
db
è
	`gdbm_şo£
(s->db);

111 #ià
	`defšed
(
USE_MEMCACHED
)

112 ià(
s
->
memc
è
	`memÿched_ä“
(s->memc);

115 
	`ä“
(
s
);

117 
	`ä“
(
p
->
cÚfig_¡Üage
);

120 
	`bufãr_ä“
(
p
->
tmp_buf
);

122 
	`ä“
(
p
);

124  
HANDLER_GO_ON
;

125 
	}
}

129 
	$SETDEFAULTS_FUNC
(
mod_Œigg”_b4_dl_£t_deçuÉs
) {

130 
¶ugš_d©a
 *
p
 = 
p_d
;

131 
size_t
 
i
 = 0;

134 
cÚfig_v®ues_t
 
cv
[] = {

135 { "Œigg”-befÜe-dowÆßd.gdbm-f’ame", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

136 { "Œigg”-befÜe-dowÆßd.Œigg”-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

137 { "Œigg”-befÜe-dowÆßd.dowÆßd-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

138 { "Œigg”-befÜe-dowÆßd.d’y-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

139 { "Œigg”-befÜe-dowÆßd.Œigg”-timeout", 
NULL
, 
T_CONFIG_SHORT
, 
T_CONFIG_SCOPE_CONNECTION
 },

140 { "Œigg”-befÜe-dowÆßd.memÿche-ho¡s", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

141 { "Œigg”-befÜe-dowÆßd.memÿche-Çme¥aû", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

142 { "Œigg”-befÜe-dowÆßd.debug", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

143 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

146 ià(!
p
è 
HANDLER_ERROR
;

148 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

150 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

151 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

152 
¶ugš_cÚfig
 *
s
;

153 #ià
	`defšed
(
HAVE_PCRE_H
)

154 cÚ¡ *
”½Œ
;

155 
”roff
;

158 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

159 
s
->
db_f’ame
 = 
	`bufãr_š™
();

160 
s
->
dowÆßd_u¾
 = 
	`bufãr_š™
();

161 
s
->
Œigg”_u¾
 = 
	`bufãr_š™
();

162 
s
->
d’y_u¾
 = 
	`bufãr_š™
();

163 
s
->
mc_ho¡s
 = 
	`¬¿y_š™
();

164 
s
->
mc_Çme¥aû
 = 
	`bufãr_š™
();

166 
cv
[0].
de¡š©iÚ
 = 
s
->
db_f’ame
;

167 
cv
[1].
de¡š©iÚ
 = 
s
->
Œigg”_u¾
;

168 
cv
[2].
de¡š©iÚ
 = 
s
->
dowÆßd_u¾
;

169 
cv
[3].
de¡š©iÚ
 = 
s
->
d’y_u¾
;

170 
cv
[4].
de¡š©iÚ
 = &(
s
->
Œigg”_timeout
);

171 
cv
[5].
de¡š©iÚ
 = 
s
->
mc_ho¡s
;

172 
cv
[6].
de¡š©iÚ
 = 
s
->
mc_Çme¥aû
;

173 
cv
[7].
de¡š©iÚ
 = &(
s
->
debug
);

175 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

177 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

178  
HANDLER_ERROR
;

180 #ià
	`defšed
(
HAVE_GDBM_H
)

181 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
db_f’ame
)) {

182 ià(
NULL
 =ğ(
s
->
db
 = 
	`gdbm_İ’
(s->
db_f’ame
->
±r
, 4096, 
GDBM_WRCREAT
 | 
GDBM_NOLOCK
, 
S_IRUSR
 | 
S_IWUSR
, 0))) {

183 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

185  
HANDLER_ERROR
;

187 
	`fd_şo£_Ú_exec
(
	`gdbm_fdesc
(
s
->
db
));

190 #ià
	`defšed
(
HAVE_PCRE_H
)

191 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
dowÆßd_u¾
)) {

192 ià(
NULL
 =ğ(
s
->
dowÆßd_»gex
 = 
	`püe_compe
(s->
dowÆßd_u¾
->
±r
,

193 0, &
”½Œ
, &
”roff
, 
NULL
))) {

195 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

197 
s
->
dowÆßd_u¾
, "pos:", 
”roff
);

198  
HANDLER_ERROR
;

202 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
Œigg”_u¾
)) {

203 ià(
NULL
 =ğ(
s
->
Œigg”_»gex
 = 
	`püe_compe
(s->
Œigg”_u¾
->
±r
,

204 0, &
”½Œ
, &
”roff
, 
NULL
))) {

206 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

208 
s
->
Œigg”_u¾
, "pos:", 
”roff
);

210  
HANDLER_ERROR
;

215 ià(
s
->
mc_ho¡s
->
u£d
) {

216 #ià
	`defšed
(
USE_MEMCACHED
)

217 
bufãr
 *
İtiÚ_¡ršg
 = 
	`bufãr_š™
();

218 
size_t
 
k
;

221 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
mc_ho¡s
->
d©a
[0];

223 
	`bufãr_­³nd_¡ršg_Ën
(
İtiÚ_¡ršg
, 
	`CONST_STR_LEN
("--SERVER="));

224 
	`bufãr_­³nd_¡ršg_bufãr
(
İtiÚ_¡ršg
, 
ds
->
v®ue
);

227 
k
 = 1; k < 
s
->
mc_ho¡s
->
u£d
; k++) {

228 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
s
->
mc_ho¡s
->
d©a
[
k
];

230 
	`bufãr_­³nd_¡ršg_Ën
(
İtiÚ_¡ršg
, 
	`CONST_STR_LEN
(" --SERVER="));

231 
	`bufãr_­³nd_¡ršg_bufãr
(
İtiÚ_¡ršg
, 
ds
->
v®ue
);

234 
s
->
memc
 = 
	`memÿched
(
	`CONST_BUF_LEN
(
İtiÚ_¡ršg
));

236 ià(
NULL
 =ğ
s
->
memc
) {

237 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

239 
İtiÚ_¡ršg
);

241 
	`bufãr_ä“
(
İtiÚ_¡ršg
);

243 ià(
NULL
 =ğ
s
->
memc
è 
HANDLER_ERROR
;

245 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

247  
HANDLER_ERROR
;

252  
HANDLER_GO_ON
;

253 
	}
}

255 
	#PATCH
(
x
) \

256 
p
->
cÚf
.
x
 = 
s
->x;

	)

257 
	$mod_Œigg”_b4_dl_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

258 
size_t
 
i
, 
j
;

259 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

261 #ià
	`defšed
(
HAVE_GDBM
)

262 
	`PATCH
(
db
);

264 #ià
	`defšed
(
HAVE_PCRE_H
)

265 
	`PATCH
(
dowÆßd_»gex
);

266 
	`PATCH
(
Œigg”_»gex
);

268 
	`PATCH
(
Œigg”_timeout
);

269 
	`PATCH
(
d’y_u¾
);

270 
	`PATCH
(
mc_Çme¥aû
);

271 
	`PATCH
(
debug
);

272 #ià
	`defšed
(
USE_MEMCACHED
)

273 
	`PATCH
(
memc
);

277 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

278 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

279 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

282 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

285 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

286 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

288 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.download-url"))) {

289 #ià
	`defšed
(
HAVE_PCRE_H
)

290 
	`PATCH
(
dowÆßd_»gex
);

292 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.trigger-url"))) {

293 #ià
	`defšed
(
HAVE_PCRE_H
)

294 
	`PATCH
(
Œigg”_»gex
);

296 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.gdbm-filename"))) {

297 #ià
	`defšed
(
HAVE_GDBM_H
)

298 
	`PATCH
(
db
);

300 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.trigger-timeout"))) {

301 
	`PATCH
(
Œigg”_timeout
);

302 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.debug"))) {

303 
	`PATCH
(
debug
);

304 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.deny-url"))) {

305 
	`PATCH
(
d’y_u¾
);

306 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.memcache-namespace"))) {

307 
	`PATCH
(
mc_Çme¥aû
);

308 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("trigger-before-download.memcache-hosts"))) {

309 #ià
	`defšed
(
USE_MEMCACHED
)

310 
	`PATCH
(
memc
);

317 
	}
}

318 #undeà
PATCH


320 
	$URIHANDLER_FUNC
(
mod_Œigg”_b4_dl_uri_hªdËr
) {

321 
¶ugš_d©a
 *
p
 = 
p_d
;

322 cÚ¡ *
»mÙe_
;

323 
d©a_¡ršg
 *
ds
;

325 #ià
	`defšed
(
HAVE_PCRE_H
)

326 
n
;

327 
	#N
 10

	)

328 
ovec
[
N
 * 3];

330 ià(
cÚ
->
mode
 !ğ
DIRECT
è 
HANDLER_GO_ON
;

332 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

334 
	`mod_Œigg”_b4_dl_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

336 ià(!
p
->
cÚf
.
Œigg”_»gex
 || !p->cÚf.
dowÆßd_»gex
è 
HANDLER_GO_ON
;

338 #ià!
	`defšed
(
HAVE_GDBM_H
è&& !defšed(
USE_MEMCACHED
)

339  
HANDLER_GO_ON
;

340 #–ià
	`defšed
(
HAVE_GDBM_H
è&& defšed(
USE_MEMCACHED
)

341 ià(!
p
->
cÚf
.
db
 && !p->cÚf.
memc
è 
HANDLER_GO_ON
;

342 ià(
p
->
cÚf
.
db
 &&…->cÚf.
memc
) {

345  
HANDLER_GO_ON
;

347 #–ià
	`defšed
(
HAVE_GDBM_H
)

348 ià(!
p
->
cÚf
.
db
è 
HANDLER_GO_ON
;

350 ià(!
p
->
cÚf
.
memc
è 
HANDLER_GO_ON
;

353 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "X-Forwarded-For"))) {

356 
»mÙe_
 = 
ds
->
v®ue
->
±r
;

360 
»mÙe_
 = 
	`š‘_Áİ_ÿche_g‘_
(
¤v
, &(
cÚ
->
d¡_addr
));

363 ià(
p
->
cÚf
.
debug
) {

364 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "(debugè»mÙe-:", 
»mÙe_
);

368 ià((
n
 = 
	`püe_exec
(
p
->
cÚf
.
Œigg”_»gex
, 
NULL
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
), 0, 0, 
ovec
, 3 * 
N
)) < 0) {

369 ià(
n
 !ğ
PCRE_ERROR_NOMATCH
) {

370 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

371 "executiÚƒ¼Ü whm©chšg:", 
n
);

373  
HANDLER_ERROR
;

376 #ià
	`defšed
(
HAVE_GDBM_H
)

377 ià(
p
->
cÚf
.
db
) {

379 
d©um
 
key
, 
v®
;

381 
key
.
d±r
 = (*)
»mÙe_
;

382 
key
.
dsize
 = 
	`¡¾’
(
»mÙe_
);

384 
v®
.
d±r
 = (*)&(
¤v
->
cur_ts
);

385 
v®
.
dsize
 = (
¤v
->
cur_ts
);

387 ià(0 !ğ
	`gdbm_¡Üe
(
p
->
cÚf
.
db
, 
key
, 
v®
, 
GDBM_REPLACE
)) {

388 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

393 #ià
	`defšed
(
USE_MEMCACHED
)

394 ià(
p
->
cÚf
.
memc
) {

395 
size_t
 
i
, 
Ën
;

396 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
,…->
cÚf
.
mc_Çme¥aû
);

397 
	`bufãr_­³nd_¡ršg
(
p
->
tmp_buf
, 
»mÙe_
);

399 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
p
->
tmp_buf
);

400 
i
 = 0; i < 
Ën
; i++) {

401 ià(
p
->
tmp_buf
->
±r
[
i
] == ' ')…->tmp_buf->ptr[i] = '-';

404 ià(
p
->
cÚf
.
debug
) {

405 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "(debugèŒigg”ed IP:", 
p
->
tmp_buf
);

408 ià(
MEMCACHED_SUCCESS
 !ğ
	`memÿched_£t
(
p
->
cÚf
.
memc
,

409 
	`CONST_BUF_LEN
(
p
->
tmp_buf
),

410 (cÚ¡ *)&(
¤v
->
cur_ts
), (srv->cur_ts),

411 
p
->
cÚf
.
Œigg”_timeout
, 0)) {

412 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

420 ià((
n
 = 
	`püe_exec
(
p
->
cÚf
.
dowÆßd_»gex
, 
NULL
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
), 0, 0, 
ovec
, 3 * 
N
)) < 0) {

421 ià(
n
 !ğ
PCRE_ERROR_NOMATCH
) {

422 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

423 "executiÚƒ¼Ü whm©chšg: ", 
n
);

424  
HANDLER_ERROR
;

428 #ià
	`defšed
(
HAVE_GDBM_H
)

429 ià(
p
->
cÚf
.
db
) {

430 
d©um
 
key
, 
v®
;

431 
time_t
 
Ï¡_h™
;

433 
key
.
d±r
 = (*)
»mÙe_
;

434 
key
.
dsize
 = 
	`¡¾’
(
»mÙe_
);

436 
v®
 = 
	`gdbm_ãtch
(
p
->
cÚf
.
db
, 
key
);

438 ià(
v®
.
d±r
 =ğ
NULL
) {

441 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("LoÿtiÚ"), 
	`CONST_BUF_LEN
(
p
->
cÚf
.
d’y_u¾
));

442 
cÚ
->
h‰p_¡©us
 = 307;

443 
cÚ
->
fe_fšished
 = 1;

445  
HANDLER_FINISHED
;

448 
	`memıy
(&
Ï¡_h™
, 
v®
.
d±r
, (
time_t
));

450 
	`ä“
(
v®
.
d±r
);

452 ià(
¤v
->
cur_ts
 - 
Ï¡_h™
 > 
p
->
cÚf
.
Œigg”_timeout
) {

455 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("LoÿtiÚ"), 
	`CONST_BUF_LEN
(
p
->
cÚf
.
d’y_u¾
));

456 
cÚ
->
h‰p_¡©us
 = 307;

457 
cÚ
->
fe_fšished
 = 1;

459 ià(
p
->
cÚf
.
db
) {

460 ià(0 !ğ
	`gdbm_d–‘e
(
p
->
cÚf
.
db
, 
key
)) {

461 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

466  
HANDLER_FINISHED
;

469 
v®
.
d±r
 = (*)&(
¤v
->
cur_ts
);

470 
v®
.
dsize
 = (
¤v
->
cur_ts
);

472 ià(0 !ğ
	`gdbm_¡Üe
(
p
->
cÚf
.
db
, 
key
, 
v®
, 
GDBM_REPLACE
)) {

473 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

479 #ià
	`defšed
(
USE_MEMCACHED
)

480 ià(
p
->
cÚf
.
memc
) {

481 
size_t
 
i
, 
Ën
;

483 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
,…->
cÚf
.
mc_Çme¥aû
);

484 
	`bufãr_­³nd_¡ršg
(
p
->
tmp_buf
, 
»mÙe_
);

486 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
p
->
tmp_buf
);

487 
i
 = 0; i < 
Ën
; i++) {

488 ià(
p
->
tmp_buf
->
±r
[
i
] == ' ')…->tmp_buf->ptr[i] = '-';

491 ià(
p
->
cÚf
.
debug
) {

492 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "(debugècheckšg IP:", 
p
->
tmp_buf
);

501 ià(
MEMCACHED_SUCCESS
 !ğ
	`memÿched_exi¡
(
p
->
cÚf
.
memc
, 
	`CONST_BUF_LEN
Õ->
tmp_buf
))) {

502 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("LoÿtiÚ"), 
	`CONST_BUF_LEN
(
p
->
cÚf
.
d’y_u¾
));

504 
cÚ
->
h‰p_¡©us
 = 307;

505 
cÚ
->
fe_fšished
 = 1;

507  
HANDLER_FINISHED
;

511 ià(
MEMCACHED_SUCCESS
 !ğ
	`memÿched_£t
(
p
->
cÚf
.
memc
,

512 
	`CONST_BUF_LEN
(
p
->
tmp_buf
),

513 (cÚ¡ *)&(
¤v
->
cur_ts
), (srv->cur_ts),

514 
p
->
cÚf
.
Œigg”_timeout
, 0)) {

515 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

523 
	`UNUSED
(
¤v
);

524 
	`UNUSED
(
cÚ
);

525 
	`UNUSED
(
p_d
);

528  
HANDLER_GO_ON
;

529 
	}
}

531 #ià
defšed
(
HAVE_GDBM_H
)

532 
	$TRIGGER_FUNC
(
mod_Œigg”_b4_dl_hªdË_Œigg”
) {

533 
¶ugš_d©a
 *
p
 = 
p_d
;

534 
size_t
 
i
;

537 ià(
¤v
->
cur_ts
 % 60 !ğ0è 
HANDLER_GO_ON
;

540 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

541 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

542 
d©um
 
key
, 
v®
, 
okey
;

544 ià(!
s
->
db
) ;

546 
okey
.
d±r
 = 
NULL
;

552 
key
 = 
	`gdbm_fœ¡key
(
s
->
db
); key.
d±r
; key = 
	`gdbm_Ãxtkey
(s->db, 
okey
)) {

553 
time_t
 
Ï¡_h™
;

554 ià(
okey
.
d±r
) {

555 
	`ä“
(
okey
.
d±r
);

556 
okey
.
d±r
 = 
NULL
;

559 
v®
 = 
	`gdbm_ãtch
(
s
->
db
, 
key
);

561 
	`memıy
(&
Ï¡_h™
, 
v®
.
d±r
, (
time_t
));

563 
	`ä“
(
v®
.
d±r
);

565 ià(
¤v
->
cur_ts
 - 
Ï¡_h™
 > 
s
->
Œigg”_timeout
) {

566 
	`gdbm_d–‘e
(
s
->
db
, 
key
);

569 
okey
 = 
key
;

571 ià(
okey
.
d±r
è
	`ä“
(okey.dptr);

574 ià((
¤v
->
cur_ts
 % (60 * 60 * 24è!ğ0)è
	`gdbm_»Ügªize
(
s
->
db
);

576  
HANDLER_GO_ON
;

577 
	}
}

582 
mod_Œigg”_b4_dl_¶ugš_š™
(
¶ugš
 *
p
);

583 
	$mod_Œigg”_b4_dl_¶ugš_š™
(
¶ugš
 *
p
) {

584 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

585 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("trigger_b4_dl");

587 
p
->
š™
 = 
mod_Œigg”_b4_dl_š™
;

588 
p
->
hªdË_uri_ş—n
 = 
mod_Œigg”_b4_dl_uri_hªdËr
;

589 
p
->
£t_deçuÉs
 = 
mod_Œigg”_b4_dl_£t_deçuÉs
;

590 #ià
	`defšed
(
HAVE_GDBM_H
)

591 
p
->
hªdË_Œigg”
 = 
mod_Œigg”_b4_dl_hªdË_Œigg”
;

593 
p
->
ş—nup
 = 
mod_Œigg”_b4_dl_ä“
;

595 
p
->
d©a
 = 
NULL
;

598 
	}
}

	@mod_uploadprogress.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"¶ugš.h
"

9 
	~"»¥Ú£.h
"

10 
	~"¡©_ÿche.h
"

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

21 
bufãr
 *
	mcÚ_id
;

22 
cÚÃùiÚ
 *
	mcÚ
;

23 } 
	tcÚÃùiÚ_m­_’Œy
;

26 
cÚÃùiÚ_m­_’Œy
 **
	m±r
;

28 
size_t
 
	mu£d
;

29 
size_t
 
	msize
;

30 } 
	tcÚÃùiÚ_m­
;

35 
bufãr
 *
	m´og»ss_u¾
;

36 } 
	t¶ugš_cÚfig
;

39 
	mPLUGIN_DATA
;

41 
cÚÃùiÚ_m­
 *
	mcÚ_m­
;

43 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

45 
¶ugš_cÚfig
 
	mcÚf
;

46 } 
	t¶ugš_d©a
;

55 
cÚÃùiÚ_m­
 *
	$cÚÃùiÚ_m­_š™
() {

56 
cÚÃùiÚ_m­
 *
cm
;

58 
cm
 = 
	`ÿÎoc
(1, (*cm));

60  
cm
;

61 
	}
}

63 
	$cÚÃùiÚ_m­_ä“
(
cÚÃùiÚ_m­
 *
cm
) {

64 
size_t
 
i
;

65 
i
 = 0; i < 
cm
->
size
; i++) {

66 
cÚÃùiÚ_m­_’Œy
 *
cme
 = 
cm
->
±r
[
i
];

68 ià(!
cme
) ;

70 ià(
cme
->
cÚ_id
) {

71 
	`bufãr_ä“
(
cme
->
cÚ_id
);

73 
	`ä“
(
cme
);

76 
	`ä“
(
cm
);

77 
	}
}

79 
	$cÚÃùiÚ_m­_š£¹
(
cÚÃùiÚ_m­
 *
cm
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
cÚ_id
) {

80 
cÚÃùiÚ_m­_’Œy
 *
cme
;

81 
size_t
 
i
;

83 ià(
cm
->
size
 == 0) {

84 
cm
->
size
 = 16;

85 
cm
->
±r
 = 
	`m®loc
(cm->
size
 * (*(cm->ptr)));

86 
i
 = 0; i < 
cm
->
size
; i++) {

87 
cm
->
±r
[
i
] = 
NULL
;

89 } ià(
cm
->
u£d
 =ğcm->
size
) {

90 
cm
->
size
 += 16;

91 
cm
->
±r
 = 
	`»®loc
(cm->±r, cm->
size
 * (*(cm->ptr)));

92 
i
 = 
cm
->
u£d
; i < cm->
size
; i++) {

93 
cm
->
±r
[
i
] = 
NULL
;

97 ià(
cm
->
±r
[cm->
u£d
]) {

99 
cme
 = 
cm
->
±r
[cm->
u£d
];

101 
cme
 = 
	`m®loc
((*cme));

102 
cme
->
cÚ_id
 = 
	`bufãr_š™
();

104 
	`bufãr_cİy_bufãr
(
cme
->
cÚ_id
, con_id);

105 
cme
->
cÚ
 = con;

107 
cm
->
±r
[cm->
u£d
++] = 
cme
;

110 
	}
}

112 
cÚÃùiÚ
 *
	$cÚÃùiÚ_m­_g‘_cÚÃùiÚ
(
cÚÃùiÚ_m­
 *
cm
, 
bufãr
 *
cÚ_id
) {

113 
size_t
 
i
;

115 
i
 = 0; i < 
cm
->
u£d
; i++) {

116 
cÚÃùiÚ_m­_’Œy
 *
cme
 = 
cm
->
±r
[
i
];

118 ià(
	`bufãr_is_equ®
(
cme
->
cÚ_id
, con_id)) {

121  
cme
->
cÚ
;

124  
NULL
;

125 
	}
}

127 
	$cÚÃùiÚ_m­_»move_cÚÃùiÚ
(
cÚÃùiÚ_m­
 *
cm
, 
cÚÃùiÚ
 *
cÚ
) {

128 
size_t
 
i
;

130 
i
 = 0; i < 
cm
->
u£d
; i++) {

131 
cÚÃùiÚ_m­_’Œy
 *
cme
 = 
cm
->
±r
[
i
];

133 ià(
cme
->
cÚ
 == con) {

136 
	`bufãr_»£t
(
cme
->
cÚ_id
);

137 
cme
->
cÚ
 = 
NULL
;

139 
cm
->
u£d
--;

142 ià(
cm
->
u£d
) {

143 
cm
->
±r
[
i
] = cm->±r[cm->
u£d
];

144 
cm
->
±r
[cm->
u£d
] = 
cme
;

152 
	}
}

155 
	$INIT_FUNC
(
mod_u¶ßd´og»ss_š™
) {

156 
¶ugš_d©a
 *
p
;

158 
p
 = 
	`ÿÎoc
(1, (*p));

160 
p
->
cÚ_m­
 = 
	`cÚÃùiÚ_m­_š™
();

162  
p
;

163 
	}
}

166 
	$FREE_FUNC
(
mod_u¶ßd´og»ss_ä“
) {

167 
¶ugš_d©a
 *
p
 = 
p_d
;

169 
	`UNUSED
(
¤v
);

171 ià(!
p
è 
HANDLER_GO_ON
;

173 ià(
p
->
cÚfig_¡Üage
) {

174 
size_t
 
i
;

175 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

176 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

178 ià(
NULL
 =ğ
s
) ;

180 
	`bufãr_ä“
(
s
->
´og»ss_u¾
);

182 
	`ä“
(
s
);

184 
	`ä“
(
p
->
cÚfig_¡Üage
);

187 
	`cÚÃùiÚ_m­_ä“
(
p
->
cÚ_m­
);

189 
	`ä“
(
p
);

191  
HANDLER_GO_ON
;

192 
	}
}

196 
	$SETDEFAULTS_FUNC
(
mod_u¶ßd´og»ss_£t_deçuÉs
) {

197 
¶ugš_d©a
 *
p
 = 
p_d
;

198 
size_t
 
i
 = 0;

200 
cÚfig_v®ues_t
 
cv
[] = {

201 { "u¶ßd-´og»ss.´og»ss-u¾", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

202 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

205 ià(!
p
è 
HANDLER_ERROR
;

207 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

209 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

210 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

211 
¶ugš_cÚfig
 *
s
;

213 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

214 
s
->
´og»ss_u¾
 = 
	`bufãr_š™
();

216 
cv
[0].
de¡š©iÚ
 = 
s
->
´og»ss_u¾
;

218 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

220 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

221  
HANDLER_ERROR
;

225  
HANDLER_GO_ON
;

226 
	}
}

228 
	#PATCH
(
x
) \

229 
p
->
cÚf
.
x
 = 
s
->x;

	)

230 
	$mod_u¶ßd´og»ss_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

231 
size_t
 
i
, 
j
;

232 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

234 
	`PATCH
(
´og»ss_u¾
);

237 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

238 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

239 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

242 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

245 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

246 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

248 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("upload-progress.progress-url"))) {

249 
	`PATCH
(
´og»ss_u¾
);

255 
	}
}

256 #undeà
PATCH


276 
	$URIHANDLER_FUNC
(
mod_u¶ßd´og»ss_uri_hªdËr
) {

277 
¶ugš_d©a
 *
p
 = 
p_d
;

278 
size_t
 
i
, 
Ën
;

279 
d©a_¡ršg
 *
ds
;

280 
bufãr
 *
b
;

281 
cÚÃùiÚ
 *
po¡_cÚ
 = 
NULL
;

283 
	`UNUSED
(
¤v
);

285 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

286 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

287 
HTTP_METHOD_GET
:

288 
HTTP_METHOD_POST
: ;

289 :  
HANDLER_GO_ON
;

292 
	`mod_u¶ßd´og»ss_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

293 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
´og»ss_u¾
)è 
HANDLER_GO_ON
;

295 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_GET
) {

296 ià(!
	`bufãr_is_equ®
(
cÚ
->
uri
.
·th
, 
p
->
cÚf
.
´og»ss_u¾
)) {

297  
HANDLER_GO_ON
;

303 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "X-Progress-ID"))) {

304 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
qu”y
)) {

306 
b
 = 
cÚ
->
uri
.
qu”y
;

308  
HANDLER_GO_ON
;

311 
b
 = 
ds
->
v®ue
;

314 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

315 ià(
Ën
 != 32) {

316 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

317 "ËÀoà´og»ss-id !ğ32:", 
Ën
);

318  
HANDLER_GO_ON
;

321 
i
 = 0; i < 
Ën
; i++) {

322 
c
 = 
b
->
±r
[
i
];

324 ià(!
	`light_isxdig™
(
c
)) {

325 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

326 "nÚ-xdig™ iÀ´og»ss-id:", 
b
);

327  
HANDLER_GO_ON
;

332 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

333 
HTTP_METHOD_POST
:

335 
	`cÚÃùiÚ_m­_š£¹
(
p
->
cÚ_m­
, 
cÚ
, 
b
);

337  
HANDLER_GO_ON
;

338 
HTTP_METHOD_GET
:

339 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

341 
cÚ
->
fe_¡¬‹d
 = 1;

342 
cÚ
->
fe_fšished
 = 1;

344 
cÚ
->
h‰p_¡©us
 = 200;

345 
cÚ
->
mode
 = 
DIRECT
;

348 ià(
NULL
 =ğ(
po¡_cÚ
 = 
	`cÚÃùiÚ_m­_g‘_cÚÃùiÚ
(
p
->
cÚ_m­
, 
b
))) {

349 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

350 "ID‚Øknown:", 
b
);

352 
	`chunkqueue_­³nd_mem
(
cÚ
->
wr™e_queue
, 
	`CONST_STR_LEN
("not in…rogress"));

354  
HANDLER_FINISHED
;

357 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/xml"));

360 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Pragma"), CONST_STR_LEN("no-cache"));

361 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Expires"), CONST_STR_LEN("Thu, 19 Nov 1981 08:52:00 GMT"));

362 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Cache-Control"), CONST_STR_LEN("no-store,‚o-cache, must-revalidate,…ost-check=0,…re-check=0"));

364 
b
 = 
	`bufãr_š™
();

367 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

371 
	`bufãr_­³nd_št
(
b
, 
po¡_cÚ
->
»que¡
.
cÚ‹Á_Ëngth
);

372 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

375 
	`bufãr_­³nd_št
(
b
, 
po¡_cÚ
->
»que¡_cÚ‹Á_queue
->
by‹s_š
);

376 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(

381 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "...", 
b
);

384 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

385 
	`bufãr_ä“
(
b
);

387  
HANDLER_FINISHED
;

392  
HANDLER_GO_ON
;

393 
	}
}

395 
	$REQUESTDONE_FUNC
(
mod_u¶ßd´og»ss_»que¡_dÚe
) {

396 
¶ugš_d©a
 *
p
 = 
p_d
;

398 
	`UNUSED
(
¤v
);

400 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 !ğ
HTTP_METHOD_POST
è 
HANDLER_GO_ON
;

401 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

403 ià(
	`cÚÃùiÚ_m­_»move_cÚÃùiÚ
(
p
->
cÚ_m­
, 
cÚ
)) {

407  
HANDLER_GO_ON
;

408 
	}
}

412 
mod_u¶ßd´og»ss_¶ugš_š™
(
¶ugš
 *
p
);

413 
	$mod_u¶ßd´og»ss_¶ugš_š™
(
¶ugš
 *
p
) {

414 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

415 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("uploadprogress");

417 
p
->
š™
 = 
mod_u¶ßd´og»ss_š™
;

418 
p
->
hªdË_uri_ş—n
 = 
mod_u¶ßd´og»ss_uri_hªdËr
;

419 
p
->
hªdË_»que¡_dÚe
 = 
mod_u¶ßd´og»ss_»que¡_dÚe
;

420 
p
->
hªdË_cÚÃùiÚ_şo£
 = 
mod_u¶ßd´og»ss_»que¡_dÚe
;

421 
p
->
£t_deçuÉs
 = 
mod_u¶ßd´og»ss_£t_deçuÉs
;

422 
p
->
ş—nup
 = 
mod_u¶ßd´og»ss_ä“
;

424 
p
->
d©a
 = 
NULL
;

427 
	}
}

	@mod_userdir.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

7 
	~"»¥Ú£.h
"

9 
	~"¶ugš.h
"

11 
	~<sys/ty³s.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

16 #ifdeà
HAVE_PWD_H


17 
	~<pwd.h
>

22 
¬¿y
 *
	mexşude_u£r
;

23 
¬¿y
 *
	mšşude_u£r
;

24 
bufãr
 *
	m·th
;

25 
bufãr
 *
	mba£·th
;

26 
	mË‰”homes
;

27 
	maùive
;

28 } 
	t¶ugš_cÚfig
;

31 
	mPLUGIN_DATA
;

33 
bufãr
 *
	mu£ºame
;

34 
bufãr
 *
	m‹mp_·th
;

36 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

38 
¶ugš_cÚfig
 
	mcÚf
;

39 } 
	t¶ugš_d©a
;

42 
	$INIT_FUNC
(
mod_u£rdœ_š™
) {

43 
¶ugš_d©a
 *
p
;

45 
p
 = 
	`ÿÎoc
(1, (*p));

47 
p
->
u£ºame
 = 
	`bufãr_š™
();

48 
p
->
‹mp_·th
 = 
	`bufãr_š™
();

50  
p
;

51 
	}
}

54 
	$FREE_FUNC
(
mod_u£rdœ_ä“
) {

55 
¶ugš_d©a
 *
p
 = 
p_d
;

57 ià(!
p
è 
HANDLER_GO_ON
;

59 ià(
p
->
cÚfig_¡Üage
) {

60 
size_t
 
i
;

62 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

63 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

65 ià(
NULL
 =ğ
s
) ;

67 
	`¬¿y_ä“
(
s
->
šşude_u£r
);

68 
	`¬¿y_ä“
(
s
->
exşude_u£r
);

69 
	`bufãr_ä“
(
s
->
·th
);

70 
	`bufãr_ä“
(
s
->
ba£·th
);

72 
	`ä“
(
s
);

74 
	`ä“
(
p
->
cÚfig_¡Üage
);

77 
	`bufãr_ä“
(
p
->
u£ºame
);

78 
	`bufãr_ä“
(
p
->
‹mp_·th
);

80 
	`ä“
(
p
);

82  
HANDLER_GO_ON
;

83 
	}
}

87 
	$SETDEFAULTS_FUNC
(
mod_u£rdœ_£t_deçuÉs
) {

88 
¶ugš_d©a
 *
p
 = 
p_d
;

89 
size_t
 
i
;

91 
cÚfig_v®ues_t
 
cv
[] = {

92 { "u£rdœ.·th", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

93 { "u£rdœ.exşude-u£r", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

94 { "u£rdœ.šşude-u£r", 
NULL
, 
T_CONFIG_ARRAY
, 
T_CONFIG_SCOPE_CONNECTION
 },

95 { "u£rdœ.ba£·th", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

96 { "u£rdœ.Ë‰”homes", 
NULL
, 
T_CONFIG_BOOLEAN
,
T_CONFIG_SCOPE_CONNECTION
 },

97 { "u£rdœ.aùive", 
NULL
, 
T_CONFIG_BOOLEAN
,
T_CONFIG_SCOPE_CONNECTION
 },

98 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

101 ià(!
p
è 
HANDLER_ERROR
;

103 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

105 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

106 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

107 
¶ugš_cÚfig
 *
s
;

109 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

110 
s
->
exşude_u£r
 = 
	`¬¿y_š™
();

111 
s
->
šşude_u£r
 = 
	`¬¿y_š™
();

112 
s
->
·th
 = 
	`bufãr_š™
();

113 
s
->
ba£·th
 = 
	`bufãr_š™
();

114 
s
->
Ë‰”homes
 = 0;

117 
s
->
aùive
 = 1;

119 
cv
[0].
de¡š©iÚ
 = 
s
->
·th
;

120 
cv
[1].
de¡š©iÚ
 = 
s
->
exşude_u£r
;

121 
cv
[2].
de¡š©iÚ
 = 
s
->
šşude_u£r
;

122 
cv
[3].
de¡š©iÚ
 = 
s
->
ba£·th
;

123 
cv
[4].
de¡š©iÚ
 = &(
s
->
Ë‰”homes
);

124 
cv
[5].
de¡š©iÚ
 = &(
s
->
aùive
);

126 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

128 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

129  
HANDLER_ERROR
;

133  
HANDLER_GO_ON
;

134 
	}
}

136 
	#PATCH
(
x
) \

137 
p
->
cÚf
.
x
 = 
s
->x;

	)

138 
	$mod_u£rdœ_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

139 
size_t
 
i
, 
j
;

140 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

142 
	`PATCH
(
·th
);

143 
	`PATCH
(
exşude_u£r
);

144 
	`PATCH
(
šşude_u£r
);

145 
	`PATCH
(
ba£·th
);

146 
	`PATCH
(
Ë‰”homes
);

147 
	`PATCH
(
aùive
);

150 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

151 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

152 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

155 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

158 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

159 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

161 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("userdir.path"))) {

162 
	`PATCH
(
·th
);

163 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("userdir.exclude-user"))) {

164 
	`PATCH
(
exşude_u£r
);

165 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("userdir.include-user"))) {

166 
	`PATCH
(
šşude_u£r
);

167 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("userdir.basepath"))) {

168 
	`PATCH
(
ba£·th
);

169 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("userdir.letterhomes"))) {

170 
	`PATCH
(
Ë‰”homes
);

171 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("userdir.active"))) {

172 
	`PATCH
(
aùive
);

178 
	}
}

179 #undeà
PATCH


181 
	$URIHANDLER_FUNC
(
mod_u£rdœ_doüoÙ_hªdËr
) {

182 
¶ugš_d©a
 *
p
 = 
p_d
;

183 
size_t
 
k
;

184 *
»l_u¾
;

185 #ifdeà
HAVE_PWD_H


186 
·sswd
 *
pwd
 = 
NULL
;

189 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

191 
	`mod_u£rdœ_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

196 ià(!
p
->
cÚf
.
aùive
 || 
	`bufãr_is_em±y
Õ->cÚf.
·th
)è 
HANDLER_GO_ON
;

200 ià(
cÚ
->
uri
.
·th
->
±r
[0] != '/' ||

201 
cÚ
->
uri
.
·th
->
±r
[1] !ğ'~'è 
HANDLER_GO_ON
;

203 ià(
NULL
 =ğ(
»l_u¾
 = 
	`¡rchr
(
cÚ
->
uri
.
·th
->
±r
 + 2, '/'))) {

205 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
¤v
, 
cÚ
);

207  
HANDLER_FINISHED
;

211 ià(0 =ğ
»l_u¾
 - (
cÚ
->
uri
.
·th
->
±r
 + 2)) {

212  
HANDLER_GO_ON
;

215 
	`bufãr_cİy_¡ršg_Ën
(
p
->
u£ºame
, 
cÚ
->
uri
.
·th
->
±r
 + 2, 
»l_u¾
 - (con->uri.path->ptr + 2));

217 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
ba£·th
)

218 #ifdeà
HAVE_PWD_H


219 && 
NULL
 =ğ(
pwd
 = 
	`g‘pwÇm
(
p
->
u£ºame
->
±r
))

223  
HANDLER_GO_ON
;

227 
k
 = 0; k < 
p
->
cÚf
.
exşude_u£r
->
u£d
; k++) {

228 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
exşude_u£r
->
d©a
[
k
];

230 ià(
	`bufãr_is_equ®
(
ds
->
v®ue
, 
p
->
u£ºame
)) {

232  
HANDLER_GO_ON
;

236 ià(
p
->
cÚf
.
šşude_u£r
->
u£d
) {

237 
found_u£r
 = 0;

238 
k
 = 0; k < 
p
->
cÚf
.
šşude_u£r
->
u£d
; k++) {

239 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
p
->
cÚf
.
šşude_u£r
->
d©a
[
k
];

241 ià(
	`bufãr_is_equ®
(
ds
->
v®ue
, 
p
->
u£ºame
)) {

243 
found_u£r
 = 1;

248 ià(!
found_u£r
è 
HANDLER_GO_ON
;

253 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
ba£·th
)) {

254 #ifdeà
HAVE_PWD_H


255 
	`bufãr_cİy_¡ršg
(
p
->
‹mp_·th
, 
pwd
->
pw_dœ
);

258 *
ı
;

263 
ı
 = 
p
->
u£ºame
->
±r
; *cp; cp++) {

264 
c
 = *
ı
;

266 ià(!(
c
 == '-' ||

267 
c
 == '_' ||

268 
c
 == '.' ||

269 (
c
 >= 'a' && c <= 'z') ||

270 (
c
 >= 'A' && c <= 'Z') ||

271 (
c
 >= '0' && c <= '9'))) {

273  
HANDLER_GO_ON
;

276 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

277 
	`bufãr_to_low”
(
p
->
u£ºame
);

280 
	`bufãr_cİy_bufãr
(
p
->
‹mp_·th
,…->
cÚf
.
ba£·th
);

281 
	`bufãr_­³nd_¦ash
(
p
->
‹mp_·th
);

282 ià(
p
->
cÚf
.
Ë‰”homes
) {

283 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
‹mp_·th
,…->
u£ºame
->
±r
, 1);

284 
	`bufãr_­³nd_¦ash
(
p
->
‹mp_·th
);

286 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
‹mp_·th
,…->
u£ºame
);

288 
	`bufãr_­³nd_¦ash
(
p
->
‹mp_·th
);

289 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
‹mp_·th
,…->
cÚf
.
·th
);

291 ià(
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
ba£·th
)) {

292 
¡©
 
¡
;

293 
»t
;

295 
»t
 = 
	`¡©
(
p
->
‹mp_·th
->
±r
, &
¡
);

296 ià(
»t
 < 0 || 
	`S_ISDIR
(
¡
.
¡_mode
) != 1) {

297  
HANDLER_GO_ON
;

301 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
ba£dœ
, 
p
->
‹mp_·th
);

310 
	`bufãr_­³nd_¦ash
(
p
->
‹mp_·th
);

318 ià(
NULL
 !ğ(
»l_u¾
 = 
	`¡rchr
(
cÚ
->
physiÿl
.
»l_·th
->
±r
 + 2, '/'))) {

319 
	`bufãr_­³nd_¡ršg
(
p
->
‹mp_·th
, 
»l_u¾
 + 1);

321 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
p
->
‹mp_·th
);

323 
	`bufãr_»£t
(
p
->
‹mp_·th
);

325  
HANDLER_GO_ON
;

326 
	}
}

330 
mod_u£rdœ_¶ugš_š™
(
¶ugš
 *
p
);

331 
	$mod_u£rdœ_¶ugš_š™
(
¶ugš
 *
p
) {

332 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

333 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("userdir");

335 
p
->
š™
 = 
mod_u£rdœ_š™
;

336 
p
->
hªdË_physiÿl
 = 
mod_u£rdœ_doüoÙ_hªdËr
;

337 
p
->
£t_deçuÉs
 = 
mod_u£rdœ_£t_deçuÉs
;

338 
p
->
ş—nup
 = 
mod_u£rdœ_ä“
;

340 
p
->
d©a
 = 
NULL
;

343 
	}
}

	@mod_usertrack.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"¿nd.h
"

8 
	~"¶ugš.h
"

10 
	~<ùy³.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

14 
	~"md5.h
"

19 
bufãr
 *
	mcook›_Çme
;

20 
bufãr
 *
	mcook›_domaš
;

21 
	mcook›_max_age
;

22 } 
	t¶ugš_cÚfig
;

25 
	mPLUGIN_DATA
;

27 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

29 
¶ugš_cÚfig
 
	mcÚf
;

30 } 
	t¶ugš_d©a
;

33 
	$INIT_FUNC
(
mod_u£¹¿ck_š™
) {

34 
¶ugš_d©a
 *
p
;

36 
p
 = 
	`ÿÎoc
(1, (*p));

38  
p
;

39 
	}
}

42 
	$FREE_FUNC
(
mod_u£¹¿ck_ä“
) {

43 
¶ugš_d©a
 *
p
 = 
p_d
;

45 
	`UNUSED
(
¤v
);

47 ià(!
p
è 
HANDLER_GO_ON
;

49 ià(
p
->
cÚfig_¡Üage
) {

50 
size_t
 
i
;

51 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

52 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

54 ià(
NULL
 =ğ
s
) ;

56 
	`bufãr_ä“
(
s
->
cook›_Çme
);

57 
	`bufãr_ä“
(
s
->
cook›_domaš
);

59 
	`ä“
(
s
);

61 
	`ä“
(
p
->
cÚfig_¡Üage
);

64 
	`ä“
(
p
);

66  
HANDLER_GO_ON
;

67 
	}
}

71 
	$SETDEFAULTS_FUNC
(
mod_u£¹¿ck_£t_deçuÉs
) {

72 
¶ugš_d©a
 *
p
 = 
p_d
;

73 
size_t
 
i
 = 0;

75 
cÚfig_v®ues_t
 
cv
[] = {

76 { "u£¹¿ck.cook›-Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

77 { "u£¹¿ck.cook›-max-age", 
NULL
, 
T_CONFIG_INT
, 
T_CONFIG_SCOPE_CONNECTION
 },

78 { "u£¹¿ck.cook›-domaš", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

80 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

83 ià(!
p
è 
HANDLER_ERROR
;

85 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

87 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

88 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

89 
¶ugš_cÚfig
 *
s
;

91 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

92 
s
->
cook›_Çme
 = 
	`bufãr_š™
();

93 
s
->
cook›_domaš
 = 
	`bufãr_š™
();

94 
s
->
cook›_max_age
 = 0;

96 
cv
[0].
de¡š©iÚ
 = 
s
->
cook›_Çme
;

97 
cv
[1].
de¡š©iÚ
 = &(
s
->
cook›_max_age
);

98 
cv
[2].
de¡š©iÚ
 = 
s
->
cook›_domaš
;

100 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

102 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

103  
HANDLER_ERROR
;

106 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
cook›_Çme
)) {

107 
	`bufãr_cİy_¡ršg_Ën
(
s
->
cook›_Çme
, 
	`CONST_STR_LEN
("TRACKID"));

109 
size_t
 
j
, 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
s
->
cook›_Çme
);

110 
j
 = 0; j < 
Ën
; j++) {

111 
c
 = 
s
->
cook›_Çme
->
±r
[
j
] | 32;

112 ià(
c
 < 'a' || c > 'z') {

113 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

115 
s
->
cook›_Çme
);

117  
HANDLER_ERROR
;

122 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
cook›_domaš
)) {

123 
size_t
 
j
, 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
s
->
cook›_domaš
);

124 
j
 = 0; j < 
Ën
; j++) {

125 
c
 = 
s
->
cook›_domaš
->
±r
[
j
];

126 ià(
c
 <= 32 || c >= 127 || c == '"' || c == '\\') {

127 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

129 
s
->
cook›_domaš
);

131  
HANDLER_ERROR
;

137  
HANDLER_GO_ON
;

138 
	}
}

140 
	#PATCH
(
x
) \

141 
p
->
cÚf
.
x
 = 
s
->x;

	)

142 
	$mod_u£¹¿ck_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

143 
size_t
 
i
, 
j
;

144 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

146 
	`PATCH
(
cook›_Çme
);

147 
	`PATCH
(
cook›_domaš
);

148 
	`PATCH
(
cook›_max_age
);

151 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

152 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

153 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

156 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

159 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

160 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

162 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("usertrack.cookie-name"))) {

163 
	`PATCH
(
cook›_Çme
);

164 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("usertrack.cookie-max-age"))) {

165 
	`PATCH
(
cook›_max_age
);

166 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("usertrack.cookie-domain"))) {

167 
	`PATCH
(
cook›_domaš
);

173 
	}
}

174 #undeà
PATCH


176 
	$URIHANDLER_FUNC
(
mod_u£¹¿ck_uri_hªdËr
) {

177 
¶ugš_d©a
 *
p
 = 
p_d
;

178 
d©a_¡ršg
 *
ds
;

179 
h
[16];

180 
li_MD5_CTX
 
Md5Ctx
;

181 
hh
[
LI_ITOSTRING_LENGTH
];

183 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

185 
	`mod_u£¹¿ck_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

187 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Cookie"))) {

188 *
g
;

197 ià(
NULL
 !ğ(
g
 = 
	`¡r¡r
(
ds
->
v®ue
->
±r
, 
p
->
cÚf
.
cook›_Çme
->ptr))) {

198 *
nc
;

201 
nc
 = 
g
 + 
	`bufãr_¡ršg_Ëngth
(
p
->
cÚf
.
cook›_Çme
); *nc == ' ' || *nc == '\t';‚c++);

203 ià(*
nc
 == '=') {

206 ià(
	`¡¾’
(
nc
) > 32) {

208  
HANDLER_GO_ON
;

215 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»¥Ú£
.
h—d”s
, 
TYPE_STRING
))) {

216 
ds
 = 
	`d©a_»¥Ú£_š™
();

218 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("Set-Cookie"));

219 
	`bufãr_cİy_bufãr
(
ds
->
v®ue
, 
p
->
cÚf
.
cook›_Çme
);

220 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("="));

226 
	`li_MD5_In™
(&
Md5Ctx
);

227 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
));

228 
	`li_MD5_Upd©e
(&
Md5Ctx
, 
	`CONST_STR_LEN
("+"));

230 
	`li_™o¡º
(
hh
, (hh), 
¤v
->
cur_ts
);

231 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
hh
, 
	`¡¾’
(hh));

232 
	`li_™o¡º
(
hh
, (hh), 
	`li_¿nd_p£udo_by‹s
());

233 
	`li_MD5_Upd©e
(&
Md5Ctx
, (*)
hh
, 
	`¡¾’
(hh));

235 
	`li_MD5_Fš®
(
h
, &
Md5Ctx
);

237 
	`bufãr_­³nd_¡ršg_’coded
(
ds
->
v®ue
, (*)
h
, 16, 
ENCODING_HEX
);

238 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("; Path=/"));

239 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("; Version=1"));

241 ià(!
	`bufãr_¡ršg_is_em±y
(
p
->
cÚf
.
cook›_domaš
)) {

242 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("; Domain="));

243 
	`bufãr_­³nd_¡ršg_’coded
(
ds
->
v®ue
, 
	`CONST_BUF_LEN
(
p
->
cÚf
.
cook›_domaš
), 
ENCODING_REL_URI
);

246 ià(
p
->
cÚf
.
cook›_max_age
) {

247 
	`bufãr_­³nd_¡ršg_Ën
(
ds
->
v®ue
, 
	`CONST_STR_LEN
("; max-age="));

248 
	`bufãr_­³nd_št
(
ds
->
v®ue
, 
p
->
cÚf
.
cook›_max_age
);

251 
	`¬¿y_š£¹_unique
(
cÚ
->
»¥Ú£
.
h—d”s
, (
d©a_un£t
 *)
ds
);

253  
HANDLER_GO_ON
;

254 
	}
}

258 
mod_u£¹¿ck_¶ugš_š™
(
¶ugš
 *
p
);

259 
	$mod_u£¹¿ck_¶ugš_š™
(
¶ugš
 *
p
) {

260 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

261 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("usertrack");

263 
p
->
š™
 = 
mod_u£¹¿ck_š™
;

264 
p
->
hªdË_uri_ş—n
 = 
mod_u£¹¿ck_uri_hªdËr
;

265 
p
->
£t_deçuÉs
 = 
mod_u£¹¿ck_£t_deçuÉs
;

266 
p
->
ş—nup
 = 
mod_u£¹¿ck_ä“
;

268 
p
->
d©a
 = 
NULL
;

271 
	}
}

	@mod_webdav.c

1 
	~"fœ¡.h
"

3 
	~"ba£.h
"

4 
	~"log.h
"

5 
	~"bufãr.h
"

6 
	~"»¥Ú£.h
"

7 
	~"cÚÃùiÚs.h
"

9 
	~"¶ugš.h
"

11 
	~"¡©_ÿche.h
"

13 
	~"sys-mm­.h
"

15 
	~<sys/ty³s.h
>

16 
	~<sys/¡©.h
>

17 
	~<ùy³.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<¡dio.h
>

23 
	~<as£¹.h
>

25 
	~<uni¡d.h
>

26 
	~<dœ’t.h
>

28 #ià
defšed
(
HAVE_LIBXML_H
è&& defšed(
HAVE_SQLITE3_H
)

29 
	#USE_PROPPATCH


	)

30 
	~<libxml/Œ“.h
>

31 
	~<libxml/·r£r.h
>

33 
	~<sql™e3.h
>

36 #ià
defšed
(
HAVE_LIBXML_H
è&& defšed(
HAVE_SQLITE3_H
è&& defšed(
HAVE_UUID_UUID_H
)

37 
	#USE_LOCKS


	)

38 
	~<uuid/uuid.h
>

49 
	#WEBDAV_FILE_MODE
 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
 | 
S_IROTH
 | 
S_IWOTH


	)

50 
	#WEBDAV_DIR_MODE
 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO


	)

55 
	m’abËd
;

56 
	mis_»adÚly
;

57 
	mlog_xml
;

59 
bufãr
 *
	msql™e_db_Çme
;

60 #ifdeà
USE_PROPPATCH


61 
sql™e3
 *
	msql
;

62 
sql™e3_¡mt
 *
	m¡mt_upd©e_´İ
;

63 
sql™e3_¡mt
 *
	m¡mt_d–‘e_´İ
;

64 
sql™e3_¡mt
 *
	m¡mt_£Ëù_´İ
;

65 
sql™e3_¡mt
 *
	m¡mt_£Ëù_´İÇmes
;

67 
sql™e3_¡mt
 *
	m¡mt_d–‘e_uri
;

68 
sql™e3_¡mt
 *
	m¡mt_move_uri
;

69 
sql™e3_¡mt
 *
	m¡mt_cİy_uri
;

71 
sql™e3_¡mt
 *
	m¡mt_»move_lock
;

72 
sql™e3_¡mt
 *
	m¡mt_ü—‹_lock
;

73 
sql™e3_¡mt
 *
	m¡mt_»ad_lock
;

74 
sql™e3_¡mt
 *
	m¡mt_»ad_lock_by_uri
;

75 
sql™e3_¡mt
 *
	m¡mt_»äesh_lock
;

77 } 
	t¶ugš_cÚfig
;

80 
	mPLUGIN_DATA
;

82 
bufãr
 *
	mtmp_buf
;

83 
»que¡_uri
 
	muri
;

84 
physiÿl
 
	mphysiÿl
;

86 
¶ugš_cÚfig
 **
	mcÚfig_¡Üage
;

88 
¶ugš_cÚfig
 
	mcÚf
;

89 } 
	t¶ugš_d©a
;

92 
¶ugš_cÚfig
 
	mcÚf
;

93 } 
	thªdËr_ùx
;

96 
	$INIT_FUNC
(
mod_webdav_š™
) {

97 
¶ugš_d©a
 *
p
;

99 
p
 = 
	`ÿÎoc
(1, (*p));

101 
p
->
tmp_buf
 = 
	`bufãr_š™
();

103 
p
->
uri
.
scheme
 = 
	`bufãr_š™
();

104 
p
->
uri
.
·th_¿w
 = 
	`bufãr_š™
();

105 
p
->
uri
.
·th
 = 
	`bufãr_š™
();

106 
p
->
uri
.
authÜ™y
 = 
	`bufãr_š™
();

108 
p
->
physiÿl
.
·th
 = 
	`bufãr_š™
();

109 
p
->
physiÿl
.
»l_·th
 = 
	`bufãr_š™
();

110 
p
->
physiÿl
.
doc_roÙ
 = 
	`bufãr_š™
();

111 
p
->
physiÿl
.
ba£dœ
 = 
	`bufãr_š™
();

113  
p
;

114 
	}
}

117 
	$FREE_FUNC
(
mod_webdav_ä“
) {

118 
¶ugš_d©a
 *
p
 = 
p_d
;

120 
	`UNUSED
(
¤v
);

122 ià(!
p
è 
HANDLER_GO_ON
;

124 ià(
p
->
cÚfig_¡Üage
) {

125 
size_t
 
i
;

126 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

127 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[
i
];

129 ià(
NULL
 =ğ
s
) ;

131 
	`bufãr_ä“
(
s
->
sql™e_db_Çme
);

132 #ifdeà
USE_PROPPATCH


133 ià(
s
->
sql
) {

134 
	`sql™e3_fš®ize
(
s
->
¡mt_d–‘e_´İ
);

135 
	`sql™e3_fš®ize
(
s
->
¡mt_d–‘e_uri
);

136 
	`sql™e3_fš®ize
(
s
->
¡mt_cİy_uri
);

137 
	`sql™e3_fš®ize
(
s
->
¡mt_move_uri
);

138 
	`sql™e3_fš®ize
(
s
->
¡mt_upd©e_´İ
);

139 
	`sql™e3_fš®ize
(
s
->
¡mt_£Ëù_´İ
);

140 
	`sql™e3_fš®ize
(
s
->
¡mt_£Ëù_´İÇmes
);

142 
	`sql™e3_fš®ize
(
s
->
¡mt_»ad_lock
);

143 
	`sql™e3_fš®ize
(
s
->
¡mt_»ad_lock_by_uri
);

144 
	`sql™e3_fš®ize
(
s
->
¡mt_ü—‹_lock
);

145 
	`sql™e3_fš®ize
(
s
->
¡mt_»move_lock
);

146 
	`sql™e3_fš®ize
(
s
->
¡mt_»äesh_lock
);

147 
	`sql™e3_şo£
(
s
->
sql
);

150 
	`ä“
(
s
);

152 
	`ä“
(
p
->
cÚfig_¡Üage
);

155 
	`bufãr_ä“
(
p
->
uri
.
scheme
);

156 
	`bufãr_ä“
(
p
->
uri
.
·th_¿w
);

157 
	`bufãr_ä“
(
p
->
uri
.
·th
);

158 
	`bufãr_ä“
(
p
->
uri
.
authÜ™y
);

160 
	`bufãr_ä“
(
p
->
physiÿl
.
·th
);

161 
	`bufãr_ä“
(
p
->
physiÿl
.
»l_·th
);

162 
	`bufãr_ä“
(
p
->
physiÿl
.
doc_roÙ
);

163 
	`bufãr_ä“
(
p
->
physiÿl
.
ba£dœ
);

165 
	`bufãr_ä“
(
p
->
tmp_buf
);

167 
	`ä“
(
p
);

169  
HANDLER_GO_ON
;

170 
	}
}

174 
	$SETDEFAULTS_FUNC
(
mod_webdav_£t_deçuÉs
) {

175 
¶ugš_d©a
 *
p
 = 
p_d
;

176 
size_t
 
i
 = 0;

178 
cÚfig_v®ues_t
 
cv
[] = {

179 { "webdav.aùiv©e", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

180 { "webdav.is-»adÚly", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

181 { "webdav.sql™e-db-Çme", 
NULL
, 
T_CONFIG_STRING
, 
T_CONFIG_SCOPE_CONNECTION
 },

182 { "webdav.log-xml", 
NULL
, 
T_CONFIG_BOOLEAN
, 
T_CONFIG_SCOPE_CONNECTION
 },

183 { 
NULL
, NULL, 
T_CONFIG_UNSET
, 
T_CONFIG_SCOPE_UNSET
 }

186 ià(!
p
è 
HANDLER_ERROR
;

188 
p
->
cÚfig_¡Üage
 = 
	`ÿÎoc
(1, 
¤v
->
cÚfig_cÚ‹xt
->
u£d
 * (
¶ugš_cÚfig
 *));

190 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

191 
d©a_cÚfig
 cÚ¡* 
cÚfig
 = (d©a_cÚfig cÚ¡*)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

192 
¶ugš_cÚfig
 *
s
;

194 
s
 = 
	`ÿÎoc
(1, (
¶ugš_cÚfig
));

195 
s
->
sql™e_db_Çme
 = 
	`bufãr_š™
();

197 
cv
[0].
de¡š©iÚ
 = &(
s
->
’abËd
);

198 
cv
[1].
de¡š©iÚ
 = &(
s
->
is_»adÚly
);

199 
cv
[2].
de¡š©iÚ
 = 
s
->
sql™e_db_Çme
;

200 
cv
[3].
de¡š©iÚ
 = &(
s
->
log_xml
);

202 
p
->
cÚfig_¡Üage
[
i
] = 
s
;

204 ià(0 !ğ
	`cÚfig_š£¹_v®ues_glob®
(
¤v
, 
cÚfig
->
v®ue
, 
cv
, 
i
 =ğ0 ? 
T_CONFIG_SCOPE_SERVER
 : 
T_CONFIG_SCOPE_CONNECTION
)) {

205  
HANDLER_ERROR
;

208 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
sql™e_db_Çme
)) {

209 #ifdeà
USE_PROPPATCH


210 cÚ¡ *
Ãxt_¡mt
;

211 *
”r
;

213 ià(
SQLITE_OK
 !ğ
	`sql™e3_İ’
(
s
->
sql™e_db_Çme
->
±r
, &(s->
sql
))) {

214 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "sqlite3_open failed for",

215 
s
->
sql™e_db_Çme
,

216 
	`sql™e3_”rmsg
(
s
->
sql
));

217  
HANDLER_ERROR
;

220 ià(
SQLITE_OK
 !ğ
	`sql™e3_exec
(
s
->
sql
,

227 
NULL
, NULL, &
”r
)) {

229 ià(0 !ğ
	`¡rcmp
(
”r
, "table…roperties‡lreadyƒxists")) {

230 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ÿn'ˆİ’¿n§ùiÚ:", 
”r
);

231 
	`sql™e3_ä“
(
”r
);

233  
HANDLER_ERROR
;

235 
	`sql™e3_ä“
(
”r
);

238 ià(
SQLITE_OK
 !ğ
	`sql™e3_exec
(
s
->
sql
,

248 
NULL
, NULL, &
”r
)) {

250 ià(0 !ğ
	`¡rcmp
(
”r
, "table†ocks‡lreadyƒxists")) {

251 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ÿn'ˆİ’¿n§ùiÚ:", 
”r
);

252 
	`sql™e3_ä“
(
”r
);

254  
HANDLER_ERROR
;

256 
	`sql™e3_ä“
(
”r
);

259 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

260 
	`CONST_STR_LEN
("SELECT value FROM…roperties WHERE„esource = ? AND…rop = ? AND‚s = ?"),

261 &(
s
->
¡mt_£Ëù_´İ
), &
Ãxt_¡mt
)) {

264 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed:", 
	`sql™e3_”rmsg
(
s
->
sql
));

265  
HANDLER_ERROR
;

268 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

269 
	`CONST_STR_LEN
("SELECT‚s,…rop FROM…roperties WHERE„esource = ?"),

270 &(
s
->
¡mt_£Ëù_´İÇmes
), &
Ãxt_¡mt
)) {

273 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed:", 
	`sql™e3_”rmsg
(
s
->
sql
));

274  
HANDLER_ERROR
;

278 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

279 
	`CONST_STR_LEN
("REPLACE INTO…roperties (resource,…rop,‚s, value) VALUES (?, ?, ?, ?)"),

280 &(
s
->
¡mt_upd©e_´İ
), &
Ãxt_¡mt
)) {

283 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed:", 
	`sql™e3_”rmsg
(
s
->
sql
));

284  
HANDLER_ERROR
;

287 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

288 
	`CONST_STR_LEN
("DELETE FROM…roperties WHERE„esource = ? AND…rop = ? AND‚s = ?"),

289 &(
s
->
¡mt_d–‘e_´İ
), &
Ãxt_¡mt
)) {

291 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

293  
HANDLER_ERROR
;

296 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

297 
	`CONST_STR_LEN
("DELETE FROM…roperties WHERE„esource = ?"),

298 &(
s
->
¡mt_d–‘e_uri
), &
Ãxt_¡mt
)) {

300 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

302  
HANDLER_ERROR
;

305 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

306 
	`CONST_STR_LEN
("INSERT INTO…roperties SELECT ?,…rop,‚s, value FROM…roperties WHERE„esource = ?"),

307 &(
s
->
¡mt_cİy_uri
), &
Ãxt_¡mt
)) {

309 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

311  
HANDLER_ERROR
;

314 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

315 
	`CONST_STR_LEN
("UPDATE OR REPLACE…roperties SET„esource = ? WHERE„esource = ?"),

316 &(
s
->
¡mt_move_uri
), &
Ãxt_¡mt
)) {

318 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

320  
HANDLER_ERROR
;

325 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

326 
	`CONST_STR_LEN
("INSERT INTO†ocks (locktoken,„esource,†ockscope,†ocktype, owner, depth,imeout) VALUES (?,?,?,?,?,?, CURRENT_TIME + 600)"),

327 &(
s
->
¡mt_ü—‹_lock
), &
Ãxt_¡mt
)) {

329 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

331  
HANDLER_ERROR
;

334 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

335 
	`CONST_STR_LEN
("DELETE FROM†ocks WHERE†ocktoken = ?"),

336 &(
s
->
¡mt_»move_lock
), &
Ãxt_¡mt
)) {

338 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

340  
HANDLER_ERROR
;

343 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

344 
	`CONST_STR_LEN
("SELECT†ocktoken,„esource,†ockscope,†ocktype, owner, depth,imeout-CURRENT_TIME FROM†ocks WHERE†ocktoken = ?"),

345 &(
s
->
¡mt_»ad_lock
), &
Ãxt_¡mt
)) {

347 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

349  
HANDLER_ERROR
;

352 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

353 
	`CONST_STR_LEN
("SELECT†ocktoken,„esource,†ockscope,†ocktype, owner, depth,imeout-CURRENT_TIME FROM†ocks WHERE„esource = ?"),

354 &(
s
->
¡mt_»ad_lock_by_uri
), &
Ãxt_¡mt
)) {

356 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

358  
HANDLER_ERROR
;

361 ià(
SQLITE_OK
 !ğ
	`sql™e3_´•¬e
(
s
->
sql
,

362 
	`CONST_STR_LEN
("UPDATE†ocks SETimeout = CURRENT_TIME + 600 WHERE†ocktoken = ?"),

363 &(
s
->
¡mt_»äesh_lock
), &
Ãxt_¡mt
)) {

365 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql™e3_´•¬çed", 
	`sql™e3_”rmsg
(
s
->
sql
));

367  
HANDLER_ERROR
;

372 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "Sorry,‚o sqlite3‡nd†ibxml2 support include, compile with --with-webdav-props");

373  
HANDLER_ERROR
;

378  
HANDLER_GO_ON
;

379 
	}
}

381 
	#PATCH_OPTION
(
x
) \

382 
p
->
cÚf
.
x
 = 
s
->x;

	)

383 
	$mod_webdav_·tch_cÚÃùiÚ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
¶ugš_d©a
 *
p
) {

384 
size_t
 
i
, 
j
;

385 
¶ugš_cÚfig
 *
s
 = 
p
->
cÚfig_¡Üage
[0];

387 
	`PATCH_OPTION
(
’abËd
);

388 
	`PATCH_OPTION
(
is_»adÚly
);

389 
	`PATCH_OPTION
(
log_xml
);

391 #ifdeà
USE_PROPPATCH


392 
	`PATCH_OPTION
(
sql
);

393 
	`PATCH_OPTION
(
¡mt_upd©e_´İ
);

394 
	`PATCH_OPTION
(
¡mt_d–‘e_´İ
);

395 
	`PATCH_OPTION
(
¡mt_£Ëù_´İ
);

396 
	`PATCH_OPTION
(
¡mt_£Ëù_´İÇmes
);

398 
	`PATCH_OPTION
(
¡mt_d–‘e_uri
);

399 
	`PATCH_OPTION
(
¡mt_move_uri
);

400 
	`PATCH_OPTION
(
¡mt_cİy_uri
);

402 
	`PATCH_OPTION
(
¡mt_»move_lock
);

403 
	`PATCH_OPTION
(
¡mt_»äesh_lock
);

404 
	`PATCH_OPTION
(
¡mt_ü—‹_lock
);

405 
	`PATCH_OPTION
(
¡mt_»ad_lock
);

406 
	`PATCH_OPTION
(
¡mt_»ad_lock_by_uri
);

409 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

410 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

411 
s
 = 
p
->
cÚfig_¡Üage
[
i
];

414 ià(!
	`cÚfig_check_cÚd
(
¤v
, 
cÚ
, 
dc
)) ;

417 
j
 = 0; j < 
dc
->
v®ue
->
u£d
; j++) {

418 
d©a_un£t
 *
du
 = 
dc
->
v®ue
->
d©a
[
j
];

420 ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("webdav.activate"))) {

421 
	`PATCH_OPTION
(
’abËd
);

422 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("webdav.is-readonly"))) {

423 
	`PATCH_OPTION
(
is_»adÚly
);

424 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("webdav.log-xml"))) {

425 
	`PATCH_OPTION
(
log_xml
);

426 } ià(
	`bufãr_is_equ®_¡ršg
(
du
->
key
, 
	`CONST_STR_LEN
("webdav.sqlite-db-name"))) {

427 #ifdeà
USE_PROPPATCH


428 
	`PATCH_OPTION
(
sql
);

429 
	`PATCH_OPTION
(
¡mt_upd©e_´İ
);

430 
	`PATCH_OPTION
(
¡mt_d–‘e_´İ
);

431 
	`PATCH_OPTION
(
¡mt_£Ëù_´İ
);

432 
	`PATCH_OPTION
(
¡mt_£Ëù_´İÇmes
);

434 
	`PATCH_OPTION
(
¡mt_d–‘e_uri
);

435 
	`PATCH_OPTION
(
¡mt_move_uri
);

436 
	`PATCH_OPTION
(
¡mt_cİy_uri
);

438 
	`PATCH_OPTION
(
¡mt_»move_lock
);

439 
	`PATCH_OPTION
(
¡mt_»äesh_lock
);

440 
	`PATCH_OPTION
(
¡mt_ü—‹_lock
);

441 
	`PATCH_OPTION
(
¡mt_»ad_lock
);

442 
	`PATCH_OPTION
(
¡mt_»ad_lock_by_uri
);

449 
	}
}

451 
	$URIHANDLER_FUNC
(
mod_webdav_uri_hªdËr
) {

452 
¶ugš_d©a
 *
p
 = 
p_d
;

454 
	`UNUSED
(
¤v
);

456 ià(
	`bufãr_is_em±y
(
cÚ
->
uri
.
·th
)è 
HANDLER_GO_ON
;

458 
	`mod_webdav_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
, 
p
);

460 ià(!
p
->
cÚf
.
’abËd
è 
HANDLER_GO_ON
;

462 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

463 
HTTP_METHOD_OPTIONS
:

465 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("DAV"), CONST_STR_LEN("1,2"));

466 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("MS-Author-Via"), CONST_STR_LEN("DAV"));

468 ià(
p
->
cÚf
.
is_»adÚly
) {

469 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Allow"), CONST_STR_LEN("PROPFIND"));

471 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Allow"), CONST_STR_LEN("PROPFIND, DELETE, MKCOL, PUT, MOVE, COPY, PROPPATCH, LOCK, UNLOCK"));

479  
HANDLER_GO_ON
;

480 
	}
}

481 
	$webdav_g’_´İ_g
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
,

482 *
´İ_Çme
,

483 *
´İ_ns
,

484 *
v®ue
,

485 
bufãr
 *
b
) {

487 
	`UNUSED
(
¤v
);

488 
	`UNUSED
(
cÚ
);

490 ià(
v®ue
) {

491 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<"));

492 
	`bufãr_­³nd_¡ršg
(
b
, 
´İ_Çme
);

493 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" xmlns=\""));

494 
	`bufãr_­³nd_¡ršg
(
b
, 
´İ_ns
);

495 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\">"));

497 
	`bufãr_­³nd_¡ršg
(
b
, 
v®ue
);

499 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</"));

500 
	`bufãr_­³nd_¡ršg
(
b
, 
´İ_Çme
);

501 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(">"));

503 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<"));

504 
	`bufãr_­³nd_¡ršg
(
b
, 
´İ_Çme
);

505 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" xmlns=\""));

506 
	`bufãr_­³nd_¡ršg
(
b
, 
´İ_ns
);

507 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\"/>"));

511 
	}
}

514 
	$webdav_g’_»¥Ú£_¡©us_g
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
physiÿl
 *
d¡
, 
¡©us
, 
bufãr
 *
b
) {

515 
	`UNUSED
(
¤v
);

517 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:response xmlns:ns0=\"urn:uuid:c2f41010-65b3-11d1-a29f-00aa00c14882/\">\n"));

519 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:href>\n"));

520 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
d¡
->
»l_·th
);

521 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:href>\n"));

522 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:status>\n"));

524 ià(
cÚ
->
»que¡
.
h‰p_v”siÚ
 =ğ
HTTP_VERSION_1_1
) {

525 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("HTTP/1.1 "));

527 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("HTTP/1.0 "));

529 
	`bufãr_­³nd_št
(
b
, 
¡©us
);

530 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

531 
	`bufãr_­³nd_¡ršg
(
b
, 
	`g‘_h‰p_¡©us_Çme
(
¡©us
));

533 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:status>\n"));

534 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:response>\n"));

537 
	}
}

539 
	$webdav_d–‘e_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
d¡
, 
bufãr
 *
b
) {

540 
¡©us
 = 0;

543 ià(-1 =ğ
	`uÆšk
(
d¡
->
·th
->
±r
)) {

544 
”ºo
) {

545 
EACCES
:

546 
EPERM
:

548 
¡©us
 = 403;

551 
¡©us
 = 501;

554 
	`webdav_g’_»¥Ú£_¡©us_g
(
¤v
, 
cÚ
, 
d¡
, 
¡©us
, 
b
);

556 #ifdeà
USE_PROPPATCH


557 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_d–‘e_uri
;

559 ià(!
¡mt
) {

560 
¡©us
 = 403;

561 
	`webdav_g’_»¥Ú£_¡©us_g
(
¤v
, 
cÚ
, 
d¡
, 
¡©us
, 
b
);

563 
	`sql™e3_»£t
(
¡mt
);

567 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

568 
	`CONST_BUF_LEN
(
d¡
->
»l_·th
),

569 
SQLITE_TRANSIENT
);

571 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

576 
	`UNUSED
(
hùx
);

580  (
¡©us
 != 0);

581 
	}
}

583 
	$webdav_d–‘e_dœ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
d¡
, 
bufãr
 *
b
) {

584 
DIR
 *
dœ
;

585 
have_muÉi_¡©us
 = 0;

586 
physiÿl
 
d
;

588 
d
.
·th
 = 
	`bufãr_š™
();

589 
d
.
»l_·th
 = 
	`bufãr_š™
();

591 ià(
NULL
 !ğ(
dœ
 = 
	`İ’dœ
(
d¡
->
·th
->
±r
))) {

592 
dœ’t
 *
de
;

594 
NULL
 !ğ(
de
 = 
	`»addœ
(
dœ
))) {

595 
¡©
 
¡
;

597 ià((
de
->
d_Çme
[0] == '.' && de->d_name[1] == '\0') ||

598 (
de
->
d_Çme
[0] == '.' && de->d_name[1] == '.' && de->d_name[2] == '\0')) {

603 
	`bufãr_cİy_bufãr
(
d
.
·th
, 
d¡
->path);

604 
	`bufãr_­³nd_¦ash
(
d
.
·th
);

605 
	`bufãr_­³nd_¡ršg
(
d
.
·th
, 
de
->
d_Çme
);

607 
	`bufãr_cİy_bufãr
(
d
.
»l_·th
, 
d¡
->rel_path);

608 
	`bufãr_­³nd_¦ash
(
d
.
»l_·th
);

609 
	`bufãr_­³nd_¡ršg
(
d
.
»l_·th
, 
de
->
d_Çme
);

612 ià(-1 =ğ
	`¡©
(
d
.
·th
->
±r
, &
¡
)) {

614 } ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

615 
have_muÉi_¡©us
 = 
	`webdav_d–‘e_dœ
(
¤v
, 
cÚ
, 
hùx
, &
d
, 
b
);

618 ià(-1 =ğ
	`rmdœ
(
d
.
·th
->
±r
)) {

619 
¡©us
;

620 
”ºo
) {

621 
EACCES
:

622 
EPERM
:

624 
¡©us
 = 403;

627 
¡©us
 = 501;

630 
have_muÉi_¡©us
 = 1;

632 
	`webdav_g’_»¥Ú£_¡©us_g
(
¤v
, 
cÚ
, &
d
, 
¡©us
, 
b
);

634 #ifdeà
USE_PROPPATCH


635 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_d–‘e_uri
;

637 ià(
¡mt
) {

638 
	`sql™e3_»£t
(
¡mt
);

642 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

643 
	`CONST_BUF_LEN
(
d
.
»l_·th
),

644 
SQLITE_TRANSIENT
);

646 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

653 
have_muÉi_¡©us
 = 
	`webdav_d–‘e_fe
(
¤v
, 
cÚ
, 
hùx
, &
d
, 
b
);

656 
	`şo£dœ
(
dœ
);

658 
	`bufãr_ä“
(
d
.
·th
);

659 
	`bufãr_ä“
(
d
.
»l_·th
);

662  
have_muÉi_¡©us
;

663 
	}
}

666 #ià
defšed
(
O_NONBLOCK
)

667 
	#FIFO_NONBLOCK
 
O_NONBLOCK


	)

669 
	#FIFO_NONBLOCK
 0

	)

672 #iâdeà
O_BINARY


673 
	#O_BINARY
 0

	)

676 
	$webdav_cİy_fe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
¤c
,…hysiÿÈ*
d¡
, 
ov”wr™e
) {

677 *
d©a
;

678 
ssize_t
 
rd
, 
wr
, 
off£t
;

679 
¡©us
 = 0, 
ifd
, 
ofd
;

680 
	`UNUSED
(
¤v
);

681 
	`UNUSED
(
cÚ
);

683 ià(-1 =ğ(
ifd
 = 
	`İ’
(
¤c
->
·th
->
±r
, 
O_RDONLY
 | 
O_BINARY
 | 
FIFO_NONBLOCK
))) {

687 ià(-1 =ğ(
ofd
 = 
	`İ’
(
d¡
->
·th
->
±r
, 
O_WRONLY
|
O_TRUNC
|
O_CREAT
|(
ov”wr™e
 ? 0 : 
O_EXCL
), 
WEBDAV_FILE_MODE
))) {

689 
”ºo
) {

690 
EEXIST
:

691 
¡©us
 = 412;

693 
EISDIR
:

694 
¡©us
 = 409;

696 
ENOENT
:

698 
¡©us
 = 409;

701 
¡©us
 = 403;

704 
	`şo£
(
ifd
);

705  
¡©us
;

708 
d©a
 = 
	`m®loc
(131072);

709 
	`fÜû_as£¹
(
d©a
);

711 0 < (
rd
 = 
	`»ad
(
ifd
, 
d©a
, 131072))) {

712 
off£t
 = 0;

714 
wr
 = 
	`wr™e
(
ofd
, 
d©a
+
off£t
, (
size_t
)(
rd
-offset));

715 } 
wr
 >ğ0 ? (
off£t
 +ğwrè!ğ
rd
 : (
”ºo
 =ğ
EINTR
));

716 ià(-1 =ğ
wr
) {

717 
¡©us
 = (
”ºo
 =ğ
ENOSPC
) ? 507 : 403;

722 ià(0 !ğ
rd
 && 0 =ğ
¡©us
) status = 403;

724 
	`ä“
(
d©a
);

725 
	`şo£
(
ifd
);

726 ià(0 !ğ
	`şo£
(
ofd
)) {

727 ià(0 =ğ
¡©us
è¡©u ğ(
”ºo
 =ğ
ENOSPC
) ? 507 : 403;

728 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

729 "şo£ ", 
d¡
->
·th
, "çed: ", 
	`¡»¼Ü
(
”ºo
));

732 #ifdeà
USE_PROPPATCH


733 ià(0 =ğ
¡©us
) {

735 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_cİy_uri
;

737 ià(
¡mt
) {

738 
	`sql™e3_»£t
(
¡mt
);

741 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

742 
	`CONST_BUF_LEN
(
d¡
->
»l_·th
),

743 
SQLITE_TRANSIENT
);

745 
	`sql™e3_bšd_‹xt
(
¡mt
, 2,

746 
	`CONST_BUF_LEN
(
¤c
->
»l_·th
),

747 
SQLITE_TRANSIENT
);

749 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

755 
	`UNUSED
(
hùx
);

757  
¡©us
;

758 
	}
}

760 
	$webdav_cİy_dœ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
¤c
,…hysiÿÈ*
d¡
, 
ov”wr™e
) {

761 
DIR
 *
¤cdœ
;

762 
¡©us
 = 0;

764 ià(
NULL
 !ğ(
¤cdœ
 = 
	`İ’dœ
(
¤c
->
·th
->
±r
))) {

765 
dœ’t
 *
de
;

766 
physiÿl
 
s
, 
d
;

768 
s
.
·th
 = 
	`bufãr_š™
();

769 
s
.
»l_·th
 = 
	`bufãr_š™
();

771 
d
.
·th
 = 
	`bufãr_š™
();

772 
d
.
»l_·th
 = 
	`bufãr_š™
();

774 
NULL
 !ğ(
de
 = 
	`»addœ
(
¤cdœ
))) {

775 
¡©
 
¡
;

777 ià((
de
->
d_Çme
[0] == '.' && de->d_name[1] == '\0')

778 || (
de
->
d_Çme
[0] == '.' && de->d_name[1] == '.' && de->d_name[2] == '\0')) {

782 
	`bufãr_cİy_bufãr
(
s
.
·th
, 
¤c
->path);

783 
	`bufãr_­³nd_¦ash
(
s
.
·th
);

784 
	`bufãr_­³nd_¡ršg
(
s
.
·th
, 
de
->
d_Çme
);

786 
	`bufãr_cİy_bufãr
(
d
.
·th
, 
d¡
->path);

787 
	`bufãr_­³nd_¦ash
(
d
.
·th
);

788 
	`bufãr_­³nd_¡ršg
(
d
.
·th
, 
de
->
d_Çme
);

790 
	`bufãr_cİy_bufãr
(
s
.
»l_·th
, 
¤c
->rel_path);

791 
	`bufãr_­³nd_¦ash
(
s
.
»l_·th
);

792 
	`bufãr_­³nd_¡ršg
(
s
.
»l_·th
, 
de
->
d_Çme
);

794 
	`bufãr_cİy_bufãr
(
d
.
»l_·th
, 
d¡
->rel_path);

795 
	`bufãr_­³nd_¦ash
(
d
.
»l_·th
);

796 
	`bufãr_­³nd_¡ršg
(
d
.
»l_·th
, 
de
->
d_Çme
);

798 ià(-1 =ğ
	`¡©
(
s
.
·th
->
±r
, &
¡
)) {

800 } ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

802 ià(-1 =ğ
	`mkdœ
(
d
.
·th
->
±r
, 
WEBDAV_DIR_MODE
) &&

803 
”ºo
 !ğ
EEXIST
) {

806 #ifdeà
USE_PROPPATCH


807 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_cİy_uri
;

809 ià(0 !ğ(
¡©us
 = 
	`webdav_cİy_dœ
(
¤v
, 
cÚ
, 
hùx
, &
s
, &
d
, 
ov”wr™e
))) {

814 ià(
¡mt
) {

815 
	`sql™e3_»£t
(
¡mt
);

818 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

819 
	`CONST_BUF_LEN
(
d¡
->
»l_·th
),

820 
SQLITE_TRANSIENT
);

822 
	`sql™e3_bšd_‹xt
(
¡mt
, 2,

823 
	`CONST_BUF_LEN
(
¤c
->
»l_·th
),

824 
SQLITE_TRANSIENT
);

826 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

832 } ià(
	`S_ISREG
(
¡
.
¡_mode
)) {

834 ià(0 !ğ(
¡©us
 = 
	`webdav_cİy_fe
(
¤v
, 
cÚ
, 
hùx
, &
s
, &
d
, 
ov”wr™e
))) {

840 
	`bufãr_ä“
(
s
.
·th
);

841 
	`bufãr_ä“
(
s
.
»l_·th
);

842 
	`bufãr_ä“
(
d
.
·th
);

843 
	`bufãr_ä“
(
d
.
»l_·th
);

845 
	`şo£dœ
(
¤cdœ
);

848  
¡©us
;

849 
	}
}

851 #ifdeà
USE_LOCKS


852 
	$webdav_aùiv–ock
(
bufãr
 *
b
,

853 cÚ¡ 
bufãr
 *
locktok’
, cÚ¡ *
lockscİe
, cÚ¡ *
lockty³
, 
d•th
, 
timeout
) {

854 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:activelock>\n"));

856 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:lockscope>"));

857 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:"));

858 
	`bufãr_­³nd_¡ršg
(
b
, 
lockscİe
);

859 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("/>"));

860 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:lockscope>\n"));

862 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:locktype>"));

863 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:"));

864 
	`bufãr_­³nd_¡ršg
(
b
, 
lockty³
);

865 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("/>"));

866 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:locktype>\n"));

868 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:depth>"));

869 
	`bufãr_­³nd_¡ršg
(
b
, 
d•th
 == 0 ? "0" : "infinity");

870 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:depth>\n"));

872 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:timeout>"));

873 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("Second-"));

874 
	`bufãr_­³nd_št
(
b
, 
timeout
);

875 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:timeout>\n"));

877 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:owner>"));

878 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:owner>\n"));

880 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:locktoken>"));

881 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:href>"));

882 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
locktok’
);

883 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:href>"));

884 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:locktoken>\n"));

886 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:activelock>\n"));

887 
	}
}

889 
	$webdav_g‘_live_´İ”ty_lockdiscov”y
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
d¡
, 
bufãr
 *
b
) {

891 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_»ad_lock_by_uri
;

892 ià(!
¡mt
) {

893 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:lockdiscovery>\n</D:lockdiscovery>\n"));

896 
	`UNUSED
(
¤v
);

897 
	`UNUSED
(
cÚ
);

903 
	`sql™e3_»£t
(
¡mt
);

905 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

906 
	`CONST_BUF_LEN
(
d¡
->
»l_·th
),

907 
SQLITE_TRANSIENT
);

909 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:lockdiscovery>\n"));

910 
SQLITE_ROW
 =ğ
	`sql™e3_¡•
(
¡mt
)) {

911 cÚ¡ *
lockscİe
 = (cÚ¡ *)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 2);

912 cÚ¡ *
lockty³
 = (cÚ¡ *)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 3);

913 cÚ¡ 
d•th
 = 
	`sql™e3_cŞumn_št
(
¡mt
, 5);

914 cÚ¡ 
timeout
 = 
	`sql™e3_cŞumn_št
(
¡mt
, 6);

915 
bufãr
 
locktok’
 = { 
NULL
, 0, 0 };

916 
locktok’
.
±r
 = (*)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 0);

917 
locktok’
.
u£d
 = 
	`sql™e3_cŞumn_by‹s
(
¡mt
, 0);

918 ià(
locktok’
.
u£d
) ++locktoken.used;

919 
locktok’
.
size
 =†ocktok’.
u£d
;

921 ià(
timeout
 > 0) {

922 
	`webdav_aùiv–ock
(
b
, &
locktok’
, 
lockscİe
, 
lockty³
, 
d•th
, 
timeout
);

925 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:lockdiscovery>\n"));

926 
	}
}

929 
	$webdav_g‘_live_´İ”ty
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
d¡
, *
´İ_Çme
, 
bufãr
 *
b
) {

930 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

931 
found
 = 0;

933 
	`UNUSED
(
hùx
);

935 ià(
HANDLER_ERROR
 !ğ(
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, 
d¡
->
·th
, &
sû
))) {

936 
ùime_buf
[] = "2005-08-18T07:27:16Z";

937 
mtime_buf
[] = "Thu, 18 Aug 2005 07:27:16 GMT";

938 
size_t
 
k
;

940 ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "resourcetype")) {

941 ià(
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)) {

942 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:resourcetype><D:collection/></D:resourcetype>"));

944 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:resourcetype/>"));

946 
found
 = 1;

947 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "getcontenttype")) {

948 ià(
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)) {

949 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:getcontenttype>httpd/unix-directory</D:getcontenttype>"));

950 
found
 = 1;

951 } if(
	`S_ISREG
(
sû
->
¡
.
¡_mode
)) {

952 
k
 = 0; k < 
cÚ
->
cÚf
.
mim‘y³s
->
u£d
; k++) {

953 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
cÚ
->
cÚf
.
mim‘y³s
->
d©a
[
k
];

955 ià(
	`bufãr_is_em±y
(
ds
->
key
)) ;

957 ià(
	`bufãr_is_equ®_right_Ën
(
d¡
->
·th
, 
ds
->
key
, 
	`bufãr_¡ršg_Ëngth
(ds->key))) {

958 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:getcontenttype>"));

959 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
v®ue
);

960 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:getcontenttype>"));

961 
found
 = 1;

967 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "creationdate")) {

968 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:creationdate‚s0:dt=\"dateTime.tz\">"));

969 
	`¡ráime
(
ùime_buf
, (ùime_buf), "%Y-%m-%dT%H:%M:%SZ", 
	`gmtime
(&(
sû
->
¡
.
¡_ùime
)));

970 
	`bufãr_­³nd_¡ršg
(
b
, 
ùime_buf
);

971 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:creationdate>"));

972 
found
 = 1;

973 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "getlastmodified")) {

974 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:getlastmodified‚s0:dt=\"dateTime.rfc1123\">"));

975 
	`¡ráime
(
mtime_buf
, (mtime_buf), "%a, %d %b %Y %H:%M:%S GMT", 
	`gmtime
(&(
sû
->
¡
.
¡_mtime
)));

976 
	`bufãr_­³nd_¡ršg
(
b
, 
mtime_buf
);

977 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:getlastmodified>"));

978 
found
 = 1;

979 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "getcontentlength")) {

980 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:getcontentlength>"));

981 
	`bufãr_­³nd_št
(
b
, 
sû
->
¡
.
¡_size
);

982 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:getcontentlength>"));

983 
found
 = 1;

984 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "getcontentlanguage")) {

985 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:getcontentlanguage>"));

986 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("en"));

987 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:getcontentlanguage>"));

988 
found
 = 1;

989 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "getetag")) {

990 
	`‘ag_ü—‹
(
cÚ
->
physiÿl
.
‘ag
, &
sû
->
¡
, cÚ->
‘ag_æags
);

991 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<D:getetag>"));

992 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
physiÿl
.
‘ag
);

993 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:getetag>"));

994 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
‘ag
);

995 
found
 = 1;

996 #ifdeà
USE_LOCKS


997 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "lockdiscovery")) {

998 
	`webdav_g‘_live_´İ”ty_lockdiscov”y
(
¤v
, 
cÚ
, 
hùx
, 
d¡
, 
b
);

999 
found
 = 1;

1000 } ià(0 =ğ
	`¡rcmp
(
´İ_Çme
, "supportedlock")) {

1001 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:supportedlock>"));

1002 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:lockentry>"));

1003 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:lockscope><D:exclusive/></D:lockscope>"));

1004 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:locktype><D:write/></D:locktype>"));

1005 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:lockentry>"));

1006 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("</D:supportedlock>"));

1007 
found
 = 1;

1012  
found
 ? 0 : -1;

1013 
	}
}

1015 
	$webdav_g‘_´İ”ty
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
d¡
, *
´İ_Çme
, *
´İ_ns
, 
bufãr
 *
b
) {

1016 ià(0 =ğ
	`¡rcmp
(
´İ_ns
, "DAV:")) {

1018  
	`webdav_g‘_live_´İ”ty
(
¤v
, 
cÚ
, 
hùx
, 
d¡
, 
´İ_Çme
, 
b
);

1020 
found
 = 0;

1021 #ifdeà
USE_PROPPATCH


1022 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_£Ëù_´İ
;

1024 ià(
¡mt
) {

1026 
	`sql™e3_»£t
(
¡mt
);

1030 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

1031 
	`CONST_BUF_LEN
(
d¡
->
»l_·th
),

1032 
SQLITE_TRANSIENT
);

1033 
	`sql™e3_bšd_‹xt
(
¡mt
, 2,

1034 
´İ_Çme
,

1035 
	`¡¾’
(
´İ_Çme
),

1036 
SQLITE_TRANSIENT
);

1037 
	`sql™e3_bšd_‹xt
(
¡mt
, 3,

1038 
´İ_ns
,

1039 
	`¡¾’
(
´İ_ns
),

1040 
SQLITE_TRANSIENT
);

1043 
SQLITE_ROW
 =ğ
	`sql™e3_¡•
(
¡mt
)) {

1045 
	`webdav_g’_´İ_g
(
¤v
, 
cÚ
, 
´İ_Çme
, 
´İ_ns
, (*)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 0), 
b
);

1046 
found
 = 1;

1050  
found
 ? 0 : -1;

1055 
	}
}

1058 *
	mns
;

1059 *
	m´İ
;

1060 } 
	twebdav_´İ”ty
;

1062 
webdav_´İ”ty
 
	glive_´İ”t›s
[] = {

1072 #ifdeà
USE_LOCKS


1077 { 
NULL
, NULL }

1081 
webdav_´İ”ty
 **
	m±r
;

1083 
size_t
 
	mu£d
;

1084 
size_t
 
	msize
;

1085 } 
	twebdav_´İ”t›s
;

1087 
	$webdav_g‘_´İs
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
physiÿl
 *
d¡
, 
webdav_´İ”t›s
 *
´İs
, 
bufãr
 *
b_200
, bufã¸*
b_404
) {

1088 
size_t
 
i
;

1090 ià(
´İs
 &&…rİs->
u£d
) {

1091 
i
 = 0; i < 
´İs
->
u£d
; i++) {

1092 
webdav_´İ”ty
 *
´İ
;

1094 
´İ
 = 
´İs
->
±r
[
i
];

1096 ià(0 !ğ
	`webdav_g‘_´İ”ty
(
¤v
, 
cÚ
, 
hùx
,

1097 
d¡
, 
´İ
->´İ,…rİ->
ns
, 
b_200
)) {

1098 
	`webdav_g’_´İ_g
(
¤v
, 
cÚ
, 
´İ
->´İ,…rİ->
ns
, 
NULL
, 
b_404
);

1102 
i
 = 0; 
live_´İ”t›s
[i].
´İ
; i++) {

1104 
	`webdav_g‘_live_´İ”ty
(
¤v
, 
cÚ
, 
hùx
, 
d¡
, 
live_´İ”t›s
[
i
].
´İ
, 
b_200
);

1109 
	}
}

1111 #ifdeà
USE_PROPPATCH


1112 
	$webdav_·r£_chunkqueue
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
chunkqueue
 *
cq
, 
xmlDoc
 **
»t_xml
) {

1113 
xmlP¬£rCtxtPŒ
 
ùxt
;

1114 
xmlDoc
 *
xml
;

1115 
»s
;

1116 
”r
;

1118 
chunk
 *
c
;

1120 
	`UNUSED
(
cÚ
);

1123 
ùxt
 = 
	`xmlC»©ePushP¬£rCtxt
(
NULL
, NULL, NULL, 0, NULL);

1125 
c
 = 
cq
->
fœ¡
; cq->
by‹s_out
 !ğcq->
by‹s_š
; c = cq->first) {

1126 
size_t
 
weWªt
 = 
cq
->
by‹s_out
 - cq->
by‹s_š
;

1127 
size_t
 
weHave
;

1128 
m­³d
;

1129 *
d©a
;

1131 
c
->
ty³
) {

1132 
FILE_CHUNK
:

1133 
weHave
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

1135 ià(
weHave
 > 
weWªt
) weHave = weWant;

1138 
m­³d
 = (
c
->
fe
.
mm­
.
¡¬t
 !ğ
MAP_FAILED
);

1139 ià(
m­³d
) {

1140 
d©a
 = 
c
->
fe
.
mm­
.
¡¬t
 + c->
off£t
;

1142 ià(-1 =ğ
c
->
fe
.
fd
 &&

1143 -1 =ğ(
c
->
fe
.
fd
 = 
	`İ’
(c->fe.
Çme
->
±r
, 
O_RDONLY
))) {

1144 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "İ’ faed: ", 
	`¡»¼Ü
(
”ºo
));

1149 ià(
MAP_FAILED
 !ğ(
c
->
fe
.
mm­
.
¡¬t
 = 
	`mm­
(0, c->fe.
Ëngth
, 
PROT_READ
, 
MAP_PRIVATE
, c->fe.
fd
, 0))) {

1151 
c
->
fe
.
mm­
.
Ëngth
 = c->file.length;

1152 
d©a
 = 
c
->
fe
.
mm­
.
¡¬t
 + c->
off£t
;

1153 
m­³d
 = 1;

1155 
ssize_t
 
rd
;

1156 ià(
weHave
 > 65536) weHave = 65536;

1157 
d©a
 = 
	`m®loc
(
weHave
);

1158 
	`fÜû_as£¹
(
d©a
);

1159 ià(-1 =ğ
	`l£ek
(
c
->
fe
.
fd
, c->fe.
¡¬t
 + c->
off£t
, 
SEEK_SET
)

1160 || 0 > (
rd
 = 
	`»ad
(
c
->
fe
.
fd
, 
d©a
, 
weHave
))) {

1161 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbd", "lseek/read failed: ",

1162 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
, c->fe.
fd
);

1163 
	`ä“
(
d©a
);

1166 
weHave
 = (
size_t
)
rd
;

1170 ià(
XML_ERR_OK
 !ğ(
”r
 = 
	`xmlP¬£Chunk
(
ùxt
, 
d©a
, 
weHave
, 0))) {

1171 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sodd", "xmlP¬£Chunk faed‡t:", 
cq
->
by‹s_out
, 
weHave
, 
”r
);

1174 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
weHave
);

1176 ià(!
m­³d
è
	`ä“
(
d©a
);

1178 
MEM_CHUNK
:

1180 
weHave
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

1182 ià(
weHave
 > 
weWªt
) weHave = weWant;

1184 ià(
hùx
->
cÚf
.
log_xml
) {

1185 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "XML-»que¡-body:", 
c
->
mem
->
±r
 + c->
off£t
);

1188 ià(
XML_ERR_OK
 !ğ(
”r
 = 
	`xmlP¬£Chunk
(
ùxt
, 
c
->
mem
->
±r
 + c->
off£t
, 
weHave
, 0))) {

1189 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sodd", "xmlP¬£Chunk faed‡t:", 
cq
->
by‹s_out
, 
weHave
, 
”r
);

1192 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
weHave
);

1198 (
”r
 = 
	`xmlP¬£Chunk
(
ùxt
, 0, 0, 1))) {

1199 
XML_ERR_DOCUMENT_END
:

1200 
XML_ERR_OK
:

1203 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "xmlP¬£Chunk faed‡ˆfš®…ack‘:", 
”r
);

1207 
xml
 = 
ùxt
->
myDoc
;

1208 
»s
 = 
ùxt
->
w–lFÜmed
;

1209 
	`xmlF»eP¬£rCtxt
(
ùxt
);

1211 ià(
»s
 == 0) {

1212 
	`xmlF»eDoc
(
xml
);

1214 *
»t_xml
 = 
xml
;

1217  
»s
;

1218 
	}
}

1221 #ifdeà
USE_LOCKS


1222 
	$webdav_lockdiscov”y
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
,

1223 
bufãr
 *
locktok’
, cÚ¡ *
lockscİe
, cÚ¡ *
lockty³
, 
d•th
) {

1225 
bufãr
 *
b
 = 
	`bufãr_š™
();

1227 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Lock-Tok’"), 
	`CONST_BUF_LEN
(
locktok’
));

1229 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
,

1230 
	`CONST_STR_LEN
("Content-Type"),

1231 
	`CONST_STR_LEN
("text/xml; charset=\"utf-8\""));

1233 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<?xml version=\"1.0\"ƒncoding=\"utf-8\"?>\n"));

1235 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:prop xmlns:D=\"DAV:\" xmlns:ns0=\"urn:uuid:c2f41010-65b3-11d1-a29f-00aa00c14882/\">\n"));

1236 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:lockdiscovery>\n"));

1237 
	`webdav_aùiv–ock
(
b
, 
locktok’
, 
lockscİe
, 
lockty³
, 
d•th
, 600);

1238 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:lockdiscovery>\n"));

1239 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:prop>\n"));

1241 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

1242 
	`bufãr_ä“
(
b
);

1245 
	}
}

1254 
	$webdav_has_lock
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
hªdËr_ùx
 *
hùx
, 
bufãr
 *
uri
) {

1255 
has_lock
 = 1;

1257 #ifdeà
USE_LOCKS


1258 
d©a_¡ršg
 *
ds
;

1259 
	`UNUSED
(
¤v
);

1276 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "If"))) {

1285 
sql™e3_¡mt
 *
¡mt
 = 
hùx
->
cÚf
.
¡mt_»ad_lock_by_uri
;

1287 
	`sql™e3_»£t
(
¡mt
);

1289 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

1290 
	`CONST_BUF_LEN
(
uri
),

1291 
SQLITE_TRANSIENT
);

1293 
SQLITE_ROW
 =ğ
	`sql™e3_¡•
(
¡mt
)) {

1294 
has_lock
 = 0;

1298 
	`UNUSED
(
¤v
);

1299 
	`UNUSED
(
cÚ
);

1300 
	`UNUSED
(
hùx
);

1301 
	`UNUSED
(
uri
);

1304  
has_lock
;

1305 
	}
}

1308 
	$SUBREQUEST_FUNC
(
mod_webdav_sub»que¡_hªdËr_huge
) {

1309 
¶ugš_d©a
 *
p
 = 
p_d
;

1310 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

1311 
bufãr
 *
b
;

1312 
DIR
 *
dœ
;

1313 
d©a_¡ršg
 *
ds
;

1314 
d•th
 = -1;

1315 
¡©
 
¡
;

1316 
bufãr
 *
´İ_200
;

1317 
bufãr
 *
´İ_404
;

1318 
webdav_´İ”t›s
 *
»q_´İs
;

1319 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

1321 
	`UNUSED
(
¤v
);

1323 ià(
NULL
 =ğ
hùx
è 
HANDLER_GO_ON
;

1324 ià(!
hùx
->
cÚf
.
’abËd
è 
HANDLER_GO_ON
;

1326 ià(
	`bufãr_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

1329 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "D•th")è&& 1 =ğ
	`bufãr_¡ršg_Ëngth
(ds->
v®ue
)) {

1330 ià('0' =ğ*
ds
->
v®ue
->
±r
) {

1331 
d•th
 = 0;

1332 } ià('1' =ğ*
ds
->
v®ue
->
±r
) {

1333 
d•th
 = 1;

1337 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

1338 
HTTP_METHOD_PROPFIND
:

1340 
»q_´İs
 = 
NULL
;

1344 
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

1345 
HANDLER_ERROR
:

1346 ià(
”ºo
 =ğ
ENOENT
) {

1347 
cÚ
->
h‰p_¡©us
 = 404;

1348  
HANDLER_FINISHED
;

1355 ià(
	`S_ISDIR
(
sû
->
¡
.
¡_mode
è&& 
cÚ
->
physiÿl
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(con->physical.path)-1] != '/') {

1356 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
¤v
, 
cÚ
);

1357  
HANDLER_FINISHED
;

1360 #ifdeà
USE_PROPPATCH


1362 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

1363 
xmlDocPŒ
 
xml
;

1365 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST
) {

1366 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

1367 ià(
r
 !ğ
HANDLER_GO_ON
) „;

1370 ià(1 =ğ
	`webdav_·r£_chunkqueue
(
¤v
, 
cÚ
, 
hùx
, cÚ->
»que¡_cÚ‹Á_queue
, &
xml
)) {

1371 
xmlNode
 *
roÙnode
 = 
	`xmlDocG‘RoÙEËm’t
(
xml
);

1373 
	`fÜû_as£¹
(
roÙnode
);

1375 ià(0 =ğ
	`xmlSŒcmp
(
roÙnode
->
Çme
, 
BAD_CAST
 "propfind")) {

1376 
xmlNode
 *
cmd
;

1378 
»q_´İs
 = 
	`ÿÎoc
(1, (*req_props));

1380 
cmd
 = 
roÙnode
->
chd»n
; cmd; cmd = cmd->
Ãxt
) {

1382 ià(0 =ğ
	`xmlSŒcmp
(
cmd
->
Çme
, 
BAD_CAST
 "prop")) {

1384 
xmlNode
 *
´İ
;

1386 
´İ
 = 
cmd
->
chd»n
;…rİ;…rİ =…rİ->
Ãxt
) {

1387 ià(
´İ
->
ty³
 =ğ
XML_TEXT_NODE
) ;

1389 ià(
´İ
->
ns
 &&

1390 (0 =ğ
	`xmlSŒcmp
(
´İ
->
ns
->
h»f
, 
BAD_CAST
 "")) &&

1391 (0 !ğ
	`xmlSŒcmp
(
´İ
->
ns
->
´efix
, 
BAD_CAST
 ""))) {

1392 
size_t
 
i
;

1393 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1395 
´İ
->
Çme
);

1397 
	`xmlF»eDoc
(
xml
);

1399 
i
 = 0; i < 
»q_´İs
->
u£d
; i++) {

1400 
	`ä“
(
»q_´İs
->
±r
[
i
]->
ns
);

1401 
	`ä“
(
»q_´İs
->
±r
[
i
]->
´İ
);

1402 
	`ä“
(
»q_´İs
->
±r
[
i
]);

1404 
	`ä“
(
»q_´İs
->
±r
);

1405 
	`ä“
(
»q_´İs
);

1407 
cÚ
->
h‰p_¡©us
 = 400;

1408  
HANDLER_FINISHED
;

1412 ià(
»q_´İs
->
size
 == 0) {

1413 
»q_´İs
->
size
 = 16;

1414 
»q_´İs
->
±r
 = 
	`m®loc
((*Ôeq_´İs->±r)è*„eq_´İs->
size
);

1415 } ià(
»q_´İs
->
u£d
 =ğ»q_´İs->
size
) {

1416 
»q_´İs
->
size
 += 16;

1417 
»q_´İs
->
±r
 = 
	`»®loc
Ôeq_´İs->±r, (*Ôeq_´İs->±r)è*„eq_´İs->
size
);

1420 
»q_´İs
->
±r
[»q_´İs->
u£d
] = 
	`m®loc
((
webdav_´İ”ty
));

1421 
»q_´İs
->
±r
[»q_´İs->
u£d
]->
ns
 = (*)
	`xmlSŒdup
(
´İ
->n ?…rİ->ns->
h»f
 : (
xmlCh¬
 *)"");

1422 
»q_´İs
->
±r
[»q_´İs->
u£d
]->
´İ
 = (*)
	`xmlSŒdup
Õrİ->
Çme
);

1423 
»q_´İs
->
u£d
++;

1425 } ià(0 =ğ
	`xmlSŒcmp
(
cmd
->
Çme
, 
BAD_CAST
 "propname")) {

1426 
sql™e3_¡mt
 *
¡mt
 = 
p
->
cÚf
.
¡mt_£Ëù_´İÇmes
;

1428 ià(
¡mt
) {

1430 
	`sql™e3_»£t
(
¡mt
);

1433 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

1434 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
),

1435 
SQLITE_TRANSIENT
);

1437 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

1440 } ià(0 =ğ
	`xmlSŒcmp
(
cmd
->
Çme
, 
BAD_CAST
 "allprop")) {

1446 
	`xmlF»eDoc
(
xml
);

1448 
cÚ
->
h‰p_¡©us
 = 400;

1449  
HANDLER_FINISHED
;

1453 
cÚ
->
h‰p_¡©us
 = 207;

1455 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/xml; charset=\"utf-8\""));

1457 
b
 = 
	`bufãr_š™
();

1459 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<?xml version=\"1.0\"ƒncoding=\"utf-8\"?>\n"));

1461 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:multistatus xmlns:D=\"DAV:\" xmlns:ns0=\"urn:uuid:c2f41010-65b3-11d1-a29f-00aa00c14882/\">\n"));

1465 
´İ_200
 = 
	`bufãr_š™
();

1466 
´İ_404
 = 
	`bufãr_š™
();

1470 
	`webdav_g‘_´İs
(
¤v
, 
cÚ
, 
hùx
, &(cÚ->
physiÿl
), 
»q_´İs
, 
´İ_200
, 
´İ_404
);

1472 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:response>\n"));

1473 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:href>"));

1474 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
uri
.
scheme
);

1475 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("://"));

1476 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
uri
.
authÜ™y
);

1477 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
), 
ENCODING_REL_URI
);

1478 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:href>\n"));

1480 ià(!
	`bufãr_¡ršg_is_em±y
(
´İ_200
)) {

1481 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:propstat>\n"));

1482 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:prop>\n"));

1484 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
´İ_200
);

1486 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:prop>\n"));

1488 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:status>HTTP/1.1 200 OK</D:status>\n"));

1490 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:propstat>\n"));

1492 ià(!
	`bufãr_¡ršg_is_em±y
(
´İ_404
)) {

1493 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:propstat>\n"));

1494 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:prop>\n"));

1496 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
´İ_404
);

1498 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:prop>\n"));

1500 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:status>HTTP/1.1 404 Not Found</D:status>\n"));

1502 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:propstat>\n"));

1505 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:response>\n"));

1508 ià(
d•th
 == 1) {

1510 ià(
NULL
 !ğ(
dœ
 = 
	`İ’dœ
(
cÚ
->
physiÿl
.
·th
->
±r
))) {

1511 
dœ’t
 *
de
;

1512 
physiÿl
 
d
;

1513 
physiÿl
 *
d¡
 = &(
cÚ
->physical);

1515 
d
.
·th
 = 
	`bufãr_š™
();

1516 
d
.
»l_·th
 = 
	`bufãr_š™
();

1518 
NULL
 !ğ(
de
 = 
	`»addœ
(
dœ
))) {

1519 ià(
de
->
d_Çme
[0] == '.' && (de->d_name[1] == '\0' || (de->d_name[1] == '.' && de->d_name[2] == '\0'))) {

1524 
	`bufãr_cİy_bufãr
(
d
.
·th
, 
d¡
->path);

1525 
	`bufãr_­³nd_¦ash
(
d
.
·th
);

1527 
	`bufãr_cİy_bufãr
(
d
.
»l_·th
, 
d¡
->rel_path);

1528 
	`bufãr_­³nd_¦ash
(
d
.
»l_·th
);

1530 
	`bufãr_­³nd_¡ršg
(
d
.
·th
, 
de
->
d_Çme
);

1531 
	`bufãr_­³nd_¡ršg
(
d
.
»l_·th
, 
de
->
d_Çme
);

1533 
	`bufãr_»£t
(
´İ_200
);

1534 
	`bufãr_»£t
(
´İ_404
);

1536 
	`webdav_g‘_´İs
(
¤v
, 
cÚ
, 
hùx
, &
d
, 
»q_´İs
, 
´İ_200
, 
´İ_404
);

1538 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:response>\n"));

1539 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:href>"));

1540 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
uri
.
scheme
);

1541 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("://"));

1542 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
cÚ
->
uri
.
authÜ™y
);

1543 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
d
.
»l_·th
), 
ENCODING_REL_URI
);

1544 ià(0 =ğ
	`¡©
(
d
.
·th
->
±r
, &
¡
è&& 
	`S_ISDIR
(¡.
¡_mode
)) {

1546 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("/"));

1548 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:href>\n"));

1550 ià(!
	`bufãr_¡ršg_is_em±y
(
´İ_200
)) {

1551 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:propstat>\n"));

1552 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:prop>\n"));

1554 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
´İ_200
);

1556 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:prop>\n"));

1558 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:status>HTTP/1.1 200 OK</D:status>\n"));

1560 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:propstat>\n"));

1562 ià(!
	`bufãr_¡ršg_is_em±y
(
´İ_404
)) {

1563 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:propstat>\n"));

1564 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:prop>\n"));

1566 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
´İ_404
);

1568 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:prop>\n"));

1570 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:status>HTTP/1.1 404 Not Found</D:status>\n"));

1572 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:propstat>\n"));

1575 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:response>\n"));

1577 
	`şo£dœ
(
dœ
);

1578 
	`bufãr_ä“
(
d
.
·th
);

1579 
	`bufãr_ä“
(
d
.
»l_·th
);

1584 ià(
»q_´İs
) {

1585 
size_t
 
i
;

1586 
i
 = 0; i < 
»q_´İs
->
u£d
; i++) {

1587 
	`ä“
(
»q_´İs
->
±r
[
i
]->
ns
);

1588 
	`ä“
(
»q_´İs
->
±r
[
i
]->
´İ
);

1589 
	`ä“
(
»q_´İs
->
±r
[
i
]);

1591 
	`ä“
(
»q_´İs
->
±r
);

1592 
	`ä“
(
»q_´İs
);

1595 
	`bufãr_ä“
(
´İ_200
);

1596 
	`bufãr_ä“
(
´İ_404
);

1598 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:multistatus>\n"));

1600 ià(
p
->
cÚf
.
log_xml
) {

1601 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "XML-»¥Ú£-body:", 
b
);

1604 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

1605 
	`bufãr_ä“
(
b
);

1607 
cÚ
->
fe_fšished
 = 1;

1609  
HANDLER_FINISHED
;

1610 
HTTP_METHOD_MKCOL
:

1611 ià(
p
->
cÚf
.
is_»adÚly
) {

1612 
cÚ
->
h‰p_¡©us
 = 403;

1613  
HANDLER_FINISHED
;

1616 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 != 0) {

1618 
cÚ
->
h‰p_¡©us
 = 415;

1620  
HANDLER_FINISHED
;

1625 ià(-1 =ğ
	`mkdœ
(
cÚ
->
physiÿl
.
·th
->
±r
, 
WEBDAV_DIR_MODE
)) {

1626 
”ºo
) {

1627 
EPERM
:

1628 
cÚ
->
h‰p_¡©us
 = 403;

1630 
ENOENT
:

1631 
ENOTDIR
:

1632 
cÚ
->
h‰p_¡©us
 = 409;

1634 
EEXIST
:

1636 
cÚ
->
h‰p_¡©us
 = 405;

1640 
cÚ
->
h‰p_¡©us
 = 201;

1641 
cÚ
->
fe_fšished
 = 1;

1644  
HANDLER_FINISHED
;

1645 
HTTP_METHOD_DELETE
:

1646 ià(
p
->
cÚf
.
is_»adÚly
) {

1647 
cÚ
->
h‰p_¡©us
 = 403;

1648  
HANDLER_FINISHED
;

1652 ià(!
	`webdav_has_lock
(
¤v
, 
cÚ
, 
hùx
, cÚ->
uri
.
·th
)) {

1653 
cÚ
->
h‰p_¡©us
 = 423;

1654  
HANDLER_FINISHED
;

1658 ià(-1 =ğ
	`¡©
(
cÚ
->
physiÿl
.
·th
->
±r
, &
¡
)) {

1660 
”ºo
) {

1661 
ENOENT
:

1662 
cÚ
->
h‰p_¡©us
 = 404;

1665 
cÚ
->
h‰p_¡©us
 = 403;

1668 } ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

1669 
bufãr
 *
muÉi_¡©us_»¥
;

1671 ià(
cÚ
->
physiÿl
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(con->physical.path)-1] != '/') {

1672 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
¤v
, 
cÚ
);

1673  
HANDLER_FINISHED
;

1676 
muÉi_¡©us_»¥
 = 
	`bufãr_š™
();

1678 ià(
	`webdav_d–‘e_dœ
(
¤v
, 
cÚ
, 
hùx
, &(cÚ->
physiÿl
), 
muÉi_¡©us_»¥
)) {

1680 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Content-Type"), CONST_STR_LEN("text/xml; charset=\"utf-8\""));

1682 
b
 = 
	`bufãr_š™
();

1684 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("<?xml version=\"1.0\"ƒncoding=\"utf-8\"?>\n"));

1686 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("<D:multistatus xmlns:D=\"DAV:\">\n"));

1688 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
muÉi_¡©us_»¥
);

1690 
	`bufãr_­³nd_¡ršg_Ën
(
b
,
	`CONST_STR_LEN
("</D:multistatus>\n"));

1692 ià(
p
->
cÚf
.
log_xml
) {

1693 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "XML-»¥Ú£-body:", 
b
);

1696 
	`chunkqueue_­³nd_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

1697 
	`bufãr_ä“
(
b
);

1699 
cÚ
->
h‰p_¡©us
 = 207;

1700 
cÚ
->
fe_fšished
 = 1;

1704 ià(-1 =ğ
	`rmdœ
(
cÚ
->
physiÿl
.
·th
->
±r
)) {

1705 
”ºo
) {

1706 
EPERM
:

1707 
cÚ
->
h‰p_¡©us
 = 403;

1709 
ENOENT
:

1710 
cÚ
->
h‰p_¡©us
 = 404;

1713 
cÚ
->
h‰p_¡©us
 = 501;

1717 
cÚ
->
h‰p_¡©us
 = 204;

1721 
	`bufãr_ä“
(
muÉi_¡©us_»¥
);

1722 } ià(-1 =ğ
	`uÆšk
(
cÚ
->
physiÿl
.
·th
->
±r
)) {

1723 
”ºo
) {

1724 
EPERM
:

1725 
cÚ
->
h‰p_¡©us
 = 403;

1727 
ENOENT
:

1728 
cÚ
->
h‰p_¡©us
 = 404;

1731 
cÚ
->
h‰p_¡©us
 = 501;

1735 
cÚ
->
h‰p_¡©us
 = 204;

1737  
HANDLER_FINISHED
;

1738 
HTTP_METHOD_PUT
: {

1739 
fd
;

1740 
chunkqueue
 *
cq
 = 
cÚ
->
»que¡_cÚ‹Á_queue
;

1741 
chunk
 *
c
;

1742 
d©a_¡ršg
 *
ds_¿nge
;

1744 ià(
p
->
cÚf
.
is_»adÚly
) {

1745 
cÚ
->
h‰p_¡©us
 = 403;

1746  
HANDLER_FINISHED
;

1751 ià(0 =ğ
cq
->
by‹s_š
 && !
	`webdav_has_lock
(
¤v
, 
cÚ
, 
hùx
, cÚ->
uri
.
·th
)) {

1752 
cÚ
->
h‰p_¡©us
 = 423;

1753  
HANDLER_FINISHED
;

1756 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST
) {

1757 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

1758 ià(
r
 !ğ
HANDLER_GO_ON
) „;

1767 ià(
NULL
 !ğ(
ds_¿nge
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Content-Range"))) {

1768 cÚ¡ *
num
 = 
ds_¿nge
->
v®ue
->
±r
;

1769 
off_t
 
off£t
;

1770 *
”r
 = 
NULL
;

1772 ià(0 !ğ
	`¡ºcmp
(
num
, "bytes ", 6)) {

1773 
cÚ
->
h‰p_¡©us
 = 501;

1775  
HANDLER_FINISHED
;

1780 
num
 += 6;

1783 *
num
 == ' ' || *num == '\t')‚um++;

1785 ià(*
num
 == '\0') {

1786 
cÚ
->
h‰p_¡©us
 = 501;

1788  
HANDLER_FINISHED
;

1791 
off£t
 = 
	`¡¹Şl
(
num
, &
”r
, 10);

1793 ià(*
”r
 !ğ'-' || 
off£t
 < 0) {

1794 
cÚ
->
h‰p_¡©us
 = 501;

1796  
HANDLER_FINISHED
;

1799 ià(-1 =ğ(
fd
 = 
	`İ’
(
cÚ
->
physiÿl
.
·th
->
±r
, 
O_WRONLY
, 
WEBDAV_FILE_MODE
))) {

1800 
”ºo
) {

1801 
ENOENT
:

1802 
cÚ
->
h‰p_¡©us
 = 404;

1805 
cÚ
->
h‰p_¡©us
 = 403;

1808  
HANDLER_FINISHED
;

1811 ià(-1 =ğ
	`l£ek
(
fd
, 
off£t
, 
SEEK_SET
)) {

1812 
cÚ
->
h‰p_¡©us
 = 501;

1814 
	`şo£
(
fd
);

1816  
HANDLER_FINISHED
;

1818 
cÚ
->
h‰p_¡©us
 = 200;

1823 ià(-1 =ğ(
fd
 = 
	`İ’
(
cÚ
->
physiÿl
.
·th
->
±r
, 
O_WRONLY
|
O_TRUNC
, 
WEBDAV_FILE_MODE
))) {

1824 ià(
”ºo
 !ğ
ENOENT
 ||

1825 -1 =ğ(
fd
 = 
	`İ’
(
cÚ
->
physiÿl
.
·th
->
±r
, 
O_WRONLY
|
O_CREAT
|
O_TRUNC
|
O_EXCL
, 
WEBDAV_FILE_MODE
))) {

1827 
cÚ
->
h‰p_¡©us
 = 403;

1829  
HANDLER_FINISHED
;

1831 
cÚ
->
h‰p_¡©us
 = 201;

1834 
cÚ
->
h‰p_¡©us
 = 200;

1838 
cÚ
->
fe_fšished
 = 1;

1840 
c
 = 
cq
->
fœ¡
; c; c = cq->first) {

1841 
r
 = 0;

1842 
m­³d
;

1843 *
d©a
;

1844 
size_t
 
dËn
;

1847 
c
->
ty³
) {

1848 
FILE_CHUNK
:

1850 
m­³d
 = (
c
->
fe
.
mm­
.
¡¬t
 !ğ
MAP_FAILED
);

1851 
dËn
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

1852 ià(
m­³d
) {

1853 
d©a
 = 
c
->
fe
.
mm­
.
¡¬t
 + c->
off£t
;

1855 ià(-1 =ğ
c
->
fe
.
fd
 &&

1856 -1 =ğ(
c
->
fe
.
fd
 = 
	`İ’
(c->fe.
Çme
->
±r
, 
O_RDONLY
))) {

1857 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "İ’ faed: ", 
	`¡»¼Ü
(
”ºo
));

1858 
	`şo£
(
fd
);

1859  
HANDLER_ERROR
;

1862 ià(
MAP_FAILED
 !ğ(
c
->
fe
.
mm­
.
¡¬t
 = 
	`mm­
(
NULL
, c->fe.
Ëngth
, 
PROT_READ
, 
MAP_PRIVATE
, c->fe.
fd
, 0))) {

1864 
c
->
fe
.
mm­
.
Ëngth
 = c->file.length;

1865 
d©a
 = 
c
->
fe
.
mm­
.
¡¬t
 + c->
off£t
;

1866 
m­³d
 = 1;

1868 
ssize_t
 
rd
;

1869 ià(
dËn
 > 65536) dlen = 65536;

1870 
d©a
 = 
	`m®loc
(
dËn
);

1871 
	`fÜû_as£¹
(
d©a
);

1872 ià(-1 =ğ
	`l£ek
(
c
->
fe
.
fd
, c->fe.
¡¬t
 + c->
off£t
, 
SEEK_SET
)

1873 || 0 > (
rd
 = 
	`»ad
(
c
->
fe
.
fd
, 
d©a
, 
dËn
))) {

1874 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbd", "lseek/read failed: ",

1875 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
, c->fe.
fd
);

1876 
	`ä“
(
d©a
);

1877 
	`şo£
(
fd
);

1878  
HANDLER_ERROR
;

1880 
dËn
 = (
size_t
)
rd
;

1885 ià((
r
 = 
	`wr™e
(
fd
, 
d©a
, 
dËn
)) < 0) {

1886 
”ºo
) {

1887 
ENOSPC
:

1888 
cÚ
->
h‰p_¡©us
 = 507;

1892 
cÚ
->
h‰p_¡©us
 = 403;

1897 ià(!
m­³d
è
	`ä“
(
d©a
);

1899 
MEM_CHUNK
:

1900 ià((
r
 = 
	`wr™e
(
fd
, 
c
->
mem
->
±r
 + c->
off£t
, 
	`bufãr_¡ršg_Ëngth
(c->mem) - c->offset)) < 0) {

1901 
”ºo
) {

1902 
ENOSPC
:

1903 
cÚ
->
h‰p_¡©us
 = 507;

1907 
cÚ
->
h‰p_¡©us
 = 403;

1914 ià(
r
 > 0) {

1915 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

1920 ià(0 !ğ
	`şo£
(
fd
)) {

1921 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbss",

1922 "şo£ ", 
cÚ
->
physiÿl
.
·th
, "çed: ", 
	`¡»¼Ü
(
”ºo
));

1923  
HANDLER_ERROR
;

1926  
HANDLER_FINISHED
;

1928 
HTTP_METHOD_MOVE
:

1929 
HTTP_METHOD_COPY
: {

1930 
bufãr
 *
de¡š©iÚ
 = 
NULL
;

1931 *
£p
, *
£p2
, *
¡¬t
;

1932 
ov”wr™e
 = 1;

1934 ià(
p
->
cÚf
.
is_»adÚly
) {

1935 
cÚ
->
h‰p_¡©us
 = 403;

1936  
HANDLER_FINISHED
;

1940 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_MOVE
) {

1941 ià(!
	`webdav_has_lock
(
¤v
, 
cÚ
, 
hùx
, cÚ->
uri
.
·th
)) {

1942 
cÚ
->
h‰p_¡©us
 = 423;

1943  
HANDLER_FINISHED
;

1947 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Destination"))) {

1948 
de¡š©iÚ
 = 
ds
->
v®ue
;

1950 
cÚ
->
h‰p_¡©us
 = 400;

1951  
HANDLER_FINISHED
;

1954 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Overwrite"))) {

1955 ià(
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
) != 1 ||

1956 (
ds
->
v®ue
->
±r
[0] != 'F' &&

1957 
ds
->
v®ue
->
±r
[0] != 'T') ) {

1958 
cÚ
->
h‰p_¡©us
 = 400;

1959  
HANDLER_FINISHED
;

1961 
ov”wr™e
 = (
ds
->
v®ue
->
±r
[0] == 'F' ? 0 : 1);

1972 
	`bufãr_»£t
(
p
->
uri
.
scheme
);

1973 
	`bufãr_»£t
(
p
->
uri
.
·th_¿w
);

1974 
	`bufãr_»£t
(
p
->
uri
.
authÜ™y
);

1976 
¡¬t
 = 
de¡š©iÚ
->
±r
;

1978 ià(
NULL
 =ğ(
£p
 = 
	`¡r¡r
(
¡¬t
, "://"))) {

1979 
cÚ
->
h‰p_¡©us
 = 400;

1980  
HANDLER_FINISHED
;

1982 
	`bufãr_cİy_¡ršg_Ën
(
p
->
uri
.
scheme
, 
¡¬t
, 
£p
 - start);

1984 
¡¬t
 = 
£p
 + 3;

1986 ià(
NULL
 =ğ(
£p
 = 
	`¡rchr
(
¡¬t
, '/'))) {

1987 
cÚ
->
h‰p_¡©us
 = 400;

1988  
HANDLER_FINISHED
;

1990 ià(
NULL
 !ğ(
£p2
 = 
	`memchr
(
¡¬t
, '@', 
£p
 - start))) {

1992 
¡¬t
 = 
£p2
 + 1;

1994 
	`bufãr_cİy_¡ršg_Ën
(
p
->
uri
.
authÜ™y
, 
¡¬t
, 
£p
 - start);

1996 
¡¬t
 = 
£p
 + 1;

1998 ià(
NULL
 =ğ(
£p
 = 
	`¡rchr
(
¡¬t
, '?'))) {

2000 
	`bufãr_cİy_¡ršg
(
p
->
uri
.
·th_¿w
, 
¡¬t
);

2002 
	`bufãr_cİy_¡ršg_Ën
(
p
->
uri
.
·th_¿w
, 
¡¬t
, 
£p
 - start);

2005 ià(!
	`bufãr_is_equ®
(
p
->
uri
.
authÜ™y
, 
cÚ
->uri.authority)) {

2007 
cÚ
->
h‰p_¡©us
 = 502;

2008  
HANDLER_FINISHED
;

2011 
	`bufãr_cİy_bufãr
(
p
->
tmp_buf
,…->
uri
.
·th_¿w
);

2012 
	`bufãr_u¾decode_·th
(
p
->
tmp_buf
);

2013 
	`bufãr_·th_sim¶ify
(
p
->
uri
.
·th
,…->
tmp_buf
);

2016 
	`bufãr_cİy_bufãr
(
p
->
physiÿl
.
doc_roÙ
, 
cÚ
->physical.doc_root);

2017 
	`bufãr_cİy_bufãr
(
p
->
physiÿl
.
»l_·th
,…->
uri
.
·th
);

2019 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

2020 
	`bufãr_to_low”
(
p
->
physiÿl
.
»l_·th
);

2044 
size_t
 
i
, 
»maš
;

2045 
£p
 = 
cÚ
->
uri
.
·th
->
±r
;

2046 
£p2
 = 
p
->
uri
.
·th
->
±r
;

2047 
i
 = 0; 
£p
[i] && s•[i] =ğ
£p2
[i]; ++i) ;

2048 ià(
£p
[
i
] =ğ'\0' && (
£p2
[i] == '\0' || sep2[i] == '/' || (i > 0 && sep[i-1] == '/'))) {

2050 
cÚ
->
h‰p_¡©us
 = 403;

2051  
HANDLER_FINISHED
;

2053 
i
 !ğ0 && 
£p
[--i] != '/') ;

2054 
»maš
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
uri
.
·th
è- 
i
;

2055 ià(!
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames


2056 ? 
	`bufãr_is_equ®_right_Ën
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
»l_·th
, 
»maš
)

2057 :(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
physiÿl
.
·th
è>ğ
»maš


2058 && 0 =ğ
	`¡ºÿ£cmp
(
cÚ
->
physiÿl
.
·th
->
±r
+
	`bufãr_¡ršg_Ëngth
(cÚ->physiÿl.·th)-
»maš
, cÚ->physiÿl.
»l_·th
->±r+
i
,„emain))) {

2060 
	`bufãr_cİy_¡ršg_Ën
(
p
->
physiÿl
.
·th
, 
cÚ
->physiÿl.·th->
±r
, 
	`bufãr_¡ršg_Ëngth
(cÚ->physiÿl.·th)-
»maš
);

2061 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
physiÿl
.
·th
,…->physiÿl.
»l_·th
->
±r
+
i
, 
	`bufãr_¡ršg_Ëngth
(p->physical.rel_path)-i);

2063 
	`bufãr_cİy_bufãr
(
p
->
physiÿl
.
ba£dœ
, 
cÚ
->physical.basedir);

2064 
	`bufãr_­³nd_¦ash
(
p
->
physiÿl
.
ba£dœ
);

2068 
	`bufãr_cİy_bufãr
(
p
->
physiÿl
.
·th
,…->physiÿl.
doc_roÙ
);

2069 
	`bufãr_­³nd_¦ash
(
p
->
physiÿl
.
·th
);

2070 
	`bufãr_cİy_bufãr
(
p
->
physiÿl
.
ba£dœ
,…->physiÿl.
·th
);

2073 ià(
p
->
physiÿl
.
»l_·th
->
±r
[0] == '/') {

2074 
	`bufãr_­³nd_¡ršg_Ën
(
p
->
physiÿl
.
·th
,…->physiÿl.
»l_·th
->
±r
 + 1, 
	`bufãr_¡ršg_Ëngth
(p->physical.rel_path) - 1);

2076 
	`bufãr_­³nd_¡ršg_bufãr
(
p
->
physiÿl
.
·th
,…->physiÿl.
»l_·th
);

2084 ià(-1 =ğ
	`¡©
(
cÚ
->
physiÿl
.
·th
->
±r
, &
¡
)) {

2086 
”ºo
) {

2087 
ENOENT
:

2088 
cÚ
->
h‰p_¡©us
 = 404;

2091 
cÚ
->
h‰p_¡©us
 = 403;

2094 } ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

2095 
r
;

2096 
ü—‹d
 = 0;

2099 ià(
cÚ
->
physiÿl
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(con->physical.path)-1] != '/') {

2100 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
¤v
, 
cÚ
);

2101  
HANDLER_FINISHED
;

2104 ià(-1 =ğ
	`¡©
(
p
->
physiÿl
.
·th
->
±r
, &
¡
)) {

2105 ià(-1 =ğ
	`mkdœ
(
p
->
physiÿl
.
·th
->
±r
, 
WEBDAV_DIR_MODE
)) {

2106 
cÚ
->
h‰p_¡©us
 = 403;

2107  
HANDLER_FINISHED
;

2109 
ü—‹d
 = 1;

2110 } ià(!
	`S_ISDIR
(
¡
.
¡_mode
)) {

2111 ià(
ov”wr™e
 == 0) {

2113 
cÚ
->
h‰p_¡©us
 = 409;

2114  
HANDLER_FINISHED
;

2116 
	`uÆšk
(
p
->
physiÿl
.
·th
->
±r
);

2117 ià(-1 =ğ
	`mkdœ
(
p
->
physiÿl
.
·th
->
±r
, 
WEBDAV_DIR_MODE
)) {

2118 
cÚ
->
h‰p_¡©us
 = 403;

2119  
HANDLER_FINISHED
;

2121 
ü—‹d
 = 1;

2126 ià(0 !ğ(
r
 = 
	`webdav_cİy_dœ
(
¤v
, 
cÚ
, 
hùx
, &(cÚ->
physiÿl
), &(
p
->physiÿl), 
ov”wr™e
))) {

2127 
cÚ
->
h‰p_¡©us
 = 
r
;

2128  
HANDLER_FINISHED
;

2130 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_MOVE
) {

2131 
b
 = 
	`bufãr_š™
();

2132 
	`webdav_d–‘e_dœ
(
¤v
, 
cÚ
, 
hùx
, &(cÚ->
physiÿl
), 
b
);

2133 
	`bufãr_ä“
(
b
);

2135 
	`rmdœ
(
cÚ
->
physiÿl
.
·th
->
±r
);

2137 
cÚ
->
h‰p_¡©us
 = 
ü—‹d
 ? 201 : 204;

2138 
cÚ
->
fe_fšished
 = 1;

2141 
r
;

2142 
de¡dœ
 = 0;

2145 ià(!
	`webdav_has_lock
(
¤v
, 
cÚ
, 
hùx
, 
p
->
uri
.
·th
)) {

2146 
cÚ
->
h‰p_¡©us
 = 423;

2147  
HANDLER_FINISHED
;

2151 ià(0 =ğ(
r
 = 
	`¡©
(
p
->
physiÿl
.
·th
->
±r
, &
¡
))) {

2152 ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

2155 
de¡dœ
 = 1;

2157 ià(
NULL
 !ğ(
£p
 = 
	`¡¼chr
(
cÚ
->
physiÿl
.
·th
->
±r
, '/'))) {

2158 
	`bufãr_­³nd_¡ršg
(
p
->
physiÿl
.
·th
, 
£p
);

2159 
r
 = 
	`¡©
(
p
->
physiÿl
.
·th
->
±r
, &
¡
);

2164 ià(-1 =ğ
r
) {

2165 
cÚ
->
h‰p_¡©us
 = 
de¡dœ
 ? 204 : 201;

2166 
cÚ
->
fe_fšished
 = 1;

2168 
”ºo
) {

2169 
ENOTDIR
:

2170 
cÚ
->
h‰p_¡©us
 = 409;

2171  
HANDLER_FINISHED
;

2173 } ià(
ov”wr™e
 == 0) {

2175 
cÚ
->
h‰p_¡©us
 = 412;

2176  
HANDLER_FINISHED
;

2178 
cÚ
->
h‰p_¡©us
 = 204;

2181 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_MOVE
) {

2184 ià(0 =ğ
	`»Çme
(
cÚ
->
physiÿl
.
·th
->
±r
, 
p
->physical.path->ptr)) {

2185 #ifdeà
USE_PROPPATCH


2186 
sql™e3_¡mt
 *
¡mt
;

2188 
¡mt
 = 
p
->
cÚf
.
¡mt_move_uri
;

2189 ià(
¡mt
) {

2191 
	`sql™e3_»£t
(
¡mt
);

2194 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

2195 
	`CONST_BUF_LEN
(
p
->
uri
.
·th
),

2196 
SQLITE_TRANSIENT
);

2198 
	`sql™e3_bšd_‹xt
(
¡mt
, 2,

2199 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
),

2200 
SQLITE_TRANSIENT
);

2202 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

2203 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sql-movçed:", 
	`sql™e3_”rmsg
(
p
->
cÚf
.
sql
));

2207  
HANDLER_FINISHED
;

2213 ià(0 !ğ(
r
 = 
	`webdav_cİy_fe
(
¤v
, 
cÚ
, 
hùx
, &(cÚ->
physiÿl
), &(
p
->physiÿl), 
ov”wr™e
))) {

2214 
cÚ
->
h‰p_¡©us
 = 
r
;

2216  
HANDLER_FINISHED
;

2219 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_MOVE
) {

2220 
b
 = 
	`bufãr_š™
();

2221 
	`webdav_d–‘e_fe
(
¤v
, 
cÚ
, 
hùx
, &(cÚ->
physiÿl
), 
b
);

2222 
	`bufãr_ä“
(
b
);

2226  
HANDLER_FINISHED
;

2228 
HTTP_METHOD_PROPPATCH
:

2229 ià(
p
->
cÚf
.
is_»adÚly
) {

2230 
cÚ
->
h‰p_¡©us
 = 403;

2231  
HANDLER_FINISHED
;

2234 ià(!
	`webdav_has_lock
(
¤v
, 
cÚ
, 
hùx
, cÚ->
uri
.
·th
)) {

2235 
cÚ
->
h‰p_¡©us
 = 423;

2236  
HANDLER_FINISHED
;

2240 ià(-1 =ğ
	`¡©
(
cÚ
->
physiÿl
.
·th
->
±r
, &
¡
)) {

2241 
”ºo
) {

2242 
ENOENT
:

2243 
cÚ
->
h‰p_¡©us
 = 404;

2248 ià(
	`S_ISDIR
(
¡
.
¡_mode
è&& 
cÚ
->
physiÿl
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(con->physical.path)-1] != '/') {

2249 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
¤v
, 
cÚ
);

2250  
HANDLER_FINISHED
;

2253 #ifdeà
USE_PROPPATCH


2254 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

2255 
xmlDocPŒ
 
xml
;

2257 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST
) {

2258 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

2259 ià(
r
 !ğ
HANDLER_GO_ON
) „;

2262 ià(1 =ğ
	`webdav_·r£_chunkqueue
(
¤v
, 
cÚ
, 
hùx
, cÚ->
»que¡_cÚ‹Á_queue
, &
xml
)) {

2263 
xmlNode
 *
roÙnode
 = 
	`xmlDocG‘RoÙEËm’t
(
xml
);

2265 ià(0 =ğ
	`xmlSŒcmp
(
roÙnode
->
Çme
, 
BAD_CAST
 "propertyupdate")) {

2266 
xmlNode
 *
cmd
;

2267 *
”r
 = 
NULL
;

2268 
em±y_ns
 = 0;

2272 ià(
SQLITE_OK
 !ğ
	`sql™e3_exec
(
p
->
cÚf
.
sql
, "BEGIN TRANSACTION", 
NULL
, NULL, &
”r
)) {

2273 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ÿn'ˆİ’¿n§ùiÚ:", 
”r
);

2274 
	`sql™e3_ä“
(
”r
);

2276 
´İm©ch_ş—nup
;

2280 
cmd
 = 
roÙnode
->
chd»n
; cmd; cmd = cmd->
Ãxt
) {

2281 
xmlNode
 *
´İs
;

2284 ià((0 =ğ
	`xmlSŒcmp
(
cmd
->
Çme
, 
BAD_CAST
 "set")) ||

2285 (0 =ğ
	`xmlSŒcmp
(
cmd
->
Çme
, 
BAD_CAST
 "remove"))) {

2287 
sql™e3_¡mt
 *
¡mt
;

2289 
¡mt
 = (0 =ğ
	`xmlSŒcmp
(
cmd
->
Çme
, 
BAD_CAST
 "remove")) ?

2290 
p
->
cÚf
.
¡mt_d–‘e_´İ
 :…->cÚf.
¡mt_upd©e_´İ
;

2292 
´İs
 = 
cmd
->
chd»n
;…rİs;…rİ ğ´İs->
Ãxt
) {

2293 ià(0 =ğ
	`xmlSŒcmp
(
´İs
->
Çme
, 
BAD_CAST
 "prop")) {

2294 
xmlNode
 *
´İ
;

2295 *
´İv®
 = 
NULL
;

2296 
r
;

2298 
´İ
 = 
´İs
->
chd»n
;

2300 ià(
´İ
->
ns
 &&

2301 (0 =ğ
	`xmlSŒcmp
(
´İ
->
ns
->
h»f
, 
BAD_CAST
 "")) &&

2302 (0 !ğ
	`xmlSŒcmp
(
´İ
->
ns
->
´efix
, 
BAD_CAST
 ""))) {

2303 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2305 
´İ
->
Çme
);

2307 
em±y_ns
 = 1;

2311 
	`sql™e3_»£t
(
¡mt
);

2315 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

2316 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
),

2317 
SQLITE_TRANSIENT
);

2318 
	`sql™e3_bšd_‹xt
(
¡mt
, 2,

2319 (*)
´İ
->
Çme
,

2320 
	`¡¾’
((*)
´İ
->
Çme
),

2321 
SQLITE_TRANSIENT
);

2322 ià(
´İ
->
ns
) {

2323 
	`sql™e3_bšd_‹xt
(
¡mt
, 3,

2324 (*)
´İ
->
ns
->
h»f
,

2325 
	`¡¾’
((*)
´İ
->
ns
->
h»f
),

2326 
SQLITE_TRANSIENT
);

2328 
	`sql™e3_bšd_‹xt
(
¡mt
, 3,

2331 
SQLITE_TRANSIENT
);

2333 ià(
¡mt
 =ğ
p
->
cÚf
.
¡mt_upd©e_´İ
) {

2334 
´İv®
 = 
´İ
->
chd»n


2335 ? (*)
	`xmlNodeLi¡G‘SŒšg
(
xml
, 
´İ
->
chd»n
, 0)

2336 : 
NULL
;

2338 
	`sql™e3_bšd_‹xt
(
¡mt
, 4,

2339 
´İv®
 ?…ropval : "",

2340 
´İv®
 ? 
	`¡¾’
(propval) : 0,

2341 
SQLITE_TRANSIENT
);

2344 ià(
SQLITE_DONE
 !ğ(
r
 = 
	`sql™e3_¡•
(
¡mt
))) {

2345 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2346 "sql-£ˆçed:", 
	`sql™e3_”rmsg
(
p
->
cÚf
.
sql
));

2349 ià(
´İv®
è
	`xmlF»e
(propval);

2352 ià(
em±y_ns
) ;

2356 ià(
em±y_ns
) {

2357 ià(
SQLITE_OK
 !ğ
	`sql™e3_exec
(
p
->
cÚf
.
sql
, "ROLLBACK", 
NULL
, NULL, &
”r
)) {

2358 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ÿn'ˆrŞlback¿n§ùiÚ:", 
”r
);

2359 
	`sql™e3_ä“
(
”r
);

2361 
´İm©ch_ş—nup
;

2364 
cÚ
->
h‰p_¡©us
 = 400;

2366 ià(
SQLITE_OK
 !ğ
	`sql™e3_exec
(
p
->
cÚf
.
sql
, "COMMIT", 
NULL
, NULL, &
”r
)) {

2367 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ÿn'ˆcomm™¿n§ùiÚ:", 
”r
);

2368 
	`sql™e3_ä“
(
”r
);

2370 
´İm©ch_ş—nup
;

2372 
cÚ
->
h‰p_¡©us
 = 200;

2374 
cÚ
->
fe_fšished
 = 1;

2376 
	`xmlF»eDoc
(
xml
);

2377  
HANDLER_FINISHED
;

2380 
´İm©ch_ş—nup
:

2382 
	`xmlF»eDoc
(
xml
);

2384 
cÚ
->
h‰p_¡©us
 = 400;

2385  
HANDLER_FINISHED
;

2389 
cÚ
->
h‰p_¡©us
 = 501;

2390  
HANDLER_FINISHED
;

2391 
HTTP_METHOD_LOCK
:

2415 ià(
d•th
 != 0 && depth != -1) {

2416 
cÚ
->
h‰p_¡©us
 = 400;

2418  
HANDLER_FINISHED
;

2421 #ifdeà
USE_LOCKS


2422 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
) {

2423 
xmlDocPŒ
 
xml
;

2424 
bufãr
 *
hdr_if
 = 
NULL
;

2425 
ü—‹d
 = 0;

2427 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_READ_POST
) {

2428 
hªdËr_t
 
r
 = 
	`cÚÃùiÚ_hªdË_»ad_po¡_¡©e
(
¤v
, 
cÚ
);

2429 ià(
r
 !ğ
HANDLER_GO_ON
) „;

2432 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "If"))) {

2433 
hdr_if
 = 
ds
->
v®ue
;

2436 ià(0 !ğ
	`¡©
(
cÚ
->
physiÿl
.
·th
->
±r
, &
¡
)) {

2437 ià(
”ºo
 =ğ
ENOENT
) {

2438 
fd
 = 
	`İ’
(
cÚ
->
physiÿl
.
·th
->
±r
, 
O_WRONLY
|
O_CREAT
|
O_APPEND
|
O_BINARY
|
FIFO_NONBLOCK
, 
WEBDAV_FILE_MODE
);

2439 ià(
fd
 >= 0) {

2440 
	`şo£
(
fd
);

2441 
ü—‹d
 = 1;

2443 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sBss",

2444 "ü—‹ fe", 
cÚ
->
physiÿl
.
·th
, ":", 
	`¡»¼Ü
(
”ºo
));

2445 
cÚ
->
h‰p_¡©us
 = 403;

2447  
HANDLER_FINISHED
;

2450 } ià(
hdr_if
 =ğ
NULL
 && 
d•th
 == -1) {

2452 ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

2453 
cÚ
->
h‰p_¡©us
 = 409;

2455  
HANDLER_FINISHED
;

2459 ià(1 =ğ
	`webdav_·r£_chunkqueue
(
¤v
, 
cÚ
, 
hùx
, cÚ->
»que¡_cÚ‹Á_queue
, &
xml
)) {

2460 
xmlNode
 *
roÙnode
 = 
	`xmlDocG‘RoÙEËm’t
(
xml
);

2462 
	`fÜû_as£¹
(
roÙnode
);

2464 ià(0 =ğ
	`xmlSŒcmp
(
roÙnode
->
Çme
, 
BAD_CAST
 "lockinfo")) {

2465 
xmlNode
 *
lockšfo
;

2466 cÚ¡ 
xmlCh¬
 *
lockscİe
 = 
NULL
, *
lockty³
 = NULL;

2468 
lockšfo
 = 
roÙnode
->
chd»n
;†ockšfo;†ockšfØğlockšfo->
Ãxt
) {

2469 ià(0 =ğ
	`xmlSŒcmp
(
lockšfo
->
Çme
, 
BAD_CAST
 "lockscope")) {

2470 
xmlNode
 *
v®ue
;

2471 
v®ue
 = 
lockšfo
->
chd»n
; v®ue; v®uğv®ue->
Ãxt
) {

2472 ià((0 =ğ
	`xmlSŒcmp
(
v®ue
->
Çme
, 
BAD_CAST
 "exclusive")) ||

2473 (0 =ğ
	`xmlSŒcmp
(
v®ue
->
Çme
, 
BAD_CAST
 "shared"))) {

2474 
lockscİe
 = 
v®ue
->
Çme
;

2476 
cÚ
->
h‰p_¡©us
 = 400;

2478 
	`xmlF»eDoc
(
xml
);

2479  
HANDLER_FINISHED
;

2482 } ià(0 =ğ
	`xmlSŒcmp
(
lockšfo
->
Çme
, 
BAD_CAST
 "locktype")) {

2483 
xmlNode
 *
v®ue
;

2484 
v®ue
 = 
lockšfo
->
chd»n
; v®ue; v®uğv®ue->
Ãxt
) {

2485 ià((0 =ğ
	`xmlSŒcmp
(
v®ue
->
Çme
, 
BAD_CAST
 "write"))) {

2486 
lockty³
 = 
v®ue
->
Çme
;

2488 
cÚ
->
h‰p_¡©us
 = 400;

2490 
	`xmlF»eDoc
(
xml
);

2491  
HANDLER_FINISHED
;

2495 } ià(0 =ğ
	`xmlSŒcmp
(
lockšfo
->
Çme
, 
BAD_CAST
 "owner")) {

2499 ià(
lockscİe
 && 
lockty³
) {

2500 
sql™e3_¡mt
 *
¡mt
 = 
p
->
cÚf
.
¡mt_»ad_lock_by_uri
;

2508 ià(
¡mt
) {

2510 
	`sql™e3_»£t
(
¡mt
);

2512 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

2513 
	`CONST_BUF_LEN
(
p
->
uri
.
·th
),

2514 
SQLITE_TRANSIENT
);

2517 
SQLITE_ROW
 =ğ
	`sql™e3_¡•
(
¡mt
)) {

2521 *
sql_lockscİe
 = (*)
	`sql™e3_cŞumn_‹xt
(
¡mt
, 2);

2523 ià(
	`¡rcmp
(
sql_lockscİe
, "exclusive")) {

2524 
cÚ
->
h‰p_¡©us
 = 423;

2525 } ià(0 =ğ
	`xmlSŒcmp
(
lockscİe
, 
BAD_CAST
 "exclusive")) {

2528 
cÚ
->
h‰p_¡©us
 = 423;

2531 ià(
cÚ
->
h‰p_¡©us
 == 423) {

2532 
	`xmlF»eDoc
(
xml
);

2533  
HANDLER_FINISHED
;

2537 
¡mt
 = 
p
->
cÚf
.
¡mt_ü—‹_lock
;

2538 ià(
¡mt
) {

2540 
uuid_t
 
id
;

2541 
uuid
[37] ;

2543 
	`uuid_g’”©e
(
id
);

2544 
	`uuid_uÅ¬£
(
id
, 
uuid
);

2546 
	`bufãr_cİy_¡ršg_Ën
(
p
->
tmp_buf
, 
	`CONST_STR_LEN
("opaquelocktoken:"));

2547 
	`bufãr_­³nd_¡ršg
(
p
->
tmp_buf
, 
uuid
);

2558 
	`sql™e3_»£t
(
¡mt
);

2560 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

2561 
	`CONST_BUF_LEN
(
p
->
tmp_buf
),

2562 
SQLITE_TRANSIENT
);

2564 
	`sql™e3_bšd_‹xt
(
¡mt
, 2,

2565 
	`CONST_BUF_LEN
(
cÚ
->
uri
.
·th
),

2566 
SQLITE_TRANSIENT
);

2568 
	`sql™e3_bšd_‹xt
(
¡mt
, 3,

2569 (cÚ¡ *)
lockscİe
,

2570 
	`xmlSŒËn
(
lockscİe
),

2571 
SQLITE_TRANSIENT
);

2573 
	`sql™e3_bšd_‹xt
(
¡mt
, 4,

2574 (cÚ¡ *)
lockty³
,

2575 
	`xmlSŒËn
(
lockty³
),

2576 
SQLITE_TRANSIENT
);

2579 
	`sql™e3_bšd_‹xt
(
¡mt
, 5,

2582 
SQLITE_TRANSIENT
);

2585 
	`sql™e3_bšd_št
(
¡mt
, 6,

2586 
d•th
);

2589 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

2590 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2591 "ü—‹†ock:", 
	`sql™e3_”rmsg
(
p
->
cÚf
.
sql
));

2595 
	`webdav_lockdiscov”y
(
¤v
, 
cÚ
, 
p
->
tmp_buf
, (cÚ¡ *)
lockscİe
, (cÚ¡ *)
lockty³
, 
d•th
);

2597 
cÚ
->
h‰p_¡©us
 = 
ü—‹d
 ? 201 : 200;

2598 
cÚ
->
fe_fšished
 = 1;

2603 
	`xmlF»eDoc
(
xml
);

2604  
HANDLER_FINISHED
;

2606 
cÚ
->
h‰p_¡©us
 = 400;

2607  
HANDLER_FINISHED
;

2611 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "If"))) {

2612 
bufãr
 *
locktok’
 = 
ds
->
v®ue
;

2613 
sql™e3_¡mt
 *
¡mt
 = 
p
->
cÚf
.
¡mt_»äesh_lock
;

2616 ià(
	`bufãr_¡ršg_Ëngth
(
locktok’
) < 5) {

2617 
cÚ
->
h‰p_¡©us
 = 400;

2619  
HANDLER_FINISHED
;

2622 
	`bufãr_cİy_¡ršg_Ën
(
p
->
tmp_buf
, 
locktok’
->
±r
 + 2, 
	`bufãr_¡ršg_Ëngth
(locktoken) - 4);

2624 
	`sql™e3_»£t
(
¡mt
);

2626 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

2627 
	`CONST_BUF_LEN
(
p
->
tmp_buf
),

2628 
SQLITE_TRANSIENT
);

2630 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

2631 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2632 "»äesh†ock:", 
	`sql™e3_”rmsg
(
p
->
cÚf
.
sql
));

2635 
	`webdav_lockdiscov”y
(
¤v
, 
cÚ
, 
p
->
tmp_buf
, "exclusive", "write", 0);

2637 
cÚ
->
h‰p_¡©us
 = 200;

2638 
cÚ
->
fe_fšished
 = 1;

2639  
HANDLER_FINISHED
;

2642 
cÚ
->
h‰p_¡©us
 = 400;

2644  
HANDLER_FINISHED
;

2649 
cÚ
->
h‰p_¡©us
 = 501;

2650  
HANDLER_FINISHED
;

2652 
HTTP_METHOD_UNLOCK
:

2653 #ifdeà
USE_LOCKS


2654 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Lock-Token"))) {

2655 
bufãr
 *
locktok’
 = 
ds
->
v®ue
;

2656 
sql™e3_¡mt
 *
¡mt
 = 
p
->
cÚf
.
¡mt_»move_lock
;

2659 ià(
	`bufãr_¡ršg_Ëngth
(
locktok’
) < 3) {

2660 
cÚ
->
h‰p_¡©us
 = 400;

2662  
HANDLER_FINISHED
;

2675 
	`bufãr_cİy_¡ršg_Ën
(
p
->
tmp_buf
, 
locktok’
->
±r
 + 1, 
	`bufãr_¡ršg_Ëngth
(locktoken) - 2);

2677 
	`sql™e3_»£t
(
¡mt
);

2679 
	`sql™e3_bšd_‹xt
(
¡mt
, 1,

2680 
	`CONST_BUF_LEN
(
p
->
tmp_buf
),

2681 
SQLITE_TRANSIENT
);

2683 ià(
SQLITE_DONE
 !ğ
	`sql™e3_¡•
(
¡mt
)) {

2684 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

2685 "»movlock:", 
	`sql™e3_”rmsg
(
p
->
cÚf
.
sql
));

2688 ià(0 =ğ
	`sql™e3_chªges
(
p
->
cÚf
.
sql
)) {

2689 
cÚ
->
h‰p_¡©us
 = 401;

2691 
cÚ
->
h‰p_¡©us
 = 204;

2693  
HANDLER_FINISHED
;

2696 
cÚ
->
h‰p_¡©us
 = 400;

2698  
HANDLER_FINISHED
;

2702 
cÚ
->
h‰p_¡©us
 = 501;

2703  
HANDLER_FINISHED
;

2710  
HANDLER_GO_ON
;

2711 
	}
}

2714 
	$SUBREQUEST_FUNC
(
mod_webdav_sub»que¡_hªdËr
) {

2715 
hªdËr_t
 
r
;

2716 
¶ugš_d©a
 *
p
 = 
p_d
;

2717 ià(
cÚ
->
mode
 !ğ
p
->
id
è 
HANDLER_GO_ON
;

2719 
r
 = 
	`mod_webdav_sub»que¡_hªdËr_huge
(
¤v
, 
cÚ
, 
p_d
);

2720 ià(
cÚ
->
h‰p_¡©us
 >ğ400ècÚ->
mode
 = 
DIRECT
;

2721  
r
;

2722 
	}
}

2725 
	$PHYSICALPATH_FUNC
(
mod_webdav_physiÿl_hªdËr
) {

2726 
¶ugš_d©a
 *
p
 = 
p_d
;

2727 ià(!
p
->
cÚf
.
’abËd
è 
HANDLER_GO_ON
;

2730 ià(
	`bufãr_is_em±y
(
cÚ
->
physiÿl
.
·th
)è 
HANDLER_GO_ON
;

2732 
	`UNUSED
(
¤v
);

2734 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

2735 
HTTP_METHOD_PROPFIND
:

2736 
HTTP_METHOD_PROPPATCH
:

2737 
HTTP_METHOD_PUT
:

2738 
HTTP_METHOD_COPY
:

2739 
HTTP_METHOD_MOVE
:

2740 
HTTP_METHOD_MKCOL
:

2741 
HTTP_METHOD_DELETE
:

2742 
HTTP_METHOD_LOCK
:

2743 
HTTP_METHOD_UNLOCK
: {

2744 
hªdËr_ùx
 *
hùx
 = 
	`ÿÎoc
(1, (*hctx));

2745 
	`memıy
(&
hùx
->
cÚf
, &
p
->cÚf, (
¶ugš_cÚfig
));

2746 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
hùx
;

2747 
cÚ
->
cÚf
.
¡»am_»que¡_body
 = 0;

2748 
cÚ
->
mode
 = 
p
->
id
;

2755  
HANDLER_GO_ON
;

2756 
	}
}

2758 
hªdËr_t
 
	$mod_webdav_cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
) {

2759 
¶ugš_d©a
 *
p
 = 
p_d
;

2760 
hªdËr_ùx
 *
hùx
 = 
cÚ
->
¶ugš_ùx
[
p
->
id
];

2761 ià(
hùx
) {

2762 
	`ä“
(
hùx
);

2763 
cÚ
->
¶ugš_ùx
[
p
->
id
] = 
NULL
;

2766 
	`UNUSED
(
¤v
);

2767  
HANDLER_GO_ON
;

2768 
	}
}

2773 
mod_webdav_¶ugš_š™
(
¶ugš
 *
p
);

2774 
	$mod_webdav_¶ugš_š™
(
¶ugš
 *
p
) {

2775 
p
->
v”siÚ
 = 
LIGHTTPD_VERSION_ID
;

2776 
p
->
Çme
 = 
	`bufãr_š™_¡ršg
("webdav");

2778 
p
->
š™
 = 
mod_webdav_š™
;

2779 
p
->
hªdË_uri_ş—n
 = 
mod_webdav_uri_hªdËr
;

2780 
p
->
hªdË_physiÿl
 = 
mod_webdav_physiÿl_hªdËr
;

2781 
p
->
hªdË_sub»que¡
 = 
mod_webdav_sub»que¡_hªdËr
;

2782 
p
->
cÚÃùiÚ_»£t
 = 
mod_webdav_cÚÃùiÚ_»£t
;

2783 
p
->
£t_deçuÉs
 = 
mod_webdav_£t_deçuÉs
;

2784 
p
->
ş—nup
 = 
mod_webdav_ä“
;

2786 
p
->
d©a
 = 
NULL
;

2789 
	}
}

	@network.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk.h
"

4 
	~"fdev’t.h
"

5 
	~"log.h
"

6 
	~"cÚÃùiÚs.h
"

7 
	~"¶ugš.h
"

8 
	~"jobli¡.h
"

9 
	~"cÚfigfe.h
"

11 
	~"ÃtwÜk_back’ds.h
"

12 
	~"sys-mm­.h
"

13 
	~"sys-sock‘.h
"

15 
	~<sys/ty³s.h
>

16 
	~<sys/¡©.h
>

17 
	~<sys/time.h
>

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<uni¡d.h
>

22 
	~<¡ršg.h
>

23 
	~<¡dlib.h
>

24 
	~<as£¹.h
>

26 #ifdeà
USE_OPENSSL


27 
	~<İ’s¦/s¦.h
>

28 
	~<İ’s¦/”r.h
>

29 
	~<İ’s¦/¿nd.h
>

30 #iâdeà
OPENSSL_NO_DH


31 
	~<İ’s¦/dh.h
>

33 
	~<İ’s¦/bn.h
>

35 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

36 #iâdeà
OPENSSL_NO_ECDH


37 
	~<İ’s¦/ecdh.h
>

42 #ifdeà
USE_OPENSSL


43 
	$s¦_šfo_ÿÎback
(cÚ¡ 
SSL
 *
s¦
, 
wh”e
, 
»t
) {

44 
	`UNUSED
(
»t
);

46 ià(0 !ğ(
wh”e
 & 
SSL_CB_HANDSHAKE_START
)) {

47 
cÚÃùiÚ
 *
cÚ
 = 
	`SSL_g‘_­p_d©a
(
s¦
);

48 ++
cÚ
->
»ÃgÙŸtiÚs
;

50 
	}
}

54 
	$ÃtwÜk_acû±_tı_ÇgË_di§bË
 (cÚ¡ 
fd
)

56 
nošh”™_tınod–ay
 = -1;

57 
İt
;

59 ià(!
nošh”™_tınod–ay
)

62 ià(
nošh”™_tınod–ay
 < 0) {

63 
sockËn_t
 
İ’
 = (
İt
);

64 ià(0 =ğ
	`g‘sockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
İt
, &
İ’
)) {

65 
nošh”™_tınod–ay
 = !
İt
;

66 ià(
İt
)

71 
İt
 = 1;

72 ()
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
İt
, (opt));

73 
	}
}

75 
hªdËr_t
 
	$ÃtwÜk_£rv”_hªdË_fdev’t
(
£rv”
 *
¤v
, *
cÚ‹xt
, 
»v’ts
) {

76 
£rv”_sock‘
 *
¤v_sock‘
 = (£rv”_sock‘ *)
cÚ‹xt
;

77 
cÚÃùiÚ
 *
cÚ
;

78 
loİs
 = 0;

80 
	`UNUSED
(
cÚ‹xt
);

82 ià(0 =ğ(
»v’ts
 & 
FDEVENT_IN
)) {

83 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd",

85 
¤v_sock‘
->
fd
,

86 
»v’ts
);

87  
HANDLER_ERROR
;

93 
loİs
 = 0;†oİ < 100 && 
NULL
 !ğ(
cÚ
 = 
	`cÚÃùiÚ_acû±
(
¤v
, 
¤v_sock‘
));†oops++) {

94 
	`cÚÃùiÚ_¡©e_machše
(
¤v
, 
cÚ
);

96  
HANDLER_GO_ON
;

97 
	}
}

99 #ià
defšed
 
USE_OPENSSL
 && ! defšed 
OPENSSL_NO_TLSEXT


100 
	$ÃtwÜk_s¦_£rv”Çme_ÿÎback
(
SSL
 *
s¦
, *
®
, 
£rv”
 *
¤v
) {

101 cÚ¡ *
£rv”Çme
;

102 
cÚÃùiÚ
 *
cÚ
 = (cÚÃùiÚ *è
	`SSL_g‘_­p_d©a
(
s¦
);

103 
	`UNUSED
(
®
);

105 
	`bufãr_cİy_¡ršg
(
cÚ
->
uri
.
scheme
, "https");

107 ià(
NULL
 =ğ(
£rv”Çme
 = 
	`SSL_g‘_£rv”Çme
(
s¦
, 
TLSEXT_NAMETYPE_ho¡_Çme
))) {

110 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

113  
SSL_TLSEXT_ERR_NOACK
;

115 
	`bufãr_cİy_¡ršg
(
cÚ
->
£xt_£rv”_Çme
, 
£rv”Çme
);

116 
	`bufãr_to_low”
(
cÚ
->
£xt_£rv”_Çme
);

119 
	`bufãr_»£t
(
cÚ
->
uri
.
authÜ™y
);

121 
	`cÚfig_cÚd_ÿche_»£t
(
¤v
, 
cÚ
);

122 
	`cÚfig_£tup_cÚÃùiÚ
(
¤v
, 
cÚ
);

124 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_SERVER_SOCKET
] = 1;

125 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_REMOTE_IP
] = 1;

126 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_SCHEME
] = 1;

127 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_HOST
] = 1;

128 
	`cÚfig_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
);

130 ià(
NULL
 =ğ
cÚ
->
cÚf
.
s¦_³mfe_x509
 || NULL =ğcÚ->cÚf.
s¦_³mfe_pkey
) {

132 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "SSL:",

133 "nØû¹ifiÿ‹/´iv©key fÜ TLS s”v”‚ame", 
cÚ
->
£xt_£rv”_Çme
);

134  
SSL_TLSEXT_ERR_ALERT_FATAL
;

138 ià(!
	`SSL_u£_û¹ifiÿ‹
(
s¦
, 
cÚ
->
cÚf
.
s¦_³mfe_x509
)) {

139 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb:s", "SSL:",

140 "çedØ£ˆû¹ifiÿ‹ fÜ TLS s”v”‚ame", 
cÚ
->
£xt_£rv”_Çme
,

141 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

142  
SSL_TLSEXT_ERR_ALERT_FATAL
;

145 ià(!
	`SSL_u£_Priv©eKey
(
s¦
, 
cÚ
->
cÚf
.
s¦_³mfe_pkey
)) {

146 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb:s", "SSL:",

147 "çedØ£ˆ´iv©key fÜ TLS s”v”‚ame", 
cÚ
->
£xt_£rv”_Çme
,

148 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

149  
SSL_TLSEXT_ERR_ALERT_FATAL
;

152 ià(
cÚ
->
cÚf
.
s¦_v”ifyş›Á
) {

153 ià(
NULL
 =ğ
cÚ
->
cÚf
.
s¦_ÿ_fe_û¹_Çmes
) {

154 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb:s", "SSL:",

155 "ÿn'ˆv”ify cl›Á w™houˆs¦.ÿ-ffÜ TLS s”v”‚ame", 
cÚ
->
£xt_£rv”_Çme
,

156 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

157  
SSL_TLSEXT_ERR_ALERT_FATAL
;

160 
	`SSL_£t_ş›Á_CA_li¡
(
s¦
, 
	`SSL_dup_CA_li¡
(
cÚ
->
cÚf
.
s¦_ÿ_fe_û¹_Çmes
));

162 
	`SSL_£t_v”ify
(

163 
s¦
,

164 
SSL_VERIFY_PEER
 | (
cÚ
->
cÚf
.
s¦_v”ifyş›Á_’fÜû
 ? 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
 : 0),

165 
NULL


167 
	`SSL_£t_v”ify_d•th
(
s¦
, 
cÚ
->
cÚf
.
s¦_v”ifyş›Á_d•th
);

169 
	`SSL_£t_v”ify
(
s¦
, 
SSL_VERIFY_NONE
, 
NULL
);

172  
SSL_TLSEXT_ERR_OK
;

173 
	}
}

176 
	$ÃtwÜk_£rv”_š™
(
£rv”
 *
¤v
, 
bufãr
 *
ho¡_tok’
, 
¥ecific_cÚfig
 *
s
) {

177 
v®
;

178 
sockËn_t
 
addr_Ën
;

179 
£rv”_sock‘
 *
¤v_sock‘
;

180 
pÜt
 = 0;

181 cÚ¡ *
ho¡
;

182 
bufãr
 *
b
;

183 
”r
;

185 #ifdeà
__WIN32


186 
WORD
 
wV”siÚReque¡ed
;

187 
WSADATA
 
w§D©a
;

189 
wV”siÚReque¡ed
 = 
	`MAKEWORD
( 2, 2 );

191 
”r
 = 
	`WSAS¹up
Ğ
wV”siÚReque¡ed
, &
w§D©a
 );

192 iàĞ
”r
 != 0 ) {

198 
”r
 = -1;

200 
¤v_sock‘
 = 
	`ÿÎoc
(1, (*srv_socket));

201 
	`fÜû_as£¹
(
NULL
 !ğ
¤v_sock‘
);

202 
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
 = 
AF_INET
;

203 
¤v_sock‘
->
fd
 = -1;

204 
¤v_sock‘
->
fde_ndx
 = -1;

206 
¤v_sock‘
->
¤v_tok’
 = 
	`bufãr_š™
();

207 
	`bufãr_cİy_bufãr
(
¤v_sock‘
->
¤v_tok’
, 
ho¡_tok’
);

209 
b
 = 
	`bufãr_š™
();

210 
	`bufãr_cİy_bufãr
(
b
, 
ho¡_tok’
);

212 
ho¡
 = 
b
->
±r
;

214 ià(
ho¡
[0] == '/') {

216 #ifdeà
HAVE_SYS_UN_H


217 
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
 = 
AF_UNIX
;

219 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

221 
”rÜ_ä“_sock‘
;

227 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

228 *
¥
 = 
NULL
;

229 ià(0 =ğ
Ën
) {

230 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "value of $SERVER[\"socket\"] must‚ot beƒmpty");

231 
”rÜ_ä“_sock‘
;

233 ià((
b
->
±r
[0] =ğ'[' && b->±r[
Ën
-1] =ğ']'è|| 
NULL
 =ğ(
¥
 = 
	`¡¼chr
(b->ptr, ':'))) {

235 
pÜt
 = 
¤v
->
¤vcÚf
.port;

236 
¥
 = 
b
->
±r
 + 
Ën
;

239 *
¥
 = '\0';

240 
pÜt
 = 
	`¡¹Ş
(
¥
+1, 
NULL
, 10);

244 ià(
b
->
±r
[0] =ğ'[' && *(
¥
-1) == ']') {

245 *(
¥
-1) = '\0';

246 
ho¡
++;

248 
s
->
u£_v6
 = 1;

251 ià(
pÜt
 == 0 ||…ort > 65535) {

252 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "pÜˆnÙ s‘ o¸ouˆoà¿nge:", 
pÜt
);

254 
”rÜ_ä“_sock‘
;

258 ià(*
ho¡
 =ğ'\0'èho¡ = 
NULL
;

260 #ifdeà
HAVE_IPV6


261 ià(
s
->
u£_v6
) {

262 
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
 = 
AF_INET6
;

266 
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
) {

267 #ifdeà
HAVE_IPV6


268 
AF_INET6
:

269 
	`mem£t
(&
¤v_sock‘
->
addr
, 0, (
sockaddr_š6
));

270 
¤v_sock‘
->
addr
.
v6
.
sš6_çmy
 = 
AF_INET6
;

271 ià(
ho¡
 =ğ
NULL
) {

272 
¤v_sock‘
->
addr
.
v6
.
sš6_addr
 = 
š6addr_ªy
;

273 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "warning:…lease use server.use-ipv6 only for hostnames,‚ot without server.bind /ƒmpty‡ddress; your config will break ifhe kernel default for IPV6_V6ONLY changes");

275 
addršfo
 
hšts
, *
»s
;

276 
r
;

278 
	`mem£t
(&
hšts
, 0, (hints));

280 
hšts
.
ai_çmy
 = 
AF_INET6
;

281 
hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

282 
hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

284 ià(0 !ğ(
r
 = 
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
»s
))) {

285 
hšts
.
ai_çmy
 = 
AF_INET
;

287 #ifdeà
EAI_ADDRFAMILY


288 
EAI_ADDRFAMILY
 =ğ
r
 &&

290 0 =ğ
	`g‘addršfo
(
ho¡
, 
NULL
, &
hšts
, &
»s
)) {

291 
	`memıy
(&
¤v_sock‘
->
addr
.
v4
, 
»s
->
ai_addr
,„es->
ai_add¾’
);

292 
¤v_sock‘
->
addr
.
v4
.
sš_çmy
 = 
AF_INET
;

293 
¤v_sock‘
->
addr
.
v4
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

294 
addr_Ën
 = (
sockaddr_š
);

296 
	`ä“addršfo
(
»s
);

300 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

302 
	`gai_¡»¼Ü
(
r
), "'", 
ho¡
, "'");

304 
”rÜ_ä“_sock‘
;

307 
	`memıy
(&(
¤v_sock‘
->
addr
), 
»s
->
ai_addr
,„es->
ai_add¾’
);

309 
	`ä“addršfo
(
»s
);

311 
¤v_sock‘
->
addr
.
v6
.
sš6_pÜt
 = 
	`htÚs
(
pÜt
);

312 
addr_Ën
 = (
sockaddr_š6
);

315 
AF_INET
:

316 
	`mem£t
(&
¤v_sock‘
->
addr
, 0, (
sockaddr_š
));

317 
¤v_sock‘
->
addr
.
v4
.
sš_çmy
 = 
AF_INET
;

318 ià(
ho¡
 =ğ
NULL
) {

319 
¤v_sock‘
->
addr
.
v4
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

321 
ho¡’t
 *
he
;

322 ià(
NULL
 =ğ(
he
 = 
	`g‘ho¡byÇme
(
ho¡
))) {

323 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

325 
h_”ºo
, 
ho¡
);

326 
”rÜ_ä“_sock‘
;

329 ià(
he
->
h_add¹y³
 !ğ
AF_INET
) {

330 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "addr-ty³ !ğAF_INET: ", 
he
->
h_add¹y³
);

331 
”rÜ_ä“_sock‘
;

334 ià(
he
->
h_Ëngth
 !ğ(
š_addr
)) {

335 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "addr-Ëngth !ğsizeof(š_addr): ", 
he
->
h_Ëngth
);

336 
”rÜ_ä“_sock‘
;

339 
	`memıy
(&(
¤v_sock‘
->
addr
.
v4
.
sš_addr
.
s_addr
), 
he
->
h_addr_li¡
[0], he->
h_Ëngth
);

341 
¤v_sock‘
->
addr
.
v4
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

342 
addr_Ën
 = (
sockaddr_š
);

344 #ifdeà
HAVE_SYS_UN_H


345 
AF_UNIX
:

346 
	`mem£t
(&
¤v_sock‘
->
addr
, 0, (
sockaddr_un
));

347 
¤v_sock‘
->
addr
.
un
.
sun_çmy
 = 
AF_UNIX
;

349 
size_t
 
ho¡Ën
 = 
	`¡¾’
(
ho¡
) + 1;

350 ià(
ho¡Ën
 > (
¤v_sock‘
->
addr
.
un
.
sun_·th
)) {

351 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sS", "unix sock‘ f’amtoØlÚg:", 
ho¡
);

352 
”rÜ_ä“_sock‘
;

354 
	`memıy
(
¤v_sock‘
->
addr
.
un
.
sun_·th
, 
ho¡
, 
ho¡Ën
);

356 #ià
	`defšed
(
SUN_LEN
)

357 
addr_Ën
 = 
	`SUN_LEN
(&
¤v_sock‘
->
addr
.
un
);

360 
addr_Ën
 = 
ho¡Ën
 + (
¤v_sock‘
->
addr
.
un
.
sun_çmy
);

367 
”rÜ_ä“_sock‘
;

370 ià(
¤v
->
¤vcÚf
.
´eæight_check
) {

371 
”r
 = 0;

372 
”rÜ_ä“_sock‘
;

375 ià(
¤v
->
sock‘s_di§bËd
) {

376 #ifdeà
USE_OPENSSL


377 ià(
s
->
s¦_’abËd
è
¤v_sock‘
->
s¦_ùx
 = s->ssl_ctx;

379 
¤v_sock‘s_­³nd
;

382 #ifdeà
HAVE_SYS_UN_H


383 ià(
AF_UNIX
 =ğ
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
) {

385 
	`fÜû_as£¹
(
ho¡
);

386 ià(-1 =ğ(
¤v_sock‘
->
fd
 = 
	`fdev’t_sock‘_şÛxec
(¤v_sock‘->
addr
.
¶aš
.
§_çmy
, 
SOCK_STREAM
, 0))) {

387 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘ faed:", 
	`¡»¼Ü
(
”ºo
));

388 
”rÜ_ä“_sock‘
;

390 ià(0 =ğ
	`cÚÃù
(
¤v_sock‘
->
fd
, (
sockaddr
 *è&(¤v_sock‘->
addr
), 
addr_Ën
)) {

391 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

393 
ho¡
);

396 
”rÜ_ä“_sock‘
;

400 
”ºo
) {

401 
ECONNREFUSED
:

402 
	`uÆšk
(
ho¡
);

404 
ENOENT
:

407 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

409 
ho¡
, 
	`¡»¼Ü
(
”ºo
));

411 
”rÜ_ä“_sock‘
;

414 
	`fdev’t_fú_£t_nb
(
¤v
->
ev
, 
¤v_sock‘
->
fd
);

418 ià(-1 =ğ(
¤v_sock‘
->
fd
 = 
	`fdev’t_sock‘_nb_şÛxec
(¤v_sock‘->
addr
.
¶aš
.
§_çmy
, 
SOCK_STREAM
, 
IPPROTO_TCP
))) {

419 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘ faed:", 
	`¡»¼Ü
(
”ºo
));

420 
”rÜ_ä“_sock‘
;

423 #ifdeà
HAVE_IPV6


424 ià(
AF_INET6
 =ğ
¤v_sock‘
->
addr
.
¶aš
.
§_çmy


425 && 
ho¡
 !ğ
NULL
) {

426 ià(
s
->
£t_v6Úly
) {

427 
v®
 = 1;

428 ià(-1 =ğ
	`£tsockİt
(
¤v_sock‘
->
fd
, 
IPPROTO_IPV6
, 
IPV6_V6ONLY
, &
v®
, (val))) {

429 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘sockİt(IPV6_V6ONLYèçed:", 
	`¡»¼Ü
(
”ºo
));

430 
”rÜ_ä“_sock‘
;

433 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "warning: server.set-v6only will be„emoved soon, update your configo have different sockets for ipv4‡nd ipv6");

440 
¤v
->
cur_fds
 = 
¤v_sock‘
->
fd
;

442 
v®
 = 1;

443 ià(
	`£tsockİt
(
¤v_sock‘
->
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
v®
, (val)) < 0) {

444 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘sockİt(SO_REUSEADDRèçed:", 
	`¡»¼Ü
(
”ºo
));

445 
”rÜ_ä“_sock‘
;

448 ià(
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
 !ğ
AF_UNIX
) {

449 
v®
 = 1;

450 ià(
	`£tsockİt
(
¤v_sock‘
->
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, &
v®
, (val)) < 0) {

451 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "sock‘sockİt(TCP_NODELAYèçed:", 
	`¡»¼Ü
(
”ºo
));

452 
”rÜ_ä“_sock‘
;

456 ià(0 !ğ
	`bšd
(
¤v_sock‘
->
fd
, (
sockaddr
 *è&(¤v_sock‘->
addr
), 
addr_Ën
)) {

457 
¤v_sock‘
->
addr
.
¶aš
.
§_çmy
) {

458 
AF_UNIX
:

459 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

461 
ho¡
, 
	`¡»¼Ü
(
”ºo
));

464 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssds",

466 
ho¡
, 
pÜt
, 
	`¡»¼Ü
(
”ºo
));

469 
”rÜ_ä“_sock‘
;

472 ià(-1 =ğ
	`li¡’
(
¤v_sock‘
->
fd
, 
s
->
li¡’_backlog
)) {

473 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "li¡’ faed: ", 
	`¡»¼Ü
(
”ºo
));

474 
”rÜ_ä“_sock‘
;

477 ià(
s
->
s¦_’abËd
) {

478 #ifdeà
USE_OPENSSL


479 ià(
NULL
 =ğ(
¤v_sock‘
->
s¦_ùx
 = 
s
->ssl_ctx)) {

480 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "ssl.pemfile haso be set");

481 
”rÜ_ä“_sock‘
;

485 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

488 
”rÜ_ä“_sock‘
;

490 #ifdeà
TCP_DEFER_ACCEPT


491 } ià(
s
->
deãr_acû±
) {

492 
v
 = 
s
->
deãr_acû±
;

493 ià(-1 =ğ
	`£tsockİt
(
¤v_sock‘
->
fd
, 
IPPROTO_TCP
, 
TCP_DEFER_ACCEPT
, &
v
, (v))) {

494 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "ÿn'ˆ£ˆTCP_DEFER_ACCEPT: ", 
	`¡»¼Ü
(
”ºo
));

497 #ià
	`defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
) \

498 || 
	`defšed
(
__O³nBSD__
è|| defšed(
__D¿gÚFly__
)

499 } ià(!
	`bufãr_is_em±y
(
s
->
bsd_acû±_f‹r
)

500 && (
	`bufãr_is_equ®_¡ršg
(
s
->
bsd_acû±_f‹r
, 
	`CONST_STR_LEN
("httpready"))

501 || 
	`bufãr_is_equ®_¡ršg
(
s
->
bsd_acû±_f‹r
, 
	`CONST_STR_LEN
("dataready")))) {

502 #ifdeà
SO_ACCEPTFILTER


504 
acû±_f‹r_¬g
 
aç
;

505 
	`mem£t
(&
aç
, 0, (afa));

506 
	`¡ºıy
(
aç
.
af_Çme
, 
s
->
bsd_acû±_f‹r
->
±r
, (afa.af_name));

507 ià(
	`£tsockİt
(
¤v_sock‘
->
fd
, 
SOL_SOCKET
, 
SO_ACCEPTFILTER
, &
aç
, (afa)) < 0) {

508 ià(
”ºo
 !ğ
ENOENT
) {

509 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SBss", "ÿn'ˆ£ˆacû±-f‹¸'", 
s
->
bsd_acû±_f‹r
, "':", 
	`¡»¼Ü
(
”ºo
));

516 
¤v_sock‘s_­³nd
:

517 
¤v_sock‘
->
is_s¦
 = 
s
->
s¦_’abËd
;

519 ià(
¤v
->
¤v_sock‘s
.
size
 == 0) {

520 
¤v
->
¤v_sock‘s
.
size
 = 4;

521 
¤v
->
¤v_sock‘s
.
u£d
 = 0;

522 
¤v
->
¤v_sock‘s
.
±r
 = 
	`m®loc
(¤v->¤v_sock‘s.
size
 * (
£rv”_sock‘
*));

523 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
¤v_sock‘s
.
±r
);

524 } ià(
¤v
->
¤v_sock‘s
.
u£d
 =ğ¤v->¤v_sock‘s.
size
) {

525 
¤v
->
¤v_sock‘s
.
size
 += 4;

526 
¤v
->
¤v_sock‘s
.
±r
 = 
	`»®loc
(¤v->¤v_sock‘s.±r, srv->¤v_sock‘s.
size
 * (
£rv”_sock‘
*));

527 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
¤v_sock‘s
.
±r
);

530 
¤v
->
¤v_sock‘s
.
±r
[¤v->¤v_sock‘s.
u£d
++] = 
¤v_sock‘
;

532 
	`bufãr_ä“
(
b
);

536 
”rÜ_ä“_sock‘
:

537 ià(
¤v_sock‘
->
fd
 != -1) {

539 ià(
¤v_sock‘
->
fde_ndx
 != -1) {

540 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
¤v_sock‘
->
fde_ndx
), srv_sock‘->
fd
);

541 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
¤v_sock‘
->
fd
);

544 
	`şo£
(
¤v_sock‘
->
fd
);

546 
	`bufãr_ä“
(
¤v_sock‘
->
¤v_tok’
);

547 
	`ä“
(
¤v_sock‘
);

549 
	`bufãr_ä“
(
b
);

551  
”r
;

552 
	}
}

554 
	$ÃtwÜk_şo£
(
£rv”
 *
¤v
) {

555 
size_t
 
i
;

556 
i
 = 0; i < 
¤v
->
¤v_sock‘s
.
u£d
; i++) {

557 
£rv”_sock‘
 *
¤v_sock‘
 = 
¤v
->
¤v_sock‘s
.
±r
[
i
];

559 ià(
¤v_sock‘
->
fd
 != -1) {

561 ià(
¤v_sock‘
->
fde_ndx
 != -1) {

562 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
¤v_sock‘
->
fde_ndx
), srv_sock‘->
fd
);

563 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
¤v_sock‘
->
fd
);

566 
	`şo£
(
¤v_sock‘
->
fd
);

569 
	`bufãr_ä“
(
¤v_sock‘
->
¤v_tok’
);

571 
	`ä“
(
¤v_sock‘
);

574 
	`ä“
(
¤v
->
¤v_sock‘s
.
±r
);

577 
	}
}

580 
	mNETWORK_BACKEND_UNSET
,

581 
	mNETWORK_BACKEND_WRITE
,

582 
	mNETWORK_BACKEND_WRITEV
,

583 
	mNETWORK_BACKEND_SENDFILE
,

584 } 
	tÃtwÜk_back’d_t
;

586 #ifdeà
USE_OPENSSL


587 
X509
* 
	$x509_lßd_³m_fe
(
£rv”
 *
¤v
, cÚ¡ *
fe
) {

588 
BIO
 *
š
;

589 
X509
 *
x
 = 
NULL
;

591 
š
 = 
	`BIO_Ãw
(
	`BIO_s_fe
());

592 ià(
NULL
 =ğ
š
) {

593 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "S", "SSL: BIO_new(BIO_s_file()) failed");

594 
”rÜ
;

597 ià(
	`BIO_»ad_f’ame
(
š
,
fe
) <= 0) {

598 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSS", "SSL: BIO_»ad_f’ame('", 
fe
,"') failed");

599 
”rÜ
;

601 
x
 = 
	`PEM_»ad_bio_X509
(
š
, 
NULL
, NULL, NULL);

603 ià(
NULL
 =ğ
x
) {

604 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSS", "SSL: couldn'ˆ»ad X509 c”tifiÿ‹ from '", 
fe
,"'");

605 
”rÜ
;

608 
	`BIO_ä“
(
š
);

609  
x
;

611 
”rÜ
:

612 ià(
NULL
 !ğ
š
è
	`BIO_ä“
(in);

613  
NULL
;

614 
	}
}

616 
EVP_PKEY
* 
	$evp_pkey_lßd_³m_fe
(
£rv”
 *
¤v
, cÚ¡ *
fe
) {

617 
BIO
 *
š
;

618 
EVP_PKEY
 *
x
 = 
NULL
;

620 
š
=
	`BIO_Ãw
(
	`BIO_s_fe
());

621 ià(
NULL
 =ğ
š
) {

622 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "SSL: BIO_new(BIO_s_file()) failed");

623 
”rÜ
;

626 ià(
	`BIO_»ad_f’ame
(
š
,
fe
) <= 0) {

627 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSS", "SSL: BIO_»ad_f’ame('", 
fe
,"') failed");

628 
”rÜ
;

630 
x
 = 
	`PEM_»ad_bio_Priv©eKey
(
š
, 
NULL
, NULL, NULL);

632 ià(
NULL
 =ğ
x
) {

633 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "SSS", "SSL: couldn'ˆ»ad…riv©key from '", 
fe
,"'");

634 
”rÜ
;

637 
	`BIO_ä“
(
š
);

638  
x
;

640 
”rÜ
:

641 ià(
NULL
 !ğ
š
è
	`BIO_ä“
(in);

642  
NULL
;

643 
	}
}

645 
	$ÃtwÜk_İ’s¦_lßd_³mfe
(
£rv”
 *
¤v
, 
size_t
 
ndx
) {

646 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[
ndx
];

648 #ifdeà
OPENSSL_NO_TLSEXT


650 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
ndx
];

651 ià((
ndx
 > 0 && (
COMP_SERVER_SOCKET
 !ğ
dc
->
comp
 || dc->
cÚd
 !ğ
CONFIG_COND_EQ
))

652 || !
s
->
s¦_’abËd
) {

653 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

660 ià(
NULL
 =ğ(
s
->
s¦_³mfe_x509
 = 
	`x509_lßd_³m_fe
(
¤v
, s->
s¦_³mfe
->
±r
)))  -1;

661 ià(
NULL
 =ğ(
s
->
s¦_³mfe_pkey
 = 
	`evp_pkey_lßd_³m_fe
(
¤v
, s->
s¦_³mfe
->
±r
)))  -1;

663 ià(!
	`X509_check_´iv©e_key
(
s
->
s¦_³mfe_x509
, s->
s¦_³mfe_pkey
)) {

664 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssb", "SSL:",

666 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
),

667 
s
->
s¦_³mfe
);

672 
	}
}

675 
	$ÃtwÜk_š™
(
£rv”
 *
¤v
) {

676 
bufãr
 *
b
;

677 
size_t
 
i
, 
j
;

678 
ÃtwÜk_back’d_t
 
back’d
;

680 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

681 #iâdeà
OPENSSL_NO_ECDH


682 
EC_KEY
 *
ecdh
;

683 
nid
;

687 #ifdeà
USE_OPENSSL


688 #iâdeà
OPENSSL_NO_DH


689 
DH
 *
dh
;

691 
BIO
 *
bio
;

704 cÚ¡ 
dh1024_p
[]={

718 cÚ¡ 
dh1024_g
[]={

733 
	snb_m­
 {

734 
ÃtwÜk_back’d_t
 
nb
;

735 cÚ¡ *
Çme
;

736 } 
ÃtwÜk_back’ds
[] = {

738 #ià
defšed
 
USE_SENDFILE


739 { 
NETWORK_BACKEND_SENDFILE
, "sendfile" },

741 #ià
defšed
 
USE_LINUX_SENDFILE


742 { 
NETWORK_BACKEND_SENDFILE
, "linux-sendfile" },

744 #ià
defšed
 
USE_FREEBSD_SENDFILE


745 { 
NETWORK_BACKEND_SENDFILE
, "freebsd-sendfile" },

747 #ià
defšed
 
USE_SOLARIS_SENDFILEV


748 { 
NETWORK_BACKEND_SENDFILE
, "solaris-sendfilev" },

750 #ià
defšed
 
USE_WRITEV


751 { 
NETWORK_BACKEND_WRITEV
, "writev" },

753 { 
NETWORK_BACKEND_WRITE
, "write" },

754 { 
NETWORK_BACKEND_UNSET
, 
NULL
 }

757 #ifdeà
USE_OPENSSL


759 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

760 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[
i
];

761 #iâdeà
SSL_OP_NO_COMPRESSION


762 
	#SSL_OP_NO_COMPRESSION
 0

	)

764 #iâdeà
SSL_MODE_RELEASE_BUFFERS


765 
	#SSL_MODE_RELEASE_BUFFERS
 0

	)

767 
s¦İtiÚs
 =

768 
SSL_OP_ALL
 | 
SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION
 | 
SSL_OP_NO_COMPRESSION
;

770 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_³mfe
è&& bufãr_¡ršg_is_em±y(s->
s¦_ÿ_fe
)) ;

772 ià(
¤v
->
s¦_is_š™
 == 0) {

773 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10100000L \

774 && !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

775 
	`OPENSSL_š™_s¦
(
OPENSSL_INIT_LOAD_SSL_STRINGS


776 |
OPENSSL_INIT_LOAD_CRYPTO_STRINGS
,
NULL
);

777 
	`OPENSSL_š™_üy±o
(
OPENSSL_INIT_ADD_ALL_CIPHERS


778 |
OPENSSL_INIT_ADD_ALL_DIGESTS


779 |
OPENSSL_INIT_LOAD_CONFIG
, 
NULL
);

781 
	`SSL_lßd_”rÜ_¡ršgs
();

782 
	`SSL_lib¿ry_š™
();

783 
	`O³nSSL_add_®l_®gÜ™hms
();

785 
¤v
->
s¦_is_š™
 = 1;

787 ià(0 =ğ
	`RAND_¡©us
()) {

788 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

794 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_³mfe
)) {

795 #ifdeà
OPENSSL_NO_TLSEXT


796 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

797 ià(
COMP_HTTP_HOST
 =ğ
dc
->
comp
) {

798 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

803 ià(
	`ÃtwÜk_İ’s¦_lßd_³mfe
(
¤v
, 
i
))  -1;

807 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_ÿ_fe
)) {

808 
s
->
s¦_ÿ_fe_û¹_Çmes
 = 
	`SSL_lßd_ş›Á_CA_fe
(s->
s¦_ÿ_fe
->
±r
);

809 ià(
NULL
 =ğ
s
->
s¦_ÿ_fe_û¹_Çmes
) {

810 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "SSL:",

811 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
), 
s
->
s¦_ÿ_fe
);

815 ià(
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_³mfe
è|| !s->
s¦_’abËd
) ;

817 ià(
NULL
 =ğ(
s
->
s¦_ùx
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_£rv”_m‘hod
()))) {

818 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

819 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

824 ià(0 =ğ
	`SSL_CTX_£t_£ssiÚ_id_cÚ‹xt
(
s
->
s¦_ùx
, (cÚ¡ *è
	`CONST_STR_LEN
("lighttpd"))) {

825 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss:s", "SSL:",

827 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

831 ià(
s
->
s¦_em±y_äagm’ts
) {

832 #ifdeà
SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS


833 
s¦İtiÚs
 &ğ~
SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS
;

835 
s¦İtiÚs
 &= ~0x00000800L;

836 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "WARNING: SSL:",

841 
	`SSL_CTX_£t_İtiÚs
(
s
->
s¦_ùx
, 
s¦İtiÚs
);

842 
	`SSL_CTX_£t_šfo_ÿÎback
(
s
->
s¦_ùx
, 
s¦_šfo_ÿÎback
);

844 ià(!
s
->
s¦_u£_s¦v2
 && 0 !ğ
SSL_OP_NO_SSLv2
) {

846 ià((
SSL_OP_NO_SSLv2
 & 
	`SSL_CTX_£t_İtiÚs
(
s
->
s¦_ùx
, SSL_OP_NO_SSLv2)) != SSL_OP_NO_SSLv2) {

847 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

848 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

853 ià(!
s
->
s¦_u£_s¦v3
 && 0 !ğ
SSL_OP_NO_SSLv3
) {

855 ià((
SSL_OP_NO_SSLv3
 & 
	`SSL_CTX_£t_İtiÚs
(
s
->
s¦_ùx
, SSL_OP_NO_SSLv3)) != SSL_OP_NO_SSLv3) {

856 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

857 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

862 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_ch”_li¡
)) {

864 ià(
	`SSL_CTX_£t_ch”_li¡
(
s
->
s¦_ùx
, s->
s¦_ch”_li¡
->
±r
) != 1) {

865 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

866 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
));

870 ià(
s
->
s¦_hÚÜ_ch”_Üd”
) {

871 
	`SSL_CTX_£t_İtiÚs
(
s
->
s¦_ùx
, 
SSL_OP_CIPHER_SERVER_PREFERENCE
);

875 #iâdeà
OPENSSL_NO_DH


877 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_dh_fe
)) {

879 
bio
 = 
	`BIO_Ãw_fe
((*è
s
->
s¦_dh_fe
->
±r
, "r");

880 ià(
bio
 =ğ
NULL
) {

881 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL: UÇbËØİ’ fe", 
s
->
s¦_dh_fe
->
±r
);

884 
dh
 = 
	`PEM_»ad_bio_DH·¿ms
(
bio
, 
NULL
, NULL, NULL);

885 
	`BIO_ä“
(
bio
);

886 ià(
dh
 =ğ
NULL
) {

887 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL: PEM_»ad_bio_DH·¿m çed", 
s
->
s¦_dh_fe
->
±r
);

891 
BIGNUM
 *
dh_p
, *
dh_g
;

893 
dh
 = 
	`DH_Ãw
();

894 ià(
dh
 =ğ
NULL
) {

895 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "SSL: DH_new () failed");

898 
dh_p
 = 
	`BN_bš2bn
(
dh1024_p
,(dh1024_p), 
NULL
);

899 
dh_g
 = 
	`BN_bš2bn
(
dh1024_g
,(dh1024_g), 
NULL
);

900 ià((
dh_p
 =ğ
NULL
è|| (
dh_g
 == NULL)) {

901 
	`DH_ä“
(
dh
);

902 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "SSL: BN_bin2bn () failed");

905 #ià
OPENSSL_VERSION_NUMBER
 < 0x10100000L \

906 || 
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

907 
dh
->
p
 = 
dh_p
;

908 
dh
->
g
 = 
dh_g
;

909 
dh
->
Ëngth
 = 160;

911 
	`DH_£t0_pqg
(
dh
, 
dh_p
, 
NULL
, 
dh_g
);

912 
	`DH_£t_Ëngth
(
dh
, 160);

915 
	`SSL_CTX_£t_tmp_dh
(
s
->
s¦_ùx
,
dh
);

916 
	`SSL_CTX_£t_İtiÚs
(
s
->
s¦_ùx
,
SSL_OP_SINGLE_DH_USE
);

917 
	`DH_ä“
(
dh
);

919 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_dh_fe
)) {

920 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL: o³ns¦ comped w™houˆDH suµÜt, cª'ˆlßd…¬am‘” äom", 
s
->
s¦_dh_fe
->
±r
);

924 #ià
OPENSSL_VERSION_NUMBER
 >= 0x0090800fL

925 #iâdeà
OPENSSL_NO_ECDH


927 ià(!
	`bufãr_¡ršg_is_em±y
(
s
->
s¦_ec_curve
)) {

929 
nid
 = 
	`OBJ_¢2nid
((*è
s
->
s¦_ec_curve
->
±r
);

930 ià(
nid
 == 0) {

931 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL: UnknowÀcurvÇme", 
s
->
s¦_ec_curve
->
±r
);

936 
nid
 = 
	`OBJ_¢2nid
("prime256v1");

938 
ecdh
 = 
	`EC_KEY_Ãw_by_curve_Çme
(
nid
);

939 ià(
ecdh
 =ğ
NULL
) {

940 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL: UÇbËØü—‹ curve", 
s
->
s¦_ec_curve
->
±r
);

943 
	`SSL_CTX_£t_tmp_ecdh
(
s
->
s¦_ùx
,
ecdh
);

944 
	`SSL_CTX_£t_İtiÚs
(
s
->
s¦_ùx
,
SSL_OP_SINGLE_ECDH_USE
);

945 
	`EC_KEY_ä“
(
ecdh
);

950 
j
 = 0; j < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; j++) {

951 
¥ecific_cÚfig
 *
s1
 = 
¤v
->
cÚfig_¡Üage
[
j
];

953 ià(!
	`bufãr_¡ršg_is_em±y
(
s1
->
s¦_ÿ_fe
)) {

954 ià(1 !ğ
	`SSL_CTX_lßd_v”ify_loÿtiÚs
(
s
->
s¦_ùx
, 
s1
->
s¦_ÿ_fe
->
±r
, 
NULL
)) {

955 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "SSL:",

956 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
), 
s1
->
s¦_ÿ_fe
);

962 ià(
s
->
s¦_v”ifyş›Á
) {

963 ià(
NULL
 =ğ
s
->
s¦_ÿ_fe_û¹_Çmes
) {

964 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

969 
	`SSL_CTX_£t_ş›Á_CA_li¡
(
s
->
s¦_ùx
, 
	`SSL_dup_CA_li¡
(s->
s¦_ÿ_fe_û¹_Çmes
));

970 
	`SSL_CTX_£t_v”ify
(

971 
s
->
s¦_ùx
,

972 
SSL_VERIFY_PEER
 | (
s
->
s¦_v”ifyş›Á_’fÜû
 ? 
SSL_VERIFY_FAIL_IF_NO_PEER_CERT
 : 0),

973 
NULL


975 
	`SSL_CTX_£t_v”ify_d•th
(
s
->
s¦_ùx
, s->
s¦_v”ifyş›Á_d•th
);

978 ià(1 !ğ
	`SSL_CTX_u£_û¹ifiÿ‹
(
s
->
s¦_ùx
, s->
s¦_³mfe_x509
)) {

979 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "SSL:",

980 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
), 
s
->
s¦_³mfe
);

984 ià(1 !ğ
	`SSL_CTX_u£_Priv©eKey
(
s
->
s¦_ùx
, s->
s¦_³mfe_pkey
)) {

985 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "SSL:",

986 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
), 
s
->
s¦_³mfe
);

990 ià(
	`SSL_CTX_check_´iv©e_key
(
s
->
s¦_ùx
) != 1) {

991 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sssb", "SSL:",

993 
	`ERR_”rÜ_¡ršg
(
	`ERR_g‘_”rÜ
(), 
NULL
),

994 
s
->
s¦_³mfe
);

997 
	`SSL_CTX_£t_deçuÉ_»ad_ah—d
(
s
->
s¦_ùx
, s->
s¦_»ad_ah—d
);

998 
	`SSL_CTX_£t_mode
(
s
->
s¦_ùx
, 
	`SSL_CTX_g‘_mode
(s->ssl_ctx)

999 | 
SSL_MODE_ENABLE_PARTIAL_WRITE


1000 | 
SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER


1001 | 
SSL_MODE_RELEASE_BUFFERS
);

1003 #iâdeà
OPENSSL_NO_TLSEXT


1004 ià(!
	`SSL_CTX_£t_£xt_£rv”Çme_ÿÎback
(
s
->
s¦_ùx
, 
ÃtwÜk_s¦_£rv”Çme_ÿÎback
) ||

1005 !
	`SSL_CTX_£t_£xt_£rv”Çme_¬g
(
s
->
s¦_ùx
, 
¤v
)) {

1006 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "SSL:",

1014 
b
 = 
	`bufãr_š™
();

1016 
	`bufãr_cİy_bufãr
(
b
, 
¤v
->
¤vcÚf
.
bšdho¡
);

1017 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(":"));

1018 
	`bufãr_­³nd_št
(
b
, 
¤v
->
¤vcÚf
.
pÜt
);

1020 ià(0 !ğ
	`ÃtwÜk_£rv”_š™
(
¤v
, 
b
, srv->
cÚfig_¡Üage
[0])) {

1021 
	`bufãr_ä“
(
b
);

1024 
	`bufãr_ä“
(
b
);

1026 #ifdeà
USE_OPENSSL


1027 
¤v
->
ÃtwÜk_s¦_back’d_wr™e
 = 
ÃtwÜk_wr™e_chunkqueue_İ’s¦
;

1031 
back’d
 = 
ÃtwÜk_back’ds
[0].
nb
;

1034 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
ÃtwÜk_back’d
)) {

1035 
i
 = 0; 
ÃtwÜk_back’ds
[i].
Çme
; i++) {

1037 ià(
	`bufãr_is_equ®_¡ršg
(
¤v
->
¤vcÚf
.
ÃtwÜk_back’d
, 
ÃtwÜk_back’ds
[
i
].
Çme
, 
	`¡¾’
(network_backends[i].name))) {

1038 
back’d
 = 
ÃtwÜk_back’ds
[
i
].
nb
;

1042 ià(
NULL
 =ğ
ÃtwÜk_back’ds
[
i
].
Çme
) {

1045 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1047 
¤v
->
¤vcÚf
.
ÃtwÜk_back’d
);

1053 
back’d
) {

1054 
NETWORK_BACKEND_WRITE
:

1055 
¤v
->
ÃtwÜk_back’d_wr™e
 = 
ÃtwÜk_wr™e_chunkqueue_wr™e
;

1057 #ià
	`defšed
(
USE_WRITEV
)

1058 
NETWORK_BACKEND_WRITEV
:

1059 
¤v
->
ÃtwÜk_back’d_wr™e
 = 
ÃtwÜk_wr™e_chunkqueue_wr™ev
;

1062 #ià
	`defšed
(
USE_SENDFILE
)

1063 
NETWORK_BACKEND_SENDFILE
:

1064 
¤v
->
ÃtwÜk_back’d_wr™e
 = 
ÃtwÜk_wr™e_chunkqueue_£ndfe
;

1072 
i
 = 1; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1073 
d©a_cÚfig
 *
dc
 = (d©a_cÚfig *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
];

1074 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[
i
];

1077 ià(
COMP_SERVER_SOCKET
 !ğ
dc
->
comp
) ;

1079 ià(
dc
->
cÚd
 !ğ
CONFIG_COND_EQ
) ;

1083 
j
 = 0; j < 
¤v
->
¤v_sock‘s
.
u£d
; j++) {

1084 ià(
	`bufãr_is_equ®
(
¤v
->
¤v_sock‘s
.
±r
[
j
]->
¤v_tok’
, 
dc
->
¡ršg
)) {

1089 ià(
j
 =ğ
¤v
->
¤v_sock‘s
.
u£d
) {

1090 ià(0 !ğ
	`ÃtwÜk_£rv”_š™
(
¤v
, 
dc
->
¡ršg
, 
s
))  -1;

1095 
	}
}

1097 
	$ÃtwÜk_»gi¡”_fdev’ts
(
£rv”
 *
¤v
) {

1098 
size_t
 
i
;

1100 ià(-1 =ğ
	`fdev’t_»£t
(
¤v
->
ev
)) {

1104 ià(
¤v
->
sock‘s_di§bËd
)  0;

1107 
i
 = 0; i < 
¤v
->
¤v_sock‘s
.
u£d
; i++) {

1108 
£rv”_sock‘
 *
¤v_sock‘
 = 
¤v
->
¤v_sock‘s
.
±r
[
i
];

1110 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
¤v_sock‘
->
fd
, 
ÃtwÜk_£rv”_hªdË_fdev’t
, srv_socket);

1111 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
¤v_sock‘
->
fde_ndx
), srv_sock‘->
fd
, 
FDEVENT_IN
);

1114 
	}
}

1116 
	$ÃtwÜk_wr™e_chunkqueue
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
) {

1117 
»t
 = -1;

1118 
off_t
 
wr™‹n
 = 0;

1119 #ifdeà
TCP_CORK


1120 
cÜked
 = 0;

1122 
£rv”_sock‘
 *
¤v_sock‘
 = 
cÚ
->srv_socket;

1124 ià(
cÚ
->
cÚf
.
glob®_kby‹s_³r_£cÚd
) {

1125 
off_t
 
lim™
 = 
cÚ
->
cÚf
.
glob®_kby‹s_³r_£cÚd
 * 1024 - *(cÚ->cÚf.
glob®_by‹s_³r_£cÚd_út_±r
);

1126 ià(
lim™
 <= 0) {

1128 
cÚ
->
Œaffic_lim™_»ached
 = 1;

1132 ià(
max_by‹s
 > 
lim™
) max_bytes =†imit;

1136 ià(
cÚ
->
cÚf
.
kby‹s_³r_£cÚd
) {

1137 
off_t
 
lim™
 = 
cÚ
->
cÚf
.
kby‹s_³r_£cÚd
 * 1024 - cÚ->
by‹s_wr™‹n_cur_£cÚd
;

1138 ià(
lim™
 <= 0) {

1140 
cÚ
->
Œaffic_lim™_»ached
 = 1;

1144 ià(
max_by‹s
 > 
lim™
) max_bytes =†imit;

1148 
wr™‹n
 = 
cq
->
by‹s_out
;

1150 #ifdeà
TCP_CORK


1154 ià(
cq
->
fœ¡
 && cq->fœ¡->
Ãxt
) {

1155 
cÜked
 = 1;

1156 ()
	`£tsockİt
(
cÚ
->
fd
, 
IPPROTO_TCP
, 
TCP_CORK
, &
cÜked
, (corked));

1160 ià(
¤v_sock‘
->
is_s¦
) {

1161 #ifdeà
USE_OPENSSL


1162 
»t
 = 
¤v
->
	`ÃtwÜk_s¦_back’d_wr™e
(¤v, 
cÚ
, cÚ->
s¦
, 
cq
, 
max_by‹s
);

1165 
»t
 = 
¤v
->
	`ÃtwÜk_back’d_wr™e
(¤v, 
cÚ
, cÚ->
fd
, 
cq
, 
max_by‹s
);

1168 ià(
»t
 >= 0) {

1169 
	`chunkqueue_»move_fšished_chunks
(
cq
);

1170 
»t
 = 
	`chunkqueue_is_em±y
(
cq
) ? 0 : 1;

1173 #ifdeà
TCP_CORK


1174 ià(
cÜked
) {

1175 
cÜked
 = 0;

1176 ()
	`£tsockİt
(
cÚ
->
fd
, 
IPPROTO_TCP
, 
TCP_CORK
, &
cÜked
, (corked));

1180 
wr™‹n
 = 
cq
->
by‹s_out
 - written;

1181 
cÚ
->
by‹s_wr™‹n
 +ğ
wr™‹n
;

1182 
cÚ
->
by‹s_wr™‹n_cur_£cÚd
 +ğ
wr™‹n
;

1184 *(
cÚ
->
cÚf
.
glob®_by‹s_³r_£cÚd_út_±r
è+ğ
wr™‹n
;

1186  
»t
;

1187 
	}
}

	@network.h

1 #iâdeà
_NETWORK_H_


2 
	#_NETWORK_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£rv”.h
"

7 
ÃtwÜk_acû±_tı_ÇgË_di§bË
(
fd
);

9 
ÃtwÜk_wr™e_chunkqueue
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
chunkqueue
 *
c
, 
off_t
 
max_by‹s
);

11 
ÃtwÜk_š™
(
£rv”
 *
¤v
);

12 
ÃtwÜk_şo£
(
£rv”
 *
¤v
);

14 
ÃtwÜk_»gi¡”_fdev’ts
(
£rv”
 *
¤v
);

	@network_backends.h

1 #iâdeà
_NETWORK_BACKENDS_H_


2 
	#_NETWORK_BACKENDS_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£‰šgs.h
"

7 
	~<sys/ty³s.h
>

10 #ià
defšed
 
HAVE_SYS_SENDFILE_H
 && defšed 
HAVE_SENDFILE
 && (!defšed 
_LARGEFILE_SOURCE
 || defšed 
HAVE_SENDFILE64
è&& defšed(
__lšux__
è&& !defšed 
HAVE_SENDFILE_BROKEN


11 #ifdeà
USE_SENDFILE


14 
	#USE_SENDFILE
 "lšux-£ndfe"

	)

15 
	#USE_LINUX_SENDFILE


	)

18 #ià
defšed
 
HAVE_SENDFILE
 && (defšed(
__F»eBSD__
è|| defšed(
__D¿gÚFly__
))

19 #ifdeà
USE_SENDFILE


22 
	#USE_SENDFILE
 "ä“bsd-£ndfe"

	)

23 
	#USE_FREEBSD_SENDFILE


	)

26 #ià
defšed
 
HAVE_SENDFILE
 && defšed(
__APPLE__
)

27 #ifdeà
USE_SENDFILE


30 
	#USE_SENDFILE
 "d¬wš-£ndfe"

	)

31 
	#USE_DARWIN_SENDFILE


	)

34 #ià
defšed
 
HAVE_SYS_SENDFILE_H
 && defšed 
HAVE_SENDFILEV
 && defšed(
__sun
)

35 #ifdeà
USE_SENDFILE


38 
	#USE_SENDFILE
 "sŞ¬is-£ndfev"

	)

39 
	#USE_SOLARIS_SENDFILEV


	)

52 #ià
defšed
 
HAVE_SYS_UIO_H
 && defšed 
HAVE_WRITEV


53 
	#USE_WRITEV


	)

56 #ià
defšed
 
HAVE_SYS_MMAN_H
 && defšed 
HAVE_MMAP
 && defšed 
ENABLE_MMAP


57 
	#USE_MMAP


	)

60 
	~"ba£.h
"

68 
ÃtwÜk_wr™e_chunkqueue_wr™e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
);

70 #ià
defšed
(
USE_WRITEV
)

71 
ÃtwÜk_wr™e_chunkqueue_wr™ev
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
);

74 #ià
defšed
(
USE_SENDFILE
)

75 
ÃtwÜk_wr™e_chunkqueue_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
);

78 #ià
defšed
(
USE_OPENSSL
)

79 
ÃtwÜk_wr™e_chunkqueue_İ’s¦
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
SSL
 *
s¦
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
);

85 
ÃtwÜk_wr™e_mem_chunk
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
);

87 #ià
defšed
(
USE_WRITEV
)

89 
ÃtwÜk_wr™ev_mem_chunks
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
);

92 
šlše
 
	$ÃtwÜk_wr™ev_mem_chunks
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

93  
	`ÃtwÜk_wr™e_mem_chunk
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

94 
	}
}

98 
ÃtwÜk_wr™e_fe_chunk_no_mm­
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
);

100 
off_t
 
mm­_®ign_off£t
(off_ˆ
¡¬t
);

101 #ià
defšed
(
USE_MMAP
)

103 
ÃtwÜk_wr™e_fe_chunk_mm­
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
);

106 
šlše
 
	$ÃtwÜk_wr™e_fe_chunk_mm­
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

107  
	`ÃtwÜk_wr™e_fe_chunk_no_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

108 
	}
}

111 #ià
defšed
(
USE_SENDFILE
)

112 
ÃtwÜk_wr™e_fe_chunk_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
);

115 
šlše
 
	$ÃtwÜk_wr™e_fe_chunk_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

116  
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

117 
	}
}

121 
ÃtwÜk_İ’_fe_chunk
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
chunkqueue
 *
cq
);

	@network_darwin_sendfile.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 #ià
defšed
(
USE_DARWIN_SENDFILE
)

7 
	~"ÃtwÜk.h
"

8 
	~"log.h
"

10 
	~<sys/ty³s.h
>

11 
	~<sys/sock‘.h
>

12 
	~<sys/uio.h
>

14 
	~<”ºo.h
>

15 
	~<¡ršg.h
>

17 
	$ÃtwÜk_wr™e_fe_chunk_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

18 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

19 
off_t
 
off£t
, 
wr™‹n
 = 0;

20 
off_t
 
toS’d
;

21 
r
;

23 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

24 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

25 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

27 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

28 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

29 ià(
toS’d
 > *
p_max_by‹s
)oSend = *p_max_bytes;

31 ià(0 =ğ
toS’d
) {

32 
	`chunkqueue_»move_fšished_chunks
(
cq
);

36 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

39 
wr™‹n
 = 
toS’d
;

40 ià(-1 =ğ(
r
 = 
	`£ndfe
(
c
->
fe
.
fd
, fd, 
off£t
, &
wr™‹n
, 
NULL
, 0))) {

41 
”ºo
) {

42 
EAGAIN
:

43 
EINTR
:

46 
EPIPE
:

47 
ENOTCONN
:

49 
EINVAL
:

50 
ENOSYS
:

51 #ià
	`defšed
(
ENOTSUP
) \

52 && (!
	`defšed
(
EOPNOTSUPP
è|| EOPNOTSUPP !ğ
ENOTSUP
)

53 
ENOTSUP
:

55 #ifdeà
EOPNOTSUPP


56 
EOPNOTSUPP
:

58 #ifdeà
ESOCKTNOSUPPORT


59 
ESOCKTNOSUPPORT
:

61 #ifdeà
EAFNOSUPPORT


62 
EAFNOSUPPORT
:

64 #ifdeà
USE_MMAP


65  
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

67  
	`ÃtwÜk_wr™e_fe_chunk_no_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

70 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "£ndfe: ", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

75 ià(
wr™‹n
 >= 0) {

76 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
wr™‹n
);

77 *
p_max_by‹s
 -ğ
wr™‹n
;

80  (
r
 >ğ0 && 
wr™‹n
 =ğ
toS’d
) ? 0 : -3;

81 
	}
}

	@network_freebsd_sendfile.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 #ià
defšed
(
USE_FREEBSD_SENDFILE
)

7 
	~"ÃtwÜk.h
"

8 
	~"log.h
"

10 
	~<sys/ty³s.h
>

11 
	~<sys/sock‘.h
>

12 
	~<sys/uio.h
>

14 
	~<”ºo.h
>

15 
	~<¡ršg.h
>

17 
	$ÃtwÜk_wr™e_fe_chunk_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

18 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

19 
off_t
 
off£t
, 
wr™‹n
 = 0;

20 
off_t
 
toS’d
;

21 
r
;

23 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

24 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

25 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

27 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

28 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

29 ià(
toS’d
 > *
p_max_by‹s
)oSend = *p_max_bytes;

31 ià(0 =ğ
toS’d
) {

32 
	`chunkqueue_»move_fšished_chunks
(
cq
);

36 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

39 ià(-1 =ğ(
r
 = 
	`£ndfe
(
c
->
fe
.
fd
, fd, 
off£t
, 
toS’d
, 
NULL
, &
wr™‹n
, 0))) {

40 
”ºo
) {

41 
EAGAIN
:

42 
EINTR
:

45 
EPIPE
:

46 
ENOTCONN
:

48 
EINVAL
:

49 
ENOSYS
:

50 #ià
	`defšed
(
ENOTSUP
) \

51 && (!
	`defšed
(
EOPNOTSUPP
è|| EOPNOTSUPP !ğ
ENOTSUP
)

52 
ENOTSUP
:

54 #ifdeà
EOPNOTSUPP


55 
EOPNOTSUPP
:

57 #ifdeà
ESOCKTNOSUPPORT


58 
ESOCKTNOSUPPORT
:

60 #ifdeà
EAFNOSUPPORT


61 
EAFNOSUPPORT
:

63 #ifdeà
USE_MMAP


64  
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

66  
	`ÃtwÜk_wr™e_fe_chunk_no_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

69 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "£ndfe: ", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

74 ià(
wr™‹n
 >= 0) {

75 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
wr™‹n
);

76 *
p_max_by‹s
 -ğ
wr™‹n
;

79  (
r
 >ğ0 && 
wr™‹n
 =ğ
toS’d
) ? 0 : -3;

80 
	}
}

	@network_linux_sendfile.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 #ià
defšed
(
USE_LINUX_SENDFILE
)

7 
	~"ÃtwÜk.h
"

8 
	~"log.h
"

10 
	~<sys/£ndfe.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršg.h
>

15 
	$ÃtwÜk_wr™e_fe_chunk_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

16 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

17 
ssize_t
 
r
;

18 
off_t
 
off£t
;

19 
off_t
 
toS’d
;

21 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

22 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

23 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

25 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

26 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

27 ià(
toS’d
 > *
p_max_by‹s
)oSend = *p_max_bytes;

29 ià(0 =ğ
toS’d
) {

30 
	`chunkqueue_»move_fšished_chunks
(
cq
);

34 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

36 ià(-1 =ğ(
r
 = 
	`£ndfe
(
fd
, 
c
->
fe
.fd, &
off£t
, 
toS’d
))) {

37 
”ºo
) {

38 
EAGAIN
:

39 
EINTR
:

41 
EPIPE
:

42 
ECONNRESET
:

44 
EINVAL
:

45 
ENOSYS
:

46 #ià
	`defšed
(
ENOTSUP
) \

47 && (!
	`defšed
(
EOPNOTSUPP
è|| EOPNOTSUPP !ğ
ENOTSUP
)

48 
ENOTSUP
:

50 #ifdeà
EOPNOTSUPP


51 
EOPNOTSUPP
:

53 #ifdeà
ESOCKTNOSUPPORT


54 
ESOCKTNOSUPPORT
:

56 #ifdeà
EAFNOSUPPORT


57 
EAFNOSUPPORT
:

59 #ifdeà
USE_MMAP


60  
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

62  
	`ÃtwÜk_wr™e_fe_chunk_no_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

65 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

66 "£ndfçed:", 
	`¡»¼Ü
(
”ºo
), 
fd
);

71 ià(
r
 >= 0) {

72 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

73 *
p_max_by‹s
 -ğ
r
;

76  (
r
 > 0 &&„ =ğ
toS’d
) ? 0 : -3;

77 
	}
}

	@network_openssl.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 #ià
defšed
(
USE_OPENSSL
)

7 
	~"ÃtwÜk.h
"

8 
	~"log.h
"

10 
	~<uni¡d.h
>

11 
	~<¡dlib.h
>

13 
	~<”ºo.h
>

14 
	~<¡ršg.h
>

16 
	~<İ’s¦/s¦.h
>

17 
	~<İ’s¦/”r.h
>

19 
	$lßd_Ãxt_chunk
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
, cÚ¡ **
d©a
, 
size_t
 *
d©a_Ën
) {

20 
chunk
 * cÚ¡ 
c
 = 
cq
->
fœ¡
;

22 
	#LOCAL_SEND_BUFSIZE
 (64 * 1024)

	)

31 *
loÿl_£nd_bufãr
 = 
NULL
;

33 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

35 
c
->
ty³
) {

36 
MEM_CHUNK
:

38 
size_t
 
have
;

40 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğ(
off_t
)
	`bufãr_¡ršg_Ëngth
(c->
mem
));

42 
have
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

43 ià((
off_t
è
have
 > 
max_by‹s
) have = max_bytes;

45 *
d©a
 = 
c
->
mem
->
±r
 + c->
off£t
;

46 *
d©a_Ën
 = 
have
;

50 
FILE_CHUNK
:

51 ià(
NULL
 =ğ
loÿl_£nd_bufãr
) {

52 
loÿl_£nd_bufãr
 = 
	`m®loc
(
LOCAL_SEND_BUFSIZE
);

53 
	`fÜû_as£¹
(
NULL
 !ğ
loÿl_£nd_bufãr
);

56 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

59 
off_t
 
off£t
, 
toS’d
;

61 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

62 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

63 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

65 ià(
toS’d
 > 
LOCAL_SEND_BUFSIZE
)oSend = LOCAL_SEND_BUFSIZE;

66 ià(
toS’d
 > 
max_by‹s
)oSend = max_bytes;

68 ià(-1 =ğ
	`l£ek
(
c
->
fe
.
fd
, 
off£t
, 
SEEK_SET
)) {

69 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "l£ek: ", 
	`¡»¼Ü
(
”ºo
));

72 ià(-1 =ğ(
toS’d
 = 
	`»ad
(
c
->
fe
.
fd
, 
loÿl_£nd_bufãr
,oSend))) {

73 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "»ad: ", 
	`¡»¼Ü
(
”ºo
));

77 *
d©a
 = 
loÿl_£nd_bufãr
;

78 *
d©a_Ën
 = 
toS’d
;

84 
	}
}

87 
	$ÃtwÜk_wr™e_chunkqueue_İ’s¦
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
SSL
 *
s¦
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
) {

93 ià(
cÚ
->
k“p_®ive
 == 0) {

94 
	`SSL_£t_shutdown
(
s¦
, 
SSL_RECEIVED_SHUTDOWN
);

97 
	`chunkqueue_»move_fšished_chunks
(
cq
);

99 
max_by‹s
 > 0 && 
NULL
 !ğ
cq
->
fœ¡
) {

100 cÚ¡ *
d©a
;

101 
size_t
 
d©a_Ën
;

102 
r
;

104 ià(0 !ğ
	`lßd_Ãxt_chunk
(
¤v
, 
cÚ
, 
cq
, 
max_by‹s
, &
d©a
, &
d©a_Ën
))  -1;

115 
	`ERR_ş—r_”rÜ
();

116 
r
 = 
	`SSL_wr™e
(
s¦
, 
d©a
, 
d©a_Ën
);

118 ià(
cÚ
->
»ÃgÙŸtiÚs
 > 1 && cÚ->
cÚf
.
s¦_di§bË_ş›Á_»ÃgÙŸtiÚ
) {

119 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "SSL:„enegotiation initiated by client, killing connection");

123 ià(
r
 <= 0) {

124 
s¦_r
;

125 
”r
;

127 (
s¦_r
 = 
	`SSL_g‘_”rÜ
(
s¦
, 
r
))) {

128 
SSL_ERROR_WANT_READ
:

129 
cÚ
->
is_»adabË
 = -1;

131 
SSL_ERROR_WANT_WRITE
:

132 
cÚ
->
is_wr™abË
 = -1;

134 
SSL_ERROR_SYSCALL
:

136 ià(0 !ğ(
”r
 = 
	`ERR_g‘_”rÜ
())) {

138 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdds", "SSL:",

139 
s¦_r
, 
r
,

140 
	`ERR_”rÜ_¡ršg
(
”r
, 
NULL
));

141 } (
”r
 = 
	`ERR_g‘_”rÜ
()));

142 } ià(
r
 == -1) {

144 
”ºo
) {

145 
EPIPE
:

146 
ECONNRESET
:

149 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddds", "SSL:",

150 
s¦_r
, 
r
, 
”ºo
,

151 
	`¡»¼Ü
(
”ºo
));

156 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sddds", "SSL (error):",

157 
s¦_r
, 
r
, 
”ºo
,

158 
	`¡»¼Ü
(
”ºo
));

162 
SSL_ERROR_ZERO_RETURN
:

165 ià(
r
 == 0)  -2;

169 (
”r
 = 
	`ERR_g‘_”rÜ
())) {

170 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdds", "SSL:",

171 
s¦_r
, 
r
,

172 
	`ERR_”rÜ_¡ršg
(
”r
, 
NULL
));

179 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

180 
max_by‹s
 -ğ
r
;

182 ià((
size_t
è
r
 < 
d©a_Ën
) ;

186 
	}
}

	@network_solaris_sendfilev.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 #ià
defšed
(
USE_SOLARIS_SENDFILEV
)

7 
	~"ÃtwÜk.h
"

8 
	~"log.h
"

10 
	~<sys/£ndfe.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršg.h
>

20 
	$ÃtwÜk_wr™e_fe_chunk_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

21 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

22 
off_t
 
off£t
;

23 
off_t
 
toS’d
;

24 
size_t
 
wr™‹n
 = 0;

25 
r
;

26 
£ndfevec_t
 
fvec
;

28 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

29 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

30 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

32 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

33 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

34 ià(
toS’d
 > *
p_max_by‹s
)oSend = *p_max_bytes;

36 ià(0 =ğ
toS’d
) {

37 
	`chunkqueue_»move_fšished_chunks
(
cq
);

41 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

43 
fvec
.
sfv_fd
 = 
c
->
fe
.
fd
;

44 
fvec
.
sfv_æag
 = 0;

45 
fvec
.
sfv_off
 = 
off£t
;

46 
fvec
.
sfv_Ën
 = 
toS’d
;

50 ià(-1 =ğ(
r
 = 
	`£ndfev
(
fd
, &
fvec
, 1, &
wr™‹n
))) {

51 
”ºo
) {

52 
EAGAIN
:

53 
EINTR
:

56 
EPIPE
:

57 
ENOTCONN
:

59 
EINVAL
:

60 
ENOSYS
:

61 #ià
	`defšed
(
ENOTSUP
) \

62 && (!
	`defšed
(
EOPNOTSUPP
è|| EOPNOTSUPP !ğ
ENOTSUP
)

63 
ENOTSUP
:

65 #ifdeà
EOPNOTSUPP


66 
EOPNOTSUPP
:

68 #ifdeà
ESOCKTNOSUPPORT


69 
ESOCKTNOSUPPORT
:

71 #ifdeà
EAFNOSUPPORT


72 
EAFNOSUPPORT
:

74 #ifdeà
USE_MMAP


75  
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

77  
	`ÃtwÜk_wr™e_fe_chunk_no_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, 
p_max_by‹s
);

80 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd", "£ndfe: ", 
	`¡»¼Ü
(
”ºo
),ƒrrno);

85 ià(
wr™‹n
 >= 0) {

86 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
wr™‹n
);

87 *
p_max_by‹s
 -ğ
wr™‹n
;

90  (
r
 >ğ0 && (
off_t
è
wr™‹n
 =ğ
toS’d
) ? 0 : -3;

91 
	}
}

	@network_write.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 
	~"ÃtwÜk.h
"

6 
	~"log.h
"

8 
	~"sys-sock‘.h
"

10 
	~<uni¡d.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršg.h
>

15 
	$ÃtwÜk_wr™e_mem_chunk
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

16 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

17 
off_t
 
c_Ën
;

18 
ssize_t
 
r
;

19 
	`UNUSED
(
cÚ
);

21 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

22 
	`fÜû_as£¹
(
MEM_CHUNK
 =ğ
c
->
ty³
);

23 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğ(
off_t
)
	`bufãr_¡ršg_Ëngth
(c->
mem
));

25 
c_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

26 ià(
c_Ën
 > *
p_max_by‹s
) c_len = *p_max_bytes;

28 ià(0 =ğ
c_Ën
) {

29 
	`chunkqueue_»move_fšished_chunks
(
cq
);

33 #ià
	`defšed
(
__WIN32
)

34 ià((
r
 = 
	`£nd
(
fd
, 
c
->
mem
->
±r
 + c->
off£t
, 
c_Ën
, 0)) < 0) {

35 
Ï¡E¼Ü
 = 
	`WSAG‘La¡E¼Ü
();

36 
Ï¡E¼Ü
) {

37 
WSAEINTR
:

38 
WSAEWOULDBLOCK
:

40 
WSAECONNRESET
:

41 
WSAETIMEDOUT
:

42 
WSAECONNABORTED
:

45 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd",

46 "£nd faed: ", 
Ï¡E¼Ü
, 
fd
);

51 ià((
r
 = 
	`wr™e
(
fd
, 
c
->
mem
->
±r
 + c->
off£t
, 
c_Ën
)) < 0) {

52 
”ºo
) {

53 
EAGAIN
:

54 
EINTR
:

56 
EPIPE
:

57 
ECONNRESET
:

60 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

61 "wr™çed:", 
	`¡»¼Ü
(
”ºo
), 
fd
);

67 ià(
r
 >= 0) {

68 *
p_max_by‹s
 -ğ
r
;

69 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

72  (
r
 > 0 &&„ =ğ
c_Ën
) ? 0 : -3;

73 
	}
}

75 
	$ÃtwÜk_wr™e_chunkqueue_wr™e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
) {

76 
max_by‹s
 > 0 && 
NULL
 !ğ
cq
->
fœ¡
) {

77 
r
 = -1;

79 
cq
->
fœ¡
->
ty³
) {

80 
MEM_CHUNK
:

81 
r
 = 
	`ÃtwÜk_wr™e_mem_chunk
(
¤v
, 
cÚ
, 
fd
, 
cq
, &
max_by‹s
);

83 
FILE_CHUNK
:

84 
r
 = 
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, &
max_by‹s
);

88 ià(-3 =ğ
r
)  0;

89 ià(0 !ğ
r
) „;

93 
	}
}

95 #ià
defšed
(
USE_SENDFILE
)

96 
	$ÃtwÜk_wr™e_chunkqueue_£ndfe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
) {

97 
max_by‹s
 > 0 && 
NULL
 !ğ
cq
->
fœ¡
) {

98 
r
 = -1;

100 
cq
->
fœ¡
->
ty³
) {

101 
MEM_CHUNK
:

102 
r
 = 
	`ÃtwÜk_wr™ev_mem_chunks
(
¤v
, 
cÚ
, 
fd
, 
cq
, &
max_by‹s
);

104 
FILE_CHUNK
:

105 
r
 = 
	`ÃtwÜk_wr™e_fe_chunk_£ndfe
(
¤v
, 
cÚ
, 
fd
, 
cq
, &
max_by‹s
);

109 ià(-3 =ğ
r
)  0;

110 ià(0 !ğ
r
) „;

114 
	}
}

	@network_write_mmap.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 
	~"ÃtwÜk.h
"

6 
	~"log.h
"

7 
	~"sys-mm­.h
"

9 
	~<£tjmp.h
>

10 
	~<sigÇl.h
>

11 
	~<uni¡d.h
>

13 
	~<”ºo.h
>

14 
	~<¡ršg.h
>

16 
	#MMAP_CHUNK_SIZE
 (512*1024)

	)

18 
off_t
 
	$mm­_®ign_off£t
(
off_t
 
¡¬t
) {

19 
·gesize
 = 0;

20 ià(0 =ğ
·gesize
) {

21 
·gesize
 = 
	`syscÚf
(
_SC_PAGESIZE
);

22 
	`fÜû_as£¹
(
·gesize
 < 
MMAP_CHUNK_SIZE
);

24 
	`fÜû_as£¹
(
¡¬t
 >ğ(¡¬ˆ% 
·gesize
));

25  
¡¬t
 - (¡¬ˆ% 
·gesize
);

26 
	}
}

28 #ià
defšed
(
USE_MMAP
)

30 vŞ©
	gsigbus_jmp_v®id
;

31 
sigjmp_buf
 
	gsigbus_jmp
;

33 
	$sigbus_hªdËr
(
sig
) {

34 
	`UNUSED
(
sig
);

35 ià(
sigbus_jmp_v®id
è
	`siglÚgjmp
(
sigbus_jmp
, 1);

36 
	`log_çed_as£¹
(
__FILE__
, 
__LINE__
, "SIGBUS");

37 
	}
}

41 
	#LOCAL_BUFFERING
 1

	)

44 
	$ÃtwÜk_wr™e_fe_chunk_mm­
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

45 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

46 
off_t
 
off£t
, 
toS’d
, 
fe_’d
;

47 
ssize_t
 
r
;

48 
size_t
 
mm­_off£t
, 
mm­_ava
;

49 cÚ¡ *
d©a
;

51 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

52 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

53 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

55 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

56 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

57 ià(
toS’d
 > *
p_max_by‹s
)oSend = *p_max_bytes;

58 
fe_’d
 = 
c
->
fe
.
¡¬t
 + c->fe.
Ëngth
;

60 ià(0 =ğ
toS’d
) {

61 
	`chunkqueue_»move_fšished_chunks
(
cq
);

65 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

68 ià(0 !ğ
	`sig£tjmp
(
sigbus_jmp
, 1)) {

69 
sigbus_jmp_v®id
 = 0;

71 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbd", "SIGBUS in mmap:",

72 
c
->
fe
.
Çme
, c->fe.
fd
);

74 
	`munm­
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
);

75 
c
->
fe
.
mm­
.
¡¬t
 = 
MAP_FAILED
;

76 #ifdeà
LOCAL_BUFFERING


77 
	`bufãr_»£t
(
c
->
mem
);

83 
	`sigÇl
(
SIGBUS
, 
sigbus_hªdËr
);

86 ià(
MAP_FAILED
 =ğ
c
->
fe
.
mm­
.
¡¬t


87 || 
off£t
 < 
c
->
fe
.
mm­
.offset

88 || 
off£t
 >ğ(
off_t
)(
c
->
fe
.
mm­
.off£ˆ+ c->fe.mm­.
Ëngth
)) {

90 ià(
MAP_FAILED
 !ğ
c
->
fe
.
mm­
.
¡¬t
) {

91 
	`munm­
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
);

92 
c
->
fe
.
mm­
.
¡¬t
 = 
MAP_FAILED
;

116 
c
->
fe
.
mm­
.
off£t
 = 
	`mm­_®ign_off£t
(offset);

119 
c
->
fe
.
mm­
.
Ëngth
 = 
MMAP_CHUNK_SIZE
;

120 ià(
c
->
fe
.
mm­
.
off£t
 > 
fe_’d
 - (
off_t
)c->fe.mm­.
Ëngth
) {

121 
c
->
fe
.
mm­
.
Ëngth
 = 
fe_’d
 - c->fe.mm­.
off£t
;

124 ià(
MAP_FAILED
 =ğ(
c
->
fe
.
mm­
.
¡¬t
 = 
	`mm­
(
NULL
, c->fe.mm­.
Ëngth
, 
PROT_READ
, 
MAP_SHARED
, c->fe.
fd
, c->fe.mm­.
off£t
))) {

125 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbdoo", "mmap failed:",

126 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
, c->fe.
fd
, c->fe.
mm­
.
off£t
, (
off_t
èc->fe.mm­.
Ëngth
);

130 #ià
	`defšed
(
LOCAL_BUFFERING
)

131 
sigbus_jmp_v®id
 = 1;

132 
	`bufãr_cİy_¡ršg_Ën
(
c
->
mem
, c->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
);

133 
sigbus_jmp_v®id
 = 0;

135 #ià
	`defšed
(
HAVE_MADVISE
)

137 ià(
c
->
fe
.
mm­
.
Ëngth
 > (64*1024)) {

142 
	`madvi£
(
c
->
fe
.
mm­
.
¡¬t
, c->fe.mm­.
Ëngth
, 
MADV_WILLNEED
);

148 
	`fÜû_as£¹
(
off£t
 >ğ
c
->
fe
.
mm­
.offset);

149 
mm­_off£t
 = 
off£t
 - 
c
->
fe
.
mm­
.offset;

150 
	`fÜû_as£¹
(
c
->
fe
.
mm­
.
Ëngth
 > 
mm­_off£t
);

151 
mm­_ava
 = 
c
->
fe
.
mm­
.
Ëngth
 - 
mm­_off£t
;

152 ià(
toS’d
 > (
off_t
è
mm­_ava
)oSend = mmap_avail;

154 #ià
	`defšed
(
LOCAL_BUFFERING
)

155 
d©a
 = 
c
->
mem
->
±r
 + 
mm­_off£t
;

157 
d©a
 = 
c
->
fe
.
mm­
.
¡¬t
 + 
mm­_off£t
;

160 
sigbus_jmp_v®id
 = 1;

161 #ià
	`defšed
(
__WIN32
)

162 
r
 = 
	`£nd
(
fd
, 
d©a
, 
toS’d
, 0);

164 
r
 = 
	`wr™e
(
fd
, 
d©a
, 
toS’d
);

166 
sigbus_jmp_v®id
 = 0;

168 #ià
	`defšed
(
__WIN32
)

169 ià(
r
 < 0) {

170 
Ï¡E¼Ü
 = 
	`WSAG‘La¡E¼Ü
();

171 
Ï¡E¼Ü
) {

172 
WSAEINTR
:

173 
WSAEWOULDBLOCK
:

175 
WSAECONNRESET
:

176 
WSAETIMEDOUT
:

177 
WSAECONNABORTED
:

180 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd",

181 "£nd faed: ", 
Ï¡E¼Ü
, 
fd
);

186 ià(
r
 < 0) {

187 
”ºo
) {

188 
EAGAIN
:

189 
EINTR
:

191 
EPIPE
:

192 
ECONNRESET
:

195 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

196 "wr™çed:", 
	`¡»¼Ü
(
”ºo
), 
fd
);

202 ià(
r
 >= 0) {

203 *
p_max_by‹s
 -ğ
r
;

204 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

207  (
r
 > 0 &&„ =ğ
toS’d
) ? 0 : -3;

208 
	}
}

	@network_write_no_mmap.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 
	~"ÃtwÜk.h
"

6 
	~"fdev’t.h
"

7 
	~"log.h
"

8 
	~"¡©_ÿche.h
"

10 
	~"sys-sock‘.h
"

12 
	~<sys/time.h
>

13 
	~<¡dlib.h
>

15 
	~<fú.h
>

16 
	~<sys/¡©.h
>

17 
	~<uni¡d.h
>

19 
	~<”ºo.h
>

20 
	~<¡ršg.h
>

22 
	$ÃtwÜk_İ’_fe_chunk
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
chunkqueue
 *
cq
) {

23 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

24 
off_t
 
off£t
, 
toS’d
;

25 
¡©
 
¡
;

26 
	`UNUSED
(
cÚ
);

28 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

29 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

30 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

32 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

33 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

35 ià(-1 =ğ
c
->
fe
.
fd
) {

36 ià(-1 =ğ(
c
->
fe
.
fd
 = 
	`fdev’t_İ’_şÛxec
(c->fe.
Çme
->
±r
, 
O_RDONLY
, 0))) {

37 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "İ’ faed:", 
	`¡»¼Ü
(
”ºo
), 
c
->
fe
.
Çme
);

43 ià(
c
->
fe
.
is_‹mp
)  0;

45 ià(-1 =ğ
	`f¡©
(
c
->
fe
.
fd
, &
¡
)) {

46 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "f¡© faed:", 
	`¡»¼Ü
(
”ºo
));

50 ià(
off£t
 > 
¡
.
¡_size
 || 
toS’d
 > st.st_size || offset > st.st_size -oSend) {

51 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "fshrunk:", 
c
->
fe
.
Çme
);

56 
	}
}

58 
	$ÃtwÜk_wr™e_fe_chunk_no_mm­
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

59 
chunk
* cÚ¡ 
c
 = 
cq
->
fœ¡
;

60 
off_t
 
off£t
, 
toS’d
;

61 
ssize_t
 
r
;

63 
	`fÜû_as£¹
(
NULL
 !ğ
c
);

64 
	`fÜû_as£¹
(
FILE_CHUNK
 =ğ
c
->
ty³
);

65 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğc->
fe
.
Ëngth
);

67 
off£t
 = 
c
->
fe
.
¡¬t
 + c->offset;

68 
toS’d
 = 
c
->
fe
.
Ëngth
 - c->
off£t
;

69 ià(
toS’d
 > 64*1024)oSend = 64*1024;

70 ià(
toS’d
 > *
p_max_by‹s
)oSend = *p_max_bytes;

72 ià(0 =ğ
toS’d
) {

73 
	`chunkqueue_»move_fšished_chunks
(
cq
);

77 ià(0 !ğ
	`ÃtwÜk_İ’_fe_chunk
(
¤v
, 
cÚ
, 
cq
))  -1;

79 
	`bufãr_¡ršg_´•¬e_cİy
(
¤v
->
tmp_buf
, 
toS’d
);

81 ià(-1 =ğ
	`l£ek
(
c
->
fe
.
fd
, 
off£t
, 
SEEK_SET
)) {

82 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "l£ek: ", 
	`¡»¼Ü
(
”ºo
));

85 ià(-1 =ğ(
toS’d
 = 
	`»ad
(
c
->
fe
.
fd
, 
¤v
->
tmp_buf
->
±r
,oSend))) {

86 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "»ad: ", 
	`¡»¼Ü
(
”ºo
));

90 #ià
	`defšed
(
__WIN32
)

91 ià((
r
 = 
	`£nd
(
fd
, 
¤v
->
tmp_buf
->
±r
, 
toS’d
, 0)) < 0) {

92 
Ï¡E¼Ü
 = 
	`WSAG‘La¡E¼Ü
();

93 
Ï¡E¼Ü
) {

94 
WSAEINTR
:

95 
WSAEWOULDBLOCK
:

97 
WSAECONNRESET
:

98 
WSAETIMEDOUT
:

99 
WSAECONNABORTED
:

102 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd",

103 "£nd faed: ", 
Ï¡E¼Ü
, 
fd
);

108 ià((
r
 = 
	`wr™e
(
fd
, 
¤v
->
tmp_buf
->
±r
, 
toS’d
)) < 0) {

109 
”ºo
) {

110 
EAGAIN
:

111 
EINTR
:

113 
EPIPE
:

114 
ECONNRESET
:

117 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

118 "wr™çed:", 
	`¡»¼Ü
(
”ºo
), 
fd
);

124 ià(
r
 >= 0) {

125 *
p_max_by‹s
 -ğ
r
;

126 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

129  (
r
 > 0 &&„ =ğ
toS’d
) ? 0 : -3;

130 
	}
}

	@network_writev.c

1 
	~"fœ¡.h
"

3 
	~"ÃtwÜk_back’ds.h
"

5 #ià
defšed
(
USE_WRITEV
)

7 
	~"ÃtwÜk.h
"

8 
	~"log.h
"

10 #ià
defšed
(
HAVE_SYS_UIO_H
)

11 
	~<sys/uio.h
>

14 
	~<”ºo.h
>

15 
	~<¡ršg.h
>

16 
	~<¡dlib.h
>

18 #ià
defšed
(
UIO_MAXIOV
)

19 
	#SYS_MAX_CHUNKS
 
UIO_MAXIOV


	)

20 #–ià
defšed
(
IOV_MAX
)

22 
	#SYS_MAX_CHUNKS
 
IOV_MAX


	)

23 #–ià
defšed
(
_XOPEN_IOV_MAX
)

25 
	#SYS_MAX_CHUNKS
 
_XOPEN_IOV_MAX


	)

27 #”rÜ 
Ã™h”
 
UIO_MAXIOV
 
nÜ
 
IOV_MAX
‚Ü 
_XOPEN_IOV_MAX
 
¬e
 
defšed


34 
	#STACK_MAX_ALLOC_CHUNKS
 32

	)

35 #ià
SYS_MAX_CHUNKS
 > 
STACK_MAX_ALLOC_CHUNKS


36 
	#MAX_CHUNKS
 
STACK_MAX_ALLOC_CHUNKS


	)

38 
	#MAX_CHUNKS
 
SYS_MAX_CHUNKS


	)

41 
	$ÃtwÜk_wr™ev_mem_chunks
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 *
p_max_by‹s
) {

42 
iovec
 
chunks
[
MAX_CHUNKS
];

43 
size_t
 
num_chunks
;

44 
off_t
 
max_by‹s
 = *
p_max_by‹s
;

45 
off_t
 
toS’d
;

46 
ssize_t
 
r
;

47 
	`UNUSED
(
cÚ
);

49 
	`fÜû_as£¹
(
NULL
 !ğ
cq
->
fœ¡
);

50 
	`fÜû_as£¹
(
MEM_CHUNK
 =ğ
cq
->
fœ¡
->
ty³
);

53 
chunk
 cÚ¡ *
c
;

55 
toS’d
 = 0;

56 
num_chunks
 = 0;

57 
c
 = 
cq
->
fœ¡
; 
NULL
 !ğø&& 
MEM_CHUNK
 =ğc->
ty³
 && 
num_chunks
 < 
MAX_CHUNKS
 && 
toS’d
 < 
max_by‹s
; c = c->
Ãxt
) {

58 
size_t
 
c_Ën
;

60 
	`fÜû_as£¹
(
c
->
off£t
 >ğ0 && c->off£ˆ<ğ(
off_t
)
	`bufãr_¡ršg_Ëngth
(c->
mem
));

61 
c_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
c
->
mem
è- c->
off£t
;

62 ià(
c_Ën
 > 0) {

63 
toS’d
 +ğ
c_Ën
;

65 
chunks
[
num_chunks
].
iov_ba£
 = 
c
->
mem
->
±r
 + c->
off£t
;

66 
chunks
[
num_chunks
].
iov_Ën
 = 
c_Ën
;

68 ++
num_chunks
;

73 ià(0 =ğ
num_chunks
) {

74 
	`chunkqueue_»move_fšished_chunks
(
cq
);

78 
r
 = 
	`wr™ev
(
fd
, 
chunks
, 
num_chunks
);

80 ià(
r
 < 0è
”ºo
) {

81 
EAGAIN
:

82 
EINTR
:

84 
EPIPE
:

85 
ECONNRESET
:

88 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssd",

89 "wr™ev faed:", 
	`¡»¼Ü
(
”ºo
), 
fd
);

93 ià(
r
 >= 0) {

94 *
p_max_by‹s
 -ğ
r
;

95 
	`chunkqueue_m¬k_wr™‹n
(
cq
, 
r
);

98  (
r
 > 0 &&„ =ğ
toS’d
) ? 0 : -3;

99 
	}
}

103 
	$ÃtwÜk_wr™e_chunkqueue_wr™ev
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
fd
, 
chunkqueue
 *
cq
, 
off_t
 
max_by‹s
) {

104 
max_by‹s
 > 0 && 
NULL
 !ğ
cq
->
fœ¡
) {

105 
r
 = -1;

107 
cq
->
fœ¡
->
ty³
) {

108 
MEM_CHUNK
:

109 
r
 = 
	`ÃtwÜk_wr™ev_mem_chunks
(
¤v
, 
cÚ
, 
fd
, 
cq
, &
max_by‹s
);

111 
FILE_CHUNK
:

112 
r
 = 
	`ÃtwÜk_wr™e_fe_chunk_mm­
(
¤v
, 
cÚ
, 
fd
, 
cq
, &
max_by‹s
);

116 ià(-3 =ğ
r
)  0;

117 ià(0 !ğ
r
) „;

121 
	}
}

	@plugin.c

1 
	~"fœ¡.h
"

3 
	~"¶ugš.h
"

4 
	~"log.h
"

6 
	~<¡ršg.h
>

7 
	~<¡dlib.h
>

9 
	~<¡dio.h
>

11 #ifdeà
HAVE_VALGRIND_VALGRIND_H


12 
	~<v®gršd/v®gršd.h
>

15 #ià!
defšed
(
__WIN32
è&& !defšed(
LIGHTTPD_STATIC
)

16 
	~<dlfú.h
>

29 
	mPLUGIN_DATA
;

30 } 
	t¶ugš_d©a
;

33 
	mPLUGIN_FUNC_UNSET
,

35 
	mPLUGIN_FUNC_HANDLE_URI_CLEAN
,

36 
	mPLUGIN_FUNC_HANDLE_URI_RAW
,

37 
	mPLUGIN_FUNC_HANDLE_REQUEST_DONE
,

38 
	mPLUGIN_FUNC_HANDLE_CONNECTION_CLOSE
,

39 
	mPLUGIN_FUNC_HANDLE_TRIGGER
,

40 
	mPLUGIN_FUNC_HANDLE_SIGHUP
,

41 
	mPLUGIN_FUNC_HANDLE_SUBREQUEST
,

42 
	mPLUGIN_FUNC_HANDLE_SUBREQUEST_START
,

43 
	mPLUGIN_FUNC_HANDLE_RESPONSE_START
,

44 
	mPLUGIN_FUNC_HANDLE_DOCROOT
,

45 
	mPLUGIN_FUNC_HANDLE_PHYSICAL
,

46 
	mPLUGIN_FUNC_CONNECTION_RESET
,

47 
	mPLUGIN_FUNC_INIT
,

48 
	mPLUGIN_FUNC_CLEANUP
,

49 
	mPLUGIN_FUNC_SET_DEFAULTS
,

51 
	mPLUGIN_FUNC_SIZEOF


52 } 
	t¶ugš_t
;

54 
¶ugš
 *
	$¶ugš_š™
() {

55 
¶ugš
 *
p
;

57 
p
 = 
	`ÿÎoc
(1, (*p));

58 
	`fÜû_as£¹
(
NULL
 !ğ
p
);

60  
p
;

61 
	}
}

63 
	$¶ugš_ä“
(
¶ugš
 *
p
) {

64 #ià!
	`defšed
(
LIGHTTPD_STATIC
)

65 
u£_dlşo£
 = 1;

68 ià(
p
->
Çme
è
	`bufãr_ä“
(p->name);

69 #ià
	`defšed
(
HAVE_VALGRIND_VALGRIND_H
è&& !defšed(
LIGHTTPD_STATIC
)

73 #ià!
	`defšed
(
LIGHTTPD_STATIC
)

74 ià(
u£_dlşo£
 && 
p
->
lib
) {

75 #ià
	`defšed
(
__WIN32
)

76 è
	`F»eLib¿ry
(
p
->
lib
);

78 
	`dlşo£
(
p
->
lib
);

83 
	`ä“
(
p
);

84 
	}
}

86 
	$¶ugšs_»gi¡”
(
£rv”
 *
¤v
, 
¶ugš
 *
p
) {

87 
¶ugš
 **
ps
;

88 ià(0 =ğ
¤v
->
¶ugšs
.
size
) {

89 
¤v
->
¶ugšs
.
size
 = 4;

90 
¤v
->
¶ugšs
.
±r
 = 
	`m®loc
(¤v->¶ugšs.
size
 * (*
ps
));

91 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
¶ugšs
.
±r
);

92 
¤v
->
¶ugšs
.
u£d
 = 0;

93 } ià(
¤v
->
¶ugšs
.
u£d
 =ğ¤v->¶ugšs.
size
) {

94 
¤v
->
¶ugšs
.
size
 += 4;

95 
¤v
->
¶ugšs
.
±r
 = 
	`»®loc
(¤v->¶ugšs.±r, srv->¶ugšs.
size
 * (*
ps
));

96 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
¶ugšs
.
±r
);

99 
ps
 = 
¤v
->
¶ugšs
.
±r
;

100 
ps
[
¤v
->
¶ugšs
.
u£d
++] = 
p
;

103 
	}
}

111 #ià
defšed
(
LIGHTTPD_STATIC
)

114 
	#PLUGIN_INIT
(
x
)\

115 
x
 ## 
	`_¶ugš_š™
(
¶ugš
 *
p
);

	)

117 
	~"¶ugš-¡©ic.h
"

119 #undeà
PLUGIN_INIT


124 cÚ¡ * 
	mÇme
;

125 (*
	m¶ugš_š™
)(
¶ugš
 *
	mp
);

126 } 
	t¶ugš_lßd_funùiÚs
;

128 cÚ¡ 
¶ugš_lßd_funùiÚs
 
	glßd_funùiÚs
[] = {

129 
	#PLUGIN_INIT
(
x
) \

130 { #x, &
x
 ## 
_¶ugš_š™
 },

	)

132 
	~"¶ugš-¡©ic.h
"

134 { 
NULL
, NULL }

135 #undeà
PLUGIN_INIT


138 
	$¶ugšs_lßd
(
£rv”
 *
¤v
) {

139 
¶ugš
 *
p
;

140 
size_t
 
i
, 
j
;

142 
i
 = 0; i < 
¤v
->
¤vcÚf
.
moduËs
->
u£d
; i++) {

143 
d©a_¡ršg
 *
d
 = (d©a_¡ršg *)
¤v
->
¤vcÚf
.
moduËs
->
d©a
[
i
];

144 *
moduË
 = 
d
->
v®ue
->
±r
;

146 
j
 = 0; j < 
i
; j++) {

147 ià(
	`bufãr_is_equ®
(
d
->
v®ue
, ((
d©a_¡ršg
 *è
¤v
->
¤vcÚf
.
moduËs
->
d©a
[
j
])->value)) {

148 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

149 "CªnÙ†ßd…lugš", 
d
->
v®ue
,

155 
j
 = 0; 
lßd_funùiÚs
[j].
Çme
; ++j) {

156 ià(0 =ğ
	`¡rcmp
(
lßd_funùiÚs
[
j
].
Çme
, 
moduË
)) {

157 
p
 = 
	`¶ugš_š™
();

158 ià((*
lßd_funùiÚs
[
j
].
¶ugš_š™
)(
p
)) {

159 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", 
moduË
, "plugin init failed" );

160 
	`¶ugš_ä“
(
p
);

163 
	`¶ugšs_»gi¡”
(
¤v
, 
p
);

167 ià(!
lßd_funùiÚs
[
j
].
Çme
) {

168 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", 
moduË
, "…lugin‚ot found" );

174 
	}
}

176 
	$¶ugšs_lßd
(
£rv”
 *
¤v
) {

177 
¶ugš
 *
p
;

178 (*
š™
)(
¶ugš
 *
¶
);

179 
size_t
 
i
, 
j
;

181 
i
 = 0; i < 
¤v
->
¤vcÚf
.
moduËs
->
u£d
; i++) {

182 
d©a_¡ršg
 *
d
 = (d©a_¡ršg *)
¤v
->
¤vcÚf
.
moduËs
->
d©a
[
i
];

183 *
moduË
 = 
d
->
v®ue
->
±r
;

185 
j
 = 0; j < 
i
; j++) {

186 ià(
	`bufãr_is_equ®
(
d
->
v®ue
, ((
d©a_¡ršg
 *è
¤v
->
¤vcÚf
.
moduËs
->
d©a
[
j
])->value)) {

187 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

188 "CªnÙ†ßd…lugš", 
d
->
v®ue
,

194 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, srv->
¤vcÚf
.
moduËs_dœ
);

196 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("/"));

197 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
moduË
);

198 #ià
	`defšed
(
__WIN32
è|| defšed(
__CYGWIN__
)

199 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
(".dll"));

201 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
(".so"));

204 
p
 = 
	`¶ugš_š™
();

205 #ifdeà
__WIN32


206 ià(
NULL
 =ğ(
p
->
lib
 = 
	`LßdLib¿ry
(
¤v
->
tmp_buf
->
±r
))) {

207 
LPVOID
 
ÍMsgBuf
;

208 
	`FÜm©Mes§ge
(

209 
FORMAT_MESSAGE_ALLOCATE_BUFFER
 |

210 
FORMAT_MESSAGE_FROM_SYSTEM
,

211 
NULL
,

212 
	`G‘La¡E¼Ü
(),

213 
	`MAKELANGID
(
LANG_NEUTRAL
, 
SUBLANG_DEFAULT
),

214 (
LPTSTR
è&
ÍMsgBuf
,

215 0, 
NULL
);

217 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssb", "LoadLibrary() failed",

218 
ÍMsgBuf
, 
¤v
->
tmp_buf
);

220 
	`¶ugš_ä“
(
p
);

226 ià(
NULL
 =ğ(
p
->
lib
 = 
	`dlİ’
(
¤v
->
tmp_buf
->
±r
, 
RTLD_NOW
|
RTLD_GLOBAL
))) {

227 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "dlopen() failed for:",

228 
¤v
->
tmp_buf
, 
	`dË¼Ü
());

230 
	`¶ugš_ä“
(
p
);

236 
	`bufãr_»£t
(
¤v
->
tmp_buf
);

237 
	`bufãr_cİy_¡ršg
(
¤v
->
tmp_buf
, 
moduË
);

238 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("_plugin_init"));

240 #ifdeà
__WIN32


241 
š™
 = 
	`G‘ProcAdd»ss
(
p
->
lib
, 
¤v
->
tmp_buf
->
±r
);

243 ià(
š™
 =ğ
NULL
) {

244 
LPVOID
 
ÍMsgBuf
;

245 
	`FÜm©Mes§ge
(

246 
FORMAT_MESSAGE_ALLOCATE_BUFFER
 |

247 
FORMAT_MESSAGE_FROM_SYSTEM
,

248 
NULL
,

249 
	`G‘La¡E¼Ü
(),

250 
	`MAKELANGID
(
LANG_NEUTRAL
, 
SUBLANG_DEFAULT
),

251 (
LPTSTR
è&
ÍMsgBuf
,

252 0, 
NULL
);

254 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", "g‘´oÿdd»s çed:", srv->
tmp_buf
, 
ÍMsgBuf
);

256 
	`¶ugš_ä“
(
p
);

262 
š™
 = ((*)(
¶ugš
 *))(
šŒ_t
)
	`dlsym
(
p
->
lib
, 
¤v
->
tmp_buf
->
±r
);

264 *(**)(&
š™
èğ
	`dlsym
(
p
->
lib
, 
¤v
->
tmp_buf
->
±r
);

266 ià(
NULL
 =ğ
š™
) {

267 cÚ¡ *
”rÜ
 = 
	`dË¼Ü
();

268 ià(
”rÜ
 !ğ
NULL
) {

269 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "dlsym:", 
”rÜ
);

271 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "dlsym symbŞ‚Ù found:", srv->
tmp_buf
->
±r
);

274 
	`¶ugš_ä“
(
p
);

279 ià((*
š™
)(
p
)) {

280 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", 
moduË
, "plugin init failed" );

282 
	`¶ugš_ä“
(
p
);

286 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", 
moduË
, "plugin†oaded" );

288 
	`¶ugšs_»gi¡”
(
¤v
, 
p
);

292 
	}
}

295 
	#PLUGIN_TO_SLOT
(
x
, 
y
) \

296 
hªdËr_t
 
¶ugšs_ÿÎ_
##
	`y
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {\

297 
¶ugš
 **
¦Ù
;\

298 
size_t
 
j
;\

299 ià(!
¤v
->
¶ugš_¦Ùs
è 
HANDLER_GO_ON
;\

300 
¦Ù
 = ((
¶ugš
 ***)(
¤v
->
¶ugš_¦Ùs
))[
x
];\

301 ià(!
¦Ù
è 
HANDLER_GO_ON
;\

302 
j
 = 0; j < 
¤v
->
¶ugšs
.
u£d
 && 
¦Ù
[j]; j++) { \

303 
¶ugš
 *
p
 = 
¦Ù
[
j
];\

304 
hªdËr_t
 
r
;\

305 
r
 = 
p
->
	`y
(
¤v
, 
cÚ
,…->
d©a
)) {\

306 
HANDLER_GO_ON
:\

308 
HANDLER_FINISHED
:\

309 
HANDLER_COMEBACK
:\

310 
HANDLER_WAIT_FOR_EVENT
:\

311 
HANDLER_WAIT_FOR_FD
:\

312 
HANDLER_ERROR
:\

313  
r
;\

315 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs", #x, 
p
->
Çme
, "unknown state");\

316  
HANDLER_ERROR
;\

319  
HANDLER_GO_ON
;\

320 }

	)

330 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_URI_CLEAN
, 
hªdË_uri_ş—n
)

331 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_URI_RAW
, 
hªdË_uri_¿w
)

332 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_REQUEST_DONE
, 
hªdË_»que¡_dÚe
)

333 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_CONNECTION_CLOSE
, 
hªdË_cÚÃùiÚ_şo£
)

334 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_SUBREQUEST
, 
hªdË_sub»que¡
)

335 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_SUBREQUEST_START
, 
hªdË_sub»que¡_¡¬t
)

336 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_RESPONSE_START
, 
hªdË_»¥Ú£_¡¬t
)

337 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_DOCROOT
, 
hªdË_doüoÙ
)

338 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_PHYSICAL
, 
hªdË_physiÿl
)

339 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_CONNECTION_RESET
, 
cÚÃùiÚ_»£t
)

341 #undeà
PLUGIN_TO_SLOT


343 
	#PLUGIN_TO_SLOT
(
x
, 
y
) \

344 
hªdËr_t
 
¶ugšs_ÿÎ_
##
	`y
(
£rv”
 *
¤v
) {\

345 
¶ugš
 **
¦Ù
;\

346 
size_t
 
j
;\

347 ià(!
¤v
->
¶ugš_¦Ùs
è 
HANDLER_GO_ON
;\

348 
¦Ù
 = ((
¶ugš
 ***)(
¤v
->
¶ugš_¦Ùs
))[
x
];\

349 ià(!
¦Ù
è 
HANDLER_GO_ON
;\

350 
j
 = 0; j < 
¤v
->
¶ugšs
.
u£d
 && 
¦Ù
[j]; j++) { \

351 
¶ugš
 *
p
 = 
¦Ù
[
j
];\

352 
hªdËr_t
 
r
;\

353 
r
 = 
p
->
	`y
(
¤v
,…->
d©a
)) {\

354 
HANDLER_GO_ON
:\

356 
HANDLER_FINISHED
:\

357 
HANDLER_COMEBACK
:\

358 
HANDLER_WAIT_FOR_EVENT
:\

359 
HANDLER_WAIT_FOR_FD
:\

360 
HANDLER_ERROR
:\

361  
r
;\

363 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsd", #x, 
p
->
Çme
, "unknowÀ¡©e:", 
r
);\

364  
HANDLER_ERROR
;\

367  
HANDLER_GO_ON
;\

368 
	}

	)
}

377 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_TRIGGER
, 
hªdË_Œigg”
)

378 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_SIGHUP
, 
hªdË_sighup
)

379 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_CLEANUP
, 
ş—nup
)

380 
	$PLUGIN_TO_SLOT
(
PLUGIN_FUNC_SET_DEFAULTS
, 
£t_deçuÉs
)

382 #undeà
PLUGIN_TO_SLOT


390 
hªdËr_t
 
	$¶ugšs_ÿÎ_hªdË_fdev’t
(
£rv”
 *
¤v
, cÚ¡ 
fd_cÚn
 *
fdc
) {

391 
size_t
 
i
;

392 
¶ugš
 **
ps
;

394 
ps
 = 
¤v
->
¶ugšs
.
±r
;

396 
i
 = 0; i < 
¤v
->
¶ugšs
.
u£d
; i++) {

397 
¶ugš
 *
p
 = 
ps
[
i
];

398 ià(
p
->
hªdË_fdev’t
) {

399 
hªdËr_t
 
r
;

400 
r
 = 
p
->
	`hªdË_fdev’t
(
¤v
, 
fdc
,…->
d©a
)) {

401 
HANDLER_GO_ON
:

403 
HANDLER_FINISHED
:

404 
HANDLER_COMEBACK
:

405 
HANDLER_WAIT_FOR_EVENT
:

406 
HANDLER_ERROR
:

407  
r
;

409 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "d", 
r
);

415  
HANDLER_GO_ON
;

416 
	}
}

426 
hªdËr_t
 
	$¶ugšs_ÿÎ_š™
(
£rv”
 *
¤v
) {

427 
size_t
 
i
;

428 
¶ugš
 **
ps
;

430 
ps
 = 
¤v
->
¶ugšs
.
±r
;

434 
¤v
->
¶ugš_¦Ùs
 = 
	`ÿÎoc
(
PLUGIN_FUNC_SIZEOF
, (
ps
));

435 
	`fÜû_as£¹
(
NULL
 !ğ
¤v
->
¶ugš_¦Ùs
);

437 
i
 = 0; i < 
¤v
->
¶ugšs
.
u£d
; i++) {

438 
size_t
 
j
;

441 
¶ugš
 *
p
 = 
ps
[
i
];

443 
	#PLUGIN_TO_SLOT
(
x
, 
y
) \

444 ià(
p
->
y
) { \

445 
¶ugš
 **
¦Ù
 = (Õlugš ***)(
¤v
->
¶ugš_¦Ùs
))[
x
]; \

446 ià(!
¦Ù
) { \

447 
¦Ù
 = 
	`ÿÎoc
(
¤v
->
¶ugšs
.
u£d
, (*slot));\

448 
	`fÜû_as£¹
(
NULL
 !ğ
¦Ù
); \

449 ((
¶ugš
 ***)(
¤v
->
¶ugš_¦Ùs
))[
x
] = 
¦Ù
; \

451 
j
 = 0; j < 
¤v
->
¶ugšs
.
u£d
; j++) { \

452 ià(
¦Ù
[
j
]) ;\

453 
¦Ù
[
j
] = 
p
;\

456 }

	)

459 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_URI_CLEAN
, 
hªdË_uri_ş—n
);

460 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_URI_RAW
, 
hªdË_uri_¿w
);

461 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_REQUEST_DONE
, 
hªdË_»que¡_dÚe
);

462 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_CONNECTION_CLOSE
, 
hªdË_cÚÃùiÚ_şo£
);

463 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_TRIGGER
, 
hªdË_Œigg”
);

464 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_SIGHUP
, 
hªdË_sighup
);

465 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_SUBREQUEST
, 
hªdË_sub»que¡
);

466 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_SUBREQUEST_START
, 
hªdË_sub»que¡_¡¬t
);

467 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_RESPONSE_START
, 
hªdË_»¥Ú£_¡¬t
);

468 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_DOCROOT
, 
hªdË_doüoÙ
);

469 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_HANDLE_PHYSICAL
, 
hªdË_physiÿl
);

470 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_CONNECTION_RESET
, 
cÚÃùiÚ_»£t
);

471 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_CLEANUP
, 
ş—nup
);

472 
	`PLUGIN_TO_SLOT
(
PLUGIN_FUNC_SET_DEFAULTS
, 
£t_deçuÉs
);

473 #undeà
PLUGIN_TO_SLOT


475 ià(
p
->
š™
) {

476 ià(
NULL
 =ğ(
p
->
d©a
 =…->
	`š™
())) {

477 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

478 "¶ugš-š™ faed fÜ moduË", 
p
->
Çme
);

479  
HANDLER_ERROR
;

483 ((
¶ugš_d©a
 *)(
p
->
d©a
))->
id
 = 
i
 + 1;

485 ià(
p
->
v”siÚ
 !ğ
LIGHTTPD_VERSION_ID
) {

486 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

487 "¶ugš-v”siÚ dÛ¢'ˆm©ch†igh‰pd-v”siÚ fÜ", 
p
->
Çme
);

488  
HANDLER_ERROR
;

491 
p
->
d©a
 = 
NULL
;

495  
HANDLER_GO_ON
;

496 
	}
}

498 
	$¶ugšs_ä“
(
£rv”
 *
¤v
) {

499 
size_t
 
i
;

500 
	`¶ugšs_ÿÎ_ş—nup
(
¤v
);

502 
i
 = 0; i < 
¤v
->
¶ugšs
.
u£d
; i++) {

503 
¶ugš
 *
p
 = (Õlugš **)
¤v
->
¶ugšs
.
±r
)[
i
];

505 
	`¶ugš_ä“
(
p
);

508 
i
 = 0; 
¤v
->
¶ugš_¦Ùs
 && i < 
PLUGIN_FUNC_SIZEOF
; i++) {

509 
¶ugš
 **
¦Ù
 = (Õlugš ***)(
¤v
->
¶ugš_¦Ùs
))[
i
];

511 ià(
¦Ù
è
	`ä“
(slot);

514 
	`ä“
(
¤v
->
¶ugš_¦Ùs
);

515 
¤v
->
¶ugš_¦Ùs
 = 
NULL
;

517 
	`ä“
(
¤v
->
¶ugšs
.
±r
);

518 
¤v
->
¶ugšs
.
±r
 = 
NULL
;

519 
¤v
->
¶ugšs
.
u£d
 = 0;

520 
	}
}

	@plugin.h

1 #iâdeà
_PLUGIN_H_


2 
	#_PLUGIN_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

6 
	~"bufãr.h
"

8 
	#SERVER_FUNC
(
x
) \

9 
hªdËr_t
 
	`x
(
£rv”
 *
¤v
, *
p_d
)

	)

11 
	#CONNECTION_FUNC
(
x
) \

12 
hªdËr_t
 
	`x
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, *
p_d
)

	)

14 
	#INIT_FUNC
(
x
) \

15 *
	`x
()

	)

17 
	#FREE_FUNC
 
SERVER_FUNC


	)

18 
	#TRIGGER_FUNC
 
SERVER_FUNC


	)

19 
	#SETDEFAULTS_FUNC
 
SERVER_FUNC


	)

20 
	#SIGHUP_FUNC
 
SERVER_FUNC


	)

22 
	#SUBREQUEST_FUNC
 
CONNECTION_FUNC


	)

23 
	#PHYSICALPATH_FUNC
 
CONNECTION_FUNC


	)

24 
	#REQUESTDONE_FUNC
 
CONNECTION_FUNC


	)

25 
	#URIHANDLER_FUNC
 
CONNECTION_FUNC


	)

27 
	#PLUGIN_DATA
 
size_t
 
id


	)

30 
size_t
 
	mv”siÚ
;

32 
bufãr
 *
	mÇme
;

34 *(* 
	mš™
) ();

35 
hªdËr_t
 (* 
£t_deçuÉs
è(
£rv”
 *
	m¤v
, *
	mp_d
);

36 
hªdËr_t
 (* 
ş—nup
è(
£rv”
 *
	m¤v
, *
	mp_d
);

38 
hªdËr_t
 (* 
hªdË_Œigg”
è(
£rv”
 *
	m¤v
, *
	mp_d
);

39 
hªdËr_t
 (* 
hªdË_sighup
è(
£rv”
 *
	m¤v
, *
	mp_d
);

41 
hªdËr_t
 (* 
hªdË_uri_¿w
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

42 
hªdËr_t
 (* 
hªdË_uri_ş—n
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

43 
hªdËr_t
 (* 
hªdË_doüoÙ
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

44 
hªdËr_t
 (* 
hªdË_physiÿl
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

45 
hªdËr_t
 (* 
hªdË_»que¡_dÚe
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

46 
hªdËr_t
 (* 
hªdË_cÚÃùiÚ_şo£
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

50 
hªdËr_t
 (* 
hªdË_sub»que¡_¡¬t
)(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

55 
hªdËr_t
 (* 
hªdË_sub»que¡
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

56 
hªdËr_t
 (* 
hªdË_»¥Ú£_¡¬t
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

57 
hªdËr_t
 (* 
cÚÃùiÚ_»£t
è(
£rv”
 *
	m¤v
, 
cÚÃùiÚ
 *
	mcÚ
, *
	mp_d
);

58 *
	md©a
;

61 *
	mlib
;

62 } 
	t¶ugš
;

64 
¶ugšs_lßd
(
£rv”
 *
¤v
);

65 
¶ugšs_ä“
(
£rv”
 *
¤v
);

67 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_uri_¿w
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

68 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_uri_ş—n
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

69 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_sub»que¡_¡¬t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

70 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_sub»que¡
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

71 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_»¥Ú£_¡¬t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

72 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_»que¡_dÚe
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

73 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_doüoÙ
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

74 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_physiÿl
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

75 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_cÚÃùiÚ_şo£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

76 
hªdËr_t
 
¶ugšs_ÿÎ_cÚÃùiÚ_»£t
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

78 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_Œigg”
(
£rv”
 *
¤v
);

79 
hªdËr_t
 
¶ugšs_ÿÎ_hªdË_sighup
(
£rv”
 *
¤v
);

81 
hªdËr_t
 
¶ugšs_ÿÎ_š™
(
£rv”
 *
¤v
);

82 
hªdËr_t
 
¶ugšs_ÿÎ_£t_deçuÉs
(
£rv”
 *
¤v
);

83 
hªdËr_t
 
¶ugšs_ÿÎ_ş—nup
(
£rv”
 *
¤v
);

85 
cÚfig_š£¹_v®ues_glob®
(
£rv”
 *
¤v
, 
¬¿y
 *
ÿ
, cÚ¡ 
cÚfig_v®ues_t
 *
cv
, 
cÚfig_scİe_ty³_t
 
scİe
);

86 
cÚfig_š£¹_v®ues_š‹º®
(
£rv”
 *
¤v
, 
¬¿y
 *
ÿ
, cÚ¡ 
cÚfig_v®ues_t
 *
cv
, 
cÚfig_scİe_ty³_t
 
scİe
);

87 
cÚfig_check_cÚd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
);

88 
cÚfig_­³nd_cÚd_m©ch_bufãr
(
cÚÃùiÚ
 *
cÚ
, 
d©a_cÚfig
 *
dc
, 
bufãr
 *
buf
, 
n
);

	@proc_open.c

1 
	~"fœ¡.h
"

3 
	~"´oc_İ’.h
"

5 
	~<¡dlib.h
>

6 
	~<¡dio.h
>

7 
	~<ùy³.h
>

8 
	~<¡ršg.h
>

9 
	~<”ºo.h
>

11 #ifdeà
WIN32


12 
	~<io.h
>

13 
	~<fú.h
>

15 
	~<sys/wa™.h
>

16 
	~<uni¡d.h
>

20 #ifdeà
WIN32


22 
	#SHELLENV
 "ComS³c"

	)

23 
	#SECURITY_DC
 , 
SECURITY_ATTRIBUTES
 *
£cur™y


	)

24 
	#SECURITY_CC
 , 
£cur™y


	)

25 
	#pe
(
·œ
è(
	`C»©ePe
(&·œ[0], &·œ[1], 
£cur™y
, 2048Lè? 0 : -1)

	)

26 
šlše
 
HANDLE
 
	$dup_hªdË
(
HANDLE
 
¤c
, 
BOOL
 
šh”™
, BOOL 
şo£Üig
)

28 
HANDLE
 
cİy
, 
£lf
 = 
	`G‘Cu¼’tProûss
();

30 ià(!
	`Du¶iÿ‹HªdË
(
£lf
, 
¤c
, s–f, &
cİy
, 0, 
šh”™
, 
DUPLICATE_SAME_ACCESS
 |

31 (
şo£Üig
 ? 
DUPLICATE_CLOSE_SOURCE
 : 0)))

32  
NULL
;

33  
cİy
;

34 
	}
}

35 
	#şo£_desütÜ
(
fd
è
	`Clo£HªdË
(fd)

	)

36 
	$pe_şo£_·»Á
(
pe_t
 *
p
) {

38 
p
->
·»Á
 = 
	`dup_hªdË
Õ->·»Á, 
FALSE
, 
TRUE
);

39 
	}
}

40 
	$pe_şo£_chd
(
pe_t
 *
p
) {

41 
	`şo£_desütÜ
(
p
->
chd
);

42 
p
->
fd
 = 
	`_İ’_osfhªdË
((í->
·»Á
,

43 (
p
->
fd
 =ğ0 ? 
O_RDONLY
 : 
O_WRONLY
)|
O_BINARY
);

44 
	}
}

48 
	#SHELLENV
 "SHELL"

	)

49 
	#SECURITY_DC


	)

50 
	#SECURITY_CC


	)

51 
	#şo£_desütÜ
(
fd
è
	`şo£
(fd)

	)

52 
	$pe_şo£_·»Á
(
pe_t
 *
p
) {

54 
	`şo£_desütÜ
(
p
->
·»Á
);

55 ià(
	`dup2
(
p
->
chd
,…->
fd
) !=…->fd) {

56 
	`³¼Ü
("pipe_child dup2");

58 
	`şo£_desütÜ
(
p
->
chd
);

59 
p
->
chd
 =…->
fd
;

61 
	}
}

62 
	$pe_şo£_chd
(
pe_t
 *
p
) {

63 
	`şo£_desütÜ
(
p
->
chd
);

64 
p
->
fd
 =…->
·»Á
;

65 
	}
}

70 
	$pe_şo£
(
pe_t
 *
p
) {

71 
	`şo£_desütÜ
(
p
->
·»Á
);

72 
	`şo£_desütÜ
(
p
->
chd
);

73 #ifdeà
WIN32


74 
	`şo£
(
p
->
fd
);

76 
	}
}

79 
	$pe_İ’
(
pe_t
 *
p
, 
fd
 
SECURITY_DC
) {

80 
desütÜ_t
 
Ãwpe
[2];

82 ià(0 !ğ
	`pe
(
Ãwpe
)) {

83 
	`årštf
(
¡d”r
, "can't open…ipe");

86 ià(0 =ğ
fd
) {

87 
p
->
·»Á
 = 
Ãwpe
[1];

88 
p
->
chd
 = 
Ãwpe
[0];

90 
p
->
·»Á
 = 
Ãwpe
[0];

91 
p
->
chd
 = 
Ãwpe
[1];

93 
p
->
fd
 = fd;

96 
	}
}

100 
	$´oc_İ’_pes
(
´oc_hªdËr_t
 *
´oc
 
SECURITY_DC
) {

101 ià(
	`pe_İ’
(&(
´oc
->
š
), 0 
SECURITY_CC
) != 0) {

104 ià(
	`pe_İ’
(&(
´oc
->
out
), 1 
SECURITY_CC
) != 0) {

107 ià(
	`pe_İ’
(&(
´oc
->
”r
), 2 
SECURITY_CC
) != 0) {

111 
	}
}

114 
	$´oc_şo£_pes
(
´oc_hªdËr_t
 *
´oc
) {

115 
	`pe_şo£
(&
´oc
->
š
);

116 
	`pe_şo£
(&
´oc
->
out
);

117 
	`pe_şo£
(&
´oc
->
”r
);

118 
	}
}

121 
	$´oc_şo£_·»Ás
(
´oc_hªdËr_t
 *
´oc
) {

122 
	`pe_şo£_·»Á
(&
´oc
->
š
);

123 
	`pe_şo£_·»Á
(&
´oc
->
out
);

124 
	`pe_şo£_·»Á
(&
´oc
->
”r
);

125 
	}
}

128 
	$´oc_şo£_chds
(
´oc_hªdËr_t
 *
´oc
) {

129 
	`pe_şo£_chd
(&
´oc
->
š
);

130 
	`pe_şo£_chd
(&
´oc
->
out
);

131 
	`pe_şo£_chd
(&
´oc
->
”r
);

132 
	}
}

135 #ifdeà
WIN32


137 
	$´oc_şo£
(
´oc_hªdËr_t
 *
´oc
) {

138 
´oc_pid_t
 
chd
 = 
´oc
->child;

139 
DWORD
 
w¡©us
;

141 
	`´oc_şo£_pes
(
´oc
);

142 
	`Wa™FÜSšgËObjeù
(
chd
, 
INFINITE
);

143 
	`G‘Ex™CodeProûss
(
chd
, &
w¡©us
);

144 
	`Clo£HªdË
(
chd
);

146  
w¡©us
;

147 
	}
}

150 
	$´oc_İ’
(
´oc_hªdËr_t
 *
´oc
, cÚ¡ *
commªd
) {

151 
PROCESS_INFORMATION
 
pi
;

152 
STARTUPINFO
 
si
;

153 
BOOL
 
´ocok
;

154 
SECURITY_ATTRIBUTES
 
£cur™y
;

155 cÚ¡ *
sh–l
 = 
NULL
;

156 cÚ¡ *
wšdœ
 = 
NULL
;

157 
bufãr
 *
cmdlše
;

159 ià(
NULL
 =ğ(
sh–l
 = 
	`g‘’v
(
SHELLENV
)) &&

160 
NULL
 =ğ(
wšdœ
 = 
	`g‘’v
("SystemRoot")) &&

161 
NULL
 =ğ(
wšdœ
 = 
	`g‘’v
("windir"))) {

162 
	`årštf
(
¡d”r
, "OÃ oà%s,%%Sy¡emRoÙ,%%wšdœ i »quœed", 
SHELLENV
);

167 
	`mem£t
(&
£cur™y
, 0, (security));

168 
£cur™y
.
nL’gth
 = (security);

169 
£cur™y
.
bInh”™HªdË
 = 
TRUE
;

170 
£cur™y
.
ÍSecur™yDesütÜ
 = 
NULL
;

172 ià(
	`´oc_İ’_pes
(
´oc
, &
£cur™y
) != 0) {

175 
	`´oc_şo£_·»Ás
(
´oc
);

177 
	`mem£t
(&
si
, 0, (si));

178 
si
.
cb
 = (si);

179 
si
.
dwFÏgs
 = 
STARTF_USESTDHANDLES
;

180 
si
.
hStdIÅut
 = 
´oc
->
š
.
chd
;

181 
si
.
hStdOuut
 = 
´oc
->
out
.
chd
;

182 
si
.
hStdE¼Ü
 = 
´oc
->
”r
.
chd
;

184 
	`mem£t
(&
pi
, 0, (pi));

186 
cmdlše
 = 
	`bufãr_š™
();

187 ià(
sh–l
) {

188 
	`bufãr_­³nd_¡ršg
(
cmdlše
, 
sh–l
);

190 
	`bufãr_­³nd_¡ršg
(
cmdlše
, 
wšdœ
);

191 
	`bufãr_­³nd_¡ršg_Ën
(
cmdlše
, 
	`CONST_STR_LEN
("\\system32\\cmd.exe"));

193 
	`bufãr_­³nd_¡ršg_Ën
(
cmdlše
, 
	`CONST_STR_LEN
(" /c "));

194 
	`bufãr_­³nd_¡ršg
(
cmdlše
, 
commªd
);

195 
´ocok
 = 
	`C»©eProûss
(
NULL
, 
cmdlše
->
±r
, &
£cur™y
, &£cur™y, 
TRUE
,

196 
NORMAL_PRIORITY_CLASS
, 
NULL
, NULL, &
si
, &
pi
);

198 ià(
FALSE
 =ğ
´ocok
) {

199 
	`årštf
(
¡d”r
, "çedØC»©eProûss: %s", 
cmdlše
->
±r
);

200 
	`bufãr_ä“
(
cmdlše
);

203 
	`bufãr_ä“
(
cmdlše
);

205 
´oc
->
chd
 = 
pi
.
hProûss
;

206 
	`Clo£HªdË
(
pi
.
hTh»ad
);

208 
	`´oc_şo£_chds
(
´oc
);

211 
	}
}

215 
	$´oc_şo£
(
´oc_hªdËr_t
 *
´oc
) {

216 
pid_t
 
chd
 = 
´oc
->child;

217 
w¡©us
;

218 
pid_t
 
wa™_pid
;

220 
	`´oc_şo£_pes
(
´oc
);

223 
wa™_pid
 = 
	`wa™pid
(
chd
, &
w¡©us
, 0);

224 } 
wa™_pid
 =ğ-1 && 
”ºo
 =ğ
EINTR
);

226 ià(
wa™_pid
 == -1) {

229 ià(
	`WIFEXITED
(
w¡©us
))

230 
w¡©us
 = 
	`WEXITSTATUS
(wstatus);

233  
w¡©us
;

234 
	}
}

237 
	$´oc_İ’
(
´oc_hªdËr_t
 *
´oc
, cÚ¡ *
commªd
) {

238 
pid_t
 
chd
;

239 cÚ¡ *
sh–l
;

241 ià(
NULL
 =ğ(
sh–l
 = 
	`g‘’v
(
SHELLENV
))) {

242 
sh–l
 = "/bin/sh";

245 ià(
	`´oc_İ’_pes
(
´oc
) != 0) {

251 
chd
 = 
	`fÜk
();

253 ià(
chd
 == 0) {

260 
	`´oc_şo£_·»Ás
(
´oc
);

262 
	`exeş
(
sh–l
, sh–l, "-c", 
commªd
, (*)
NULL
);

263 
	`årštf
(
¡d”r
, "çedØexecu‹ sh–l: % -ø%s: %s\n", 
sh–l
, 
commªd
, 
	`¡»¼Ü
(
”ºo
));

264 
	`_ex™
(127);

266 } ià(
chd
 < 0) {

267 
	`årštf
(
¡d”r
, "failedo forking");

268 
	`´oc_şo£
(
´oc
);

272 
´oc
->
chd
 = child;

273 
	`´oc_şo£_chds
(
´oc
);

276 
	}
}

281 
	$´oc_»ad_fd_to_bufãr
(
fd
, 
bufãr
 *
b
) {

282 
ssize_t
 
s
;

285 
	`bufãr_¡ršg_´•¬e_­³nd
(
b
, 1024);

286 ià((
s
 = 
	`»ad
(
fd
, (*)(
b
->
±r
 + 
	`bufãr_¡ršg_Ëngth
(b)), 
	`bufãr_¡ršg_¥aû
(b))) <= 0) {

289 
	`bufãr_comm™
(
b
, 
s
);

291 
	}
}

294 
	$´oc_İ’_bufãr
(cÚ¡ *
commªd
, 
bufãr
 *
š
, bufã¸*
out
, bufã¸*
”r
) {

295 
´oc_hªdËr_t
 
´oc
;

297 ià(
	`´oc_İ’
(&
´oc
, 
commªd
) != 0) {

301 ià(
š
) {

302 ià(
	`wr™e
(
´oc
.
š
.
fd
, 
	`CONST_BUF_LEN
(in)) < 0) {

303 
	`³¼Ü
("error writing…ipe");

307 
	`pe_şo£
(&
´oc
.
š
);

309 ià(
out
) {

310 
	`´oc_»ad_fd_to_bufãr
(
´oc
.
out
.
fd
, out);

312 
	`pe_şo£
(&
´oc
.
out
);

314 ià(
”r
) {

315 
	`´oc_»ad_fd_to_bufãr
(
´oc
.
”r
.
fd
,ƒrr);

317 
bufãr
 *
tmp
 = 
	`bufãr_š™
();

318 
	`´oc_»ad_fd_to_bufãr
(
´oc
.
”r
.
fd
, 
tmp
);

319 ià(!
	`bufãr_¡ršg_is_em±y
(
tmp
è&& 
	`wr™e
(2, 
	`CONST_BUF_LEN
(tmp)) < 0) {

320 
	`³¼Ü
("error writing…ipe");

321 
	`bufãr_ä“
(
tmp
);

324 
	`bufãr_ä“
(
tmp
);

326 
	`pe_şo£
(&
´oc
.
”r
);

328 
	`´oc_şo£
(&
´oc
);

331 
	}
}

335 #ifdeà
DEBUG_PROC_OPEN


336 
	$maš
() {

337 
´oc_hªdËr_t
 
´oc
;

338 
bufãr
 *
š
 = 
	`bufãr_š™
(), *
out
 = bufãr_š™(), *
”r
 = buffer_init();

339 
w¡©us
;

341 
	#FREE
() do { \

342 
	`bufãr_ä“
(
š
); \

343 
	`bufãr_ä“
(
out
); \

344 
	`bufãr_ä“
(
”r
); \

345 } 0)

	)

347 
	#RESET
() do { \

348 
	`bufãr_»£t
(
š
); \

349 
	`bufãr_»£t
(
out
); \

350 
	`bufãr_»£t
(
”r
); \

351 
w¡©us
 = 
	`´oc_şo£
(&
´oc
); \

352 ià(0&&
w¡©us
 != 0) { \

353 
	`årštf
(
¡dout
, "ex™¡©u %d\n", 
w¡©us
); \

354  
__LINE__
 - 200; \

356 } 0)

	)

358 
	#ERROR_OUT
() do { \

359 
	`årštf
(
¡dout
, "failed opening…roc\n"); \

360 
w¡©us
 = 
	`´oc_şo£
(&
´oc
); \

361 
	`årštf
(
¡dout
, "ex™¡©u %d\n", 
w¡©us
); \

362 
	`FREE
(); \

363  
__LINE__
 - 300; \

364 } 0)

	)

366 #ifdeà
WIN32


367 
	#CMD_CAT
 "·u£"

	)

369 
	#CMD_CAT
 "ÿt"

	)

373 
	`årštf
(
¡dout
, "test:ƒcho 123 without„ead\n");

374 ià(
	`´oc_İ’
(&
´oc
, "echo 321") != 0) {

375 
	`ERROR_OUT
();

377 
	`şo£_desütÜ
(
´oc
.
š
.
·»Á
);

378 
	`şo£_desütÜ
(
´oc
.
out
.
·»Á
);

379 
	`şo£_desütÜ
(
´oc
.
”r
.
·»Á
);

380 
	`RESET
();

382 
	`årštf
(
¡dout
, "‹¡:ƒchØ321 w™h„—d\n"); 
	`fæush
(stdout);

383 ià(
	`´oc_İ’_bufãr
("echØ321", 
NULL
, 
out
, 
”r
) != 0) {

384 
	`ERROR_OUT
();

386 
	`årštf
(
¡dout
, "»suÉ: ->%s<-\n\n", 
out
->
±r
); 
	`fæush
(stdout);

387 
	`RESET
();

389 
	`årštf
(
¡dout
, "‹¡:ƒchØ123 | " 
CMD_CAT
 "\n"); 
	`fæush
(stdout);

390 
	`bufãr_cİy_¡ršg_Ën
(
š
, 
	`CONST_STR_LEN
("123\n"));

391 ià(
	`´oc_İ’_bufãr
(
CMD_CAT
, 
š
, 
out
, 
”r
) != 0) {

392 
	`ERROR_OUT
();

394 
	`årštf
(
¡dout
, "»suÉ: ->%s<-\n\n", 
out
->
±r
); 
	`fæush
(stdout);

395 
	`RESET
();

398 #undeà
RESET


399 #undeà
ERROR_OUT


401 
	`årštf
(
¡dout
, "ok\n");

403 
	`FREE
();

405 
	}
}

	@proc_open.h

1 #iâdeà
LI_PROC_OPEN_H


2 
	#LI_PROC_OPEN_H


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

7 #ifdeà
WIN32


8 
	~<wšdows.h
>

9 
HANDLE
 
	tdesütÜ_t
;

10 
HANDLE
 
	t´oc_pid_t
;

12 
	tdesütÜ_t
;

13 
pid_t
 
	t´oc_pid_t
;

17 
desütÜ_t
 
	m·»Á
, 
	mchd
;

18 
	mfd
;

19 } 
	tpe_t
;

22 
pe_t
 
	mš
, 
	mout
, 
	m”r
;

23 
´oc_pid_t
 
	mchd
;

24 } 
	t´oc_hªdËr_t
;

26 
´oc_şo£
(
´oc_hªdËr_t
 *
ht
);

27 
´oc_İ’
(
´oc_hªdËr_t
 *
ht
, cÚ¡ *
commªd
);

28 
´oc_İ’_bufãr
(cÚ¡ *
commªd
, 
bufãr
 *
š
, bufã¸*
out
, bufã¸*
”r
);

	@rand.c

1 
	~"fœ¡.h
"

3 
	~"¿nd.h
"

4 
	~"ba£.h
"

5 
	~"fdev’t.h
"

6 
	~"§ã_memş—r.h
"

8 
	~<sys/ty³s.h
>

9 
	~<sys/¡©.h
>

10 
	~<”ºo.h
>

11 
	~<fú.h
>

12 
	~<¡dio.h
>

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<uni¡d.h
>

18 #ifdeà
USE_OPENSSL


19 
	~<İ’s¦/¿nd.h
>

21 #ifdeà
HAVE_LINUX_RANDOM_H


22 
	~<sys/sysÿÎ.h
>

23 
	~<lšux/¿ndom.h
>

25 #ifdeà
RNDGETENTCNT


26 
	~<sys/ioùl.h
>

59 
	$li_g‘’Œİy
 (*
buf
, 
size_t
 
buæ’
)

61 #ifdeà
HAVE_GETENTROPY


62  
	`g‘’Œİy
(
buf
, 
buæ’
);

65 #ià
	`defšed
(
HAVE_GETRANDOM
è|| defšed(
SYS_g‘¿ndom
)

66 ià(
buæ’
 <= 256) {

67 #ifdeà
HAVE_GETRANDOM


68 
num
 = 
	`g‘¿ndom
(
buf
, 
buæ’
, 0);

69 #–ià
	`defšed
(
SYS_g‘¿ndom
)

72 
num
 = ()
	`sysÿÎ
(
SYS_g‘¿ndom
, 
buf
, 
buæ’
, 0);

74 ià(
num
 =ğ()
buæ’
)  0;

75 ià(
num
 < 0) ‚um;

78 
	`UNUSED
(
buf
);

79 
	`UNUSED
(
buæ’
);

81 
”ºo
 = 
EIO
;

84 
	}
}

86 
	$li_¿nd_deviû_by‹s
 (*
buf
, 
num
)

91 cÚ¡ * cÚ¡ 
deviûs
[] = {

92 #ifdeà
__O³nBSD__


101 ià(0 =ğ
	`li_g‘’Œİy
(
buf
, (
size_t
)
num
))  1;

103 
u
 = 0; u < (
deviûs
)/(devices[0]); ++u) {

105 
fd
 = 
	`fdev’t_İ’_şÛxec
(
deviûs
[
u
], 
O_RDONLY
, 0);

106 ià(
fd
 >= 0) {

107 
ssize_t
 
rd
 = 0;

108 #ifdeà
RNDGETENTCNT


109 
’Œİy
;

110 ià(0 =ğ
	`ioùl
(
fd
, 
RNDGETENTCNT
, &
’Œİy
è&&ƒÁrİy >ğ
num
*8)

112 
rd
 = 
	`»ad
(
fd
, 
buf
, (
size_t
)
num
);

113 
	`şo£
(
fd
);

114 ià(
rd
 =ğ
num
) {

121 
	}
}

123 
	gli_¿nd_š™ed
;

124 
	gxsubi
[3];

126 
	$li_¿nd_š™
 ()

135 
u
;

136 
li_¿nd_š™ed
 = 1;

137 ià(1 =ğ
	`li_¿nd_deviû_by‹s
((*)
xsubi
, ()(xsubi))) {

138 
u
 = (()
xsubi
[0] << 16) | xsubi[1];

141 #ifdeà
HAVE_ARC4RANDOM_BUF


142 
u
 = 
	`¬c4¿ndom
();

143 
	`¬c4¿ndom_buf
(
xsubi
, (xsubi));

146 
	`¤ªd
(()(
	`time
(
NULL
è^ 
	`g‘pid
()));

147 
u
 = 0; u < (); ++u)

149 
xsubi
[
u
] = ()(
	`¿nd
() & 0xFFFF);

150 
u
 = (()
xsubi
[0] << 16) | xsubi[1];

153 
	`¤ªd
(
u
);

154 #ifdeà
HAVE_SRANDOM


155 
	`¤ªdom
(
u
);

157 #ifdeà
USE_OPENSSL


158 
	`RAND_pŞl
();

159 
	`RAND_£ed
(
xsubi
, ()(xsubi));

161 
	}
}

163 
	$li_¿nd_»£ed
 ()

165 ià(
li_¿nd_š™ed
è
	`li_¿nd_š™
();

166 
	}
}

168 
	$li_¿nd_p£udo_by‹s
 ()

172 #ifdeà
USE_OPENSSL


173 #ià
OPENSSL_VERSION_NUMBER
 < 0x10100000L || 
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

174 
i
;

175 ià(-1 !ğ
	`RAND_p£udo_by‹s
((*)&
i
, (i)))  i;

178 ià(!
li_¿nd_š™ed
è
	`li_¿nd_š™
();

179 #ifdeà
HAVE_ARC4RANDOM_BUF


180  ()
	`¬c4¿ndom
();

181 #–ià
	`defšed
(
HAVE_SRANDOM
)

183  ()
	`¿ndom
();

184 #–ià
	`defšed
(
HAVE_JRAND48
)

187  ()
	`j¿nd48
(
xsubi
);

190  
	`¿nd
();

192 
	}
}

194 
	$li_¿nd_by‹s
 (*
buf
, 
num
)

196 #ifdeà
USE_OPENSSL


197 
rc
 = 
	`RAND_by‹s
(
buf
, 
num
);

198 ià(-1 !ğ
rc
) {

199  
rc
;

202 ià(1 =ğ
	`li_¿nd_deviû_by‹s
(
buf
, 
num
)) {

207 
i
 = 0; i < 
num
; ++i)

208 
buf
[
i
] = 
	`li_¿nd_p£udo_by‹s
() & 0xFF;

212 
	}
}

214 
	$li_¿nd_ş—nup
 ()

216 #ifdeà
USE_OPENSSL


217 
	`RAND_ş—nup
();

219 
	`§ã_memş—r
(
xsubi
, (xsubi));

220 
	}
}

	@rand.h

1 #iâdeà
LI_RAND_H_


2 
	#LI_RAND_H_


	)

3 
	~"fœ¡.h
"

5 
li_¿nd_p£udo_by‹s
 ();

6 
li_¿nd_»£ed
 ();

7 
li_¿nd_by‹s
 (*
buf
, 
num
);

8 
li_¿nd_ş—nup
 ();

	@request.c

1 
	~"fœ¡.h
"

3 
	~"»que¡.h
"

4 
	~"keyv®ue.h
"

5 
	~"log.h
"

7 
	~<sys/¡©.h
>

9 
	~<lim™s.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dio.h
>

13 
	~<ùy³.h
>

15 
	$»que¡_check_ho¡Çme
(
bufãr
 *
ho¡
) {

16 ’um { 
DOMAINLABEL
, 
TOPLABEL
 } 
¡age
 = TOPLABEL;

17 
size_t
 
i
;

18 
Ïb–_Ën
 = 0;

19 
size_t
 
ho¡_Ën
, 
ho¡pÜt_Ën
;

20 *
cŞÚ
;

21 
is_
 = -1;

22 
Ëv–
 = 0;

36 ià(
ho¡
->
±r
[0] == '[') {

37 *
c
 = 
ho¡
->
±r
 + 1;

38 
cŞÚ_út
 = 0;

41 ; *
c
 && *c != ']'; c++) {

42 ià(*
c
 == ':') {

43 ià(++
cŞÚ_út
 > 7) {

46 } ià(!
	`light_isxdig™
(*
c
) && '.' != *c) {

52 ià(!*
c
) {

57 ià(*(
c
+1) == ':') {

58 
c
 += 2; *c; c++) {

59 ià(!
	`light_isdig™
(*
c
)) {

64 ià('\0' !ğ*(
c
+1)) {

71 
ho¡pÜt_Ën
 = 
ho¡_Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ho¡
);

73 ià(
NULL
 !ğ(
cŞÚ
 = 
	`memchr
(
ho¡
->
±r
, ':', 
ho¡_Ën
))) {

74 *
c
 = 
cŞÚ
 + 1;

77 ; *
c
; c++) {

78 ià(!
	`light_isdig™
(*
c
))  -1;

82 
ho¡_Ën
 = 
cŞÚ
 - 
ho¡
->
±r
;

86 ià(
ho¡_Ën
 == 0)  -1;

89 ià(
ho¡
->
±r
[
ho¡_Ën
-1] == '.') {

91 ià(
NULL
 !ğ
cŞÚ
è
	`memmove
(cŞÚ-1, cŞÚ, 
ho¡pÜt_Ën
 - 
ho¡_Ën
);

92 
	`bufãr_¡ršg_£t_Ëngth
(
ho¡
, --
ho¡pÜt_Ën
);

93 ià(--
ho¡_Ën
 == 0)  -1;

98 
i
 = 
ho¡_Ën
; i-- > 0; ) {

99 cÚ¡ 
c
 = 
ho¡
->
±r
[
i
];

101 
¡age
) {

102 
TOPLABEL
:

103 ià(
c
 == '.') {

105 ià(
i
 !ğ
ho¡_Ën
 - 1) {

106 ià(
Ïb–_Ën
 == 0) {

111 ià(
is_
 == 0) {

112 ià(!
	`light_i§Êum
(
ho¡
->
±r
[
i
+1])) {

115 } ià(!
	`light_isdig™
(
ho¡
->
±r
[
i
+1])) {

116 
is_
 = 0;

117 } ià('-' =ğ
ho¡
->
±r
[
i
+1]) {

121 
is_
 = 1;

124 
¡age
 = 
DOMAINLABEL
;

126 
Ïb–_Ën
 = 0;

127 
Ëv–
++;

128 } ià(
i
 == 0) {

132 } ià(
i
 == 0) {

134 ià(!
	`light_i§Êum
(
c
)) {

137 
Ïb–_Ën
++;

139 ià(
c
 !ğ'-' && !
	`light_i§Êum
(c)) {

142 ià(
is_
 == -1) {

143 ià(!
	`light_isdig™
(
c
)è
is_
 = 0;

145 
Ïb–_Ën
++;

149 
DOMAINLABEL
:

150 ià(
is_
 == 1) {

151 ià(
c
 == '.') {

152 ià(
Ïb–_Ën
 == 0) {

156 
Ïb–_Ën
 = 0;

157 
Ëv–
++;

158 } ià(!
	`light_isdig™
(
c
)) {

161 
Ïb–_Ën
++;

164 ià(
c
 == '.') {

165 ià(
Ïb–_Ën
 == 0) {

170 ià('-' =ğ
ho¡
->
±r
[
i
+1]) {

174 
Ïb–_Ën
 = 0;

175 
Ëv–
++;

176 } ià(
i
 == 0) {

177 ià(!
	`light_i§Êum
(
c
)) {

180 
Ïb–_Ën
++;

182 ià(
c
 !ğ'-' && !
	`light_i§Êum
(c)) {

185 
Ïb–_Ën
++;

194 ià(
is_
 =ğ1 && 
Ëv–
 != 3) {

198 ià(
Ïb–_Ën
 == 0) {

203 
	}
}

205 
	$h‰p_»que¡_ho¡_nÜm®ize
(
bufãr
 *
b
) {

233 cÚ¡ * cÚ¡ 
p
 = 
b
->
±r
;

234 cÚ¡ 
size_t
 
bËn
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

235 
pÜt
 = 0;

237 ià(*
p
 != '[') {

238 * cÚ¡ 
cŞÚ
 = (*)
	`memchr
(
p
, ':', 
bËn
);

239 ià(
cŞÚ
) {

240 ià(*
p
 == ':')  -1;

241 ià(
cŞÚ
[1] != '\0') {

242 *
e
;

243 
pÜt
 = 
	`¡¹Ş
(
cŞÚ
+1, &
e
, 0);

244 ià(0 < 
pÜt
 &&…Üˆ<ğ
USHRT_MAX
 && *
e
 == '\0') {

250 
	`bufãr_¡ršg_£t_Ëngth
(
b
, (
size_t
)(
cŞÚ
 - 
p
));

253 ià(
	`light_isdig™
(*
p
)) {

255 
š_addr
 
addr
;

256 #ià
	`defšed
(
HAVE_INET_ATON
)

257 ià(0 !ğ
	`š‘_©Ú
(
p
, &
addr
))

259 ià((
addr
.
s_addr
 = 
	`š‘_addr
(
p
)è!ğ
INADDR_NONE
)

262 #ià
	`defšed
(
HAVE_INET_PTON
)

263 #iâdeà
INET_ADDRSTRLEN


264 
	#INET_ADDRSTRLEN
 16

	)

266 
buf
[
INET_ADDRSTRLEN
];

267 
	`š‘_Áİ
(
AF_INET
, (cÚ¡ *)&
addr
, 
buf
, (buf));

268 
	`bufãr_cİy_¡ršg
(
b
, 
buf
);

270 
	`bufãr_cİy_¡ršg
(
b
, 
	`š‘_Áß
(
addr
));

275 #ià
	`defšed
(
HAVE_IPV6
è&& defšed(
HAVE_INET_PTON
)

277 
š6_addr
 
addr
;

278 *
b¿ck‘
 = 
b
->
±r
+
bËn
-1;

279 *
³rûÁ
 = 
	`¡rchr
(
b
->
±r
+1, '%');

280 
size_t
 
Ën
;

281 
rc
;

282 
buf
[
INET6_ADDRSTRLEN
+16];

283 ià(
bËn
 <= 2)  -1;

284 ià(*
b¿ck‘
 != ']') {

285 
b¿ck‘
 = (*)
	`memchr
(
b
->
±r
+1, ']', 
bËn
-1);

286 ià(
NULL
 =ğ
b¿ck‘
 || b¿ck‘[1] !ğ':' || b¿ck‘ - 
b
->
±r
 == 1){

289 ià(
b¿ck‘
[2] != '\0') {

290 *
e
;

291 
pÜt
 = 
	`¡¹Ş
(
b¿ck‘
+2, &
e
, 0);

292 ià(0 < 
pÜt
 &&…Üˆ<ğ
USHRT_MAX
 && *
e
 == '\0') {

300 *
b¿ck‘
 = '\0';

301 ià(
³rûÁ
) *percent = '\0';

302 
rc
 = 
	`š‘_±Ú
(
AF_INET6
, 
b
->
±r
+1, &
addr
);

303 ià(
³rûÁ
) *percent = '%';

304 *
b¿ck‘
 = ']';

305 ià(1 !ğ
rc
)  -1;

307 
	`š‘_Áİ
(
AF_INET6
,(cÚ¡ *)&
addr
, 
buf
, (buf));

308 
Ën
 = 
	`¡¾’
(
buf
);

309 ià(
³rûÁ
) {

310 ià(
³rûÁ
 > 
b¿ck‘
)  -1;

311 ià(
Ën
 + (
size_t
)(
b¿ck‘
 - 
³rûÁ
è>ğ(
buf
))  -1;

312 
	`memıy
(
buf
+
Ën
, 
³rûÁ
, (
size_t
)(
b¿ck‘
 -…ercent));

313 
Ën
 +ğ(
size_t
)(
b¿ck‘
 - 
³rûÁ
);

315 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 1);

316 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
buf
, 
Ën
);

317 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("]"));

326 ià(
pÜt
) {

327 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(":"));

328 
	`bufãr_­³nd_št
(
b
, ()
pÜt
);

332 
	}
}

335 
	#DUMP_HEADER


	)

338 
	$h‰p_»que¡_¥l™_v®ue
(
¬¿y
 *
v®s
, 
bufãr
 *
b
) {

339 
size_t
 
i
, 
Ën
;

340 
¡©e
 = 0;

342 cÚ¡ *
cu¼’t
;

343 cÚ¡ *
tok’_¡¬t
 = 
NULL
, *
tok’_’d
 = NULL;

352 ià(
	`bufãr_¡ršg_is_em±y
(
b
))  0;

354 
cu¼’t
 = 
b
->
±r
;

355 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

356 
i
 = 0; i <ğ
Ën
; ++i, ++
cu¼’t
) {

357 
d©a_¡ršg
 *
ds
;

359 
¡©e
) {

361 *
cu¼’t
) {

370 
tok’_¡¬t
 = 
tok’_’d
 = 
cu¼’t
;

371 
¡©e
 = 1;

376 *
cu¼’t
) {

383 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
v®s
, 
TYPE_STRING
))) {

384 
ds
 = 
	`d©a_¡ršg_š™
();

387 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
tok’_¡¬t
, 
tok’_’d
-token_start+1);

388 
	`¬¿y_š£¹_unique
(
v®s
, (
d©a_un£t
 *)
ds
);

390 
¡©e
 = 0;

394 
tok’_’d
 = 
cu¼’t
;

402 
	}
}

404 
	$»que¡_uri_is_v®id_ch¬
(
c
) {

405 ià(
c
 <= 32)  0;

406 ià(
c
 == 127)  0;

407 ià(
c
 == 255)  0;

410 
	}
}

412 
	$h‰p_»que¡_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

413 *
uri
 = 
NULL
, *
´Ùo
 = NULL, *
m‘hod
 = NULL, 
cÚ_Ëngth_£t
;

414 
is_key
 = 1, 
key_Ën
 = 0, 
is_ws_aá”_key
 = 0, 
š_fŞdšg
;

415 *
v®ue
 = 
NULL
, *
key
 = NULL;

416 *
»qlše_ho¡
 = 
NULL
;

417 
»qlše_ho¡Ën
 = 0;

419 ’um { 
HTTP_CONNECTION_UNSET
, 
HTTP_CONNECTION_KEEPALIVE
, 
HTTP_CONNECTION_CLOSE
 } 
k“p_®ive_£t
 = HTTP_CONNECTION_UNSET;

421 
lše
 = 0;

423 
»que¡_lše_¡age
 = 0;

424 
size_t
 
i
, 
fœ¡
, 
’
;

426 
dÚe
 = 0;

427 cÚ¡ 
h‰p_h—d”_¡riù
 = (
cÚ
->
cÚf
.
h‰p_·r£İts
 & 
HTTP_PARSEOPT_HEADER_STRICT
);

435 ià(
cÚ
->
cÚf
.
log_»que¡_h—d”
) {

436 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsdSb",

437 "fd:", 
cÚ
->
fd
,

438 "»que¡-Ën:", 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.request),

439 "\n", 
cÚ
->
»que¡
.request);

442 ià(
cÚ
->
»que¡_couÁ
 > 1 &&

443 
cÚ
->
»que¡
.»que¡->
±r
[0] == '\r' &&

444 
cÚ
->
»que¡
.»que¡->
±r
[1] == '\n') {

448 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
·r£_»que¡
, cÚ->
»que¡
.»que¡->
±r
 + 2, 
	`bufãr_¡ršg_Ëngth
(con->request.request) - 2);

451 
	`bufãr_cİy_bufãr
(
cÚ
->
·r£_»que¡
, cÚ->
»que¡
.request);

454 
k“p_®ive_£t
 = 0;

455 
cÚ_Ëngth_£t
 = 0;

463 
’
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
·r£_»que¡
);

464 
i
 = 0, 
fœ¡
 = 0; i < 
’
 && 
lše
 == 0; i++) {

465 
cÚ
->
·r£_»que¡
->
±r
[
i
]) {

467 ià(
cÚ
->
·r£_»que¡
->
±r
[
i
+1] == '\n') {

468 
h‰p_m‘hod_t
 
r
;

469 *
nuri
 = 
NULL
;

470 
size_t
 
j
, 
jËn
;

473 
cÚ
->
·r£_»que¡
->
±r
[
i
] = '\0';

474 
cÚ
->
·r£_»que¡
->
±r
[
i
+1] = '\0';

476 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
»que¡
.
»que¡_lše
, cÚ->
·r£_»que¡
->
±r
, 
i
);

478 ià(
»que¡_lše_¡age
 != 2) {

479 
cÚ
->
h‰p_¡©us
 = 400;

480 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

481 
cÚ
->
k“p_®ive
 = 0;

483 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

484 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "incomplete„equest†ine -> 400");

485 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

487 
cÚ
->
»que¡
.request);

492 
´Ùo
 = 
cÚ
->
·r£_»que¡
->
±r
 + 
fœ¡
;

494 *(
uri
 - 1) = '\0';

495 *(
´Ùo
 - 1) = '\0';

498 ià(
HTTP_METHOD_UNSET
 =ğ(
r
 = 
	`g‘_h‰p_m‘hod_key
(
m‘hod
))) {

499 
cÚ
->
h‰p_¡©us
 = 501;

500 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

501 
cÚ
->
k“p_®ive
 = 0;

503 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

504 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "unknown http-method -> 501");

505 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

507 
cÚ
->
»que¡
.request);

513 
cÚ
->
»que¡
.
h‰p_m‘hod
 = 
r
;

521 ià(0 =ğ
	`¡ºcmp
(
´Ùo
, "HTTP/", ("HTTP/") - 1)) {

522 * 
majÜ
 = 
´Ùo
 + ("HTTP/") - 1;

523 * 
mšÜ
 = 
	`¡rchr
(
majÜ
, '.');

524 *
”r
 = 
NULL
;

525 
majÜ_num
 = 0, 
mšÜ_num
 = 0;

527 
šv®id_v”siÚ
 = 0;

529 ià(
NULL
 =ğ
mšÜ
 ||

530 
mšÜ
 =ğ
majÜ
 ||

531 *(
mšÜ
 + 1) == '\0' ) {

532 
šv®id_v”siÚ
 = 1;

534 *
mšÜ
 = '\0';

535 
majÜ_num
 = 
	`¡¹Ş
(
majÜ
, &
”r
, 10);

537 ià(*
”r
 !ğ'\0'è
šv®id_v”siÚ
 = 1;

539 *
mšÜ
++ = '.';

540 
mšÜ_num
 = 
	`¡¹Ş
(
mšÜ
, &
”r
, 10);

542 ià(*
”r
 !ğ'\0'è
šv®id_v”siÚ
 = 1;

545 ià(
šv®id_v”siÚ
) {

546 
cÚ
->
h‰p_¡©us
 = 400;

547 
cÚ
->
k“p_®ive
 = 0;

549 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

550 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "unknown…rotocol -> 400");

551 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

553 
cÚ
->
»que¡
.request);

558 ià(
majÜ_num
 =ğ1 && 
mšÜ_num
 == 1) {

559 
cÚ
->
»que¡
.
h‰p_v”siÚ
 = cÚ->
cÚf
.
®low_h‰p11
 ? 
HTTP_VERSION_1_1
 : 
HTTP_VERSION_1_0
;

560 } ià(
majÜ_num
 =ğ1 && 
mšÜ_num
 == 0) {

561 
cÚ
->
»que¡
.
h‰p_v”siÚ
 = 
HTTP_VERSION_1_0
;

563 
cÚ
->
h‰p_¡©us
 = 505;

565 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

566 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "unknown HTTP version -> 505");

567 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

569 
cÚ
->
»que¡
.request);

574 
cÚ
->
h‰p_¡©us
 = 400;

575 
cÚ
->
k“p_®ive
 = 0;

577 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

578 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "unknown…rotocol -> 400");

579 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

581 
cÚ
->
»que¡
.request);

586 ià(0 =ğ
	`¡ºcmp
(
uri
, "http://", 7) &&

587 
NULL
 !ğ(
nuri
 = 
	`¡rchr
(
uri
 + 7, '/'))) {

588 
»qlše_ho¡
 = 
uri
 + 7;

589 
»qlše_ho¡Ën
 = 
nuri
 - 
»qlše_ho¡
;

591 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
»que¡
.
uri
, 
nuri
, 
´Ùo
 -‚uri - 1);

592 } ià(0 =ğ
	`¡ºcmp
(
uri
, "https://", 8) &&

593 
NULL
 !ğ(
nuri
 = 
	`¡rchr
(
uri
 + 8, '/'))) {

594 
»qlše_ho¡
 = 
uri
 + 8;

595 
»qlše_ho¡Ën
 = 
nuri
 - 
»qlše_ho¡
;

597 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
»que¡
.
uri
, 
nuri
, 
´Ùo
 -‚uri - 1);

600 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
»que¡
.
uri
, uri, 
´Ùo
 - uri - 1);

604 
jËn
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.
uri
);

605 ià(
h‰p_h—d”_¡riù
) {

606 
j
 = 0; j < 
jËn
 && 
	`»que¡_uri_is_v®id_ch¬
(
cÚ
->
»que¡
.
uri
->
±r
[j]); j++) ;

608 *
z
 = 
	`memchr
(
cÚ
->
»que¡
.
uri
->
±r
, '\0', 
jËn
);

609 
j
 = (
NULL
 =ğ
z
è? 
jËn
 : (
size_t
)(z - 
cÚ
->
»que¡
.
uri
->
±r
);

611 ià(
j
 < 
jËn
) {

612 
cÚ
->
h‰p_¡©us
 = 400;

613 
cÚ
->
k“p_®ive
 = 0;

615 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

616 
buf
[2];

617 
buf
[0] = 
cÚ
->
»que¡
.
uri
->
±r
[
j
];

618 
buf
[1] = '\0';

620 ià(
cÚ
->
»que¡
.
uri
->
±r
[
j
] > 32 &&

621 
cÚ
->
»que¡
.
uri
->
±r
[
j
] != 127) {

623 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

625 
buf
);

628 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

630 
cÚ
->
»que¡
.
uri
->
±r
[
j
]);

633 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

635 
cÚ
->
»que¡
.request);

641 
	`bufãr_cİy_bufãr
(
cÚ
->
»que¡
.
Üig_uri
, cÚ->»que¡.
uri
);

643 
cÚ
->
h‰p_¡©us
 = 0;

645 
i
++;

646 
lše
++;

647 
fœ¡
 = 
i
+1;

651 
»que¡_lše_¡age
) {

654 
m‘hod
 = 
cÚ
->
·r£_»que¡
->
±r
 + 
fœ¡
;

655 
fœ¡
 = 
i
 + 1;

659 
uri
 = 
cÚ
->
·r£_»que¡
->
±r
 + 
fœ¡
;

660 
fœ¡
 = 
i
 + 1;

664 
cÚ
->
h‰p_¡©us
 = 400;

665 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

666 
cÚ
->
k“p_®ive
 = 0;

668 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

669 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "overlong„equest†ine -> 400");

670 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

672 
cÚ
->
»que¡
.request);

677 
»que¡_lše_¡age
++;

682 
š_fŞdšg
 = 0;

684 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
uri
)) {

685 
cÚ
->
h‰p_¡©us
 = 400;

686 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

687 
cÚ
->
k“p_®ive
 = 0;

689 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

690 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "no uri specified -> 400");

691 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

693 
cÚ
->
»que¡
.request);

698 ià(
»qlše_ho¡
) {

700 
d©a_¡ršg
 *
ds
;

702 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
TYPE_STRING
))) {

703 
ds
 = 
	`d©a_¡ršg_š™
();

706 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, 
	`CONST_STR_LEN
("Host"));

707 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, 
»qlše_ho¡
, 
»qlše_ho¡Ën
);

708 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

709 
cÚ
->
»que¡
.
h‰p_ho¡
 = 
ds
->
v®ue
;

712 ; 
i
 <ğ
’
 && !
dÚe
; i++) {

713 *
cur
 = 
cÚ
->
·r£_»que¡
->
±r
 + 
i
;

715 ià(
is_key
) {

716 
size_t
 
j
;

717 
gÙ_cŞÚ
 = 0;

724 *
cur
) {

726 
is_key
 = 0;

728 
v®ue
 = 
cur
 + 1;

730 ià(
is_ws_aá”_key
 == 0) {

731 
key_Ën
 = 
i
 - 
fœ¡
;

733 
is_ws_aá”_key
 = 0;

752 
cÚ
->
h‰p_¡©us
 = 400;

753 
cÚ
->
k“p_®ive
 = 0;

754 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

756 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

757 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsds",

758 "šv®id ch¬aù” iÀkey", 
cÚ
->
»que¡
.»que¡, 
cur
, *cur, "-> 400");

760 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

762 
cÚ
->
»que¡
.request);

767 ià(
i
 =ğ
fœ¡
) {

768 
is_key
 = 0;

769 
š_fŞdšg
 = 1;

770 
v®ue
 = 
cur
;

776 
key_Ën
 = 
i
 - 
fœ¡
;

779 
j
 = 1; !
gÙ_cŞÚ
; j++) {

780 
cÚ
->
·r£_»que¡
->
±r
[
j
 + 
i
]) {

788 
i
 +ğ
j
 - 1;

789 
gÙ_cŞÚ
 = 1;

790 
is_ws_aá”_key
 = 1;

796 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

797 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "WS character in key -> 400");

798 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

800 
cÚ
->
»que¡
.request);

803 
cÚ
->
h‰p_¡©us
 = 400;

804 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

805 
cÚ
->
k“p_®ive
 = 0;

813 ià(
cÚ
->
·r£_»que¡
->
±r
[
i
+1] =ğ'\n' && i =ğ
fœ¡
) {

815 
cÚ
->
·r£_»que¡
->
±r
[
i
] = '\0';

816 
cÚ
->
·r£_»que¡
->
±r
[
i
+1] = '\0';

818 
i
++;

820 
dÚe
 = 1;

822 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

823 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "CR without LF -> 400");

824 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

826 
cÚ
->
»que¡
.request);

829 
cÚ
->
h‰p_¡©us
 = 400;

830 
cÚ
->
k“p_®ive
 = 0;

831 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

836 ià(
h‰p_h—d”_¡riù
 ? (*
cur
 < 32 || (()*cur) >= 127) : *cur == '\0') {

837 
cÚ
->
h‰p_¡©us
 = 400;

838 
cÚ
->
k“p_®ive
 = 0;

839 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

841 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

842 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsds",

843 "šv®id ch¬aù” iÀkey", 
cÚ
->
»que¡
.»que¡, 
cur
, *cur, "-> 400");

845 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

847 
cÚ
->
»que¡
.request);

856 *
cur
) {

858 ià(
cÚ
->
·r£_»que¡
->
±r
[
i
+1] == '\n') {

859 
d©a_¡ršg
 *
ds
 = 
NULL
;

862 
cÚ
->
·r£_»que¡
->
±r
[
i
] = '\0';

863 
cÚ
->
·r£_»que¡
->
±r
[
i
+1] = '\0';

865 ià(
š_fŞdšg
) {

866 
bufãr
 *
key_b
;

876 ià(!
key
 || !
key_Ën
) {

879 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

880 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "WS‡the start of first†ine -> 400");

882 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

884 
cÚ
->
»que¡
.request);

888 
cÚ
->
h‰p_¡©us
 = 400;

889 
cÚ
->
k“p_®ive
 = 0;

890 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

894 
key_b
 = 
	`bufãr_š™
();

895 
	`bufãr_cİy_¡ršg_Ën
(
key_b
, 
key
, 
key_Ën
);

897 ià(
NULL
 !ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
key_b
->
±r
))) {

898 
	`bufãr_­³nd_¡ršg
(
ds
->
v®ue
, value);

901 
	`bufãr_ä“
(
key_b
);

903 
s_Ën
;

904 
key
 = 
cÚ
->
·r£_»que¡
->
±r
 + 
fœ¡
;

906 
s_Ën
 = 
cur
 - 
v®ue
;

909 ; 
s_Ën
 > 0 &&

910 (
v®ue
[
s_Ën
 - 1] == ' ' ||

911 
v®ue
[
s_Ën
 - 1] == '\t'); s_len--);

913 
v®ue
[
s_Ën
] = '\0';

915 ià(
s_Ën
 > 0) {

916 
cmp
 = 0;

917 ià(
NULL
 =ğ(
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
»que¡
.
h—d”s
, 
TYPE_STRING
))) {

918 
ds
 = 
	`d©a_¡ršg_š™
();

920 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
key
, key, 
key_Ën
);

921 
	`bufãr_cİy_¡ršg_Ën
(
ds
->
v®ue
, v®ue, 
s_Ën
);

929 ià(0 =ğ(
cmp
 = 
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("Connection")))) {

930 
¬¿y
 *
v®s
;

931 
size_t
 
vi
;

935 
v®s
 = 
¤v
->
¥l™_v®s
;

937 
	`¬¿y_»£t
(
v®s
);

939 
	`h‰p_»que¡_¥l™_v®ue
(
v®s
, 
ds
->
v®ue
);

941 
vi
 = 0; v˜< 
v®s
->
u£d
; vi++) {

942 
d©a_¡ršg
 *
dsv
 = (d©a_¡ršg *)
v®s
->
d©a
[
vi
];

944 ià(0 =ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
dsv
->
v®ue
), 
	`CONST_STR_LEN
("keep-alive"))) {

945 
k“p_®ive_£t
 = 
HTTP_CONNECTION_KEEPALIVE
;

948 } ià(0 =ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
dsv
->
v®ue
), 
	`CONST_STR_LEN
("close"))) {

949 
k“p_®ive_£t
 = 
HTTP_CONNECTION_CLOSE
;

955 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("Content-Length")))) {

956 *
”r
;

957 
off_t
 
r
;

958 
size_t
 
j
, 
jËn
;

960 ià(
cÚ_Ëngth_£t
) {

961 
cÚ
->
h‰p_¡©us
 = 400;

962 
cÚ
->
k“p_®ive
 = 0;

964 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

965 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

967 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

969 
cÚ
->
»que¡
.request);

971 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

975 
jËn
 = 
	`bufãr_¡ršg_Ëngth
(
ds
->
v®ue
);

976 
j
 = 0; j < 
jËn
; j++) {

977 
c
 = 
ds
->
v®ue
->
±r
[
j
];

978 ià(!
	`isdig™
(()
c
)) {

979 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

980 "cÚ‹Á-Ëngth brok’:", 
ds
->
v®ue
, "-> 400");

982 
cÚ
->
h‰p_¡©us
 = 400;

983 
cÚ
->
k“p_®ive
 = 0;

985 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

990 
r
 = 
	`¡¹Şl
(
ds
->
v®ue
->
±r
, &
”r
, 10);

992 ià(*
”r
 =ğ'\0' && 
r
 >= 0) {

993 
cÚ_Ëngth_£t
 = 1;

994 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 = 
r
;

996 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

997 "cÚ‹Á-Ëngth brok’:", 
ds
->
v®ue
, "-> 400");

999 
cÚ
->
h‰p_¡©us
 = 400;

1000 
cÚ
->
k“p_®ive
 = 0;

1002 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1005 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("Content-Type")))) {

1007 ià(!
cÚ
->
»que¡
.
h‰p_cÚ‹Á_ty³
) {

1008 
cÚ
->
»que¡
.
h‰p_cÚ‹Á_ty³
 = 
ds
->
v®ue
->
±r
;

1010 
cÚ
->
h‰p_¡©us
 = 400;

1011 
cÚ
->
k“p_®ive
 = 0;

1013 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1014 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1016 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

1018 
cÚ
->
»que¡
.request);

1020 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1023 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("Expect")))) {

1039 ià(
¤v
->
¤vcÚf
.
»jeù_ex³ù_100_w™h_417
 && 0 =ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
v®ue
), 
	`CONST_STR_LEN
("100-continue"))) {

1040 
cÚ
->
h‰p_¡©us
 = 417;

1041 
cÚ
->
k“p_®ive
 = 0;

1042 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1045 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("Host")))) {

1046 ià(
»qlše_ho¡
) {

1048 
ds
->
	`ä“
((
d©a_un£t
*) ds);

1049 
ds
 = 
NULL
;

1050 } ià(!
cÚ
->
»que¡
.
h‰p_ho¡
) {

1051 
cÚ
->
»que¡
.
h‰p_ho¡
 = 
ds
->
v®ue
;

1053 
cÚ
->
h‰p_¡©us
 = 400;

1054 
cÚ
->
k“p_®ive
 = 0;

1056 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1057 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1059 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

1061 
cÚ
->
»que¡
.request);

1063 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1066 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("If-Modified-Since")))) {

1070 ià(!
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
) {

1071 
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
 = 
ds
->
v®ue
->
±r
;

1072 } ià(0 =ğ
	`¡rÿ£cmp
(
cÚ
->
»que¡
.
h‰p_if_modif›d_sšû
,

1073 
ds
->
v®ue
->
±r
)) {

1076 
ds
->
	`ä“
((
d©a_un£t
 *)ds);

1077 
ds
 = 
NULL
;

1079 
cÚ
->
h‰p_¡©us
 = 400;

1080 
cÚ
->
k“p_®ive
 = 0;

1082 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1083 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1085 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

1087 
cÚ
->
»que¡
.request);

1089 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1092 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("If-None-Match")))) {

1094 ià(!
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
) {

1095 
cÚ
->
»que¡
.
h‰p_if_nÚe_m©ch
 = 
ds
->
v®ue
->
±r
;

1097 
ds
->
	`ä“
((
d©a_un£t
*) ds);

1098 
ds
 = 
NULL
;

1100 } ià(
cmp
 > 0 && 0 =ğ(cm°ğ
	`bufãr_ÿ£Ëss_com·»
(
	`CONST_BUF_LEN
(
ds
->
key
), 
	`CONST_STR_LEN
("Range")))) {

1101 ià(!
cÚ
->
»que¡
.
h‰p_¿nge
) {

1104 ià(0 =ğ
	`¡ºÿ£cmp
(
ds
->
v®ue
->
±r
, "bytes=", 6) &&

1105 
NULL
 !ğ
	`¡rchr
(
ds
->
v®ue
->
±r
+6, '-')) {

1108 
cÚ
->
»que¡
.
h‰p_¿nge
 = 
ds
->
v®ue
->
±r
 + 6;

1111 
cÚ
->
h‰p_¡©us
 = 400;

1112 
cÚ
->
k“p_®ive
 = 0;

1114 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1115 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1117 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

1119 
cÚ
->
»que¡
.request);

1121 
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)
ds
);

1126 ià(
ds
è
	`¬¿y_š£¹_unique
(
cÚ
->
»que¡
.
h—d”s
, (
d©a_un£t
 *)ds);

1132 
i
++;

1133 
fœ¡
 = 
i
+1;

1134 
is_key
 = 1;

1135 
v®ue
 = 
NULL
;

1140 
key_Ën
 = 0;

1142 
š_fŞdšg
 = 0;

1144 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1145 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1146 "CR w™houˆLF", 
cÚ
->
»que¡
.request, "-> 400");

1149 
cÚ
->
h‰p_¡©us
 = 400;

1150 
cÚ
->
k“p_®ive
 = 0;

1151 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

1158 ià(
v®ue
 =ğ
cur
) value = cur+1;

1161 ià(
h‰p_h—d”_¡riù
 ? (*
cur
 >= 0 && *cur < 32) : *cur == '\0') {

1162 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1163 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sds",

1164 "šv®id ch¬ iÀh—d”", ()*
cur
, "-> 400");

1167 
cÚ
->
h‰p_¡©us
 = 400;

1168 
cÚ
->
k“p_®ive
 = 0;

1177 
cÚ
->
h—d”_Ën
 = 
i
;

1181 ià(
cÚ
->
»que¡
.
h‰p_v”siÚ
 =ğ
HTTP_VERSION_1_1
) {

1182 ià(
k“p_®ive_£t
 !ğ
HTTP_CONNECTION_CLOSE
) {

1186 
cÚ
->
k“p_®ive
 = 1;

1188 
cÚ
->
k“p_®ive
 = 0;

1192 ià(
cÚ
->
»que¡
.
h‰p_ho¡
 =ğ
NULL
 ||

1193 
	`bufãr_¡ršg_is_em±y
(
cÚ
->
»que¡
.
h‰p_ho¡
)) {

1194 
cÚ
->
h‰p_¡©us
 = 400;

1195 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

1196 
cÚ
->
k“p_®ive
 = 0;

1198 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1199 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "HTTP/1.1 but Host missing -> 400");

1200 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

1202 
cÚ
->
»que¡
.request);

1207 ià(
k“p_®ive_£t
 =ğ
HTTP_CONNECTION_KEEPALIVE
) {

1211 
cÚ
->
k“p_®ive
 = 1;

1213 
cÚ
->
k“p_®ive
 = 0;

1218 ià(!
	`bufãr_is_em±y
(
cÚ
->
»que¡
.
h‰p_ho¡
) &&

1219 (((
cÚ
->
cÚf
.
h‰p_·r£İts
 & 
HTTP_PARSEOPT_HOST_STRICT
) &&

1220 0 !ğ
	`»que¡_check_ho¡Çme
(
cÚ
->
»que¡
.
h‰p_ho¡
))

1221 || ((
cÚ
->
cÚf
.
h‰p_·r£İts
 & 
HTTP_PARSEOPT_HOST_NORMALIZE
) &&

1222 0 !ğ
	`h‰p_»que¡_ho¡_nÜm®ize
(
cÚ
->
»que¡
.
h‰p_ho¡
)))) {

1224 ià(
¤v
->
¤vcÚf
.
log_»que¡_h—d”_Ú_”rÜ
) {

1225 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1227 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "Sb",

1229 
cÚ
->
»que¡
.request);

1232 
cÚ
->
h‰p_¡©us
 = 400;

1233 
cÚ
->
»¥Ú£
.
k“p_®ive
 = 0;

1234 
cÚ
->
k“p_®ive
 = 0;

1240 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Transfer-Encoding");

1241 ià(
NULL
 !ğ
ds
) {

1242 ià(
cÚ
->
»que¡
.
h‰p_v”siÚ
 =ğ
HTTP_VERSION_1_0
) {

1243 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1245 
cÚ
->
k“p_®ive
 = 0;

1246 
cÚ
->
h‰p_¡©us
 = 400;

1250 ià(0 !ğ
	`¡rÿ£cmp
(
ds
->
v®ue
->
±r
, "chunked")) {

1253 
cÚ
->
k“p_®ive
 = 0;

1254 
cÚ
->
h‰p_¡©us
 = 501;

1260 
	`bufãr_»£t
(
ds
->
v®ue
);

1262 
cÚ_Ëngth_£t
 = 1;

1263 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 = -1;

1266 
ds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_–em’t
(
cÚ
->
»que¡
.
h—d”s
, "Content-Length");

1267 ià(
NULL
 !ğ
ds
è
	`bufãr_»£t
(ds->
v®ue
);

1271 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

1272 
HTTP_METHOD_GET
:

1273 
HTTP_METHOD_HEAD
:

1275 ià(
cÚ_Ëngth_£t
 && 
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 != 0) {

1277 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1280 
cÚ
->
k“p_®ive
 = 0;

1281 
cÚ
->
h‰p_¡©us
 = 400;

1285 
HTTP_METHOD_POST
:

1287 ià(!
cÚ_Ëngth_£t
) {

1289 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1292 
cÚ
->
k“p_®ive
 = 0;

1293 
cÚ
->
h‰p_¡©us
 = 411;

1304 ià(
cÚ_Ëngth_£t
) {

1306 ià(
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 != 0) {

1312 
	}
}

1314 
	$h‰p_»que¡_h—d”_fšished
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

1315 
	`UNUSED
(
¤v
);

1317 ià(
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.request) < 4)  0;

1319 ià(0 =ğ
	`memcmp
(
cÚ
->
»que¡
.»que¡->
±r
 + 
	`bufãr_¡ršg_Ëngth
(cÚ->»que¡.»que¡è- 4, 
	`CONST_STR_LEN
("\r\n\r\n")))  1;

1320 ià(
NULL
 !ğ
	`¡r¡r
(
cÚ
->
»que¡
.»que¡->
±r
, "\r\n\r\n"))  1;

1323 
	}
}

	@request.h

1 #iâdeà
_REQUEST_H_


2 
	#_REQUEST_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£rv”.h
"

8 
	mHTTP_PARSEOPT_HEADER_STRICT
 = 1

9 ,
	mHTTP_PARSEOPT_HOST_STRICT
 = 2

10 ,
	mHTTP_PARSEOPT_HOST_NORMALIZE
 = 4

11 } 
	th‰p_·r£İts_e
;

13 
h‰p_»que¡_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

14 
h‰p_»que¡_h—d”_fšished
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

15 
h‰p_»que¡_ho¡_nÜm®ize
(
bufãr
 *
b
);

	@response.c

1 
	~"fœ¡.h
"

3 
	~"»¥Ú£.h
"

4 
	~"keyv®ue.h
"

5 
	~"log.h
"

6 
	~"¡©_ÿche.h
"

7 
	~"chunk.h
"

9 
	~"cÚfigfe.h
"

11 
	~"¶ugš.h
"

13 
	~<sys/ty³s.h
>

14 
	~<sys/¡©.h
>

16 
	~<lim™s.h
>

17 
	~<”ºo.h
>

18 
	~<fú.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

21 
	~<time.h
>

22 
	~<uni¡d.h
>

23 
	~<ùy³.h
>

24 
	~<as£¹.h
>

26 
	~<¡dio.h
>

28 
	~"sys-sock‘.h
"

30 
	$h‰p_»¥Ú£_wr™e_h—d”
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

31 
bufãr
 *
b
;

32 
size_t
 
i
;

33 
have_d©e
 = 0;

34 
have_£rv”
 = 0;

36 
b
 = 
	`bufãr_š™
();

38 ià(
cÚ
->
»que¡
.
h‰p_v”siÚ
 =ğ
HTTP_VERSION_1_1
) {

39 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("HTTP/1.1 "));

41 
	`bufãr_cİy_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("HTTP/1.0 "));

43 
	`bufãr_­³nd_št
(
b
, 
cÚ
->
h‰p_¡©us
);

44 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(" "));

45 
	`bufãr_­³nd_¡ršg
(
b
, 
	`g‘_h‰p_¡©us_Çme
(
cÚ
->
h‰p_¡©us
));

48 ià(
cÚ
->
»que¡_couÁ
 > cÚ->
cÚf
.
max_k“p_®ive_»que¡s
 || 0 =ğcÚ->cÚf.
max_k“p_®ive_idË
) {

49 
cÚ
->
k“p_®ive
 = 0;

51 
cÚ
->
k“p_®ive_idË
 = cÚ->
cÚf
.
max_k“p_®ive_idË
;

54 ià(
cÚ
->
»que¡
.
h‰p_v”siÚ
 !ğ
HTTP_VERSION_1_1
 || cÚ->
k“p_®ive
 == 0) {

55 ià(
cÚ
->
k“p_®ive
) {

56 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Connection"), CONST_STR_LEN("keep-alive"));

58 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Connection"), CONST_STR_LEN("close"));

62 ià(
cÚ
->
»¥Ú£
.
Œªsãr_’codšg
 & 
HTTP_TRANSFER_ENCODING_CHUNKED
) {

63 
	`»¥Ú£_h—d”_ov”wr™e
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Transfer-Encoding"), CONST_STR_LEN("chunked"));

68 
i
 = 0; i < 
cÚ
->
»¥Ú£
.
h—d”s
->
u£d
; i++) {

69 
d©a_¡ršg
 *
ds
;

71 
ds
 = (
d©a_¡ršg
 *)
cÚ
->
»¥Ú£
.
h—d”s
->
d©a
[
i
];

73 ià(!
	`bufãr_is_em±y
(
ds
->
v®ue
è&& !bufãr_is_em±y(ds->
key
) &&

74 0 !ğ
	`¡ºÿ£cmp
(
ds
->
key
->
±r
, 
	`CONST_STR_LEN
("X-LIGHTTPD-")) &&

75 0 !ğ
	`¡ºÿ£cmp
(
ds
->
key
->
±r
, 
	`CONST_STR_LEN
("X-Sendfile"))) {

76 ià(0 =ğ
	`¡rÿ£cmp
(
ds
->
key
->
±r
, "D©e")è
have_d©e
 = 1;

77 ià(0 =ğ
	`¡rÿ£cmp
(
ds
->
key
->
±r
, "S”v”")è
have_£rv”
 = 1;

78 ià(0 =ğ
	`¡rÿ£cmp
(
ds
->
key
->
±r
, "CÚ‹Á-Encodšg"è&& 304 =ğ
cÚ
->
h‰p_¡©us
) ;

80 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n"));

81 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
key
);

82 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
(": "));

87 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
ds
->
v®ue
), 
ENCODING_HTTP_HEADER
);

89 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
ds
->
v®ue
);

94 ià(!
have_d©e
) {

96 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\nDate: "));

99 ià(
¤v
->
cur_ts
 !ğ¤v->
Ï¡_g’”©ed_d©e_ts
) {

100 
	`bufãr_¡ršg_´•¬e_cİy
(
¤v
->
ts_d©e_¡r
, 255);

102 
	`bufãr_­³nd_¡ráime
(
¤v
->
ts_d©e_¡r
, "%a, %d %b %Y %H:%M:%S GMT", 
	`gmtime
(&(¤v->
cur_ts
)));

104 
¤v
->
Ï¡_g’”©ed_d©e_ts
 = srv->
cur_ts
;

107 
	`bufãr_­³nd_¡ršg_bufãr
(
b
, 
¤v
->
ts_d©e_¡r
);

110 ià(!
have_£rv”
) {

111 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
cÚf
.
£rv”_g
)) {

112 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\nServer: "));

113 
	`bufãr_­³nd_¡ršg_’coded
(
b
, 
	`CONST_BUF_LEN
(
cÚ
->
cÚf
.
£rv”_g
), 
ENCODING_HTTP_HEADER
);

117 
	`bufãr_­³nd_¡ršg_Ën
(
b
, 
	`CONST_STR_LEN
("\r\n\r\n"));

119 
cÚ
->
by‹s_h—d”
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

121 ià(
cÚ
->
cÚf
.
log_»¥Ú£_h—d”
) {

122 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sSb", "Re¥Ú£-H—d”:", "\n", 
b
);

125 
	`chunkqueue_´•’d_bufãr
(
cÚ
->
wr™e_queue
, 
b
);

126 
	`bufãr_ä“
(
b
);

129 
	}
}

131 #ifdeà
USE_OPENSSL


132 
	~<İ’s¦/bn.h
>

133 
	~<İ’s¦/”r.h
>

134 
	$h‰ps_add_s¦_ş›Á_’Œ›s
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

135 
X509
 *
xs
;

136 
X509_NAME
 *
xn
;

137 
i
, 
ÃÁr›s
;

139 
vr
 = 
	`SSL_g‘_v”ify_»suÉ
(
cÚ
->
s¦
);

140 ià(
vr
 !ğ
X509_V_OK
) {

141 
”r¡r
[256];

142 
	`ERR_”rÜ_¡ršg_n
(
vr
, 
”r¡r
, (errstr));

143 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("FAILED:"));

144 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
”r¡r
);

145 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

146 
	`CONST_STR_LEN
("SSL_CLIENT_VERIFY"),

147 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
));

149 } ià(!(
xs
 = 
	`SSL_g‘_³”_û¹ifiÿ‹
(
cÚ
->
s¦
))) {

150 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

151 
	`CONST_STR_LEN
("SSL_CLIENT_VERIFY"),

152 
	`CONST_STR_LEN
("NONE"));

155 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

156 
	`CONST_STR_LEN
("SSL_CLIENT_VERIFY"),

157 
	`CONST_STR_LEN
("SUCCESS"));

160 
	`bufãr_cİy_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("SSL_CLIENT_S_DN_"));

161 
xn
 = 
	`X509_g‘_subjeù_Çme
(
xs
);

162 
i
 = 0, 
ÃÁr›s
 = 
	`X509_NAME_’Œy_couÁ
(
xn
); i <‚entries; ++i) {

163 
xobjnid
;

164 cÚ¡ * 
xobj¢
;

165 
X509_NAME_ENTRY
 *
xe
;

167 ià(!(
xe
 = 
	`X509_NAME_g‘_’Œy
(
xn
, 
i
))) {

170 
xobjnid
 = 
	`OBJ_obj2nid
((
ASN1_OBJECT
*)
	`X509_NAME_ENTRY_g‘_objeù
(
xe
));

171 
xobj¢
 = 
	`OBJ_nid2¢
(
xobjnid
);

172 ià(
xobj¢
) {

173 
	`bufãr_¡ršg_£t_Ëngth
(
¤v
->
tmp_buf
, ("SSL_CLIENT_S_DN_")-1);

174 
	`bufãr_­³nd_¡ršg
(
¤v
->
tmp_buf
, 
xobj¢
);

175 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

176 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
),

177 (cÚ¡ *)
	`X509_NAME_ENTRY_g‘_d©a
(
xe
)->
d©a
,

178 
	`X509_NAME_ENTRY_g‘_d©a
(
xe
)->
Ëngth
);

183 
ASN1_INTEGER
 *
x¢
 = 
	`X509_g‘_£rŸlNumb”
(
xs
);

184 
BIGNUM
 *
£rŸlBN
 = 
	`ASN1_INTEGER_to_BN
(
x¢
, 
NULL
);

185 *
£rŸlHex
 = 
	`BN_bn2hex
(
£rŸlBN
);

186 
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
,

187 
	`CONST_STR_LEN
("SSL_CLIENT_M_SERIAL"),

188 
£rŸlHex
, 
	`¡¾’
(serialHex));

189 
	`OPENSSL_ä“
(
£rŸlHex
);

190 
	`BN_ä“
(
£rŸlBN
);

193 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
cÚf
.
s¦_v”ifyş›Á_u£ºame
)) {

197 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
	`¬¿y_g‘_–em’t
(
cÚ
->
’vœÚm’t
, cÚ->
cÚf
.
s¦_v”ifyş›Á_u£ºame
->
±r
);

198 ià(
ds
è
	`¬¿y_£t_key_v®ue
(
cÚ
->
’vœÚm’t
, 
	`CONST_STR_LEN
("REMOTE_USER"), 
	`CONST_BUF_LEN
(ds->
v®ue
));

201 ià(
cÚ
->
cÚf
.
s¦_v”ifyş›Á_expÜt_û¹
) {

202 
BIO
 *
bio
;

203 ià(
NULL
 !ğ(
bio
 = 
	`BIO_Ãw
(
	`BIO_s_mem
()))) {

204 
d©a_¡ršg
 *
’vds
;

205 
n
;

207 
	`PEM_wr™e_bio_X509
(
bio
, 
xs
);

208 
n
 = 
	`BIO_³ndšg
(
bio
);

210 ià(
NULL
 =ğ(
’vds
 = (
d©a_¡ršg
 *)
	`¬¿y_g‘_unu£d_–em’t
(
cÚ
->
’vœÚm’t
, 
TYPE_STRING
))) {

211 
’vds
 = 
	`d©a_¡ršg_š™
();

214 
	`bufãr_cİy_¡ršg_Ën
(
’vds
->
key
, 
	`CONST_STR_LEN
("SSL_CLIENT_CERT"));

215 
	`bufãr_¡ršg_´•¬e_cİy
(
’vds
->
v®ue
, 
n
);

216 
	`BIO_»ad
(
bio
, 
’vds
->
v®ue
->
±r
, 
n
);

217 
	`BIO_ä“
(
bio
);

218 
	`bufãr_comm™
(
’vds
->
v®ue
, 
n
);

219 
	`¬¿y_»¶aû
(
cÚ
->
’vœÚm’t
, (
d©a_un£t
 *)
’vds
);

222 
	`X509_ä“
(
xs
);

223 
	}
}

227 
hªdËr_t
 
	$h‰p_»¥Ú£_´•¬e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
) {

228 
hªdËr_t
 
r
;

231 ià(
cÚ
->
mode
 =ğ
DIRECT
 &&

232 (
cÚ
->
h‰p_¡©us
 != 0 && con->http_status != 200)) {

234 ià(
cÚ
->
fe_fšished
 == 0) {

235 
	`chunkqueue_»£t
(
cÚ
->
wr™e_queue
);

238  
HANDLER_FINISHED
;

242 ià(
cÚ
->
mode
 =ğ
DIRECT
 && 
	`bufãr_is_em±y
(cÚ->
physiÿl
.
·th
)) {

243 *
q¡r
;

257 
	`cÚfig_cÚd_ÿche_»£t
(
¤v
, 
cÚ
);

258 
	`cÚfig_£tup_cÚÃùiÚ
(
¤v
, 
cÚ
);

260 ià(
cÚ
->
cÚf
.
log_cÚd™iÚ_hªdlšg
) {

261 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "run condition");

287 ià(
cÚ
->
¤v_sock‘
->
is_s¦
) {

288 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
uri
.
scheme
, 
	`CONST_STR_LEN
("https"));

290 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
uri
.
scheme
, 
	`CONST_STR_LEN
("http"));

292 
	`bufãr_cİy_bufãr
(
cÚ
->
uri
.
authÜ™y
, cÚ->
»que¡
.
h‰p_ho¡
);

293 
	`bufãr_to_low”
(
cÚ
->
uri
.
authÜ™y
);

296 ià(
NULL
 !ğ(
q¡r
 = 
	`¡rchr
(
cÚ
->
»que¡
.
uri
->
±r
, '#'))) {

297 
	`bufãr_¡ršg_£t_Ëngth
(
cÚ
->
»que¡
.
uri
, 
q¡r
 - cÚ->»que¡.uri->
±r
);

301 ià(
NULL
 !ğ(
q¡r
 = 
	`¡rchr
(
cÚ
->
»que¡
.
uri
->
±r
, '?'))) {

302 
	`bufãr_cİy_¡ršg
 (
cÚ
->
uri
.
qu”y
, 
q¡r
 + 1);

303 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
uri
.
·th_¿w
, cÚ->
»que¡
.uri->
±r
, 
q¡r
 - con->request.uri->ptr);

305 
	`bufãr_»£t
 (
cÚ
->
uri
.
qu”y
);

306 
	`bufãr_cİy_bufãr
(
cÚ
->
uri
.
·th_¿w
, cÚ->
»que¡
.uri);

315 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_OPTIONS
 &&

316 
cÚ
->
uri
.
·th_¿w
->
±r
[0] == '*' && con->uri.path_raw->ptr[1] == '\0') {

318 
	`bufãr_cİy_bufãr
(
cÚ
->
uri
.
·th
, cÚ->uri.
·th_¿w
);

320 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
uri
.
·th_¿w
);

321 
	`bufãr_u¾decode_·th
(
¤v
->
tmp_buf
);

322 
	`bufãr_·th_sim¶ify
(
cÚ
->
uri
.
·th
, 
¤v
->
tmp_buf
);

325 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_SERVER_SOCKET
] = 1;

326 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_SCHEME
] = 1;

327 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_HOST
] = 1;

328 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_REMOTE_IP
] = 1;

329 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_REFERER
] = 1;

330 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_USER_AGENT
] =

331 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_LANGUAGE
] = 1;

332 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_COOKIE
] = 1;

333 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_REQUEST_METHOD
] = 1;

334 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_URL
] = 1;

335 
cÚ
->
cÚd™iÚ®_is_v®id
[
COMP_HTTP_QUERY_STRING
] = 1;

336 
	`cÚfig_·tch_cÚÃùiÚ
(
¤v
, 
cÚ
);

338 #ifdeà
USE_OPENSSL


339 ià(
cÚ
->
¤v_sock‘
->
is_s¦
 && cÚ->
cÚf
.
s¦_v”ifyş›Á
) {

340 
	`h‰ps_add_s¦_ş›Á_’Œ›s
(
¤v
, 
cÚ
);

345 ià(!
cÚ
->
cÚf
.
®low_h‰p11
) {

346 
cÚ
->
»que¡
.
h‰p_v”siÚ
 = 
HTTP_VERSION_1_0
;

349 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

350 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- splitting Request-URI");

351 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "Reque¡-URI : ", 
cÚ
->
»que¡
.
uri
);

352 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI-schem : ", 
cÚ
->
uri
.
scheme
);

353 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI-authÜ™y : ", 
cÚ
->
uri
.
authÜ™y
);

354 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI-·th (¿wè : ", 
cÚ
->
uri
.
·th_¿w
);

355 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI-·th (ş—n): ", 
cÚ
->
uri
.
·th
);

356 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI-qu”y : ", 
cÚ
->
uri
.
qu”y
);

360 ià(0 !ğ
cÚ
->
cÚf
.
max_»que¡_size
 &&

361 (
off_t
)
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
 > ((off_t)cÚ->
cÚf
.
max_»que¡_size
 << 10)) {

362 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sos",

363 "»que¡-siztoØlÚg:", (
off_t
è
cÚ
->
»que¡
.
cÚ‹Á_Ëngth
, "-> 413");

364 
cÚ
->
k“p_®ive
 = 0;

365 
cÚ
->
h‰p_¡©us
 = 413;

366 
cÚ
->
fe_fšished
 = 1;

368  
HANDLER_FINISHED
;

380 
r
 = 
	`¶ugšs_ÿÎ_hªdË_uri_¿w
(
¤v
, 
cÚ
)) {

381 
HANDLER_GO_ON
:

383 
HANDLER_FINISHED
:

384 
HANDLER_COMEBACK
:

385 
HANDLER_WAIT_FOR_EVENT
:

386 
HANDLER_ERROR
:

387  
r
;

389 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "hªdË_uri_¿w: unknowÀ»tuº v®ue", 
r
);

401 
r
 = 
	`¶ugšs_ÿÎ_hªdË_uri_ş—n
(
¤v
, 
cÚ
)) {

402 
HANDLER_GO_ON
:

404 
HANDLER_FINISHED
:

405 
HANDLER_COMEBACK
:

406 
HANDLER_WAIT_FOR_EVENT
:

407 
HANDLER_ERROR
:

408  
r
;

410 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "");

414 ià(
cÚ
->
»que¡
.
h‰p_m‘hod
 =ğ
HTTP_METHOD_OPTIONS
 &&

415 
cÚ
->
uri
.
·th
->
±r
[0] =ğ'*' && cÚ->uri.
·th_¿w
->ptr[1] == '\0') {

418 
	`»¥Ú£_h—d”_š£¹
(
¤v
, 
cÚ
, 
	`CONST_STR_LEN
("Allow"), CONST_STR_LEN("OPTIONS, GET, HEAD, POST"));

420 
cÚ
->
h‰p_¡©us
 = 200;

421 
cÚ
->
fe_fšished
 = 1;

423  
HANDLER_FINISHED
;

456 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
doc_roÙ
, cÚ->
cÚf
.
docum’t_roÙ
);

457 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
»l_·th
, cÚ->
uri
.
·th
);

459 #ià
	`defšed
(
__WIN32
è|| defšed(
__CYGWIN__
)

473 ià(
cÚ
->
physiÿl
.
»l_·th
->
u£d
 > 1) {

474 
bufãr
 *
b
 = 
cÚ
->
physiÿl
.
»l_·th
;

475 
size_t
 
Ën
 = 
	`bufãr_¡ršg_Ëngth
(
b
);

478 ià(
Ën
 > 1 &&

479 
b
->
±r
[
Ën
 - 1] == '/' &&

480 (
b
->
±r
[
Ën
 - 2] == ' ' || b->ptr[len - 2] == '.')) {

481 
Ën
 -= 2;

484 
Ën
 > 0 && ( ' ' =ğ
b
->
±r
[len-1] || '.' == b->ptr[len-1] ) ) --len;

485 
	`bufãr_¡ršg_£t_Ëngth
(
b
, 
Ën
);

489 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

490 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- before doc_root");

491 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "Doc-RoÙ :", 
cÚ
->
physiÿl
.
doc_roÙ
);

492 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "R–-P©h :", 
cÚ
->
physiÿl
.
»l_·th
);

493 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

498 
r
 = 
	`¶ugšs_ÿÎ_hªdË_doüoÙ
(
¤v
, 
cÚ
)) {

499 
HANDLER_GO_ON
:

501 
HANDLER_FINISHED
:

502 
HANDLER_COMEBACK
:

503 
HANDLER_WAIT_FOR_EVENT
:

504 
HANDLER_ERROR
:

505  
r
;

507 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "");

515 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames
) {

516 
	`bufãr_to_low”
(
cÚ
->
physiÿl
.
»l_·th
);

520 ià(
	`bufãr_¡ršg_is_em±y
(
cÚ
->
£rv”_Çme
)) {

521 
	`bufãr_cİy_bufãr
(
cÚ
->
£rv”_Çme
, cÚ->
uri
.
authÜ™y
);

530 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
ba£dœ
, cÚ->physiÿl.
doc_roÙ
);

531 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
doc_roÙ
);

532 
	`bufãr_­³nd_¦ash
(
cÚ
->
physiÿl
.
·th
);

533 ià(!
	`bufãr_¡ršg_is_em±y
(
cÚ
->
physiÿl
.
»l_·th
) &&

534 
cÚ
->
physiÿl
.
»l_·th
->
±r
[0] == '/') {

536 
	`bufãr_­³nd_¡ršg_Ën
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
»l_·th
->
±r
 + 1, 
	`bufãr_¡ršg_Ëngth
(con->physical.rel_path) - 1);

538 
	`bufãr_­³nd_¡ršg_bufãr
(
cÚ
->
physiÿl
.
·th
, cÚ->physiÿl.
»l_·th
);

541 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

542 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--‡fter doc_root");

543 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "Doc-RoÙ :", 
cÚ
->
physiÿl
.
doc_roÙ
);

544 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "R–-P©h :", 
cÚ
->
physiÿl
.
»l_·th
);

545 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

548 
r
 = 
	`¶ugšs_ÿÎ_hªdË_physiÿl
(
¤v
, 
cÚ
)) {

549 
HANDLER_GO_ON
:

551 
HANDLER_FINISHED
:

552 
HANDLER_COMEBACK
:

553 
HANDLER_WAIT_FOR_EVENT
:

554 
HANDLER_ERROR
:

555  
r
;

557 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "");

561 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

562 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--†ogical ->…hysical");

563 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "Doc-RoÙ :", 
cÚ
->
physiÿl
.
doc_roÙ
);

564 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "Ba£dœ :", 
cÚ
->
physiÿl
.
ba£dœ
);

565 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "R–-P©h :", 
cÚ
->
physiÿl
.
»l_·th
);

566 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

576 ià(
cÚ
->
mode
 =ğ
DIRECT
) {

577 *
¦ash
 = 
NULL
;

578 *
·thšfo
 = 
NULL
;

579 
found
 = 0;

580 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

582 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

583 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- handling…hysical…ath");

584 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

587 ià(
HANDLER_ERROR
 !ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

590 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

591 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- file found");

592 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

594 #ifdeà
HAVE_LSTAT


595 ià((
sû
->
is_symlšk
 !ğ0è&& !
cÚ
->
cÚf
.
fŞlow_symlšk
) {

596 
cÚ
->
h‰p_¡©us
 = 403;

598 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

599 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--‡ccess denied due symlink„estriction");

600 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

603 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

604  
HANDLER_FINISHED
;

607 ià(
	`S_ISDIR
(
sû
->
¡
.
¡_mode
)) {

608 ià(
cÚ
->
uri
.
·th
->
±r
[
	`bufãr_¡ršg_Ëngth
(con->uri.path) - 1] != '/') {

611 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
¤v
, 
cÚ
);

613  
HANDLER_FINISHED
;

615 #ifdeà
HAVE_LSTAT


616 } ià(!
	`S_ISREG
(
sû
->
¡
.
¡_mode
è&& !sû->
is_symlšk
) {

618 } ià(!
	`S_ISREG
(
sû
->
¡
.
¡_mode
)) {

625 
”ºo
) {

626 
EACCES
:

627 
cÚ
->
h‰p_¡©us
 = 403;

629 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

630 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--‡ccess denied");

631 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

634 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

635  
HANDLER_FINISHED
;

636 
ENAMETOOLONG
:

638 
ENOENT
:

639 
cÚ
->
h‰p_¡©us
 = 404;

641 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

642 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- file‚ot found");

643 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

646 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

647  
HANDLER_FINISHED
;

648 
ENOTDIR
:

653 
cÚ
->
h‰p_¡©us
 = 500;

654 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

656 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ssbsb",

657 "fnÙ found ... o¸so: ", 
	`¡»¼Ü
(
”ºo
),

658 
cÚ
->
uri
.
·th
,

659 "->", 
cÚ
->
physiÿl
.
·th
);

661  
HANDLER_FINISHED
;

666 
	`bufãr_cİy_bufãr
(
¤v
->
tmp_buf
, 
cÚ
->
physiÿl
.
·th
);

669 ià(
¦ash
) {

670 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
physiÿl
.
·th
, 
¤v
->
tmp_buf
->
±r
, 
¦ash
 - srv->tmp_buf->ptr);

672 
	`bufãr_cİy_bufãr
(
cÚ
->
physiÿl
.
·th
, 
¤v
->
tmp_buf
);

675 ià(
HANDLER_ERROR
 !ğ
	`¡©_ÿche_g‘_’Œy
(
¤v
, 
cÚ
, cÚ->
physiÿl
.
·th
, &
sû
)) {

676 
found
 = 
	`S_ISREG
(
sû
->
¡
.
¡_mode
);

680 ià(
·thšfo
 !ğ
NULL
) {

681 *
·thšfo
 = '\0';

683 
¦ash
 = 
	`¡¼chr
(
¤v
->
tmp_buf
->
±r
, '/');

685 ià(
·thšfo
 !ğ
NULL
) {

687 *
·thšfo
 = '/';

690 ià(
¦ash
è
·thšfo
 = slash;

691 } (
found
 =ğ0è&& (
¦ash
 !ğ
NULL
è&& ((
size_t
)(¦ash - 
¤v
->
tmp_buf
->
±r
è> (
	`bufãr_¡ršg_Ëngth
(
cÚ
->
physiÿl
.
ba£dœ
) - 1)));

693 ià(
found
 == 0) {

695 
cÚ
->
h‰p_¡©us
 = 404;

697 ià(
cÚ
->
cÚf
.
log_fe_nÙ_found
) {

698 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsb",

699 "fnÙ found:", 
cÚ
->
uri
.
·th
,

700 "->", 
cÚ
->
physiÿl
.
·th
);

703 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

705  
HANDLER_FINISHED
;

708 #ifdeà
HAVE_LSTAT


709 ià((
sû
->
is_symlšk
 !ğ0è&& !
cÚ
->
cÚf
.
fŞlow_symlšk
) {

710 
cÚ
->
h‰p_¡©us
 = 403;

712 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

713 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--‡ccess denied due symlink„estriction");

714 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

717 
	`bufãr_»£t
(
cÚ
->
physiÿl
.
·th
);

718  
HANDLER_FINISHED
;

723 ià(
·thšfo
) {

724 
size_t
 
Ën
 = 
	`¡¾’
(
·thšfo
), 
»qËn
;

725 ià(
cÚ
->
cÚf
.
fÜû_low”ÿ£_f’ames


726 && 
Ën
 <ğ(
»qËn
 = 
	`bufãr_¡ršg_Ëngth
(
cÚ
->
»que¡
.
uri
))

727 && 0 =ğ
	`¡ºÿ£cmp
(
cÚ
->
»que¡
.
uri
->
±r
 + 
»qËn
 - 
Ën
, 
·thšfo
,†en)) {

732 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
»que¡
.
·thšfo
, cÚ->»que¡.
uri
->
±r
 + 
»qËn
 - 
Ën
,†en);

734 
	`bufãr_cİy_¡ršg_Ën
(
cÚ
->
»que¡
.
·thšfo
,…©hšfo, 
Ën
);

741 
	`bufãr_¡ršg_£t_Ëngth
(
cÚ
->
uri
.
·th
, 
	`bufãr_¡ršg_Ëngth
(cÚ->uri.·thè- 
Ën
);

744 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

745 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "--‡fter…athinfo check");

746 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

747 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "URI :", 
cÚ
->
uri
.
·th
);

748 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©hšfØ :", 
cÚ
->
»que¡
.
·thšfo
);

752 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

753 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- handling subrequest");

754 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb", "P©h :", 
cÚ
->
physiÿl
.
·th
);

758 
r
 = 
	`¶ugšs_ÿÎ_hªdË_sub»que¡_¡¬t
(
¤v
, 
cÚ
)) {

759 
HANDLER_GO_ON
:

762 
HANDLER_FINISHED
:

764 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

765 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "-- subrequest finished");

769  
r
;

774 ià(
cÚ
->
mode
 =ğ
DIRECT
 && cÚ->
h‰p_¡©us
 == 0) {

775 
cÚ
->
»que¡
.
h‰p_m‘hod
) {

776 
HTTP_METHOD_OPTIONS
:

777 
cÚ
->
h‰p_¡©us
 = 200;

780 
cÚ
->
h‰p_¡©us
 = 403;

783  
HANDLER_FINISHED
;

788 
r
 = 
	`¶ugšs_ÿÎ_hªdË_sub»que¡
(
¤v
, 
cÚ
)) {

789 
HANDLER_GO_ON
:

791  
HANDLER_FINISHED
;

792 
HANDLER_FINISHED
:

796  
r
;

800  
HANDLER_COMEBACK
;

801 
	}
}

	@response.h

1 #iâdeà
_RESPONSE_H_


2 
	#_RESPONSE_H_


	)

3 
	~"fœ¡.h
"

5 
	~"£rv”.h
"

7 
	~<time.h
>

9 
h‰p_»¥Ú£_·r£
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

10 
h‰p_»¥Ú£_wr™e_h—d”
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

12 
»¥Ú£_h—d”_š£¹
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, 
size_t
 
keyËn
, cÚ¡ *
v®ue
, size_ˆ
v®Ën
);

13 
»¥Ú£_h—d”_ov”wr™e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, 
size_t
 
keyËn
, cÚ¡ *
v®ue
, size_ˆ
v®Ën
);

14 
»¥Ú£_h—d”_­³nd
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, cÚ¡ *
key
, 
size_t
 
keyËn
, cÚ¡ *
v®ue
, size_ˆ
v®Ën
);

16 
	sh‰p_cgi_İts_t
 {

17 
	mauthÜiz”
;

18 
	mb»ak_sütf’ame_fÜ_php
;

19 
bufãr
 *
	mdoüoÙ
;

20 
bufãr
 *
	m¡r_»que¡_uri
;

21 } 
	th‰p_cgi_İts
;

23 (*
	th‰p_cgi_h—d”_­³nd_cb
)(*
	tvd©a
, cÚ¡ *
	tk
, 
	tsize_t
 
	tkËn
, cÚ¡ *
	tv
, size_ˆ
	tvËn
);

24 
	`h‰p_cgi_h—d”s
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
h‰p_cgi_İts
 *
İts
, 
h‰p_cgi_h—d”_­³nd_cb
 
cb
, *
vd©a
);

25 #ifdeà
USE_OPENSSL


26 
	`h‰p_cgi_s¦_’v
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

29 
hªdËr_t
 
	`h‰p_»¥Ú£_´•¬e
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

30 
	`h‰p_»¥Ú£_»dœeù_to_dœeùÜy
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

31 
	`h‰p_»¥Ú£_hªdË_ÿchabË
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 * 
mtime
);

32 
	`h‰p_»¥Ú£_£nd_fe
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
·th
);

33 
	`h‰p_»¥Ú£_x£ndfe
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
·th
, cÚ¡ 
¬¿y
 *
xdoüoÙ
);

34 
	`h‰p_»¥Ú£_back’d_dÚe
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

35 
	`h‰p_»¥Ú£_back’d_”rÜ
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
);

37 
bufãr
 * 
	`¡ráime_ÿche_g‘
(
£rv”
 *
¤v
, 
time_t
 
Ï¡_mod
);

	@safe_memclear.c

1 
	~"fœ¡.h
"

3 
	~"£‰šgs.h
"

5 
	~"§ã_memş—r.h
"

7 
	~<¡ršg.h
>

9 #ià!
defšed
(
HAVE_MEMSET_S
è&& !defšed(
HAVE_EXPLICIT_BZERO
)

11 #ià
defšed
(
HAVE_WEAK_SYMBOLS
)

13 
__©Œibu‹__
((
w—k
)è
__li_§ã_mem£t_hook
(*
buf
, 
size_t
 
Ën
);

15 
	$__li_§ã_mem£t_hook
(*
buf
, 
size_t
 
Ën
)

17 
	`UNUSED
(
buf
);

18 
	`UNUSED
(
Ën
);

19 
	}
}

22 * 
	$§ã_mem£t
(*
s
, 
c
, 
size_t
 
n
)

24 ià(
n
 > 0) {

25 vŞ©
vŞ©e_z”o
 = 0;

26 vŞ©*
vs
 = (vŞ©*)
s
;

29 
	`mem£t
(
s
, 
c
, 
n
);

30 } 
vs
[
vŞ©e_z”o
] !ğ()
c
);

31 #ià
	`defšed
(
HAVE_WEAK_SYMBOLS
)

32 
	`__li_§ã_mem£t_hook
(
s
, 
n
);

36  
s
;

37 
	}
}

41 
	$§ã_memş—r
(*
s
, 
size_t
 
n
) {

42 #ià
	`defšed
(
HAVE_MEMSET_S
)

43 
	`mem£t_s
(
s
, 
n
, 0,‚);

44 #–ià
	`defšed
(
HAVE_EXPLICIT_BZERO
)

45 
	`ex¶ic™_bz”o
(
s
, 
n
);

47 
	`§ã_mem£t
(
s
, 0, 
n
);

49 
	}
}

	@safe_memclear.h

1 #iâdeà
_SAFE_MEMCLEAR_H_


2 
	#_SAFE_MEMCLEAR_H_


	)

3 
	~"fœ¡.h
"

6 
	~<sys/ty³s.h
>

8 
§ã_memş—r
(*
s
, 
size_t
 
n
);

	@server.c

1 
	~"fœ¡.h
"

3 
	~"£rv”.h
"

4 
	~"bufãr.h
"

5 
	~"ÃtwÜk.h
"

6 
	~"log.h
"

7 
	~"keyv®ue.h
"

8 
	~"¿nd.h
"

9 
	~"»¥Ú£.h
"

10 
	~"»que¡.h
"

11 
	~"chunk.h
"

12 
	~"h‰p_chunk.h
"

13 
	~"fdev’t.h
"

14 
	~"cÚÃùiÚs.h
"

15 
	~"¡©_ÿche.h
"

16 
	~"¶ugš.h
"

17 
	~"jobli¡.h
"

18 
	~"ÃtwÜk_back’ds.h
"

19 
	~"v”siÚ.h
"

21 
	~<sys/ty³s.h
>

22 
	~<sys/time.h
>

23 
	~<sys/¡©.h
>

25 
	~<¡ršg.h
>

26 
	~<”ºo.h
>

27 
	~<fú.h
>

28 
	~<uni¡d.h
>

29 
	~<¡dlib.h
>

30 
	~<time.h
>

31 
	~<sigÇl.h
>

32 
	~<as£¹.h
>

33 
	~<loÿË.h
>

35 
	~<¡dio.h
>

37 #ifdeà
HAVE_GETOPT_H


38 
	~<g‘İt.h
>

41 #ifdeà
HAVE_VALGRIND_VALGRIND_H


42 
	~<v®gršd/v®gršd.h
>

45 #ifdeà
HAVE_SYS_WAIT_H


46 
	~<sys/wa™.h
>

49 #ifdeà
HAVE_PWD_H


50 
	~<g½.h
>

51 
	~<pwd.h
>

54 #ifdeà
HAVE_SYS_RESOURCE_H


55 
	~<sys/»sourû.h
>

58 #ifdeà
HAVE_SYS_PRCTL_H


59 
	~<sys/´ùl.h
>

62 #ifdeà
USE_OPENSSL


63 
	~<İ’s¦/”r.h
>

66 #iâdeà
__sgi


71 #ifdeà
HAVE_GETUID


72 #iâdeà
HAVE_ISSETUGID


74 
	$l_is£tugid
() {

75  (
	`g‘euid
(è!ğ
	`g‘uid
(è|| 
	`g‘egid
(è!ğ
	`g‘gid
());

76 
	}
}

78 
	#is£tugid
 
l_is£tugid


	)

82 
	gÚeshÙ_fd
 = 0;

83 vŞ©
sig_©omic_t
 
	g¤v_shutdown
 = 0;

84 vŞ©
sig_©omic_t
 
	gg¿ûful_shutdown
 = 0;

85 vŞ©
sig_©omic_t
 
	ghªdË_sig_®¬m
 = 1;

86 vŞ©
sig_©omic_t
 
	ghªdË_sig_hup
 = 0;

87 vŞ©
sig_©omic_t
 
	gfÜw¬ded_sig_hup
 = 0;

89 #ià
defšed
(
HAVE_SIGACTION
è&& defšed(
SA_SIGINFO
)

90 vŞ©
sigšfo_t
 
	gÏ¡_sig‹rm_šfo
;

91 vŞ©
sigšfo_t
 
	gÏ¡_sighup_šfo
;

93 
	$sigaùiÚ_hªdËr
(
sig
, 
sigšfo_t
 *
si
, *
cÚ‹xt
) {

94 
sigšfo_t
 
em±y_sigšfo
;

95 
	`UNUSED
(
cÚ‹xt
);

97 ià(!
si
ès˜ğ&
em±y_sigšfo
;

99 
sig
) {

100 
SIGTERM
:

101 
¤v_shutdown
 = 1;

102 
Ï¡_sig‹rm_šfo
 = *
si
;

104 
SIGINT
:

105 ià(
g¿ûful_shutdown
) {

106 
¤v_shutdown
 = 1;

108 
g¿ûful_shutdown
 = 1;

110 
Ï¡_sig‹rm_šfo
 = *
si
;

113 
SIGALRM
:

114 
hªdË_sig_®¬m
 = 1;

116 
SIGHUP
:

124 ià(!
fÜw¬ded_sig_hup
) {

125 
hªdË_sig_hup
 = 1;

126 
Ï¡_sighup_šfo
 = *
si
;

128 
fÜw¬ded_sig_hup
 = 0;

131 
SIGCHLD
:

134 
	}
}

135 #–ià
defšed
(
HAVE_SIGNAL
è|| defšed(
HAVE_SIGACTION
)

136 
	$sigÇl_hªdËr
(
sig
) {

137 
sig
) {

138 
SIGTERM
: 
¤v_shutdown
 = 1; ;

139 
SIGINT
:

140 ià(
g¿ûful_shutdown
è
¤v_shutdown
 = 1;

141 
g¿ûful_shutdown
 = 1;

144 
SIGALRM
: 
hªdË_sig_®¬m
 = 1; ;

145 
SIGHUP
: 
hªdË_sig_hup
 = 1; ;

146 
SIGCHLD
: ;

148 
	}
}

151 #ifdeà
HAVE_FORK


152 
	$d«mÚize
() {

153 
pefd
[2];

154 
pid_t
 
pid
;

155 #ifdeà
SIGTTOU


156 
	`sigÇl
(
SIGTTOU
, 
SIG_IGN
);

158 #ifdeà
SIGTTIN


159 
	`sigÇl
(
SIGTTIN
, 
SIG_IGN
);

161 #ifdeà
SIGTSTP


162 
	`sigÇl
(
SIGTSTP
, 
SIG_IGN
);

165 ià(
	`pe
(
pefd
è< 0è
	`ex™
(-1);

167 ià(0 > (
pid
 = 
	`fÜk
())è
	`ex™
(-1);

169 ià(0 < 
pid
) {

170 
buf
;

171 
ssize_t
 
by‹s
;

173 
	`şo£
(
pefd
[1]);

176 
by‹s
 = 
	`»ad
(
pefd
[0], &
buf
, (buf));

177 } 
by‹s
 < 0 && 
EINTR
 =ğ
”ºo
);

178 
	`şo£
(
pefd
[0]);

180 ià(
by‹s
 <= 0) {

182 
	`åuts
("d«mÚized s”v” faedØ¡¬t; checkƒ¼Ü†og fÜ d‘as\n", 
¡d”r
);

183 
	`ex™
(-1);

186 
	`ex™
(0);

189 
	`şo£
(
pefd
[0]);

191 ià(-1 =ğ
	`£tsid
()è
	`ex™
(0);

193 
	`sigÇl
(
SIGHUP
, 
SIG_IGN
);

195 ià(0 !ğ
	`fÜk
()è
	`ex™
(0);

197 ià(0 !ğ
	`chdœ
("/")è
	`ex™
(0);

199 
	`fd_şo£_Ú_exec
(
pefd
[1]);

200  
pefd
[1];

201 
	}
}

204 
£rv”
 *
	$£rv”_š™
() {

205 
i
;

206 
£rv”
 *
¤v
 = 
	`ÿÎoc
(1, (*srv));

207 
	`fÜû_as£¹
(
¤v
);

208 
	#CLEAN
(
x
) \

209 
¤v
->
x
 = 
	`bufãr_š™
();

	)

211 
	`CLEAN
(
»¥Ú£_h—d”
);

212 
	`CLEAN
(
·r£_fuÎ_·th
);

213 
	`CLEAN
(
ts_debug_¡r
);

214 
	`CLEAN
(
ts_d©e_¡r
);

215 
	`CLEAN
(
”rÜlog_buf
);

216 
	`CLEAN
(
»¥Ú£_¿nge
);

217 
	`CLEAN
(
tmp_buf
);

218 
¤v
->
em±y_¡ršg
 = 
	`bufãr_š™_¡ršg
("");

219 
	`CLEAN
(
cÚd_check_buf
);

221 
	`CLEAN
(
¤vcÚf
.
”rÜlog_fe
);

222 
	`CLEAN
(
¤vcÚf
.
b»akag–og_fe
);

223 
	`CLEAN
(
¤vcÚf
.
grou²ame
);

224 
	`CLEAN
(
¤vcÚf
.
u£ºame
);

225 
	`CLEAN
(
¤vcÚf
.
chªg”oÙ
);

226 
	`CLEAN
(
¤vcÚf
.
bšdho¡
);

227 
	`CLEAN
(
¤vcÚf
.
ev’t_hªdËr
);

228 
	`CLEAN
(
¤vcÚf
.
pid_fe
);

230 
	`CLEAN
(
tmp_chunk_Ën
);

231 #undeà
CLEAN


233 
	#CLEAN
(
x
) \

234 
¤v
->
x
 = 
	`¬¿y_š™
();

	)

236 
	`CLEAN
(
cÚfig_cÚ‹xt
);

237 
	`CLEAN
(
cÚfig_touched
);

238 
	`CLEAN
(
¡©us
);

239 #undeà
CLEAN


241 
i
 = 0; i < 
FILE_CACHE_MAX
; i++) {

242 
¤v
->
mtime_ÿche
[
i
].
mtime
 = (
time_t
)-1;

243 
¤v
->
mtime_ÿche
[
i
].
¡r
 = 
	`bufãr_š™
();

246 
	`li_¿nd_»£ed
();

248 
¤v
->
cur_ts
 = 
	`time
(
NULL
);

249 
¤v
->
¡¬tup_ts
 = srv->
cur_ts
;

251 
¤v
->
cÚns
 = 
	`ÿÎoc
(1, (*srv->conns));

252 
	`fÜû_as£¹
(
¤v
->
cÚns
);

254 
¤v
->
jobli¡
 = 
	`ÿÎoc
(1, (*srv->joblist));

255 
	`fÜû_as£¹
(
¤v
->
jobli¡
);

257 
¤v
->
fdwa™queue
 = 
	`ÿÎoc
(1, (*srv->fdwaitqueue));

258 
	`fÜû_as£¹
(
¤v
->
fdwa™queue
);

260 
¤v
->
¤vcÚf
.
moduËs
 = 
	`¬¿y_š™
();

261 
¤v
->
¤vcÚf
.
moduËs_dœ
 = 
	`bufãr_š™_¡ršg
(
LIBRARY_DIR
);

262 
¤v
->
¤vcÚf
.
ÃtwÜk_back’d
 = 
	`bufãr_š™
();

263 
¤v
->
¤vcÚf
.
u¶ßd_‹mpdœs
 = 
	`¬¿y_š™
();

264 
¤v
->
¤vcÚf
.
»jeù_ex³ù_100_w™h_417
 = 1;

265 
¤v
->
¤vcÚf
.
x©Œ_Çme
 = 
	`bufãr_š™_¡ršg
("Content-Type");

266 
¤v
->
¤vcÚf
.
h‰p_h—d”_¡riù
 = 1;

267 
¤v
->
¤vcÚf
.
h‰p_ho¡_¡riù
 = 1;

268 
¤v
->
¤vcÚf
.
h‰p_ho¡_nÜm®ize
 = 0;

269 
¤v
->
¤vcÚf
.
high_´ecisiÚ_time¡amps
 = 0;

270 
¤v
->
¤vcÚf
.
max_»que¡_f›ld_size
 = 8192;

271 
¤v
->
¤vcÚf
.
lßdavg
[0] = 0.0;

272 
¤v
->
¤vcÚf
.
lßdavg
[1] = 0.0;

273 
¤v
->
¤vcÚf
.
lßdavg
[2] = 0.0;

276 
¤v
->
”rÜlog_fd
 = 
STDERR_FILENO
;

277 
¤v
->
”rÜlog_mode
 = 
ERRORLOG_FD
;

279 
¤v
->
¥l™_v®s
 = 
	`¬¿y_š™
();

281  
¤v
;

282 
	}
}

284 
	$£rv”_ä“
(
£rv”
 *
¤v
) {

285 
size_t
 
i
;

287 
i
 = 0; i < 
FILE_CACHE_MAX
; i++) {

288 
	`bufãr_ä“
(
¤v
->
mtime_ÿche
[
i
].
¡r
);

291 ià(
ÚeshÙ_fd
 > 0) {

292 
	`şo£
(
ÚeshÙ_fd
);

295 
	#CLEAN
(
x
) \

296 
	`bufãr_ä“
(
¤v
->
x
);

	)

298 
	`CLEAN
(
»¥Ú£_h—d”
);

299 
	`CLEAN
(
·r£_fuÎ_·th
);

300 
	`CLEAN
(
ts_debug_¡r
);

301 
	`CLEAN
(
ts_d©e_¡r
);

302 
	`CLEAN
(
”rÜlog_buf
);

303 
	`CLEAN
(
»¥Ú£_¿nge
);

304 
	`CLEAN
(
tmp_buf
);

305 
	`CLEAN
(
em±y_¡ršg
);

306 
	`CLEAN
(
cÚd_check_buf
);

308 
	`CLEAN
(
¤vcÚf
.
”rÜlog_fe
);

309 
	`CLEAN
(
¤vcÚf
.
b»akag–og_fe
);

310 
	`CLEAN
(
¤vcÚf
.
grou²ame
);

311 
	`CLEAN
(
¤vcÚf
.
u£ºame
);

312 
	`CLEAN
(
¤vcÚf
.
chªg”oÙ
);

313 
	`CLEAN
(
¤vcÚf
.
bšdho¡
);

314 
	`CLEAN
(
¤vcÚf
.
ev’t_hªdËr
);

315 
	`CLEAN
(
¤vcÚf
.
pid_fe
);

316 
	`CLEAN
(
¤vcÚf
.
moduËs_dœ
);

317 
	`CLEAN
(
¤vcÚf
.
ÃtwÜk_back’d
);

318 
	`CLEAN
(
¤vcÚf
.
x©Œ_Çme
);

320 
	`CLEAN
(
tmp_chunk_Ën
);

321 #undeà
CLEAN


324 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, srv->
fd
);

326 
	`fdev’t_ä“
(
¤v
->
ev
);

328 
	`ä“
(
¤v
->
cÚns
);

330 ià(
¤v
->
cÚfig_¡Üage
) {

331 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

332 
¥ecific_cÚfig
 *
s
 = 
¤v
->
cÚfig_¡Üage
[
i
];

334 ià(!
s
) ;

336 
	`bufãr_ä“
(
s
->
docum’t_roÙ
);

337 
	`bufãr_ä“
(
s
->
£rv”_Çme
);

338 
	`bufãr_ä“
(
s
->
£rv”_g
);

339 
	`bufãr_ä“
(
s
->
s¦_³mfe
);

340 
	`bufãr_ä“
(
s
->
s¦_ÿ_fe
);

341 
	`bufãr_ä“
(
s
->
s¦_ch”_li¡
);

342 
	`bufãr_ä“
(
s
->
s¦_dh_fe
);

343 
	`bufãr_ä“
(
s
->
s¦_ec_curve
);

344 
	`bufãr_ä“
(
s
->
”rÜ_hªdËr
);

345 
	`bufãr_ä“
(
s
->
”rÜ_hªdËr_404
);

346 
	`bufãr_ä“
(
s
->
”rÜfe_´efix
);

347 
	`¬¿y_ä“
(
s
->
mim‘y³s
);

348 
	`bufãr_ä“
(
s
->
s¦_v”ifyş›Á_u£ºame
);

349 #ifdeà
USE_OPENSSL


350 
	`SSL_CTX_ä“
(
s
->
s¦_ùx
);

351 
	`EVP_PKEY_ä“
(
s
->
s¦_³mfe_pkey
);

352 
	`X509_ä“
(
s
->
s¦_³mfe_x509
);

353 ià(
NULL
 !ğ
s
->
s¦_ÿ_fe_û¹_Çmes
è
	`sk_X509_NAME_pİ_ä“
(s->s¦_ÿ_fe_û¹_Çmes, 
X509_NAME_ä“
);

355 
	`ä“
(
s
);

357 
	`ä“
(
¤v
->
cÚfig_¡Üage
);

358 
¤v
->
cÚfig_¡Üage
 = 
NULL
;

361 
	#CLEAN
(
x
) \

362 
	`¬¿y_ä“
(
¤v
->
x
);

	)

364 
	`CLEAN
(
cÚfig_cÚ‹xt
);

365 
	`CLEAN
(
cÚfig_touched
);

366 
	`CLEAN
(
¡©us
);

367 
	`CLEAN
(
¤vcÚf
.
u¶ßd_‹mpdœs
);

368 #undeà
CLEAN


370 
	`jobli¡_ä“
(
¤v
, srv->
jobli¡
);

371 
	`fdwa™queue_ä“
(
¤v
, srv->
fdwa™queue
);

373 ià(
¤v
->
¡©_ÿche
) {

374 
	`¡©_ÿche_ä“
(
¤v
->
¡©_ÿche
);

377 
	`¬¿y_ä“
(
¤v
->
¤vcÚf
.
moduËs
);

378 
	`¬¿y_ä“
(
¤v
->
¥l™_v®s
);

380 #ifdeà
USE_OPENSSL


381 ià(
¤v
->
s¦_is_š™
) {

382 #ià 
OPENSSL_VERSION_NUMBER
 >= 0x10100000L \

383 && !
	`defšed
(
LIBRESSL_VERSION_NUMBER
)

387 
	`CRYPTO_ş—nup_®l_ex_d©a
();

388 
	`ERR_ä“_¡ršgs
();

389 #ià
OPENSSL_VERSION_NUMBER
 >= 0x10000000L

390 
	`ERR_»move_th»ad_¡©e
(
NULL
);

392 
	`ERR_»move_¡©e
(0);

394 
	`EVP_ş—nup
();

398 
	`li_¿nd_ş—nup
();

400 
	`ä“
(
¤v
);

401 
	}
}

403 
	$»move_pid_fe
(
£rv”
 *
¤v
, *
pid_fd
) {

404 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
pid_fe
è&& 0 <ğ*
pid_fd
) {

405 ià(0 !ğ
	`árunÿ‹
(*
pid_fd
, 0)) {

406 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbds",

408 
¤v
->
¤vcÚf
.
pid_fe
,

409 
”ºo
,

410 
	`¡»¼Ü
(
”ºo
));

413 ià(0 <ğ*
pid_fd
) {

414 
	`şo£
(*
pid_fd
);

415 *
pid_fd
 = -1;

417 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
pid_fe
) &&

418 
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
chªg”oÙ
)) {

419 ià(0 !ğ
	`uÆšk
(
¤v
->
¤vcÚf
.
pid_fe
->
±r
)) {

420 ià(
”ºo
 !ğ
EACCES
 &&ƒ¼nØ!ğ
EPERM
) {

421 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbds",

423 
¤v
->
¤vcÚf
.
pid_fe
,

424 
”ºo
,

425 
	`¡»¼Ü
(
”ºo
));

429 
	}
}

432 
£rv”_sock‘
 * 
	$£rv”_ÚeshÙ_g‘sock
(
£rv”
 *
¤v
, 
sock_addr
 *
út_addr
) {

433 
£rv”_sock‘
 *
¤v_sock‘
, *
¤v_sock‘_wd
 = 
NULL
;

434 
size_t
 
i
;

435 
i
 = 0; i < 
¤v
->
¤v_sock‘s
.
u£d
; ++i) {

436 
¤v_sock‘
 = 
¤v
->
¤v_sock‘s
.
±r
[
i
];

437 ià(
út_addr
->
¶aš
.
§_çmy
 !ğ
¤v_sock‘
->
addr
.plain.sa_family) ;

438 
út_addr
->
¶aš
.
§_çmy
) {

439 
AF_INET
:

440 ià(
¤v_sock‘
->
addr
.
v4
.
sš_pÜt
 !ğ
út_addr
->ipv4.sin_port) ;

441 ià(
¤v_sock‘
->
addr
.
v4
.
sš_addr
.
s_addr
 =ğ
út_addr
->ipv4.sin_addr.s_addr) {

442  
¤v_sock‘
;

444 ià(
¤v_sock‘
->
addr
.
v4
.
sš_addr
.
s_addr
 =ğ
	`htÚl
(
INADDR_ANY
)) {

445 
¤v_sock‘_wd
 = 
¤v_sock‘
;

448 #ifdeà
HAVE_IPV6


449 
AF_INET6
:

450 ià(
¤v_sock‘
->
addr
.
v6
.
sš6_pÜt
 !ğ
út_addr
->ipv6.sin6_port) ;

451 ià(0 =ğ
	`memcmp
(&
¤v_sock‘
->
addr
.
v6
.
sš6_addr
, &
út_addr
->v6.sš6_addr, (
š6_addr
))) {

452  
¤v_sock‘
;

454 ià(0 =ğ
	`memcmp
(&
¤v_sock‘
->
addr
.
v6
.
sš6_addr
, &
š6addr_ªy
, (
š6_addr
))) {

455 
¤v_sock‘_wd
 = 
¤v_sock‘
;

459 #ifdeà
HAVE_SYS_UN_H


460 
AF_UNIX
:

461 ià(0 =ğ
	`¡rcmp
(
¤v_sock‘
->
addr
.
un
.
sun_·th
, 
út_addr
->un.sun_path)) {

462  
¤v_sock‘
;

470 ià(
NULL
 !ğ
¤v_sock‘_wd
) {

471  
¤v_sock‘_wd
;

472 } ià(
¤v
->
¤v_sock‘s
.
u£d
) {

473  
¤v
->
¤v_sock‘s
.
±r
[0];

475 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "no sockets configured");

476  
NULL
;

478 
	}
}

481 
	$£rv”_ÚeshÙ_š™
(
£rv”
 *
¤v
, 
fd
) {

494 
cÚÃùiÚ
 *
cÚ
;

495 
£rv”_sock‘
 *
¤v_sock‘
;

496 
sock_addr
 
út_addr
;

497 
sockËn_t
 
út_Ën
;

498 
¡©
 
¡
;

500 ià(0 !ğ
	`f¡©
(
fd
, &
¡
)) {

501 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "f¡©:", 
	`¡»¼Ü
(
”ºo
));

505 ià(!
	`S_ISSOCK
(
¡
.
¡_mode
)) {

508 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "lighttpd -1 stdin is‚ot‡ socket");

512 
út_Ën
 = (
út_addr
);

513 ià(0 !ğ
	`g‘sockÇme
(
fd
, (
sockaddr
 *)&
út_addr
, &
út_Ën
)) {

514 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "g‘sockÇme:", 
	`¡»¼Ü
(
”ºo
));

518 
¤v_sock‘
 = 
	`£rv”_ÚeshÙ_g‘sock
(
¤v
, &
út_addr
);

519 ià(
NULL
 =ğ
¤v_sock‘
)  0;

521 
út_Ën
 = (
út_addr
);

522 ià(0 !ğ
	`g‘³”Çme
(
fd
, (
sockaddr
 *)&
út_addr
, &
út_Ën
)) {

523 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "g‘³”Çme:", 
	`¡»¼Ü
(
”ºo
));

527 ià(
út_addr
.
¶aš
.
§_çmy
 !ğ
AF_UNIX
) {

528 
	`ÃtwÜk_acû±_tı_ÇgË_di§bË
(
fd
);

531 
cÚ
 = 
	`cÚÃùiÚ_acû±ed
(
¤v
, 
¤v_sock‘
, &
út_addr
, 
fd
);

532 ià(
NULL
 =ğ
cÚ
)  0;

534 
	`cÚÃùiÚ_¡©e_machše
(
¤v
, 
cÚ
);

536 
	}
}

539 
	$show_v”siÚ
 () {

540 #ifdeà
USE_OPENSSL


541 
	#TEXT_SSL
 " (s¦)"

	)

543 
	#TEXT_SSL


	)

545 *
b
 = 
PACKAGE_DESC
 
TEXT_SSL
 \

547 "Bud-D©e: " 
__DATE__
 " " 
__TIME__
 "\n";

549 #undeà
TEXT_SSL


550 
	`wr™e_®l
(
STDOUT_FILENO
, 
b
, 
	`¡¾’
(b));

551 
	}
}

553 
	$show_ã©u»s
 () {

554 cÚ¡ 
ã©u»s
[] = ""

555 #ifdeà
USE_SELECT


560 #ifdeà
USE_POLL


565 #ifdeà
USE_LINUX_EPOLL


570 #ifdeà
USE_SOLARIS_DEVPOLL


575 #ifdeà
USE_SOLARIS_PORT


580 #ifdeà
USE_FREEBSD_KQUEUE


585 #ifdeà
USE_LIBEV


591 #ià
defšed
 
USE_LINUX_SENDFILE


596 #ià
defšed
 
USE_FREEBSD_SENDFILE


601 #ià
defšed
 
USE_DARWIN_SENDFILE


606 #ià
defšed
 
USE_SOLARIS_SENDFILEV


611 #ià
defšed
 
USE_WRITEV


617 #ifdeà
USE_MMAP


623 #ifdeà
HAVE_IPV6


628 #ià
defšed
 
HAVE_ZLIB_H
 && defšed 
HAVE_LIBZ


633 #ià
defšed
 
HAVE_BZLIB_H
 && defšed 
HAVE_LIBBZ2


638 #ià
	`defšed
(
HAVE_CRYPT
è|| defšed(
HAVE_CRYPT_R
è|| defšed(
HAVE_LIBCRYPT
)

643 #ifdeà
USE_OPENSSL


648 #ifdeà
HAVE_LIBPCRE


653 #ifdeà
HAVE_MYSQL


658 #ifdeà
HAVE_KRB5


663 #ià
	`defšed
(
HAVE_LDAP_H
è&& defšed(
HAVE_LBER_H
è&& defšed(
HAVE_LIBLDAP
è&& defšed(
HAVE_LIBLBER
)

668 #ifdeà
USE_MEMCACHED


673 #ifdeà
HAVE_FAM_H


678 #ifdeà
HAVE_LUA_H


683 #ifdeà
HAVE_LIBXML_H


688 #ifdeà
HAVE_SQLITE3_H


693 #ifdeà
HAVE_GDBM_H


699 
	`show_v”siÚ
();

700 
	`´štf
("\nEv’ˆHªdËrs:\n\n%s", 
ã©u»s
);

701 
	}
}

703 
	$show_h–p
 () {

704 #ifdeà
USE_OPENSSL


705 
	#TEXT_SSL
 " (s¦)"

	)

707 
	#TEXT_SSL


	)

709 *
b
 = 
PACKAGE_DESC
 
TEXT_SSL
 " ("
__DATE__
 " " 
__TIME__
 ")" \

713 " -m <Çme> moduË dœeùÜy (deçuÉ: "
LIBRARY_DIR
")\n" \

725 #undeà
TEXT_SSL


726 #undeà
TEXT_IPV6


727 
	`wr™e_®l
(
STDOUT_FILENO
, 
b
, 
	`¡¾’
(b));

728 
	}
}

730 
	$maš
 (
¬gc
, **
¬gv
) {

731 
£rv”
 *
¤v
 = 
NULL
;

732 
´št_cÚfig
 = 0;

733 
‹¡_cÚfig
 = 0;

734 
i_am_roÙ
;

735 
o
;

736 
num_chds
 = 0;

737 
pid_fd
 = -1, 
fd
;

738 
size_t
 
i
;

739 
time_t
 
idË_lim™
 = 0, 
Ï¡_aùive_ts
 = 
	`time
(
NULL
);

740 #ifdeà
HAVE_SIGACTION


741 
sigaùiÚ
 
aù
;

743 #ifdeà
HAVE_GETRLIMIT


744 
¾im™
 
¾im
;

747 #ifdeà
HAVE_FORK


748 
·»Á_pe_fd
 = -1;

751 #ifdeà
USE_ALARM


752 
™im”v®
 
š‹rv®
;

754 
š‹rv®
.
™_š‹rv®
.
tv_£c
 = 1;

755 
š‹rv®
.
™_š‹rv®
.
tv_u£c
 = 0;

756 
š‹rv®
.
™_v®ue
.
tv_£c
 = 1;

757 
š‹rv®
.
™_v®ue
.
tv_u£c
 = 0;

761 
	`£oÿË
(
LC_TIME
, "C");

763 ià(
NULL
 =ğ(
¤v
 = 
	`£rv”_š™
())) {

764 
	`årštf
(
¡d”r
, "didhis„eally happen?\n");

770 
¤v
->
¤vcÚf
.
pÜt
 = 0;

771 #ifdeà
HAVE_GETUID


772 
i_am_roÙ
 = (
	`g‘uid
() == 0);

774 
i_am_roÙ
 = 0;

776 
¤v
->
¤vcÚf
.
dÚt_d«mÚize
 = 0;

777 
¤v
->
¤vcÚf
.
´eæight_check
 = 0;

779 -1 !ğ(
o
 = 
	`g‘İt
(
¬gc
, 
¬gv
, "f:m:i:hvVD1pt"))) {

780 
o
) {

782 ià(
¤v
->
cÚfig_¡Üage
) {

783 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

786 
	`£rv”_ä“
(
¤v
);

789 ià(
	`cÚfig_»ad
(
¤v
, 
İrg
)) {

790 
	`£rv”_ä“
(
¤v
);

795 
	`bufãr_cİy_¡ršg
(
¤v
->
¤vcÚf
.
moduËs_dœ
, 
İrg
);

798 *
’d±r
;

799 
timeout
 = 
	`¡¹Ş
(
İrg
, &
’d±r
, 0);

800 ià(!*
İrg
 || *
’d±r
 || 
timeout
 < 0) {

801 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

802 "Inv®id idËimeouˆv®ue:", 
İrg
);

803 
	`£rv”_ä“
(
¤v
);

806 
idË_lim™
 = (
time_t
)
timeout
;

809 'p': 
´št_cÚfig
 = 1; ;

810 't': ++
‹¡_cÚfig
; ;

811 '1': 
ÚeshÙ_fd
 = 
	`dup
(
STDIN_FILENO
); ;

812 'D': 
¤v
->
¤vcÚf
.
dÚt_d«mÚize
 = 1; ;

813 'v': 
	`show_v”siÚ
(); 
	`£rv”_ä“
(
¤v
);  0;

814 'V': 
	`show_ã©u»s
(); 
	`£rv”_ä“
(
¤v
);  0;

815 'h': 
	`show_h–p
(); 
	`£rv”_ä“
(
¤v
);  0;

817 
	`show_h–p
();

818 
	`£rv”_ä“
(
¤v
);

823 ià(!
¤v
->
cÚfig_¡Üage
) {

824 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

827 
	`£rv”_ä“
(
¤v
);

831 ià(
´št_cÚfig
) {

832 
d©a_un£t
 *
dc
 = 
¤v
->
cÚfig_cÚ‹xt
->
d©a
[0];

833 ià(
dc
) {

834 
dc
->
	`´št
(dc, 0);

835 
	`årštf
(
¡dout
, "\n");

838 
	`årštf
(
¡d”r
, "global config‚ot found\n");

842 ià(
‹¡_cÚfig
) {

843 ià(1 =ğ
‹¡_cÚfig
) {

844 
	`´štf
("Syntax OK\n");

846 
‹¡_cÚfig
 = 0;

847 
¤v
->
¤vcÚf
.
´eæight_check
 = 1;

848 
¤v
->
¤vcÚf
.
dÚt_d«mÚize
 = 1;

849 
	`bufãr_»£t
(
¤v
->
¤vcÚf
.
pid_fe
);

853 ià(
‹¡_cÚfig
 || 
´št_cÚfig
) {

854 
	`£rv”_ä“
(
¤v
);

858 ià(
ÚeshÙ_fd
) {

859 ià(
ÚeshÙ_fd
 <ğ
STDERR_FILENO
) {

860 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

862 
	`£rv”_ä“
(
¤v
);

865 
g¿ûful_shutdown
 = 1;

866 
¤v
->
sock‘s_di§bËd
 = 1;

867 
¤v
->
¤vcÚf
.
dÚt_d«mÚize
 = 1;

868 
	`bufãr_»£t
(
¤v
->
¤vcÚf
.
pid_fe
);

869 ià(
¤v
->
¤vcÚf
.
max_wÜk”
) {

870 
¤v
->
¤vcÚf
.
max_wÜk”
 = 0;

871 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

877 
	`İ’DevNuÎ
(
STDIN_FILENO
);

878 
	`İ’DevNuÎ
(
STDOUT_FILENO
);

880 ià(0 !ğ
	`cÚfig_£t_deçuÉs
(
¤v
)) {

881 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

883 
	`£rv”_ä“
(
¤v
);

888 #ifdeà
HAVE_GETUID


889 ià(!
i_am_roÙ
 && 
	`is£tugid
()) {

892 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

895 
	`£rv”_ä“
(
¤v
);

901 ià(
	`bufãr_¡ršg_is_em±y
(
¤v
->
cÚfig_¡Üage
[0]->
docum’t_roÙ
)) {

902 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

905 
	`£rv”_ä“
(
¤v
);

910 ià(
	`¶ugšs_lßd
(
¤v
)) {

911 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

914 
	`¶ugšs_ä“
(
¤v
);

915 
	`£rv”_ä“
(
¤v
);

921 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
pid_fe
)) {

922 ià(-1 =ğ(
pid_fd
 = 
	`fdev’t_İ’_şÛxec
(
¤v
->
¤vcÚf
.
pid_fe
->
±r
, 
O_WRONLY
 | 
O_CREAT
 | 
O_EXCL
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
))) {

923 
¡©
 
¡
;

924 ià(
”ºo
 !ğ
EEXIST
) {

925 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

926 "İ’šg…id-fçed:", 
¤v
->
¤vcÚf
.
pid_fe
, 
	`¡»¼Ü
(
”ºo
));

930 ià(0 !ğ
	`¡©
(
¤v
->
¤vcÚf
.
pid_fe
->
±r
, &
¡
)) {

931 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

932 "¡©šgƒxi¡šg…id-fçed:", 
¤v
->
¤vcÚf
.
pid_fe
, 
	`¡»¼Ü
(
”ºo
));

935 ià(!
	`S_ISREG
(
¡
.
¡_mode
)) {

936 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

937 "pid-fexi¡ ªd i¢'ˆ»guÏ¸fe:", 
¤v
->
¤vcÚf
.
pid_fe
);

941 ià(-1 =ğ(
pid_fd
 = 
	`İ’
(
¤v
->
¤vcÚf
.
pid_fe
->
±r
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
))) {

942 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

943 "İ’šg…id-fçed:", 
¤v
->
¤vcÚf
.
pid_fe
, 
	`¡»¼Ü
(
”ºo
));

949 ià(
¤v
->
ev’t_hªdËr
 =ğ
FDEVENT_HANDLER_SELECT
) {

954 
¤v
->
max_fds
 = 
FD_SETSIZE
 - 200;

956 
¤v
->
max_fds
 = 4096;

959 ià(
i_am_roÙ
) {

960 
group
 *
g½
 = 
NULL
;

961 
·sswd
 *
pwd
 = 
NULL
;

962 
u£_¾im™
 = 1;

964 #ifdeà
HAVE_VALGRIND_VALGRIND_H


965 ià(
RUNNING_ON_VALGRIND
è
u£_¾im™
 = 0;

968 #ifdeà
HAVE_GETRLIMIT


969 ià(0 !ğ
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾im
)) {

970 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

972 
	`¡»¼Ü
(
”ºo
));

976 ià(
u£_¾im™
 && 
¤v
->
¤vcÚf
.
max_fds
) {

979 
¾im
.
¾im_cur
 = 
¤v
->
¤vcÚf
.
max_fds
;

980 
¾im
.
¾im_max
 = 
¤v
->
¤vcÚf
.
max_fds
;

982 ià(0 !ğ
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾im
)) {

983 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

985 
	`¡»¼Ü
(
”ºo
));

990 ià(
¤v
->
ev’t_hªdËr
 =ğ
FDEVENT_HANDLER_SELECT
) {

991 
¤v
->
max_fds
 = 
¾im
.
¾im_cur
 < (
¾im_t
)
FD_SETSIZE
 - 200 ? ()rlim.rlim_cur : ()FD_SETSIZE - 200;

993 
¤v
->
max_fds
 = 
¾im
.
¾im_cur
;

997 ià(
u£_¾im™
 && 
¤v
->
¤vcÚf
.
’abË_cÜes
 && 
	`g‘¾im™
(
RLIMIT_CORE
, &
¾im
) == 0) {

998 
¾im
.
¾im_cur
 =„lim.
¾im_max
;

999 
	`£Œlim™
(
RLIMIT_CORE
, &
¾im
);

1002 ià(
¤v
->
ev’t_hªdËr
 =ğ
FDEVENT_HANDLER_SELECT
) {

1004 ià(
¤v
->
max_fds
 > (()
FD_SETSIZE
) - 200) {

1005 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1006 "ÿn'ˆ¿i£ max fedesütÜ above", 
FD_SETSIZE
 - 200,

1013 #ifdeà
HAVE_PWD_H


1015 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
grou²ame
)) {

1016 ià(
NULL
 =ğ(
g½
 = 
	`g‘gºam
(
¤v
->
¤vcÚf
.
grou²ame
->
±r
))) {

1017 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1018 "ÿn'ˆfšd grou²ame", 
¤v
->
¤vcÚf
.
grou²ame
);

1023 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
u£ºame
)) {

1024 ià(
NULL
 =ğ(
pwd
 = 
	`g‘pwÇm
(
¤v
->
¤vcÚf
.
u£ºame
->
±r
))) {

1025 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

1026 "ÿn'ˆfšd u£ºame", 
¤v
->
¤vcÚf
.
u£ºame
);

1030 ià(
pwd
->
pw_uid
 == 0) {

1031 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1036 ià(
NULL
 =ğ
g½
 && NULL =ğ(g½ = 
	`g‘grgid
(
pwd
->
pw_gid
))) {

1037 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1038 "ÿn'ˆfšd grou°id", 
pwd
->
pw_gid
);

1043 ià(
NULL
 !ğ
g½
) {

1044 ià(
g½
->
gr_gid
 == 0) {

1045 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1052 ià(0 !ğ
	`ÃtwÜk_š™
(
¤v
)) {

1053 
	`¶ugšs_ä“
(
¤v
);

1054 
	`£rv”_ä“
(
¤v
);

1058 #ifdeà
HAVE_PWD_H


1063 ià(
NULL
 !ğ
g½
) {

1064 ià(-1 =ğ
	`£tgid
(
g½
->
gr_gid
)) {

1065 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "£tgid faed: ", 
	`¡»¼Ü
(
”ºo
));

1068 ià(-1 =ğ
	`£tgroups
(0, 
NULL
)) {

1069 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "£tgroup çed: ", 
	`¡»¼Ü
(
”ºo
));

1072 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
u£ºame
)) {

1073 
	`š™groups
(
¤v
->
¤vcÚf
.
u£ºame
->
±r
, 
g½
->
gr_gid
);

1077 #ifdeà
HAVE_CHROOT


1078 ià(!
	`bufãr_¡ršg_is_em±y
(
¤v
->
¤vcÚf
.
chªg”oÙ
)) {

1079 
	`tz£t
();

1081 ià(-1 =ğ
	`chroÙ
(
¤v
->
¤vcÚf
.
chªg”oÙ
->
±r
)) {

1082 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "chroÙ faed: ", 
	`¡»¼Ü
(
”ºo
));

1085 ià(-1 =ğ
	`chdœ
("/")) {

1086 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "chdœ faed: ", 
	`¡»¼Ü
(
”ºo
));

1091 #ifdeà
HAVE_PWD_H


1093 ià(
NULL
 !ğ
pwd
) {

1094 ià(-1 =ğ
	`£tuid
(
pwd
->
pw_uid
)) {

1095 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "£tuid faed: ", 
	`¡»¼Ü
(
”ºo
));

1100 #ià
	`defšed
(
HAVE_SYS_PRCTL_H
è&& defšed(
PR_SET_DUMPABLE
)

1104 ià(
¤v
->
¤vcÚf
.
’abË_cÜes
) {

1105 
	`´ùl
(
PR_SET_DUMPABLE
, 1, 0, 0, 0);

1110 #ifdeà
HAVE_GETRLIMIT


1111 ià(0 !ğ
	`g‘¾im™
(
RLIMIT_NOFILE
, &
¾im
)) {

1112 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

1114 
	`¡»¼Ü
(
”ºo
));

1121 ià(
¤v
->
¤vcÚf
.
max_fds
 && srv->¤vcÚf.max_fd <ğ
¾im
.
¾im_max
) {

1124 
¾im
.
¾im_cur
 = 
¤v
->
¤vcÚf
.
max_fds
;

1126 ià(0 !ğ
	`£Œlim™
(
RLIMIT_NOFILE
, &
¾im
)) {

1127 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

1129 
	`¡»¼Ü
(
”ºo
));

1134 ià(
¤v
->
ev’t_hªdËr
 =ğ
FDEVENT_HANDLER_SELECT
) {

1135 
¤v
->
max_fds
 = 
¾im
.
¾im_cur
 < (
¾im_t
)
FD_SETSIZE
 - 200 ? ()rlim.rlim_cur : ()FD_SETSIZE - 200;

1137 
¤v
->
max_fds
 = 
¾im
.
¾im_cur
;

1141 ià(
¤v
->
¤vcÚf
.
’abË_cÜes
 && 
	`g‘¾im™
(
RLIMIT_CORE
, &
¾im
) == 0) {

1142 
¾im
.
¾im_cur
 =„lim.
¾im_max
;

1143 
	`£Œlim™
(
RLIMIT_CORE
, &
¾im
);

1147 ià(
¤v
->
ev’t_hªdËr
 =ğ
FDEVENT_HANDLER_SELECT
) {

1149 ià(
¤v
->
max_fds
 > (()
FD_SETSIZE
) - 200) {

1150 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1151 "ÿn'ˆ¿i£ max fedesütÜ above", 
FD_SETSIZE
 - 200,

1157 ià(0 !ğ
	`ÃtwÜk_š™
(
¤v
)) {

1158 
	`¶ugšs_ä“
(
¤v
);

1159 
	`£rv”_ä“
(
¤v
);

1166 ià(
¤v
->
¤vcÚf
.
max_cÚns
 > srv->
max_fds
/2) {

1168 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd", "ÿn'ˆhavmÜcÚÃùiÚ thª fds/2: ", srv->
¤vcÚf
.
max_cÚns
, srv->
max_fds
);

1169 
¤v
->
max_cÚns
 = srv->
max_fds
/2;

1170 } ià(
¤v
->
¤vcÚf
.
max_cÚns
) {

1172 
¤v
->
max_cÚns
 = srv->
¤vcÚf
.max_conns;

1175 
¤v
->
max_cÚns
 = srv->
max_fds
/3;

1178 ià(
HANDLER_GO_ON
 !ğ
	`¶ugšs_ÿÎ_š™
(
¤v
)) {

1179 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "Initialization of…lugins failed. Going down.");

1181 
	`¶ugšs_ä“
(
¤v
);

1182 
	`ÃtwÜk_şo£
(
¤v
);

1183 
	`£rv”_ä“
(
¤v
);

1188 #ifdeà
HAVE_FORK


1190 ià(
¤v
->
¤vcÚf
.
dÚt_d«mÚize
 == 0) {

1191 
·»Á_pe_fd
 = 
	`d«mÚize
();

1196 #ifdeà
HAVE_SIGACTION


1197 
	`mem£t
(&
aù
, 0, (act));

1198 
aù
.
§_hªdËr
 = 
SIG_IGN
;

1199 
	`sigaùiÚ
(
SIGPIPE
, &
aù
, 
NULL
);

1200 
	`sigaùiÚ
(
SIGUSR1
, &
aù
, 
NULL
);

1201 #ià
	`defšed
(
SA_SIGINFO
)

1202 
aù
.
§_sigaùiÚ
 = 
sigaùiÚ_hªdËr
;

1203 
	`sigem±y£t
(&
aù
.
§_mask
);

1204 
aù
.
§_æags
 = 
SA_SIGINFO
;

1206 
aù
.
§_hªdËr
 = 
sigÇl_hªdËr
;

1207 
	`sigem±y£t
(&
aù
.
§_mask
);

1208 
aù
.
§_æags
 = 0;

1210 
	`sigaùiÚ
(
SIGINT
, &
aù
, 
NULL
);

1211 
	`sigaùiÚ
(
SIGTERM
, &
aù
, 
NULL
);

1212 
	`sigaùiÚ
(
SIGHUP
, &
aù
, 
NULL
);

1213 
	`sigaùiÚ
(
SIGALRM
, &
aù
, 
NULL
);

1216 
aù
.
§_æags
 |ğ
SA_RESTART
 | 
SA_NOCLDSTOP
;

1217 
	`sigaùiÚ
(
SIGCHLD
, &
aù
, 
NULL
);

1219 #–ià
	`defšed
(
HAVE_SIGNAL
)

1221 
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

1222 
	`sigÇl
(
SIGUSR1
, 
SIG_IGN
);

1223 
	`sigÇl
(
SIGALRM
, 
sigÇl_hªdËr
);

1224 
	`sigÇl
(
SIGTERM
, 
sigÇl_hªdËr
);

1225 
	`sigÇl
(
SIGHUP
, 
sigÇl_hªdËr
);

1226 
	`sigÇl
(
SIGCHLD
, 
sigÇl_hªdËr
);

1227 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

1230 #ifdeà
USE_ALARM


1231 
	`sigÇl
(
SIGALRM
, 
sigÇl_hªdËr
);

1234 ià(
	`£t™im”
(
ITIMER_REAL
, &
š‹rv®
, 
NULL
)) {

1235 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "settingimer failed");

1239 
	`g‘™im”
(
ITIMER_REAL
, &
š‹rv®
);

1243 
¤v
->
gid
 = 
	`g‘gid
();

1244 
¤v
->
uid
 = 
	`g‘uid
();

1247 ià(
pid_fd
 != -1) {

1248 
	`bufãr_cİy_št
(
¤v
->
tmp_buf
, 
	`g‘pid
());

1249 
	`bufãr_­³nd_¡ršg_Ën
(
¤v
->
tmp_buf
, 
	`CONST_STR_LEN
("\n"));

1250 ià(-1 =ğ
	`wr™e_®l
(
pid_fd
, 
	`CONST_BUF_LEN
(
¤v
->
tmp_buf
))) {

1251 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "Couldn'ˆwr™pid fe:", 
	`¡»¼Ü
(
”ºo
));

1252 
	`şo£
(
pid_fd
);

1259 ià(!
¤v
->
¤vcÚf
.
´eæight_check
 && -1 =ğ
	`log_”rÜ_İ’
(srv)) {

1260 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "Openingƒrrorlog failed. Going down.");

1262 
	`¶ugšs_ä“
(
¤v
);

1263 
	`ÃtwÜk_şo£
(
¤v
);

1264 
	`£rv”_ä“
(
¤v
);

1268 ià(
HANDLER_GO_ON
 !ğ
	`¶ugšs_ÿÎ_£t_deçuÉs
(
¤v
)) {

1269 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "Configuration of…lugins failed. Going down.");

1271 
	`¶ugšs_ä“
(
¤v
);

1272 
	`ÃtwÜk_şo£
(
¤v
);

1273 
	`£rv”_ä“
(
¤v
);

1279 
¤v
->
cÚfig_¡Üage
[0]->
high_´ecisiÚ_time¡amps
 = srv->
¤vcÚf
.high_precision_timestamps;

1282 
i
 = 0; i < 
¤v
->
cÚfig_cÚ‹xt
->
u£d
; i++) {

1283 
¬¿y
 *
cÚfig
 = ((
d©a_cÚfig
 *)
¤v
->
cÚfig_cÚ‹xt
->
d©a
[
i
])->
v®ue
;

1284 
size_t
 
j
;

1286 
j
 = 0; 
cÚfig
 && j < cÚfig->
u£d
; j++) {

1287 
d©a_un£t
 *
du
 = 
cÚfig
->
d©a
[
j
];

1290 ià(
	`¡ºcmp
(
du
->
key
->
±r
, "var.", ("var.") - 1) == 0) {

1294 ià(
NULL
 =ğ
	`¬¿y_g‘_–em’t
(
¤v
->
cÚfig_touched
, 
du
->
key
->
±r
)) {

1295 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

1297 
du
->
key
,

1303 ià(
¤v
->
cÚfig_unsuµÜ‹d
) {

1304 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1308 ià(
¤v
->
cÚfig_d•»ÿ‹d
) {

1309 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1313 ià(
¤v
->
cÚfig_unsuµÜ‹d
 || srv->
cÚfig_d•»ÿ‹d
) {

1314 
	`¶ugšs_ä“
(
¤v
);

1315 
	`ÃtwÜk_şo£
(
¤v
);

1316 
	`£rv”_ä“
(
¤v
);

1321 ià(
¤v
->
¤vcÚf
.
´eæight_check
) {

1323 
	`¶ugšs_ä“
(
¤v
);

1324 
	`ÃtwÜk_şo£
(
¤v
);

1325 
	`£rv”_ä“
(
¤v
);

1327 
	`ex™
(0);

1331 #ifdeà
HAVE_FORK


1336 ià(
¤v
->
¤vcÚf
.
dÚt_d«mÚize
 == 0) {

1337 ià(0 > 
	`wr™e
(
·»Á_pe_fd
, "", 1))  -1;

1338 
	`şo£
(
·»Á_pe_fd
);

1341 ià(
idË_lim™
 && 
¤v
->
¤vcÚf
.
max_wÜk”
) {

1342 
¤v
->
¤vcÚf
.
max_wÜk”
 = 0;

1343 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1348 
num_chds
 = 
¤v
->
¤vcÚf
.
max_wÜk”
;

1349 ià(
num_chds
 > 0) {

1350 
chd
 = 0;

1351 !
chd
 && !
¤v_shutdown
 && !
g¿ûful_shutdown
) {

1352 ià(
num_chds
 > 0) {

1353 
	`fÜk
()) {

1357 
chd
 = 1;

1360 
num_chds
--;

1364 
¡©us
;

1366 ià(-1 !ğ
	`wa™
(&
¡©us
)) {

1370 
num_chds
++;

1372 
”ºo
) {

1373 
EINTR
:

1378 ià(
hªdË_sig_hup
) {

1379 
hªdË_sig_hup
 = 0;

1381 
	`log_”rÜ_cyşe
(
¤v
);

1388 ià(!
fÜw¬ded_sig_hup
 && 0 !ğ
¤v
->
¤vcÚf
.
max_wÜk”
) {

1389 
fÜw¬ded_sig_hup
 = 1;

1390 
	`kl
(0, 
SIGHUP
);

1404 ià(!
chd
) {

1408 ià(
g¿ûful_shutdown
) {

1409 
	`kl
(0, 
SIGINT
);

1410 } ià(
¤v_shutdown
) {

1411 
	`kl
(0, 
SIGTERM
);

1414 
	`»move_pid_fe
(
¤v
, &
pid_fd
);

1415 
	`log_”rÜ_şo£
(
¤v
);

1416 
	`ÃtwÜk_şo£
(
¤v
);

1417 
	`cÚÃùiÚs_ä“
(
¤v
);

1418 
	`¶ugšs_ä“
(
¤v
);

1419 
	`£rv”_ä“
(
¤v
);

1426 ià(0 <ğ
pid_fd
) {

1427 
	`şo£
(
pid_fd
);

1428 
pid_fd
 = -1;

1430 
	`bufãr_»£t
(
¤v
->
¤vcÚf
.
pid_fe
);

1432 
	`li_¿nd_»£ed
();

1436 ià(
NULL
 =ğ(
¤v
->
ev
 = 
	`fdev’t_š™
(¤v, srv->
max_fds
 + 1, srv->
ev’t_hªdËr
))) {

1437 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
,

1443 #ifdeà
HAVE_SIGACTION


1444 
	`sigaùiÚ
(
SIGCHLD
, &
aù
, 
NULL
);

1445 #–ià
	`defšed
(
HAVE_SIGNAL
)

1446 
	`sigÇl
(
SIGCHLD
, 
sigÇl_hªdËr
);

1454 ià(0 !ğ
	`ÃtwÜk_»gi¡”_fdev’ts
(
¤v
)) {

1455 
	`¶ugšs_ä“
(
¤v
);

1456 
	`ÃtwÜk_şo£
(
¤v
);

1457 
	`£rv”_ä“
(
¤v
);

1463 ià(
NULL
 =ğ(
¤v
->
¡©_ÿche
 = 
	`¡©_ÿche_š™
())) {

1464 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1469 #ifdeà
HAVE_FAM_H


1471 ià(
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 =ğ
STAT_CACHE_ENGINE_FAM
) {

1472 ià(0 !ğ
	`FAMO³n2
(&
¤v
->
¡©_ÿche
->
çm
, "lighttpd")) {

1473 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1477 #ifdeà
HAVE_FAMNOEXISTS


1478 
	`FAMNoExi¡s
(&
¤v
->
¡©_ÿche
->
çm
);

1481 
	`fd_şo£_Ú_exec
(
	`FAMCONNECTION_GETFD
(&
¤v
->
¡©_ÿche
->
çm
));

1482 
	`fdev’t_»gi¡”
(
¤v
->
ev
, 
	`FAMCONNECTION_GETFD
(&¤v->
¡©_ÿche
->
çm
), 
¡©_ÿche_hªdË_fdev’t
, 
NULL
);

1483 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(¤v->
¡©_ÿche
->
çm_fcû_ndx
), 
	`FAMCONNECTION_GETFD
(&¤v->¡©_ÿche->
çm
), 
FDEVENT_IN
);

1489 
¤v
->
cur_fds
 = 
	`İ’
("/dev/nuÎ", 
O_RDONLY
);

1490 
	`şo£
(
¤v
->
cur_fds
);

1492 
i
 = 0; i < 
¤v
->
¤v_sock‘s
.
u£d
; i++) {

1493 
£rv”_sock‘
 *
¤v_sock‘
 = 
¤v
->
¤v_sock‘s
.
±r
[
i
];

1494 ià(
¤v
->
sock‘s_di§bËd
) ;

1495 ià(-1 =ğ
	`fdev’t_fú_£t_nb_şÛxec_sock
(
¤v
->
ev
, 
¤v_sock‘
->
fd
)) {

1496 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss", "fú faed:", 
	`¡»¼Ü
(
”ºo
));

1501 ià(
ÚeshÙ_fd
 && 
	`£rv”_ÚeshÙ_š™
(
¤v
, oneshot_fd)) {

1502 
ÚeshÙ_fd
 = -1;

1506 !
¤v_shutdown
) {

1507 
n
;

1508 
size_t
 
ndx
;

1509 
time_t
 
mš_ts
;

1511 ià(
hªdË_sig_hup
) {

1512 
hªdËr_t
 
r
;

1515 
hªdË_sig_hup
 = 0;

1520 
r
 = 
	`¶ugšs_ÿÎ_hªdË_sighup
(
¤v
)) {

1521 
HANDLER_GO_ON
:

1524 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd", "sighup-hªdË¸»tuº w™h‡À”rÜ", 
r
);

1528 ià(-1 =ğ
	`log_”rÜ_cyşe
(
¤v
)) {

1529 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "cyclingƒrrorlog failed, dying");

1533 #ifdeà
HAVE_SIGACTION


1534 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

1536 
Ï¡_sighup_šfo
.
si_uid
,

1538 
Ï¡_sighup_šfo
.
si_pid
);

1540 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1546 ià(
hªdË_sig_®¬m
) {

1549 #ifdeà
USE_ALARM


1551 
hªdË_sig_®¬m
 = 0;

1555 
mš_ts
 = 
	`time
(
NULL
);

1557 ià(
mš_ts
 !ğ
¤v
->
cur_ts
) {

1558 #ifdeà
DEBUG_CONNECTION_STATES


1559 
cs
 = 0;

1561 
cÚÃùiÚs
 *
cÚns
 = 
¤v
->conns;

1562 
hªdËr_t
 
r
;

1564 
r
 = 
	`¶ugšs_ÿÎ_hªdË_Œigg”
(
¤v
)) {

1565 
HANDLER_GO_ON
:

1567 
HANDLER_ERROR
:

1568 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "one ofheriggers failed");

1571 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "d", 
r
);

1576 
¤v
->
cur_ts
 = 
mš_ts
;

1579 ià(
idË_lim™
 && idË_lim™ < 
mš_ts
 - 
Ï¡_aùive_ts
 && !
g¿ûful_shutdown
) {

1580 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sDs", "[nÙe] idËimeout", ()
idË_lim™
,

1582 
g¿ûful_shutdown
 = 2;

1585 #ifdeà
HAVE_GETLOADAVG


1587 ià(
¤v
->
¤vcÚf
.
lßdts
 + 30 < 
mš_ts
) {

1588 ià(-1 !ğ
	`g‘lßdavg
(
¤v
->
¤vcÚf
.
lßdavg
, 3)) {

1589 
¤v
->
¤vcÚf
.
lßdts
 = 
mš_ts
;

1595 
	`¡©_ÿche_Œigg”_ş—nup
(
¤v
);

1600 
ndx
 = 0;‚dx < 
cÚns
->
u£d
;‚dx++) {

1601 
cÚÃùiÚ
 * cÚ¡ 
cÚ
 = 
cÚns
->
±r
[
ndx
];

1602 cÚ¡ 
wa™ev’ts
 = 
	`fdev’t_ev’t_g‘_š‹»¡
(
¤v
->
ev
, 
cÚ
->
fd
);

1603 
chªged
 = 0;

1604 
t_diff
;

1606 ià(
cÚ
->
¡©e
 =ğ
CON_STATE_CLOSE
) {

1607 ià(
¤v
->
cur_ts
 - 
cÚ
->
şo£_timeout_ts
 > 
HTTP_LINGER_TIMEOUT
) {

1608 
chªged
 = 1;

1610 } ià(
wa™ev’ts
 & 
FDEVENT_IN
) {

1611 ià(
cÚ
->
»que¡_couÁ
 =ğ1 || cÚ->
¡©e
 !ğ
CON_STATE_READ
) {

1612 ià(
¤v
->
cur_ts
 - 
cÚ
->
»ad_idË_ts
 > cÚ->
cÚf
.
max_»ad_idË
) {

1614 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

1615 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1616 "cÚÃùiÚ clo£d -„—dimeout:", 
cÚ
->
fd
);

1619 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1620 
chªged
 = 1;

1623 ià(
¤v
->
cur_ts
 - 
cÚ
->
»ad_idË_ts
 > cÚ->
k“p_®ive_idË
) {

1625 ià(
cÚ
->
cÚf
.
log_»que¡_hªdlšg
) {

1626 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sd",

1627 "cÚÃùiÚ clo£d - k“p-®ivtimeout:", 
cÚ
->
fd
);

1630 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1631 
chªged
 = 1;

1641 ià((
cÚ
->
¡©e
 =ğ
CON_STATE_WRITE
) &&

1642 (
cÚ
->
wr™e_»que¡_ts
 != 0)) {

1644 ià(
¤v
->
cur_ts
 - 
cÚ
->
wr™e_»que¡_ts
 > 60) {

1645 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdd",

1646 "cÚÃùiÚ clo£d -…»-wr™e-»que¡-timeout:", 
cÚ
->
fd
, 
¤v
->
cur_ts
 - cÚ->
wr™e_»que¡_ts
);

1650 ià(
¤v
->
cur_ts
 - 
cÚ
->
wr™e_»que¡_ts
 > cÚ->
cÚf
.
max_wr™e_idË
) {

1652 ià(
cÚ
->
cÚf
.
log_timeouts
) {

1653 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbsosds",

1655 
cÚ
->
d¡_addr_buf
,

1657 
cÚ
->
»que¡
.
uri
,

1659 
cÚ
->
by‹s_wr™‹n
,

1661 ()
cÚ
->
cÚf
.
max_wr™e_idË
,

1664 
	`cÚÃùiÚ_£t_¡©e
(
¤v
, 
cÚ
, 
CON_STATE_ERROR
);

1665 
chªged
 = 1;

1670 ià(0 =ğ(
t_diff
 = 
¤v
->
cur_ts
 - 
cÚ
->
cÚÃùiÚ_¡¬t
))_diff = 1;

1672 ià(
cÚ
->
Œaffic_lim™_»ached
 &&

1673 (
cÚ
->
cÚf
.
kby‹s_³r_£cÚd
 == 0 ||

1674 ((
cÚ
->
by‹s_wr™‹n
 / 
t_diff
è< cÚ->
cÚf
.
kby‹s_³r_£cÚd
 * 1024))) {

1676 
cÚ
->
Œaffic_lim™_»ached
 = 0;

1678 
chªged
 = 1;

1681 ià(
chªged
) {

1682 
	`cÚÃùiÚ_¡©e_machše
(
¤v
, 
cÚ
);

1684 
cÚ
->
by‹s_wr™‹n_cur_£cÚd
 = 0;

1685 *(
cÚ
->
cÚf
.
glob®_by‹s_³r_£cÚd_út_±r
) = 0;

1687 #ià
DEBUG_CONNECTION_STATES


1688 ià(
cs
 == 0) {

1689 
	`årštf
(
¡d”r
, "connection-state: ");

1690 
cs
 = 1;

1693 
	`årštf
(
¡d”r
, "c[%d,%d]: %s ",

1694 
cÚ
->
fd
,

1695 
cÚ
->
fcgi
.
fd
,

1696 
	`cÚÃùiÚ_g‘_¡©e
(
cÚ
->
¡©e
));

1700 #ifdeà
DEBUG_CONNECTION_STATES


1701 ià(
cs
 =ğ1è
	`årštf
(
¡d”r
, "\n");

1706 ià(
¤v
->
sock‘s_di§bËd
) {

1709 ià((
¤v
->
cur_fds
 + srv->
wªt_fds
 < srv->
max_fds
 * 8 / 10) &&

1710 (
¤v
->
cÚns
->
u£d
 <ğ¤v->
max_cÚns
 * 9 / 10) &&

1711 (0 =ğ
g¿ûful_shutdown
)) {

1712 
i
 = 0; i < 
¤v
->
¤v_sock‘s
.
u£d
; i++) {

1713 
£rv”_sock‘
 *
¤v_sock‘
 = 
¤v
->
¤v_sock‘s
.
±r
[
i
];

1714 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
¤v_sock‘
->
fde_ndx
), srv_sock‘->
fd
, 
FDEVENT_IN
);

1717 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "[note] socketsƒnabled‡gain");

1719 
¤v
->
sock‘s_di§bËd
 = 0;

1722 ià((
¤v
->
cur_fds
 + srv->
wªt_fds
 > srv->
max_fds
 * 9 / 10) ||

1723 (
¤v
->
cÚns
->
u£d
 >ğ¤v->
max_cÚns
) ||

1724 (
g¿ûful_shutdown
)) {

1728 
i
 = 0; i < 
¤v
->
¤v_sock‘s
.
u£d
; i++) {

1729 
£rv”_sock‘
 *
¤v_sock‘
 = 
¤v
->
¤v_sock‘s
.
±r
[
i
];

1731 ià(
g¿ûful_shutdown
) {

1738 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
¤v_sock‘
->
fde_ndx
), srv_sock‘->
fd
);

1739 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
¤v_sock‘
->
fd
);

1740 
	`şo£
(
¤v_sock‘
->
fd
);

1741 
¤v_sock‘
->
fd
 = -1;

1745 
	`fdev’t_ev’t_£t
(
¤v
->
ev
, &(
¤v_sock‘
->
fde_ndx
), srv_sock‘->
fd
, 0);

1749 ià(
g¿ûful_shutdown
) {

1750 
	`»move_pid_fe
(
¤v
, &
pid_fd
);

1751 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "[note] graceful shutdown started");

1752 } ià(
¤v
->
cÚns
->
u£d
 >ğ¤v->
max_cÚns
) {

1753 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "[note] sockets disabled, connection†imit„eached");

1755 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "[note] sockets disabled, out-of-fds");

1758 
¤v
->
sock‘s_di§bËd
 = 1;

1762 ià(
g¿ûful_shutdown
 && 
¤v
->
cÚns
->
u£d
 == 0) {

1765 
¤v_shutdown
 = 1;

1770 ià(
¤v
->
wªt_fds
) {

1772 
ä“_fds
 = 
¤v
->
max_fds
 - srv->
cur_fds
 - 16;

1773 
cÚÃùiÚ
 *
cÚ
;

1775 ; 
ä“_fds
 > 0 && 
NULL
 !ğ(
cÚ
 = 
	`fdwa™queue_unshiá
(
¤v
, srv->
fdwa™queue
)); free_fds--) {

1776 
	`cÚÃùiÚ_¡©e_machše
(
¤v
, 
cÚ
);

1778 
¤v
->
wªt_fds
--;

1782 ià((
n
 = 
	`fdev’t_pŞl
(
¤v
->
ev
, 1000)) > 0) {

1784 
»v’ts
;

1785 
fd_ndx
;

1786 
Ï¡_aùive_ts
 = 
¤v
->
cur_ts
;

1787 
fd_ndx
 = -1;

1789 
fdev’t_hªdËr
 
hªdËr
;

1790 *
cÚ‹xt
;

1792 
fd_ndx
 = 
	`fdev’t_ev’t_Ãxt_fdndx
 (
¤v
->
ev
, fd_ndx);

1793 ià(-1 =ğ
fd_ndx
) ;

1795 
»v’ts
 = 
	`fdev’t_ev’t_g‘_»v’t
 (
¤v
->
ev
, 
fd_ndx
);

1796 
fd
 = 
	`fdev’t_ev’t_g‘_fd
 (
¤v
->
ev
, 
fd_ndx
);

1797 
hªdËr
 = 
	`fdev’t_g‘_hªdËr
(
¤v
->
ev
, 
fd
);

1798 
cÚ‹xt
 = 
	`fdev’t_g‘_cÚ‹xt
(
¤v
->
ev
, 
fd
);

1799 ià(
NULL
 !ğ
hªdËr
) {

1800 (*
hªdËr
)(
¤v
, 
cÚ‹xt
, 
»v’ts
);

1802 } --
n
 > 0);

1803 
	`fdev’t_sched_run
(
¤v
, srv->
ev
);

1804 } ià(
n
 < 0 && 
”ºo
 !ğ
EINTR
) {

1805 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "ss",

1807 
	`¡»¼Ü
(
”ºo
));

1810 
ndx
 = 0;‚dx < 
¤v
->
jobli¡
->
u£d
;‚dx++) {

1811 
cÚÃùiÚ
 *
cÚ
 = 
¤v
->
jobli¡
->
±r
[
ndx
];

1812 
	`cÚÃùiÚ_¡©e_machše
(
¤v
, 
cÚ
);

1813 
cÚ
->
š_jobli¡
 = 0;

1816 
¤v
->
jobli¡
->
u£d
 = 0;

1819 ià(0 =ğ
g¿ûful_shutdown
) {

1820 
	`»move_pid_fe
(
¤v
, &
pid_fd
);

1823 ià(2 =ğ
g¿ûful_shutdown
) {

1824 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1827 #ifdeà
HAVE_SIGACTION


1828 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sdsd",

1830 
Ï¡_sig‹rm_šfo
.
si_uid
,

1832 
Ï¡_sig‹rm_šfo
.
si_pid
);

1834 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s",

1840 
	`log_”rÜ_şo£
(
¤v
);

1841 
	`ÃtwÜk_şo£
(
¤v
);

1842 
	`cÚÃùiÚs_ä“
(
¤v
);

1843 
	`¶ugšs_ä“
(
¤v
);

1844 
	`£rv”_ä“
(
¤v
);

1847 
	}
}

	@server.h

1 #iâdeà
_SERVER_H_


2 
	#_SERVER_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

7 
cÚfig_»ad
(
£rv”
 *
¤v
, cÚ¡ *
â
);

8 
cÚfig_£t_deçuÉs
(
£rv”
 *
¤v
);

	@settings.h

1 #iâdeà
_LIGHTTPD_SETTINGS_H_


2 
	#_LIGHTTPD_SETTINGS_H_


	)

3 
	~"fœ¡.h
"

5 #ifdeà
__GNUC__


6 
	#LI_NORETURN
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

8 
	#LI_NORETURN


	)

11 
	#UNUSED
(
x
èĞ()(xè)

	)

13 
	#BV
(
x
è(1 << x)

	)

15 
	#INET_NTOP_CACHE_MAX
 4

	)

16 
	#FILE_CACHE_MAX
 16

	)

24 
	#BUFFER_MAX_REUSE_SIZE
 (4 * 1024)

	)

27 
	#MAX_READ_LIMIT
 (256*1024)

	)

28 
	#MAX_WRITE_LIMIT
 (256*1024)

	)

36 
	#MAX_HTTP_REQUEST_HEADER
 (32 * 1024)

	)

38 ’um { 
	mHANDLER_UNSET
,

39 
	mHANDLER_GO_ON
,

40 
	mHANDLER_FINISHED
,

41 
	mHANDLER_COMEBACK
,

42 
	mHANDLER_WAIT_FOR_EVENT
,

43 
	mHANDLER_ERROR
,

44 
	mHANDLER_WAIT_FOR_FD


45 } 
	thªdËr_t
;

47 
	#HTTP_LINGER_TIMEOUT
 5

	)

	@splaytree.c

49 
	~"¥ÏyŒ“.h
"

50 
	~<¡dlib.h
>

51 
	~<as£¹.h
>

53 
	#com·»
(
i
,
j
è((i)-(j))

	)

57 
	#node_size
 
¥ÏyŒ“_size


	)

62 
¥Ïy_Œ“
 * 
	$¥ÏyŒ“_¥Ïy
 (
¥Ïy_Œ“
 *
t
, 
i
) {

63 
¥Ïy_Œ“
 
N
, *
l
, *
r
, *
y
;

64 
comp
, 
l_size
, 
r_size
;

66 ià(
t
 =ğ
NULL
) ;

67 
N
.
Ëá
 = N.
right
 = 
NULL
;

68 
l
 = 
r
 = &
N
;

69 
l_size
 = 
r_size
 = 0;

72 
comp
 = 
	`com·»
(
i
, 
t
->
key
);

73 ià(
comp
 < 0) {

74 ià(
t
->
Ëá
 =ğ
NULL
) ;

75 ià(
	`com·»
(
i
, 
t
->
Ëá
->
key
) < 0) {

76 
y
 = 
t
->
Ëá
;

77 
t
->
Ëá
 = 
y
->
right
;

78 
y
->
right
 = 
t
;

79 
t
->
size
 = 
	`node_size
Ñ->
Ëá
è+‚ode_sizeÑ->
right
) + 1;

80 
t
 = 
y
;

81 ià(
t
->
Ëá
 =ğ
NULL
) ;

83 
r
->
Ëá
 = 
t
;

84 
r
 = 
t
;

85 
t
 =->
Ëá
;

86 
r_size
 +ğ1+
	`node_size
(
r
->
right
);

87 } ià(
comp
 > 0) {

88 ià(
t
->
right
 =ğ
NULL
) ;

89 ià(
	`com·»
(
i
, 
t
->
right
->
key
) > 0) {

90 
y
 = 
t
->
right
;

91 
t
->
right
 = 
y
->
Ëá
;

92 
y
->
Ëá
 = 
t
;

93 
t
->
size
 = 
	`node_size
Ñ->
Ëá
è+‚ode_sizeÑ->
right
) + 1;

94 
t
 = 
y
;

95 ià(
t
->
right
 =ğ
NULL
) ;

97 
l
->
right
 = 
t
;

98 
l
 = 
t
;

99 
t
 =->
right
;

100 
l_size
 +ğ1+
	`node_size
(
l
->
Ëá
);

105 
l_size
 +ğ
	`node_size
(
t
->
Ëá
);

106 
r_size
 +ğ
	`node_size
(
t
->
right
);

107 
t
->
size
 = 
l_size
 + 
r_size
 + 1;

109 
l
->
right
 = 
r
->
Ëá
 = 
NULL
;

114 
y
 = 
N
.
right
; y !ğ
NULL
; y = y->right) {

115 
y
->
size
 = 
l_size
;

116 
l_size
 -ğ1+
	`node_size
(
y
->
Ëá
);

118 
y
 = 
N
.
Ëá
; y !ğ
NULL
; y = y->left) {

119 
y
->
size
 = 
r_size
;

120 
r_size
 -ğ1+
	`node_size
(
y
->
right
);

123 
l
->
right
 = 
t
->
Ëá
;

124 
r
->
Ëá
 = 
t
->
right
;

125 
t
->
Ëá
 = 
N
.
right
;

126 
t
->
right
 = 
N
.
Ëá
;

128  
t
;

129 
	}
}

131 
¥Ïy_Œ“
 * 
	$¥ÏyŒ“_š£¹
(
¥Ïy_Œ“
 * 
t
, 
i
, *
d©a
) {

134 
¥Ïy_Œ“
 * 
Ãw
;

136 ià(
t
 !ğ
NULL
) {

137 
t
 = 
	`¥ÏyŒ“_¥Ïy
Ñ, 
i
);

138 ià(
	`com·»
(
i
, 
t
->
key
)==0) {

139  
t
;

142 
Ãw
 = (
¥Ïy_Œ“
 *è
	`m®loc
 ( (splay_tree));

143 
	`as£¹
(
Ãw
);

144 ià(
t
 =ğ
NULL
) {

145 
Ãw
->
Ëá
 =‚ew->
right
 = 
NULL
;

146 } ià(
	`com·»
(
i
, 
t
->
key
) < 0) {

147 
Ãw
->
Ëá
 = 
t
->left;

148 
Ãw
->
right
 = 
t
;

149 
t
->
Ëá
 = 
NULL
;

150 
t
->
size
 = 1+
	`node_size
Ñ->
right
);

152 
Ãw
->
right
 = 
t
->right;

153 
Ãw
->
Ëá
 = 
t
;

154 
t
->
right
 = 
NULL
;

155 
t
->
size
 = 1+
	`node_size
Ñ->
Ëá
);

157 
Ãw
->
key
 = 
i
;

158 
Ãw
->
d©a
 = data;

159 
Ãw
->
size
 = 1 + 
	`node_size
Òew->
Ëá
è+‚ode_sizeÒew->
right
);

160  
Ãw
;

161 
	}
}

163 
¥Ïy_Œ“
 * 
	$¥ÏyŒ“_d–‘e
(
¥Ïy_Œ“
 *
t
, 
i
) {

166 
¥Ïy_Œ“
 * 
x
;

167 
tsize
;

169 ià(
t
==
NULL
)  NULL;

170 
tsize
 = 
t
->
size
;

171 
t
 = 
	`¥ÏyŒ“_¥Ïy
Ñ, 
i
);

172 ià(
	`com·»
(
i
, 
t
->
key
) == 0) {

173 ià(
t
->
Ëá
 =ğ
NULL
) {

174 
x
 = 
t
->
right
;

176 
x
 = 
	`¥ÏyŒ“_¥Ïy
(
t
->
Ëá
, 
i
);

177 
x
->
right
 = 
t
->right;

179 
	`ä“
(
t
);

180 ià(
x
 !ğ
NULL
) {

181 
x
->
size
 = 
tsize
-1;

183  
x
;

185  
t
;

187 
	}
}

190 
¥Ïy_Œ“
 *
	$fšd_¿nk
(
r
, 
¥Ïy_Œ“
 *
t
) {

195 
lsize
;

196 ià((
r
 < 0è|| (¸>ğ
	`node_size
(
t
))è 
NULL
;

198 
lsize
 = 
	`node_size
(
t
->
Ëá
);

199 ià(
r
 < 
lsize
) {

200 
t
 =->
Ëá
;

201 } ià(
r
 > 
lsize
) {

202 
r
 =„ - 
lsize
 -1;

203 
t
 =->
right
;

205  
t
;

208 
	}
}

	@splaytree.h

1 #iâdeà
_SPLAY_TREE_H_


2 
	#_SPLAY_TREE_H_


	)

3 
	~"fœ¡.h
"

5 
	sŒ“_node
 {

6 
Œ“_node
 * 
	mËá
, * 
	mright
;

7 
	mkey
;

8 
	msize
;

10 *
	md©a
;

11 } 
	t¥Ïy_Œ“
;

14 
¥Ïy_Œ“
 * 
¥ÏyŒ“_¥Ïy
 (¥Ïy_Œ“ *
t
, 
key
);

15 
¥Ïy_Œ“
 * 
¥ÏyŒ“_š£¹
(¥Ïy_Œ“ *
t
, 
key
, *
d©a
);

16 
¥Ïy_Œ“
 * 
¥ÏyŒ“_d–‘e
(¥Ïy_Œ“ *
t
, 
key
);

17 
¥Ïy_Œ“
 * 
¥ÏyŒ“_size
(¥Ïy_Œ“ *
t
);

19 
	#¥ÏyŒ“_size
(
x
è(((x)==
NULL
è? 0 : ((x)->
size
))

	)

	@stat_cache.c

1 
	~"fœ¡.h
"

3 
	~"log.h
"

4 
	~"¡©_ÿche.h
"

5 
	~"fdev’t.h
"

6 
	~"‘ag.h
"

8 
	~<sys/ty³s.h
>

9 
	~<sys/¡©.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

13 
	~<”ºo.h
>

14 
	~<uni¡d.h
>

15 
	~<¡dio.h
>

16 
	~<fú.h
>

17 
	~<as£¹.h
>

19 #ifdeà
HAVE_ATTR_ATTRIBUTES_H


20 
	~<©Œ/©Œibu‹s.h
>

23 #ifdeà
HAVE_SYS_EXTATTR_H


24 
	~<sys/ex‰r.h
>

27 #ifdeà
HAVE_FAM_H


28 
	~<çm.h
>

31 #iâdeà
HAVE_LSTAT


32 
	#l¡©
 
¡©


	)

37 
	#DEBUG_STAT_CACHE


	)

64 #ifdeà
HAVE_FAM_H


66 
FAMReque¡
 *
	m»q
;

68 
bufãr
 *
	mÇme
;

70 
	mv”siÚ
;

71 } 
	tçm_dœ_’Œy
;

87 #ifdeà
DEBUG_STAT_CACHE


89 *
	m±r
;

91 
size_t
 
	mu£d
;

92 
size_t
 
	msize
;

93 } 
	tçke_keys
;

95 
çke_keys
 
	gù¾
;

98 
¡©_ÿche
 *
	$¡©_ÿche_š™
() {

99 
¡©_ÿche
 *
sc
 = 
NULL
;

101 
sc
 = 
	`ÿÎoc
(1, (*sc));

102 
	`fÜû_as£¹
(
NULL
 !ğ
sc
);

104 
sc
->
dœ_Çme
 = 
	`bufãr_š™
();

105 
sc
->
hash_key
 = 
	`bufãr_š™
();

107 #ifdeà
HAVE_FAM_H


108 
sc
->
çm_fcû_ndx
 = -1;

111 #ifdeà
DEBUG_STAT_CACHE


112 
ù¾
.
size
 = 0;

115  
sc
;

116 
	}
}

118 
¡©_ÿche_’Œy
 * 
	$¡©_ÿche_’Œy_š™
() {

119 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

121 
sû
 = 
	`ÿÎoc
(1, (*sce));

122 
	`fÜû_as£¹
(
NULL
 !ğ
sû
);

124 
sû
->
Çme
 = 
	`bufãr_š™
();

125 
sû
->
‘ag
 = 
	`bufãr_š™
();

126 
sû
->
cÚ‹Á_ty³
 = 
	`bufãr_š™
();

128  
sû
;

129 
	}
}

131 
	$¡©_ÿche_’Œy_ä“
(*
d©a
) {

132 
¡©_ÿche_’Œy
 *
sû
 = 
d©a
;

133 ià(!
sû
) ;

135 
	`bufãr_ä“
(
sû
->
‘ag
);

136 
	`bufãr_ä“
(
sû
->
Çme
);

137 
	`bufãr_ä“
(
sû
->
cÚ‹Á_ty³
);

139 
	`ä“
(
sû
);

140 
	}
}

142 #ifdeà
HAVE_FAM_H


143 
çm_dœ_’Œy
 * 
	$çm_dœ_’Œy_š™
() {

144 
çm_dœ_’Œy
 *
çm_dœ
 = 
NULL
;

146 
çm_dœ
 = 
	`ÿÎoc
(1, (*fam_dir));

147 
	`fÜû_as£¹
(
NULL
 !ğ
çm_dœ
);

149 
çm_dœ
->
Çme
 = 
	`bufãr_š™
();

151  
çm_dœ
;

152 
	}
}

154 
	$çm_dœ_’Œy_ä“
(
FAMCÚÃùiÚ
 *
fc
, *
d©a
) {

155 
çm_dœ_’Œy
 *
çm_dœ
 = 
d©a
;

157 ià(!
çm_dœ
) ;

159 
	`FAMCªûlMÚ™Ü
(
fc
, 
çm_dœ
->
»q
);

161 
	`bufãr_ä“
(
çm_dœ
->
Çme
);

162 
	`ä“
(
çm_dœ
->
»q
);

164 
	`ä“
(
çm_dœ
);

165 
	}
}

168 
	$¡©_ÿche_ä“
(
¡©_ÿche
 *
sc
) {

169 
sc
->
fes
) {

170 
osize
;

171 
¥Ïy_Œ“
 *
node
 = 
sc
->
fes
;

173 
osize
 = 
sc
->
fes
->
size
;

175 
	`¡©_ÿche_’Œy_ä“
(
node
->
d©a
);

176 
sc
->
fes
 = 
	`¥ÏyŒ“_d–‘e
(sc->fes, 
node
->
key
);

178 
	`fÜû_as£¹
(
osize
 - 1 =ğ
	`¥ÏyŒ“_size
(
sc
->
fes
));

181 
	`bufãr_ä“
(
sc
->
dœ_Çme
);

182 
	`bufãr_ä“
(
sc
->
hash_key
);

184 #ifdeà
HAVE_FAM_H


185 
sc
->
dœs
) {

186 
osize
;

187 
¥Ïy_Œ“
 *
node
 = 
sc
->
dœs
;

189 
osize
 = 
sc
->
dœs
->
size
;

191 
	`çm_dœ_’Œy_ä“
(&
sc
->
çm
, 
node
->
d©a
);

192 
sc
->
dœs
 = 
	`¥ÏyŒ“_d–‘e
(sc->dœs, 
node
->
key
);

194 ià(
osize
 == 1) {

195 
	`fÜû_as£¹
(
NULL
 =ğ
sc
->
dœs
);

197 
	`fÜû_as£¹
(
osize
 =ğ(
sc
->
dœs
->
size
 + 1));

201 ià(-1 !ğ
sc
->
çm_fcû_ndx
) {

203 
sc
->
çm_fcû_ndx
 = -1;

205 
	`FAMClo£
(&
sc
->
çm
);

208 
	`ä“
(
sc
);

209 
	}
}

211 #ià
defšed
(
HAVE_XATTR
)

212 
	$¡©_ÿche_©Œ_g‘
(
bufãr
 *
buf
, *
Çme
, *
x©ŒÇme
) {

213 
©ŒËn
;

214 
»t
;

216 
	`bufãr_¡ršg_´•¬e_cİy
(
buf
, 1023);

217 
©ŒËn
 = 
buf
->
size
 - 1;

218 if(0 =ğ(
»t
 = 
	`©Œ_g‘
(
Çme
, 
x©ŒÇme
, 
buf
->
±r
, &
©ŒËn
, 0))) {

219 
	`bufãr_comm™
(
buf
, 
©ŒËn
);

221  
»t
;

222 
	}
}

223 #–ià
defšed
(
HAVE_EXTATTR
)

224 
	$¡©_ÿche_©Œ_g‘
(
bufãr
 *
buf
, *
Çme
, *
x©ŒÇme
) {

225 
ssize_t
 
©ŒËn
;

227 
	`bufãr_¡ršg_´•¬e_cİy
(
buf
, 1023);

229 ià(-1 !ğ(
©ŒËn
 = 
	`ex‰r_g‘_fe
(
Çme
, 
EXTATTR_NAMESPACE_USER
, 
x©ŒÇme
, 
buf
->
±r
, buf->
size
 - 1))) {

230 
buf
->
u£d
 = 
©ŒËn
 + 1;

231 
buf
->
±r
[
©ŒËn
] = '\0';

235 
	}
}

239 
ušt32_t
 
	$hashme
(
bufãr
 *
¡r
) {

240 
ušt32_t
 
hash
 = 5381;

241 cÚ¡ *
s
;

242 
s
 = 
¡r
->
±r
; *s; s++) {

243 
hash
 = ((hash << 5è+ hashè+ *
s
;

246 
hash
 &ğ~(((
ušt32_t
)1) << 31);

248  
hash
;

249 
	}
}

251 #ifdeà
HAVE_FAM_H


252 
hªdËr_t
 
	$¡©_ÿche_hªdË_fdev’t
(
£rv”
 *
¤v
, *
_fû
, 
»v’t
) {

253 
size_t
 
i
;

254 
¡©_ÿche
 *
sc
 = 
¤v
->stat_cache;

255 
size_t
 
ev’ts
;

257 
	`UNUSED
(
_fû
);

260 ià(
»v’t
 & 
FDEVENT_IN
) {

261 
ev’ts
 = 
	`FAMP’dšg
(&
sc
->
çm
);

263 
i
 = 0; i < 
ev’ts
; i++) {

264 
FAMEv’t
 
ã
;

265 
çm_dœ_’Œy
 *
çm_dœ
;

266 
¥Ïy_Œ“
 *
node
;

267 
ndx
, 
j
;

269 
	`FAMNextEv’t
(&
sc
->
çm
, &
ã
);

273 
ã
.
code
) {

274 
FAMChªged
:

275 
FAMD–‘ed
:

276 
FAMMoved
:

279 
çm_dœ
 = 
ã
.
u£rd©a
;

280 
çm_dœ
->
v”siÚ
++;

283 ià(
ã
.
code
 =ğ
FAMChªged
) ;

287 
j
 = 0; j < 2; j++) {

288 
	`bufãr_cİy_¡ršg
(
sc
->
hash_key
, 
ã
.
f’ame
);

289 
	`bufãr_­³nd_št
(
sc
->
hash_key
, 
j
);

291 
ndx
 = 
	`hashme
(
sc
->
hash_key
);

293 
sc
->
dœs
 = 
	`¥ÏyŒ“_¥Ïy
(sc->dœs, 
ndx
);

294 
node
 = 
sc
->
dœs
;

296 ià(
node
 && (node->
key
 =ğ
ndx
)) {

297 
osize
 = 
	`¥ÏyŒ“_size
(
sc
->
dœs
);

299 
	`çm_dœ_’Œy_ä“
(&
sc
->
çm
, 
node
->
d©a
);

300 
sc
->
dœs
 = 
	`¥ÏyŒ“_d–‘e
(sc->dœs, 
ndx
);

302 
	`fÜû_as£¹
(
osize
 - 1 =ğ
	`¥ÏyŒ“_size
(
sc
->
dœs
));

312 ià(
»v’t
 & 
FDEVENT_HUP
) {

314 
	`fdev’t_ev’t_d–
(
¤v
->
ev
, &(
sc
->
çm_fcû_ndx
), 
	`FAMCONNECTION_GETFD
(&sc->
çm
));

315 
	`fdev’t_uÄegi¡”
(
¤v
->
ev
, 
	`FAMCONNECTION_GETFD
(&
sc
->
çm
));

317 
	`FAMClo£
(&
sc
->
çm
);

320  
HANDLER_GO_ON
;

321 
	}
}

323 
	$bufãr_cİy_dœÇme
(
bufãr
 *
d¡
, bufã¸*
fe
) {

324 
size_t
 
i
;

326 ià(
	`bufãr_¡ršg_is_em±y
(
fe
))  -1;

328 
i
 = 
	`bufãr_¡ršg_Ëngth
(
fe
); i > 0; i--) {

329 ià(
fe
->
±r
[
i
] == '/') {

330 
	`bufãr_cİy_¡ršg_Ën
(
d¡
, 
fe
->
±r
, 
i
);

336 
	}
}

339 #ifdeà
HAVE_LSTAT


340 
	$¡©_ÿche_l¡©
(
£rv”
 *
¤v
, 
bufãr
 *
dÇme
, 
¡©
 *
l¡
) {

341 ià(
	`l¡©
(
dÇme
->
±r
, 
l¡
) == 0) {

342  
	`S_ISLNK
(
l¡
->
¡_mode
) ? 0 : 1;

345 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

347 
dÇme
, 
	`¡»¼Ü
(
”ºo
));

350 
	}
}

362 
hªdËr_t
 
	$¡©_ÿche_g‘_’Œy
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
Çme
, 
¡©_ÿche_’Œy
 **
»t_sû
) {

363 #ifdeà
HAVE_FAM_H


364 
çm_dœ_’Œy
 *
çm_dœ
 = 
NULL
;

365 
dœ_ndx
 = -1;

367 
¡©_ÿche_’Œy
 *
sû
 = 
NULL
;

368 
¡©_ÿche
 *
sc
;

369 
¡©
 
¡
;

370 
size_t
 
k
;

371 
fd
;

372 
¡©
 
l¡
;

373 #ifdeà
DEBUG_STAT_CACHE


374 
size_t
 
i
;

377 
fe_ndx
;

379 *
»t_sû
 = 
NULL
;

385 
sc
 = 
¤v
->
¡©_ÿche
;

387 
	`bufãr_cİy_bufãr
(
sc
->
hash_key
, 
Çme
);

388 
	`bufãr_­³nd_št
(
sc
->
hash_key
, 
cÚ
->
cÚf
.
fŞlow_symlšk
);

390 
fe_ndx
 = 
	`hashme
(
sc
->
hash_key
);

391 
sc
->
fes
 = 
	`¥ÏyŒ“_¥Ïy
(sc->fes, 
fe_ndx
);

393 #ifdeà
DEBUG_STAT_CACHE


394 
i
 = 0; i < 
ù¾
.
u£d
; i++) {

395 ià(
ù¾
.
±r
[
i
] =ğ
fe_ndx
) ;

399 ià(
sc
->
fes
 && (sc->fes->
key
 =ğ
fe_ndx
)) {

400 #ifdeà
DEBUG_STAT_CACHE


402 
	`fÜû_as£¹
(
i
 < 
ù¾
.
u£d
);

408 
sû
 = 
sc
->
fes
->
d©a
;

412 ià(
	`bufãr_is_equ®
(
Çme
, 
sû
->name)) {

413 ià(
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 =ğ
STAT_CACHE_ENGINE_SIMPLE
) {

414 ià(
sû
->
¡©_ts
 =ğ
¤v
->
cur_ts
 && 
cÚ
->
cÚf
.
fŞlow_symlšk
) {

415 *
»t_sû
 = 
sû
;

416  
HANDLER_GO_ON
;

421 
sû
 = 
NULL
;

424 #ifdeà
DEBUG_STAT_CACHE


425 ià(
i
 !ğ
ù¾
.
u£d
) {

426 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "xSB",

427 
fe_ndx
, "wa ®»ady in£¹ed buˆnÙ found iÀÿche, ", 
Çme
);

429 
	`fÜû_as£¹
(
i
 =ğ
ù¾
.
u£d
);

433 #ifdeà
HAVE_FAM_H


435 ià(
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 =ğ
STAT_CACHE_ENGINE_FAM
) {

436 ià(0 !ğ
	`bufãr_cİy_dœÇme
(
sc
->
dœ_Çme
, 
Çme
)) {

437 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

438 "nØ'/' found iÀf’ame:", 
Çme
);

439  
HANDLER_ERROR
;

442 
	`bufãr_cİy_bufãr
(
sc
->
hash_key
, sc->
dœ_Çme
);

443 
	`bufãr_­³nd_št
(
sc
->
hash_key
, 
cÚ
->
cÚf
.
fŞlow_symlšk
);

445 
dœ_ndx
 = 
	`hashme
(
sc
->
hash_key
);

447 
sc
->
dœs
 = 
	`¥ÏyŒ“_¥Ïy
(sc->dœs, 
dœ_ndx
);

449 ià((
NULL
 !ğ
sc
->
dœs
è&& (sc->dœs->
key
 =ğ
dœ_ndx
)) {

450 
çm_dœ
 = 
sc
->
dœs
->
d©a
;

453 ià(
	`bufãr_is_equ®
(
sc
->
dœ_Çme
, 
çm_dœ
->
Çme
)) {

455 ià((
NULL
 !ğ
sû
è&& (
çm_dœ
->
v”siÚ
 =ğsû->
dœ_v”siÚ
)) {

458 *
»t_sû
 = 
sû
;

459  
HANDLER_GO_ON
;

463 
çm_dœ
 = 
NULL
;

475 ià(-1 =ğ
	`¡©
(
Çme
->
±r
, &
¡
)) {

476  
HANDLER_ERROR
;

480 ià(
	`S_ISREG
(
¡
.
¡_mode
)) {

482 ià(
Çme
->
±r
[
	`bufãr_¡ršg_Ëngth
(name) - 1] == '/') {

483 
”ºo
 = 
ENOTDIR
;

484  
HANDLER_ERROR
;

488 ià(-1 =ğ(
fd
 = 
	`İ’
(
Çme
->
±r
, 
O_RDONLY
))) {

489  
HANDLER_ERROR
;

491 
	`şo£
(
fd
);

494 ià(
NULL
 =ğ
sû
) {

496 
sû
 = 
	`¡©_ÿche_’Œy_š™
();

497 
	`bufãr_cİy_bufãr
(
sû
->
Çme
,‚ame);

500 ià((
NULL
 !ğ
sc
->
fes
è&& (sc->fes->
key
 =ğ
fe_ndx
)) {

502 
	`¡©_ÿche_’Œy_ä“
(
sc
->
fes
->
d©a
);

503 
sc
->
fes
->
d©a
 = 
sû
;

505 
osize
 = 
	`¥ÏyŒ“_size
(
sc
->
fes
);

507 
sc
->
fes
 = 
	`¥ÏyŒ“_š£¹
(sc->fes, 
fe_ndx
, 
sû
);

508 
	`fÜû_as£¹
(
osize
 + 1 =ğ
	`¥ÏyŒ“_size
(
sc
->
fes
));

510 #ifdeà
DEBUG_STAT_CACHE


511 ià(
ù¾
.
size
 == 0) {

512 
ù¾
.
size
 = 16;

513 
ù¾
.
u£d
 = 0;

514 
ù¾
.
±r
 = 
	`m®loc
(ù¾.
size
 * (*ctrl.ptr));

515 
	`fÜû_as£¹
(
NULL
 !ğ
ù¾
.
±r
);

516 } ià(
ù¾
.
size
 =ğù¾.
u£d
) {

517 
ù¾
.
size
 += 16;

518 
ù¾
.
±r
 = 
	`»®loc
(ù¾.±r, cŒl.
size
 * (*ctrl.ptr));

519 
	`fÜû_as£¹
(
NULL
 !ğ
ù¾
.
±r
);

522 
ù¾
.
±r
[ù¾.
u£d
++] = 
fe_ndx
;

525 
	`fÜû_as£¹
(
sc
->
fes
);

526 
	`fÜû_as£¹
(
sc
->
fes
->
d©a
 =ğ
sû
);

529 
sû
->
¡
 = st;

530 
sû
->
¡©_ts
 = 
¤v
->
cur_ts
;

544 #ifdeà
HAVE_LSTAT


545 
sû
->
is_symlšk
 = 0;

549 ià(!
cÚ
->
cÚf
.
fŞlow_symlšk
) {

550 ià(
	`¡©_ÿche_l¡©
(
¤v
, 
Çme
, &
l¡
) == 0) {

551 #ifdeà
DEBUG_STAT_CACHE


552 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

553 "found symlšk", 
Çme
);

555 
sû
->
is_symlšk
 = 1;

562 ià(
	`bufãr_¡ršg_Ëngth
(
Çme
) > 1) {

563 
bufãr
 *
dÇme
;

564 *
s_cur
;

566 
dÇme
 = 
	`bufãr_š™
();

567 
	`bufãr_cİy_bufãr
(
dÇme
, 
Çme
);

569 (
s_cur
 = 
	`¡¼chr
(
dÇme
->
±r
, '/'))) {

570 
	`bufãr_¡ršg_£t_Ëngth
(
dÇme
, 
s_cur
 - dÇme->
±r
);

571 ià(
dÇme
->
±r
 =ğ
s_cur
) {

572 #ifdeà
DEBUG_STAT_CACHE


573 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "s", "reached /");

577 #ifdeà
DEBUG_STAT_CACHE


578 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbs",

579 "checkšg if", 
dÇme
, "is‡ symlink");

581 ià(
	`¡©_ÿche_l¡©
(
¤v
, 
dÇme
, &
l¡
) == 0) {

582 
sû
->
is_symlšk
 = 1;

583 #ifdeà
DEBUG_STAT_CACHE


584 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sb",

585 "found symlšk", 
dÇme
);

590 
	`bufãr_ä“
(
dÇme
);

595 ià(
	`S_ISREG
(
¡
.
¡_mode
)) {

597 
	`bufãr_»£t
(
sû
->
cÚ‹Á_ty³
);

598 #ià
	`defšed
(
HAVE_XATTR
è|| defšed(
HAVE_EXTATTR
)

599 ià(
cÚ
->
cÚf
.
u£_x©Œ
) {

600 
	`¡©_ÿche_©Œ_g‘
(
sû
->
cÚ‹Á_ty³
, 
Çme
->
±r
, 
¤v
->
¤vcÚf
.
x©Œ_Çme
->ptr);

604 ià(
	`bufãr_¡ršg_is_em±y
(
sû
->
cÚ‹Á_ty³
)) {

605 
size_t
 
Çm–’
 = 
	`bufãr_¡ršg_Ëngth
(
Çme
);

607 
k
 = 0; k < 
cÚ
->
cÚf
.
mim‘y³s
->
u£d
; k++) {

608 
d©a_¡ršg
 *
ds
 = (d©a_¡ršg *)
cÚ
->
cÚf
.
mim‘y³s
->
d©a
[
k
];

609 
bufãr
 *
ty³
 = 
ds
->
key
;

610 
size_t
 
ty³Ën
 = 
	`bufãr_¡ršg_Ëngth
(
ty³
);

612 ià(
	`bufãr_is_em±y
(
ty³
)) ;

615 ià(
ty³Ën
 > 
Çm–’
) ;

617 ià(0 =ğ
	`¡ºÿ£cmp
(
Çme
->
±r
 + 
Çm–’
 - 
ty³Ën
, 
ty³
->ptr,ypelen)) {

618 
	`bufãr_cİy_bufãr
(
sû
->
cÚ‹Á_ty³
, 
ds
->
v®ue
);

623 
	`‘ag_ü—‹
(
sû
->
‘ag
, &(sû->
¡
), 
cÚ
->
‘ag_æags
);

624 } ià(
	`S_ISDIR
(
¡
.
¡_mode
)) {

625 
	`‘ag_ü—‹
(
sû
->
‘ag
, &(sû->
¡
), 
cÚ
->
‘ag_æags
);

628 #ifdeà
HAVE_FAM_H


629 ià(
¤v
->
¤vcÚf
.
¡©_ÿche_’gše
 =ğ
STAT_CACHE_ENGINE_FAM
) {

631 ià(
NULL
 =ğ
çm_dœ
) {

632 
çm_dœ
 = 
	`çm_dœ_’Œy_š™
();

634 
	`bufãr_cİy_bufãr
(
çm_dœ
->
Çme
, 
sc
->
dœ_Çme
);

636 
çm_dœ
->
v”siÚ
 = 1;

638 
çm_dœ
->
»q
 = 
	`ÿÎoc
(1, (
FAMReque¡
));

639 
	`fÜû_as£¹
(
NULL
 !ğ
çm_dœ
);

641 ià(0 !ğ
	`FAMMÚ™ÜDœeùÜy
(&
sc
->
çm
, 
çm_dœ
->
Çme
->
±r
,

642 
çm_dœ
->
»q
, fam_dir)) {

644 
	`log_”rÜ_wr™e
(
¤v
, 
__FILE__
, 
__LINE__
, "sbsbs",

646 
çm_dœ
->
Çme
,

647 "fe:", 
Çme
,

648 
FamE¼li¡
[
FAME¼no
]);

650 
	`çm_dœ_’Œy_ä“
(&
sc
->
çm
, 
çm_dœ
);

651 
çm_dœ
 = 
NULL
;

653 
osize
 = 
	`¥ÏyŒ“_size
(
sc
->
dœs
);

656 ià((
NULL
 !ğ
sc
->
dœs
è&& (sc->dœs->
key
 =ğ
dœ_ndx
)) {

658 
	`çm_dœ_’Œy_ä“
(&
sc
->
çm
, sc->
dœs
->
d©a
);

659 
sc
->
dœs
->
d©a
 = 
çm_dœ
;

661 
sc
->
dœs
 = 
	`¥ÏyŒ“_š£¹
(sc->dœs, 
dœ_ndx
, 
çm_dœ
);

662 
	`fÜû_as£¹
(
osize
 =ğ(
	`¥ÏyŒ“_size
(
sc
->
dœs
) - 1));

665 
	`fÜû_as£¹
(
sc
->
dœs
);

666 
	`fÜû_as£¹
(
sc
->
dœs
->
d©a
 =ğ
çm_dœ
);

672 ià(
çm_dœ
) {

673 
sû
->
dœ_v”siÚ
 = 
çm_dœ
->
v”siÚ
;

678 *
»t_sû
 = 
sû
;

680  
HANDLER_GO_ON
;

681 
	}
}

683 
	$¡©_ÿche_İ’_rdÚly_f¡©
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
Çme
, 
¡©
 *
¡
) {

686 #iâdeà
O_BINARY


687 
	#O_BINARY
 0

	)

689 #iâdeà
O_LARGEFILE


690 
	#O_LARGEFILE
 0

	)

692 #iâdeà
O_NOCTTY


693 
	#O_NOCTTY
 0

	)

695 #iâdeà
O_NONBLOCK


696 
	#O_NONBLOCK
 0

	)

698 #iâdeà
O_NOFOLLOW


699 
	#O_NOFOLLOW
 0

	)

701 cÚ¡ 
oæags
 = 
O_BINARY
 | 
O_LARGEFILE
 | 
O_NOCTTY
 | 
O_NONBLOCK


702 | (
cÚ
->
cÚf
.
fŞlow_symlšk
 ? 0 : 
O_NOFOLLOW
);

703 cÚ¡ 
fd
 = 
	`İ’
(
Çme
->
±r
, 
O_RDONLY
 | 
oæags
);

704 ià(
fd
 >= 0) {

705 ià(0 =ğ
	`f¡©
(
fd
, 
¡
)) {

706  
fd
;

708 
	`şo£
(
fd
);

711 
	`UNUSED
(
¤v
);

713 
	}
}

724 
	$¡©_ÿche_g_Şd_’Œ›s
(
£rv”
 *
¤v
, 
¥Ïy_Œ“
 *
t
, *
keys
, 
size_t
 *
ndx
) {

725 
¡©_ÿche_’Œy
 *
sû
;

727 ià(!
t
)  0;

729 
	`¡©_ÿche_g_Şd_’Œ›s
(
¤v
, 
t
->
Ëá
, 
keys
, 
ndx
);

730 
	`¡©_ÿche_g_Şd_’Œ›s
(
¤v
, 
t
->
right
, 
keys
, 
ndx
);

732 
sû
 = 
t
->
d©a
;

734 ià(
¤v
->
cur_ts
 - 
sû
->
¡©_ts
 > 2) {

735 
keys
[(*
ndx
)++] = 
t
->
key
;

739 
	}
}

741 
	$¡©_ÿche_Œigg”_ş—nup
(
£rv”
 *
¤v
) {

742 
¡©_ÿche
 *
sc
;

743 
size_t
 
max_ndx
 = 0, 
i
;

744 *
keys
;

746 
sc
 = 
¤v
->
¡©_ÿche
;

748 ià(!
sc
->
fes
)  0;

750 
keys
 = 
	`ÿÎoc
(1, (è* 
sc
->
fes
->
size
);

751 
	`fÜû_as£¹
(
NULL
 !ğ
keys
);

753 
	`¡©_ÿche_g_Şd_’Œ›s
(
¤v
, 
sc
->
fes
, 
keys
, &
max_ndx
);

755 
i
 = 0; i < 
max_ndx
; i++) {

756 
ndx
 = 
keys
[
i
];

757 
¥Ïy_Œ“
 *
node
;

759 
sc
->
fes
 = 
	`¥ÏyŒ“_¥Ïy
(sc->fes, 
ndx
);

761 
node
 = 
sc
->
fes
;

763 ià(
node
 && (node->
key
 =ğ
ndx
)) {

764 #ifdeà
DEBUG_STAT_CACHE


765 
size_t
 
j
;

766 
osize
 = 
	`¥ÏyŒ“_size
(
sc
->
fes
);

767 
¡©_ÿche_’Œy
 *
sû
 = 
node
->
d©a
;

769 
	`¡©_ÿche_’Œy_ä“
(
node
->
d©a
);

770 
sc
->
fes
 = 
	`¥ÏyŒ“_d–‘e
(sc->fes, 
ndx
);

772 #ifdeà
DEBUG_STAT_CACHE


773 
j
 = 0; j < 
ù¾
.
u£d
; j++) {

774 ià(
ù¾
.
±r
[
j
] =ğ
ndx
) {

775 
ù¾
.
±r
[
j
] = cŒl.±r[--ù¾.
u£d
];

780 
	`fÜû_as£¹
(
osize
 - 1 =ğ
	`¥ÏyŒ“_size
(
sc
->
fes
));

785 
	`ä“
(
keys
);

788 
	}
}

	@stat_cache.h

1 #iâdeà
_FILE_CACHE_H_


2 
	#_FILE_CACHE_H_


	)

3 
	~"fœ¡.h
"

5 
	~"ba£.h
"

7 
¡©_ÿche
 *
¡©_ÿche_š™
();

8 
¡©_ÿche_ä“
(
¡©_ÿche
 *
fc
);

10 
hªdËr_t
 
¡©_ÿche_g‘_’Œy
(
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
Çme
, 
¡©_ÿche_’Œy
 **
fû
);

11 
hªdËr_t
 
¡©_ÿche_hªdË_fdev’t
(
£rv”
 *
¤v
, *
_fû
, 
»v’t
);

12 
¡©_ÿche_İ’_rdÚly_f¡©
 (
£rv”
 *
¤v
, 
cÚÃùiÚ
 *
cÚ
, 
bufãr
 *
Çme
, 
¡©
 *
¡
);

14 
¡©_ÿche_Œigg”_ş—nup
(
£rv”
 *
¤v
);

	@status_counter.c

1 
	~"fœ¡.h
"

3 
	~"¡©us_couÁ”.h
"

5 
	~<¡dlib.h
>

21 
d©a_š‹g”
 *
	$¡©us_couÁ”_g‘_couÁ”
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
) {

22 
d©a_š‹g”
 *
di
;

24 ià(
NULL
 =ğ(
di
 = (
d©a_š‹g”
 *)
	`¬¿y_g‘_–em’t
(
¤v
->
¡©us
, 
s
))) {

27 ià(
NULL
 =ğ(
di
 = (
d©a_š‹g”
 *)
	`¬¿y_g‘_unu£d_–em’t
(
¤v
->
¡©us
, 
TYPE_INTEGER
))) {

28 
di
 = 
	`d©a_š‹g”_š™
();

30 
	`bufãr_cİy_¡ršg_Ën
(
di
->
key
, 
s
, 
Ën
);

31 
di
->
v®ue
 = 0;

33 
	`¬¿y_š£¹_unique
(
¤v
->
¡©us
, (
d©a_un£t
 *)
di
);

35  
di
;

36 
	}
}

40 
	$¡©us_couÁ”_šc
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
) {

41 
d©a_š‹g”
 *
di
 = 
	`¡©us_couÁ”_g‘_couÁ”
(
¤v
, 
s
, 
Ën
);

43 
di
->
v®ue
++;

46 
	}
}

48 
	$¡©us_couÁ”_dec
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
) {

49 
d©a_š‹g”
 *
di
 = 
	`¡©us_couÁ”_g‘_couÁ”
(
¤v
, 
s
, 
Ën
);

51 ià(
di
->
v®ue
 > 0) di->value--;

54 
	}
}

56 
	$¡©us_couÁ”_£t
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
, 
v®
) {

57 
d©a_š‹g”
 *
di
 = 
	`¡©us_couÁ”_g‘_couÁ”
(
¤v
, 
s
, 
Ën
);

59 
di
->
v®ue
 = 
v®
;

62 
	}
}

	@status_counter.h

1 #iâdeà
_STATUS_COUNTER_H_


2 
	#_STATUS_COUNTER_H_


	)

3 
	~"fœ¡.h
"

5 
	~"¬¿y.h
"

6 
	~"ba£.h
"

8 
	~<sys/ty³s.h
>

10 
d©a_š‹g”
 *
¡©us_couÁ”_g‘_couÁ”
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
);

11 
¡©us_couÁ”_šc
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
);

12 
¡©us_couÁ”_dec
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
);

13 
¡©us_couÁ”_£t
(
£rv”
 *
¤v
, cÚ¡ *
s
, 
size_t
 
Ën
, 
v®
);

	@stream.c

1 
	~"fœ¡.h
"

3 
	~"¡»am.h
"

5 
	~<sys/ty³s.h
>

6 
	~<sys/¡©.h
>

8 
	~<uni¡d.h
>

9 
	~<fú.h
>

11 
	~"sys-mm­.h
"

13 #iâdeà
O_BINARY


14 
	#O_BINARY
 0

	)

18 #ià
defšed
(
O_NONBLOCK
)

19 
	#FIFO_NONBLOCK
 
O_NONBLOCK


	)

21 
	#FIFO_NONBLOCK
 0

	)

24 
	$¡»am_İ’
(
¡»am
 *
f
, cÚ¡ 
bufãr
 *
â
) {

26 #ià!
	`defšed
(
__WIN32
)

28 
¡©
 
¡
;

29 
fd
;

31 
f
->
¡¬t
 = 
NULL
;

32 
f
->
size
 = 0;

33 
f
->
m­³d
 = 0;

35 ià(-1 =ğ(
fd
 = 
	`İ’
(
â
->
±r
, 
O_RDONLY
 | 
O_BINARY
 | 
FIFO_NONBLOCK
))) {

39 ià(-1 =ğ
	`f¡©
(
fd
, &
¡
)) {

40 
	`şo£
(
fd
);

44 ià(0 =ğ
¡
.
¡_size
) {

46 
	`şo£
(
fd
);

50 
f
->
¡¬t
 = 
	`mm­
(
NULL
, 
¡
.
¡_size
, 
PROT_READ
, 
MAP_SHARED
, 
fd
, 0);

52 ià(
MAP_FAILED
 =ğ
f
->
¡¬t
) {

53 
f
->
¡¬t
 = 
	`m®loc
((
size_t
)
¡
.
¡_size
);

54 ià(
NULL
 =ğ
f
->
¡¬t


55 || 
¡
.
¡_size
 !ğ
	`»ad
(
fd
, 
f
->
¡¬t
, (
size_t
)st.st_size)) {

56 
	`ä“
(
f
->
¡¬t
);

57 
f
->
¡¬t
 = 
NULL
;

58 
	`şo£
(
fd
);

62 
f
->
m­³d
 = 1;

65 
	`şo£
(
fd
);

67 
f
->
size
 = 
¡
.
¡_size
;

70 #–ià
defšed
 
__WIN32


72 
HANDLE
 *
fh
, *
mh
;

73 *
p
;

74 
LARGE_INTEGER
 
fsize
;

76 
f
->
¡¬t
 = 
NULL
;

77 
f
->
size
 = 0;

79 
fh
 = 
	`C»©eFe
(
â
->
±r
,

80 
GENERIC_READ
,

81 
FILE_SHARE_READ
,

82 
NULL
,

83 
OPEN_EXISTING
,

84 
FILE_ATTRIBUTE_READONLY
,

85 
NULL
);

87 ià(!
fh
)  -1;

89 ià(0 !ğ
	`G‘FeSizeEx
(
fh
, &
fsize
)) {

90 
	`Clo£HªdË
(
fh
);

94 ià(0 =ğ
fsize
) {

95 
	`Clo£HªdË
(
fh
);

99 
mh
 = 
	`C»©eFeM­pšg
Ğ
fh
,

100 
NULL
,

101 
PAGE_READONLY
,

102 ((
off_t
è> 4è? 
fsize
 >> 32 : 0,

103 
fsize
 & 0xffffffff,

104 
NULL
);

106 ià(!
mh
) {

118 
	`Clo£HªdË
(
fh
);

122 
p
 = 
	`M­V›wOfFe
(
mh
,

123 
FILE_MAP_READ
,

127 
	`Clo£HªdË
(
mh
);

128 
	`Clo£HªdË
(
fh
);

130 
f
->
¡¬t
 = 
p
;

131 
f
->
size
 = (
off_t
)
fsize
;

136 
	}
}

138 
	$¡»am_şo£
(
¡»am
 *
f
) {

139 #ifdeà
HAVE_MMAP


140 ià(
f
->
¡¬t
) {

141 ià(
f
->
m­³d
) {

142 
f
->
m­³d
 = 0;

143 
	`munm­
(
f
->
¡¬t
, f->
size
);

145 
	`ä“
(
f
->
¡¬t
);

148 #–ià
	`defšed
(
__WIN32
)

149 ià(
f
->
¡¬t
è
	`Unm­V›wOfFe
(f->start);

152 
f
->
¡¬t
 = 
NULL
;

153 
f
->
size
 = 0;

156 
	}
}

	@stream.h

1 #iâdeà
_STREAM_H_


2 
	#_STREAM_H_


	)

3 
	~"fœ¡.h
"

5 
	~"bufãr.h
"

8 *
	m¡¬t
;

9 
off_t
 
	msize
;

10 
	mm­³d
;

11 } 
	t¡»am
;

13 
¡»am_İ’
(
¡»am
 *
f
, cÚ¡ 
bufãr
 *
â
);

14 
¡»am_şo£
(
¡»am
 *
f
);

	@sys-endian.h

1 #iâdeà
LI_SYS_ENDIAN_H


2 
	#LI_SYS_ENDIAN_H


	)

3 
	~"fœ¡.h
"

6 #ià!
defšed
(
__LITTLE_ENDIAN__
è&& !defšed(
__BIG_ENDIAN__
)

12 #ià
defšed
(
__BYTE_ORDER__
) \

13 && ( 
defšed
(
__ORDER_LITTLE_ENDIAN__
) \

14 || 
defšed
(
__ORDER_BIG_ENDIAN__
) \

15 || 
	$defšed
(
__ORDER_PDP_ENDIAN__
) )

16 #ià
__BYTE_ORDER__
 =ğ
__ORDER_LITTLE_ENDIAN__


17 
	#__LITTLE_ENDIAN__
 1

	)

18 #–ià
__BYTE_ORDER__
 =ğ
__ORDER_BIG_ENDIAN__


19 
	#__BIG_ENDIAN__
 1

	)

21 #–ià
	`defšed
(
_LITTLE_ENDIAN
è&& !defšed(
_BIG_ENDIAN
)

22 
	#__LITTLE_ENDIAN__
 1

	)

23 #–ià!
	`defšed
(
_LITTLE_ENDIAN
è&& defšed(
_BIG_ENDIAN
)

24 
	#__BIG_ENDIAN__
 1

	)

25 #–ià
	`defšed
(
_WIN32
)

26 
	#__LITTLE_ENDIAN__
 1

	)

27 #–ià
	`defšed
(
__GLIBC__
è|| defšed(
__lšux__
)

28 
	~<’dŸn.h
>

29 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


30 
	#__LITTLE_ENDIAN__
 1

	)

31 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


32 
	#__BIG_ENDIAN__
 1

	)

34 #–ià
	`defšed
(
__sun__
è&& defšed(
__SVR4
)

35 
	~<sys/i§_defs.h
>

36 #ià
	`defšed
(
_LITTLE_ENDIAN
)

37 
	#__LITTLE_ENDIAN__
 1

	)

38 #–ià
	`defšed
(
_BIG_ENDIAN
)

39 
	#__BIG_ENDIAN__
 1

	)

41 #–ià
	`defšed
(
_AIX
)

42 
	~<sys/machše.h
>

43 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


44 
	#__LITTLE_ENDIAN__
 1

	)

45 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


46 
	#__BIG_ENDIAN__
 1

	)

48 #–ià
	`defšed
(
__APPLE__
è&& defšed(
__MACH__
)

49 
	~<machše/’dŸn.h
>

50 #ià
BYTE_ORDER
 =ğ
LITTLE_ENDIAN


51 
	#__LITTLE_ENDIAN__
 1

	)

52 #–ià
BYTE_ORDER
 =ğ
BIG_ENDIAN


53 
	#__BIG_ENDIAN__
 1

	)

55 #–ià
	`defšed
(
__F»eBSD__
è|| defšed(
__N‘BSD__
) \

56 || 
	`defšed
(
__O³nBSD__
è|| 
	$defšed
(
__D¿gÚFly__
)

57 
	~<machše/’dŸn.h
>

58 #ià
_BYTE_ORDER
 =ğ
_LITTLE_ENDIAN


59 
	#__LITTLE_ENDIAN__
 1

	)

60 #–ià
_BYTE_ORDER
 =ğ
_BIG_ENDIAN


61 
	#__BIG_ENDIAN__
 1

	)

64 
	#__LITTLE_ENDIAN__
 1

	)

	@sys-mmap.h

1 #iâdeà
LI_SYS_MMAP_H


2 
	#LI_SYS_MMAP_H


	)

3 
	~"fœ¡.h
"

5 #ià
defšed
(
HAVE_SYS_MMAN_H
)

6 
	~<sys/mmª.h
>

9 
	#PROT_SHARED
 0

	)

10 
	#MAP_SHARED
 0

	)

11 
	#PROT_READ
 0

	)

13 
	#mm­
(
a
, 
b
, 
c
, 
d
, 
e
, 
f
è(-1)

	)

14 
	#munm­
(
a
, 
b
è(-1)

	)

19 #ià!
defšed
(
MAP_FAILED
)

20 
	#MAP_FAILED
 ((*)-1)

	)

	@sys-socket.h

1 #iâdeà
WIN32_SOCKET_H


2 
	#WIN32_SOCKET_H


	)

3 
	~"fœ¡.h
"

5 #ifdeà
__WIN32


7 
	~<wšsock2.h
>

9 
	#ECONNRESET
 
WSAECONNRESET


	)

10 
	#EINPROGRESS
 
WSAEINPROGRESS


	)

11 
	#EALREADY
 
WSAEALREADY


	)

12 
	#ECONNABORTED
 
WSAECONNABORTED


	)

13 
	#ioùl
 
ioùlsock‘


	)

15 
	~<sys/sock‘.h
>

16 
	~<sys/ioùl.h
>

17 
	~<Ãtš‘/š.h
>

18 
	~<Ãtš‘/tı.h
>

19 
	~<sys/un.h
>

20 
	~<¬·/š‘.h
>

22 
	~<Ãtdb.h
>

24 #ifdeà
HAVE_SYS_FILIO_H


25 
	~<sys/fio.h
>

	@test_base64.c

1 
	~"fœ¡.h
"

3 
	~"ba£64.h
"

5 
	$check_®l_Ën_0
() {

6 
bufãr
 *
check
 = 
	`bufãr_š™
();

7 cÚ¡ 
em±y
[] = "";

10 * 
check_»s
;

12 
	`fÜû_as£¹
(0 =ğ
	`li_to_ba£64_no_·ddšg
(
NULL
, 0, NULL, 0, 
BASE64_STANDARD
));

14 
	`bufãr_»£t
(
check
);

15 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
NULL
, 0, 
BASE64_STANDARD
);

16 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

17 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, 
em±y
, 0));

21 * 
check_»s
;

23 
	`fÜû_as£¹
(0 =ğ
	`li_to_ba£64_no_·ddšg
(
NULL
, 0, NULL, 0, 
BASE64_URL
));

25 
	`bufãr_»£t
(
check
);

26 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
NULL
, 0, 
BASE64_URL
);

27 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

28 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, 
em±y
, 0));

31 
	`bufãr_ä“
(
check
);

32 
	}
}

34 
	$check_®l_Ën_1
() {

35 
c1
;

36 
bufãr
 *
check
 = 
	`bufãr_š™
();

38 
c1
 = 0; c1 < 256; ++c1) {

40 
š
[] = { 
c1
 };

41 
out
[2] = { 0, 0 };

42 * 
check_»s
;

44 
	`fÜû_as£¹
((
out
è=ğ
	`li_to_ba£64_no_·ddšg
(out, (out), 
š
, (š), 
BASE64_STANDARD
));

46 
	`bufãr_»£t
(
check
);

47 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
out
, (out), 
BASE64_STANDARD
);

48 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

49 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, (cÚ¡ *è
š
, (in)));

53 
š
[] = { 
c1
 };

54 
out
[2] = { 0, 0 };

55 * 
check_»s
;

57 
	`fÜû_as£¹
((
out
è=ğ
	`li_to_ba£64_no_·ddšg
(out, (out), 
š
, (š), 
BASE64_URL
));

59 
	`bufãr_»£t
(
check
);

60 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
out
, (out), 
BASE64_URL
);

61 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

62 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, (cÚ¡ *è
š
, (in)));

66 
	`bufãr_ä“
(
check
);

67 
	}
}

69 
	$check_®l_Ën_2
() {

70 
c1
, 
c2
;

71 
bufãr
 *
check
 = 
	`bufãr_š™
();

73 
c1
 = 0; c1 < 256; ++c1è
c2
 = 0; c2 < 256; ++c2) {

75 
š
[] = { 
c1
, 
c2
 };

76 
out
[3] = { 0, 0, 0 };

77 * 
check_»s
;

79 
	`fÜû_as£¹
((
out
è=ğ
	`li_to_ba£64_no_·ddšg
(out, (out), 
š
, (š), 
BASE64_STANDARD
));

81 
	`bufãr_»£t
(
check
);

82 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
out
, (out), 
BASE64_STANDARD
);

83 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

84 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, (cÚ¡ *è
š
, (in)));

88 
š
[] = { 
c1
, 
c2
 };

89 
out
[3] = { 0, 0, 0 };

90 * 
check_»s
;

92 
	`fÜû_as£¹
((
out
è=ğ
	`li_to_ba£64_no_·ddšg
(out, (out), 
š
, (š), 
BASE64_URL
));

94 
	`bufãr_»£t
(
check
);

95 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
out
, (out), 
BASE64_URL
);

96 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

97 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, (cÚ¡ *è
š
, (in)));

101 
	`bufãr_ä“
(
check
);

102 
	}
}

104 
	$check_®l_Ën_3
() {

105 
c1
, 
c2
, 
c3
;

106 
bufãr
 *
check
 = 
	`bufãr_š™
();

108 
c1
 = 0; c1 < 256; ++c1è
c2
 = 0; c2 < 256; ++c2è
c3
 = 0; c3 < 256; ++c3) {

110 
š
[] = { 
c1
, 
c2
, 
c3
 };

111 
out
[4] = { 0, 0, 0, 0 };

112 * 
check_»s
;

114 
	`fÜû_as£¹
((
out
è=ğ
	`li_to_ba£64_no_·ddšg
(out, (out), 
š
, (š), 
BASE64_STANDARD
));

116 
	`bufãr_»£t
(
check
);

117 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
out
, (out), 
BASE64_STANDARD
);

118 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

119 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, (cÚ¡ *è
š
, (in)));

123 
š
[] = { 
c1
, 
c2
, 
c3
 };

124 
out
[4] = { 0, 0, 0, 0 };

125 * 
check_»s
;

127 
	`fÜû_as£¹
((
out
è=ğ
	`li_to_ba£64_no_·ddšg
(out, (out), 
š
, (š), 
BASE64_URL
));

129 
	`bufãr_»£t
(
check
);

130 
check_»s
 = 
	`bufãr_­³nd_ba£64_decode
(
check
, 
out
, (out), 
BASE64_URL
);

131 
	`fÜû_as£¹
((
check_»s
 !ğ
NULL
è&& (check_» =ğ(*è
check
->
±r
));

132 
	`fÜû_as£¹
(
	`bufãr_is_equ®_¡ršg
(
check
, (cÚ¡ *è
š
, (in)));

136 
	`bufãr_ä“
(
check
);

137 
	}
}

139 
	$maš
() {

140 
	`check_®l_Ën_0
();

141 
	`check_®l_Ën_1
();

142 
	`check_®l_Ën_2
();

143 
	`check_®l_Ën_3
();

146 
	}
}

	@test_buffer.c

1 
	~"fœ¡.h
"

3 
	~"bufãr.h
"

5 
	$run_bufãr_·th_sim¶ify
(
bufãr
 *
p¤c
, bufã¸*
pde¡
, cÚ¡ *
š
, 
size_t
 
š_Ën
, cÚ¡ *
out
, size_ˆ
out_Ën
) {

6 
	`bufãr_cİy_¡ršg_Ën
(
p¤c
, 
š
, 
š_Ën
);

8 
	`bufãr_·th_sim¶ify
(
pde¡
, 
p¤c
);

10 ià(!
	`bufãr_is_equ®_¡ršg
(
pde¡
, 
out
, 
out_Ën
)) {

11 
	`årštf
(
¡d”r
,

13 
__FILE__
,

14 
__LINE__
,

15 
š
,

16 
out
,

17 
pde¡
->
±r
 ?…dest->ptr : "");

18 
	`fæush
(
¡d”r
);

19 
	`abÜt
();

21 
	`årštf
(
¡dout
,

23 
__FILE__
,

24 
__LINE__
,

25 
š
,

26 
out
);

28 ià(
p¤c
 !ğ
pde¡
è
	`bufãr_cİy_bufãr
(psrc,…dest);

29 
	`bufãr_·th_sim¶ify
(
pde¡
, 
p¤c
);

31 ià(!
	`bufãr_is_equ®_¡ršg
(
pde¡
, 
out
, 
out_Ën
)) {

32 
	`årštf
(
¡d”r
,

34 
__FILE__
,

35 
__LINE__
,

36 
out
,

37 
out
,

38 
pde¡
->
±r
 ?…dest->ptr : "");

39 
	`fæush
(
¡d”r
);

40 
	`abÜt
();

43 
	}
}

45 
	$‹¡_bufãr_·th_sim¶ify_w™h
(
bufãr
 *
p¤c
, bufã¸*
pde¡
) {

46 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
(""), CONST_STR_LEN(""));

47 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
(" "), CONST_STR_LEN("/"));

48 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/"), CONST_STR_LEN("/"));

49 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("//"), CONST_STR_LEN("/"));

50 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc"), CONST_STR_LEN("/abc"));

51 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc//"), CONST_STR_LEN("/abc/"));

52 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc/./xyz"), CONST_STR_LEN("/abc/xyz"));

53 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc/.//xyz"), CONST_STR_LEN("/abc/xyz"));

54 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc/../xyz"), CONST_STR_LEN("/xyz"));

55 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/abc/./xyz"), CONST_STR_LEN("/abc/xyz"));

56 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/abc//./xyz"), CONST_STR_LEN("/abc/xyz"));

57 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/abc/../xyz"), CONST_STR_LEN("/xyz"));

58 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc/../xyz/."), CONST_STR_LEN("/xyz/"));

59 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/abc/../xyz/."), CONST_STR_LEN("/xyz/"));

60 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("abc/./xyz/.."), CONST_STR_LEN("/abc/"));

61 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/abc/./xyz/.."), CONST_STR_LEN("/abc/"));

62 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("./xyz/.."), CONST_STR_LEN("/"));

63 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
(".//xyz/.."), CONST_STR_LEN("/"));

64 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/./xyz/.."), CONST_STR_LEN("/"));

65 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
(".././xyz/.."), CONST_STR_LEN("/"));

66 
	`run_bufãr_·th_sim¶ify
(
p¤c
, 
pde¡
, 
	`CONST_STR_LEN
("/.././xyz/.."), CONST_STR_LEN("/"));

67 
	}
}

69 
	$‹¡_bufãr_·th_sim¶ify
() {

70 
bufãr
 *
p¤c
 = 
	`bufãr_š™
();

71 
bufãr
 *
pde¡
 = 
	`bufãr_š™
();

74 
	`‹¡_bufãr_·th_sim¶ify_w™h
(
p¤c
,…src);

75 
	`‹¡_bufãr_·th_sim¶ify_w™h
(
pde¡
, 
p¤c
);

77 
	`bufãr_ä“
(
p¤c
);

78 
	`bufãr_ä“
(
pde¡
);

79 
	}
}

81 
	$maš
() {

82 
	`‹¡_bufãr_·th_sim¶ify
();

85 
	}
}

	@test_configfile.c

1 
	~"cÚfigfe-glue.c
"

3 
	~<as£¹.h
>

4 
	~<¡dlib.h
>

5 
	~<¡dio.h
>

8 cÚ¡ *
	m¡ršg
;

9 cÚ¡ *
	mrmt¡r
;

10 
	mrmtçmy
;

11 
	mex³ù
;

12 } 
	grmtmask
[] = {

13 { "1.0.0.1/1", "1.0.0.1", 
AF_INET
, 1 }

14 ,{ "254.254.254.254/1", "254.0.0.1", 
AF_INET
, 1 }

15 ,{ "254.254.254.252/31", "254.254.254.253", 
AF_INET
, 1 }

16 ,{ "254.254.254.253/31", "254.254.254.254", 
AF_INET
, 0 }

17 ,{ "254.254.254.253/32", "254.254.254.254", 
AF_INET
, 0 }

18 ,{ "254.254.254.254/32", "254.254.254.254", 
AF_INET
, 1 }

19 #ifdeà
HAVE_IPV6


20 ,{ "2001::/3", "2001::1", 
AF_INET6
, 1 }

21 ,{ "2f01::/5", "2701::1", 
AF_INET6
, 0 }

22 ,{ "2f01::/32", "2f01::1", 
AF_INET6
, 1 }

23 ,{ "2f01::/32", "2f02::1", 
AF_INET6
, 0 }

24 ,{ "2001::1/127", "2001::1", 
AF_INET6
, 1 }

25 ,{ "2001::1/127", "2001::2", 
AF_INET6
, 0 }

26 ,{ "2001::2/128", "2001::2", 
AF_INET6
, 1 }

27 ,{ "2001::2/128", "2001::3", 
AF_INET6
, 0 }

28 ,{ "1.0.0.1/1", "::ffff:1.0.0.1", 
AF_INET6
, 1 }

29 ,{ "254.254.254.254/1", "::ffff:254.0.0.1", 
AF_INET6
, 1 }

30 ,{ "254.254.254.252/31", "::ffff:254.254.254.253", 
AF_INET6
, 1 }

31 ,{ "254.254.254.253/31", "::ffff:254.254.254.254", 
AF_INET6
, 0 }

32 ,{ "254.254.254.253/32", "::ffff:254.254.254.254", 
AF_INET6
, 0 }

33 ,{ "254.254.254.254/32", "::ffff:254.254.254.254", 
AF_INET6
, 1 }

34 ,{ "::ffff:1.0.0.1/97", "1.0.0.1", 
AF_INET
, 1 }

35 ,{ "::ffff:254.254.254.254/97", "254.0.0.1", 
AF_INET
, 1 }

36 ,{ "::ffff:254.254.254.252/127", "254.254.254.253", 
AF_INET
, 1 }

37 ,{ "::ffff:254.254.254.253/127", "254.254.254.254", 
AF_INET
, 0 }

38 ,{ "::ffff:254.254.254.253/128", "254.254.254.254", 
AF_INET
, 0 }

39 ,{ "::ffff:254.254.254.254/128", "254.254.254.254", 
AF_INET
, 1 }

43 
	$‹¡_cÚfigfe_addrbuf_eq_»mÙe__mask
 () {

44 
i
, 
m
;

45 
bufãr
 * cÚ¡ 
s
 = 
	`bufãr_š™
();

46 *
¦ash
;

47 
sock_addr
 
rmt
;

49 
i
 = 0; i < ()((
rmtmask
)/(rmtmask[0])); ++i) {

50 #iâdeà
HAVE_INET_PTON


51 
rmt
.
v4
.
sš_çmy
 = 
AF_INET
;

52 
rmt
.
v4
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
rmtmask
[
i
].
rmt¡r
);

54 ià(
rmtmask
[
i
].
rmtçmy
 =ğ
AF_INET
) {

55 
rmt
.
v4
.
sš_çmy
 = 
AF_INET
;

56 
	`š‘_±Ú
(
AF_INET
, 
rmtmask
[
i
].
rmt¡r
, &
rmt
.
v4
.
sš_addr
);

57 #ifdeà
HAVE_IPV6


58 } ià(
rmtmask
[
i
].
rmtçmy
 =ğ
AF_INET6
) {

59 
rmt
.
v6
.
sš6_çmy
 = 
AF_INET6
;

60 
	`š‘_±Ú
(
AF_INET6
, 
rmtmask
[
i
].
rmt¡r
, &
rmt
.
v6
.
sš6_addr
);

66 
	`bufãr_cİy_¡ršg
(
s
, 
rmtmask
[
i
].
¡ršg
);

67 
¦ash
 = 
	`¡rchr
(
s
->
±r
,'/'); 
	`as£¹
(slash);

68 
m
 = 
	`cÚfig_addrbuf_eq_»mÙe__mask
(
NULL
, 
s
, 
¦ash
, &
rmt
);

69 ià(
m
 !ğ
rmtmask
[
i
].
ex³ù
) {

70 
	`årštf
(
¡d”r
, "failed‡ssertion: %s %s %s\n",

71 
rmtmask
[
i
].
¡ršg
,

72 
rmtmask
[
i
].
ex³ù
 ? "==" : "!=",

73 
rmtmask
[
i
].
rmt¡r
);

74 
	`ex™
(-1);

78 
	`bufãr_ä“
(
s
);

79 
	}
}

81 
	$maš
 () {

82 
	`‹¡_cÚfigfe_addrbuf_eq_»mÙe__mask
();

85 
	}
}

90 
	$fd_şo£_Ú_exec
(
fd
è{ 
	`UNUSED
(fd); 
	}
}

	@vector.c

1 
	~"fœ¡.h
"

3 
	~"veùÜ.h
"

4 
	~"ba£.h
"

6 *
	$veùÜ_»®loc
(*
d©a
, 
size_t
 
–em_size
, size_ˆ
size
, size_ˆ
u£d
) {

7 cÚ¡ 
size_t
 
tÙ®_size
 = 
–em_size
 * 
size
;

8 cÚ¡ 
size_t
 
u£d_size
 = 
–em_size
 * 
u£d
;

9 
	`fÜû_as£¹
(
size
 <ğ
SIZE_MAX
 / 
–em_size
);

10 
d©a
 = 
	`»®loc
(d©a, 
tÙ®_size
);

11 
	`fÜû_as£¹
(
NULL
 !ğ
d©a
);

14 
	`mem£t
(((*)
d©a
è+ 
u£d_size
, 0, 
tÙ®_size
 - used_size);

16  
d©a
;

17 
	}
}

	@vector.h

1 #iâdeà
LI_VECTOR_H


2 
	#LI_VECTOR_H


	)

3 
	~"fœ¡.h
"

5 #iâdeà
SIZE_MAX


6 #ifdeà
SIZE_T_MAX


7 
	#SIZE_MAX
 
SIZE_T_MAX


	)

9 
	#SIZE_MAX
 ((
size_t
)~0)

	)

13 
	~<¡dlib.h
>

14 
	~<¡ršg.h
>

16 
šlše
 
size_t
 
	$veùÜ_®ign_size
(
size_t
 
s
) {

17 
size_t
 
a
 = (
s
 + 16) & ((size_t)~15);

18  (
a
 < 
s
) ? s :‡;

19 
	}
}

21 *
veùÜ_»®loc
(*
d©a
, 
size_t
 
–em_size
, size_ˆ
size
, size_ˆ
u£d
);

23 
	#DEFINE_TYPED_VECTOR
(
Çme
, 
’Œy
, 
»Ëa£
) \

24 
veùÜ_
 ## 
	tÇme
 { \

25 
’Œy
* 
d©a
; \

26 
size_t
 
u£d
; \

27 
size_t
 
size
; \

28 } 
	tveùÜ_
 ## 
	tÇme
; \

29 
šlše
 
veùÜ_
 ## 
Çme
 ## 
	`_š™
(veùÜ_ ##‚am*
v
) { \

30 
v
->
d©a
 = 
NULL
; \

31 
v
->
u£d
 = v->
size
 = 0; \

33 
šlše
 
veùÜ_
 ## 
Çme
 *veùÜ_ ##‚am## 
	`_®loc
() { \

34 
veùÜ_
 ## 
Çme
 *
v
 = 
	`m®loc
((*v)); \

35 
	`fÜû_as£¹
(
NULL
 !ğ
v
); \

36 
veùÜ_
 ## 
Çme
 ## 
	`_š™
(
v
); \

37  
v
; \

39 
šlše
 
veùÜ_
 ## 
Çme
 ## 
	`_ş—r
(veùÜ_ ##‚am*
v
) { \

40 
size_t
 
ndx
; \

41 
veùÜ_
 ## 
Çme
 
vcİy
 = *
v
; \

42 
veùÜ_
 ## 
Çme
 ## 
	`_š™
(
v
); \

43 ià(
»Ëa£
è
ndx
 = 0;‚dx < 
vcİy
.
u£d
; ++ndxè
	`»Ëa£
(vcİy.
d©a
[ndx]); \

44 
	`ä“
(
vcİy
.
d©a
); \

46 
šlše
 
veùÜ_
 ## 
Çme
 ## 
	`_ä“
(veùÜ_ ##‚am*
v
) { \

47 ià(
NULL
 !ğ
v
) { \

48 
veùÜ_
 ## 
Çme
 ## 
	`_ş—r
(
v
); \

49 
	`ä“
(
v
); \

52 
šlše
 
veùÜ_
 ## 
Çme
 ## 
	`_»£rve
(veùÜ_ ##‚am*
v
, 
size_t
 
p
) { \

53 
	`fÜû_as£¹
(
v
->
u£d
 < 
SIZE_MAX
 - 
p
); \

54 ià(
v
->
size
 < v->
u£d
 + 
p
) { \

55 
v
->
size
 = 
	`veùÜ_®ign_size
(v->
u£d
 + 
p
); \

56 
v
->
d©a
 = 
	`veùÜ_»®loc
(v->d©a, (
’Œy
), v->
size
, v->
u£d
); \

59 
šlše
 
veùÜ_
 ## 
Çme
 ## 
	`_push
(veùÜ_ ##‚am*
v
, 
’Œy
 
e
) { \

60 
veùÜ_
 ## 
Çme
 ## 
	`_»£rve
(
v
, 1); \

61 
v
->
d©a
[v->
u£d
++] = 
e
; \

63 
šlše
 
’Œy
 
veùÜ_
 ## 
Çme
 ## 
	`_pİ
(veùÜ_ ##‚am*
v
) { \

64 
	`fÜû_as£¹
(
v
->
u£d
 > 0); \

65  
v
->
d©a
[--v->
u£d
]; \

67 
veùÜ_
 ## 
Çme
 \

68 

	)

70 
	#DEFINE_TYPED_VECTOR_NO_RELEASE
(
Çme
, 
’Œy
) \

71 
	`DEFINE_TYPED_VECTOR
(
Çme
, 
’Œy
, (((*)ÓÁry)è
NULL
)) \

72 

	)

	@version.h

1 #iâdeà
_VERSION_H_


2 
	#_VERSION_H_


	)

3 
	~"fœ¡.h
"

5 #ifdeà
HAVE_VERSION_H


6 
	~"v”siÚ¡amp.h
"

8 
	#REPO_VERSION
 ""

	)

11 
	#PACKAGE_DESC
 
PACKAGE_NAME
 "/" 
PACKAGE_VERSION
 
REPO_VERSION


	)

	@
1
.
0
156
2311
array.c
array.h
base.h
base64.c
base64.h
buffer.c
buffer.h
build/CMakeFiles/3.9.2/CompilerIdC/CMakeCCompilerId.c
build/CMakeFiles/CheckTypeSize/HAVE_SOCKLEN_T.c
build/CMakeFiles/CheckTypeSize/SIZEOF_LONG.c
build/CMakeFiles/CheckTypeSize/SIZEOF_OFF_T.c
build/CMakeFiles/feature_tests.c
build/config.h
chunk.c
chunk.h
configfile-glue.c
configfile.c
configfile.h
configparser.c
configparser.h
connections-glue.c
connections.c
connections.h
crc32.c
crc32.h
data_array.c
data_config.c
data_fastcgi.c
data_integer.c
data_string.c
etag.c
etag.h
fastcgi.h
fdevent.c
fdevent.h
fdevent_freebsd_kqueue.c
fdevent_libev.c
fdevent_linux_sysepoll.c
fdevent_poll.c
fdevent_select.c
fdevent_solaris_devpoll.c
fdevent_solaris_port.c
first.h
http-header-glue.c
http_auth.c
http_auth.h
http_chunk.c
http_chunk.h
inet_ntop_cache.c
inet_ntop_cache.h
joblist.c
joblist.h
keyvalue.c
keyvalue.h
lemon.c
lempar.c
lighttpd-angel.c
log.c
log.h
md5.c
md5.h
mod_access.c
mod_accesslog.c
mod_alias.c
mod_auth.c
mod_authn_file.c
mod_authn_gssapi.c
mod_authn_ldap.c
mod_authn_mysql.c
mod_cgi.c
mod_cml.c
mod_cml.h
mod_cml_funcs.c
mod_cml_funcs.h
mod_cml_lua.c
mod_compress.c
mod_deflate.c
mod_dirlisting.c
mod_evasive.c
mod_evhost.c
mod_expire.c
mod_extforward.c
mod_fastcgi.c
mod_flv_streaming.c
mod_geoip.c
mod_indexfile.c
mod_magnet.c
mod_magnet_cache.c
mod_magnet_cache.h
mod_mysql_vhost.c
mod_proxy.c
mod_redirect.c
mod_rewrite.c
mod_rrdtool.c
mod_scgi.c
mod_secdownload.c
mod_setenv.c
mod_simple_vhost.c
mod_skeleton.c
mod_ssi.c
mod_ssi.h
mod_ssi_expr.c
mod_ssi_expr.h
mod_ssi_exprparser.c
mod_ssi_exprparser.h
mod_staticfile.c
mod_status.c
mod_trigger_b4_dl.c
mod_uploadprogress.c
mod_userdir.c
mod_usertrack.c
mod_webdav.c
network.c
network.h
network_backends.h
network_darwin_sendfile.c
network_freebsd_sendfile.c
network_linux_sendfile.c
network_openssl.c
network_solaris_sendfilev.c
network_write.c
network_write_mmap.c
network_write_no_mmap.c
network_writev.c
plugin.c
plugin.h
proc_open.c
proc_open.h
rand.c
rand.h
request.c
request.h
response.c
response.h
safe_memclear.c
safe_memclear.h
server.c
server.h
settings.h
splaytree.c
splaytree.h
stat_cache.c
stat_cache.h
status_counter.c
status_counter.h
stream.c
stream.h
sys-endian.h
sys-mmap.h
sys-socket.h
test_base64.c
test_buffer.c
test_configfile.c
vector.c
vector.h
version.h
